{"title":"å­¦Netty-é»‘é©¬æ»¡å“¥","uid":"ab3568622c7f6e7ae567a8af8514c4cd","slug":"å­¦Netty-é»‘é©¬æ»¡å“¥","date":"2022-04-26T14:11:41.000Z","updated":"2022-08-22T08:05:45.171Z","comments":true,"path":"api/articles/å­¦Netty-é»‘é©¬æ»¡å“¥.json","keywords":null,"cover":"http://p9.qhimg.com/bdm/960_593_0/t01747d916d50e11a77.jpg","content":"<p>é»‘é©¬Nettyï¼š<a href=\"https://www.bilibili.com/video/BV1py4y1E7oA\">https://www.bilibili.com/video/BV1py4y1E7oA</a></p>\n<p>å­¦Nettyï¼Œå»ºè®®çœ‹é»‘é©¬Nettyæ•™ç¨‹ã€‚ç„¶åå°šç¡…è°·Nettyè¯¾çš„Protobuf, DubboRPCç­‰æ¡ˆä¾‹å°±å¯ä»¥äº†ã€‚</p>\n<p>å°šç¡…è°·-éŸ©é¡ºå¹³ï¼š<a href=\"https://www.bilibili.com/video/BV1DJ411m7NR?p=1\">https://www.bilibili.com/video/BV1DJ411m7NR?p=1</a></p>\n<p>å­¦ä¹ Nettyå»ºè®®ä¸€å®šè¦çœ‹ ã€ŠNetty in Actionã€‹ï¼ˆNttyå®æˆ˜ï¼‰ï¼Œ ç½‘ä¸Šæœ‰å¤§ç¥ä¹Ÿç¿»è¯‘äº† ï¼š <a href=\"https://waylau.com/essential-netty-in-action/index.html\">https://waylau.com/essential-netty-in-action/index.html</a><br>åˆ«äººçš„å­¦ä¹ æ–‡æ¡£ï¼ŒæŒç»­æ›´æ–°ï¼š<a href=\"https://github.com/guang19/framework-learning\">https://github.com/guang19/framework-learning</a></p>\n<h1 id=\"ä¸€-NIO-åŸºç¡€\"><a href=\"#ä¸€-NIO-åŸºç¡€\" class=\"headerlink\" title=\"ä¸€. NIO åŸºç¡€\"></a>ä¸€. NIO åŸºç¡€</h1><p>non-blocking io éé˜»å¡ IO</p>\n<h2 id=\"1-ä¸‰å¤§ç»„ä»¶\"><a href=\"#1-ä¸‰å¤§ç»„ä»¶\" class=\"headerlink\" title=\"1. ä¸‰å¤§ç»„ä»¶\"></a>1. ä¸‰å¤§ç»„ä»¶</h2><h3 id=\"1-1-Channel-amp-Buffer\"><a href=\"#1-1-Channel-amp-Buffer\" class=\"headerlink\" title=\"1.1 Channel &amp; Buffer\"></a>1.1 Channel &amp; Buffer</h3><p>channel æœ‰ä¸€ç‚¹ç±»ä¼¼äº streamï¼Œå®ƒå°±æ˜¯è¯»å†™æ•°æ®çš„<strong>åŒå‘é€šé“</strong>ï¼Œå¯ä»¥ä» channel å°†æ•°æ®è¯»å…¥ bufferï¼Œä¹Ÿå¯ä»¥å°† buffer çš„æ•°æ®å†™å…¥ channelï¼Œè€Œä¹‹å‰çš„ stream è¦ä¹ˆæ˜¯è¾“å…¥ï¼Œè¦ä¹ˆæ˜¯è¾“å‡ºï¼Œchannel æ¯” stream æ›´ä¸ºåº•å±‚</p>\n<pre class=\"line-numbers language-mermaid\" data-language=\"mermaid\"><code class=\"language-mermaid\">graph LR\nchannel --&gt; buffer\nbuffer --&gt; channel</code></pre>\n\n<p>å¸¸è§çš„ Channel æœ‰</p>\n<ul>\n<li>FileChannel</li>\n<li>DatagramChannel    UDP</li>\n<li>SocketChannel    C&#x2F;S</li>\n<li>ServerSocketChannel    S</li>\n</ul>\n<p>buffer åˆ™ç”¨æ¥ç¼“å†²è¯»å†™æ•°æ®ï¼Œå¸¸è§çš„ buffer æœ‰</p>\n<ul>\n<li>ByteBuffer æŠ½è±¡ç±»<ul>\n<li>MappedByteBuffer</li>\n<li>DirectByteBuffer</li>\n<li>HeapByteBuffer</li>\n</ul>\n</li>\n<li>ShortBuffer</li>\n<li>IntBuffer</li>\n<li>LongBuffer</li>\n<li>FloatBuffer</li>\n<li>DoubleBuffer</li>\n<li>CharBuffer</li>\n</ul>\n<h3 id=\"1-2-Selector\"><a href=\"#1-2-Selector\" class=\"headerlink\" title=\"1.2 Selector\"></a>1.2 Selector</h3><p>selector å•ä»å­—é¢æ„æ€ä¸å¥½ç†è§£ï¼Œéœ€è¦ç»“åˆæœåŠ¡å™¨çš„è®¾è®¡æ¼”åŒ–æ¥ç†è§£å®ƒçš„ç”¨é€”</p>\n<h4 id=\"å¤šçº¿ç¨‹ç‰ˆè®¾è®¡\"><a href=\"#å¤šçº¿ç¨‹ç‰ˆè®¾è®¡\" class=\"headerlink\" title=\"å¤šçº¿ç¨‹ç‰ˆè®¾è®¡\"></a>å¤šçº¿ç¨‹ç‰ˆè®¾è®¡</h4><pre class=\"line-numbers language-mermaid\" data-language=\"mermaid\"><code class=\"language-mermaid\">graph TD\nsubgraph å¤šçº¿ç¨‹ç‰ˆ\nt1(thread) --&gt; s1(socket1)\nt2(thread) --&gt; s2(socket2)\nt3(thread) --&gt; s3(socket3)\nend</code></pre>\n\n<h4 id=\"âš ï¸-å¤šçº¿ç¨‹ç‰ˆç¼ºç‚¹\"><a href=\"#âš ï¸-å¤šçº¿ç¨‹ç‰ˆç¼ºç‚¹\" class=\"headerlink\" title=\"âš ï¸ å¤šçº¿ç¨‹ç‰ˆç¼ºç‚¹\"></a>âš ï¸ å¤šçº¿ç¨‹ç‰ˆç¼ºç‚¹</h4><ul>\n<li>å†…å­˜å ç”¨é«˜</li>\n<li>çº¿ç¨‹ä¸Šä¸‹æ–‡åˆ‡æ¢æˆæœ¬é«˜</li>\n<li>åªé€‚åˆè¿æ¥æ•°å°‘çš„åœºæ™¯</li>\n</ul>\n<h4 id=\"çº¿ç¨‹æ± ç‰ˆè®¾è®¡\"><a href=\"#çº¿ç¨‹æ± ç‰ˆè®¾è®¡\" class=\"headerlink\" title=\"çº¿ç¨‹æ± ç‰ˆè®¾è®¡\"></a>çº¿ç¨‹æ± ç‰ˆè®¾è®¡</h4><pre class=\"line-numbers language-mermaid\" data-language=\"mermaid\"><code class=\"language-mermaid\">graph TD\nsubgraph çº¿ç¨‹æ± ç‰ˆ\nt4(thread) --&gt; s4(socket1)\nt5(thread) --&gt; s5(socket2)\nt4(thread) -.-&gt; s6(socket3)\nt5(thread) -.-&gt; s7(socket4)\nend</code></pre>\n\n<h4 id=\"âš ï¸-çº¿ç¨‹æ± ç‰ˆç¼ºç‚¹\"><a href=\"#âš ï¸-çº¿ç¨‹æ± ç‰ˆç¼ºç‚¹\" class=\"headerlink\" title=\"âš ï¸ çº¿ç¨‹æ± ç‰ˆç¼ºç‚¹\"></a>âš ï¸ çº¿ç¨‹æ± ç‰ˆç¼ºç‚¹</h4><ul>\n<li>é˜»å¡æ¨¡å¼ä¸‹ï¼Œçº¿ç¨‹ä»…èƒ½å¤„ç†ä¸€ä¸ª socket è¿æ¥</li>\n<li>ä»…é€‚åˆçŸ­è¿æ¥åœºæ™¯ï¼šå› ä¸ºé˜»å¡æ¨¡å¼ï¼respåå°½å¿«æ–­å¼€å¤„ç†å…¶ä»–socket</li>\n</ul>\n<p>THåˆ©ç”¨ç‡ä¸é«˜</p>\n<h4 id=\"selector-ç‰ˆè®¾è®¡\"><a href=\"#selector-ç‰ˆè®¾è®¡\" class=\"headerlink\" title=\"selector ç‰ˆè®¾è®¡\"></a>selector ç‰ˆè®¾è®¡</h4><p>selector çš„ä½œç”¨å°±æ˜¯ã€é…åˆä¸€ä¸ªçº¿ç¨‹æ¥ç®¡ç†å¤šä¸ªã€‘ channelï¼Œè·å–è¿™äº› channel ä¸Šå‘ç”Ÿçš„ã€äº‹ä»¶ã€‘ï¼Œè¿™äº› channel å·¥ä½œåœ¨éé˜»å¡æ¨¡å¼ä¸‹ï¼Œä¸ä¼šè®©çº¿ç¨‹åŠæ­»åœ¨ä¸€ä¸ª channel ä¸Šã€‚<strong>é€‚åˆè¿æ¥æ•°ç‰¹åˆ«å¤šï¼Œä½†æµé‡ä½[éé¢‘ç¹è¯·æ±‚]çš„åœºæ™¯ï¼ˆlow trafficï¼‰</strong></p>\n<pre class=\"line-numbers language-mermaid\" data-language=\"mermaid\"><code class=\"language-mermaid\">graph TD\nsubgraph selector ç‰ˆ\nthread --&gt; selector\nselector --&gt; c1(channel)\nselector --&gt; c2(channel)\nselector --&gt; c3(channel)\nend</code></pre>\n\n<p>å¯è¿æ¥|R|Wçš„event</p>\n<p>è°ƒç”¨ selector çš„ <strong>select() ä¼šé˜»å¡ç›´åˆ° channel å‘ç”Ÿäº†è¯»å†™å°±ç»ªäº‹ä»¶</strong>ï¼Œè¿™äº›äº‹ä»¶å‘ç”Ÿï¼Œselect æ–¹æ³•å°±ä¼š<strong>è¿”å›è¿™äº›äº‹ä»¶äº¤ç»™ thread æ¥å¤„ç†</strong></p>\n<h2 id=\"2-ByteBuffer\"><a href=\"#2-ByteBuffer\" class=\"headerlink\" title=\"2. ByteBuffer\"></a>2. ByteBuffer</h2><p>æœ‰ä¸€æ™®é€šæ–‡æœ¬æ–‡ä»¶ data.txtï¼Œå†…å®¹ä¸º</p>\n<pre class=\"line-numbers language-none\"><code class=\"language-none\">1234567890abcd</code></pre>\n\n<p>ä½¿ç”¨ FileChannel æ¥è¯»å–æ–‡ä»¶å†…å®¹\t&#x3D;&#x3D;twrï¼štry-with-resources&#x3D;&#x3D;</p>\n<pre class=\"line-numbers language-java\" data-language=\"java\"><code class=\"language-java\">@Slf4j\npublic class TestByteBuffer &#123;\n\n    public static void main(String[] args) &#123;\n        &#x2F;&#x2F; FileChannel\n        &#x2F;&#x2F; 1. è¾“å…¥è¾“å‡ºæµï¼Œ 2. RandomAccessFile\n        try (FileChannel channel &#x3D; new FileInputStream(&quot;data.txt&quot;).getChannel()) &#123;\n            &#x2F;&#x2F; å‡†å¤‡ç¼“å†²åŒº\n            ByteBuffer buffer &#x3D; ByteBuffer.allocate(10);\n            while (true) &#123;\n                &#x2F;&#x2F; ä»channelè¯»å–æ•°æ®ï¼Œå†™åˆ°buffer\n                int len &#x3D; channel.read(buffer);\n                log.debug(&quot;è¯»å–åˆ°çš„å­—èŠ‚æ•° &#123;&#125;&quot;, len);\n                if(len &#x3D;&#x3D; -1) break;&#x2F;&#x2F;æ²¡æœ‰å†…å®¹äº†\n                &#x2F;&#x2F;print\n                buffer.flip(); &#x2F;&#x2F;åˆ‡æ¢åˆ°è¯»bufferæ¨¡å¼\n                while(buffer.hasRemaining()) &#123;\n                    byte b &#x3D; buffer.get();&#x2F;&#x2F;è¯»1B\n                    log.debug(&quot;å®é™…å­—èŠ‚æ•° &#123;&#125;&quot;, (char) b);\n                &#125;\n                buffer.clear(); &#x2F;&#x2F;åˆ‡æ¢åˆ°å†™bufferæ¨¡å¼\n            &#125;\n\n        &#125; catch (IOException e) &#123;\n        &#125;\n    &#125;\n\n&#125;\n</code></pre>\n\n<p>è¾“å‡º</p>\n<pre class=\"line-numbers language-none\"><code class=\"language-none\">10:39:03 [DEBUG] [main] c.i.n.ChannelDemo1 - è¯»åˆ°å­—èŠ‚æ•°ï¼š10\n10:39:03 [DEBUG] [main] c.i.n.ChannelDemo1 - 1\n10:39:03 [DEBUG] [main] c.i.n.ChannelDemo1 - 2\n10:39:03 [DEBUG] [main] c.i.n.ChannelDemo1 - 3\n10:39:03 [DEBUG] [main] c.i.n.ChannelDemo1 - 4\n10:39:03 [DEBUG] [main] c.i.n.ChannelDemo1 - 5\n10:39:03 [DEBUG] [main] c.i.n.ChannelDemo1 - 6\n10:39:03 [DEBUG] [main] c.i.n.ChannelDemo1 - 7\n10:39:03 [DEBUG] [main] c.i.n.ChannelDemo1 - 8\n10:39:03 [DEBUG] [main] c.i.n.ChannelDemo1 - 9\n10:39:03 [DEBUG] [main] c.i.n.ChannelDemo1 - 0\n10:39:03 [DEBUG] [main] c.i.n.ChannelDemo1 - è¯»åˆ°å­—èŠ‚æ•°ï¼š4\n10:39:03 [DEBUG] [main] c.i.n.ChannelDemo1 - a\n10:39:03 [DEBUG] [main] c.i.n.ChannelDemo1 - b\n10:39:03 [DEBUG] [main] c.i.n.ChannelDemo1 - c\n10:39:03 [DEBUG] [main] c.i.n.ChannelDemo1 - d\n10:39:03 [DEBUG] [main] c.i.n.ChannelDemo1 - è¯»åˆ°å­—èŠ‚æ•°ï¼š-1</code></pre>\n\n\n\n<h3 id=\"2-1-ByteBuffer-æ­£ç¡®ä½¿ç”¨å§¿åŠ¿\"><a href=\"#2-1-ByteBuffer-æ­£ç¡®ä½¿ç”¨å§¿åŠ¿\" class=\"headerlink\" title=\"2.1  ByteBuffer æ­£ç¡®ä½¿ç”¨å§¿åŠ¿\"></a>2.1  ByteBuffer æ­£ç¡®ä½¿ç”¨å§¿åŠ¿</h3><ol>\n<li>å‘ buffer å†™å…¥æ•°æ®ï¼Œä¾‹å¦‚è°ƒç”¨ channel.read(buffer)</li>\n<li>è°ƒç”¨ flip() åˆ‡æ¢è‡³<strong>è¯»æ¨¡å¼</strong></li>\n<li>ä» buffer è¯»å–æ•°æ®ï¼Œä¾‹å¦‚è°ƒç”¨ buffer.get()</li>\n<li>è°ƒç”¨ clear() æˆ– compact() ã€Rä¸€éƒ¨åˆ†ï¼Œå‹ç¼©æ‰å·²è¯»éƒ¨åˆ†ç»§ç»­Wã€‘åˆ‡æ¢è‡³<strong>å†™æ¨¡å¼</strong></li>\n<li>é‡å¤ 1~4 æ­¥éª¤</li>\n</ol>\n<h3 id=\"2-2-ByteBuffer-ç»“æ„\"><a href=\"#2-2-ByteBuffer-ç»“æ„\" class=\"headerlink\" title=\"2.2 ByteBuffer ç»“æ„\"></a>2.2 ByteBuffer ç»“æ„</h3><p>ByteBuffer æœ‰ä»¥ä¸‹é‡è¦å±æ€§</p>\n<ul>\n<li>capacity</li>\n<li>position curW&#x2F;Rä½ç½®</li>\n<li>limit W&#x2F;Ré™åˆ¶</li>\n</ul>\n<p>ä¸€å¼€å§‹</p>\n<p><img src=\"http://cache.itzy8.top/%E5%AD%A6Netty-%E9%BB%91%E9%A9%AC%E6%BB%A1%E5%93%A5/0021.png\"></p>\n<p>å†™æ¨¡å¼ä¸‹ï¼Œposition æ˜¯å†™å…¥ä½ç½®ï¼Œlimit ç­‰äºå®¹é‡ï¼Œä¸‹å›¾è¡¨ç¤ºå†™å…¥äº† 4 ä¸ªå­—èŠ‚åçš„çŠ¶æ€</p>\n<p><img src=\"http://cache.itzy8.top/%E5%AD%A6Netty-%E9%BB%91%E9%A9%AC%E6%BB%A1%E5%93%A5/0018.png\"></p>\n<p>flip åŠ¨ä½œå‘ç”Ÿåï¼Œposition åˆ‡æ¢ä¸ºè¯»å–ä½ç½®ï¼Œlimit åˆ‡æ¢ä¸ºè¯»å–é™åˆ¶</p>\n<p><img src=\"http://cache.itzy8.top/%E5%AD%A6Netty-%E9%BB%91%E9%A9%AC%E6%BB%A1%E5%93%A5/0019.png\"></p>\n<p>è¯»å– 4 ä¸ªå­—èŠ‚åï¼ŒçŠ¶æ€</p>\n<p><img src=\"http://cache.itzy8.top/%E5%AD%A6Netty-%E9%BB%91%E9%A9%AC%E6%BB%A1%E5%93%A5/0020.png\"></p>\n<p>clear åŠ¨ä½œå‘ç”Ÿåï¼ŒçŠ¶æ€</p>\n<p><img src=\"http://cache.itzy8.top/%E5%AD%A6Netty-%E9%BB%91%E9%A9%AC%E6%BB%A1%E5%93%A5/0021.png\"></p>\n<p>compact æ–¹æ³•ï¼Œæ˜¯æŠŠ**[æœªè¯»å®Œ]çš„éƒ¨åˆ†å‘å‰å‹ç¼©ï¼Œç„¶ååˆ‡æ¢è‡³å†™(ç»§ç»­W)**æ¨¡å¼</p>\n<p><img src=\"http://cache.itzy8.top/%E5%AD%A6Netty-%E9%BB%91%E9%A9%AC%E6%BB%A1%E5%93%A5/0022.png\"></p>\n<h4 id=\"ğŸ’¡-è°ƒè¯•å·¥å…·ç±»\"><a href=\"#ğŸ’¡-è°ƒè¯•å·¥å…·ç±»\" class=\"headerlink\" title=\"ğŸ’¡ è°ƒè¯•å·¥å…·ç±»\"></a>ğŸ’¡ è°ƒè¯•å·¥å…·ç±»</h4><pre class=\"line-numbers language-java\" data-language=\"java\"><code class=\"language-java\">public class ByteBufferUtil &#123;\n    private static final char[] BYTE2CHAR &#x3D; new char[256];\n    private static final char[] HEXDUMP_TABLE &#x3D; new char[256 * 4];\n    private static final String[] HEXPADDING &#x3D; new String[16];\n    private static final String[] HEXDUMP_ROWPREFIXES &#x3D; new String[65536 &gt;&gt;&gt; 4];\n    private static final String[] BYTE2HEX &#x3D; new String[256];\n    private static final String[] BYTEPADDING &#x3D; new String[16];\n\n    static &#123;\n        final char[] DIGITS &#x3D; &quot;0123456789abcdef&quot;.toCharArray();\n        for (int i &#x3D; 0; i &lt; 256; i++) &#123;\n            HEXDUMP_TABLE[i &lt;&lt; 1] &#x3D; DIGITS[i &gt;&gt;&gt; 4 &amp; 0x0F];\n            HEXDUMP_TABLE[(i &lt;&lt; 1) + 1] &#x3D; DIGITS[i &amp; 0x0F];\n        &#125;\n\n        int i;\n\n        &#x2F;&#x2F; Generate the lookup table for hex dump paddings\n        for (i &#x3D; 0; i &lt; HEXPADDING.length; i++) &#123;\n            int padding &#x3D; HEXPADDING.length - i;\n            StringBuilder buf &#x3D; new StringBuilder(padding * 3);\n            for (int j &#x3D; 0; j &lt; padding; j++) &#123;\n                buf.append(&quot;   &quot;);\n            &#125;\n            HEXPADDING[i] &#x3D; buf.toString();\n        &#125;\n\n        &#x2F;&#x2F; Generate the lookup table for the start-offset header in each row (up to 64KiB).\n        for (i &#x3D; 0; i &lt; HEXDUMP_ROWPREFIXES.length; i++) &#123;\n            StringBuilder buf &#x3D; new StringBuilder(12);\n            buf.append(NEWLINE);\n            buf.append(Long.toHexString(i &lt;&lt; 4 &amp; 0xFFFFFFFFL | 0x100000000L));\n            buf.setCharAt(buf.length() - 9, &#39;|&#39;);\n            buf.append(&#39;|&#39;);\n            HEXDUMP_ROWPREFIXES[i] &#x3D; buf.toString();\n        &#125;\n\n        &#x2F;&#x2F; Generate the lookup table for byte-to-hex-dump conversion\n        for (i &#x3D; 0; i &lt; BYTE2HEX.length; i++) &#123;\n            BYTE2HEX[i] &#x3D; &#39; &#39; + StringUtil.byteToHexStringPadded(i);\n        &#125;\n\n        &#x2F;&#x2F; Generate the lookup table for byte dump paddings\n        for (i &#x3D; 0; i &lt; BYTEPADDING.length; i++) &#123;\n            int padding &#x3D; BYTEPADDING.length - i;\n            StringBuilder buf &#x3D; new StringBuilder(padding);\n            for (int j &#x3D; 0; j &lt; padding; j++) &#123;\n                buf.append(&#39; &#39;);\n            &#125;\n            BYTEPADDING[i] &#x3D; buf.toString();\n        &#125;\n\n        &#x2F;&#x2F; Generate the lookup table for byte-to-char conversion\n        for (i &#x3D; 0; i &lt; BYTE2CHAR.length; i++) &#123;\n            if (i &lt;&#x3D; 0x1f || i &gt;&#x3D; 0x7f) &#123;\n                BYTE2CHAR[i] &#x3D; &#39;.&#39;;\n            &#125; else &#123;\n                BYTE2CHAR[i] &#x3D; (char) i;\n            &#125;\n        &#125;\n    &#125;\n\n    &#x2F;**\n     * æ‰“å°æ‰€æœ‰å†…å®¹\n     * @param buffer\n     *&#x2F;\n    public static void debugAll(ByteBuffer buffer) &#123;\n        int oldlimit &#x3D; buffer.limit();\n        buffer.limit(buffer.capacity());\n        StringBuilder origin &#x3D; new StringBuilder(256);\n        appendPrettyHexDump(origin, buffer, 0, buffer.capacity());\n        System.out.println(&quot;+--------+-------------------- all ------------------------+----------------+&quot;);\n        System.out.printf(&quot;position: [%d], limit: [%d]\\n&quot;, buffer.position(), oldlimit);\n        System.out.println(origin);\n        buffer.limit(oldlimit);\n    &#125;\n\n    &#x2F;**\n     * æ‰“å°å¯è¯»å–å†…å®¹\n     * @param buffer\n     *&#x2F;\n    public static void debugRead(ByteBuffer buffer) &#123;\n        StringBuilder builder &#x3D; new StringBuilder(256);\n        appendPrettyHexDump(builder, buffer, buffer.position(), buffer.limit() - buffer.position());\n        System.out.println(&quot;+--------+-------------------- read -----------------------+----------------+&quot;);\n        System.out.printf(&quot;position: [%d], limit: [%d]\\n&quot;, buffer.position(), buffer.limit());\n        System.out.println(builder);\n    &#125;\n\n    private static void appendPrettyHexDump(StringBuilder dump, ByteBuffer buf, int offset, int length) &#123;\n        if (isOutOfBounds(offset, length, buf.capacity())) &#123;\n            throw new IndexOutOfBoundsException(\n                    &quot;expected: &quot; + &quot;0 &lt;&#x3D; offset(&quot; + offset + &quot;) &lt;&#x3D; offset + length(&quot; + length\n                            + &quot;) &lt;&#x3D; &quot; + &quot;buf.capacity(&quot; + buf.capacity() + &#39;)&#39;);\n        &#125;\n        if (length &#x3D;&#x3D; 0) &#123;\n            return;\n        &#125;\n        dump.append(\n                &quot;         +-------------------------------------------------+&quot; +\n                        NEWLINE + &quot;         |  0  1  2  3  4  5  6  7  8  9  a  b  c  d  e  f |&quot; +\n                        NEWLINE + &quot;+--------+-------------------------------------------------+----------------+&quot;);\n\n        final int startIndex &#x3D; offset;\n        final int fullRows &#x3D; length &gt;&gt;&gt; 4;\n        final int remainder &#x3D; length &amp; 0xF;\n\n        &#x2F;&#x2F; Dump the rows which have 16 bytes.\n        for (int row &#x3D; 0; row &lt; fullRows; row++) &#123;\n            int rowStartIndex &#x3D; (row &lt;&lt; 4) + startIndex;\n\n            &#x2F;&#x2F; Per-row prefix.\n            appendHexDumpRowPrefix(dump, row, rowStartIndex);\n\n            &#x2F;&#x2F; Hex dump\n            int rowEndIndex &#x3D; rowStartIndex + 16;\n            for (int j &#x3D; rowStartIndex; j &lt; rowEndIndex; j++) &#123;\n                dump.append(BYTE2HEX[getUnsignedByte(buf, j)]);\n            &#125;\n            dump.append(&quot; |&quot;);\n\n            &#x2F;&#x2F; ASCII dump\n            for (int j &#x3D; rowStartIndex; j &lt; rowEndIndex; j++) &#123;\n                dump.append(BYTE2CHAR[getUnsignedByte(buf, j)]);\n            &#125;\n            dump.append(&#39;|&#39;);\n        &#125;\n\n        &#x2F;&#x2F; Dump the last row which has less than 16 bytes.\n        if (remainder !&#x3D; 0) &#123;\n            int rowStartIndex &#x3D; (fullRows &lt;&lt; 4) + startIndex;\n            appendHexDumpRowPrefix(dump, fullRows, rowStartIndex);\n\n            &#x2F;&#x2F; Hex dump\n            int rowEndIndex &#x3D; rowStartIndex + remainder;\n            for (int j &#x3D; rowStartIndex; j &lt; rowEndIndex; j++) &#123;\n                dump.append(BYTE2HEX[getUnsignedByte(buf, j)]);\n            &#125;\n            dump.append(HEXPADDING[remainder]);\n            dump.append(&quot; |&quot;);\n\n            &#x2F;&#x2F; Ascii dump\n            for (int j &#x3D; rowStartIndex; j &lt; rowEndIndex; j++) &#123;\n                dump.append(BYTE2CHAR[getUnsignedByte(buf, j)]);\n            &#125;\n            dump.append(BYTEPADDING[remainder]);\n            dump.append(&#39;|&#39;);\n        &#125;\n\n        dump.append(NEWLINE +\n                &quot;+--------+-------------------------------------------------+----------------+&quot;);\n    &#125;\n\n    private static void appendHexDumpRowPrefix(StringBuilder dump, int row, int rowStartIndex) &#123;\n        if (row &lt; HEXDUMP_ROWPREFIXES.length) &#123;\n            dump.append(HEXDUMP_ROWPREFIXES[row]);\n        &#125; else &#123;\n            dump.append(NEWLINE);\n            dump.append(Long.toHexString(rowStartIndex &amp; 0xFFFFFFFFL | 0x100000000L));\n            dump.setCharAt(dump.length() - 9, &#39;|&#39;);\n            dump.append(&#39;|&#39;);\n        &#125;\n    &#125;\n\n    public static short getUnsignedByte(ByteBuffer buffer, int index) &#123;\n        return (short) (buffer.get(index) &amp; 0xFF);\n    &#125;\n&#125;</code></pre>\n\n\n\n<h3 id=\"2-3-ByteBuffer-å¸¸è§æ–¹æ³•-nio-c2\"><a href=\"#2-3-ByteBuffer-å¸¸è§æ–¹æ³•-nio-c2\" class=\"headerlink\" title=\"2.3 ByteBuffer å¸¸è§æ–¹æ³•-nio.c2\"></a>2.3 ByteBuffer å¸¸è§æ–¹æ³•-nio.c2</h3><h4 id=\"åˆ†é…ç©ºé—´TestByteBufferAllocate\"><a href=\"#åˆ†é…ç©ºé—´TestByteBufferAllocate\" class=\"headerlink\" title=\"åˆ†é…ç©ºé—´\tTestByteBufferAllocate\"></a>åˆ†é…ç©ºé—´\tTestByteBufferAllocate</h4><p>å¯ä»¥ä½¿ç”¨ allocate æ–¹æ³•ä¸º ByteBuffer åˆ†é…ç©ºé—´ï¼Œå…¶å®ƒ buffer ç±»ä¹Ÿæœ‰è¯¥æ–¹æ³•</p>\n<pre class=\"line-numbers language-java\" data-language=\"java\"><code class=\"language-java\">Bytebuffer buf &#x3D; ByteBuffer.allocate(16);\n\nSystem.out.println(ByteBuffer.allocateDirect(16).getClass());\n&#x2F;*\n        é›¶æ‹·è´:allocateDirect(16)\n        class java.nio.HeapByteBuffer    - java å †å†…å­˜ï¼Œè¯»å†™æ•ˆç‡è¾ƒä½ï¼Œå—åˆ° GC copyçš„å½±å“\n        class java.nio.DirectByteBuffer  - ç›´æ¥å†…å­˜ï¼Œè¯»å†™æ•ˆç‡é«˜ï¼ˆå°‘ä¸€æ¬¡æ‹·è´ï¼‰ï¼Œä¸ä¼šå— GC å½±å“ï¼Œè°ƒOSsyså‡½æ•°ï¼šåˆ†é…çš„æ•ˆç‡ä½\n        ã€ä¼˜åŒ–-Nettyå¯¹è±¡æ± ï¼šå‡å°‘bytebufferåˆ†é…é¢‘ç‡ï¼Œå¹¶å›æ”¶ã€‘\n         *&#x2F;</code></pre>\n\n\n\n<h4 id=\"å‘-buffer-å†™å…¥æ•°æ®TestByteBufferReadWrite\"><a href=\"#å‘-buffer-å†™å…¥æ•°æ®TestByteBufferReadWrite\" class=\"headerlink\" title=\"å‘ buffer å†™å…¥æ•°æ®\tTestByteBufferReadWrite\"></a>å‘ buffer å†™å…¥æ•°æ®\tTestByteBufferReadWrite</h4><p>æœ‰ä¸¤ç§åŠæ³•</p>\n<ul>\n<li>è°ƒç”¨ channel çš„ read æ–¹æ³•</li>\n<li>è°ƒç”¨ buffer è‡ªå·±çš„ put æ–¹æ³•</li>\n</ul>\n<pre class=\"line-numbers language-java\" data-language=\"java\"><code class=\"language-java\">int readBytes &#x3D; channel.read(buf);</code></pre>\n\n<p>å’Œ</p>\n<pre class=\"line-numbers language-java\" data-language=\"java\"><code class=\"language-java\">buf.put((byte)127);</code></pre>\n\n\n\n<h4 id=\"ä»-buffer-è¯»å–æ•°æ®TestByteBufferRead\"><a href=\"#ä»-buffer-è¯»å–æ•°æ®TestByteBufferRead\" class=\"headerlink\" title=\"ä» buffer è¯»å–æ•°æ®\tTestByteBufferRead\"></a>ä» buffer è¯»å–æ•°æ®\tTestByteBufferRead</h4><p>åŒæ ·æœ‰ä¸¤ç§åŠæ³•</p>\n<ul>\n<li>è°ƒç”¨ channel çš„ write æ–¹æ³•</li>\n<li>è°ƒç”¨ buffer è‡ªå·±çš„ get æ–¹æ³•</li>\n</ul>\n<pre class=\"line-numbers language-java\" data-language=\"java\"><code class=\"language-java\">int writeBytes &#x3D; channel.write(buf);</code></pre>\n\n<p>å’Œ</p>\n<pre class=\"line-numbers language-java\" data-language=\"java\"><code class=\"language-java\">byte b &#x3D; buf.get();</code></pre>\n\n<p><strong>get æ–¹æ³•ä¼šè®© position è¯»æŒ‡é’ˆå‘åèµ°</strong>ï¼Œå¦‚æœ<strong>æƒ³é‡å¤è¯»å–</strong>æ•°æ®</p>\n<ul>\n<li>å¯ä»¥è°ƒç”¨ <strong>rewind æ–¹æ³•å°† position é‡æ–°ç½®ä¸º 0</strong></li>\n<li>æˆ–è€…è°ƒç”¨ <strong>get(int i)</strong> æ–¹æ³•è·å–ç´¢å¼• i çš„å†…å®¹ï¼Œå®ƒ<strong>ä¸ä¼šç§»åŠ¨è¯»æŒ‡é’ˆ</strong></li>\n</ul>\n<h4 id=\"mark-å’Œ-reset\"><a href=\"#mark-å’Œ-reset\" class=\"headerlink\" title=\"mark å’Œ reset\"></a>mark å’Œ reset</h4><p>mark æ˜¯åœ¨è¯»å–æ—¶ï¼Œåšä¸€ä¸ªæ ‡è®°ï¼Œå³ä½¿ position æ”¹å˜ï¼Œåªè¦è°ƒç”¨ reset å°±èƒ½å›åˆ° mark çš„ä½ç½®</p>\n<blockquote><span class=\"custom-blockquote-svg\"><svg width=\"24\" height=\"24\" viewBox=\"0 0 24 24\" fill=\"\" xmlns=\"http://www.w3.org/2000/svg\" data-reactroot=\"\">\n<path fill=\"\" d=\"M22 12C22 6.5 17.5 2 12 2C6.5 2 2 6.5 2 12C2 17.5 6.5 22 12 22C13.8 22 15.5 21.5 17 20.6L22 22L20.7 17C21.5 15.5 22 13.8 22 12Z\" undefined=\"1\"></path>\n<path fill=\"\" d=\"M15.97 11.5H16.04C17.12 11.5 18 12.38 18 13.47V13.53C18 14.62 17.12 15.5 16.03 15.5H15.96C14.88 15.5 14 14.62 14 13.53V13.46C14 12.38 14.88 11.5 15.97 11.5Z\" undefined=\"1\"></path>\n<path fill=\"\" d=\"M7.97 11.5H8.04C9.12 11.5 10 12.38 10 13.47V13.53C10 14.62 9.12 15.5 8.03 15.5H7.97C6.88 15.5 6 14.62 6 13.53V13.46C6 12.38 6.88 11.5 7.97 11.5Z\" undefined=\"1\"></path>\n<path stroke-linejoin=\"round\" stroke-linecap=\"round\" stroke-miterlimit=\"10\" stroke-width=\"2\" stroke=\"\" d=\"M17 8.5C15.23 8.97 14.07 10.84 14.01 13.27C14 13.33 14 13.4 14 13.47V13.5\"></path>\n<path stroke-linejoin=\"round\" stroke-linecap=\"round\" stroke-miterlimit=\"10\" stroke-width=\"2\" stroke=\"\" d=\"M9 8.5C7.23 8.97 6.07 10.84 6.01 13.27C6 13.33 6 13.4 6 13.47V13.5\"></path>\n<path stroke-linejoin=\"round\" stroke-linecap=\"round\" stroke-miterlimit=\"10\" stroke-width=\"2\" stroke=\"\" d=\"M15.97 11.5H16.04C17.12 11.5 18 12.38 18 13.47V13.53C18 14.62 17.12 15.5 16.03 15.5H15.96C14.88 15.5 14 14.62 14 13.53V13.46C14 12.38 14.88 11.5 15.97 11.5Z\"></path>\n<path stroke-linejoin=\"round\" stroke-linecap=\"round\" stroke-miterlimit=\"10\" stroke-width=\"2\" stroke=\"\" d=\"M7.97 11.5H8.04C9.12 11.5 10 12.38 10 13.47V13.53C10 14.62 9.12 15.5 8.03 15.5H7.97C6.88 15.5 6 14.62 6 13.53V13.46C6 12.38 6.88 11.5 7.97 11.5Z\"></path>\n</svg>\n</span><p><strong>æ³¨æ„</strong></p>\n<p>rewind å’Œ flip éƒ½ä¼šæ¸…é™¤ mark ä½ç½®ï¼</p></blockquote>\n<h4 id=\"å­—ç¬¦ä¸²ä¸-ByteBuffer-äº’è½¬TestByteBufferString\"><a href=\"#å­—ç¬¦ä¸²ä¸-ByteBuffer-äº’è½¬TestByteBufferString\" class=\"headerlink\" title=\"å­—ç¬¦ä¸²ä¸ ByteBuffer äº’è½¬\tTestByteBufferString\"></a>å­—ç¬¦ä¸²ä¸ ByteBuffer äº’è½¬\tTestByteBufferString</h4><pre class=\"line-numbers language-java\" data-language=\"java\"><code class=\"language-java\">        &#x2F;&#x2F; 1. å­—ç¬¦ä¸²è½¬ä¸º ByteBuffer allocate+put:W\n        ByteBuffer buffer1 &#x3D; ByteBuffer.allocate(16);\n        buffer1.put(&quot;hello&quot;.getBytes());&#x2F;&#x2F;\n        debugAll(buffer1);\n\n        &#x2F;&#x2F; 2. Charset R\n        ByteBuffer buffer2 &#x3D; StandardCharsets.UTF_8.encode(&quot;ä½ å¥½&quot;);\n        debugAll(buffer2);\n\n        &#x2F;&#x2F; 3. wrap R\n        ByteBuffer buffer3 &#x3D; ByteBuffer.wrap(&quot;hello&quot;.getBytes());\n        debugAll(buffer3);\n\nByteBuffer buffer1 &#x3D; StandardCharsets.UTF_8.encode(&quot;ä½ å¥½&quot;);\nByteBuffer buffer2 &#x3D; Charset.forName(&quot;utf-8&quot;).encode(&quot;ä½ å¥½&quot;);\n\ndebug(buffer1);\ndebug(buffer2);\n\nbuffer1.flip();&#x2F;&#x2F;W-&gt;R\nCharBuffer buffer3 &#x3D; StandardCharsets.UTF_8.decode(buffer1);\nSystem.out.println(buffer3.getClass());&#x2F;&#x2F;HeapCharBuffer\nSystem.out.println(buffer3.toString());&#x2F;&#x2F;</code></pre>\n\n<p>è¾“å‡º</p>\n<pre class=\"line-numbers language-none\"><code class=\"language-none\">         +-------------------------------------------------+\n         |  0  1  2  3  4  5  6  7  8  9  a  b  c  d  e  f |\n+--------+-------------------------------------------------+----------------+\n|00000000| e4 bd a0 e5 a5 bd                               |......          |\n+--------+-------------------------------------------------+----------------+\n         +-------------------------------------------------+\n         |  0  1  2  3  4  5  6  7  8  9  a  b  c  d  e  f |\n+--------+-------------------------------------------------+----------------+\n|00000000| e4 bd a0 e5 a5 bd                               |......          |\n+--------+-------------------------------------------------+----------------+\nclass java.nio.HeapCharBuffer\nä½ å¥½</code></pre>\n\n\n\n<h4 id=\"âš ï¸-Buffer-çš„çº¿ç¨‹å®‰å…¨\"><a href=\"#âš ï¸-Buffer-çš„çº¿ç¨‹å®‰å…¨\" class=\"headerlink\" title=\"âš ï¸ Buffer çš„çº¿ç¨‹å®‰å…¨\"></a>âš ï¸ Buffer çš„çº¿ç¨‹å®‰å…¨</h4><blockquote><span class=\"custom-blockquote-svg\"><svg width=\"24\" height=\"24\" viewBox=\"0 0 24 24\" fill=\"\" xmlns=\"http://www.w3.org/2000/svg\" data-reactroot=\"\">\n<path fill=\"\" d=\"M22 12C22 6.5 17.5 2 12 2C6.5 2 2 6.5 2 12C2 17.5 6.5 22 12 22C13.8 22 15.5 21.5 17 20.6L22 22L20.7 17C21.5 15.5 22 13.8 22 12Z\" undefined=\"1\"></path>\n<path fill=\"\" d=\"M15.97 11.5H16.04C17.12 11.5 18 12.38 18 13.47V13.53C18 14.62 17.12 15.5 16.03 15.5H15.96C14.88 15.5 14 14.62 14 13.53V13.46C14 12.38 14.88 11.5 15.97 11.5Z\" undefined=\"1\"></path>\n<path fill=\"\" d=\"M7.97 11.5H8.04C9.12 11.5 10 12.38 10 13.47V13.53C10 14.62 9.12 15.5 8.03 15.5H7.97C6.88 15.5 6 14.62 6 13.53V13.46C6 12.38 6.88 11.5 7.97 11.5Z\" undefined=\"1\"></path>\n<path stroke-linejoin=\"round\" stroke-linecap=\"round\" stroke-miterlimit=\"10\" stroke-width=\"2\" stroke=\"\" d=\"M17 8.5C15.23 8.97 14.07 10.84 14.01 13.27C14 13.33 14 13.4 14 13.47V13.5\"></path>\n<path stroke-linejoin=\"round\" stroke-linecap=\"round\" stroke-miterlimit=\"10\" stroke-width=\"2\" stroke=\"\" d=\"M9 8.5C7.23 8.97 6.07 10.84 6.01 13.27C6 13.33 6 13.4 6 13.47V13.5\"></path>\n<path stroke-linejoin=\"round\" stroke-linecap=\"round\" stroke-miterlimit=\"10\" stroke-width=\"2\" stroke=\"\" d=\"M15.97 11.5H16.04C17.12 11.5 18 12.38 18 13.47V13.53C18 14.62 17.12 15.5 16.03 15.5H15.96C14.88 15.5 14 14.62 14 13.53V13.46C14 12.38 14.88 11.5 15.97 11.5Z\"></path>\n<path stroke-linejoin=\"round\" stroke-linecap=\"round\" stroke-miterlimit=\"10\" stroke-width=\"2\" stroke=\"\" d=\"M7.97 11.5H8.04C9.12 11.5 10 12.38 10 13.47V13.53C10 14.62 9.12 15.5 8.03 15.5H7.97C6.88 15.5 6 14.62 6 13.53V13.46C6 12.38 6.88 11.5 7.97 11.5Z\"></path>\n</svg>\n</span><p>Buffer æ˜¯<strong>éçº¿ç¨‹å®‰å…¨çš„</strong></p></blockquote>\n<h3 id=\"2-4-Scattering-Reads\"><a href=\"#2-4-Scattering-Reads\" class=\"headerlink\" title=\"2.4 Scattering Reads\"></a>2.4 Scattering Reads</h3><p>åˆ†æ•£è¯»å–ï¼Œæœ‰ä¸€ä¸ªæ–‡æœ¬æ–‡ä»¶ 3parts.txt</p>\n<pre class=\"line-numbers language-none\"><code class=\"language-none\">onetwothree</code></pre>\n\n<p>ä½¿ç”¨å¦‚ä¸‹æ–¹å¼è¯»å–ï¼Œå¯ä»¥å°†æ•°æ®ã€å¡«å……è‡³å¤šä¸ª bufferã€‘</p>\n<pre class=\"line-numbers language-java\" data-language=\"java\"><code class=\"language-java\">try (RandomAccessFile file &#x3D; new RandomAccessFile(&quot;helloword&#x2F;3parts.txt&quot;, &quot;rw&quot;)) &#123;\n    FileChannel channel &#x3D; file.getChannel();\n    ByteBuffer a &#x3D; ByteBuffer.allocate(3);\n    ByteBuffer b &#x3D; ByteBuffer.allocate(3);\n    ByteBuffer c &#x3D; ByteBuffer.allocate(5);\n    channel.read(new ByteBuffer[]&#123;a, b, c&#125;);&#x2F;&#x2F;å¢å¼ºread([])\n    a.flip();\n    b.flip();\n    c.flip();\n    debug(a);\n    debug(b);\n    debug(c);\n&#125; catch (IOException e) &#123;\n    e.printStackTrace();\n&#125;</code></pre>\n\n<p>ç»“æœ</p>\n<pre class=\"line-numbers language-none\"><code class=\"language-none\">         +-------------------------------------------------+\n         |  0  1  2  3  4  5  6  7  8  9  a  b  c  d  e  f |\n+--------+-------------------------------------------------+----------------+\n|00000000| 6f 6e 65                                        |one             |\n+--------+-------------------------------------------------+----------------+\n         +-------------------------------------------------+\n         |  0  1  2  3  4  5  6  7  8  9  a  b  c  d  e  f |\n+--------+-------------------------------------------------+----------------+\n|00000000| 74 77 6f                                        |two             |\n+--------+-------------------------------------------------+----------------+\n         +-------------------------------------------------+\n         |  0  1  2  3  4  5  6  7  8  9  a  b  c  d  e  f |\n+--------+-------------------------------------------------+----------------+\n|00000000| 74 68 72 65 65                                  |three           |\n+--------+-------------------------------------------------+----------------+</code></pre>\n\n\n\n<h3 id=\"2-5-Gathering-Writes\"><a href=\"#2-5-Gathering-Writes\" class=\"headerlink\" title=\"2.5 Gathering Writes\"></a>2.5 Gathering Writes</h3><p>ä½¿ç”¨å¦‚ä¸‹æ–¹å¼å†™å…¥ï¼Œå¯ä»¥å°†å¤šä¸ª buffer çš„æ•°æ®å¡«å……è‡³ channel</p>\n<pre class=\"line-numbers language-java\" data-language=\"java\"><code class=\"language-java\">try (RandomAccessFile file &#x3D; new RandomAccessFile(&quot;helloword&#x2F;3parts.txt&quot;, &quot;rw&quot;)) &#123;\n    FileChannel channel &#x3D; file.getChannel();\n    ByteBuffer d &#x3D; ByteBuffer.allocate(4);\n    ByteBuffer e &#x3D; ByteBuffer.allocate(4);\n    channel.position(11);&#x2F;&#x2F;\n\n    d.put(new byte[]&#123;&#39;f&#39;, &#39;o&#39;, &#39;u&#39;, &#39;r&#39;&#125;);\n    e.put(new byte[]&#123;&#39;f&#39;, &#39;i&#39;, &#39;v&#39;, &#39;e&#39;&#125;);\n    d.flip();\n    e.flip();\n    debug(d);\n    debug(e);\n    channel.write(new ByteBuffer[]&#123;d, e&#125;);&#x2F;&#x2F;\n&#125; catch (IOException e) &#123;\n    e.printStackTrace();\n&#125;</code></pre>\n\n<p>è¾“å‡º</p>\n<pre class=\"line-numbers language-none\"><code class=\"language-none\">         +-------------------------------------------------+\n         |  0  1  2  3  4  5  6  7  8  9  a  b  c  d  e  f |\n+--------+-------------------------------------------------+----------------+\n|00000000| 66 6f 75 72                                     |four            |\n+--------+-------------------------------------------------+----------------+\n         +-------------------------------------------------+\n         |  0  1  2  3  4  5  6  7  8  9  a  b  c  d  e  f |\n+--------+-------------------------------------------------+----------------+\n|00000000| 66 69 76 65                                     |five            |\n+--------+-------------------------------------------------+----------------+</code></pre>\n\n<p>æ–‡ä»¶å†…å®¹</p>\n<pre class=\"line-numbers language-none\"><code class=\"language-none\">onetwothreefourfive</code></pre>\n\n\n\n<h3 id=\"2-6-ç»ƒä¹ TestByteBufferExam\"><a href=\"#2-6-ç»ƒä¹ TestByteBufferExam\" class=\"headerlink\" title=\"2.6 ç»ƒä¹ \tTestByteBufferExam\"></a>2.6 ç»ƒä¹ \tTestByteBufferExam</h3><p>ç½‘ç»œä¸Šæœ‰å¤šæ¡æ•°æ®å‘é€ç»™æœåŠ¡ç«¯ï¼Œæ•°æ®ä¹‹é—´ä½¿ç”¨ \\n è¿›è¡Œåˆ†éš”<br>ä½†ç”±äºæŸç§åŸå› è¿™äº›æ•°æ®åœ¨æ¥æ”¶æ—¶ï¼Œè¢«è¿›è¡Œäº†é‡æ–°ç»„åˆï¼Œä¾‹å¦‚åŸå§‹æ•°æ®æœ‰3æ¡ä¸º</p>\n<ul>\n<li>Hello,world\\n</li>\n<li>Iâ€™m zhangsan\\n</li>\n<li>How are you?\\n</li>\n</ul>\n<p>å˜æˆäº†ä¸‹é¢çš„ä¸¤ä¸ª byteBuffer (é»åŒ…ï¼ŒåŠåŒ…)</p>\n<ul>\n<li>Hello,world\\nIâ€™m zhangsan\\nHo</li>\n<li>w are you?\\n</li>\n</ul>\n<p>ç°åœ¨è¦æ±‚ä½ ç¼–å†™ç¨‹åºï¼Œå°†é”™ä¹±çš„æ•°æ®æ¢å¤æˆåŸå§‹çš„æŒ‰ \\n åˆ†éš”çš„æ•°æ®</p>\n<pre class=\"line-numbers language-java\" data-language=\"java\"><code class=\"language-java\">public static void main(String[] args) &#123;\n    ByteBuffer source &#x3D; ByteBuffer.allocate(32);\n    &#x2F;&#x2F;                     11            24\n    source.put(&quot;Hello,world\\nI&#39;m zhangsan\\nHo&quot;.getBytes());\n    split(source);\n\n    source.put(&quot;w are you?\\nhaha!\\n&quot;.getBytes());\n    split(source);\n&#125;\n\n    private static void split(ByteBuffer source) &#123;\n        source.flip();\n        for (int i &#x3D; 0; i &lt; source.limit(); i++) &#123;\n            &#x2F;&#x2F; æ‰¾åˆ°ä¸€æ¡å®Œæ•´æ¶ˆæ¯\n            if (source.get(i) &#x3D;&#x3D; &#39;\\n&#39;) &#123;\n                int length &#x3D; i + 1 - source.position();\n                &#x2F;&#x2F; æŠŠè¿™æ¡å®Œæ•´æ¶ˆæ¯å­˜å…¥æ–°çš„ ByteBuffer\n                ByteBuffer target &#x3D; ByteBuffer.allocate(length);\n                &#x2F;&#x2F; ä» source è¯»ï¼Œå‘ target å†™\n                for (int j &#x3D; 0; j &lt; length; j++) &#123;\n                    target.put(source.get());&#x2F;&#x2F;\n                &#125;\n                debugAll(target);\n            &#125;\n        &#125;\n        source.compact();&#x2F;&#x2F;Ho copyè¦†ç›–,å¾…æ‹¼æ¥neï¼\n    &#125;</code></pre>\n\n\n\n<h2 id=\"3-æ–‡ä»¶ç¼–ç¨‹\"><a href=\"#3-æ–‡ä»¶ç¼–ç¨‹\" class=\"headerlink\" title=\"3. æ–‡ä»¶ç¼–ç¨‹\"></a>3. æ–‡ä»¶ç¼–ç¨‹</h2><h3 id=\"3-1-FileChannel\"><a href=\"#3-1-FileChannel\" class=\"headerlink\" title=\"3.1 FileChannel\"></a>3.1 FileChannel</h3><h4 id=\"âš ï¸-FileChannel-å·¥ä½œæ¨¡å¼\"><a href=\"#âš ï¸-FileChannel-å·¥ä½œæ¨¡å¼\" class=\"headerlink\" title=\"âš ï¸ FileChannel å·¥ä½œæ¨¡å¼\"></a>âš ï¸ FileChannel å·¥ä½œæ¨¡å¼</h4><blockquote><span class=\"custom-blockquote-svg\"><svg width=\"24\" height=\"24\" viewBox=\"0 0 24 24\" fill=\"\" xmlns=\"http://www.w3.org/2000/svg\" data-reactroot=\"\">\n<path fill=\"\" d=\"M22 12C22 6.5 17.5 2 12 2C6.5 2 2 6.5 2 12C2 17.5 6.5 22 12 22C13.8 22 15.5 21.5 17 20.6L22 22L20.7 17C21.5 15.5 22 13.8 22 12Z\" undefined=\"1\"></path>\n<path fill=\"\" d=\"M15.97 11.5H16.04C17.12 11.5 18 12.38 18 13.47V13.53C18 14.62 17.12 15.5 16.03 15.5H15.96C14.88 15.5 14 14.62 14 13.53V13.46C14 12.38 14.88 11.5 15.97 11.5Z\" undefined=\"1\"></path>\n<path fill=\"\" d=\"M7.97 11.5H8.04C9.12 11.5 10 12.38 10 13.47V13.53C10 14.62 9.12 15.5 8.03 15.5H7.97C6.88 15.5 6 14.62 6 13.53V13.46C6 12.38 6.88 11.5 7.97 11.5Z\" undefined=\"1\"></path>\n<path stroke-linejoin=\"round\" stroke-linecap=\"round\" stroke-miterlimit=\"10\" stroke-width=\"2\" stroke=\"\" d=\"M17 8.5C15.23 8.97 14.07 10.84 14.01 13.27C14 13.33 14 13.4 14 13.47V13.5\"></path>\n<path stroke-linejoin=\"round\" stroke-linecap=\"round\" stroke-miterlimit=\"10\" stroke-width=\"2\" stroke=\"\" d=\"M9 8.5C7.23 8.97 6.07 10.84 6.01 13.27C6 13.33 6 13.4 6 13.47V13.5\"></path>\n<path stroke-linejoin=\"round\" stroke-linecap=\"round\" stroke-miterlimit=\"10\" stroke-width=\"2\" stroke=\"\" d=\"M15.97 11.5H16.04C17.12 11.5 18 12.38 18 13.47V13.53C18 14.62 17.12 15.5 16.03 15.5H15.96C14.88 15.5 14 14.62 14 13.53V13.46C14 12.38 14.88 11.5 15.97 11.5Z\"></path>\n<path stroke-linejoin=\"round\" stroke-linecap=\"round\" stroke-miterlimit=\"10\" stroke-width=\"2\" stroke=\"\" d=\"M7.97 11.5H8.04C9.12 11.5 10 12.38 10 13.47V13.53C10 14.62 9.12 15.5 8.03 15.5H7.97C6.88 15.5 6 14.62 6 13.53V13.46C6 12.38 6.88 11.5 7.97 11.5Z\"></path>\n</svg>\n</span><p><strong>FileChannel åªèƒ½å·¥ä½œåœ¨é˜»å¡æ¨¡å¼ä¸‹ï¼Œä¸èƒ½selectéé˜»å¡ï¼</strong></p></blockquote>\n<h4 id=\"è·å–\"><a href=\"#è·å–\" class=\"headerlink\" title=\"è·å–\"></a>è·å–</h4><p>ä¸èƒ½ç›´æ¥æ‰“å¼€ FileChannelï¼Œå¿…é¡»ã€é€šè¿‡ FileInputStreamã€FileOutputStream æˆ–è€… RandomAccessFile æ¥è·å– FileChannelï¼Œå®ƒä»¬<strong>éƒ½æœ‰ getChannel æ–¹æ³•</strong>ã€‘</p>\n<ul>\n<li>é€šè¿‡ FileInputStream è·å–çš„ channel åªèƒ½è¯»</li>\n<li>é€šè¿‡ FileOutputStream è·å–çš„ channel åªèƒ½å†™</li>\n<li>é€šè¿‡ RandomAccessFile æ˜¯å¦èƒ½è¯»å†™æ ¹æ®<strong>æ„é€  RandomAccessFile æ—¶çš„è¯»å†™æ¨¡å¼å†³å®š</strong></li>\n</ul>\n<h4 id=\"è¯»å–\"><a href=\"#è¯»å–\" class=\"headerlink\" title=\"è¯»å–\"></a>è¯»å–</h4><p>ä¼šä» channel è¯»å–æ•°æ®å¡«å…… ByteBufferï¼Œè¿”å›å€¼è¡¨ç¤ºè¯»åˆ°äº†å¤šå°‘å­—èŠ‚ï¼Œ-1 è¡¨ç¤ºåˆ°è¾¾äº†æ–‡ä»¶çš„æœ«å°¾</p>\n<pre class=\"line-numbers language-java\" data-language=\"java\"><code class=\"language-java\">int readBytes &#x3D; channel.read(buffer);</code></pre>\n\n\n\n<h4 id=\"å†™å…¥\"><a href=\"#å†™å…¥\" class=\"headerlink\" title=\"å†™å…¥\"></a>å†™å…¥</h4><p>å†™å…¥çš„æ­£ç¡®å§¿åŠ¿å¦‚ä¸‹ï¼Œ SocketChannel</p>\n<pre class=\"line-numbers language-java\" data-language=\"java\"><code class=\"language-java\">ByteBuffer buffer &#x3D; ...;\nbuffer.put(...); &#x2F;&#x2F; å­˜å…¥æ•°æ®\nbuffer.flip();   &#x2F;&#x2F; åˆ‡æ¢è¯»æ¨¡å¼\n\nwhile(buffer.hasRemaining()) &#123;\n    channel.write(buffer);\n&#125;</code></pre>\n\n<p>åœ¨ while ä¸­è°ƒç”¨ channel.write æ˜¯å› ä¸º <strong>write æ–¹æ³•å¹¶ä¸èƒ½ä¿è¯ä¸€æ¬¡å°† buffer ä¸­çš„å†…å®¹å…¨éƒ¨å†™å…¥ channel</strong></p>\n<h4 id=\"å…³é—­\"><a href=\"#å…³é—­\" class=\"headerlink\" title=\"å…³é—­\"></a>å…³é—­</h4><p>channel å¿…é¡»å…³é—­ï¼Œä¸è¿‡è°ƒç”¨äº† FileInputStreamã€FileOutputStream æˆ–è€… RandomAccessFile çš„ close æ–¹æ³•ä¼šé—´æ¥åœ°è°ƒç”¨ channel çš„ close æ–¹æ³•</p>\n<h4 id=\"ä½ç½®\"><a href=\"#ä½ç½®\" class=\"headerlink\" title=\"ä½ç½®\"></a>ä½ç½®</h4><p>è·å–å½“å‰ä½ç½®</p>\n<pre class=\"line-numbers language-java\" data-language=\"java\"><code class=\"language-java\">long pos &#x3D; channel.position();</code></pre>\n\n<p>è®¾ç½®å½“å‰ä½ç½®</p>\n<pre class=\"line-numbers language-java\" data-language=\"java\"><code class=\"language-java\">long newPos &#x3D; ...;\nchannel.position(newPos);</code></pre>\n\n<p>è®¾ç½®å½“å‰ä½ç½®æ—¶ï¼Œå¦‚æœè®¾ç½®ä¸ºæ–‡ä»¶çš„æœ«å°¾</p>\n<ul>\n<li>è¿™æ—¶è¯»å–ä¼šè¿”å› -1 </li>\n<li>è¿™æ—¶å†™å…¥ï¼Œä¼šè¿½åŠ å†…å®¹ï¼Œä½†è¦<strong>æ³¨æ„å¦‚æœ position è¶…è¿‡äº†æ–‡ä»¶æœ«å°¾ï¼Œå†å†™å…¥æ—¶åœ¨æ–°å†…å®¹å’ŒåŸæœ«å°¾ä¹‹é—´ä¼šæœ‰ç©ºæ´ï¼ˆ00ï¼‰</strong></li>\n</ul>\n<h4 id=\"å¤§å°\"><a href=\"#å¤§å°\" class=\"headerlink\" title=\"å¤§å°\"></a>å¤§å°</h4><p>ä½¿ç”¨ size æ–¹æ³•è·å–æ–‡ä»¶çš„å¤§å°</p>\n<h4 id=\"å¼ºåˆ¶å†™å…¥\"><a href=\"#å¼ºåˆ¶å†™å…¥\" class=\"headerlink\" title=\"å¼ºåˆ¶å†™å…¥\"></a>å¼ºåˆ¶å†™å…¥</h4><p>ã€æ“ä½œç³»ç»Ÿå‡ºäºæ€§èƒ½çš„è€ƒè™‘ï¼Œä¼šå°†æ•°æ®ç¼“å­˜ã€‘ï¼Œä¸æ˜¯ç«‹åˆ»å†™å…¥ç£ç›˜ã€‚å¯ä»¥è°ƒç”¨ <strong>force(true)  æ–¹æ³•å°†æ–‡ä»¶å†…å®¹å’Œå…ƒæ•°æ®ï¼ˆæ–‡ä»¶çš„æƒé™ç­‰ä¿¡æ¯ï¼‰ç«‹åˆ»å†™å…¥ç£ç›˜</strong></p>\n<h3 id=\"3-2-ä¸¤ä¸ª-Channel-ä¼ è¾“æ•°æ®-nio-c3\"><a href=\"#3-2-ä¸¤ä¸ª-Channel-ä¼ è¾“æ•°æ®-nio-c3\" class=\"headerlink\" title=\"3.2 ä¸¤ä¸ª Channel ä¼ è¾“æ•°æ®-nio.c3\"></a>3.2 ä¸¤ä¸ª Channel ä¼ è¾“æ•°æ®-nio.c3</h3><pre class=\"line-numbers language-java\" data-language=\"java\"><code class=\"language-java\">String FROM &#x3D; &quot;helloword&#x2F;data.txt&quot;;\nString TO &#x3D; &quot;helloword&#x2F;to.txt&quot;;\nlong start &#x3D; System.nanoTime();\ntry (FileChannel from &#x3D; new FileInputStream(FROM).getChannel();\n     FileChannel to &#x3D; new FileOutputStream(TO).getChannel();\n    ) &#123;\n    from.transferTo(0, from.size(), to);&#x2F;&#x2F;\n&#125; catch (IOException e) &#123;\n    e.printStackTrace();\n&#125;\nlong end &#x3D; System.nanoTime();\nSystem.out.println(&quot;transferTo ç”¨æ—¶ï¼š&quot; + (end - start) &#x2F; 1000_000.0);</code></pre>\n\n<p>è¾“å‡º</p>\n<pre class=\"line-numbers language-none\"><code class=\"language-none\">transferTo ç”¨æ—¶ï¼š8.2011</code></pre>\n\n\n\n<p>è¶…è¿‡ 2g å¤§å°çš„æ–‡ä»¶ä¼ è¾“\tTestFileChannelTransferTo</p>\n<pre class=\"line-numbers language-java\" data-language=\"java\"><code class=\"language-java\">public class TestFileChannelTransferTo &#123;\n    public static void main(String[] args) &#123;\n        try (\n                FileChannel from &#x3D; new FileInputStream(&quot;data.txt&quot;).getChannel();\n                FileChannel to &#x3D; new FileOutputStream(&quot;to.txt&quot;).getChannel();\n        ) &#123;\n            &#x2F;&#x2F; æ•ˆç‡é«˜ï¼Œåº•å±‚ä¼šåˆ©ç”¨æ“ä½œç³»ç»Ÿçš„é›¶æ‹·è´è¿›è¡Œä¼˜åŒ–\n            long size &#x3D; from.size();\n            &#x2F;&#x2F; left å˜é‡ä»£è¡¨ã€è¿˜å‰©ä½™å¤šå°‘å­—èŠ‚ã€‘\n            for (long left &#x3D; size; left &gt; 0; ) &#123;\n                System.out.println(&quot;position:&quot; + (size - left) + &quot; left:&quot; + left);\n                left -&#x3D; from.transferTo((size - left), left, to);&#x2F;&#x2F;[sz-left ...-&gt;sz]\n            &#125;\n        &#125; catch (IOException e) &#123;\n            e.printStackTrace();\n        &#125;\n    &#125;\n&#125;</code></pre>\n\n<p>å®é™…ä¼ è¾“ä¸€ä¸ªè¶…å¤§æ–‡ä»¶</p>\n<pre class=\"line-numbers language-none\"><code class=\"language-none\">position:0 left:7769948160\nposition:2147483647 left:5622464513\nposition:4294967294 left:3474980866\nposition:6442450941 left:1327497219</code></pre>\n\n\n\n<h3 id=\"3-3-Path\"><a href=\"#3-3-Path\" class=\"headerlink\" title=\"3.3 Path\"></a>3.3 Path</h3><p>jdk7 å¼•å…¥äº† Path å’Œ Paths ç±»</p>\n<ul>\n<li>Path ç”¨æ¥è¡¨ç¤ºæ–‡ä»¶è·¯å¾„</li>\n<li>Paths æ˜¯å·¥å…·ç±»ï¼Œç”¨æ¥è·å– Path å®ä¾‹</li>\n</ul>\n<pre class=\"line-numbers language-java\" data-language=\"java\"><code class=\"language-java\">Path source &#x3D; Paths.get(&quot;1.txt&quot;); &#x2F;&#x2F; ç›¸å¯¹è·¯å¾„ ä½¿ç”¨ user.dir ç¯å¢ƒå˜é‡æ¥å®šä½ 1.txt\n\nPath source &#x3D; Paths.get(&quot;d:\\\\1.txt&quot;); &#x2F;&#x2F; ç»å¯¹è·¯å¾„ ä»£è¡¨äº†  d:\\1.txt\n\nPath source &#x3D; Paths.get(&quot;d:&#x2F;1.txt&quot;); &#x2F;&#x2F; ç»å¯¹è·¯å¾„ åŒæ ·ä»£è¡¨äº†  d:\\1.txt\n\nPath projects &#x3D; Paths.get(&quot;d:\\\\data&quot;, &quot;projects&quot;); &#x2F;&#x2F; ä»£è¡¨äº†  d:\\data\\projects</code></pre>\n\n<ul>\n<li><code>.</code> ä»£è¡¨äº†å½“å‰è·¯å¾„</li>\n<li><code>..</code> ä»£è¡¨äº†ä¸Šä¸€çº§è·¯å¾„</li>\n</ul>\n<p>ä¾‹å¦‚ç›®å½•ç»“æ„å¦‚ä¸‹</p>\n<pre class=\"line-numbers language-none\"><code class=\"language-none\">d:\n\t|- data\n\t\t|- projects\n\t\t\t|- a\n\t\t\t|- b</code></pre>\n\n<p>ä»£ç </p>\n<pre class=\"line-numbers language-java\" data-language=\"java\"><code class=\"language-java\">Path path &#x3D; Paths.get(&quot;d:\\\\data\\\\projects\\\\a\\\\..\\\\b&quot;);\nSystem.out.println(path);\nSystem.out.println(path.normalize()); &#x2F;&#x2F; æ­£å¸¸åŒ–è·¯å¾„</code></pre>\n\n<p>ä¼šè¾“å‡º</p>\n<pre class=\"line-numbers language-none\"><code class=\"language-none\">d:\\data\\projects\\a\\..\\b\nd:\\data\\projects\\b</code></pre>\n\n\n\n<h3 id=\"3-4-Files\"><a href=\"#3-4-Files\" class=\"headerlink\" title=\"3.4 Files\"></a>3.4 Files</h3><p>æ£€æŸ¥æ–‡ä»¶æ˜¯å¦å­˜åœ¨</p>\n<pre class=\"line-numbers language-java\" data-language=\"java\"><code class=\"language-java\">Path path &#x3D; Paths.get(&quot;helloword&#x2F;data.txt&quot;);\nSystem.out.println(Files.exists(path));&#x2F;&#x2F;</code></pre>\n\n\n\n<p>åˆ›å»ºä¸€çº§ç›®å½•</p>\n<pre class=\"line-numbers language-java\" data-language=\"java\"><code class=\"language-java\">Path path &#x3D; Paths.get(&quot;helloword&#x2F;d1&quot;);\nFiles.createDirectory(path);&#x2F;&#x2F;</code></pre>\n\n<ul>\n<li>å¦‚æœç›®å½•å·²å­˜åœ¨ï¼Œä¼šæŠ›å¼‚å¸¸ FileAlreadyExistsException</li>\n<li>ä¸èƒ½ä¸€æ¬¡åˆ›å»ºå¤šçº§ç›®å½•ï¼Œå¦åˆ™ä¼šæŠ›å¼‚å¸¸ NoSuchFileException</li>\n</ul>\n<p>åˆ›å»ºå¤šçº§ç›®å½•ç”¨</p>\n<pre class=\"line-numbers language-java\" data-language=\"java\"><code class=\"language-java\">Path path &#x3D; Paths.get(&quot;helloword&#x2F;d1&#x2F;d2&quot;);\nFiles.createDirectories(path);&#x2F;&#x2F;</code></pre>\n\n\n\n<p>æ‹·è´æ–‡ä»¶</p>\n<pre class=\"line-numbers language-java\" data-language=\"java\"><code class=\"language-java\">Path source &#x3D; Paths.get(&quot;helloword&#x2F;data.txt&quot;);\nPath target &#x3D; Paths.get(&quot;helloword&#x2F;target.txt&quot;);\n\nFiles.copy(source, target);&#x2F;&#x2F;</code></pre>\n\n<ul>\n<li>å¦‚æœæ–‡ä»¶å·²å­˜åœ¨ï¼Œä¼šæŠ›å¼‚å¸¸ FileAlreadyExistsException</li>\n</ul>\n<p>å¦‚æœ<strong>å¸Œæœ›ç”¨ source è¦†ç›–æ‰ target</strong>ï¼Œéœ€è¦ç”¨ StandardCopyOption æ¥æ§åˆ¶</p>\n<pre class=\"line-numbers language-java\" data-language=\"java\"><code class=\"language-java\">Files.copy(source, target, StandardCopyOption.REPLACE_EXISTING);&#x2F;&#x2F;REPLACE_EXISTING</code></pre>\n\n\n\n<p>ç§»åŠ¨æ–‡ä»¶</p>\n<pre class=\"line-numbers language-java\" data-language=\"java\"><code class=\"language-java\">Path source &#x3D; Paths.get(&quot;helloword&#x2F;data.txt&quot;);\nPath target &#x3D; Paths.get(&quot;helloword&#x2F;data.txt&quot;);\n\nFiles.move(source, target, StandardCopyOption.ATOMIC_MOVE);&#x2F;&#x2F;ATOMIC_MOVE</code></pre>\n\n<ul>\n<li>StandardCopyOption.ATOMIC_MOVE ä¿è¯æ–‡ä»¶ç§»åŠ¨çš„åŸå­æ€§</li>\n</ul>\n<p>åˆ é™¤æ–‡ä»¶</p>\n<pre class=\"line-numbers language-java\" data-language=\"java\"><code class=\"language-java\">Path target &#x3D; Paths.get(&quot;helloword&#x2F;target.txt&quot;);\n\nFiles.delete(target);</code></pre>\n\n<ul>\n<li>å¦‚æœæ–‡ä»¶ä¸å­˜åœ¨ï¼Œä¼šæŠ›å¼‚å¸¸ NoSuchFileException</li>\n</ul>\n<p>åˆ é™¤ç›®å½•</p>\n<pre class=\"line-numbers language-java\" data-language=\"java\"><code class=\"language-java\">Path target &#x3D; Paths.get(&quot;helloword&#x2F;d1&quot;);\n\nFiles.delete(target);</code></pre>\n\n<ul>\n<li>å¦‚æœç›®å½•è¿˜æœ‰å†…å®¹ï¼Œä¼šæŠ›å¼‚å¸¸ <strong>DirectoryNotEmptyException</strong></li>\n</ul>\n<h4 id=\"TestFilesWalkFileTree\"><a href=\"#TestFilesWalkFileTree\" class=\"headerlink\" title=\"TestFilesWalkFileTree\"></a>TestFilesWalkFileTree</h4><p>&#x3D;&#x3D;!Extract Method:ctrl+alt+M&#x3D;&#x3D;</p>\n<p>éå†ç›®å½•æ–‡ä»¶</p>\n<pre class=\"line-numbers language-java\" data-language=\"java\"><code class=\"language-java\">&#x2F;&#x2F;    !Extract Method:ctrl+alt+M\n    private static void m1() throws IOException &#123;\n        AtomicInteger dirCount &#x3D; new AtomicInteger();&#x2F;&#x2F;æ³•ä¸€\n        AtomicInteger fileCount &#x3D; new AtomicInteger();\n&#x2F;&#x2F;        ä¸æ˜¯å¤šçº¿ç¨‹ï¼ŒåŒ¿åç±»é‡Œä¸èƒ½ä½¿ç”¨éfinalçš„ï¼Œæ‰€ä»¥ä½ å¿…é¡»ç”¨å¯¹è±¡å»åšï¼Œæ¢æˆä¸ªæ•°ç»„ä¹Ÿè¡Œã€Integeræ˜¯ä¸å¯å˜ç±»ï¼ä¸èƒ½++ï¼ã€‘\n&#x2F;&#x2F;        å› ä¸ºåŸå­ç±»æ˜¯å¼•ç”¨ç±»å‹ï¼Œæ”¾åˆ°å†…éƒ¨ç±»å½“ä¸­ã€å°†å¼•ç”¨å¤åˆ¶åˆ°å†…éƒ¨ç±»å¯¹è±¡æ‰€åœ¨çš„å †å½“ä¸­ï¼Œä½¿ç”¨åŸºæœ¬æ•°æ®ç±»å‹å¤åˆ¶ä¼šæœ‰æ•°æ®ä¸ä¸€è‡´çš„é—®é¢˜ã€‘\n&#x2F;&#x2F;        final int[] cnt &#x3D; &#123;0&#125;;&#x2F;&#x2F;æ³•äºŒ\n&#x2F;&#x2F;        SimpleFileVisitorå†…éƒ¨ç±»  visitorè®¿é—®è€…æ¨¡å¼ï¼ï¼ï¼\n        Files.walkFileTree(Paths.get(&quot;D:\\\\Software\\\\Program Files\\\\Java\\\\jdk1.8.0_162&quot;), new SimpleFileVisitor&lt;Path&gt;()&#123;\n            @Override\n            public FileVisitResult preVisitDirectory(Path dir, BasicFileAttributes attrs) throws IOException &#123;\n                System.out.println(&quot;&#x3D;&#x3D;&#x3D;&#x3D;&gt;&quot;+dir);\n                dirCount.incrementAndGet();\n&#x2F;&#x2F;                cnt[0]++;\n                return super.preVisitDirectory(dir, attrs);\n            &#125;\n\n            @Override\n            public FileVisitResult visitFile(Path file, BasicFileAttributes attrs) throws IOException &#123;\n                System.out.println(file);\n                fileCount.incrementAndGet();\n                return super.visitFile(file, attrs);\n            &#125;\n        &#125;);\n        System.out.println(&quot;dir count:&quot; +dirCount);\n        System.out.println(&quot;file count:&quot; +fileCount);\n    &#125;</code></pre>\n\n\n\n<p>ç»Ÿè®¡ jar çš„æ•°ç›®</p>\n<pre class=\"line-numbers language-java\" data-language=\"java\"><code class=\"language-java\">private static void m2() throws IOException &#123;\n    AtomicInteger jarCount &#x3D; new AtomicInteger();\n    Files.walkFileTree(Paths.get(&quot;D:\\\\Software\\\\Program Files\\\\Java\\\\jdk1.8.0_162&quot;), new SimpleFileVisitor&lt;Path&gt;()&#123;\n        @Override\n        public FileVisitResult visitFile(Path file, BasicFileAttributes attrs) throws IOException &#123;\n            if (file.toString().endsWith(&quot;.jar&quot;)) &#123;&#x2F;&#x2F;\n                System.out.println(file);\n                jarCount.incrementAndGet();\n            &#125;\n            return super.visitFile(file, attrs);\n        &#125;\n    &#125;);\n    System.out.println(&quot;jar count:&quot; +jarCount);\n&#125;</code></pre>\n\n\n\n<p>åˆ é™¤å¤šçº§ç›®å½•</p>\n<pre class=\"line-numbers language-java\" data-language=\"java\"><code class=\"language-java\">    public static void main(String[] args) throws IOException &#123;\n\n&#x2F;&#x2F;        m1();\n&#x2F;&#x2F;        m2();\n\n        &#x2F;&#x2F;åˆ é™¤å¤šçº§ç›®å½•\n        Files.delete(Paths.get(&quot;D:\\\\Snipaste-1.16.2-x64 - å‰¯æœ¬&quot;));&#x2F;&#x2F;DirectoryNotEmptyException!!!\n        &#x2F;&#x2F;å…ˆåˆ æ–‡ä»¶ï¼Œå†åˆ ç›®å½•\n        Files.walkFileTree(Paths.get(&quot;D:\\\\Snipaste-1.16.2-x64 - å‰¯æœ¬&quot;), new SimpleFileVisitor&lt;Path&gt;() &#123;\n            @Override\n            public FileVisitResult visitFile(Path file, BasicFileAttributes attrs) throws IOException &#123;\n                Files.delete(file);&#x2F;&#x2F;\n                return super.visitFile(file, attrs);\n            &#125;\n            @Override\n            public FileVisitResult postVisitDirectory(Path dir, IOException exc) throws IOException &#123;\n                Files.delete(dir);&#x2F;&#x2F;\n                return super.postVisitDirectory(dir, exc);\n            &#125;\n        &#125;);\n    &#125;\n</code></pre>\n\n\n\n<h4 id=\"âš ï¸-åˆ é™¤å¾ˆå±é™©\"><a href=\"#âš ï¸-åˆ é™¤å¾ˆå±é™©\" class=\"headerlink\" title=\"âš ï¸ åˆ é™¤å¾ˆå±é™©\"></a>âš ï¸ åˆ é™¤å¾ˆå±é™©</h4><blockquote><span class=\"custom-blockquote-svg\"><svg width=\"24\" height=\"24\" viewBox=\"0 0 24 24\" fill=\"\" xmlns=\"http://www.w3.org/2000/svg\" data-reactroot=\"\">\n<path fill=\"\" d=\"M22 12C22 6.5 17.5 2 12 2C6.5 2 2 6.5 2 12C2 17.5 6.5 22 12 22C13.8 22 15.5 21.5 17 20.6L22 22L20.7 17C21.5 15.5 22 13.8 22 12Z\" undefined=\"1\"></path>\n<path fill=\"\" d=\"M15.97 11.5H16.04C17.12 11.5 18 12.38 18 13.47V13.53C18 14.62 17.12 15.5 16.03 15.5H15.96C14.88 15.5 14 14.62 14 13.53V13.46C14 12.38 14.88 11.5 15.97 11.5Z\" undefined=\"1\"></path>\n<path fill=\"\" d=\"M7.97 11.5H8.04C9.12 11.5 10 12.38 10 13.47V13.53C10 14.62 9.12 15.5 8.03 15.5H7.97C6.88 15.5 6 14.62 6 13.53V13.46C6 12.38 6.88 11.5 7.97 11.5Z\" undefined=\"1\"></path>\n<path stroke-linejoin=\"round\" stroke-linecap=\"round\" stroke-miterlimit=\"10\" stroke-width=\"2\" stroke=\"\" d=\"M17 8.5C15.23 8.97 14.07 10.84 14.01 13.27C14 13.33 14 13.4 14 13.47V13.5\"></path>\n<path stroke-linejoin=\"round\" stroke-linecap=\"round\" stroke-miterlimit=\"10\" stroke-width=\"2\" stroke=\"\" d=\"M9 8.5C7.23 8.97 6.07 10.84 6.01 13.27C6 13.33 6 13.4 6 13.47V13.5\"></path>\n<path stroke-linejoin=\"round\" stroke-linecap=\"round\" stroke-miterlimit=\"10\" stroke-width=\"2\" stroke=\"\" d=\"M15.97 11.5H16.04C17.12 11.5 18 12.38 18 13.47V13.53C18 14.62 17.12 15.5 16.03 15.5H15.96C14.88 15.5 14 14.62 14 13.53V13.46C14 12.38 14.88 11.5 15.97 11.5Z\"></path>\n<path stroke-linejoin=\"round\" stroke-linecap=\"round\" stroke-miterlimit=\"10\" stroke-width=\"2\" stroke=\"\" d=\"M7.97 11.5H8.04C9.12 11.5 10 12.38 10 13.47V13.53C10 14.62 9.12 15.5 8.03 15.5H7.97C6.88 15.5 6 14.62 6 13.53V13.46C6 12.38 6.88 11.5 7.97 11.5Z\"></path>\n</svg>\n</span><p>åˆ é™¤æ˜¯å±é™©æ“ä½œï¼Œç¡®ä¿è¦é€’å½’åˆ é™¤çš„æ–‡ä»¶å¤¹æ²¡æœ‰é‡è¦å†…å®¹</p></blockquote>\n<p>æ‹·è´å¤šçº§ç›®å½•\tTestFilesCopy</p>\n<pre class=\"line-numbers language-java\" data-language=\"java\"><code class=\"language-java\">long start &#x3D; System.currentTimeMillis();\nString source &#x3D; &quot;D:\\\\Snipaste-1.16.2-x64&quot;;\nString target &#x3D; &quot;D:\\\\Snipaste-1.16.2-x64aaa&quot;;\n\nFiles.walk(Paths.get(source)).forEach(path -&gt; &#123;\n    try &#123;\n        String targetName &#x3D; path.toString().replace(source, target);\n        &#x2F;&#x2F; æ˜¯ç›®å½•\n        if (Files.isDirectory(path)) &#123;\n            Files.createDirectory(Paths.get(targetName));\n        &#125;\n        &#x2F;&#x2F; æ˜¯æ™®é€šæ–‡ä»¶\n        else if (Files.isRegularFile(path)) &#123;\n            Files.copy(path, Paths.get(targetName));\n        &#125;\n    &#125; catch (IOException e) &#123;\n        e.printStackTrace();\n    &#125;\n&#125;);\nlong end &#x3D; System.currentTimeMillis();\nSystem.out.println(end - start);</code></pre>\n\n\n\n\n\n<h2 id=\"4-ç½‘ç»œç¼–ç¨‹-nio-c4\"><a href=\"#4-ç½‘ç»œç¼–ç¨‹-nio-c4\" class=\"headerlink\" title=\"4. ç½‘ç»œç¼–ç¨‹-nio.c4\"></a>4. ç½‘ç»œç¼–ç¨‹-nio.c4</h2><h3 id=\"4-1-éé˜»å¡-vs-é˜»å¡\"><a href=\"#4-1-éé˜»å¡-vs-é˜»å¡\" class=\"headerlink\" title=\"4.1 éé˜»å¡ vs é˜»å¡\"></a>4.1 éé˜»å¡ vs é˜»å¡</h3><h4 id=\"1ã€é˜»å¡\"><a href=\"#1ã€é˜»å¡\" class=\"headerlink\" title=\"1ã€é˜»å¡\"></a>1ã€é˜»å¡</h4><ul>\n<li>é˜»å¡æ¨¡å¼ä¸‹ï¼Œç›¸å…³æ–¹æ³•éƒ½ä¼šå¯¼è‡´çº¿ç¨‹æš‚åœ<ul>\n<li>ServerSocketChannel.accept ä¼šåœ¨<strong>æ²¡æœ‰è¿æ¥å»ºç«‹æ—¶</strong>è®©çº¿ç¨‹æš‚åœ</li>\n<li>SocketChannel.read ä¼šåœ¨<strong>æ²¡æœ‰æ•°æ®å¯è¯»æ—¶</strong>è®©çº¿ç¨‹æš‚åœ</li>\n<li>é˜»å¡çš„è¡¨ç°å…¶å®å°±æ˜¯çº¿ç¨‹æš‚åœäº†ï¼Œ<strong>æš‚åœæœŸé—´ä¸ä¼šå ç”¨ cpuï¼Œä½†çº¿ç¨‹ç›¸å½“äºé—²ç½®</strong></li>\n</ul>\n</li>\n<li><strong>å•çº¿ç¨‹ä¸‹ï¼Œé˜»å¡æ–¹æ³•ä¹‹é—´ç›¸äº’å½±å“ï¼Œå‡ ä¹ä¸èƒ½æ­£å¸¸å·¥ä½œ</strong>ï¼Œéœ€è¦å¤šçº¿ç¨‹æ”¯æŒ</li>\n<li>ä½†å¤šçº¿ç¨‹ä¸‹ï¼Œæœ‰æ–°çš„é—®é¢˜ï¼Œä½“ç°åœ¨ä»¥ä¸‹æ–¹é¢<ul>\n<li>32 ä½ jvm ä¸€ä¸ªçº¿ç¨‹ 320kï¼Œ<strong>64 ä½ jvm ä¸€ä¸ªçº¿ç¨‹ 1024kï¼Œå¦‚æœè¿æ¥æ•°è¿‡å¤šï¼Œå¿…ç„¶å¯¼è‡´ OOMï¼Œå¹¶ä¸”çº¿ç¨‹å¤ªå¤šï¼Œåè€Œä¼šå› ä¸ºé¢‘ç¹ä¸Šä¸‹æ–‡åˆ‡æ¢å¯¼è‡´æ€§èƒ½é™ä½</strong></li>\n<li>å¯ä»¥é‡‡ç”¨&#x3D;&#x3D;<strong>çº¿ç¨‹æ± æŠ€æœ¯æ¥å‡å°‘çº¿ç¨‹æ•°å’Œçº¿ç¨‹ä¸Šä¸‹æ–‡åˆ‡æ¢ï¼Œä½†æ²»æ ‡ä¸æ²»æœ¬ï¼Œå¦‚æœã€æœ‰å¾ˆå¤šè¿æ¥å»ºç«‹ï¼Œä½†é•¿æ—¶é—´ inactiveï¼Œä¼šé˜»å¡çº¿ç¨‹æ± ä¸­æ‰€æœ‰çº¿ç¨‹ã€‘ï¼Œå› æ­¤ä¸é€‚åˆé•¿è¿æ¥ï¼Œã€åªé€‚åˆçŸ­è¿æ¥ã€‘</strong>&#x3D;&#x3D;</li>\n</ul>\n</li>\n</ul>\n<p>æœåŠ¡å™¨ç«¯</p>\n<pre class=\"line-numbers language-java\" data-language=\"java\"><code class=\"language-java\">&#x2F;&#x2F; ä½¿ç”¨ nio æ¥ç†è§£é˜»å¡æ¨¡å¼, å•çº¿ç¨‹\n&#x2F;&#x2F; 0. ByteBuffer\nByteBuffer buffer &#x3D; ByteBuffer.allocate(16);\n&#x2F;&#x2F; 1. åˆ›å»ºäº†æœåŠ¡å™¨\nServerSocketChannel ssc &#x3D; ServerSocketChannel.open();\n\n&#x2F;&#x2F; 2. ç»‘å®šç›‘å¬ç«¯å£\nssc.bind(new InetSocketAddress(8080));\n\n&#x2F;&#x2F; 3. è¿æ¥é›†åˆ\nList&lt;SocketChannel&gt; channels &#x3D; new ArrayList&lt;&gt;();\nwhile (true) &#123;\n    &#x2F;&#x2F; 4. accept å»ºç«‹ä¸å®¢æˆ·ç«¯è¿æ¥ï¼Œ SocketChannel ç”¨æ¥ä¸å®¢æˆ·ç«¯ä¹‹é—´é€šä¿¡\n    log.debug(&quot;connecting...&quot;);\n    SocketChannel sc &#x3D; ssc.accept(); &#x2F;&#x2F; é˜»å¡æ–¹æ³•ï¼Œçº¿ç¨‹åœæ­¢è¿è¡Œ\n    log.debug(&quot;connected... &#123;&#125;&quot;, sc);\n    channels.add(sc);\n    for (SocketChannel channel : channels) &#123;\n        &#x2F;&#x2F; 5. æ¥æ”¶å®¢æˆ·ç«¯å‘é€çš„æ•°æ®\n        log.debug(&quot;before read... &#123;&#125;&quot;, channel);\n        channel.read(buffer); &#x2F;&#x2F; é˜»å¡æ–¹æ³•ï¼Œçº¿ç¨‹åœæ­¢è¿è¡Œ\n        buffer.flip();\n        debugRead(buffer);\n        buffer.clear();\n        log.debug(&quot;after read...&#123;&#125;&quot;, channel);\n    &#125;\n&#125;</code></pre>\n\n<p>å®¢æˆ·ç«¯</p>\n<pre class=\"line-numbers language-java\" data-language=\"java\"><code class=\"language-java\">        SocketChannel sc &#x3D; SocketChannel.open();\n        sc.connect(new InetSocketAddress(&quot;localhost&quot;, 8080));\n        SocketAddress address &#x3D; sc.getLocalAddress();\n        System.out.println(&quot;waiting...&quot;);\n&#x2F;&#x2F;        sc.close();</code></pre>\n\n\n\n<p>Sï¼šrun\tconnecting\tbefore read()</p>\n<p><strong>C:debug sc-å³é”®evaluate expression</strong>ï¼šsc.write(Charset.defaultCharset().encode(â€œhelloâ€));</p>\n<p>å†å‘â€œhiâ€ï¼Œæ²¡ååº”ï¼éœ€è¦å»ºç«‹æ–°è¿æ¥ï¼</p>\n<p>&#x3D;&#x3D;Client-edit conf-å‹¾é€‰Alow parallel runï¼šdebug æ–°C&#x3D;&#x3D;</p>\n<p>sc.write(Charset.defaultCharset().encode(â€œhiâ€));</p>\n<p>å•çº¿ç¨‹å¤„ç†å¤šä¸ªè¿æ¥ï¼šaccept() read()å‡é˜»å¡ï¼</p>\n<h4 id=\"2ã€éé˜»å¡\"><a href=\"#2ã€éé˜»å¡\" class=\"headerlink\" title=\"2ã€éé˜»å¡\"></a>2ã€éé˜»å¡</h4><ul>\n<li>éé˜»å¡æ¨¡å¼ä¸‹ï¼Œç›¸å…³æ–¹æ³•éƒ½ä¸ä¼šè®©çº¿ç¨‹æš‚åœ<ul>\n<li>åœ¨ ServerSocketChannel.accept åœ¨æ²¡æœ‰è¿æ¥å»ºç«‹æ—¶ï¼Œ<strong>ä¼šè¿”å› nullï¼Œç»§ç»­è¿è¡Œ</strong></li>\n<li>SocketChannel.read åœ¨æ²¡æœ‰æ•°æ®å¯è¯»æ—¶ï¼Œ<strong>ä¼šè¿”å› 0ï¼Œä½†çº¿ç¨‹ä¸å¿…é˜»å¡ï¼Œå¯ä»¥å»æ‰§è¡Œå…¶å®ƒ SocketChannel çš„ read æˆ–æ˜¯å»æ‰§è¡Œ ServerSocketChannel.accept</strong> </li>\n<li>å†™æ•°æ®æ—¶ï¼Œçº¿ç¨‹<strong>åªæ˜¯ç­‰å¾…æ•°æ®å†™å…¥ Channel å³å¯ï¼Œæ— éœ€ç­‰ Channel é€šè¿‡ç½‘ç»œæŠŠæ•°æ®å‘é€å‡ºå»</strong></li>\n</ul>\n</li>\n<li>ä½†&#x3D;&#x3D;éé˜»å¡æ¨¡å¼ä¸‹ï¼Œ<strong>å³ä½¿æ²¡æœ‰</strong>è¿æ¥å»ºç«‹ï¼Œå’Œå¯è¯»æ•°æ®ï¼Œ<strong>çº¿ç¨‹ä»ç„¶åœ¨ä¸æ–­è¿è¡Œï¼Œç™½ç™½æµªè´¹äº† cpuï¼ï¼ï¼&#x3D;&#x3D;</strong></li>\n<li>&#x3D;&#x3D;<strong>æ•°æ®ã€å¤åˆ¶ã€‘</strong>è¿‡ç¨‹ä¸­ï¼Œ<strong>çº¿ç¨‹å®é™…è¿˜æ˜¯é˜»å¡çš„ï¼ˆAIO[å¼‚æ­¥ï¼] æ”¹è¿›</strong>çš„åœ°æ–¹ï¼‰&#x3D;&#x3D;</li>\n</ul>\n<p>æœåŠ¡å™¨ç«¯ï¼Œå®¢æˆ·ç«¯ä»£ç ä¸å˜</p>\n<pre class=\"line-numbers language-java\" data-language=\"java\"><code class=\"language-java\">&#x2F;&#x2F; ä½¿ç”¨ nio æ¥ç†è§£éé˜»å¡æ¨¡å¼, å•çº¿ç¨‹\n&#x2F;&#x2F; 0. ByteBuffer\nByteBuffer buffer &#x3D; ByteBuffer.allocate(16);\n&#x2F;&#x2F; 1. åˆ›å»ºäº†æœåŠ¡å™¨\nServerSocketChannel ssc &#x3D; ServerSocketChannel.open();\nssc.configureBlocking(false); &#x2F;&#x2F; éé˜»å¡æ¨¡å¼\n&#x2F;&#x2F; 2. ç»‘å®šç›‘å¬ç«¯å£\nssc.bind(new InetSocketAddress(8080));\n&#x2F;&#x2F; 3. è¿æ¥é›†åˆ\nList&lt;SocketChannel&gt; channels &#x3D; new ArrayList&lt;&gt;();\nwhile (true) &#123;\n    &#x2F;&#x2F; 4. accept å»ºç«‹ä¸å®¢æˆ·ç«¯è¿æ¥ï¼Œ SocketChannel ç”¨æ¥ä¸å®¢æˆ·ç«¯ä¹‹é—´é€šä¿¡\n    SocketChannel sc &#x3D; ssc.accept(); &#x2F;&#x2F; éé˜»å¡ï¼Œçº¿ç¨‹è¿˜ä¼šç»§ç»­è¿è¡Œï¼Œå¦‚æœæ²¡æœ‰è¿æ¥å»ºç«‹ï¼Œä½†scæ˜¯null\n    if (sc !&#x3D; null) &#123;\n        log.debug(&quot;connected... &#123;&#125;&quot;, sc);\n        sc.configureBlocking(false); &#x2F;&#x2F; éé˜»å¡æ¨¡å¼\n        channels.add(sc);\n    &#125;\n    for (SocketChannel channel : channels) &#123;\n        &#x2F;&#x2F; 5. æ¥æ”¶å®¢æˆ·ç«¯å‘é€çš„æ•°æ®\n        int read &#x3D; channel.read(buffer);&#x2F;&#x2F; éé˜»å¡ï¼Œçº¿ç¨‹ä»ç„¶ä¼šç»§ç»­è¿è¡Œï¼Œå¦‚æœæ²¡æœ‰è¯»åˆ°æ•°æ®ï¼Œread è¿”å› 0\n        if (read &gt; 0) &#123;\n            buffer.flip();\n            debugRead(buffer);\n            buffer.clear();\n            log.debug(&quot;after read...&#123;&#125;&quot;, channel);\n        &#125;\n    &#125;\n&#125;</code></pre>\n\n<p>å•çº¿ç¨‹å¤„ç†å¤šä¸ªè¿æ¥</p>\n<pre class=\"line-numbers language-java\" data-language=\"java\"><code class=\"language-java\">12:39:32 [DEBUG] [main] c.i.nio.c4.Server - connected... java.nio.channels.SocketChannel[connected local&#x3D;&#x2F;127.0.0.1:8080 remote&#x3D;&#x2F;127.0.0.1:11261]\n12:39:40 [DEBUG] [main] c.i.nio.c4.Server - connected... java.nio.channels.SocketChannel[connected local&#x3D;&#x2F;127.0.0.1:8080 remote&#x3D;&#x2F;127.0.0.1:11268]\n12:39:47 [DEBUG] [main] c.i.nio.c4.Server - connected... java.nio.channels.SocketChannel[connected local&#x3D;&#x2F;127.0.0.1:8080 remote&#x3D;&#x2F;127.0.0.1:11284]</code></pre>\n\n\n\n<h3 id=\"å®æˆ˜ï¼šnio-c4ï¼ï¼ï¼\"><a href=\"#å®æˆ˜ï¼šnio-c4ï¼ï¼ï¼\" class=\"headerlink\" title=\"å®æˆ˜ï¼šnio.c4ï¼ï¼ï¼\"></a>å®æˆ˜ï¼šnio.c4ï¼ï¼ï¼</h3><p>Client</p>\n<pre class=\"line-numbers language-java\" data-language=\"java\"><code class=\"language-java\">public class Client &#123;\n    public static void main(String[] args) throws IOException &#123;\n        SocketChannel sc &#x3D; SocketChannel.open();\n        sc.connect(new InetSocketAddress(&quot;localhost&quot;, 8080));\n        SocketAddress address &#x3D; sc.getLocalAddress();\n        System.out.println(&quot;waiting...&quot;);\n&#x2F;&#x2F;        sc.close();\n    &#125;\n&#125;</code></pre>\n\n\n\n<p>Server</p>\n<pre class=\"line-numbers language-java\" data-language=\"java\"><code class=\"language-java\">package cn.itcast.nio.c4;\n\nimport lombok.extern.slf4j.Slf4j;\n\nimport java.io.IOException;\nimport java.net.InetSocketAddress;\nimport java.nio.ByteBuffer;\nimport java.nio.channels.*;\nimport java.nio.charset.Charset;\nimport java.util.ArrayList;\nimport java.util.Iterator;\nimport java.util.List;\n\nimport static cn.itcast.nio.c2.ByteBufferUtil.debugRead;\n\n@Slf4j\npublic class Server &#123;\n\n    public static void main(String[] args) throws IOException &#123;\n&#x2F;&#x2F;&#x2F;&#x2F; ä½¿ç”¨ nio æ¥ç†è§£éé˜»å¡æ¨¡å¼, å•çº¿ç¨‹\n&#x2F;&#x2F;&#x2F;&#x2F; 0. ByteBuffer\n&#x2F;&#x2F;        ByteBuffer buffer &#x3D; ByteBuffer.allocate(16);\n&#x2F;&#x2F;&#x2F;&#x2F; 1. åˆ›å»ºäº†æœåŠ¡å™¨\n&#x2F;&#x2F;        ServerSocketChannel ssc &#x3D; ServerSocketChannel.open();\n&#x2F;&#x2F;        ssc.configureBlocking(false); &#x2F;&#x2F; éé˜»å¡æ¨¡å¼\n&#x2F;&#x2F;&#x2F;&#x2F; 2. ç»‘å®šç›‘å¬ç«¯å£\n&#x2F;&#x2F;        ssc.bind(new InetSocketAddress(8080));\n&#x2F;&#x2F;&#x2F;&#x2F; 3. è¿æ¥é›†åˆ\n&#x2F;&#x2F;        List&lt;SocketChannel&gt; channels &#x3D; new ArrayList&lt;&gt;();\n&#x2F;&#x2F;        while (true) &#123;\n&#x2F;&#x2F;            &#x2F;&#x2F; 4. accept å»ºç«‹ä¸å®¢æˆ·ç«¯è¿æ¥ï¼Œ SocketChannel ç”¨æ¥ä¸å®¢æˆ·ç«¯ä¹‹é—´é€šä¿¡\n&#x2F;&#x2F;            SocketChannel sc &#x3D; ssc.accept(); &#x2F;&#x2F; éé˜»å¡ï¼Œçº¿ç¨‹è¿˜ä¼šç»§ç»­è¿è¡Œï¼Œå¦‚æœæ²¡æœ‰è¿æ¥å»ºç«‹ï¼Œä½†scæ˜¯null\n&#x2F;&#x2F;            if (sc !&#x3D; null) &#123;\n&#x2F;&#x2F;                log.debug(&quot;connected... &#123;&#125;&quot;, sc);\n&#x2F;&#x2F;                sc.configureBlocking(false); &#x2F;&#x2F; éé˜»å¡æ¨¡å¼\n&#x2F;&#x2F;                channels.add(sc);\n&#x2F;&#x2F;            &#125;\n&#x2F;&#x2F;            for (SocketChannel channel : channels) &#123;\n&#x2F;&#x2F;                &#x2F;&#x2F; 5. æ¥æ”¶å®¢æˆ·ç«¯å‘é€çš„æ•°æ®\n&#x2F;&#x2F;                int read &#x3D; channel.read(buffer);&#x2F;&#x2F; éé˜»å¡ï¼Œçº¿ç¨‹ä»ç„¶ä¼šç»§ç»­è¿è¡Œï¼Œå¦‚æœæ²¡æœ‰è¯»åˆ°æ•°æ®ï¼Œread è¿”å› 0\n&#x2F;&#x2F;                if (read &gt; 0) &#123;\n&#x2F;&#x2F;                    buffer.flip();\n&#x2F;&#x2F;                    debugRead(buffer);\n&#x2F;&#x2F;                    buffer.clear();\n&#x2F;&#x2F;                    log.debug(&quot;after read...&#123;&#125;&quot;, channel);\n&#x2F;&#x2F;                &#125;\n&#x2F;&#x2F;            &#125;\n&#x2F;&#x2F;        &#125;\n\n\n        &#x2F;&#x2F; 1. åˆ›å»º selector, ç®¡ç†å¤šä¸ª channel\n        Selector selector &#x3D; Selector.open();\n        ServerSocketChannel ssc &#x3D; ServerSocketChannel.open();\n        ssc.configureBlocking(false);\n        &#x2F;&#x2F; 2. å»ºç«‹ selector å’Œ channel çš„è”ç³»ï¼ˆ&lt;-æ³¨å†Œï¼‰\n        &#x2F;&#x2F; SelectionKey å°±æ˜¯å°†æ¥äº‹ä»¶å‘ç”Ÿåï¼Œé€šè¿‡å®ƒå¯ä»¥çŸ¥é“å½“å‰æ˜¯å“ªä¸ªäº‹ä»¶å’Œå“ªä¸ªchannelçš„äº‹ä»¶\n        SelectionKey sscKey &#x3D; ssc.register(selector, 0, null);\n        &#x2F;&#x2F; key åªå…³æ³¨ accept äº‹ä»¶ï¼šç›‘å¬æ–°çš„è¿æ¥è¯·æ±‚\n        sscKey.interestOps(SelectionKey.OP_ACCEPT);\n        log.debug(&quot;sscKey:&#123;&#125;&quot;, sscKey);\n\n        &#x2F;&#x2F;è§‚å¯Ÿè€…æ¨¡å¼ï¼Ÿï¼Ÿï¼Ÿ\n        ssc.bind(new InetSocketAddress(8080));\n        while (true) &#123;\n            &#x2F;&#x2F; 3. ã€select æ–¹æ³•ï¼š æ²¡æœ‰äº‹ä»¶å‘ç”Ÿï¼Œçº¿ç¨‹é˜»å¡ï¼Œæœ‰äº‹ä»¶ï¼Œçº¿ç¨‹æ‰ä¼šæ¢å¤è¿è¡Œã€‘\n            &#x2F;&#x2F; select åœ¨ã€äº‹ä»¶æœªå¤„ç†æ—¶ï¼Œå®ƒä¸ä¼šé˜»å¡ã€‘, äº‹ä»¶å‘ç”Ÿåè¦ä¹ˆå¤„ç†ï¼Œè¦ä¹ˆå–æ¶ˆkey.cancel()ï¼Œä¸èƒ½ç½®ä¹‹ä¸ç†ï¼ä»–ä¼šç»§ç»­è®©ä½ å¤„ç†curï¼Œéé˜»å¡æ­»å¾ªç¯ï¼\n            selector.select();\n            &#x2F;&#x2F; 4. å¤„ç†äº‹ä»¶, selectedKeys å†…éƒ¨åŒ…å«äº†æ‰€æœ‰å‘ç”Ÿçš„äº‹ä»¶\n            &#x2F;&#x2F; è¾¹éå†è¾¹åˆ é™¤ï¼šä¸è¦ç”¨å¢å¼ºforéå†ï¼Œç”¨iteréå†ï¼iter.remove();ï¼\n            Iterator&lt;SelectionKey&gt; iter &#x3D; selector.selectedKeys().iterator(); &#x2F;&#x2F; accept, read\n            while (iter.hasNext()) &#123;\n                SelectionKey key &#x3D; iter.next();\n                &#x2F;&#x2F; å¤„ç†key æ—¶ï¼Œè¦ä» selectedKeys(åª+ä¸-) é›†åˆä¸­ä¸»åŠ¨åˆ é™¤ï¼Œå¦åˆ™ä¸‹æ¬¡å¤„ç†(æ²¡äº‹ä»¶)å°±ä¼šæœ‰é—®é¢˜:NullPointerException!!!\n                iter.remove();\n                log.debug(&quot;key: &#123;&#125;&quot;, key);\n\n                &#x2F;&#x2F; 5. åŒºåˆ†äº‹ä»¶ç±»å‹\n                if (key.isAcceptable()) &#123; &#x2F;&#x2F; å¦‚æœæ˜¯ accept\n                    ServerSocketChannel channel &#x3D; (ServerSocketChannel) key.channel();\n                    SocketChannel sc &#x3D; channel.accept();&#x2F;&#x2F;if(å¤„ç†å®Œï¼Œssckeyä¸åˆ ):ä¸‹æ¬¡å†accept()ä¼šNullPointerException! æ•…è¦ä¸»åŠ¨iter.remove()!\n                    sc.configureBlocking(false);\n\n                    SelectionKey scKey &#x3D; sc.register(selector, 0, null);\n                    scKey.interestOps(SelectionKey.OP_READ);&#x2F;&#x2F;acceptåæ³¨å†Œåˆ°readä¸Šï¼\n                    log.debug(&quot;&#123;&#125;&quot;, sc);\n                    log.debug(&quot;scKey:&#123;&#125;&quot;, scKey);\n                &#125; else if (key.isReadable()) &#123; &#x2F;&#x2F; å¦‚æœæ˜¯ read\n                    try &#123;\n                        SocketChannel channel &#x3D; (SocketChannel) key.channel(); &#x2F;&#x2F; æ‹¿åˆ°è§¦å‘äº‹ä»¶çš„channel\n                        ByteBuffer buffer &#x3D; ByteBuffer.allocate(4);\n                        int read &#x3D; channel.read(buffer); &#x2F;&#x2F; å¦‚æœæ˜¯æ­£å¸¸æ–­å¼€ï¼Œread çš„æ–¹æ³•çš„è¿”å›å€¼æ˜¯ -1\n                        if(read &#x3D;&#x3D; -1) &#123;\n                            key.cancel();&#x2F;&#x2F;å–æ¶ˆ!!!sc.close()æ­£å¸¸æ–­å¼€ï¼\n                        &#125; else &#123;\n                            buffer.flip();\n&#x2F;&#x2F;                            debugAll(buffer);\n                            System.out.println(Charset.defaultCharset().decode(buffer));\n                        &#125;\n                    &#125; catch (IOException e) &#123;\n                        e.printStackTrace();\n                        &#x2F;&#x2F; å› ä¸ºå®¢æˆ·ç«¯(å¼‚å¸¸)æ–­å¼€äº†,å› æ­¤éœ€è¦å°† key å–æ¶ˆï¼ˆä» selector çš„ keys é›†åˆä¸­çœŸæ­£åˆ é™¤ keyï¼‰å¤„ç†å¼‚å¸¸ï¼Œaccept()é˜»å¡ï¼šå¦åˆ™æ­»å¾ªç¯æŠ›å¼‚å¸¸ï¼\n                        key.cancel();\n                    &#125;\n                &#125;\n            &#125;\n        &#125;\n    &#125;\n&#125;\n</code></pre>\n\n<p>iter.remove();</p>\n<p><img src=\"http://cache.itzy8.top/%E5%AD%A6Netty-%E9%BB%91%E9%A9%AC%E6%BB%A1%E5%93%A5/image-20220422154114082.png\" alt=\"image-20220422154114082\"></p>\n<p>å¼‚å¸¸æ–­å¼€ï¼štry-catch:cancel()\tsc.close()æ­£å¸¸æ–­å¼€:read&#x3D;&#x3D;-1:cancel()\tå¦åˆ™æ­»å¾ªç¯ï¼</p>\n<p>utf8:ä¸­æ–‡3B</p>\n<p><img src=\"http://cache.itzy8.top/%E5%AD%A6Netty-%E9%BB%91%E9%A9%AC%E6%BB%A1%E5%93%A5/image-20220422155300433.png\" alt=\"image-20220422155300433\"></p>\n<pre class=\"line-numbers language-none\"><code class=\"language-none\">sc.write(Charset.defaultCharset().encode(&quot;ä¸­å›½&quot;));</code></pre>\n\n<p>åŠåŒ…ç°è±¡ï¼</p>\n<h3 id=\"ã€åˆ†æ­¥è®²è§£ã€‘4-2-Selector\"><a href=\"#ã€åˆ†æ­¥è®²è§£ã€‘4-2-Selector\" class=\"headerlink\" title=\"ã€åˆ†æ­¥è®²è§£ã€‘4.2 Selector\"></a>ã€åˆ†æ­¥è®²è§£ã€‘4.2 Selector</h3><pre class=\"line-numbers language-mermaid\" data-language=\"mermaid\"><code class=\"language-mermaid\">graph TD\nsubgraph selector ç‰ˆ\nthread --&gt; selector\nselector --&gt; c1(channel)\nselector --&gt; c2(channel)\nselector --&gt; c3(channel)\nend</code></pre>\n\n\n\n<h4 id=\"3ã€å¤šè·¯å¤ç”¨\"><a href=\"#3ã€å¤šè·¯å¤ç”¨\" class=\"headerlink\" title=\"3ã€å¤šè·¯å¤ç”¨\"></a>3ã€å¤šè·¯å¤ç”¨</h4><p><strong>å•çº¿ç¨‹å¯ä»¥é…åˆ Selector å®Œæˆå¯¹å¤šä¸ª Channel å¯è¯»å†™ã€äº‹ä»¶ã€‘çš„ç›‘æ§</strong>ï¼Œè¿™ç§°ä¹‹ä¸ºå¤šè·¯å¤ç”¨</p>\n<ul>\n<li><strong>å¤šè·¯å¤ç”¨ä»…é’ˆå¯¹ç½‘ç»œ IO</strong>ã€æ™®é€šæ–‡ä»¶ IO æ²¡æ³•åˆ©ç”¨å¤šè·¯å¤ç”¨</li>\n<li>å¦‚æœä¸ç”¨ Selector çš„éé˜»å¡æ¨¡å¼ï¼Œçº¿ç¨‹å¤§éƒ¨åˆ†æ—¶é—´éƒ½åœ¨åšæ— ç”¨åŠŸï¼Œè€Œ Selector èƒ½å¤Ÿä¿è¯<ul>\n<li><strong>æœ‰å¯</strong>è¿æ¥<strong>äº‹ä»¶æ—¶æ‰å»</strong>è¿æ¥</li>\n<li>æœ‰å¯è¯»äº‹ä»¶æ‰å»è¯»å–</li>\n<li>æœ‰å¯å†™äº‹ä»¶æ‰å»å†™å…¥<ul>\n<li><strong>é™äºç½‘ç»œä¼ è¾“èƒ½åŠ›ï¼ŒChannel æœªå¿…æ—¶æ—¶å¯å†™ï¼Œä¸€æ—¦ Channel å¯å†™ï¼Œä¼šè§¦å‘ Selector çš„å¯å†™äº‹ä»¶</strong></li>\n</ul>\n</li>\n</ul>\n</li>\n</ul>\n<p>å¥½å¤„</p>\n<ul>\n<li>ä¸€ä¸ªçº¿ç¨‹é…åˆ selector å°±å¯ä»¥ç›‘æ§å¤šä¸ª channel çš„äº‹ä»¶ï¼Œäº‹ä»¶å‘ç”Ÿçº¿ç¨‹æ‰å»å¤„ç†ã€‚é¿å…éé˜»å¡æ¨¡å¼ä¸‹æ‰€åšæ— ç”¨åŠŸ</li>\n<li>è®©è¿™ä¸ªçº¿ç¨‹èƒ½å¤Ÿè¢«å……åˆ†åˆ©ç”¨</li>\n<li>èŠ‚çº¦äº†çº¿ç¨‹çš„æ•°é‡</li>\n<li>å‡å°‘äº†çº¿ç¨‹ä¸Šä¸‹æ–‡åˆ‡æ¢</li>\n</ul>\n<h4 id=\"åˆ›å»º\"><a href=\"#åˆ›å»º\" class=\"headerlink\" title=\"åˆ›å»º\"></a>åˆ›å»º</h4><pre class=\"line-numbers language-java\" data-language=\"java\"><code class=\"language-java\">Selector selector &#x3D; Selector.open();</code></pre>\n\n\n\n<h4 id=\"ç»‘å®š-Channel-äº‹ä»¶\"><a href=\"#ç»‘å®š-Channel-äº‹ä»¶\" class=\"headerlink\" title=\"ç»‘å®š Channel äº‹ä»¶\"></a>ç»‘å®š Channel äº‹ä»¶</h4><p>ä¹Ÿç§°ä¹‹ä¸ºæ³¨å†Œäº‹ä»¶ï¼Œç»‘å®šçš„äº‹ä»¶ selector æ‰ä¼šå…³å¿ƒ </p>\n<pre class=\"line-numbers language-java\" data-language=\"java\"><code class=\"language-java\">channel.configureBlocking(false);\nSelectionKey key &#x3D; channel.register(selector, ç»‘å®šäº‹ä»¶);</code></pre>\n\n<ul>\n<li>channel å¿…é¡»å·¥ä½œåœ¨éé˜»å¡æ¨¡å¼</li>\n<li><strong>FileChannel æ²¡æœ‰éé˜»å¡æ¨¡å¼</strong>ï¼Œå› æ­¤ä¸èƒ½é…åˆ selector ä¸€èµ·ä½¿ç”¨</li>\n<li>ç»‘å®šçš„äº‹ä»¶ç±»å‹å¯ä»¥æœ‰<ul>\n<li>ã€connect - å®¢æˆ·ç«¯è¿æ¥æˆåŠŸã€‘æ—¶è§¦å‘</li>\n<li>accept - æœåŠ¡å™¨ç«¯æˆåŠŸæ¥å—è¿æ¥æ—¶è§¦å‘</li>\n<li>read - æ•°æ®å¯è¯»å…¥æ—¶è§¦å‘ï¼Œæœ‰å› ä¸ºSæ¥æ”¶èƒ½åŠ›å¼±ï¼Œæ•°æ®æš‚ä¸èƒ½è¯»å…¥çš„æƒ…å†µ</li>\n<li>write - æ•°æ®å¯å†™å‡ºæ—¶è§¦å‘ï¼Œæœ‰å› ä¸ºSå‘é€èƒ½åŠ›å¼±ï¼Œæ•°æ®æš‚ä¸èƒ½å†™å‡ºçš„æƒ…å†µ</li>\n</ul>\n</li>\n</ul>\n<h4 id=\"ç›‘å¬-Channel-äº‹ä»¶\"><a href=\"#ç›‘å¬-Channel-äº‹ä»¶\" class=\"headerlink\" title=\"ç›‘å¬ Channel äº‹ä»¶\"></a>ç›‘å¬ Channel äº‹ä»¶</h4><p>å¯ä»¥é€šè¿‡ä¸‹é¢ä¸‰ç§æ–¹æ³•æ¥ç›‘å¬æ˜¯å¦æœ‰äº‹ä»¶å‘ç”Ÿï¼Œæ–¹æ³•çš„è¿”å›å€¼ä»£è¡¨æœ‰å¤šå°‘ channel å‘ç”Ÿäº†äº‹ä»¶</p>\n<p>æ–¹æ³•1ï¼Œé˜»å¡ç›´åˆ°ç»‘å®šäº‹ä»¶å‘ç”Ÿ</p>\n<pre class=\"line-numbers language-java\" data-language=\"java\"><code class=\"language-java\">int count &#x3D; selector.select();</code></pre>\n\n\n\n<p>æ–¹æ³•2ï¼Œé˜»å¡ç›´åˆ°ç»‘å®šäº‹ä»¶å‘ç”Ÿï¼Œæˆ–æ˜¯è¶…æ—¶ï¼ˆæ—¶é—´å•ä½ä¸º msï¼‰</p>\n<pre class=\"line-numbers language-java\" data-language=\"java\"><code class=\"language-java\">int count &#x3D; selector.select(long timeout);</code></pre>\n\n\n\n<p>æ–¹æ³•3ï¼Œä¸ä¼šé˜»å¡ï¼Œä¹Ÿå°±æ˜¯ä¸ç®¡æœ‰æ²¡æœ‰äº‹ä»¶ï¼Œç«‹åˆ»è¿”å›ï¼Œè‡ªå·±æ ¹æ®è¿”å›å€¼(äº‹ä»¶æ•°)æ£€æŸ¥æ˜¯å¦æœ‰äº‹ä»¶</p>\n<pre class=\"line-numbers language-java\" data-language=\"java\"><code class=\"language-java\">int count &#x3D; selector.selectNow();</code></pre>\n\n\n\n<h4 id=\"ğŸ’¡-select-ä½•æ—¶ä¸é˜»å¡\"><a href=\"#ğŸ’¡-select-ä½•æ—¶ä¸é˜»å¡\" class=\"headerlink\" title=\"ğŸ’¡ select ä½•æ—¶ä¸é˜»å¡\"></a>ğŸ’¡ select ä½•æ—¶ä¸é˜»å¡</h4><blockquote><span class=\"custom-blockquote-svg\"><svg width=\"24\" height=\"24\" viewBox=\"0 0 24 24\" fill=\"\" xmlns=\"http://www.w3.org/2000/svg\" data-reactroot=\"\">\n<path fill=\"\" d=\"M22 12C22 6.5 17.5 2 12 2C6.5 2 2 6.5 2 12C2 17.5 6.5 22 12 22C13.8 22 15.5 21.5 17 20.6L22 22L20.7 17C21.5 15.5 22 13.8 22 12Z\" undefined=\"1\"></path>\n<path fill=\"\" d=\"M15.97 11.5H16.04C17.12 11.5 18 12.38 18 13.47V13.53C18 14.62 17.12 15.5 16.03 15.5H15.96C14.88 15.5 14 14.62 14 13.53V13.46C14 12.38 14.88 11.5 15.97 11.5Z\" undefined=\"1\"></path>\n<path fill=\"\" d=\"M7.97 11.5H8.04C9.12 11.5 10 12.38 10 13.47V13.53C10 14.62 9.12 15.5 8.03 15.5H7.97C6.88 15.5 6 14.62 6 13.53V13.46C6 12.38 6.88 11.5 7.97 11.5Z\" undefined=\"1\"></path>\n<path stroke-linejoin=\"round\" stroke-linecap=\"round\" stroke-miterlimit=\"10\" stroke-width=\"2\" stroke=\"\" d=\"M17 8.5C15.23 8.97 14.07 10.84 14.01 13.27C14 13.33 14 13.4 14 13.47V13.5\"></path>\n<path stroke-linejoin=\"round\" stroke-linecap=\"round\" stroke-miterlimit=\"10\" stroke-width=\"2\" stroke=\"\" d=\"M9 8.5C7.23 8.97 6.07 10.84 6.01 13.27C6 13.33 6 13.4 6 13.47V13.5\"></path>\n<path stroke-linejoin=\"round\" stroke-linecap=\"round\" stroke-miterlimit=\"10\" stroke-width=\"2\" stroke=\"\" d=\"M15.97 11.5H16.04C17.12 11.5 18 12.38 18 13.47V13.53C18 14.62 17.12 15.5 16.03 15.5H15.96C14.88 15.5 14 14.62 14 13.53V13.46C14 12.38 14.88 11.5 15.97 11.5Z\"></path>\n<path stroke-linejoin=\"round\" stroke-linecap=\"round\" stroke-miterlimit=\"10\" stroke-width=\"2\" stroke=\"\" d=\"M7.97 11.5H8.04C9.12 11.5 10 12.38 10 13.47V13.53C10 14.62 9.12 15.5 8.03 15.5H7.97C6.88 15.5 6 14.62 6 13.53V13.46C6 12.38 6.88 11.5 7.97 11.5Z\"></path>\n</svg>\n</span><ul>\n<li>äº‹ä»¶å‘ç”Ÿæ—¶<ul>\n<li>å®¢æˆ·ç«¯å‘èµ·è¿æ¥è¯·æ±‚ï¼Œä¼šè§¦å‘ accept äº‹ä»¶</li>\n<li>ã€å®¢æˆ·ç«¯å‘é€æ•°æ®è¿‡æ¥ï¼Œå®¢æˆ·ç«¯æ­£å¸¸ã€å¼‚å¸¸å…³é—­æ—¶ã€‘ï¼Œéƒ½ä¼šè§¦å‘ read äº‹ä»¶ï¼Œå¦å¤–å¦‚æœå®¢æˆ·ç«¯å‘é€çš„æ•°æ®<strong>å¤§äº buffer ç¼“å†²åŒºï¼Œä¼šè§¦å‘å¤šæ¬¡è¯»å–</strong>äº‹ä»¶</li>\n<li>channel å¯å†™ï¼Œä¼šè§¦å‘ write äº‹ä»¶</li>\n<li>åœ¨ <strong>linux ä¸‹ nio bug å‘ç”Ÿ</strong>æ—¶</li>\n</ul>\n</li>\n<li>è°ƒç”¨ <strong>selector.wakeup()</strong></li>\n<li>è°ƒç”¨ <strong>selector.close()</strong></li>\n<li>selector æ‰€åœ¨<strong>çº¿ç¨‹ interrupt</strong></li>\n</ul></blockquote>\n<h3 id=\"4-3-å¤„ç†-accept-äº‹ä»¶\"><a href=\"#4-3-å¤„ç†-accept-äº‹ä»¶\" class=\"headerlink\" title=\"4.3 å¤„ç† accept äº‹ä»¶\"></a>4.3 å¤„ç† accept äº‹ä»¶</h3><p>å®¢æˆ·ç«¯ä»£ç ä¸º</p>\n<pre class=\"line-numbers language-java\" data-language=\"java\"><code class=\"language-java\">public class Client &#123;\n    public static void main(String[] args) &#123;\n        try (Socket socket &#x3D; new Socket(&quot;localhost&quot;, 8080)) &#123;\n            System.out.println(socket);\n            socket.getOutputStream().write(&quot;world&quot;.getBytes());\n            System.in.read();\n        &#125; catch (IOException e) &#123;\n            e.printStackTrace();\n        &#125;\n    &#125;\n&#125;</code></pre>\n\n\n\n<p>æœåŠ¡å™¨ç«¯ä»£ç ä¸º</p>\n<pre class=\"line-numbers language-java\" data-language=\"java\"><code class=\"language-java\">@Slf4j\npublic class ChannelDemo6 &#123;\n    public static void main(String[] args) &#123;\n        try (ServerSocketChannel channel &#x3D; ServerSocketChannel.open()) &#123;\n            channel.bind(new InetSocketAddress(8080));\n            System.out.println(channel);\n            Selector selector &#x3D; Selector.open();\n            channel.configureBlocking(false);\n            channel.register(selector, SelectionKey.OP_ACCEPT);\n\n            while (true) &#123;\n                int count &#x3D; selector.select();\n&#x2F;&#x2F;                int count &#x3D; selector.selectNow();\n                log.debug(&quot;select count: &#123;&#125;&quot;, count);\n&#x2F;&#x2F;                if(count &lt;&#x3D; 0) &#123;\n&#x2F;&#x2F;                    continue;\n&#x2F;&#x2F;                &#125;\n\n                &#x2F;&#x2F; è·å–æ‰€æœ‰äº‹ä»¶\n                Set&lt;SelectionKey&gt; keys &#x3D; selector.selectedKeys();\n\n                &#x2F;&#x2F; éå†æ‰€æœ‰äº‹ä»¶ï¼Œé€ä¸€å¤„ç†\n                Iterator&lt;SelectionKey&gt; iter &#x3D; keys.iterator();\n                while (iter.hasNext()) &#123;\n                    SelectionKey key &#x3D; iter.next();\n                    &#x2F;&#x2F; åˆ¤æ–­äº‹ä»¶ç±»å‹\n                    if (key.isAcceptable()) &#123;\n                        ServerSocketChannel c &#x3D; (ServerSocketChannel) key.channel();\n                        &#x2F;&#x2F; å¿…é¡»å¤„ç†\n                        SocketChannel sc &#x3D; c.accept();\n                        log.debug(&quot;&#123;&#125;&quot;, sc);\n                    &#125;\n                    &#x2F;&#x2F; å¤„ç†å®Œæ¯•ï¼Œå¿…é¡»å°†äº‹ä»¶ç§»é™¤\n                    iter.remove();\n                &#125;\n            &#125;\n        &#125; catch (IOException e) &#123;\n            e.printStackTrace();\n        &#125;\n    &#125;\n&#125;</code></pre>\n\n\n\n<h4 id=\"ğŸ’¡-äº‹ä»¶å‘ç”Ÿåèƒ½å¦ä¸å¤„ç†\"><a href=\"#ğŸ’¡-äº‹ä»¶å‘ç”Ÿåèƒ½å¦ä¸å¤„ç†\" class=\"headerlink\" title=\"ğŸ’¡ äº‹ä»¶å‘ç”Ÿåèƒ½å¦ä¸å¤„ç†\"></a>ğŸ’¡ äº‹ä»¶å‘ç”Ÿåèƒ½å¦ä¸å¤„ç†</h4><blockquote><span class=\"custom-blockquote-svg\"><svg width=\"24\" height=\"24\" viewBox=\"0 0 24 24\" fill=\"\" xmlns=\"http://www.w3.org/2000/svg\" data-reactroot=\"\">\n<path fill=\"\" d=\"M22 12C22 6.5 17.5 2 12 2C6.5 2 2 6.5 2 12C2 17.5 6.5 22 12 22C13.8 22 15.5 21.5 17 20.6L22 22L20.7 17C21.5 15.5 22 13.8 22 12Z\" undefined=\"1\"></path>\n<path fill=\"\" d=\"M15.97 11.5H16.04C17.12 11.5 18 12.38 18 13.47V13.53C18 14.62 17.12 15.5 16.03 15.5H15.96C14.88 15.5 14 14.62 14 13.53V13.46C14 12.38 14.88 11.5 15.97 11.5Z\" undefined=\"1\"></path>\n<path fill=\"\" d=\"M7.97 11.5H8.04C9.12 11.5 10 12.38 10 13.47V13.53C10 14.62 9.12 15.5 8.03 15.5H7.97C6.88 15.5 6 14.62 6 13.53V13.46C6 12.38 6.88 11.5 7.97 11.5Z\" undefined=\"1\"></path>\n<path stroke-linejoin=\"round\" stroke-linecap=\"round\" stroke-miterlimit=\"10\" stroke-width=\"2\" stroke=\"\" d=\"M17 8.5C15.23 8.97 14.07 10.84 14.01 13.27C14 13.33 14 13.4 14 13.47V13.5\"></path>\n<path stroke-linejoin=\"round\" stroke-linecap=\"round\" stroke-miterlimit=\"10\" stroke-width=\"2\" stroke=\"\" d=\"M9 8.5C7.23 8.97 6.07 10.84 6.01 13.27C6 13.33 6 13.4 6 13.47V13.5\"></path>\n<path stroke-linejoin=\"round\" stroke-linecap=\"round\" stroke-miterlimit=\"10\" stroke-width=\"2\" stroke=\"\" d=\"M15.97 11.5H16.04C17.12 11.5 18 12.38 18 13.47V13.53C18 14.62 17.12 15.5 16.03 15.5H15.96C14.88 15.5 14 14.62 14 13.53V13.46C14 12.38 14.88 11.5 15.97 11.5Z\"></path>\n<path stroke-linejoin=\"round\" stroke-linecap=\"round\" stroke-miterlimit=\"10\" stroke-width=\"2\" stroke=\"\" d=\"M7.97 11.5H8.04C9.12 11.5 10 12.38 10 13.47V13.53C10 14.62 9.12 15.5 8.03 15.5H7.97C6.88 15.5 6 14.62 6 13.53V13.46C6 12.38 6.88 11.5 7.97 11.5Z\"></path>\n</svg>\n</span><p>äº‹ä»¶å‘ç”Ÿåï¼Œè¦ä¹ˆå¤„ç†ï¼Œè¦ä¹ˆå–æ¶ˆï¼ˆcancelï¼‰ï¼Œä¸èƒ½ä»€ä¹ˆéƒ½ä¸åšï¼Œå¦åˆ™ä¸‹æ¬¡è¯¥äº‹ä»¶ä»ä¼šè§¦å‘ï¼Œè¿™æ˜¯å› ä¸º ã€nio åº•å±‚ä½¿ç”¨çš„æ˜¯æ°´å¹³è§¦å‘ï¼Ÿï¼Ÿï¼Ÿã€‘</p></blockquote>\n<h3 id=\"4-4-å¤„ç†-read-äº‹ä»¶\"><a href=\"#4-4-å¤„ç†-read-äº‹ä»¶\" class=\"headerlink\" title=\"4.4 å¤„ç† read äº‹ä»¶\"></a>4.4 å¤„ç† read äº‹ä»¶</h3><pre class=\"line-numbers language-java\" data-language=\"java\"><code class=\"language-java\">@Slf4j\npublic class ChannelDemo6 &#123;\n    public static void main(String[] args) &#123;\n        try (ServerSocketChannel channel &#x3D; ServerSocketChannel.open()) &#123;\n            channel.bind(new InetSocketAddress(8080));\n            System.out.println(channel);\n            Selector selector &#x3D; Selector.open();\n            channel.configureBlocking(false);\n            channel.register(selector, SelectionKey.OP_ACCEPT);\n\n            while (true) &#123;\n                int count &#x3D; selector.select();\n&#x2F;&#x2F;                int count &#x3D; selector.selectNow();\n                log.debug(&quot;select count: &#123;&#125;&quot;, count);\n&#x2F;&#x2F;                if(count &lt;&#x3D; 0) &#123;\n&#x2F;&#x2F;                    continue;\n&#x2F;&#x2F;                &#125;\n\n                &#x2F;&#x2F; è·å–æ‰€æœ‰äº‹ä»¶\n                Set&lt;SelectionKey&gt; keys &#x3D; selector.selectedKeys();\n\n                &#x2F;&#x2F; éå†æ‰€æœ‰äº‹ä»¶ï¼Œé€ä¸€å¤„ç†\n                Iterator&lt;SelectionKey&gt; iter &#x3D; keys.iterator();\n                while (iter.hasNext()) &#123;\n                    SelectionKey key &#x3D; iter.next();\n                    &#x2F;&#x2F; åˆ¤æ–­äº‹ä»¶ç±»å‹\n                    if (key.isAcceptable()) &#123;\n                        ServerSocketChannel c &#x3D; (ServerSocketChannel) key.channel();\n                        &#x2F;&#x2F; å¿…é¡»å¤„ç†\n                        SocketChannel sc &#x3D; c.accept();\n                        sc.configureBlocking(false);\n                        sc.register(selector, SelectionKey.OP_READ);\n                        log.debug(&quot;è¿æ¥å·²å»ºç«‹: &#123;&#125;&quot;, sc);\n                    &#125; else if (key.isReadable()) &#123;\n                        SocketChannel sc &#x3D; (SocketChannel) key.channel();\n                        ByteBuffer buffer &#x3D; ByteBuffer.allocate(128);\n                        int read &#x3D; sc.read(buffer);\n                        if(read &#x3D;&#x3D; -1) &#123;\n                            key.cancel();\n                            sc.close();\n                        &#125; else &#123;\n                            buffer.flip();\n                            debug(buffer);\n                        &#125;\n                    &#125;\n                    &#x2F;&#x2F; å¤„ç†å®Œæ¯•ï¼Œå¿…é¡»å°†äº‹ä»¶ç§»é™¤\n                    iter.remove();\n                &#125;\n            &#125;\n        &#125; catch (IOException e) &#123;\n            e.printStackTrace();\n        &#125;\n    &#125;\n&#125;</code></pre>\n\n<p>å¼€å¯ä¸¤ä¸ªå®¢æˆ·ç«¯ï¼Œä¿®æ”¹ä¸€ä¸‹å‘é€æ–‡å­—ï¼Œè¾“å‡º</p>\n<pre class=\"line-numbers language-none\"><code class=\"language-none\">sun.nio.ch.ServerSocketChannelImpl[&#x2F;0:0:0:0:0:0:0:0:8080]\n21:16:39 [DEBUG] [main] c.i.n.ChannelDemo6 - select count: 1\n21:16:39 [DEBUG] [main] c.i.n.ChannelDemo6 - è¿æ¥å·²å»ºç«‹: java.nio.channels.SocketChannel[connected local&#x3D;&#x2F;127.0.0.1:8080 remote&#x3D;&#x2F;127.0.0.1:60367]\n21:16:39 [DEBUG] [main] c.i.n.ChannelDemo6 - select count: 1\n         +-------------------------------------------------+\n         |  0  1  2  3  4  5  6  7  8  9  a  b  c  d  e  f |\n+--------+-------------------------------------------------+----------------+\n|00000000| 68 65 6c 6c 6f                                  |hello           |\n+--------+-------------------------------------------------+----------------+\n21:16:59 [DEBUG] [main] c.i.n.ChannelDemo6 - select count: 1\n21:16:59 [DEBUG] [main] c.i.n.ChannelDemo6 - è¿æ¥å·²å»ºç«‹: java.nio.channels.SocketChannel[connected local&#x3D;&#x2F;127.0.0.1:8080 remote&#x3D;&#x2F;127.0.0.1:60378]\n21:16:59 [DEBUG] [main] c.i.n.ChannelDemo6 - select count: 1\n         +-------------------------------------------------+\n         |  0  1  2  3  4  5  6  7  8  9  a  b  c  d  e  f |\n+--------+-------------------------------------------------+----------------+\n|00000000| 77 6f 72 6c 64                                  |world           |\n+--------+-------------------------------------------------+----------------+</code></pre>\n\n\n\n<h4 id=\"ğŸ’¡-ä¸ºä½•è¦-iter-remove\"><a href=\"#ğŸ’¡-ä¸ºä½•è¦-iter-remove\" class=\"headerlink\" title=\"ğŸ’¡ ä¸ºä½•è¦ iter.remove()\"></a>ğŸ’¡ ä¸ºä½•è¦ iter.remove()</h4><blockquote><span class=\"custom-blockquote-svg\"><svg width=\"24\" height=\"24\" viewBox=\"0 0 24 24\" fill=\"\" xmlns=\"http://www.w3.org/2000/svg\" data-reactroot=\"\">\n<path fill=\"\" d=\"M22 12C22 6.5 17.5 2 12 2C6.5 2 2 6.5 2 12C2 17.5 6.5 22 12 22C13.8 22 15.5 21.5 17 20.6L22 22L20.7 17C21.5 15.5 22 13.8 22 12Z\" undefined=\"1\"></path>\n<path fill=\"\" d=\"M15.97 11.5H16.04C17.12 11.5 18 12.38 18 13.47V13.53C18 14.62 17.12 15.5 16.03 15.5H15.96C14.88 15.5 14 14.62 14 13.53V13.46C14 12.38 14.88 11.5 15.97 11.5Z\" undefined=\"1\"></path>\n<path fill=\"\" d=\"M7.97 11.5H8.04C9.12 11.5 10 12.38 10 13.47V13.53C10 14.62 9.12 15.5 8.03 15.5H7.97C6.88 15.5 6 14.62 6 13.53V13.46C6 12.38 6.88 11.5 7.97 11.5Z\" undefined=\"1\"></path>\n<path stroke-linejoin=\"round\" stroke-linecap=\"round\" stroke-miterlimit=\"10\" stroke-width=\"2\" stroke=\"\" d=\"M17 8.5C15.23 8.97 14.07 10.84 14.01 13.27C14 13.33 14 13.4 14 13.47V13.5\"></path>\n<path stroke-linejoin=\"round\" stroke-linecap=\"round\" stroke-miterlimit=\"10\" stroke-width=\"2\" stroke=\"\" d=\"M9 8.5C7.23 8.97 6.07 10.84 6.01 13.27C6 13.33 6 13.4 6 13.47V13.5\"></path>\n<path stroke-linejoin=\"round\" stroke-linecap=\"round\" stroke-miterlimit=\"10\" stroke-width=\"2\" stroke=\"\" d=\"M15.97 11.5H16.04C17.12 11.5 18 12.38 18 13.47V13.53C18 14.62 17.12 15.5 16.03 15.5H15.96C14.88 15.5 14 14.62 14 13.53V13.46C14 12.38 14.88 11.5 15.97 11.5Z\"></path>\n<path stroke-linejoin=\"round\" stroke-linecap=\"round\" stroke-miterlimit=\"10\" stroke-width=\"2\" stroke=\"\" d=\"M7.97 11.5H8.04C9.12 11.5 10 12.38 10 13.47V13.53C10 14.62 9.12 15.5 8.03 15.5H7.97C6.88 15.5 6 14.62 6 13.53V13.46C6 12.38 6.88 11.5 7.97 11.5Z\"></path>\n</svg>\n</span><p>å› ä¸º select åœ¨äº‹ä»¶å‘ç”Ÿåï¼Œå°±[ä¼šå°†ç›¸å…³çš„ key æ”¾å…¥ selectedKeys é›†åˆï¼Œä½†ä¸ä¼šåœ¨å¤„ç†å®Œåä» selectedKeys é›†åˆä¸­ç§»é™¤ï¼Œéœ€è¦æˆ‘ä»¬è‡ªå·±ç¼–ç åˆ é™¤]ã€‚ä¾‹å¦‚</p>\n<ul>\n<li>ç¬¬ä¸€æ¬¡è§¦å‘äº† ssckey ä¸Šçš„ accept äº‹ä»¶ï¼Œæ²¡æœ‰ç§»é™¤ ssckey </li>\n<li>ç¬¬äºŒæ¬¡<strong>è§¦å‘äº† sckey ä¸Šçš„ read äº‹ä»¶ï¼Œä½†è¿™æ—¶ selectedKeys ä¸­è¿˜æœ‰ä¸Šæ¬¡çš„ ssckey ï¼Œåœ¨å¤„ç†æ—¶å› ä¸ºæ²¡æœ‰çœŸæ­£çš„ serverSocket è¿ä¸Šäº†ï¼Œå°±ä¼šå¯¼è‡´ç©ºæŒ‡é’ˆå¼‚å¸¸</strong></li>\n</ul></blockquote>\n<h4 id=\"ğŸ’¡-cancel-çš„ä½œç”¨\"><a href=\"#ğŸ’¡-cancel-çš„ä½œç”¨\" class=\"headerlink\" title=\"ğŸ’¡ cancel çš„ä½œç”¨\"></a>ğŸ’¡ cancel çš„ä½œç”¨</h4><blockquote><span class=\"custom-blockquote-svg\"><svg width=\"24\" height=\"24\" viewBox=\"0 0 24 24\" fill=\"\" xmlns=\"http://www.w3.org/2000/svg\" data-reactroot=\"\">\n<path fill=\"\" d=\"M22 12C22 6.5 17.5 2 12 2C6.5 2 2 6.5 2 12C2 17.5 6.5 22 12 22C13.8 22 15.5 21.5 17 20.6L22 22L20.7 17C21.5 15.5 22 13.8 22 12Z\" undefined=\"1\"></path>\n<path fill=\"\" d=\"M15.97 11.5H16.04C17.12 11.5 18 12.38 18 13.47V13.53C18 14.62 17.12 15.5 16.03 15.5H15.96C14.88 15.5 14 14.62 14 13.53V13.46C14 12.38 14.88 11.5 15.97 11.5Z\" undefined=\"1\"></path>\n<path fill=\"\" d=\"M7.97 11.5H8.04C9.12 11.5 10 12.38 10 13.47V13.53C10 14.62 9.12 15.5 8.03 15.5H7.97C6.88 15.5 6 14.62 6 13.53V13.46C6 12.38 6.88 11.5 7.97 11.5Z\" undefined=\"1\"></path>\n<path stroke-linejoin=\"round\" stroke-linecap=\"round\" stroke-miterlimit=\"10\" stroke-width=\"2\" stroke=\"\" d=\"M17 8.5C15.23 8.97 14.07 10.84 14.01 13.27C14 13.33 14 13.4 14 13.47V13.5\"></path>\n<path stroke-linejoin=\"round\" stroke-linecap=\"round\" stroke-miterlimit=\"10\" stroke-width=\"2\" stroke=\"\" d=\"M9 8.5C7.23 8.97 6.07 10.84 6.01 13.27C6 13.33 6 13.4 6 13.47V13.5\"></path>\n<path stroke-linejoin=\"round\" stroke-linecap=\"round\" stroke-miterlimit=\"10\" stroke-width=\"2\" stroke=\"\" d=\"M15.97 11.5H16.04C17.12 11.5 18 12.38 18 13.47V13.53C18 14.62 17.12 15.5 16.03 15.5H15.96C14.88 15.5 14 14.62 14 13.53V13.46C14 12.38 14.88 11.5 15.97 11.5Z\"></path>\n<path stroke-linejoin=\"round\" stroke-linecap=\"round\" stroke-miterlimit=\"10\" stroke-width=\"2\" stroke=\"\" d=\"M7.97 11.5H8.04C9.12 11.5 10 12.38 10 13.47V13.53C10 14.62 9.12 15.5 8.03 15.5H7.97C6.88 15.5 6 14.62 6 13.53V13.46C6 12.38 6.88 11.5 7.97 11.5Z\"></path>\n</svg>\n</span><p>cancel ä¼š<strong>å–æ¶ˆæ³¨å†Œåœ¨ selector ä¸Šçš„ channelï¼Œå¹¶ä» keys é›†åˆä¸­åˆ é™¤ key åç»­ä¸ä¼šå†ç›‘å¬äº‹ä»¶</strong></p></blockquote>\n<h4 id=\"âš ï¸-ä¸å¤„ç†è¾¹ç•Œçš„é—®é¢˜\"><a href=\"#âš ï¸-ä¸å¤„ç†è¾¹ç•Œçš„é—®é¢˜\" class=\"headerlink\" title=\"âš ï¸  ä¸å¤„ç†è¾¹ç•Œçš„é—®é¢˜\"></a>âš ï¸  ä¸å¤„ç†è¾¹ç•Œçš„é—®é¢˜</h4><p>ä»¥å‰æœ‰åŒå­¦å†™è¿‡è¿™æ ·çš„ä»£ç ï¼Œæ€è€ƒæ³¨é‡Šä¸­ä¸¤ä¸ªé—®é¢˜ï¼Œä»¥ bio ä¸ºä¾‹ï¼Œå…¶å® nio é“ç†æ˜¯ä¸€æ ·çš„</p>\n<pre class=\"line-numbers language-java\" data-language=\"java\"><code class=\"language-java\">public class Server &#123;\n    public static void main(String[] args) throws IOException &#123;\n        ServerSocket ss&#x3D;new ServerSocket(9000);\n        while (true) &#123;\n            Socket s &#x3D; ss.accept();\n            InputStream in &#x3D; s.getInputStream();\n            &#x2F;&#x2F; è¿™é‡Œè¿™ä¹ˆå†™ï¼Œæœ‰æ²¡æœ‰é—®é¢˜\n            byte[] arr &#x3D; new byte[4];\n            while(true) &#123;\n                int read &#x3D; in.read(arr);\n                &#x2F;&#x2F; è¿™é‡Œè¿™ä¹ˆå†™ï¼Œæœ‰æ²¡æœ‰é—®é¢˜\n                if(read &#x3D;&#x3D; -1) &#123;\n                    break;\n                &#125;\n                System.out.println(new String(arr, 0, read));\n            &#125;\n        &#125;\n    &#125;\n&#125;</code></pre>\n\n<p>å®¢æˆ·ç«¯</p>\n<pre class=\"line-numbers language-java\" data-language=\"java\"><code class=\"language-java\">public class Client &#123;\n    public static void main(String[] args) throws IOException &#123;\n        Socket max &#x3D; new Socket(&quot;localhost&quot;, 9000);\n        OutputStream out &#x3D; max.getOutputStream();\n        out.write(&quot;hello&quot;.getBytes());\n        out.write(&quot;world&quot;.getBytes());\n        out.write(&quot;ä½ å¥½&quot;.getBytes());\n        max.close();\n    &#125;\n&#125;</code></pre>\n\n<p>è¾“å‡º</p>\n<pre class=\"line-numbers language-none\"><code class=\"language-none\">hell\nowor\nldï¿½\nï¿½å¥½\n</code></pre>\n\n<p>ä¸ºä»€ä¹ˆï¼Ÿ</p>\n<h4 id=\"å¤„ç†æ¶ˆæ¯çš„è¾¹ç•Œï¼ï¼ï¼\"><a href=\"#å¤„ç†æ¶ˆæ¯çš„è¾¹ç•Œï¼ï¼ï¼\" class=\"headerlink\" title=\"å¤„ç†æ¶ˆæ¯çš„è¾¹ç•Œï¼ï¼ï¼\"></a>å¤„ç†æ¶ˆæ¯çš„è¾¹ç•Œï¼ï¼ï¼</h4><p><img src=\"http://cache.itzy8.top/%E5%AD%A6Netty-%E9%BB%91%E9%A9%AC%E6%BB%A1%E5%93%A5/0023.png\"></p>\n<ul>\n<li>ä¸€ç§æ€è·¯æ˜¯<strong>å›ºå®šæ¶ˆæ¯é•¿åº¦ï¼Œæ•°æ®åŒ…å¤§å°ä¸€æ ·ï¼ŒæœåŠ¡å™¨æŒ‰é¢„å®šé•¿åº¦è¯»å–ï¼Œç¼ºç‚¹æ˜¯æµªè´¹å¸¦å®½</strong></li>\n<li>å¦ä¸€ç§æ€è·¯æ˜¯<strong>æŒ‰åˆ†éš”ç¬¦æ‹†åˆ†ï¼Œç¼ºç‚¹æ˜¯æ•ˆç‡ä½</strong></li>\n<li>TLV æ ¼å¼ï¼Œå³ Type ç±»å‹ã€Length é•¿åº¦ã€Value æ•°æ®ï¼Œç±»å‹å’Œé•¿åº¦å·²çŸ¥çš„æƒ…å†µä¸‹ï¼Œå°±å¯ä»¥æ–¹ä¾¿è·å–æ¶ˆæ¯å¤§å°ï¼Œåˆ†é…åˆé€‚çš„ bufferï¼Œ<strong>ç¼ºç‚¹æ˜¯ buffer éœ€è¦æå‰åˆ†é…ï¼Œå¦‚æœå†…å®¹è¿‡å¤§ï¼Œåˆ™å½±å“ server ååé‡</strong><ul>\n<li>Http 1.1 æ˜¯ TLV æ ¼å¼ content-type\tcontent-length</li>\n<li>Http 2.0 æ˜¯ LTV æ ¼å¼</li>\n</ul>\n</li>\n</ul>\n<p><img src=\"http://cache.itzy8.top/%E5%AD%A6Netty-%E9%BB%91%E9%A9%AC%E6%BB%A1%E5%93%A5/image-20220422160404090.png\" alt=\"image-20220422160404090\"></p>\n<p>ifä¸æ‰©å®¹ï¼Œä¼šåˆ†æˆä¸¤æ¬¡ï¼Œå±€éƒ¨å˜é‡bufferè¢«è¦†ç›–ï¼š</p>\n<p><img src=\"http://cache.itzy8.top/%E5%AD%A6Netty-%E9%BB%91%E9%A9%AC%E6%BB%A1%E5%93%A5/image-20220422162229473.png\" alt=\"image-20220422162229473\"></p>\n<p>bufferæ‰©å®¹ï¼š</p>\n<pre class=\"line-numbers language-mermaid\" data-language=\"mermaid\"><code class=\"language-mermaid\">sequenceDiagram \nparticipant c1 as å®¢æˆ·ç«¯1\nparticipant s as æœåŠ¡å™¨\nparticipant b1 as ByteBuffer1\nparticipant b2 as ByteBuffer2\nc1 -&gt;&gt; s: å‘é€ 01234567890abcdef3333\\r\ns -&gt;&gt; b1: ç¬¬ä¸€æ¬¡ read å­˜å…¥ 01234567890abcdef\ns -&gt;&gt; b2: æ‰©å®¹\nb1 -&gt;&gt; b2: æ‹·è´ 01234567890abcdef\ns -&gt;&gt; b2: ç¬¬äºŒæ¬¡ read å­˜å…¥ 3333\\r\nb2 -&gt;&gt; b2: 01234567890abcdef3333\\r</code></pre>\n\n<p>æœåŠ¡å™¨ç«¯Server\tTestByteBufferExam.split\tåˆ†éš”ç¬¦åŒ¹é…æ‹†åˆ†æ³•</p>\n<pre class=\"line-numbers language-java\" data-language=\"java\"><code class=\"language-java\">private static void split(ByteBuffer source) &#123;\n    source.flip();\n    for (int i &#x3D; 0; i &lt; source.limit(); i++) &#123;\n        &#x2F;&#x2F; æ‰¾åˆ°ä¸€æ¡å®Œæ•´æ¶ˆæ¯\n        if (source.get(i) &#x3D;&#x3D; &#39;\\n&#39;) &#123;\n            int length &#x3D; i + 1 - source.position();\n            &#x2F;&#x2F; æŠŠè¿™æ¡å®Œæ•´æ¶ˆæ¯å­˜å…¥æ–°çš„ ByteBuffer\n            ByteBuffer target &#x3D; ByteBuffer.allocate(length);\n            &#x2F;&#x2F; ä» source è¯»ï¼Œå‘ target å†™\n            for (int j &#x3D; 0; j &lt; length; j++) &#123;\n                target.put(source.get());\n            &#125;\n            debugAll(target);\n        &#125;\n    &#125;\n    source.compact(); &#x2F;&#x2F; 0123456789abcdef  position 16 limit 16\n&#125;\n\npublic static void main(String[] args) throws IOException &#123;\n    &#x2F;&#x2F; 1. åˆ›å»º selector, ç®¡ç†å¤šä¸ª channel\n    Selector selector &#x3D; Selector.open();\n    ServerSocketChannel ssc &#x3D; ServerSocketChannel.open();\n    ssc.configureBlocking(false);\n    &#x2F;&#x2F; 2. å»ºç«‹ selector å’Œ channel çš„è”ç³»ï¼ˆæ³¨å†Œï¼‰\n    &#x2F;&#x2F; SelectionKey å°±æ˜¯å°†æ¥äº‹ä»¶å‘ç”Ÿåï¼Œé€šè¿‡å®ƒå¯ä»¥çŸ¥é“äº‹ä»¶å’Œå“ªä¸ªchannelçš„äº‹ä»¶\n    SelectionKey sscKey &#x3D; ssc.register(selector, 0, null);\n    &#x2F;&#x2F; key åªå…³æ³¨ accept äº‹ä»¶\n    sscKey.interestOps(SelectionKey.OP_ACCEPT);\n    log.debug(&quot;sscKey:&#123;&#125;&quot;, sscKey);\n    ssc.bind(new InetSocketAddress(8080));\n    while (true) &#123;\n        &#x2F;&#x2F; 3. select æ–¹æ³•, æ²¡æœ‰äº‹ä»¶å‘ç”Ÿï¼Œçº¿ç¨‹é˜»å¡ï¼Œæœ‰äº‹ä»¶ï¼Œçº¿ç¨‹æ‰ä¼šæ¢å¤è¿è¡Œ\n        &#x2F;&#x2F; select åœ¨äº‹ä»¶æœªå¤„ç†æ—¶ï¼Œå®ƒä¸ä¼šé˜»å¡, äº‹ä»¶å‘ç”Ÿåè¦ä¹ˆå¤„ç†ï¼Œè¦ä¹ˆå–æ¶ˆï¼Œä¸èƒ½ç½®ä¹‹ä¸ç†\n        selector.select();\n        &#x2F;&#x2F; 4. å¤„ç†äº‹ä»¶, selectedKeys å†…éƒ¨åŒ…å«äº†æ‰€æœ‰å‘ç”Ÿçš„äº‹ä»¶\n        Iterator&lt;SelectionKey&gt; iter &#x3D; selector.selectedKeys().iterator(); &#x2F;&#x2F; accept, read\n        while (iter.hasNext()) &#123;\n            SelectionKey key &#x3D; iter.next();\n            &#x2F;&#x2F; å¤„ç†key æ—¶ï¼Œè¦ä» selectedKeys é›†åˆä¸­åˆ é™¤ï¼Œå¦åˆ™ä¸‹æ¬¡å¤„ç†å°±ä¼šæœ‰é—®é¢˜\n            iter.remove();\n            log.debug(&quot;key: &#123;&#125;&quot;, key);\n            &#x2F;&#x2F; 5. åŒºåˆ†äº‹ä»¶ç±»å‹\n            if (key.isAcceptable()) &#123; &#x2F;&#x2F; å¦‚æœæ˜¯ accept\n                ServerSocketChannel channel &#x3D; (ServerSocketChannel) key.channel();\n                SocketChannel sc &#x3D; channel.accept();\n                sc.configureBlocking(false);\n                ByteBuffer buffer &#x3D; ByteBuffer.allocate(16); &#x2F;&#x2F; attachment\n                &#x2F;&#x2F; å°†ä¸€ä¸ª byteBuffer ä½œä¸ºé™„ä»¶å…³è”åˆ° selectionKey ä¸Š\n                SelectionKey scKey &#x3D; sc.register(selector, 0, buffer);\n                scKey.interestOps(SelectionKey.OP_READ);\n                log.debug(&quot;&#123;&#125;&quot;, sc);\n                log.debug(&quot;scKey:&#123;&#125;&quot;, scKey);\n            &#125; else if (key.isReadable()) &#123; &#x2F;&#x2F; å¦‚æœæ˜¯ read\n                try &#123;\n                    SocketChannel channel &#x3D; (SocketChannel) key.channel(); &#x2F;&#x2F; æ‹¿åˆ°è§¦å‘äº‹ä»¶çš„channel\n                    &#x2F;&#x2F; è·å– selectionKey ä¸Šå…³è”çš„é™„ä»¶\n                    ByteBuffer buffer &#x3D; (ByteBuffer) key.attachment();\n                    int read &#x3D; channel.read(buffer); &#x2F;&#x2F; å¦‚æœæ˜¯æ­£å¸¸æ–­å¼€ï¼Œread çš„æ–¹æ³•çš„è¿”å›å€¼æ˜¯ -1\n                    if(read &#x3D;&#x3D; -1) &#123;\n                        key.cancel();\n                    &#125; else &#123;\n                        split(buffer);&#x2F;&#x2F;\n                        &#x2F;&#x2F; éœ€è¦æ‰©å®¹\n                        if (buffer.position() &#x3D;&#x3D; buffer.limit()) &#123;\n                            ByteBuffer newBuffer &#x3D; ByteBuffer.allocate(buffer.capacity() * 2);\n                            buffer.flip();\n                            newBuffer.put(buffer); &#x2F;&#x2F; 0123456789abcdef3333\\n\n                            key.attach(newBuffer);\n                        &#125;\n                    &#125;\n\n                &#125; catch (IOException e) &#123;\n                    e.printStackTrace();\n                    key.cancel();  &#x2F;&#x2F; å› ä¸ºå®¢æˆ·ç«¯æ–­å¼€äº†,å› æ­¤éœ€è¦å°† key å–æ¶ˆï¼ˆä» selector çš„ keys é›†åˆä¸­çœŸæ­£åˆ é™¤ keyï¼‰\n                &#125;\n            &#125;\n        &#125;\n    &#125;\n&#125;</code></pre>\n\n<p>å®¢æˆ·ç«¯</p>\n<pre class=\"line-numbers language-java\" data-language=\"java\"><code class=\"language-java\">SocketChannel sc &#x3D; SocketChannel.open();\nsc.connect(new InetSocketAddress(&quot;localhost&quot;, 8080));\nSocketAddress address &#x3D; sc.getLocalAddress();\n&#x2F;&#x2F; sc.write(Charset.defaultCharset().encode(&quot;hello\\nworld\\n&quot;));\nsc.write(Charset.defaultCharset().encode(&quot;0123\\n456789abcdef\\n&quot;));\nsc.write(Charset.defaultCharset().encode(&quot;0123456789abcdef3333\\n&quot;));\nSystem.in.read();</code></pre>\n\n\n\n<p>nettyåˆ™å¯è‡ªé€‚åº”æ‰©ç¼©å®¹bufferå¤§å°ï¼Œæ›´åŠ ç²¾ç»†~</p>\n<h4 id=\"ByteBuffer-å¤§å°åˆ†é…\"><a href=\"#ByteBuffer-å¤§å°åˆ†é…\" class=\"headerlink\" title=\"ByteBuffer å¤§å°åˆ†é…\"></a>ByteBuffer å¤§å°åˆ†é…</h4><ul>\n<li>æ¯ä¸ª channel éƒ½éœ€è¦è®°å½•å¯èƒ½è¢«åˆ‡åˆ†çš„æ¶ˆæ¯ï¼Œ<strong>å› ä¸º ByteBuffer ä¸èƒ½è¢«å¤šä¸ª channel å…±åŒä½¿ç”¨ï¼Œå› æ­¤éœ€è¦ä¸ºæ¯ä¸ª channel ç»´æŠ¤ä¸€ä¸ªç‹¬ç«‹çš„ ByteBufferã€å…³è”é™„ä»¶ attchment() attach(newBuffer)ã€‘</strong></li>\n<li>ByteBuffer ä¸èƒ½å¤ªå¤§ï¼Œæ¯”å¦‚<strong>ä¸€ä¸ª ByteBuffer 1Mb çš„è¯ï¼Œè¦æ”¯æŒç™¾ä¸‡è¿æ¥å°±è¦ 1Tb å†…å­˜ï¼Œå› æ­¤éœ€è¦è®¾è®¡å¤§å°å¯å˜çš„ ByteBuffer</strong><ul>\n<li>ä¸€ç§æ€è·¯æ˜¯é¦–å…ˆåˆ†é…ä¸€ä¸ªè¾ƒå°çš„ bufferï¼Œä¾‹å¦‚ 4kï¼Œå¦‚æœå‘ç°æ•°æ®ä¸å¤Ÿï¼Œå†åˆ†é… 8k çš„ bufferï¼Œå°† 4k buffer <strong>å†…å®¹æ‹·è´</strong>è‡³ 8k bufferï¼Œ<strong>ä¼˜ç‚¹æ˜¯æ¶ˆæ¯è¿ç»­å®¹æ˜“å¤„ç†ï¼Œç¼ºç‚¹æ˜¯æ•°æ®æ‹·è´è€—è´¹æ€§èƒ½</strong>ã€ä¸Šä¾‹ã€‘ï¼Œå‚è€ƒå®ç° <a href=\"http://tutorials.jenkov.com/java-performance/resizable-array.html\">http://tutorials.jenkov.com/java-performance/resizable-array.html</a></li>\n<li>å¦ä¸€ç§æ€è·¯æ˜¯<strong>ç”¨å¤šä¸ªæ•°ç»„ç»„æˆ bufferï¼Œä¸€ä¸ªæ•°ç»„ä¸å¤Ÿï¼ŒæŠŠå¤šå‡ºæ¥çš„å†…å®¹å†™å…¥æ–°çš„æ•°ç»„ï¼Œä¸å‰é¢çš„åŒºåˆ«æ˜¯æ¶ˆæ¯å­˜å‚¨ä¸è¿ç»­è§£æå¤æ‚ï¼Œä¼˜ç‚¹æ˜¯é¿å…äº†æ‹·è´å¼•èµ·çš„æ€§èƒ½æŸè€—</strong>ã€egï¼šNettyä¸­çš„CompositeByteBufferï¼ã€‘</li>\n</ul>\n</li>\n</ul>\n<h3 id=\"4-5-å¤„ç†-write-äº‹ä»¶WriteServer-x2F-Client\"><a href=\"#4-5-å¤„ç†-write-äº‹ä»¶WriteServer-x2F-Client\" class=\"headerlink\" title=\"4.5 å¤„ç† write äº‹ä»¶\tWriteServer&#x2F;Client\"></a>4.5 å¤„ç† write äº‹ä»¶\tWriteServer&#x2F;Client</h3><p>whileå¤„ç†è¯¥scï¼Œå…¶ä»–scæ¥äº†å¤„ç†ä¸äº†ï¼ï¼ï¼æ•ˆç‡ä¸é«˜ï¼</p>\n<p><img src=\"http://cache.itzy8.top/%E5%AD%A6Netty-%E9%BB%91%E9%A9%AC%E6%BB%A1%E5%93%A5/image-20220422170133644.png\" alt=\"image-20220422170133644\"></p>\n<p>ä¸€å †0ï¼šå†™ç¼“å†²åŒºæ»¡äº†ã€è½¬å»ï¼šè¯»ã€‘ï¼Œæ²¡è¢«æ¶ˆè´¹ï¼Œå› ä¸ºå†™ä¸äº†ï¼</p>\n<h4 id=\"ä¸€æ¬¡æ— æ³•å†™å®Œä¾‹å­\"><a href=\"#ä¸€æ¬¡æ— æ³•å†™å®Œä¾‹å­\" class=\"headerlink\" title=\"ä¸€æ¬¡æ— æ³•å†™å®Œä¾‹å­\"></a>ä¸€æ¬¡æ— æ³•å†™å®Œä¾‹å­</h4><ul>\n<li>éé˜»å¡æ¨¡å¼ä¸‹ï¼Œæ— æ³•ä¿è¯æŠŠ buffer ä¸­æ‰€æœ‰æ•°æ®éƒ½å†™å…¥ channelï¼Œå› æ­¤éœ€è¦è¿½è¸ª write æ–¹æ³•çš„è¿”å›å€¼ï¼ˆä»£è¡¨å®é™…å†™å…¥å­—èŠ‚æ•°ï¼‰</li>\n<li><strong>ç”¨ selector ç›‘å¬æ‰€æœ‰ channel çš„å¯å†™äº‹ä»¶ï¼Œæ¯ä¸ª channel éƒ½éœ€è¦ä¸€ä¸ª key æ¥è·Ÿè¸ª bufferï¼Œä½†è¿™æ ·åˆä¼šå¯¼è‡´å ç”¨å†…å­˜è¿‡å¤š</strong>ï¼Œå°±æœ‰<strong>ä¸¤é˜¶æ®µç­–ç•¥</strong><ul>\n<li>å½“æ¶ˆæ¯å¤„ç†å™¨<strong>ç¬¬ä¸€æ¬¡å†™å…¥æ¶ˆæ¯æ—¶ï¼Œæ‰å°† channel æ³¨å†Œ</strong>åˆ° selector ä¸Š</li>\n<li>selector <strong>æ£€æŸ¥ channel ä¸Šçš„å¯å†™äº‹ä»¶ï¼Œå¦‚æœæ‰€æœ‰çš„æ•°æ®å†™å®Œäº†ï¼Œå°±å–æ¶ˆ</strong> channel çš„<strong>æ³¨å†Œ</strong></li>\n<li>å¦‚æœ<strong>ä¸å–æ¶ˆï¼Œä¼šæ¯æ¬¡å¯å†™å‡ä¼šè§¦å‘ write äº‹ä»¶</strong></li>\n</ul>\n</li>\n</ul>\n<pre class=\"line-numbers language-java\" data-language=\"java\"><code class=\"language-java\">public class WriteServer &#123;\n\n    public static void main(String[] args) throws IOException &#123;\n        ServerSocketChannel ssc &#x3D; ServerSocketChannel.open();\n        ssc.configureBlocking(false);\n        ssc.bind(new InetSocketAddress(8080));\n\n        Selector selector &#x3D; Selector.open();\n        ssc.register(selector, SelectionKey.OP_ACCEPT);\n\n        while(true) &#123;\n            selector.select();\n\n            Iterator&lt;SelectionKey&gt; iter &#x3D; selector.selectedKeys().iterator();\n            while (iter.hasNext()) &#123;\n                SelectionKey key &#x3D; iter.next();\n                iter.remove();\n                if (key.isAcceptable()) &#123;\n                    SocketChannel sc &#x3D; ssc.accept();\n                    sc.configureBlocking(false);\n                    SelectionKey sckey &#x3D; sc.register(selector, SelectionKey.OP_READ);\n                    &#x2F;&#x2F; 1. å‘å®¢æˆ·ç«¯å‘é€å†…å®¹\n                    StringBuilder sb &#x3D; new StringBuilder();\n                    for (int i &#x3D; 0; i &lt; 3000000; i++) &#123;\n                        sb.append(&quot;a&quot;);\n                    &#125;\n                    ByteBuffer buffer &#x3D; Charset.defaultCharset().encode(sb.toString());\n                    int write &#x3D; sc.write(buffer);\n                    &#x2F;&#x2F; 3. write è¡¨ç¤ºå®é™…å†™äº†å¤šå°‘å­—èŠ‚\n                    System.out.println(&quot;å®é™…å†™å…¥å­—èŠ‚:&quot; + write);\n                    &#x2F;&#x2F; 4. å¦‚æœæœ‰å‰©ä½™æœªè¯»å­—èŠ‚ï¼Œæ‰éœ€è¦å…³æ³¨å†™äº‹ä»¶\n                    if (buffer.hasRemaining()) &#123;\n                        &#x2F;&#x2F; read 1  write 4\n                        &#x2F;&#x2F; åœ¨åŸæœ‰å…³æ³¨äº‹ä»¶çš„åŸºç¡€ä¸Šï¼Œå¤šå…³æ³¨ å†™äº‹ä»¶\n                        sckey.interestOps(sckey.interestOps() + SelectionKey.OP_WRITE);\n                        &#x2F;&#x2F; æŠŠ buffer ä½œä¸ºé™„ä»¶åŠ å…¥ sckey\n                        sckey.attach(buffer);\n                    &#125;\n                &#125; else if (key.isWritable()) &#123;\n                    ByteBuffer buffer &#x3D; (ByteBuffer) key.attachment();\n                    SocketChannel sc &#x3D; (SocketChannel) key.channel();\n                    int write &#x3D; sc.write(buffer);\n                    System.out.println(&quot;å®é™…å†™å…¥å­—èŠ‚:&quot; + write);\n                    if (!buffer.hasRemaining()) &#123; &#x2F;&#x2F; å†™å®Œäº†\n                        key.interestOps(key.interestOps() - SelectionKey.OP_WRITE);\n                        key.attach(null);\n                    &#125;\n                &#125;\n            &#125;\n        &#125;\n    &#125;\n&#125;</code></pre>\n\n<p>å®¢æˆ·ç«¯</p>\n<pre class=\"line-numbers language-java\" data-language=\"java\"><code class=\"language-java\">public class WriteClient &#123;\n    public static void main(String[] args) throws IOException &#123;\n        Selector selector &#x3D; Selector.open();\n        SocketChannel sc &#x3D; SocketChannel.open();\n        sc.configureBlocking(false);\n        sc.register(selector, SelectionKey.OP_CONNECT | SelectionKey.OP_READ);\n        sc.connect(new InetSocketAddress(&quot;localhost&quot;, 8080));\n        int count &#x3D; 0;\n        while (true) &#123;\n            selector.select();\n            Iterator&lt;SelectionKey&gt; iter &#x3D; selector.selectedKeys().iterator();\n            while (iter.hasNext()) &#123;\n                SelectionKey key &#x3D; iter.next();\n                iter.remove();\n                if (key.isConnectable()) &#123;\n                    System.out.println(sc.finishConnect());\n                &#125; else if (key.isReadable()) &#123;\n                    ByteBuffer buffer &#x3D; ByteBuffer.allocate(1024 * 1024);\n                    count +&#x3D; sc.read(buffer);\n                    buffer.clear();\n                    System.out.println(count);\n                &#125;\n            &#125;\n        &#125;\n    &#125;\n&#125;</code></pre>\n\n\n\n<h4 id=\"ğŸ’¡-write-ä¸ºä½•è¦å–æ¶ˆ\"><a href=\"#ğŸ’¡-write-ä¸ºä½•è¦å–æ¶ˆ\" class=\"headerlink\" title=\"ğŸ’¡ write ä¸ºä½•è¦å–æ¶ˆ\"></a>ğŸ’¡ write ä¸ºä½•è¦å–æ¶ˆ</h4><p>åªè¦å‘ channel å‘é€æ•°æ®æ—¶ï¼Œ[socket ç¼“å†²å¯å†™ï¼Œè¿™ä¸ªäº‹ä»¶ä¼šé¢‘ç¹è§¦å‘]ï¼Œå› æ­¤<strong>åº”å½“[åªåœ¨ socket ç¼“å†²åŒºå†™ä¸ä¸‹æ—¶å†å…³æ³¨å¯å†™äº‹ä»¶ï¼Œæ•°æ®å†™å®Œä¹‹åå†å–æ¶ˆå…³æ³¨]</strong></p>\n<h3 id=\"4-6-æ›´è¿›ä¸€æ­¥\"><a href=\"#4-6-æ›´è¿›ä¸€æ­¥\" class=\"headerlink\" title=\"4.6 æ›´è¿›ä¸€æ­¥\"></a>4.6 æ›´è¿›ä¸€æ­¥</h3><h4 id=\"ğŸ’¡-åˆ©ç”¨å¤šçº¿ç¨‹ä¼˜åŒ–\"><a href=\"#ğŸ’¡-åˆ©ç”¨å¤šçº¿ç¨‹ä¼˜åŒ–\" class=\"headerlink\" title=\"ğŸ’¡ åˆ©ç”¨å¤šçº¿ç¨‹ä¼˜åŒ–\"></a>ğŸ’¡ åˆ©ç”¨å¤šçº¿ç¨‹ä¼˜åŒ–</h4><blockquote><span class=\"custom-blockquote-svg\"><svg width=\"24\" height=\"24\" viewBox=\"0 0 24 24\" fill=\"\" xmlns=\"http://www.w3.org/2000/svg\" data-reactroot=\"\">\n<path fill=\"\" d=\"M22 12C22 6.5 17.5 2 12 2C6.5 2 2 6.5 2 12C2 17.5 6.5 22 12 22C13.8 22 15.5 21.5 17 20.6L22 22L20.7 17C21.5 15.5 22 13.8 22 12Z\" undefined=\"1\"></path>\n<path fill=\"\" d=\"M15.97 11.5H16.04C17.12 11.5 18 12.38 18 13.47V13.53C18 14.62 17.12 15.5 16.03 15.5H15.96C14.88 15.5 14 14.62 14 13.53V13.46C14 12.38 14.88 11.5 15.97 11.5Z\" undefined=\"1\"></path>\n<path fill=\"\" d=\"M7.97 11.5H8.04C9.12 11.5 10 12.38 10 13.47V13.53C10 14.62 9.12 15.5 8.03 15.5H7.97C6.88 15.5 6 14.62 6 13.53V13.46C6 12.38 6.88 11.5 7.97 11.5Z\" undefined=\"1\"></path>\n<path stroke-linejoin=\"round\" stroke-linecap=\"round\" stroke-miterlimit=\"10\" stroke-width=\"2\" stroke=\"\" d=\"M17 8.5C15.23 8.97 14.07 10.84 14.01 13.27C14 13.33 14 13.4 14 13.47V13.5\"></path>\n<path stroke-linejoin=\"round\" stroke-linecap=\"round\" stroke-miterlimit=\"10\" stroke-width=\"2\" stroke=\"\" d=\"M9 8.5C7.23 8.97 6.07 10.84 6.01 13.27C6 13.33 6 13.4 6 13.47V13.5\"></path>\n<path stroke-linejoin=\"round\" stroke-linecap=\"round\" stroke-miterlimit=\"10\" stroke-width=\"2\" stroke=\"\" d=\"M15.97 11.5H16.04C17.12 11.5 18 12.38 18 13.47V13.53C18 14.62 17.12 15.5 16.03 15.5H15.96C14.88 15.5 14 14.62 14 13.53V13.46C14 12.38 14.88 11.5 15.97 11.5Z\"></path>\n<path stroke-linejoin=\"round\" stroke-linecap=\"round\" stroke-miterlimit=\"10\" stroke-width=\"2\" stroke=\"\" d=\"M7.97 11.5H8.04C9.12 11.5 10 12.38 10 13.47V13.53C10 14.62 9.12 15.5 8.03 15.5H7.97C6.88 15.5 6 14.62 6 13.53V13.46C6 12.38 6.88 11.5 7.97 11.5Z\"></path>\n</svg>\n</span><p>ç°åœ¨éƒ½æ˜¯å¤šæ ¸ cpuï¼Œè®¾è®¡æ—¶è¦å……åˆ†è€ƒè™‘åˆ«è®© cpu çš„åŠ›é‡è¢«ç™½ç™½æµªè´¹</p></blockquote>\n<p>å‰é¢çš„ä»£ç åªæœ‰ä¸€ä¸ªé€‰æ‹©å™¨ï¼Œæ²¡æœ‰å……åˆ†åˆ©ç”¨å¤šæ ¸ cpuï¼Œå¦‚ä½•æ”¹è¿›å‘¢ï¼Ÿ</p>\n<p>åˆ†ä¸¤ç»„é€‰æ‹©å™¨</p>\n<ul>\n<li><strong>å•çº¿ç¨‹é…ä¸€ä¸ªé€‰æ‹©å™¨ï¼Œä¸“é—¨å¤„ç† accept</strong> äº‹ä»¶</li>\n<li>åˆ›å»º <strong>cpu æ ¸å¿ƒæ•°çš„çº¿ç¨‹ï¼Œæ¯ä¸ªçº¿ç¨‹é…ä¸€ä¸ªé€‰æ‹©å™¨ï¼Œè½®æµå¤„ç† read</strong> äº‹ä»¶</li>\n</ul>\n<p><img src=\"http://cache.itzy8.top/%E5%AD%A6Netty-%E9%BB%91%E9%A9%AC%E6%BB%A1%E5%93%A5/image-20220423172400956.png\" alt=\"image-20220423172400956\"></p>\n<p>duplicate line: ctrl+D</p>\n<p>move line down: alt+shift+ä¸‹</p>\n<p><img src=\"http://cache.itzy8.top/%E5%AD%A6Netty-%E9%BB%91%E9%A9%AC%E6%BB%A1%E5%93%A5/image-20220424095453950.png\" alt=\"image-20220424095453950\"></p>\n<p>æ–°Cåˆè¢«é˜»ï¼Œä¸å¯è¯»ï¼</p>\n<pre class=\"line-numbers language-java\" data-language=\"java\"><code class=\"language-java\">package cn.itcast.nio.c4;\n\nimport javafx.concurrent.Worker;\nimport lombok.extern.slf4j.Slf4j;\n\nimport java.io.IOException;\nimport java.net.InetSocketAddress;\nimport java.nio.ByteBuffer;\nimport java.nio.channels.*;\nimport java.util.Iterator;\nimport java.util.concurrent.ConcurrentLinkedQueue;\nimport java.util.concurrent.atomic.AtomicInteger;\n\nimport static cn.itcast.nio.c2.ByteBufferUtil.debugAll;\n\n@Slf4j\npublic class MultiThreadServer &#123;\n    public static void main(String[] args) throws IOException &#123;\n        Thread.currentThread().setName(&quot;boss&quot;);\n        ServerSocketChannel ssc &#x3D; ServerSocketChannel.open();\n        ssc.configureBlocking(false);\n        Selector boss &#x3D; Selector.open();\n        SelectionKey bossKey &#x3D; ssc.register(boss, 0, null);\n        bossKey.interestOps(SelectionKey.OP_ACCEPT);\n        ssc.bind(new InetSocketAddress(8080));\n\n        &#x2F;&#x2F;staticæ–¹æ³•ä¸èƒ½è°ƒç”¨éstatic(æˆå‘˜)å†…éƒ¨ç±»ï¼ï¼ˆè¿˜ä¸å­˜åœ¨ï¼ï¼‰\n        &#x2F;&#x2F; 1. åˆ›å»ºå›ºå®šæ•°é‡çš„ worker å¹¶åˆå§‹åŒ–\n        Worker[] workers &#x3D; new Worker[Runtime.getRuntime().availableProcessors()];\n        for (int i &#x3D; 0; i &lt; workers.length; i++) &#123;\n            workers[i] &#x3D; new Worker(&quot;worker-&quot; + i);\n        &#125;\n        AtomicInteger index &#x3D; new AtomicInteger();&#x2F;&#x2F;\n\n        while(true) &#123;\n            boss.select();\n            Iterator&lt;SelectionKey&gt; iter &#x3D; boss.selectedKeys().iterator();\n            while (iter.hasNext()) &#123;\n                SelectionKey key &#x3D; iter.next();\n                iter.remove();\n                if (key.isAcceptable()) &#123;\n                    SocketChannel sc &#x3D; ssc.accept();\n                    sc.configureBlocking(false);\n\n                    log.debug(&quot;connected...&#123;&#125;&quot;, sc.getRemoteAddress());\n                    &#x2F;&#x2F; 2. å…³è” selector\n                    log.debug(&quot;before register...&#123;&#125;&quot;, sc.getRemoteAddress());\n                    &#x2F;&#x2F; round robin è½®è¯¢\n                    workers[index.getAndIncrement() % workers.length].register(sc); &#x2F;&#x2F;[1] boss è°ƒç”¨ åˆå§‹åŒ– selector , å¯åŠ¨ worker-0\n                    &#x2F;&#x2F; worker.register(sc);\n                    &#x2F;&#x2F; sc.register(worker.selector, SelectionKey.OP_READ, null); &#x2F;&#x2F; boss--&gt;åº”è¯¥ä¸‹ç§»åˆ°workerä¸­ï¼è·¨workerå…ˆåé¡ºåºä¸å¯æ§ï¼\n                    log.debug(&quot;after register...&#123;&#125;&quot;, sc.getRemoteAddress());\n                &#125;\n            &#125;\n        &#125;\n    &#125;\n\n    static class Worker implements Runnable&#123;\n        private Thread thread;\n        private Selector selector;\n        private String name;\n        private volatile boolean start &#x3D; false; &#x2F;&#x2F; è¿˜æœªåˆå§‹åŒ–\n        private ConcurrentLinkedQueue&lt;Runnable&gt; queue &#x3D; new ConcurrentLinkedQueue&lt;&gt;();\n        public Worker(String name) &#123;\n            this.name &#x3D; name;\n        &#125;\n\n        &#x2F;&#x2F; åˆå§‹åŒ–çº¿ç¨‹ï¼Œå’Œ selector\n        public void register(SocketChannel sc) throws IOException &#123;\n            if(!start) &#123;\n                selector &#x3D; Selector.open();\n                thread &#x3D; new Thread(this, name);\n                thread.start();\n                start &#x3D; true;\n            &#125;\n            selector.wakeup(); &#x2F;&#x2F; ï¼ˆ1ï¼‰å”¤é†’ select æ–¹æ³• boss  ã€(å–ç¥¨)ä¸€æ¬¡æ€§ï¼Œå¯å…ˆåï¼Œç­‰fdã€‘ goto-implementï¼šWindowsSelectorImpl\n            sc.register(selector, SelectionKey.OP_READ, null); &#x2F;&#x2F; ï¼ˆ2ï¼‰boss   selectä¸é˜»å¡æ‰èƒ½regæˆåŠŸ\n        &#125;\n\n        @Override\n        public void run() &#123;\n            while(true) &#123;\n                try &#123;\n                    selector.select(); &#x2F;&#x2F; ï¼ˆ3ï¼‰worker-0  é˜»å¡ ã€(1ã€2)(3)3å¥é¡ºåºå‡OKï¼ï¼ï¼ã€‘\n                    Iterator&lt;SelectionKey&gt; iter &#x3D; selector.selectedKeys().iterator();\n                    while (iter.hasNext()) &#123;\n                        SelectionKey key &#x3D; iter.next();\n                        iter.remove();\n                        if (key.isReadable()) &#123;\n                            ByteBuffer buffer &#x3D; ByteBuffer.allocate(16);\n                            SocketChannel channel &#x3D; (SocketChannel) key.channel();\n                            log.debug(&quot;read...&#123;&#125;&quot;, channel.getRemoteAddress());\n                            channel.read(buffer);\n                            buffer.flip();\n                            debugAll(buffer);\n                        &#125;\n                    &#125;\n                &#125; catch (IOException e) &#123;\n                    e.printStackTrace();\n                &#125;\n            &#125;\n        &#125;\n    &#125;\n\n\n&#x2F;&#x2F;    static class Worker implements Runnable &#123;\n&#x2F;&#x2F;        private Thread thread;\n&#x2F;&#x2F;        private Selector selector;\n&#x2F;&#x2F;        private String name;\n&#x2F;&#x2F;        private volatile boolean start &#x3D; false; &#x2F;&#x2F;è¿˜æœªåˆå§‹åŒ–\n&#x2F;&#x2F;        private ConcurrentLinkedQueue&lt;Runnable&gt; queue &#x3D; new ConcurrentLinkedQueue&lt;&gt;();&#x2F;&#x2F;ä¸¤çº¿ç¨‹é—´ä¼ é€’æ•°æ®ï¼šConcurrentLinkedQueueè§£è€¦ï¼è§P161ï¼åŒnettyåšæ³•ï¼\n&#x2F;&#x2F;\n&#x2F;&#x2F;        public Worker(String name) &#123;\n&#x2F;&#x2F;            this.name &#x3D; name;\n&#x2F;&#x2F;        &#125;\n&#x2F;&#x2F;\n&#x2F;&#x2F;        &#x2F;&#x2F;[1] åˆå§‹åŒ–çº¿ç¨‹ï¼Œå’Œselector\n&#x2F;&#x2F;        public void register(SocketChannel sc) throws IOException &#123;\n&#x2F;&#x2F;            if(!start) &#123;&#x2F;&#x2F;first time!\n&#x2F;&#x2F;                selector &#x3D; Selector.open();\n&#x2F;&#x2F;                thread &#x3D; new Thread(this, name);\n&#x2F;&#x2F;                thread.start();&#x2F;&#x2F;[2]\n&#x2F;&#x2F;                start &#x3D; true;\n&#x2F;&#x2F;            &#125;\n&#x2F;&#x2F;            &#x2F;&#x2F;[3.2] bossï¼šå‘é˜Ÿåˆ—é‡Œæ·»åŠ äº†ä»»åŠ¡ï¼Œä½†æ­¤ä»»åŠ¡å¹¶æ²¡æœ‰ç«‹åˆ»æ‰§è¡Œï¼\n&#x2F;&#x2F;            queue.add(()-&gt;&#123;\n&#x2F;&#x2F;                try &#123;\n&#x2F;&#x2F;                    sc.register(selector, SelectionKey.OP_READ, null); &#x2F;&#x2F; ä»ç„¶æ˜¯bossé‡Œæ‰§è¡Œï¼ç”¨ConcurrentLinkedQueueè§£è€¦\n&#x2F;&#x2F;                &#125; catch (ClosedChannelException e) &#123;\n&#x2F;&#x2F;                    e.printStackTrace();\n&#x2F;&#x2F;                &#125;\n&#x2F;&#x2F;            &#125;);\n&#x2F;&#x2F;            selector.wakeup(); &#x2F;&#x2F;[4] å”¤é†’ run()é‡Œçš„ selector.select() æ–¹æ³•\n&#x2F;&#x2F;        &#125;\n&#x2F;&#x2F;        @Override\n&#x2F;&#x2F;        public void run() &#123;&#x2F;&#x2F;[2]worker: new start!\n&#x2F;&#x2F;            while(true) &#123;\n&#x2F;&#x2F;                try &#123;\n&#x2F;&#x2F;                    selector.select();&#x2F;&#x2F;[3.1] worker-0 é˜»å¡:ç­‰åˆ°äº‹ä»¶å‘ç”Ÿ(first:è¿˜æ²¡reg(read),ç­‰åˆ«çš„äº‹ä»¶å‘ç”Ÿ:æ™š) è¢«wakeup()ä¸»åŠ¨å”¤é†’:reg(read)\n&#x2F;&#x2F;                    Runnable task &#x3D; queue.poll();\n&#x2F;&#x2F;                    if(task !&#x3D; null) &#123;\n&#x2F;&#x2F;                        task.run();&#x2F;&#x2F;[5] worker:æ‰§è¡Œäº† sc.register(selector, SelectionKey.OP_READ, null);\n&#x2F;&#x2F;                    &#125;\n&#x2F;&#x2F;                    Iterator&lt;SelectionKey&gt; iter &#x3D; selector.selectedKeys().iterator();\n&#x2F;&#x2F;                    while(iter.hasNext()) &#123;\n&#x2F;&#x2F;                        SelectionKey key &#x3D; iter.next();\n&#x2F;&#x2F;                        iter.remove();\n&#x2F;&#x2F;                        if(key.isReadable()) &#123;\n&#x2F;&#x2F;                            ByteBuffer buffer &#x3D; ByteBuffer.allocate(16);\n&#x2F;&#x2F;                            SocketChannel channel &#x3D; (SocketChannel) key.channel();\n&#x2F;&#x2F;                            log.debug(&quot;read...&#123;&#125;&quot;, channel.getRemoteAddress());\n&#x2F;&#x2F;                            channel.read(buffer);\n&#x2F;&#x2F;                            buffer.flip();\n&#x2F;&#x2F;                            debugAll(buffer);\n&#x2F;&#x2F;                            &#x2F;&#x2F; ç»†èŠ‚ï¼šç²˜åŒ…åŠåŒ…ï¼Œæ‰å¼‚å¸¸é€€å‡ºcancelï¼Œå¯å¤šæ¬¡å†™...\n&#x2F;&#x2F;                        &#125;\n&#x2F;&#x2F;                    &#125;\n&#x2F;&#x2F;\n&#x2F;&#x2F;                &#125; catch (IOException e) &#123;\n&#x2F;&#x2F;                    e.printStackTrace();\n&#x2F;&#x2F;                &#125;\n&#x2F;&#x2F;\n&#x2F;&#x2F;            &#125;\n&#x2F;&#x2F;        &#125;\n&#x2F;&#x2F;\n&#x2F;&#x2F;\n&#x2F;&#x2F;    &#125;\n\n&#125;\n</code></pre>\n\n<p>æ•°ç»„Worker[].length &#x2F;&#x2F;å­—æ®µï¼ï¼ï¼\tstr.length()ï¼ï¼ï¼</p>\n<p>â‘  å¯¹äºObjectä¸­waitå’Œnotifyï¼šå¿…é¡»åœ¨é”ä¸­ä½¿ç”¨ï¼Œè¿™é‡ŒæŒ‡synchronizedï¼Œå¹¶ä¸”waitæ–¹æ³•è¦å…ˆäºnotifyï¼Œå¦åˆ™waitæ–¹æ³•ä¼šä¸€ç›´é˜»å¡è¯¥è¯¥çº¿ç¨‹ã€‚</p>\n<p>â‘¡ Lockä¸­lock.newCondition:condition.await()å’Œcondition.signal()ï¼šå¿…é¡»åœ¨é”ä¸­ä½¿ç”¨ï¼Œè¿™é‡ŒæŒ‡lock.lock()ä¹‹åï¼Œå¹¶ä¸”awaitæ–¹æ³•è¦å…ˆäºsingnalï¼Œå¦åˆ™awaitæ–¹æ³•ä¼šä¸€ç›´é˜»å¡è¯¥è¯¥çº¿ç¨‹ã€‚</p>\n<p>ä¸ºæˆ‘ä»¬æä¾›äº†ä¸€ç§æ–¹ä¾¿çš„åŸºäºåŒä¸€ä¸ªé”ï¼Œ å®ç°å¤šä¸ªæ¡ä»¶çš„ wait() å’Œ notify() æ“ä½œã€‚<code>Condition</code>æ¥å£æŠŠ<code>Object</code>ä¸­çš„<code>wait()</code>ã€<code>notify()</code>å’Œ<code>notifyAll()</code>åˆ†è§£åˆ°äº†ä¸åŒå¯¹è±¡ä¸­ï¼Œæ­é…ä¸Šä»»æ„ä¸€ç§Lockä½¿ç”¨ï¼Œä½¿å¾—ä¸€ä¸ªå¯¹è±¡å¯ä»¥å­˜åœ¨äºå¤šä¸ª<strong>ç­‰å¾…é›†</strong>ã€‚</p>\n<p><img src=\"https://img-blog.csdn.net/20170923153729093?watermark/2/text/aHR0cDovL2Jsb2cuY3Nkbi5uZXQvbGVuZ3hpYW8xOTkz/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70/gravity/SouthEast#pic_center\" alt=\"å›¾ç‰‡æ¥æºäºhttps://blog.csdn.net/lengxiao1993/article/details/81482410\"></p>\n<p>â‘¢ LockSupportä¼˜åŠ¿ï¼Œä¼˜åŠ¿1ï¼šç±»é™æ€æ–¹æ³•ï¼Œä¸éœ€è¦åœ¨é”ä¸­è¿›è¡Œï¼›ä¼˜åŠ¿äºŒï¼š<strong>parkæ–¹æ³•å¯ä»¥ä¸å…ˆäºunparkæ–¹æ³•ã€‚</strong></p>\n<p><a href=\"https://blog.csdn.net/weixin_44601714/article/details/100081131\">https://blog.csdn.net/weixin_44601714/article/details/100081131</a></p>\n<p>å…¶ä»–çº¿ç¨‹å¦‚æœå› ä¸ºè°ƒç”¨äº†selector.select()æˆ–è€…selector.select(long)è¿™ä¸¤ä¸ªæ–¹æ³•è€Œé˜»å¡ï¼Œ è°ƒç”¨äº†selector.wakeup()ä¹‹åï¼Œå°±ä¼šç«‹å³è¿”å›ç»“æœï¼Œå¹¶ä¸”è¿”å›çš„å€¼!&#x3D;0ï¼Œ <strong>å¦‚æœå½“å‰Selectoræ²¡æœ‰é˜»å¡åœ¨selectæ–¹æ³•ä¸Šï¼Œ é‚£ä¹ˆæœ¬æ¬¡ wakeupè°ƒç”¨ä¼šåœ¨ä¸‹ä¸€æ¬¡selecté˜»å¡(å¯ä»¥ä¸å…ˆäº)çš„æ—¶å€™ç”Ÿæ•ˆã€‚</strong></p>\n<p>select()æ–¹æ³•ä¼šé˜»å¡ï¼Œæ˜¯å› ä¸º<strong>ç”¨æˆ·æ€å°†socketçš„æ–‡ä»¶æè¿°ç¬¦å’Œæ„Ÿå…´è¶£çš„äº‹ä»¶ä¼ é€’ç»™æ“ä½œç³»ç»Ÿåº•å±‚çš„pipeï¼Ÿï¼Œåº•å±‚å‡½æ•°ã€æ‰§è¡Œå®Œæˆï¼Œè§¦å‘äº‹ä»¶ä¹‹ååº•å±‚å°±ä¼šå‘ç”¨æˆ·æ€è¿”å›æ•°æ®ã€‘ï¼Œè¿™æ ·æ‰ä¼šæ‰“ç ´é˜»å¡</strong></p>\n<p><img src=\"https://img-blog.csdnimg.cn/20200403141222532.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L0FjY2VsZXJhdGluZw==,size_16,color_FFFFFF,t_70\" alt=\"åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°\"></p>\n<pre class=\"line-numbers language-java\" data-language=\"java\"><code class=\"language-java\">public Selector wakeup() &#123;\n    synchronized(this.interruptLock) &#123;\n        if (!this.interruptTriggered) &#123;\n            this.setWakeupSocket();\n            this.interruptTriggered &#x3D; true;\n        &#125;\n\n        return this;\n    &#125;\n&#125;\n&#x2F;&#x2F;è¿™é‡Œè¿½åˆ°äº†nativeæ–¹æ³•\nprivate native void setWakeupSocket0(int var1);</code></pre>\n\n<p>setWakeupSocket()æ–¹æ³• ä¼šç›´æ¥<strong>å‘pipeä¸­æ·»åŠ wakeupSinkFDï¼Œè¿™ä¸ªFDä¼šç«‹å³æ‰§è¡Œå®Œæˆå¹¶ä¸”è¿”å›æ•°æ®ï¼Œè¿™æ ·åº•å±‚å°±ä¼šç»™ç”¨æˆ·æ€æ•°æ®ï¼Œç„¶åç»“æŸé˜»å¡</strong></p>\n<pre class=\"line-numbers language-java\" data-language=\"java\"><code class=\"language-java\">public class ChannelDemo7 &#123;\n    public static void main(String[] args) throws IOException &#123;\n        new BossEventLoop().register();\n    &#125;\n\n\n    @Slf4j\n    static class BossEventLoop implements Runnable &#123;\n        private Selector boss;\n        private WorkerEventLoop[] workers;\n        private volatile boolean start &#x3D; false;\n        AtomicInteger index &#x3D; new AtomicInteger();\n\n        public void register() throws IOException &#123;\n            if (!start) &#123;\n                ServerSocketChannel ssc &#x3D; ServerSocketChannel.open();\n                ssc.bind(new InetSocketAddress(8080));\n                ssc.configureBlocking(false);\n                boss &#x3D; Selector.open();\n                SelectionKey ssckey &#x3D; ssc.register(boss, 0, null);\n                ssckey.interestOps(SelectionKey.OP_ACCEPT);\n                workers &#x3D; initEventLoops();\n                new Thread(this, &quot;boss&quot;).start();\n                log.debug(&quot;boss start...&quot;);\n                start &#x3D; true;\n            &#125;\n        &#125;\n\n        public WorkerEventLoop[] initEventLoops() &#123;\n&#x2F;&#x2F;        EventLoop[] eventLoops &#x3D; new EventLoop[Runtime.getRuntime().availableProcessors()];\n            WorkerEventLoop[] workerEventLoops &#x3D; new WorkerEventLoop[2];\n            for (int i &#x3D; 0; i &lt; workerEventLoops.length; i++) &#123;\n                workerEventLoops[i] &#x3D; new WorkerEventLoop(i);\n            &#125;\n            return workerEventLoops;\n        &#125;\n\n        @Override\n        public void run() &#123;\n            while (true) &#123;\n                try &#123;\n                    boss.select();\n                    Iterator&lt;SelectionKey&gt; iter &#x3D; boss.selectedKeys().iterator();\n                    while (iter.hasNext()) &#123;\n                        SelectionKey key &#x3D; iter.next();\n                        iter.remove();\n                        if (key.isAcceptable()) &#123;\n                            ServerSocketChannel c &#x3D; (ServerSocketChannel) key.channel();\n                            SocketChannel sc &#x3D; c.accept();\n                            sc.configureBlocking(false);\n                            log.debug(&quot;&#123;&#125; connected&quot;, sc.getRemoteAddress());\n                            workers[index.getAndIncrement() % workers.length].register(sc);\n                        &#125;\n                    &#125;\n                &#125; catch (IOException e) &#123;\n                    e.printStackTrace();\n                &#125;\n            &#125;\n        &#125;\n    &#125;\n\n    @Slf4j\n    static class WorkerEventLoop implements Runnable &#123;\n        private Selector worker;\n        private volatile boolean start &#x3D; false;\n        private int index;\n\n        private final ConcurrentLinkedQueue&lt;Runnable&gt; tasks &#x3D; new ConcurrentLinkedQueue&lt;&gt;();\n\n        public WorkerEventLoop(int index) &#123;\n            this.index &#x3D; index;\n        &#125;\n\n        public void register(SocketChannel sc) throws IOException &#123;\n            if (!start) &#123;\n                worker &#x3D; Selector.open();\n                new Thread(this, &quot;worker-&quot; + index).start();\n                start &#x3D; true;\n            &#125;\n            tasks.add(() -&gt; &#123;\n                try &#123;\n                    SelectionKey sckey &#x3D; sc.register(worker, 0, null);\n                    sckey.interestOps(SelectionKey.OP_READ);\n                    worker.selectNow();&#x2F;&#x2F;\n                &#125; catch (IOException e) &#123;\n                    e.printStackTrace();\n                &#125;\n            &#125;);\n            worker.wakeup();\n        &#125;\n\n        @Override\n        public void run() &#123;\n            while (true) &#123;\n                try &#123;\n                    worker.select();\n                    Runnable task &#x3D; tasks.poll();\n                    if (task !&#x3D; null) &#123;\n                        task.run();\n                    &#125;\n                    Set&lt;SelectionKey&gt; keys &#x3D; worker.selectedKeys();\n                    Iterator&lt;SelectionKey&gt; iter &#x3D; keys.iterator();\n                    while (iter.hasNext()) &#123;\n                        SelectionKey key &#x3D; iter.next();\n                        if (key.isReadable()) &#123;\n                            SocketChannel sc &#x3D; (SocketChannel) key.channel();\n                            ByteBuffer buffer &#x3D; ByteBuffer.allocate(128);\n                            try &#123;\n                                int read &#x3D; sc.read(buffer);\n                                if (read &#x3D;&#x3D; -1) &#123;\n                                    key.cancel();\n                                    sc.close();\n                                &#125; else &#123;\n                                    buffer.flip();\n                                    log.debug(&quot;&#123;&#125; message:&quot;, sc.getRemoteAddress());\n                                    debugAll(buffer);\n                                &#125;\n                            &#125; catch (IOException e) &#123;\n                                e.printStackTrace();\n                                key.cancel();\n                                sc.close();\n                            &#125;\n                        &#125;\n                        iter.remove();\n                    &#125;\n                &#125; catch (IOException e) &#123;\n                    e.printStackTrace();\n                &#125;\n            &#125;\n        &#125;\n    &#125;\n&#125;</code></pre>\n\n\n\n<h4 id=\"ğŸ’¡-å¦‚ä½•æ‹¿åˆ°-cpu-ä¸ªæ•°\"><a href=\"#ğŸ’¡-å¦‚ä½•æ‹¿åˆ°-cpu-ä¸ªæ•°\" class=\"headerlink\" title=\"ğŸ’¡ å¦‚ä½•æ‹¿åˆ° cpu ä¸ªæ•°\"></a>ğŸ’¡ å¦‚ä½•æ‹¿åˆ° cpu ä¸ªæ•°</h4><blockquote><span class=\"custom-blockquote-svg\"><svg width=\"24\" height=\"24\" viewBox=\"0 0 24 24\" fill=\"\" xmlns=\"http://www.w3.org/2000/svg\" data-reactroot=\"\">\n<path fill=\"\" d=\"M22 12C22 6.5 17.5 2 12 2C6.5 2 2 6.5 2 12C2 17.5 6.5 22 12 22C13.8 22 15.5 21.5 17 20.6L22 22L20.7 17C21.5 15.5 22 13.8 22 12Z\" undefined=\"1\"></path>\n<path fill=\"\" d=\"M15.97 11.5H16.04C17.12 11.5 18 12.38 18 13.47V13.53C18 14.62 17.12 15.5 16.03 15.5H15.96C14.88 15.5 14 14.62 14 13.53V13.46C14 12.38 14.88 11.5 15.97 11.5Z\" undefined=\"1\"></path>\n<path fill=\"\" d=\"M7.97 11.5H8.04C9.12 11.5 10 12.38 10 13.47V13.53C10 14.62 9.12 15.5 8.03 15.5H7.97C6.88 15.5 6 14.62 6 13.53V13.46C6 12.38 6.88 11.5 7.97 11.5Z\" undefined=\"1\"></path>\n<path stroke-linejoin=\"round\" stroke-linecap=\"round\" stroke-miterlimit=\"10\" stroke-width=\"2\" stroke=\"\" d=\"M17 8.5C15.23 8.97 14.07 10.84 14.01 13.27C14 13.33 14 13.4 14 13.47V13.5\"></path>\n<path stroke-linejoin=\"round\" stroke-linecap=\"round\" stroke-miterlimit=\"10\" stroke-width=\"2\" stroke=\"\" d=\"M9 8.5C7.23 8.97 6.07 10.84 6.01 13.27C6 13.33 6 13.4 6 13.47V13.5\"></path>\n<path stroke-linejoin=\"round\" stroke-linecap=\"round\" stroke-miterlimit=\"10\" stroke-width=\"2\" stroke=\"\" d=\"M15.97 11.5H16.04C17.12 11.5 18 12.38 18 13.47V13.53C18 14.62 17.12 15.5 16.03 15.5H15.96C14.88 15.5 14 14.62 14 13.53V13.46C14 12.38 14.88 11.5 15.97 11.5Z\"></path>\n<path stroke-linejoin=\"round\" stroke-linecap=\"round\" stroke-miterlimit=\"10\" stroke-width=\"2\" stroke=\"\" d=\"M7.97 11.5H8.04C9.12 11.5 10 12.38 10 13.47V13.53C10 14.62 9.12 15.5 8.03 15.5H7.97C6.88 15.5 6 14.62 6 13.53V13.46C6 12.38 6.88 11.5 7.97 11.5Z\"></path>\n</svg>\n</span><ul>\n<li><strong>Runtime.getRuntime().availableProcessors() å¦‚æœå·¥ä½œåœ¨ docker å®¹å™¨ä¸‹ï¼Œå› ä¸ºå®¹å™¨ä¸æ˜¯ç‰©ç†éš”ç¦»çš„ï¼Œä¼šæ‹¿åˆ°ç‰©ç† cpu ä¸ªæ•°ï¼Œè€Œä¸æ˜¯å®¹å™¨ç”³è¯·æ—¶çš„ä¸ªæ•°</strong>\tjdk8ä¸‹éƒ¨ç½²ï¼Œæœ€å¥½æ‰‹åŠ¨æŒ‡å®šå‡ æ ¸ï¼</li>\n<li>è¿™ä¸ªé—®é¢˜ç›´åˆ° <strong>jdk 10 æ‰ä¿®å¤ï¼Œä½¿ç”¨ jvm å‚æ•° UseContainerSupport é…ç½®ï¼Œ é»˜è®¤å¼€å¯</strong></li>\n</ul></blockquote>\n<p>CPUè®¡ç®—å¯†é›†å‹ï¼šæ ¸å¿ƒæ•°ã€IOå¯†é›†å‹ï¼šTHs&gt;æ ¸æ•° Amdahlå®šå¾‹ï¼š<img src=\"https://www.zhihu.com/equation?tex=Time+=+s+++%5Cfrac%7Bf%7D%7Bp%7D\" alt=\"[å…¬å¼]\"></p>\n<ul>\n<li><img src=\"https://www.zhihu.com/equation?tex=s\" alt=\"[å…¬å¼]\"> ä¸²è¡Œéƒ¨åˆ†</li>\n<li><img src=\"https://www.zhihu.com/equation?tex=f\" alt=\"[å…¬å¼]\"> å¹¶è¡Œéƒ¨åˆ†</li>\n<li><img src=\"https://www.zhihu.com/equation?tex=p\" alt=\"[å…¬å¼]\"> æ ¸æ•°</li>\n</ul>\n<h3 id=\"4-7-UDP\"><a href=\"#4-7-UDP\" class=\"headerlink\" title=\"4.7 UDP\"></a>4.7 UDP</h3><ul>\n<li>UDP æ˜¯<strong>æ— è¿æ¥çš„ï¼Œclient å‘é€æ•°æ®ä¸ä¼šç®¡ server æ˜¯å¦å¼€å¯</strong></li>\n<li>server è¿™è¾¹çš„ <strong>receive æ–¹æ³•ä¼šå°†æ¥æ”¶åˆ°çš„æ•°æ®å­˜å…¥ byte bufferï¼Œä½†å¦‚æœæ•°æ®æŠ¥æ–‡è¶…è¿‡ buffer å¤§å°ï¼Œå¤šå‡ºæ¥çš„æ•°æ®ä¼šè¢«é»˜é»˜æŠ›å¼ƒ</strong></li>\n</ul>\n<p>é¦–å…ˆå¯åŠ¨æœåŠ¡å™¨ç«¯</p>\n<pre class=\"line-numbers language-java\" data-language=\"java\"><code class=\"language-java\">public class UdpServer &#123;\n    public static void main(String[] args) &#123;\n        try (DatagramChannel channel &#x3D; DatagramChannel.open()) &#123;\n            channel.socket().bind(new InetSocketAddress(9999));&#x2F;&#x2F;\n            System.out.println(&quot;waiting...&quot;);\n            ByteBuffer buffer &#x3D; ByteBuffer.allocate(32);\n            channel.receive(buffer);&#x2F;&#x2F;\n            buffer.flip();\n            debug(buffer);\n        &#125; catch (IOException e) &#123;\n            e.printStackTrace();\n        &#125;\n    &#125;\n&#125;</code></pre>\n\n<p>è¾“å‡º</p>\n<pre class=\"line-numbers language-none\"><code class=\"language-none\">waiting...</code></pre>\n\n\n\n<p>è¿è¡Œå®¢æˆ·ç«¯</p>\n<pre class=\"line-numbers language-java\" data-language=\"java\"><code class=\"language-java\">public class UdpClient &#123;\n    public static void main(String[] args) &#123;\n        try (DatagramChannel channel &#x3D; DatagramChannel.open()) &#123;\n            ByteBuffer buffer &#x3D; StandardCharsets.UTF_8.encode(&quot;hello&quot;);\n            InetSocketAddress address &#x3D; new InetSocketAddress(&quot;localhost&quot;, 9999);\n            channel.send(buffer, address);&#x2F;&#x2F;\n        &#125; catch (Exception e) &#123;\n            e.printStackTrace();\n        &#125;\n    &#125;\n&#125;</code></pre>\n\n<p>æ¥ä¸‹æ¥æœåŠ¡å™¨ç«¯è¾“å‡º</p>\n<pre class=\"line-numbers language-none\"><code class=\"language-none\">         +-------------------------------------------------+\n         |  0  1  2  3  4  5  6  7  8  9  a  b  c  d  e  f |\n+--------+-------------------------------------------------+----------------+\n|00000000| 68 65 6c 6c 6f                                  |hello           |\n+--------+-------------------------------------------------+----------------+</code></pre>\n\n\n\n\n\n<h2 id=\"5-NIO-vs-BIO\"><a href=\"#5-NIO-vs-BIO\" class=\"headerlink\" title=\"5. NIO vs BIO\"></a>5. NIO vs BIO</h2><h3 id=\"5-1-stream-vs-channel\"><a href=\"#5-1-stream-vs-channel\" class=\"headerlink\" title=\"5.1 stream vs channel\"></a>5.1 stream vs channel</h3><ul>\n<li><strong>stream ä¸ä¼šè‡ªåŠ¨ç¼“å†²</strong>æ•°æ®ï¼Œ<strong>channel ä¼šåˆ©ç”¨ç³»ç»Ÿæä¾›çš„å‘é€ç¼“å†²åŒºã€æ¥æ”¶ç¼“å†²åŒºï¼ˆæ›´ä¸ºåº•å±‚ï¼‰</strong></li>\n<li>stream ä»…æ”¯æŒé˜»å¡ APIï¼Œ<strong>channel åŒæ—¶æ”¯æŒé˜»å¡ã€éé˜»å¡ APIï¼Œç½‘ç»œ channel å¯é…åˆ selector å®ç°å¤šè·¯å¤ç”¨</strong></li>\n<li>äºŒè€…<strong>å‡ä¸ºå…¨åŒå·¥ï¼Œå³è¯»å†™å¯ä»¥åŒæ—¶</strong>è¿›è¡Œï¼Ÿï¼Ÿï¼Ÿ</li>\n</ul>\n<h3 id=\"5-2-IO-æ¨¡å‹\"><a href=\"#5-2-IO-æ¨¡å‹\" class=\"headerlink\" title=\"5.2 IO æ¨¡å‹\"></a>5.2 IO æ¨¡å‹</h3><p>&#x3D;&#x3D;åŒæ­¥é˜»å¡ã€åŒæ­¥éé˜»å¡ã€åŒæ­¥å¤šè·¯å¤ç”¨ã€å¼‚æ­¥é˜»å¡ï¼ˆæ²¡æœ‰æ­¤æƒ…å†µï¼‰ã€å¼‚æ­¥éé˜»å¡&#x3D;&#x3D;</p>\n<ul>\n<li>åŒæ­¥ï¼š<strong>çº¿ç¨‹è‡ªå·±å»è·å–ç»“æœ</strong>ï¼ˆä¸€ä¸ªçº¿ç¨‹ï¼‰</li>\n<li>å¼‚æ­¥ï¼šçº¿ç¨‹è‡ªå·±ä¸å»è·å–ç»“æœï¼Œè€Œæ˜¯<strong>ç”±å…¶å®ƒçº¿ç¨‹é€ç»“æœï¼ˆè‡³å°‘ä¸¤ä¸ªçº¿ç¨‹ï¼‰</strong></li>\n</ul>\n<p>å½“è°ƒç”¨ä¸€æ¬¡ channel.read æˆ– stream.read åï¼Œä¼šåˆ‡æ¢è‡³æ“ä½œç³»ç»Ÿå†…æ ¸æ€æ¥å®ŒæˆçœŸæ­£æ•°æ®è¯»å–ï¼Œè€Œè¯»å–åˆåˆ†ä¸ºä¸¤ä¸ªé˜¶æ®µï¼Œåˆ†åˆ«ä¸ºï¼š</p>\n<ul>\n<li>ç­‰å¾…æ•°æ®é˜¶æ®µ</li>\n<li>å¤åˆ¶æ•°æ®é˜¶æ®µ</li>\n</ul>\n<p><img src=\"http://cache.itzy8.top/%E5%AD%A6Netty-%E9%BB%91%E9%A9%AC%E6%BB%A1%E5%93%A5/0033.png\"></p>\n<ul>\n<li><p>é˜»å¡ IO</p>\n<p><img src=\"http://cache.itzy8.top/%E5%AD%A6Netty-%E9%BB%91%E9%A9%AC%E6%BB%A1%E5%93%A5/0039.png\"></p>\n</li>\n<li><p>éé˜»å¡  IO    ä¸¤æ€åˆ‡æ¢è¿‡äºé¢‘ç¹</p>\n<p><img src=\"http://cache.itzy8.top/%E5%AD%A6Netty-%E9%BB%91%E9%A9%AC%E6%BB%A1%E5%93%A5/0035.png\"></p>\n</li>\n<li><p>å¤šè·¯å¤ç”¨</p>\n<p><img src=\"http://cache.itzy8.top/%E5%AD%A6Netty-%E9%BB%91%E9%A9%AC%E6%BB%A1%E5%93%A5/0038.png\"></p>\n</li>\n<li><p>é˜»å¡ IO[ä¸²è¡Œ] vs å¤šè·¯å¤ç”¨[ä¸€æ¬¡æ€§æ‹¿åˆ°ä¸€æ‰¹eventsï¼Œå¾ªç¯åˆ†ç±»å¤„ç†]</p>\n<p><img src=\"http://cache.itzy8.top/%E5%AD%A6Netty-%E9%BB%91%E9%A9%AC%E6%BB%A1%E5%93%A5/0034.png\"></p>\n<p><img src=\"http://cache.itzy8.top/%E5%AD%A6Netty-%E9%BB%91%E9%A9%AC%E6%BB%A1%E5%93%A5/0036.png\"></p>\n<ul>\n<li><p>ä¿¡å·é©±åŠ¨</p>\n</li>\n<li><p>å¼‚æ­¥ IO    th1å®šä¹‰äº†å›è°ƒç›´æ¥è¿”å›ï¼Œth2è°ƒç”¨å›è°ƒå‡½æ•°ï¼Œå¡«å…¥å‚ï¼Œé€ç»“æœ</p>\n<p><img src=\"http://cache.itzy8.top/%E5%AD%A6Netty-%E9%BB%91%E9%A9%AC%E6%BB%A1%E5%93%A5/0037.png\"></p>\n</li>\n</ul>\n</li>\n</ul>\n<h4 id=\"ğŸ”–-å‚è€ƒ\"><a href=\"#ğŸ”–-å‚è€ƒ\" class=\"headerlink\" title=\"ğŸ”– å‚è€ƒ\"></a>ğŸ”– å‚è€ƒ</h4><p>UNIX ç½‘ç»œç¼–ç¨‹ - å· I</p>\n<h3 id=\"5-3-é›¶æ‹·è´\"><a href=\"#5-3-é›¶æ‹·è´\" class=\"headerlink\" title=\"5.3 é›¶æ‹·è´\"></a>5.3 é›¶æ‹·è´</h3><h4 id=\"ä¼ ç»Ÿ-IO-é—®é¢˜\"><a href=\"#ä¼ ç»Ÿ-IO-é—®é¢˜\" class=\"headerlink\" title=\"ä¼ ç»Ÿ IO é—®é¢˜\"></a>ä¼ ç»Ÿ IO é—®é¢˜</h4><p>ä¼ ç»Ÿçš„ IO å°†ä¸€ä¸ªæ–‡ä»¶é€šè¿‡ socket å†™å‡º</p>\n<pre class=\"line-numbers language-java\" data-language=\"java\"><code class=\"language-java\">File f &#x3D; new File(&quot;helloword&#x2F;data.txt&quot;);\nRandomAccessFile file &#x3D; new RandomAccessFile(file, &quot;r&quot;);\n\nbyte[] buf &#x3D; new byte[(int)f.length()];\nfile.read(buf);&#x2F;&#x2F;12\n\nSocket socket &#x3D; ...;\nsocket.getOutputStream().write(buf);&#x2F;&#x2F;34</code></pre>\n\n<p>å†…éƒ¨å·¥ä½œæµç¨‹æ˜¯è¿™æ ·çš„ï¼š</p>\n<p><img src=\"http://cache.itzy8.top/%E5%AD%A6Netty-%E9%BB%91%E9%A9%AC%E6%BB%A1%E5%93%A5/0024.png\"></p>\n<ol>\n<li><p>java æœ¬èº«å¹¶ä¸å…·å¤‡ IO è¯»å†™èƒ½åŠ›ï¼Œå› æ­¤ read æ–¹æ³•è°ƒç”¨åï¼Œè¦ä» java ç¨‹åºçš„<strong>ç”¨æˆ·æ€</strong>åˆ‡æ¢è‡³<strong>å†…æ ¸æ€</strong>ï¼Œå»è°ƒç”¨æ“ä½œç³»ç»Ÿï¼ˆKernelï¼‰çš„è¯»èƒ½åŠ›ï¼Œå°†æ•°æ®è¯»å…¥<strong>å†…æ ¸ç¼“å†²åŒº</strong>ã€‚è¿™æœŸé—´ã€ç”¨æˆ·çº¿ç¨‹é˜»å¡ï¼Œæ“ä½œç³»ç»Ÿä½¿ç”¨ DMAï¼ˆDirect Memory Accessï¼‰æ¥å®ç°æ–‡ä»¶è¯»ï¼Œå…¶é—´ä¹Ÿä¸ä¼šä½¿ç”¨ cpuã€‘</p>\n<blockquote><span class=\"custom-blockquote-svg\"><svg width=\"24\" height=\"24\" viewBox=\"0 0 24 24\" fill=\"\" xmlns=\"http://www.w3.org/2000/svg\" data-reactroot=\"\">\n<path fill=\"\" d=\"M22 12C22 6.5 17.5 2 12 2C6.5 2 2 6.5 2 12C2 17.5 6.5 22 12 22C13.8 22 15.5 21.5 17 20.6L22 22L20.7 17C21.5 15.5 22 13.8 22 12Z\" undefined=\"1\"></path>\n<path fill=\"\" d=\"M15.97 11.5H16.04C17.12 11.5 18 12.38 18 13.47V13.53C18 14.62 17.12 15.5 16.03 15.5H15.96C14.88 15.5 14 14.62 14 13.53V13.46C14 12.38 14.88 11.5 15.97 11.5Z\" undefined=\"1\"></path>\n<path fill=\"\" d=\"M7.97 11.5H8.04C9.12 11.5 10 12.38 10 13.47V13.53C10 14.62 9.12 15.5 8.03 15.5H7.97C6.88 15.5 6 14.62 6 13.53V13.46C6 12.38 6.88 11.5 7.97 11.5Z\" undefined=\"1\"></path>\n<path stroke-linejoin=\"round\" stroke-linecap=\"round\" stroke-miterlimit=\"10\" stroke-width=\"2\" stroke=\"\" d=\"M17 8.5C15.23 8.97 14.07 10.84 14.01 13.27C14 13.33 14 13.4 14 13.47V13.5\"></path>\n<path stroke-linejoin=\"round\" stroke-linecap=\"round\" stroke-miterlimit=\"10\" stroke-width=\"2\" stroke=\"\" d=\"M9 8.5C7.23 8.97 6.07 10.84 6.01 13.27C6 13.33 6 13.4 6 13.47V13.5\"></path>\n<path stroke-linejoin=\"round\" stroke-linecap=\"round\" stroke-miterlimit=\"10\" stroke-width=\"2\" stroke=\"\" d=\"M15.97 11.5H16.04C17.12 11.5 18 12.38 18 13.47V13.53C18 14.62 17.12 15.5 16.03 15.5H15.96C14.88 15.5 14 14.62 14 13.53V13.46C14 12.38 14.88 11.5 15.97 11.5Z\"></path>\n<path stroke-linejoin=\"round\" stroke-linecap=\"round\" stroke-miterlimit=\"10\" stroke-width=\"2\" stroke=\"\" d=\"M7.97 11.5H8.04C9.12 11.5 10 12.38 10 13.47V13.53C10 14.62 9.12 15.5 8.03 15.5H7.97C6.88 15.5 6 14.62 6 13.53V13.46C6 12.38 6.88 11.5 7.97 11.5Z\"></path>\n</svg>\n</span><p>DMA ä¹Ÿå¯ä»¥ç†è§£ä¸ºç¡¬ä»¶å•å…ƒï¼Œç”¨æ¥è§£æ”¾ cpu å®Œæˆæ–‡ä»¶ IO</p></blockquote>\n</li>\n<li><p>ä»<strong>å†…æ ¸æ€</strong>åˆ‡æ¢å›<strong>ç”¨æˆ·æ€</strong>ï¼Œå°†æ•°æ®ä»<strong>å†…æ ¸ç¼“å†²åŒº</strong>è¯»å…¥<strong>ç”¨æˆ·ç¼“å†²åŒº</strong>ï¼ˆå³ byte[] bufï¼‰ï¼Œè¿™æœŸé—´ cpu ä¼šå‚ä¸æ‹·è´ï¼Œæ— æ³•åˆ©ç”¨ DMA</p>\n</li>\n<li><p>è°ƒç”¨ write æ–¹æ³•ï¼Œè¿™æ—¶å°†æ•°æ®ä»<strong>ç”¨æˆ·ç¼“å†²åŒº</strong>ï¼ˆbyte[] bufï¼‰å†™å…¥ <strong>socket ç¼“å†²åŒº</strong>ï¼Œcpu ä¼šå‚ä¸æ‹·è´</p>\n</li>\n<li><p>æ¥ä¸‹æ¥è¦å‘ç½‘å¡å†™æ•°æ®ï¼Œè¿™é¡¹èƒ½åŠ› java åˆä¸å…·å¤‡ï¼Œå› æ­¤åˆå¾—ä»<strong>ç”¨æˆ·æ€</strong>åˆ‡æ¢è‡³<strong>å†…æ ¸æ€</strong>ï¼Œè°ƒç”¨æ“ä½œç³»ç»Ÿçš„å†™èƒ½åŠ›ï¼Œã€ä½¿ç”¨ DMA å°† <strong>socket ç¼“å†²åŒº</strong>çš„æ•°æ®å†™å…¥ç½‘å¡ï¼Œä¸ä¼šä½¿ç”¨ cpuã€‘</p>\n</li>\n</ol>\n<p>å¯ä»¥çœ‹åˆ°ä¸­é—´ç¯èŠ‚è¾ƒå¤šï¼Œjava çš„ IO å®é™…ä¸æ˜¯ç‰©ç†è®¾å¤‡çº§åˆ«çš„è¯»å†™ï¼Œè€Œæ˜¯ç¼“å­˜çš„å¤åˆ¶ï¼Œåº•å±‚çš„çœŸæ­£è¯»å†™æ˜¯æ“ä½œç³»ç»Ÿæ¥å®Œæˆçš„</p>\n<ul>\n<li>ç”¨æˆ·æ€ä¸å†…æ ¸<strong>æ€çš„åˆ‡æ¢å‘ç”Ÿäº† 3 æ¬¡</strong>ï¼Œè¿™ä¸ªæ“ä½œæ¯”è¾ƒé‡é‡çº§</li>\n<li>æ•°æ®<strong>æ‹·è´äº†å…± 4 æ¬¡</strong></li>\n</ul>\n<h4 id=\"NIO-ä¼˜åŒ–\"><a href=\"#NIO-ä¼˜åŒ–\" class=\"headerlink\" title=\"NIO ä¼˜åŒ–\"></a>NIO ä¼˜åŒ–</h4><p>é€šè¿‡ &#x3D;&#x3D;DirectByteBuf&#x3D;&#x3D;</p>\n<ul>\n<li>ByteBuffer.allocate(10)  HeapByteBuffer ä½¿ç”¨çš„è¿˜æ˜¯ java å†…å­˜</li>\n<li><strong>ByteBuffer.allocateDirect(10)  DirectByteBuffer ä½¿ç”¨çš„æ˜¯æ“ä½œç³»ç»Ÿå†…å­˜</strong></li>\n</ul>\n<p><img src=\"http://cache.itzy8.top/%E5%AD%A6Netty-%E9%BB%91%E9%A9%AC%E6%BB%A1%E5%93%A5/0025.png\"></p>\n<p>å¤§éƒ¨åˆ†æ­¥éª¤ä¸ä¼˜åŒ–å‰ç›¸åŒï¼Œä¸å†èµ˜è¿°ã€‚å”¯æœ‰ä¸€ç‚¹ï¼šjava å¯ä»¥ä½¿&#x3D;&#x3D;<strong>ç”¨ DirectByteBuf å°†ã€å †å¤–å†…å­˜æ˜ å°„åˆ° jvm å†…å­˜ä¸­æ¥ç›´æ¥è®¿é—®ã€‘ä½¿ç”¨</strong>&#x3D;&#x3D;</p>\n<ul>\n<li>&#x3D;&#x3D;è¿™å—å†…å­˜<strong>ä¸å— jvm åƒåœ¾å›æ”¶çš„å½±å“ï¼Œå› æ­¤å†…å­˜åœ°å€å›ºå®šï¼Œæœ‰åŠ©äº IO è¯»å†™</strong>&#x3D;&#x3D;</li>\n<li>java ä¸­çš„ &#x3D;&#x3D;<strong>DirectByteBuf å¯¹è±¡ä»…ç»´æŠ¤äº†æ­¤å†…å­˜çš„è™šå¼•ç”¨</strong>&#x3D;&#x3D;ï¼Œå†…å­˜å›æ”¶åˆ†æˆä¸¤æ­¥<ul>\n<li>DirectByteBuf <strong>å¯¹è±¡è¢«åƒåœ¾å›æ”¶ï¼Œå°†[è™šå¼•ç”¨åŠ å…¥å¼•ç”¨é˜Ÿåˆ—]</strong></li>\n<li>é€šè¿‡&#x3D;&#x3D;ä¸“é—¨çº¿ç¨‹è®¿é—®å¼•ç”¨é˜Ÿåˆ—ï¼Œæ ¹æ®è™šå¼•ç”¨é‡Šæ”¾å †å¤–å†…å­˜&#x3D;&#x3D;</li>\n</ul>\n</li>\n<li><strong>åªå‡å°‘äº†ä¸€æ¬¡æ•°æ®æ‹·è´</strong>ï¼Œç”¨æˆ·æ€ä¸å†…æ ¸<strong>æ€çš„åˆ‡æ¢æ¬¡æ•°æ²¡æœ‰å‡å°‘</strong></li>\n</ul>\n<p>è¿›ä¸€æ­¥ä¼˜åŒ–ï¼ˆåº•å±‚é‡‡ç”¨äº† &#x3D;&#x3D;linux 2.1&#x3D;&#x3D; åæä¾›çš„ <strong>sendFile æ–¹æ³•</strong>ï¼‰ï¼Œjava ä¸­å¯¹åº”ç€<strong>ä¸¤ä¸ª channel è°ƒç”¨ transferTo&#x2F;transferFrom æ–¹æ³•æ‹·è´æ•°æ®</strong></p>\n<p><img src=\"http://cache.itzy8.top/%E5%AD%A6Netty-%E9%BB%91%E9%A9%AC%E6%BB%A1%E5%93%A5/0026.png\"></p>\n<ol>\n<li>java è°ƒç”¨ transferTo æ–¹æ³•åï¼Œè¦ä» java ç¨‹åºçš„<strong>ç”¨æˆ·æ€</strong>åˆ‡æ¢è‡³<strong>å†…æ ¸æ€</strong>ï¼Œä½¿ç”¨ DMAå°†æ•°æ®è¯»å…¥<strong>å†…æ ¸ç¼“å†²åŒº</strong>ï¼Œä¸ä¼šä½¿ç”¨ cpu</li>\n<li>æ•°æ®ä»<strong>å†…æ ¸ç¼“å†²åŒº</strong>ä¼ è¾“åˆ° <strong>socket ç¼“å†²åŒº</strong>ï¼Œã€cpu ä¼šå‚ä¸æ‹·è´ã€‘</li>\n<li>æœ€åä½¿ç”¨ DMA å°† <strong>socket ç¼“å†²åŒº</strong>çš„æ•°æ®å†™å…¥ç½‘å¡ï¼Œä¸ä¼šä½¿ç”¨ cpu</li>\n</ol>\n<p>å¯ä»¥çœ‹åˆ°</p>\n<ul>\n<li>åªå‘ç”Ÿäº†ä¸€æ¬¡ç”¨æˆ·æ€ä¸å†…æ ¸æ€çš„åˆ‡æ¢</li>\n<li>æ•°æ®æ‹·è´äº† 3 æ¬¡</li>\n</ul>\n<p>è¿›ä¸€æ­¥ä¼˜åŒ–&#x3D;&#x3D;ï¼ˆlinux 2.4ï¼‰&#x3D;&#x3D;</p>\n<p><img src=\"http://cache.itzy8.top/%E5%AD%A6Netty-%E9%BB%91%E9%A9%AC%E6%BB%A1%E5%93%A5/0027.png\"></p>\n<ol>\n<li>java è°ƒç”¨ transferTo æ–¹æ³•åï¼Œè¦ä» java ç¨‹åºçš„<strong>ç”¨æˆ·æ€</strong>åˆ‡æ¢è‡³<strong>å†…æ ¸æ€</strong>ï¼Œä½¿ç”¨ DMAå°†æ•°æ®è¯»å…¥<strong>å†…æ ¸ç¼“å†²åŒº</strong>ï¼Œä¸ä¼šä½¿ç”¨ cpu</li>\n<li>åªä¼šå°†ä¸€äº›&#x3D;&#x3D;ã€offset å’Œ length ä¿¡æ¯ã€‘æ‹·å…¥ <strong>socket ç¼“å†²åŒº</strong>ï¼Œå‡ ä¹æ— æ¶ˆè€—&#x3D;&#x3D;</li>\n<li>ä½¿ç”¨ DMA å°† <strong>å†…æ ¸ç¼“å†²åŒº</strong>çš„æ•°æ®å†™å…¥ç½‘å¡ï¼Œä¸ä¼šä½¿ç”¨ cpu</li>\n</ol>\n<p>æ•´ä¸ªè¿‡ç¨‹&#x3D;&#x3D;ä»…åªå‘ç”Ÿäº†ä¸€æ¬¡ç”¨æˆ·æ€ä¸å†…æ ¸æ€çš„åˆ‡æ¢ï¼Œæ•°æ®æ‹·è´äº† 2 æ¬¡&#x3D;&#x3D;ã€‚æ‰€è°“çš„ã€é›¶æ‹·è´ã€‘ï¼Œå¹¶ä¸æ˜¯çœŸæ­£æ— æ‹·è´ï¼Œè€Œæ˜¯ã€ä¸ä¼šå†æ‹·è´é‡å¤æ•°æ®åˆ° jvm å†…å­˜ä¸­ã€‘ï¼Œé›¶æ‹·è´çš„ä¼˜ç‚¹æœ‰</p>\n<ul>\n<li>æ›´å°‘çš„ç”¨æˆ·æ€ä¸å†…æ ¸ã€æ€çš„åˆ‡æ¢ã€‘</li>\n<li>ã€ä¸åˆ©ç”¨ cpu è®¡ç®—ã€‘ï¼Œ&#x3D;&#x3D;å‡å°‘ cpu ç¼“å­˜ä¼ªå…±äº«&#x3D;&#x3D;</li>\n<li>é›¶æ‹·è´<strong>é€‚åˆå°æ–‡ä»¶ä¼ </strong>è¾“ã€ç¼“å†²åŒºï¼Œåå¤RWï¼šå°æ–‡ä»¶ï¼ã€‘</li>\n</ul>\n<h3 id=\"5-3-AIO\"><a href=\"#5-3-AIO\" class=\"headerlink\" title=\"5.3 AIO\"></a>5.3 AIO</h3><p>AIO ç”¨æ¥è§£å†³æ•°æ®å¤åˆ¶é˜¶æ®µçš„é˜»å¡é—®é¢˜</p>\n<ul>\n<li>åŒæ­¥æ„å‘³ç€ï¼Œåœ¨è¿›è¡Œè¯»å†™æ“ä½œæ—¶ï¼Œçº¿ç¨‹éœ€è¦ç­‰å¾…ç»“æœï¼Œè¿˜æ˜¯ç›¸å½“äº[é—²ç½®]</li>\n<li>å¼‚æ­¥æ„å‘³ç€ï¼Œåœ¨è¿›è¡Œè¯»å†™æ“ä½œæ—¶ï¼Œçº¿ç¨‹[ä¸å¿…ç­‰å¾…]ç»“æœï¼Œè€Œæ˜¯[å°†æ¥ç”±æ“ä½œç³»ç»Ÿæ¥é€šè¿‡å›è°ƒæ–¹å¼ç”±å¦å¤–çš„çº¿ç¨‹æ¥è·å¾—ç»“æœ]</li>\n</ul>\n<blockquote><span class=\"custom-blockquote-svg\"><svg width=\"24\" height=\"24\" viewBox=\"0 0 24 24\" fill=\"\" xmlns=\"http://www.w3.org/2000/svg\" data-reactroot=\"\">\n<path fill=\"\" d=\"M22 12C22 6.5 17.5 2 12 2C6.5 2 2 6.5 2 12C2 17.5 6.5 22 12 22C13.8 22 15.5 21.5 17 20.6L22 22L20.7 17C21.5 15.5 22 13.8 22 12Z\" undefined=\"1\"></path>\n<path fill=\"\" d=\"M15.97 11.5H16.04C17.12 11.5 18 12.38 18 13.47V13.53C18 14.62 17.12 15.5 16.03 15.5H15.96C14.88 15.5 14 14.62 14 13.53V13.46C14 12.38 14.88 11.5 15.97 11.5Z\" undefined=\"1\"></path>\n<path fill=\"\" d=\"M7.97 11.5H8.04C9.12 11.5 10 12.38 10 13.47V13.53C10 14.62 9.12 15.5 8.03 15.5H7.97C6.88 15.5 6 14.62 6 13.53V13.46C6 12.38 6.88 11.5 7.97 11.5Z\" undefined=\"1\"></path>\n<path stroke-linejoin=\"round\" stroke-linecap=\"round\" stroke-miterlimit=\"10\" stroke-width=\"2\" stroke=\"\" d=\"M17 8.5C15.23 8.97 14.07 10.84 14.01 13.27C14 13.33 14 13.4 14 13.47V13.5\"></path>\n<path stroke-linejoin=\"round\" stroke-linecap=\"round\" stroke-miterlimit=\"10\" stroke-width=\"2\" stroke=\"\" d=\"M9 8.5C7.23 8.97 6.07 10.84 6.01 13.27C6 13.33 6 13.4 6 13.47V13.5\"></path>\n<path stroke-linejoin=\"round\" stroke-linecap=\"round\" stroke-miterlimit=\"10\" stroke-width=\"2\" stroke=\"\" d=\"M15.97 11.5H16.04C17.12 11.5 18 12.38 18 13.47V13.53C18 14.62 17.12 15.5 16.03 15.5H15.96C14.88 15.5 14 14.62 14 13.53V13.46C14 12.38 14.88 11.5 15.97 11.5Z\"></path>\n<path stroke-linejoin=\"round\" stroke-linecap=\"round\" stroke-miterlimit=\"10\" stroke-width=\"2\" stroke=\"\" d=\"M7.97 11.5H8.04C9.12 11.5 10 12.38 10 13.47V13.53C10 14.62 9.12 15.5 8.03 15.5H7.97C6.88 15.5 6 14.62 6 13.53V13.46C6 12.38 6.88 11.5 7.97 11.5Z\"></path>\n</svg>\n</span><p>å¼‚æ­¥æ¨¡å‹éœ€è¦åº•å±‚æ“ä½œç³»ç»Ÿï¼ˆKernelï¼‰æä¾›æ”¯æŒ</p>\n<ul>\n<li>&#x3D;&#x3D;Windows ç³»ç»Ÿé€šè¿‡ IOCP å®ç°äº†çœŸæ­£çš„å¼‚æ­¥ IOï¼Ÿï¼Ÿï¼Ÿ&#x3D;&#x3D;(I&#x2F;O Completion Port,I&#x2F;Oå®Œæˆç«¯å£) çº¿ç¨‹æ± ã€‚ã€‚ã€‚</li>\n<li>Linux ç³»ç»Ÿå¼‚æ­¥ IO åœ¨ ã€2.6 ç‰ˆæœ¬å¼•å…¥ï¼Œä½†å…¶åº•å±‚å®ç°è¿˜æ˜¯ç”¨å¤šè·¯å¤ç”¨æ¨¡æ‹Ÿäº†å¼‚æ­¥ IOï¼Œæ€§èƒ½æ²¡æœ‰ä¼˜åŠ¿ï¼Œä¸”å¼•å…¥ä¸å¿…è¦çš„å¤æ‚æ€§ã€‚ã€‘ Netty5åŸºäºæ­¤çš„APIä¹Ÿè¢«åºŸå¼ƒäº†ï¼Œç›®å‰æœ€æ–°å°±ç”¨Netty4ï¼</li>\n</ul></blockquote>\n<h4 id=\"æ–‡ä»¶-AIO\"><a href=\"#æ–‡ä»¶-AIO\" class=\"headerlink\" title=\"æ–‡ä»¶ AIO\"></a>æ–‡ä»¶ AIO</h4><p>å…ˆæ¥çœ‹çœ‹ AsynchronousFileChannel</p>\n<pre class=\"line-numbers language-java\" data-language=\"java\"><code class=\"language-java\">@Slf4j\npublic class AioDemo1 &#123;\n    public static void main(String[] args) throws IOException &#123;\n        try&#123;\n            AsynchronousFileChannel s &#x3D; \n                AsynchronousFileChannel.open(\n                \tPaths.get(&quot;1.txt&quot;), StandardOpenOption.READ);\n            ByteBuffer buffer &#x3D; ByteBuffer.allocate(2);\n            log.debug(&quot;begin...&quot;);\n            s.read(buffer, 0, null, new CompletionHandler&lt;Integer, ByteBuffer&gt;() &#123;\n                @Override\n                public void completed(Integer result, ByteBuffer attachment) &#123;\n                    log.debug(&quot;read completed...&#123;&#125;&quot;, result);\n                    buffer.flip();\n                    debug(buffer);\n                &#125;\n\n                @Override\n                public void failed(Throwable exc, ByteBuffer attachment) &#123;\n                    log.debug(&quot;read failed...&quot;);\n                &#125;\n            &#125;);\n\n        &#125; catch (IOException e) &#123;\n            e.printStackTrace();\n        &#125;\n        log.debug(&quot;do other things...&quot;);\n        System.in.read();&#x2F;&#x2F;\n    &#125;\n&#125;</code></pre>\n\n<p>è¾“å‡º</p>\n<pre class=\"line-numbers language-none\"><code class=\"language-none\">13:44:56 [DEBUG] [main] c.i.aio.AioDemo1 - begin...\n13:44:56 [DEBUG] [main] c.i.aio.AioDemo1 - do other things...\n13:44:56 [DEBUG] [Thread-5] c.i.aio.AioDemo1 - read completed...2\n         +-------------------------------------------------+\n         |  0  1  2  3  4  5  6  7  8  9  a  b  c  d  e  f |\n+--------+-------------------------------------------------+----------------+\n|00000000| 61 0d                                           |a.              |\n+--------+-------------------------------------------------+----------------+</code></pre>\n\n<p>å¯ä»¥çœ‹åˆ°</p>\n<ul>\n<li>å“åº”æ–‡ä»¶è¯»å–æˆåŠŸçš„æ˜¯å¦ä¸€ä¸ªçº¿ç¨‹ Thread-5</li>\n<li>ä¸»çº¿ç¨‹å¹¶æ²¡æœ‰ IO æ“ä½œé˜»å¡</li>\n</ul>\n<h4 id=\"ğŸ’¡-å®ˆæŠ¤çº¿ç¨‹\"><a href=\"#ğŸ’¡-å®ˆæŠ¤çº¿ç¨‹\" class=\"headerlink\" title=\"ğŸ’¡ å®ˆæŠ¤çº¿ç¨‹\"></a>ğŸ’¡ å®ˆæŠ¤çº¿ç¨‹</h4><p>&#x3D;&#x3D;&#x3D;é»˜è®¤æ–‡ä»¶ AIO ä½¿ç”¨çš„çº¿ç¨‹éƒ½æ˜¯å®ˆæŠ¤çº¿ç¨‹ï¼Œæ‰€ä»¥æœ€åè¦æ‰§è¡Œ <code>System.in.read()</code> ä»¥é¿å…å®ˆæŠ¤çº¿ç¨‹æ„å¤–ç»“æŸ&#x3D;&#x3D;</p>\n<h4 id=\"ç½‘ç»œ-AIO\"><a href=\"#ç½‘ç»œ-AIO\" class=\"headerlink\" title=\"ç½‘ç»œ AIO\"></a>ç½‘ç»œ AIO</h4><pre class=\"line-numbers language-java\" data-language=\"java\"><code class=\"language-java\">public class AioServer &#123;\n    public static void main(String[] args) throws IOException &#123;\n        AsynchronousServerSocketChannel ssc &#x3D; AsynchronousServerSocketChannel.open();\n        ssc.bind(new InetSocketAddress(8080));\n        ssc.accept(null, new AcceptHandler(ssc));\n        System.in.read();\n    &#125;\n\n    private static void closeChannel(AsynchronousSocketChannel sc) &#123;\n        try &#123;\n            System.out.printf(&quot;[%s] %s close\\n&quot;, Thread.currentThread().getName(), sc.getRemoteAddress());\n            sc.close();\n        &#125; catch (IOException e) &#123;\n            e.printStackTrace();\n        &#125;\n    &#125;\n\n    private static class ReadHandler implements CompletionHandler&lt;Integer, ByteBuffer&gt; &#123;\n        private final AsynchronousSocketChannel sc;\n\n        public ReadHandler(AsynchronousSocketChannel sc) &#123;\n            this.sc &#x3D; sc;\n        &#125;\n\n        @Override\n        public void completed(Integer result, ByteBuffer attachment) &#123;\n            try &#123;\n                if (result &#x3D;&#x3D; -1) &#123;\n                    closeChannel(sc);\n                    return;\n                &#125;\n                System.out.printf(&quot;[%s] %s read\\n&quot;, Thread.currentThread().getName(), sc.getRemoteAddress());\n                attachment.flip();\n                System.out.println(Charset.defaultCharset().decode(attachment));\n                attachment.clear();\n                &#x2F;&#x2F; å¤„ç†å®Œç¬¬ä¸€ä¸ª read æ—¶ï¼Œéœ€è¦å†æ¬¡è°ƒç”¨ read æ–¹æ³•æ¥å¤„ç†ä¸‹ä¸€ä¸ª read äº‹ä»¶\n                sc.read(attachment, attachment, this);\n            &#125; catch (IOException e) &#123;\n                e.printStackTrace();\n            &#125;\n        &#125;\n\n        @Override\n        public void failed(Throwable exc, ByteBuffer attachment) &#123;\n            closeChannel(sc);\n            exc.printStackTrace();\n        &#125;\n    &#125;\n\n    private static class WriteHandler implements CompletionHandler&lt;Integer, ByteBuffer&gt; &#123;\n        private final AsynchronousSocketChannel sc;\n\n        private WriteHandler(AsynchronousSocketChannel sc) &#123;\n            this.sc &#x3D; sc;\n        &#125;\n\n        @Override\n        public void completed(Integer result, ByteBuffer attachment) &#123;\n            &#x2F;&#x2F; å¦‚æœä½œä¸ºé™„ä»¶çš„ buffer è¿˜æœ‰å†…å®¹ï¼Œéœ€è¦å†æ¬¡ write å†™å‡ºå‰©ä½™å†…å®¹\n            if (attachment.hasRemaining()) &#123;\n                sc.write(attachment);\n            &#125;\n        &#125;\n\n        @Override\n        public void failed(Throwable exc, ByteBuffer attachment) &#123;\n            exc.printStackTrace();\n            closeChannel(sc);\n        &#125;\n    &#125;\n\n    private static class AcceptHandler implements CompletionHandler&lt;AsynchronousSocketChannel, Object&gt; &#123;\n        private final AsynchronousServerSocketChannel ssc;\n\n        public AcceptHandler(AsynchronousServerSocketChannel ssc) &#123;\n            this.ssc &#x3D; ssc;\n        &#125;\n\n        @Override\n        public void completed(AsynchronousSocketChannel sc, Object attachment) &#123;\n            try &#123;\n                System.out.printf(&quot;[%s] %s connected\\n&quot;, Thread.currentThread().getName(), sc.getRemoteAddress());\n            &#125; catch (IOException e) &#123;\n                e.printStackTrace();\n            &#125;\n            ByteBuffer buffer &#x3D; ByteBuffer.allocate(16);\n            &#x2F;&#x2F; è¯»äº‹ä»¶ç”± ReadHandler å¤„ç†\n            sc.read(buffer, buffer, new ReadHandler(sc));\n            &#x2F;&#x2F; å†™äº‹ä»¶ç”± WriteHandler å¤„ç†\n            sc.write(Charset.defaultCharset().encode(&quot;server hello!&quot;), ByteBuffer.allocate(16), new WriteHandler(sc));\n            &#x2F;&#x2F; å¤„ç†å®Œç¬¬ä¸€ä¸ª accpet æ—¶ï¼Œéœ€è¦å†æ¬¡è°ƒç”¨ accept æ–¹æ³•æ¥å¤„ç†ä¸‹ä¸€ä¸ª accept äº‹ä»¶\n            ssc.accept(null, this);\n        &#125;\n\n        @Override\n        public void failed(Throwable exc, Object attachment) &#123;\n            exc.printStackTrace();\n        &#125;\n    &#125;\n&#125;</code></pre>\n\n<h1 id=\"äºŒ-Netty-å…¥é—¨\"><a href=\"#äºŒ-Netty-å…¥é—¨\" class=\"headerlink\" title=\"äºŒ. Netty å…¥é—¨\"></a>äºŒ. Netty å…¥é—¨</h1><h2 id=\"1-æ¦‚è¿°\"><a href=\"#1-æ¦‚è¿°\" class=\"headerlink\" title=\"1. æ¦‚è¿°\"></a>1. æ¦‚è¿°</h2><h3 id=\"1-1-Netty-æ˜¯ä»€ä¹ˆï¼Ÿ\"><a href=\"#1-1-Netty-æ˜¯ä»€ä¹ˆï¼Ÿ\" class=\"headerlink\" title=\"1.1 Netty æ˜¯ä»€ä¹ˆï¼Ÿ\"></a>1.1 Netty æ˜¯ä»€ä¹ˆï¼Ÿ</h3><pre class=\"line-numbers language-none\"><code class=\"language-none\">Netty is an asynchronous event-driven network application framework\nfor rapid development of maintainable high performance protocol servers &amp; clients.</code></pre>\n\n<p>Netty æ˜¯ä¸€ä¸ª[è°ƒç”¨æ—¶]å¼‚æ­¥çš„[ç”¨å¤šçº¿ç¨‹å°†æ–¹æ³•è°ƒç”¨ä¸å¤„ç†ç»“æœç›¸åˆ†ç¦»]ã€åŸºäºäº‹ä»¶é©±åŠ¨[IOæ¨¡å‹è¿˜æ˜¯selectorå¤šè·¯å¤ç”¨]çš„ç½‘ç»œåº”ç”¨æ¡†æ¶ï¼Œç”¨äºå¿«é€Ÿå¼€å‘å¯ç»´æŠ¤ã€é«˜æ€§èƒ½çš„ç½‘ç»œæœåŠ¡å™¨å’Œå®¢æˆ·ç«¯</p>\n<h3 id=\"1-2-Netty-çš„ä½œè€…\"><a href=\"#1-2-Netty-çš„ä½œè€…\" class=\"headerlink\" title=\"1.2 Netty çš„ä½œè€…\"></a>1.2 Netty çš„ä½œè€…</h3><p><img src=\"http://cache.itzy8.top/%E5%AD%A6Netty-%E9%BB%91%E9%A9%AC%E6%BB%A1%E5%93%A5/0005.png\"></p>\n<p>ä»–è¿˜æ˜¯å¦ä¸€ä¸ªè‘—åç½‘ç»œåº”ç”¨æ¡†æ¶ Apache Mina çš„é‡è¦è´¡çŒ®è€…</p>\n<h3 id=\"1-3-Netty-çš„åœ°ä½\"><a href=\"#1-3-Netty-çš„åœ°ä½\" class=\"headerlink\" title=\"1.3 Netty çš„åœ°ä½\"></a>1.3 Netty çš„åœ°ä½</h3><p>Netty åœ¨ Java ç½‘ç»œåº”ç”¨æ¡†æ¶ä¸­çš„åœ°ä½å°±å¥½æ¯”ï¼šSpring æ¡†æ¶åœ¨ JavaEE å¼€å‘ä¸­çš„åœ°ä½</p>\n<p>ä»¥ä¸‹çš„æ¡†æ¶éƒ½ä½¿ç”¨äº† Nettyï¼Œå› ä¸ºå®ƒä»¬æœ‰ç½‘ç»œé€šä¿¡éœ€æ±‚ï¼</p>\n<ul>\n<li>Cassandra - nosql æ•°æ®åº“</li>\n<li>Spark - å¤§æ•°æ®åˆ†å¸ƒå¼[è®¡ç®—]æ¡†æ¶</li>\n<li>Hadoop - å¤§æ•°æ®åˆ†å¸ƒå¼[å­˜å‚¨]æ¡†æ¶</li>\n<li>RocketMQ - ali å¼€æºçš„æ¶ˆæ¯é˜Ÿåˆ—</li>\n<li>ElasticSearch - æœç´¢å¼•æ“</li>\n<li>gRPC - rpc æ¡†æ¶</li>\n<li>Dubbo - rpc æ¡†æ¶</li>\n<li>Spring 5.x - flux api (WebFlux) å®Œå…¨æŠ›å¼ƒäº† tomcat ï¼Œä½¿ç”¨ netty ä½œä¸ºæœåŠ¡å™¨ç«¯</li>\n<li>Zookeeper - åˆ†å¸ƒå¼åè°ƒæ¡†æ¶</li>\n</ul>\n<h3 id=\"1-4-Netty-çš„ä¼˜åŠ¿\"><a href=\"#1-4-Netty-çš„ä¼˜åŠ¿\" class=\"headerlink\" title=\"1.4 Netty çš„ä¼˜åŠ¿\"></a>1.4 Netty çš„ä¼˜åŠ¿</h3><ul>\n<li>Netty vs NIOï¼Œå·¥ä½œé‡å¤§ï¼Œbug å¤š<ul>\n<li>éœ€è¦è‡ªå·±æ„å»ºåè®®</li>\n<li>è§£å†³ TCP ä¼ è¾“é—®é¢˜ï¼Œå¦‚ç²˜åŒ…ã€åŠåŒ…</li>\n<li>epoll ç©ºè½®è¯¢å¯¼è‡´ CPU 100%</li>\n<li>å¯¹ API è¿›è¡Œå¢å¼ºï¼Œä½¿ä¹‹æ›´æ˜“ç”¨ï¼Œå¦‚ [FastThreadLocal] &#x3D;&gt; ThreadLocalï¼Œ[ByteBuf] &#x3D;&gt; ByteBuffer</li>\n</ul>\n</li>\n<li>Netty vs å…¶å®ƒç½‘ç»œåº”ç”¨æ¡†æ¶<ul>\n<li>Mina ç”± apache ç»´æŠ¤ï¼Œå°†æ¥ 3.x ç‰ˆæœ¬å¯èƒ½ä¼šæœ‰è¾ƒå¤§é‡æ„ï¼Œç ´å API å‘ä¸‹å…¼å®¹æ€§ï¼ŒNetty çš„å¼€å‘è¿­ä»£æ›´è¿…é€Ÿï¼ŒAPI æ›´ç®€æ´ã€æ–‡æ¡£æ›´ä¼˜ç§€</li>\n<li>ä¹…ç»è€ƒéªŒï¼Œ16å¹´ï¼ŒNetty ç‰ˆæœ¬<ul>\n<li>2.x 2004</li>\n<li>3.x 2008</li>\n<li>4.x 2013</li>\n<li>5.x å·²åºŸå¼ƒï¼ˆæ²¡æœ‰æ˜æ˜¾çš„æ€§èƒ½æå‡ï¼Œç»´æŠ¤æˆæœ¬é«˜ï¼‰</li>\n</ul>\n</li>\n</ul>\n</li>\n</ul>\n<h2 id=\"2-Hello-World\"><a href=\"#2-Hello-World\" class=\"headerlink\" title=\"2. Hello World\"></a>2. Hello World</h2><h3 id=\"2-1-ç›®æ ‡\"><a href=\"#2-1-ç›®æ ‡\" class=\"headerlink\" title=\"2.1 ç›®æ ‡\"></a>2.1 ç›®æ ‡</h3><p>å¼€å‘ä¸€ä¸ªç®€å•çš„æœåŠ¡å™¨ç«¯å’Œå®¢æˆ·ç«¯</p>\n<ul>\n<li>å®¢æˆ·ç«¯å‘æœåŠ¡å™¨ç«¯å‘é€ hello, world</li>\n<li>æœåŠ¡å™¨ä»…æ¥æ”¶ï¼Œä¸è¿”å›</li>\n</ul>\n<p>åŠ å…¥ä¾èµ–</p>\n<pre class=\"line-numbers language-markup\" data-language=\"markup\"><code class=\"language-markup\">&lt;dependency&gt;\n    &lt;groupId&gt;io.netty&lt;&#x2F;groupId&gt;\n    &lt;artifactId&gt;netty-all&lt;&#x2F;artifactId&gt;\n    &lt;version&gt;4.1.39.Final&lt;&#x2F;version&gt;\n&lt;&#x2F;dependency&gt;</code></pre>\n\n\n\n\n\n<h3 id=\"2-2-æœåŠ¡å™¨ç«¯\"><a href=\"#2-2-æœåŠ¡å™¨ç«¯\" class=\"headerlink\" title=\"2.2 æœåŠ¡å™¨ç«¯\"></a>2.2 æœåŠ¡å™¨ç«¯</h3><pre class=\"line-numbers language-java\" data-language=\"java\"><code class=\"language-java\">new ServerBootstrap()\n    .group(new NioEventLoopGroup()) &#x2F;&#x2F; 1\n    .channel(NioServerSocketChannel.class) &#x2F;&#x2F; 2\n    .childHandler(new ChannelInitializer&lt;NioSocketChannel&gt;() &#123; &#x2F;&#x2F; 3\n        protected void initChannel(NioSocketChannel ch) &#123;\n            ch.pipeline().addLast(new StringDecoder()); &#x2F;&#x2F; 5\n            ch.pipeline().addLast(new SimpleChannelInboundHandler&lt;String&gt;() &#123; &#x2F;&#x2F; 6\n                @Override\n                protected void channelRead0(ChannelHandlerContext ctx, String msg) &#123;\n                    System.out.println(msg);\n                &#125;\n            &#125;);\n        &#125;\n    &#125;)\n    .bind(8080); &#x2F;&#x2F; 4</code></pre>\n\n<p>ä»£ç è§£è¯»</p>\n<ul>\n<li><p>1 å¤„ï¼Œåˆ›å»º NioEventLoopGroupï¼Œå¯ä»¥ç®€å•ç†è§£ä¸º <code>çº¿ç¨‹æ±  + Selector</code> åé¢ä¼šè¯¦ç»†å±•å¼€</p>\n</li>\n<li><p>2 å¤„ï¼Œé€‰æ‹©æœåŠ¡ Scoket å®ç°ç±»ï¼Œå…¶ä¸­ NioServerSocketChannel è¡¨ç¤ºåŸºäº NIO çš„æœåŠ¡å™¨ç«¯å®ç°ï¼Œå…¶å®ƒå®ç°è¿˜æœ‰</p>\n<p><img src=\"http://cache.itzy8.top/%E5%AD%A6Netty-%E9%BB%91%E9%A9%AC%E6%BB%A1%E5%93%A5/0006.png\"></p>\n</li>\n<li><p>3 å¤„ï¼Œä¸ºå•¥æ–¹æ³•å« childHandlerï¼Œæ˜¯æ¥ä¸‹æ¥æ·»åŠ çš„å¤„ç†å™¨éƒ½æ˜¯ç»™ SocketChannel ç”¨çš„ï¼Œè€Œä¸æ˜¯ç»™ ServerSocketChannelã€‚ChannelInitializer å¤„ç†å™¨ï¼ˆä»…æ‰§è¡Œä¸€æ¬¡ï¼‰ï¼Œå®ƒçš„ä½œç”¨æ˜¯å¾…å®¢æˆ·ç«¯ SocketChannel å»ºç«‹è¿æ¥åï¼Œæ‰§è¡Œ initChannel ä»¥ä¾¿æ·»åŠ æ›´å¤šçš„å¤„ç†å™¨</p>\n</li>\n<li><p>4 å¤„ï¼ŒServerSocketChannel ç»‘å®šçš„ç›‘å¬ç«¯å£</p>\n</li>\n<li><p>5 å¤„ï¼ŒSocketChannel çš„å¤„ç†å™¨ï¼Œè§£ç  ByteBuf &#x3D;&gt; String</p>\n</li>\n<li><p>6 å¤„ï¼ŒSocketChannel çš„ä¸šåŠ¡å¤„ç†å™¨ï¼Œä½¿ç”¨ä¸Šä¸€ä¸ªå¤„ç†å™¨çš„å¤„ç†ç»“æœ</p>\n</li>\n</ul>\n<h3 id=\"2-3-å®¢æˆ·ç«¯\"><a href=\"#2-3-å®¢æˆ·ç«¯\" class=\"headerlink\" title=\"2.3 å®¢æˆ·ç«¯\"></a>2.3 å®¢æˆ·ç«¯</h3><pre class=\"line-numbers language-java\" data-language=\"java\"><code class=\"language-java\">new Bootstrap()\n    .group(new NioEventLoopGroup()) &#x2F;&#x2F; 1\n    .channel(NioSocketChannel.class) &#x2F;&#x2F; 2\n    .handler(new ChannelInitializer&lt;Channel&gt;() &#123; &#x2F;&#x2F; 3\n        @Override\n        protected void initChannel(Channel ch) &#123;\n            ch.pipeline().addLast(new StringEncoder()); &#x2F;&#x2F; 8\n        &#125;\n    &#125;)\n    .connect(&quot;127.0.0.1&quot;, 8080) &#x2F;&#x2F; 4\n    .sync() &#x2F;&#x2F; 5\n    .channel() &#x2F;&#x2F; 6\n    .writeAndFlush(new Date() + &quot;: hello world!&quot;); &#x2F;&#x2F; 7</code></pre>\n\n<p>ä»£ç è§£è¯»</p>\n<ul>\n<li><p>1 å¤„ï¼Œåˆ›å»º NioEventLoopGroupï¼ŒåŒ Server</p>\n</li>\n<li><p>2 å¤„ï¼Œé€‰æ‹©å®¢æˆ· Socket å®ç°ç±»ï¼ŒNioSocketChannel è¡¨ç¤ºåŸºäº NIO çš„å®¢æˆ·ç«¯å®ç°ï¼Œå…¶å®ƒå®ç°è¿˜æœ‰</p>\n<p><img src=\"http://cache.itzy8.top/%E5%AD%A6Netty-%E9%BB%91%E9%A9%AC%E6%BB%A1%E5%93%A5/0007.png\"></p>\n</li>\n<li><p>3 å¤„ï¼Œæ·»åŠ  SocketChannel çš„å¤„ç†å™¨ï¼ŒChannelInitializer å¤„ç†å™¨ï¼ˆä»…æ‰§è¡Œä¸€æ¬¡ï¼‰ï¼Œå®ƒçš„ä½œç”¨æ˜¯å¾…å®¢æˆ·ç«¯ SocketChannel å»ºç«‹è¿æ¥åï¼Œæ‰§è¡Œ initChannel ä»¥ä¾¿æ·»åŠ æ›´å¤šçš„å¤„ç†å™¨</p>\n</li>\n<li><p>4 å¤„ï¼ŒæŒ‡å®šè¦è¿æ¥çš„æœåŠ¡å™¨å’Œç«¯å£</p>\n</li>\n<li><p>5 å¤„ï¼ŒNetty ä¸­å¾ˆå¤šæ–¹æ³•éƒ½æ˜¯å¼‚æ­¥çš„ï¼Œå¦‚ connectï¼Œè¿™æ—¶éœ€è¦ä½¿ç”¨ sync æ–¹æ³•ç­‰å¾… connect å»ºç«‹è¿æ¥å®Œæ¯•</p>\n</li>\n<li><p>6 å¤„ï¼Œè·å– channel å¯¹è±¡ï¼Œå®ƒå³ä¸ºé€šé“æŠ½è±¡ï¼Œå¯ä»¥è¿›è¡Œæ•°æ®è¯»å†™æ“ä½œ</p>\n</li>\n<li><p>7 å¤„ï¼Œå†™å…¥æ¶ˆæ¯å¹¶æ¸…ç©ºç¼“å†²åŒº</p>\n</li>\n<li><p>8 å¤„ï¼Œæ¶ˆæ¯ä¼šç»è¿‡é€šé“ handler å¤„ç†ï¼Œè¿™é‡Œæ˜¯å°† String &#x3D;&gt; ByteBuf å‘å‡º</p>\n</li>\n<li><p>æ•°æ®ç»è¿‡ç½‘ç»œä¼ è¾“ï¼Œåˆ°è¾¾æœåŠ¡å™¨ç«¯ï¼ŒæœåŠ¡å™¨ç«¯ 5 å’Œ 6 å¤„çš„ handler å…ˆåè¢«è§¦å‘ï¼Œèµ°å®Œä¸€ä¸ªæµç¨‹</p>\n</li>\n</ul>\n<h3 id=\"2-4-æµç¨‹æ¢³ç†\"><a href=\"#2-4-æµç¨‹æ¢³ç†\" class=\"headerlink\" title=\"2.4 æµç¨‹æ¢³ç†\"></a>2.4 æµç¨‹æ¢³ç†</h3><p><img src=\"http://cache.itzy8.top/%E5%AD%A6Netty-%E9%BB%91%E9%A9%AC%E6%BB%A1%E5%93%A5/0040.png\"></p>\n<p>filterã€interceptorã€handler\tè´£ä»»é“¾</p>\n<h4 id=\"ğŸ’¡-æç¤º\"><a href=\"#ğŸ’¡-æç¤º\" class=\"headerlink\" title=\"ğŸ’¡ æç¤º\"></a>ğŸ’¡ æç¤º</h4><blockquote><span class=\"custom-blockquote-svg\"><svg width=\"24\" height=\"24\" viewBox=\"0 0 24 24\" fill=\"\" xmlns=\"http://www.w3.org/2000/svg\" data-reactroot=\"\">\n<path fill=\"\" d=\"M22 12C22 6.5 17.5 2 12 2C6.5 2 2 6.5 2 12C2 17.5 6.5 22 12 22C13.8 22 15.5 21.5 17 20.6L22 22L20.7 17C21.5 15.5 22 13.8 22 12Z\" undefined=\"1\"></path>\n<path fill=\"\" d=\"M15.97 11.5H16.04C17.12 11.5 18 12.38 18 13.47V13.53C18 14.62 17.12 15.5 16.03 15.5H15.96C14.88 15.5 14 14.62 14 13.53V13.46C14 12.38 14.88 11.5 15.97 11.5Z\" undefined=\"1\"></path>\n<path fill=\"\" d=\"M7.97 11.5H8.04C9.12 11.5 10 12.38 10 13.47V13.53C10 14.62 9.12 15.5 8.03 15.5H7.97C6.88 15.5 6 14.62 6 13.53V13.46C6 12.38 6.88 11.5 7.97 11.5Z\" undefined=\"1\"></path>\n<path stroke-linejoin=\"round\" stroke-linecap=\"round\" stroke-miterlimit=\"10\" stroke-width=\"2\" stroke=\"\" d=\"M17 8.5C15.23 8.97 14.07 10.84 14.01 13.27C14 13.33 14 13.4 14 13.47V13.5\"></path>\n<path stroke-linejoin=\"round\" stroke-linecap=\"round\" stroke-miterlimit=\"10\" stroke-width=\"2\" stroke=\"\" d=\"M9 8.5C7.23 8.97 6.07 10.84 6.01 13.27C6 13.33 6 13.4 6 13.47V13.5\"></path>\n<path stroke-linejoin=\"round\" stroke-linecap=\"round\" stroke-miterlimit=\"10\" stroke-width=\"2\" stroke=\"\" d=\"M15.97 11.5H16.04C17.12 11.5 18 12.38 18 13.47V13.53C18 14.62 17.12 15.5 16.03 15.5H15.96C14.88 15.5 14 14.62 14 13.53V13.46C14 12.38 14.88 11.5 15.97 11.5Z\"></path>\n<path stroke-linejoin=\"round\" stroke-linecap=\"round\" stroke-miterlimit=\"10\" stroke-width=\"2\" stroke=\"\" d=\"M7.97 11.5H8.04C9.12 11.5 10 12.38 10 13.47V13.53C10 14.62 9.12 15.5 8.03 15.5H7.97C6.88 15.5 6 14.62 6 13.53V13.46C6 12.38 6.88 11.5 7.97 11.5Z\"></path>\n</svg>\n</span><p>ä¸€å¼€å§‹éœ€è¦æ ‘ç«‹æ­£ç¡®çš„è§‚å¿µ</p>\n<ul>\n<li>æŠŠ channel ç†è§£ä¸ºæ•°æ®çš„é€šé“</li>\n<li>æŠŠ msg ç†è§£ä¸ºæµåŠ¨çš„æ•°æ®ï¼Œæœ€å¼€å§‹è¾“å…¥æ˜¯ ByteBufï¼Œä½†ç»è¿‡ pipeline çš„åŠ å·¥ï¼Œä¼šå˜æˆå…¶å®ƒç±»å‹å¯¹è±¡ï¼Œæœ€åè¾“å‡ºåˆå˜æˆ ByteBuf</li>\n<li>æŠŠ handler ç†è§£ä¸ºæ•°æ®çš„å¤„ç†å·¥åº<ul>\n<li>å·¥åºæœ‰å¤šé“ï¼Œåˆåœ¨ä¸€èµ·å°±æ˜¯ pipelineï¼Œ<strong>pipeline è´Ÿè´£å‘å¸ƒäº‹ä»¶ï¼ˆè¯»ã€è¯»å–å®Œæˆâ€¦ï¼‰ä¼ æ’­ç»™æ¯ä¸ª handlerï¼Œ handler å¯¹è‡ªå·±æ„Ÿå…´è¶£çš„äº‹ä»¶è¿›è¡Œå¤„ç†ï¼ˆé‡å†™</strong>äº†ç›¸åº”äº‹ä»¶å¤„ç†æ–¹æ³•ï¼‰</li>\n<li>handler åˆ† Inbound (-&gt;mem)å’Œ Outbound (-&gt;C)ä¸¤ç±»</li>\n</ul>\n</li>\n<li>æŠŠ eventLoop ç†è§£ä¸ºå¤„ç†æ•°æ®çš„<strong>å·¥äºº</strong>ã€å•thæ± ã€‘<ul>\n<li><strong>å·¥äººå¯ä»¥ç®¡ç†å¤šä¸ª channel çš„ io æ“ä½œï¼Œå¹¶ä¸”ä¸€æ—¦å·¥äººè´Ÿè´£äº†æŸä¸ª channelï¼Œå°±è¦è´Ÿè´£åˆ°åº•ï¼ˆç»‘å®š</strong>ï¼šTHå®‰å…¨ï¼‰</li>\n<li>å·¥äººæ—¢å¯ä»¥æ‰§è¡Œ <strong>io æ“ä½œ</strong>ï¼Œä¹Ÿå¯ä»¥è¿›è¡Œ<strong>ä»»åŠ¡å¤„ç†ï¼Œæ¯ä½å·¥äººæœ‰ä»»åŠ¡é˜Ÿåˆ—ï¼Œé˜Ÿåˆ—é‡Œå¯ä»¥å †æ”¾å¤šä¸ª channel çš„å¾…å¤„ç†ä»»åŠ¡ï¼Œä»»åŠ¡åˆ†ä¸ºæ™®é€šä»»åŠ¡ã€å®šæ—¶ä»»åŠ¡</strong></li>\n<li>å·¥äººæŒ‰ç…§ pipeline é¡ºåºï¼Œä¾æ¬¡æŒ‰ç…§ handler çš„è§„åˆ’ï¼ˆä»£ç ï¼‰å¤„ç†æ•°æ®ï¼Œå¯ä»¥<strong>ä¸ºæ¯é“å·¥åºï¼ˆéIOæ“ä½œçš„ä»»åŠ¡ï¼‰æŒ‡å®šä¸åŒçš„å·¥äºº</strong></li>\n</ul>\n</li>\n</ul></blockquote>\n<h2 id=\"3-ç»„ä»¶\"><a href=\"#3-ç»„ä»¶\" class=\"headerlink\" title=\"3. ç»„ä»¶\"></a>3. ç»„ä»¶</h2><h3 id=\"3-1-EventLoop-x3D-åŒ…è£…çš„Selector\"><a href=\"#3-1-EventLoop-x3D-åŒ…è£…çš„Selector\" class=\"headerlink\" title=\"3.1 EventLoop&#x3D;åŒ…è£…çš„Selector\"></a>3.1 EventLoop&#x3D;åŒ…è£…çš„Selector</h3><p>äº‹ä»¶å¾ªç¯å¯¹è±¡</p>\n<p>EventLoop æœ¬è´¨æ˜¯ä¸€ä¸ª&#x3D;&#x3D;å•çº¿ç¨‹æ‰§è¡Œå™¨[ä»»åŠ¡é˜Ÿåˆ—]ï¼ˆåŒæ—¶ç»´æŠ¤äº†ä¸€ä¸ª Selectorï¼‰ï¼Œé‡Œé¢æœ‰ run æ–¹æ³•å¤„ç† Channel ä¸Šæºæºä¸æ–­çš„ ã€ioã€‘ äº‹ä»¶ã€‚&#x3D;&#x3D;</p>\n<p>å®ƒçš„ç»§æ‰¿å…³ç³»æ¯”è¾ƒå¤æ‚</p>\n<ul>\n<li>ä¸€æ¡çº¿æ˜¯ç»§æ‰¿è‡ª j.u.c.ScheduledExecutorService å› æ­¤åŒ…å«äº†çº¿ç¨‹æ± ä¸­æ‰€æœ‰çš„æ–¹æ³•</li>\n<li>å¦ä¸€æ¡çº¿æ˜¯ç»§æ‰¿è‡ª netty è‡ªå·±çš„ OrderedEventExecutorï¼Œã€ä¿è¯ io é¡ºåºã€‘<ul>\n<li>æä¾›äº† boolean inEventLoop(Thread thread) æ–¹æ³•ã€åˆ¤æ–­ä¸€ä¸ªçº¿ç¨‹æ˜¯å¦å±äºæ­¤ EventLoopã€‘</li>\n<li>æä¾›äº† parent æ–¹æ³•æ¥çœ‹çœ‹ã€è‡ªå·±å±äºå“ªä¸ª EventLoopGroupã€‘</li>\n</ul>\n</li>\n</ul>\n<p>äº‹ä»¶å¾ªç¯ç»„</p>\n<p>EventLoopGroup æ˜¯ä¸€ç»„ EventLoopï¼Œ&#x3D;&#x3D;ã€Channel ä¸€èˆ¬ä¼šè°ƒç”¨ EventLoopGroup çš„ register æ–¹æ³•æ¥ç»‘å®šå…¶ä¸­ä¸€ä¸ª EventLoopï¼Œåç»­è¿™ä¸ª Channel ä¸Šçš„ io äº‹ä»¶éƒ½ç”±æ­¤ EventLoop æ¥å¤„ç†ï¼ˆä¿è¯äº† io äº‹ä»¶å¤„ç†æ—¶çš„çº¿ç¨‹å®‰å…¨ï¼‰ã€‘&#x3D;&#x3D;</p>\n<ul>\n<li>ç»§æ‰¿è‡ª netty è‡ªå·±çš„ EventExecutorGroup<ul>\n<li>å®ç°äº† Iterable æ¥å£æä¾›éå† EventLoop çš„èƒ½åŠ›</li>\n<li>å¦æœ‰ next æ–¹æ³•è·å–é›†åˆä¸­ä¸‹ä¸€ä¸ª EventLoop</li>\n</ul>\n</li>\n</ul>\n<p>ä»¥ä¸€ä¸ªç®€å•çš„å®ç°ä¸ºä¾‹ï¼š</p>\n<pre class=\"line-numbers language-java\" data-language=\"java\"><code class=\"language-java\">&#x2F;&#x2F; å†…éƒ¨åˆ›å»ºäº†ä¸¤ä¸ª EventLoop, æ¯ä¸ª EventLoop ç»´æŠ¤ä¸€ä¸ªçº¿ç¨‹\nDefaultEventLoopGroup group &#x3D; new DefaultEventLoopGroup(2);\nSystem.out.println(group.next());\nSystem.out.println(group.next());\nSystem.out.println(group.next());</code></pre>\n\n<p>è¾“å‡º</p>\n<pre class=\"line-numbers language-none\"><code class=\"language-none\">io.netty.channel.DefaultEventLoop@60f82f98\nio.netty.channel.DefaultEventLoop@35f983a6\nio.netty.channel.DefaultEventLoop@60f82f98</code></pre>\n\n<p>ä¹Ÿå¯ä»¥ä½¿ç”¨ for å¾ªç¯</p>\n<pre class=\"line-numbers language-java\" data-language=\"java\"><code class=\"language-java\">DefaultEventLoopGroup group &#x3D; new DefaultEventLoopGroup(2);\nfor (EventExecutor eventLoop : group) &#123;\n    System.out.println(eventLoop);\n&#125;</code></pre>\n\n<p>è¾“å‡º</p>\n<pre class=\"line-numbers language-none\"><code class=\"language-none\">io.netty.channel.DefaultEventLoop@60f82f98\nio.netty.channel.DefaultEventLoop@35f983a6</code></pre>\n\n\n\n<pre class=\"line-numbers language-none\"><code class=\"language-none\">private static final int DEFAULT_EVENT_LOOP_THREADS &#x3D; Math.max(1, SystemPropertyUtil.getInt(&quot;io.netty.eventLoopThreads&quot;, NettyRuntime.availableProcessors() * 2));&#x2F;&#x2F;é»˜è®¤çº¿ç¨‹æ•°ï¼šé…ç½®ï¼Œ2å€æ ¸æ•°ï¼Œ0-&gt;1</code></pre>\n\n\n\n<h4 id=\"æ¼”ç¤º-NioEventLoop-å¤„ç†-io-äº‹ä»¶\"><a href=\"#æ¼”ç¤º-NioEventLoop-å¤„ç†-io-äº‹ä»¶\" class=\"headerlink\" title=\"æ¼”ç¤º NioEventLoop å¤„ç† io äº‹ä»¶\"></a>æ¼”ç¤º NioEventLoop å¤„ç† io äº‹ä»¶</h4><p>æœåŠ¡å™¨ç«¯ä¸¤ä¸ª nio worker å·¥äºº\tnetty.c3.EventLoopServer</p>\n<pre class=\"line-numbers language-java\" data-language=\"java\"><code class=\"language-java\">new ServerBootstrap()\n    .group(new NioEventLoopGroup(1), new NioEventLoopGroup(2))\n    .channel(NioServerSocketChannel.class)\n    .childHandler(new ChannelInitializer&lt;NioSocketChannel&gt;() &#123;\n        @Override\n        protected void initChannel(NioSocketChannel ch) &#123;\n            ch.pipeline().addLast(new ChannelInboundHandlerAdapter() &#123;\n                @Override\n                public void channelRead(ChannelHandlerContext ctx, Object msg) &#123;\n                    ByteBuf byteBuf &#x3D; msg instanceof ByteBuf ? ((ByteBuf) msg) : null;\n                    if (byteBuf !&#x3D; null) &#123;\n                        byte[] buf &#x3D; new byte[16];\n                        ByteBuf len &#x3D; byteBuf.readBytes(buf, 0, byteBuf.readableBytes());\n                        log.debug(new String(buf));\n                    &#125;\n                &#125;\n            &#125;);\n        &#125;\n    &#125;).bind(8080).sync();</code></pre>\n\n<p><img src=\"http://cache.itzy8.top/%E5%AD%A6Netty-%E9%BB%91%E9%A9%AC%E6%BB%A1%E5%93%A5/image-20220425225312737.png\" alt=\"image-20220425225312737\"></p>\n<p><img src=\"http://cache.itzy8.top/%E5%AD%A6Netty-%E9%BB%91%E9%A9%AC%E6%BB%A1%E5%93%A5/image-20220425225832275.png\" alt=\"image-20220425225832275\"></p>\n<p>EventLoopClient</p>\n<p>å®¢æˆ·ç«¯ï¼Œå¯åŠ¨ä¸‰æ¬¡ï¼Œåˆ†åˆ«ä¿®æ”¹å‘é€å­—ç¬¦ä¸²ä¸º zhangsanï¼ˆç¬¬ä¸€æ¬¡ï¼‰ï¼Œlisiï¼ˆç¬¬äºŒæ¬¡ï¼‰ï¼Œwangwuï¼ˆç¬¬ä¸‰æ¬¡ï¼‰</p>\n<pre class=\"line-numbers language-java\" data-language=\"java\"><code class=\"language-java\">public static void main(String[] args) throws InterruptedException &#123;\n    Channel channel &#x3D; new Bootstrap()\n            .group(new NioEventLoopGroup(1))\n            .handler(new ChannelInitializer&lt;NioSocketChannel&gt;() &#123;\n                @Override\n                protected void initChannel(NioSocketChannel ch) throws Exception &#123;\n                    System.out.println(&quot;init...&quot;);\n                    ch.pipeline().addLast(new LoggingHandler(LogLevel.DEBUG));\n                &#125;\n            &#125;)\n            .channel(NioSocketChannel.class).connect(&quot;localhost&quot;, 8080)\n            .sync()\n            .channel();\n\n    channel.writeAndFlush(ByteBufAllocator.DEFAULT.buffer().writeBytes(&quot;wangwu&quot;.getBytes()));\n    Thread.sleep(2000);\n    channel.writeAndFlush(ByteBufAllocator.DEFAULT.buffer().writeBytes(&quot;wangwu&quot;.getBytes()));</code></pre>\n\n<p>æœ€åè¾“å‡º</p>\n<pre class=\"line-numbers language-none\"><code class=\"language-none\">22:03:34 [DEBUG] [nioEventLoopGroup-3-1] c.i.o.EventLoopTest - zhangsan       \n22:03:36 [DEBUG] [nioEventLoopGroup-3-1] c.i.o.EventLoopTest - zhangsan       \n22:05:36 [DEBUG] [nioEventLoopGroup-3-2] c.i.o.EventLoopTest - lisi           \n22:05:38 [DEBUG] [nioEventLoopGroup-3-2] c.i.o.EventLoopTest - lisi           \n22:06:09 [DEBUG] [nioEventLoopGroup-3-1] c.i.o.EventLoopTest - wangwu        \n22:06:11 [DEBUG] [nioEventLoopGroup-3-1] c.i.o.EventLoopTest - wangwu         </code></pre>\n\n<p>å¯ä»¥çœ‹åˆ°ä¸¤ä¸ªEventLoopå·¥äººè½®æµå¤„ç† channelï¼Œä½†å·¥äººä¸ channel ä¹‹é—´è¿›è¡Œäº†ç»‘å®š</p>\n<p><img src=\"http://cache.itzy8.top/%E5%AD%A6Netty-%E9%BB%91%E9%A9%AC%E6%BB%A1%E5%93%A5/0042.png\"></p>\n<p>handlerâ€¦</p>\n<p>å†å¢åŠ ä¸¤ä¸ªé nio å·¥äºº\tEventLoopServer</p>\n<pre class=\"line-numbers language-java\" data-language=\"java\"><code class=\"language-java\">DefaultEventLoopGroup normalWorkers &#x3D; new DefaultEventLoopGroup(2);&#x2F;&#x2F;énio\nnew ServerBootstrap()\n    .group(new NioEventLoopGroup(1), new NioEventLoopGroup(2))&#x2F;&#x2F;\n    .channel(NioServerSocketChannel.class)\n    .childHandler(new ChannelInitializer&lt;NioSocketChannel&gt;() &#123;\n        @Override\n        protected void initChannel(NioSocketChannel ch)  &#123;\n            ch.pipeline().addLast(new LoggingHandler(LogLevel.DEBUG));&#x2F;&#x2F;\n            ch.pipeline().addLast(normalWorkers,&quot;myhandler&quot;,\n              new ChannelInboundHandlerAdapter() &#123;&#x2F;&#x2F;\n                @Override\n                public void channelRead(ChannelHandlerContext ctx, Object msg) &#123;\n                    ByteBuf byteBuf &#x3D; msg instanceof ByteBuf ? ((ByteBuf) msg) : null;\n                    if (byteBuf !&#x3D; null) &#123;\n                        byte[] buf &#x3D; new byte[16];\n                        ByteBuf len &#x3D; byteBuf.readBytes(buf, 0, byteBuf.readableBytes());\n                        log.debug(new String(buf));\n                    &#125;\n                &#125;\n            &#125;);\n        &#125;\n    &#125;).bind(8080).sync();\n\n\n\n\n\n\n\npackage cn.itcast.netty.c3;\n\nimport io.netty.bootstrap.ServerBootstrap;\nimport io.netty.buffer.ByteBuf;\nimport io.netty.channel.*;\nimport io.netty.channel.nio.NioEventLoopGroup;\nimport io.netty.channel.socket.nio.NioServerSocketChannel;\nimport io.netty.channel.socket.nio.NioSocketChannel;\nimport lombok.extern.slf4j.Slf4j;\n\nimport java.nio.charset.Charset;\n\n@Slf4j\npublic class EventLoopServer &#123;\n    public static void main(String[] args) &#123;\n        &#x2F;&#x2F; ç»†åˆ†2ï¼šåˆ›å»ºä¸€ä¸ªç‹¬ç«‹çš„ EventLoopGroup\n        EventLoopGroup group &#x3D; new DefaultEventLoopGroup();\n        new ServerBootstrap()\n                &#x2F;&#x2F; boss å’Œ worker\n                &#x2F;&#x2F; ç»†åˆ†1ï¼šboss åªè´Ÿè´£ ServerSocketChannel ä¸Š accept äº‹ä»¶     worker åªè´Ÿè´£ socketChannel ä¸Šçš„è¯»å†™\n                .group(new NioEventLoopGroup(), new NioEventLoopGroup(2))&#x2F;&#x2F;é»˜è®¤2*CPUs\n                .channel(NioServerSocketChannel.class)&#x2F;&#x2F;only one!\n                .childHandler(new ChannelInitializer&lt;NioSocketChannel&gt;() &#123;\n                    @Override\n                    protected void initChannel(NioSocketChannel ch) throws Exception &#123;\n                        ch.pipeline().addLast(&quot;handler1&quot;, new ChannelInboundHandlerAdapter() &#123;&#x2F;&#x2F;ioäº‹ä»¶\n                            @Override                                         &#x2F;&#x2F; ByteBuf\n                            public void channelRead(ChannelHandlerContext ctx, Object msg) throws Exception &#123;\n                                ByteBuf buf &#x3D; (ByteBuf) msg;\n                                log.debug(buf.toString(Charset.defaultCharset()));\n                                ctx.fireChannelRead(msg); &#x2F;&#x2F; è®©æ¶ˆæ¯ä¼ é€’ç»™ä¸‹ä¸€ä¸ªhandlerï¼\n                            &#125;\n                        &#125;);\n                        &#x2F;*.addLast(group, &quot;handler2&quot;, new ChannelInboundHandlerAdapter() &#123;&#x2F;&#x2F;æ™®é€šä»»åŠ¡\n                            @Override                                         &#x2F;&#x2F; ByteBuf\n                            public void channelRead(ChannelHandlerContext ctx, Object msg) throws Exception &#123;\n                                ByteBuf buf &#x3D; (ByteBuf) msg;\n                                log.debug(buf.toString(Charset.defaultCharset()));\n                            &#125;\n                        &#125;);*&#x2F;\n                    &#125;\n                &#125;)\n                .bind(8080);\n    &#125;\n&#125;\n</code></pre>\n\n<p>å®¢æˆ·ç«¯ä»£ç ä¸å˜ï¼Œå¯åŠ¨ä¸‰æ¬¡ï¼Œåˆ†åˆ«ä¿®æ”¹å‘é€å­—ç¬¦ä¸²ä¸º zhangsanï¼ˆç¬¬ä¸€æ¬¡ï¼‰ï¼Œlisiï¼ˆç¬¬äºŒæ¬¡ï¼‰ï¼Œwangwuï¼ˆç¬¬ä¸‰æ¬¡ï¼‰</p>\n<p>è¾“å‡º</p>\n<pre class=\"line-numbers language-none\"><code class=\"language-none\">22:19:48 [DEBUG] [nioEventLoopGroup-4-1] i.n.h.l.LoggingHandler - [id: 0x251562d5, L:&#x2F;127.0.0.1:8080 - R:&#x2F;127.0.0.1:52588] REGISTERED\n22:19:48 [DEBUG] [nioEventLoopGroup-4-1] i.n.h.l.LoggingHandler - [id: 0x251562d5, L:&#x2F;127.0.0.1:8080 - R:&#x2F;127.0.0.1:52588] ACTIVE\n22:19:48 [DEBUG] [nioEventLoopGroup-4-1] i.n.h.l.LoggingHandler - [id: 0x251562d5, L:&#x2F;127.0.0.1:8080 - R:&#x2F;127.0.0.1:52588] READ: 8B\n         +-------------------------------------------------+\n         |  0  1  2  3  4  5  6  7  8  9  a  b  c  d  e  f |\n+--------+-------------------------------------------------+----------------+\n|00000000| 7a 68 61 6e 67 73 61 6e                         |zhangsan        |\n+--------+-------------------------------------------------+----------------+\n22:19:48 [DEBUG] [nioEventLoopGroup-4-1] i.n.h.l.LoggingHandler - [id: 0x251562d5, L:&#x2F;127.0.0.1:8080 - R:&#x2F;127.0.0.1:52588] READ COMPLETE\n22:19:48 [DEBUG] [defaultEventLoopGroup-2-1] c.i.o.EventLoopTest - zhangsan        \n22:19:50 [DEBUG] [nioEventLoopGroup-4-1] i.n.h.l.LoggingHandler - [id: 0x251562d5, L:&#x2F;127.0.0.1:8080 - R:&#x2F;127.0.0.1:52588] READ: 8B\n         +-------------------------------------------------+\n         |  0  1  2  3  4  5  6  7  8  9  a  b  c  d  e  f |\n+--------+-------------------------------------------------+----------------+\n|00000000| 7a 68 61 6e 67 73 61 6e                         |zhangsan        |\n+--------+-------------------------------------------------+----------------+\n22:19:50 [DEBUG] [nioEventLoopGroup-4-1] i.n.h.l.LoggingHandler - [id: 0x251562d5, L:&#x2F;127.0.0.1:8080 - R:&#x2F;127.0.0.1:52588] READ COMPLETE\n22:19:50 [DEBUG] [defaultEventLoopGroup-2-1] c.i.o.EventLoopTest - zhangsan        \n22:20:24 [DEBUG] [nioEventLoopGroup-4-2] i.n.h.l.LoggingHandler - [id: 0x94b2a840, L:&#x2F;127.0.0.1:8080 - R:&#x2F;127.0.0.1:52612] REGISTERED\n22:20:24 [DEBUG] [nioEventLoopGroup-4-2] i.n.h.l.LoggingHandler - [id: 0x94b2a840, L:&#x2F;127.0.0.1:8080 - R:&#x2F;127.0.0.1:52612] ACTIVE\n22:20:25 [DEBUG] [nioEventLoopGroup-4-2] i.n.h.l.LoggingHandler - [id: 0x94b2a840, L:&#x2F;127.0.0.1:8080 - R:&#x2F;127.0.0.1:52612] READ: 4B\n         +-------------------------------------------------+\n         |  0  1  2  3  4  5  6  7  8  9  a  b  c  d  e  f |\n+--------+-------------------------------------------------+----------------+\n|00000000| 6c 69 73 69                                     |lisi            |\n+--------+-------------------------------------------------+----------------+\n22:20:25 [DEBUG] [nioEventLoopGroup-4-2] i.n.h.l.LoggingHandler - [id: 0x94b2a840, L:&#x2F;127.0.0.1:8080 - R:&#x2F;127.0.0.1:52612] READ COMPLETE\n22:20:25 [DEBUG] [defaultEventLoopGroup-2-2] c.i.o.EventLoopTest - lisi            \n22:20:27 [DEBUG] [nioEventLoopGroup-4-2] i.n.h.l.LoggingHandler - [id: 0x94b2a840, L:&#x2F;127.0.0.1:8080 - R:&#x2F;127.0.0.1:52612] READ: 4B\n         +-------------------------------------------------+\n         |  0  1  2  3  4  5  6  7  8  9  a  b  c  d  e  f |\n+--------+-------------------------------------------------+----------------+\n|00000000| 6c 69 73 69                                     |lisi            |\n+--------+-------------------------------------------------+----------------+\n22:20:27 [DEBUG] [nioEventLoopGroup-4-2] i.n.h.l.LoggingHandler - [id: 0x94b2a840, L:&#x2F;127.0.0.1:8080 - R:&#x2F;127.0.0.1:52612] READ COMPLETE\n22:20:27 [DEBUG] [defaultEventLoopGroup-2-2] c.i.o.EventLoopTest - lisi            \n22:20:38 [DEBUG] [nioEventLoopGroup-4-1] i.n.h.l.LoggingHandler - [id: 0x79a26af9, L:&#x2F;127.0.0.1:8080 - R:&#x2F;127.0.0.1:52625] REGISTERED\n22:20:38 [DEBUG] [nioEventLoopGroup-4-1] i.n.h.l.LoggingHandler - [id: 0x79a26af9, L:&#x2F;127.0.0.1:8080 - R:&#x2F;127.0.0.1:52625] ACTIVE\n22:20:38 [DEBUG] [nioEventLoopGroup-4-1] i.n.h.l.LoggingHandler - [id: 0x79a26af9, L:&#x2F;127.0.0.1:8080 - R:&#x2F;127.0.0.1:52625] READ: 6B\n         +-------------------------------------------------+\n         |  0  1  2  3  4  5  6  7  8  9  a  b  c  d  e  f |\n+--------+-------------------------------------------------+----------------+\n|00000000| 77 61 6e 67 77 75                               |wangwu          |\n+--------+-------------------------------------------------+----------------+\n22:20:38 [DEBUG] [nioEventLoopGroup-4-1] i.n.h.l.LoggingHandler - [id: 0x79a26af9, L:&#x2F;127.0.0.1:8080 - R:&#x2F;127.0.0.1:52625] READ COMPLETE\n22:20:38 [DEBUG] [defaultEventLoopGroup-2-1] c.i.o.EventLoopTest - wangwu          \n22:20:40 [DEBUG] [nioEventLoopGroup-4-1] i.n.h.l.LoggingHandler - [id: 0x79a26af9, L:&#x2F;127.0.0.1:8080 - R:&#x2F;127.0.0.1:52625] READ: 6B\n         +-------------------------------------------------+\n         |  0  1  2  3  4  5  6  7  8  9  a  b  c  d  e  f |\n+--------+-------------------------------------------------+----------------+\n|00000000| 77 61 6e 67 77 75                               |wangwu          |\n+--------+-------------------------------------------------+----------------+\n22:20:40 [DEBUG] [nioEventLoopGroup-4-1] i.n.h.l.LoggingHandler - [id: 0x79a26af9, L:&#x2F;127.0.0.1:8080 - R:&#x2F;127.0.0.1:52625] READ COMPLETE\n22:20:40 [DEBUG] [defaultEventLoopGroup-2-1] c.i.o.EventLoopTest - wangwu          </code></pre>\n\n<p>å¯ä»¥çœ‹åˆ°ï¼Œ<strong>nio å·¥äººå’Œ é nio å·¥äººä¹Ÿåˆ†åˆ«ç»‘å®šäº† channelï¼ˆLoggingHandler ç”± nio å·¥äººæ‰§è¡Œï¼Œè€Œæˆ‘ä»¬è‡ªå·±çš„ handler ç”±é nio å·¥äººæ‰§è¡Œï¼‰</strong></p>\n<p><img src=\"http://cache.itzy8.top/%E5%AD%A6Netty-%E9%BB%91%E9%A9%AC%E6%BB%A1%E5%93%A5/0041.png\"></p>\n<p>ä¸€ä¸ªé•¿channelReadä¼šæ‹–æ…¢ç»‘å®šåœ¨workerä¸Šç›‘æµ‹çš„å…¶ä»–æ‰€æœ‰channelçš„ioå¤„ç†ï¼</p>\n<p>åˆ›å»ºç‹¬ç«‹çš„DefaultEventLoopGroupï¼šåªå¤„ç†æ™®é€š&#x2F;å®šæ—¶ä»»åŠ¡ï¼Œä¸å¤„ç†ioäº‹ä»¶ï¼</p>\n<h4 id=\"ğŸ’¡-handler-æ‰§è¡Œä¸­å¦‚ä½•æ¢äººï¼Ÿ\"><a href=\"#ğŸ’¡-handler-æ‰§è¡Œä¸­å¦‚ä½•æ¢äººï¼Ÿ\" class=\"headerlink\" title=\"ğŸ’¡ handler æ‰§è¡Œä¸­å¦‚ä½•æ¢äººï¼Ÿ\"></a>ğŸ’¡ handler æ‰§è¡Œä¸­å¦‚ä½•æ¢äººï¼Ÿ</h4><p>å…³é”®ä»£ç  <code>io.netty.channel.AbstractChannelHandlerContext#invokeChannelRead()</code></p>\n<pre class=\"line-numbers language-java\" data-language=\"java\"><code class=\"language-java\">static void invokeChannelRead(final AbstractChannelHandlerContext next, Object msg) &#123;\n    final Object m &#x3D; next.pipeline.touch(ObjectUtil.checkNotNull(msg, &quot;msg&quot;), next);\n    &#x2F;&#x2F; ä¸‹ä¸€ä¸ª handler çš„äº‹ä»¶å¾ªç¯æ˜¯å¦ä¸å½“å‰çš„äº‹ä»¶å¾ªç¯æ˜¯åŒä¸€ä¸ªçº¿ç¨‹\n    EventExecutor executor &#x3D; next.executor();\n    \n    &#x2F;&#x2F; æ˜¯ï¼Œç›´æ¥è°ƒç”¨\n    if (executor.inEventLoop()) &#123;\n        next.invokeChannelRead(m);\n    &#125; \n    &#x2F;&#x2F; ä¸æ˜¯ï¼Œå°†è¦æ‰§è¡Œçš„ä»£ç ä½œä¸ºä»»åŠ¡æäº¤ç»™ä¸‹ä¸€ä¸ªäº‹ä»¶å¾ªç¯å¤„ç†ï¼ˆæ¢äººï¼‰\n    else &#123;\n        executor.execute(new Runnable() &#123;\n            @Override\n            public void run() &#123;\n                next.invokeChannelRead(m);\n            &#125;\n        &#125;);\n    &#125;\n&#125;</code></pre>\n\n<ul>\n<li>å¦‚æœ<strong>ä¸¤ä¸ª handler ç»‘å®šçš„æ˜¯åŒä¸€ä¸ªçº¿ç¨‹ï¼Œé‚£ä¹ˆå°±ç›´æ¥è°ƒç”¨</strong></li>\n<li>å¦åˆ™ï¼Œ<strong>æŠŠè¦è°ƒç”¨çš„ä»£ç å°è£…ä¸ºä¸€ä¸ªä»»åŠ¡å¯¹è±¡ï¼Œç”±ä¸‹ä¸€ä¸ª handler çš„çº¿ç¨‹æ¥è°ƒç”¨</strong></li>\n</ul>\n<h4 id=\"æ¼”ç¤º-NioEventLoop-å¤„ç†æ™®é€šä»»åŠ¡\"><a href=\"#æ¼”ç¤º-NioEventLoop-å¤„ç†æ™®é€šä»»åŠ¡\" class=\"headerlink\" title=\"æ¼”ç¤º NioEventLoop å¤„ç†æ™®é€šä»»åŠ¡\"></a>æ¼”ç¤º NioEventLoop å¤„ç†æ™®é€šä»»åŠ¡</h4><p>NioEventLoop é™¤äº†å¯ä»¥å¤„ç† io äº‹ä»¶ï¼ŒåŒæ ·å¯ä»¥å‘å®ƒæäº¤æ™®é€šä»»åŠ¡</p>\n<pre class=\"line-numbers language-java\" data-language=\"java\"><code class=\"language-java\">NioEventLoopGroup nioWorkers &#x3D; new NioEventLoopGroup(2);\n\nlog.debug(&quot;server start...&quot;);\nThread.sleep(2000);\nnioWorkers.execute(()-&gt;&#123; &#x2F;&#x2F; æˆ–submit\n    log.debug(&quot;normal task...&quot;);\n&#125;);</code></pre>\n\n<p>è¾“å‡º</p>\n<pre class=\"line-numbers language-none\"><code class=\"language-none\">22:30:36 [DEBUG] [main] c.i.o.EventLoopTest2 - server start...\n22:30:38 [DEBUG] [nioEventLoopGroup-2-1] c.i.o.EventLoopTest2 - normal task...</code></pre>\n\n<blockquote><span class=\"custom-blockquote-svg\"><svg width=\"24\" height=\"24\" viewBox=\"0 0 24 24\" fill=\"\" xmlns=\"http://www.w3.org/2000/svg\" data-reactroot=\"\">\n<path fill=\"\" d=\"M22 12C22 6.5 17.5 2 12 2C6.5 2 2 6.5 2 12C2 17.5 6.5 22 12 22C13.8 22 15.5 21.5 17 20.6L22 22L20.7 17C21.5 15.5 22 13.8 22 12Z\" undefined=\"1\"></path>\n<path fill=\"\" d=\"M15.97 11.5H16.04C17.12 11.5 18 12.38 18 13.47V13.53C18 14.62 17.12 15.5 16.03 15.5H15.96C14.88 15.5 14 14.62 14 13.53V13.46C14 12.38 14.88 11.5 15.97 11.5Z\" undefined=\"1\"></path>\n<path fill=\"\" d=\"M7.97 11.5H8.04C9.12 11.5 10 12.38 10 13.47V13.53C10 14.62 9.12 15.5 8.03 15.5H7.97C6.88 15.5 6 14.62 6 13.53V13.46C6 12.38 6.88 11.5 7.97 11.5Z\" undefined=\"1\"></path>\n<path stroke-linejoin=\"round\" stroke-linecap=\"round\" stroke-miterlimit=\"10\" stroke-width=\"2\" stroke=\"\" d=\"M17 8.5C15.23 8.97 14.07 10.84 14.01 13.27C14 13.33 14 13.4 14 13.47V13.5\"></path>\n<path stroke-linejoin=\"round\" stroke-linecap=\"round\" stroke-miterlimit=\"10\" stroke-width=\"2\" stroke=\"\" d=\"M9 8.5C7.23 8.97 6.07 10.84 6.01 13.27C6 13.33 6 13.4 6 13.47V13.5\"></path>\n<path stroke-linejoin=\"round\" stroke-linecap=\"round\" stroke-miterlimit=\"10\" stroke-width=\"2\" stroke=\"\" d=\"M15.97 11.5H16.04C17.12 11.5 18 12.38 18 13.47V13.53C18 14.62 17.12 15.5 16.03 15.5H15.96C14.88 15.5 14 14.62 14 13.53V13.46C14 12.38 14.88 11.5 15.97 11.5Z\"></path>\n<path stroke-linejoin=\"round\" stroke-linecap=\"round\" stroke-miterlimit=\"10\" stroke-width=\"2\" stroke=\"\" d=\"M7.97 11.5H8.04C9.12 11.5 10 12.38 10 13.47V13.53C10 14.62 9.12 15.5 8.03 15.5H7.97C6.88 15.5 6 14.62 6 13.53V13.46C6 12.38 6.88 11.5 7.97 11.5Z\"></path>\n</svg>\n</span><p>å¯ä»¥ç”¨æ¥æ‰§è¡Œè€—æ—¶è¾ƒé•¿çš„ä»»åŠ¡</p></blockquote>\n<h4 id=\"æ¼”ç¤º-NioEventLoop-å¤„ç†å®šæ—¶ä»»åŠ¡\"><a href=\"#æ¼”ç¤º-NioEventLoop-å¤„ç†å®šæ—¶ä»»åŠ¡\" class=\"headerlink\" title=\"æ¼”ç¤º NioEventLoop å¤„ç†å®šæ—¶ä»»åŠ¡\"></a>æ¼”ç¤º NioEventLoop å¤„ç†å®šæ—¶ä»»åŠ¡</h4><pre class=\"line-numbers language-java\" data-language=\"java\"><code class=\"language-java\">NioEventLoopGroup nioWorkers &#x3D; new NioEventLoopGroup(2);\n\nlog.debug(&quot;server start...&quot;);\nThread.sleep(2000);\nnioWorkers.scheduleAtFixedRate(() -&gt; &#123;&#x2F;&#x2F;\n    log.debug(&quot;running...&quot;);\n&#125;, 0, 1, TimeUnit.SECONDS);</code></pre>\n\n<p>è¾“å‡º</p>\n<pre class=\"line-numbers language-none\"><code class=\"language-none\">22:35:15 [DEBUG] [main] c.i.o.EventLoopTest2 - server start...\n22:35:17 [DEBUG] [nioEventLoopGroup-2-1] c.i.o.EventLoopTest2 - running...\n22:35:18 [DEBUG] [nioEventLoopGroup-2-1] c.i.o.EventLoopTest2 - running...\n22:35:19 [DEBUG] [nioEventLoopGroup-2-1] c.i.o.EventLoopTest2 - running...\n22:35:20 [DEBUG] [nioEventLoopGroup-2-1] c.i.o.EventLoopTest2 - running...\n...</code></pre>\n\n<blockquote><span class=\"custom-blockquote-svg\"><svg width=\"24\" height=\"24\" viewBox=\"0 0 24 24\" fill=\"\" xmlns=\"http://www.w3.org/2000/svg\" data-reactroot=\"\">\n<path fill=\"\" d=\"M22 12C22 6.5 17.5 2 12 2C6.5 2 2 6.5 2 12C2 17.5 6.5 22 12 22C13.8 22 15.5 21.5 17 20.6L22 22L20.7 17C21.5 15.5 22 13.8 22 12Z\" undefined=\"1\"></path>\n<path fill=\"\" d=\"M15.97 11.5H16.04C17.12 11.5 18 12.38 18 13.47V13.53C18 14.62 17.12 15.5 16.03 15.5H15.96C14.88 15.5 14 14.62 14 13.53V13.46C14 12.38 14.88 11.5 15.97 11.5Z\" undefined=\"1\"></path>\n<path fill=\"\" d=\"M7.97 11.5H8.04C9.12 11.5 10 12.38 10 13.47V13.53C10 14.62 9.12 15.5 8.03 15.5H7.97C6.88 15.5 6 14.62 6 13.53V13.46C6 12.38 6.88 11.5 7.97 11.5Z\" undefined=\"1\"></path>\n<path stroke-linejoin=\"round\" stroke-linecap=\"round\" stroke-miterlimit=\"10\" stroke-width=\"2\" stroke=\"\" d=\"M17 8.5C15.23 8.97 14.07 10.84 14.01 13.27C14 13.33 14 13.4 14 13.47V13.5\"></path>\n<path stroke-linejoin=\"round\" stroke-linecap=\"round\" stroke-miterlimit=\"10\" stroke-width=\"2\" stroke=\"\" d=\"M9 8.5C7.23 8.97 6.07 10.84 6.01 13.27C6 13.33 6 13.4 6 13.47V13.5\"></path>\n<path stroke-linejoin=\"round\" stroke-linecap=\"round\" stroke-miterlimit=\"10\" stroke-width=\"2\" stroke=\"\" d=\"M15.97 11.5H16.04C17.12 11.5 18 12.38 18 13.47V13.53C18 14.62 17.12 15.5 16.03 15.5H15.96C14.88 15.5 14 14.62 14 13.53V13.46C14 12.38 14.88 11.5 15.97 11.5Z\"></path>\n<path stroke-linejoin=\"round\" stroke-linecap=\"round\" stroke-miterlimit=\"10\" stroke-width=\"2\" stroke=\"\" d=\"M7.97 11.5H8.04C9.12 11.5 10 12.38 10 13.47V13.53C10 14.62 9.12 15.5 8.03 15.5H7.97C6.88 15.5 6 14.62 6 13.53V13.46C6 12.38 6.88 11.5 7.97 11.5Z\"></path>\n</svg>\n</span><p>å¯ä»¥ç”¨æ¥æ‰§è¡Œå®šæ—¶ä»»åŠ¡</p></blockquote>\n<h3 id=\"3-2-Channelï¼ï¼ï¼\"><a href=\"#3-2-Channelï¼ï¼ï¼\" class=\"headerlink\" title=\"3.2 Channelï¼ï¼ï¼\"></a>3.2 Channelï¼ï¼ï¼</h3><p>channel çš„ä¸»è¦ä½œç”¨</p>\n<ul>\n<li>close() å¯ä»¥ç”¨æ¥å…³é—­ channel</li>\n<li>closeFuture() ç”¨æ¥å¤„ç† channel çš„å…³é—­<ul>\n<li><strong>sync æ–¹æ³•ä½œç”¨æ˜¯åŒæ­¥ç­‰å¾… channel å…³é—­</strong></li>\n<li><strong>è€Œ addListener æ–¹æ³•æ˜¯å¼‚æ­¥ç­‰å¾… channel å…³é—­</strong></li>\n</ul>\n</li>\n<li>pipeline() æ–¹æ³•æ·»åŠ å¤„ç†å™¨</li>\n<li>write() æ–¹æ³•å°†æ•°æ®å†™å…¥</li>\n<li>writeAndFlush() æ–¹æ³•å°†æ•°æ®å†™å…¥å¹¶åˆ·å‡ºï¼šC-&gt;S</li>\n</ul>\n<h4 id=\"ChannelFuture\"><a href=\"#ChannelFuture\" class=\"headerlink\" title=\"ChannelFuture\"></a>ChannelFuture</h4><p>è¿™æ—¶åˆšæ‰çš„å®¢æˆ·ç«¯ä»£ç </p>\n<pre class=\"line-numbers language-java\" data-language=\"java\"><code class=\"language-java\">new Bootstrap()\n    .group(new NioEventLoopGroup())\n    .channel(NioSocketChannel.class)\n    .handler(new ChannelInitializer&lt;Channel&gt;() &#123;\n        @Override\n        protected void initChannel(Channel ch) &#123;\n            ch.pipeline().addLast(new StringEncoder());\n        &#125;\n    &#125;)\n    .connect(&quot;127.0.0.1&quot;, 8080)\n    .sync()\n    .channel()\n    .writeAndFlush(new Date() + &quot;: hello world!&quot;);</code></pre>\n\n<p>ç°åœ¨æŠŠå®ƒæ‹†å¼€æ¥çœ‹</p>\n<pre class=\"line-numbers language-java\" data-language=\"java\"><code class=\"language-java\">ChannelFuture channelFuture &#x3D; new Bootstrap()\n    .group(new NioEventLoopGroup())\n    .channel(NioSocketChannel.class)\n    .handler(new ChannelInitializer&lt;Channel&gt;() &#123;\n        @Override\n        protected void initChannel(Channel ch) &#123;\n            ch.pipeline().addLast(new StringEncoder());\n        &#125;\n    &#125;)\n    .connect(&quot;127.0.0.1&quot;, 8080); &#x2F;&#x2F; 1\n\nchannelFuture.sync().channel().writeAndFlush(new Date() + &quot;: hello world!&quot;);</code></pre>\n\n<ul>\n<li>1 å¤„è¿”å›çš„æ˜¯ ChannelFuture å¯¹è±¡ï¼Œå®ƒçš„ä½œç”¨æ˜¯<strong>åˆ©ç”¨ channel() æ–¹æ³•æ¥è·å– Channel å¯¹è±¡</strong></li>\n</ul>\n<p><strong>æ³¨æ„</strong> &#x3D;&#x3D;connect æ–¹æ³•æ˜¯å¼‚æ­¥çš„ï¼Œæ„å‘³ç€ä¸ç­‰è¿æ¥å»ºç«‹ï¼Œæ–¹æ³•æ‰§è¡Œå°±è¿”å›äº†ã€‚å› æ­¤ channelFuture å¯¹è±¡ä¸­ä¸èƒ½ã€ç«‹åˆ»ã€‘è·å¾—åˆ°æ­£ç¡®çš„ Channel å¯¹è±¡&#x3D;&#x3D;</p>\n<p>å®éªŒå¦‚ä¸‹ï¼š<strong>sync</strong></p>\n<pre class=\"line-numbers language-java\" data-language=\"java\"><code class=\"language-java\">ChannelFuture channelFuture &#x3D; new Bootstrap()\n    .group(new NioEventLoopGroup())\n    .channel(NioSocketChannel.class)\n    .handler(new ChannelInitializer&lt;Channel&gt;() &#123;\n        @Override\n        protected void initChannel(Channel ch) &#123;\n            ch.pipeline().addLast(new StringEncoder());\n        &#125;\n    &#125;)\n    .connect(&quot;127.0.0.1&quot;, 8080);\n\nSystem.out.println(channelFuture.channel()); &#x2F;&#x2F; 1\nchannelFuture.sync(); &#x2F;&#x2F; 2\nSystem.out.println(channelFuture.channel()); &#x2F;&#x2F; 3</code></pre>\n\n<ul>\n<li>æ‰§è¡Œåˆ° 1 æ—¶ï¼Œè¿æ¥æœªå»ºç«‹ï¼Œæ‰“å° <code>[id: 0x2e1884dd]</code></li>\n<li>æ‰§è¡Œåˆ° 2 æ—¶ï¼Œ&#x3D;&#x3D;sync æ–¹æ³•æ˜¯åŒæ­¥ç­‰å¾…è¿æ¥å»ºç«‹å®Œæˆ&#x3D;&#x3D;</li>\n<li>æ‰§è¡Œåˆ° 3 æ—¶ï¼Œè¿æ¥è‚¯å®šå»ºç«‹äº†ï¼Œæ‰“å° <code>[id: 0x2e1884dd, L:/127.0.0.1:57191 - R:/127.0.0.1:8080]</code></li>\n</ul>\n<h4 id=\"x3D-x3D-ï¼ï¼ï¼é™¤äº†ç”¨-sync-æ–¹æ³•å¯ä»¥è®©connectå¼‚æ­¥æ“ä½œåŒæ­¥ä»¥å¤–ï¼Œè¿˜å¯ä»¥ä½¿ç”¨å›è°ƒçš„æ–¹å¼ï¼š-x3D-x3D\"><a href=\"#x3D-x3D-ï¼ï¼ï¼é™¤äº†ç”¨-sync-æ–¹æ³•å¯ä»¥è®©connectå¼‚æ­¥æ“ä½œåŒæ­¥ä»¥å¤–ï¼Œè¿˜å¯ä»¥ä½¿ç”¨å›è°ƒçš„æ–¹å¼ï¼š-x3D-x3D\" class=\"headerlink\" title=\"&#x3D;&#x3D;ï¼ï¼ï¼é™¤äº†ç”¨ sync æ–¹æ³•å¯ä»¥è®©connectå¼‚æ­¥æ“ä½œåŒæ­¥ä»¥å¤–ï¼Œè¿˜å¯ä»¥ä½¿ç”¨å›è°ƒçš„æ–¹å¼ï¼š&#x3D;&#x3D;\"></a>&#x3D;&#x3D;ï¼ï¼ï¼é™¤äº†ç”¨ sync æ–¹æ³•å¯ä»¥è®©connectå¼‚æ­¥æ“ä½œåŒæ­¥ä»¥å¤–ï¼Œè¿˜å¯ä»¥ä½¿ç”¨<strong>å›è°ƒ</strong>çš„æ–¹å¼ï¼š&#x3D;&#x3D;</h4><p><a href=\"https://zhuanlan.zhihu.com/p/386837957\">https://zhuanlan.zhihu.com/p/386837957</a></p>\n<p>ä¸€ä¸ªChannelHandlerå¯ä»¥ç®€å•çš„ç†è§£ä¸ºä¸€ä¸ªå›è°ƒæ–¹æ³•ï¼Œåœ¨Nettyå†…éƒ¨ä½¿ç”¨ã€å›è°ƒæ¥å¤„ç†äº‹ä»¶ã€‘ï¼›å½“ä¸€ä¸ªäº‹ä»¶è¢«è§¦å‘æ—¶ï¼Œä¸äº‹ä»¶ç›¸å…³çš„ChannelHandlerå°†è¢«è°ƒç”¨æ¥å“åº”è¿™ä¸ªäº‹ä»¶çš„å¤„ç†</p>\n<p>åœ¨Nettyä¸­ï¼ŒFutureæä¾›äº†ä¸€ç§åœ¨ã€æ“ä½œå®Œæˆæ—¶[é€šçŸ¥]åº”ç”¨ç¨‹åºã€‘çš„æ–¹å¼ã€‚è¿™ä¸ªå¯¹è±¡å¯ä»¥çœ‹ä½œæ˜¯ä¸€ä¸ªå¼‚æ­¥æ“ä½œç»“æœçš„å ä½ç¬¦ï¼›å®ƒå°†åœ¨æœªæ¥æŸä¸ªæ—¶åˆ»å®Œæˆå¹¶æä¾›ã€å¯¹ç»“æœçš„è®¿é—®ã€‘ã€‚</p>\n<p>ChannelHandlerå’ŒFutureæ˜¯ã€ç›¸äº’è¡¥å……ã€‘çš„æœºåˆ¶ï¼›å®ƒä»¬ç›¸äº’ç»“åˆä½¿ç”¨æ„æˆäº†Nettyæœ¬èº«çš„å…³é”®æ„ä»¶ä¹‹ä¸€ã€‚</p>\n<hr>\n<p>è™½ç„¶å¯ä»¥é€šè¿‡ChannelFutureçš„get()æ–¹æ³•è·å–å¼‚æ­¥æ“ä½œçš„ç»“æœ,ä½†å®Œæˆæ—¶é—´æ˜¯æ— æ³•é¢„æµ‹çš„,è‹¥ä¸è®¾ç½®è¶…æ—¶æ—¶é—´åˆ™æœ‰å¯èƒ½å¯¼è‡´çº¿ç¨‹é•¿æ—¶é—´è¢«é˜»å¡;è‹¥æ˜¯ä¸èƒ½ç²¾ç¡®çš„è®¾ç½®è¶…æ—¶æ—¶é—´åˆ™å¯èƒ½å¯¼è‡´I&#x2F;Oæ“ä½œä¸­æ–­.å› æ­¤,Nettyå»ºè®®é€šè¿‡GenericFutureListeneræ¥å£æ‰§è¡Œå¼‚æ­¥æ“ä½œç»“æŸåçš„å›è°ƒ.</p>\n<p>ChannelFutureæ¥å£é¢å¤–æä¾›äº†æ³¨å†Œä¸€ä¸ªæˆ–è€…å¤šä¸ªGenericFutureListenerå®ä¾‹çš„æ–¹æ³•ï¼Œç›‘å¬å™¨çš„å›è°ƒæ–¹æ³•<code>operationComplete()</code>å°†ä¼šåœ¨å¯¹åº”çš„æ“ä½œå®Œæˆæ—¶è¢«è°ƒç”¨ã€‚</p>\n<pre class=\"line-numbers language-java\" data-language=\"java\"><code class=\"language-java\">ChannelFuture channelFuture &#x3D; new Bootstrap()\n    .group(new NioEventLoopGroup())\n    .channel(NioSocketChannel.class)\n    .handler(new ChannelInitializer&lt;Channel&gt;() &#123;\n        @Override\n        protected void initChannel(Channel ch) &#123;\n            ch.pipeline().addLast(new StringEncoder());\n        &#125;\n    &#125;)\n    .connect(&quot;127.0.0.1&quot;, 8080);\nSystem.out.println(channelFuture.channel()); &#x2F;&#x2F; 1\nchannelFuture.addListener((ChannelFutureListener) future -&gt; &#123;\n    System.out.println(future.channel()); &#x2F;&#x2F; 2\n&#125;);</code></pre>\n\n<ul>\n<li>æ‰§è¡Œåˆ° 1 æ—¶ï¼Œè¿æ¥æœªå»ºç«‹ï¼Œæ‰“å° <code>[id: 0x749124ba]</code></li>\n<li>&#x3D;&#x3D;ChannelFutureListener ä¼šåœ¨è¿æ¥å»ºç«‹æ—¶è¢«è°ƒç”¨ï¼ˆå…¶ä¸­ operationComplete æ–¹æ³•ï¼‰ï¼Œå› æ­¤æ‰§è¡Œåˆ° 2 æ—¶ï¼Œè¿æ¥è‚¯å®šå»ºç«‹äº†&#x3D;&#x3D;ï¼Œæ‰“å° <code>[id: 0x749124ba, L:/127.0.0.1:57351 - R:/127.0.0.1:8080]</code></li>\n</ul>\n<h4 id=\"CloseFuture\"><a href=\"#CloseFuture\" class=\"headerlink\" title=\"CloseFuture\"></a>CloseFuture</h4><pre class=\"line-numbers language-java\" data-language=\"java\"><code class=\"language-java\">@Slf4j\npublic class CloseFutureClient &#123;\n    public static void main(String[] args) throws InterruptedException &#123;\n        NioEventLoopGroup group new NioEventLoopGroup();\n        ChannelFuture channelFuture &#x3D; new Bootstrap()\n                .group(group)\n                .channel(NioSocketChannel.class)\n                .handler(new ChannelInitializer&lt;NioSocketChannel&gt;() &#123;\n                    @Override &#x2F;&#x2F; åœ¨è¿æ¥å»ºç«‹åè¢«è°ƒç”¨  ä¹Ÿæ˜¯å¼‚æ­¥å›è°ƒï¼ç›¸äº’è¡¥å……ï¼\n                    protected void initChannel(NioSocketChannel ch) throws Exception &#123;\n                        ch.pipeline().addLast(new LoggingHandler(LogLevel.DEBUG));\n                        ch.pipeline().addLast(new StringEncoder());\n                    &#125;\n                &#125;)\n                .connect(new InetSocketAddress(&quot;localhost&quot;, 8080));\n        Channel channel &#x3D; channelFuture.sync().channel();&#x2F;&#x2F;\n        log.debug(&quot;&#123;&#125;&quot;, channel);\n        new Thread(()-&gt;&#123;&#x2F;&#x2F;\n            Scanner scanner &#x3D; new Scanner(System.in);\n            while (true) &#123;\n                String line &#x3D; scanner.nextLine();\n                if (&quot;q&quot;.equals(line)) &#123;\n                    channel.close(); &#x2F;&#x2F; close å¼‚æ­¥æ“ä½œ: 1s ä¹‹åã€éé˜»å¡ï¼ã€‘\n&#x2F;&#x2F;                    log.debug(&quot;å¤„ç†å…³é—­ä¹‹åçš„æ“ä½œ&quot;); &#x2F;&#x2F; ä¸èƒ½åœ¨è¿™é‡Œå–„åï¼å¯èƒ½è¿˜æ²¡closeï¼\n                    break;\n                &#125;\n                channel.writeAndFlush(line);\n            &#125;\n        &#125;, &quot;input&quot;).start();\n\n        &#x2F;&#x2F; è·å– CloseFuture å¯¹è±¡ï¼Œ 1) åŒæ­¥å¤„ç†å…³é—­ï¼Œ 2) å¼‚æ­¥å¤„ç†å…³é—­\n        ChannelFuture closeFuture &#x3D; channel.closeFuture();\n        &#x2F;*log.debug(&quot;waiting close...&quot;);\n        closeFuture.sync();\n        log.debug(&quot;å¤„ç†å…³é—­ä¹‹åçš„æ“ä½œ&quot;);*&#x2F;\n        &#x2F;*\n        closeFuture.addListener(new ChannelFutureListener() &#123;\n            @Override\n            public void operationComplete(ChannelFuture future) throws Exception &#123;\n                log.debug(&quot;å¤„ç†å…³é—­ä¹‹åçš„æ“ä½œ&quot;);\n                group.shutdownGracefully();&#x2F;&#x2F;\n            &#125;\n        &#125;);*&#x2F;\n        &#x2F;&#x2F;@FunctionalInterfaceå‡½æ•°å¼æ¥å£&#x2F;åŠŸèƒ½æ€§æ¥å£(å•æŠ½è±¡æ–¹æ³•æ¥å£) å¯ä½¿ç”¨ Lambda è¡¨è¾¾å¼,æ–¹æ³•å¼•ç”¨å’Œæ„é€ å‡½æ•°å¼•ç”¨æ¥è¡¨ç¤º\n        &#x2F;&#x2F;new ChannelFutureListener()&#123;åªæœ‰ä¸€ä¸ªå¾…é‡å†™çš„å•æŠ½è±¡æ–¹æ³•ï¼šoperationComplete&#125;å¯ç”¨lambdaè¡¨è¾¾å¼ç®€åŒ– alt+enterï¼ï¼ï¼\n        closeFuture.addListener((ChannelFutureListener) future -&gt; &#123;\n            log.debug(&quot;å¤„ç†å…³é—­ä¹‹åçš„æ“ä½œ&quot;);\n            group.shutdownGracefully();&#x2F;&#x2F;\n        &#125;);\n    &#125;\n&#125;</code></pre>\n\n<p>logback.xml</p>\n<pre class=\"line-numbers language-markup\" data-language=\"markup\"><code class=\"language-markup\">&lt;!-- ç”¨æ¥æ§åˆ¶æŸ¥çœ‹é‚£ä¸ªç±»çš„æ—¥å¿—å†…å®¹ï¼ˆå¯¹mybatis name ä»£è¡¨å‘½åç©ºé—´ï¼‰ --&gt;\n&lt;logger name&#x3D;&quot;cn.itcast&quot; level&#x3D;&quot;DEBUG&quot; additivity&#x3D;&quot;false&quot;&gt;\n    &lt;appender-ref ref&#x3D;&quot;STDOUT&quot;&#x2F;&gt;\n&lt;&#x2F;logger&gt;\n\n&lt;logger name&#x3D;&quot;io.netty.handler.logging.LoggingHandler&quot; level&#x3D;&quot;DEBUG&quot; additivity&#x3D;&quot;false&quot;&gt;\n    &lt;appender-ref ref&#x3D;&quot;STDOUT&quot;&#x2F;&gt;\n&lt;&#x2F;logger&gt;\n\n&lt;root level&#x3D;&quot;ERROR&quot;&gt;\n    &lt;appender-ref ref&#x3D;&quot;STDOUT&quot;&#x2F;&gt;\n&lt;&#x2F;root&gt;</code></pre>\n\n<p><img src=\"http://cache.itzy8.top/%E5%AD%A6Netty-%E9%BB%91%E9%A9%AC%E6%BB%A1%E5%93%A5/image-20220426165553101.png\" alt=\"image-20220426165553101\"></p>\n<h4 id=\"ğŸ’¡-ä¼˜é›…å…³é—­\"><a href=\"#ğŸ’¡-ä¼˜é›…å…³é—­\" class=\"headerlink\" title=\"ğŸ’¡ ä¼˜é›…å…³é—­\"></a>ğŸ’¡ ä¼˜é›…å…³é—­</h4><p>ä¼˜é›…å…³é—­ <code>shutdownGracefully</code> æ–¹æ³•ã€‚è¯¥æ–¹æ³•ä¼š&#x3D;&#x3D;ã€é¦–å…ˆåˆ‡æ¢ <code>EventLoopGroup</code> åˆ°å…³é—­çŠ¶æ€ä»è€Œæ‹’ç»æ–°çš„ä»»åŠ¡çš„åŠ å…¥ã€‘ï¼Œç„¶åã€åœ¨ä»»åŠ¡é˜Ÿåˆ—çš„ä»»åŠ¡éƒ½å¤„ç†å®Œæˆåï¼Œåœæ­¢çº¿ç¨‹çš„è¿è¡Œã€‘&#x3D;&#x3D;ã€‚ä»è€Œã€ç¡®ä¿æ•´ä½“åº”ç”¨æ˜¯åœ¨æ­£å¸¸æœ‰åºçš„çŠ¶æ€ä¸‹é€€å‡ºã€‘çš„</p>\n<p>å¼‚å¸¸å¤„ç†ä¸­ä¹Ÿè¦<code>shutdownGracefully</code> ï¼</p>\n<p>&#x3D;&#x3D;Java8 Lambdaè¡¨è¾¾å¼ï¼š@FunctionalInterfaceå‡½æ•°å¼æ¥å£&#x2F;åŠŸèƒ½æ€§æ¥å£(å•æŠ½è±¡æ–¹æ³•æ¥å£) å¯ä½¿ç”¨ Lambda è¡¨è¾¾å¼,æ–¹æ³•å¼•ç”¨å’Œæ„é€ å‡½æ•°å¼•ç”¨æ¥è¡¨ç¤º&#x3D;&#x3D;</p>\n<h4 id=\"ğŸ’¡-å¼‚æ­¥æå‡çš„æ˜¯ä»€ä¹ˆï¼ï¼ï¼\"><a href=\"#ğŸ’¡-å¼‚æ­¥æå‡çš„æ˜¯ä»€ä¹ˆï¼ï¼ï¼\" class=\"headerlink\" title=\"ğŸ’¡ å¼‚æ­¥æå‡çš„æ˜¯ä»€ä¹ˆï¼ï¼ï¼\"></a>ğŸ’¡ å¼‚æ­¥æå‡çš„æ˜¯ä»€ä¹ˆï¼ï¼ï¼</h4><ul>\n<li><p>æœ‰äº›åŒå­¦çœ‹åˆ°è¿™é‡Œä¼šæœ‰ç–‘é—®ï¼šã€ä¸ºä»€ä¹ˆä¸åœ¨ä¸€ä¸ªçº¿ç¨‹ä¸­å»æ‰§è¡Œå»ºç«‹è¿æ¥ã€å»æ‰§è¡Œå…³é—­ channelï¼Œé‚£æ ·ä¸æ˜¯ä¹Ÿå¯ä»¥å—ï¼Ÿéè¦ç”¨è¿™ä¹ˆå¤æ‚çš„<strong>å¼‚æ­¥æ–¹å¼ï¼šæ¯”å¦‚ä¸€ä¸ªçº¿ç¨‹å‘èµ·å»ºç«‹è¿æ¥ï¼Œå¦ä¸€ä¸ªçº¿ç¨‹å»çœŸæ­£å»ºç«‹è¿æ¥</strong>ã€‘</p>\n</li>\n<li><p>è¿˜æœ‰åŒå­¦ä¼šç¬¼ç»Ÿåœ°å›ç­”ï¼Œå› ä¸º netty å¼‚æ­¥æ–¹å¼ç”¨äº†å¤šçº¿ç¨‹ã€å¤šçº¿ç¨‹å°±æ•ˆç‡é«˜ã€‚å…¶å®è¿™äº›è®¤è¯†éƒ½æ¯”è¾ƒç‰‡é¢ï¼Œå¤šçº¿ç¨‹å’Œå¼‚æ­¥æ‰€æå‡çš„æ•ˆç‡å¹¶ä¸æ˜¯æ‰€è®¤ä¸ºçš„</p>\n</li>\n</ul>\n<h3 id=\"x3D-x3D-ã€å¼‚æ­¥-å¤šæ ¸å¤šçº¿ç¨‹ï¼-ä»»åŠ¡æ‹†åˆ†ï¼-æµæ°´çº¿pipelineï¼-å“åº”å˜æ…¢-åä½œæ—¶é—´-ï¼Œååå˜é«˜ï¼ã€‘-x3D-x3D\"><a href=\"#x3D-x3D-ã€å¼‚æ­¥-å¤šæ ¸å¤šçº¿ç¨‹ï¼-ä»»åŠ¡æ‹†åˆ†ï¼-æµæ°´çº¿pipelineï¼-å“åº”å˜æ…¢-åä½œæ—¶é—´-ï¼Œååå˜é«˜ï¼ã€‘-x3D-x3D\" class=\"headerlink\" title=\"&#x3D;&#x3D;ã€å¼‚æ­¥+å¤šæ ¸å¤šçº¿ç¨‹ï¼ ä»»åŠ¡æ‹†åˆ†ï¼ æµæ°´çº¿pipelineï¼ å“åº”å˜æ…¢(+åä½œæ—¶é—´)ï¼Œååå˜é«˜ï¼ã€‘&#x3D;&#x3D;\"></a>&#x3D;&#x3D;ã€å¼‚æ­¥+å¤šæ ¸å¤šçº¿ç¨‹ï¼ ä»»åŠ¡æ‹†åˆ†ï¼ æµæ°´çº¿pipelineï¼ å“åº”å˜æ…¢(+åä½œæ—¶é—´)ï¼Œååå˜é«˜ï¼ã€‘&#x3D;&#x3D;</h3><p>æ€è€ƒä¸‹é¢çš„åœºæ™¯ï¼Œ4 ä¸ªåŒ»ç”Ÿç»™äººçœ‹ç—…ï¼Œæ¯ä¸ªç—…äººèŠ±è´¹ 20 åˆ†é’Ÿï¼Œè€Œä¸”åŒ»ç”Ÿçœ‹ç—…çš„è¿‡ç¨‹ä¸­æ˜¯ä»¥ç—…äººä¸ºå•ä½çš„ï¼Œä¸€ä¸ªç—…äººçœ‹å®Œäº†ï¼Œæ‰èƒ½çœ‹ä¸‹ä¸€ä¸ªç—…äººã€‚å‡è®¾ç—…äººæºæºä¸æ–­åœ°æ¥ï¼Œå¯ä»¥è®¡ç®—ä¸€ä¸‹ 4 ä¸ªåŒ»ç”Ÿä¸€å¤©å·¥ä½œ 8 å°æ—¶ï¼Œå¤„ç†çš„ç—…äººæ€»æ•°æ˜¯ï¼š<code>4 * 8 * 3 = 96</code></p>\n<p><img src=\"http://cache.itzy8.top/%E5%AD%A6Netty-%E9%BB%91%E9%A9%AC%E6%BB%A1%E5%93%A5/0044.png\"></p>\n<p>ç»ç ”ç©¶å‘ç°ï¼Œçœ‹ç—…å¯ä»¥ç»†åˆ†ä¸ºå››ä¸ªæ­¥éª¤ï¼Œç»æ‹†åˆ†åæ¯ä¸ªæ­¥éª¤éœ€è¦ 5 åˆ†é’Ÿï¼Œå¦‚ä¸‹</p>\n<p><img src=\"http://cache.itzy8.top/%E5%AD%A6Netty-%E9%BB%91%E9%A9%AC%E6%BB%A1%E5%93%A5/0048.png\"></p>\n<p>å› æ­¤å¯ä»¥åšå¦‚ä¸‹ä¼˜åŒ–ï¼Œåªæœ‰ä¸€å¼€å§‹ï¼ŒåŒ»ç”Ÿ 2ã€3ã€4 åˆ†åˆ«è¦ç­‰å¾… 5ã€10ã€15 åˆ†é’Ÿæ‰èƒ½æ‰§è¡Œå·¥ä½œï¼Œä½†åªè¦åç»­ç—…äººæºæºä¸æ–­åœ°æ¥ï¼Œä»–ä»¬å°±èƒ½å¤Ÿæ»¡è´Ÿè·å·¥ä½œï¼Œå¹¶ä¸”å¤„ç†ç—…äººçš„èƒ½åŠ›æé«˜åˆ°äº† <code>4 * 8 * 12</code> æ•ˆç‡å‡ ä¹æ˜¯åŸæ¥çš„å››å€</p>\n<p><img src=\"http://cache.itzy8.top/%E5%AD%A6Netty-%E9%BB%91%E9%A9%AC%E6%BB%A1%E5%93%A5/0047.png\"></p>\n<p>è¦ç‚¹</p>\n<ul>\n<li>å•çº¿ç¨‹æ²¡æ³•å¼‚æ­¥æé«˜æ•ˆç‡ï¼Œ<strong>å¿…é¡»é…åˆå¤šçº¿ç¨‹ã€å¤šæ ¸ cpu æ‰èƒ½å‘æŒ¥å¼‚æ­¥çš„ä¼˜åŠ¿</strong></li>\n<li>&#x3D;&#x3D;å¼‚æ­¥å¹¶æ²¡æœ‰ç¼©çŸ­<strong>å“åº”æ—¶é—´ï¼Œåè€Œæœ‰æ‰€å¢åŠ ã€æé«˜çš„æ˜¯ååé‡ï¼šå•ä½æ—¶é—´å†…å¤„ç†ä»»åŠ¡çš„é€Ÿåº¦ï¼ã€‘</strong>&#x3D;&#x3D;</li>\n<li><strong>åˆç†è¿›è¡Œä»»åŠ¡æ‹†åˆ†</strong>ï¼Œä¹Ÿæ˜¯åˆ©ç”¨å¼‚æ­¥çš„å…³é”®</li>\n</ul>\n<h3 id=\"3-3-Future-amp-Promise\"><a href=\"#3-3-Future-amp-Promise\" class=\"headerlink\" title=\"3.3 Future &amp; Promise\"></a>3.3 Future &amp; Promise</h3><p>åœ¨å¼‚æ­¥å¤„ç†æ—¶ï¼Œç»å¸¸ç”¨åˆ°è¿™ä¸¤ä¸ªæ¥å£</p>\n<p>é¦–å…ˆè¦è¯´æ˜ netty ä¸­çš„ Future ä¸ jdk ä¸­çš„ Future åŒåï¼Œä½†æ˜¯æ˜¯ä¸¤ä¸ªæ¥å£ï¼Œ<strong>netty çš„ Future ç»§æ‰¿è‡ª jdk çš„ Futureï¼Œè€Œ Promise åˆå¯¹ netty Future è¿›è¡Œäº†æ‰©å±•</strong>\tjdk Future &lt;- Netty Future &lt;- netty Promise</p>\n<ul>\n<li>jdk Future åªèƒ½åŒæ­¥ç­‰å¾…ä»»åŠ¡ç»“æŸï¼ˆæˆ–æˆåŠŸã€æˆ–å¤±è´¥ï¼‰æ‰èƒ½å¾—åˆ°ç»“æœ</li>\n<li>netty Future å¯ä»¥åŒæ­¥ç­‰å¾…ä»»åŠ¡ç»“æŸå¾—åˆ°ç»“æœï¼Œä¹Ÿå¯ä»¥å¼‚æ­¥æ–¹å¼å¾—åˆ°ç»“æœï¼Œä½†éƒ½æ˜¯è¦<strong>ç­‰ä»»åŠ¡ç»“æŸ</strong></li>\n<li>netty Promise ä¸ä»…æœ‰ netty Future çš„åŠŸèƒ½ï¼Œè€Œä¸”<strong>è„±ç¦»äº†ä»»åŠ¡ç‹¬ç«‹å­˜åœ¨ï¼Œåªä½œä¸ºä¸¤ä¸ªçº¿ç¨‹é—´ä¼ é€’ç»“æœçš„å®¹å™¨</strong></li>\n</ul>\n<table>\n<thead>\n<tr>\n<th>åŠŸèƒ½&#x2F;åç§°</th>\n<th>jdk Future</th>\n<th>netty Future</th>\n<th>Promise</th>\n</tr>\n</thead>\n<tbody><tr>\n<td>cancel</td>\n<td>å–æ¶ˆä»»åŠ¡</td>\n<td>-</td>\n<td>-</td>\n</tr>\n<tr>\n<td>isCanceled</td>\n<td>ä»»åŠ¡æ˜¯å¦å–æ¶ˆ</td>\n<td>-</td>\n<td>-</td>\n</tr>\n<tr>\n<td>isDone</td>\n<td>ä»»åŠ¡æ˜¯å¦å®Œæˆï¼Œä¸èƒ½åŒºåˆ†æˆåŠŸå¤±è´¥</td>\n<td>-</td>\n<td>-</td>\n</tr>\n<tr>\n<td>get</td>\n<td>è·å–ä»»åŠ¡ç»“æœï¼Œ<strong>é˜»å¡ç­‰å¾…</strong>[åˆ«çš„thå¡«ç»“æœ]  åŒæ­¥</td>\n<td>-</td>\n<td>-</td>\n</tr>\n<tr>\n<td>getNow</td>\n<td>-</td>\n<td>è·å–ä»»åŠ¡ç»“æœï¼Œéé˜»å¡ï¼Œ<strong>è¿˜æœªäº§ç”Ÿç»“æœæ—¶è¿”å› null</strong></td>\n<td>-</td>\n</tr>\n<tr>\n<td>await</td>\n<td>-</td>\n<td>ç­‰å¾…ä»»åŠ¡ç»“æŸï¼Œå¦‚æœä»»åŠ¡å¤±è´¥ï¼Œ<strong>ä¸ä¼šæŠ›å¼‚å¸¸</strong>ï¼Œè€Œæ˜¯é€šè¿‡ <strong>isSuccess</strong> åˆ¤æ–­</td>\n<td>-</td>\n</tr>\n<tr>\n<td>sync</td>\n<td>-</td>\n<td>ç­‰å¾…ä»»åŠ¡ç»“æŸï¼Œå¦‚æœ<strong>ä»»åŠ¡å¤±è´¥ï¼ŒæŠ›å‡ºå¼‚å¸¸</strong>       é˜»å¡ï¼Œä¸è·å–ç»“æœ</td>\n<td>-</td>\n</tr>\n<tr>\n<td>isSuccess</td>\n<td>-</td>\n<td>åˆ¤æ–­ä»»åŠ¡æ˜¯å¦æˆåŠŸ</td>\n<td>-</td>\n</tr>\n<tr>\n<td>cause</td>\n<td>-</td>\n<td>è·å–å¤±è´¥ä¿¡æ¯ï¼Œéé˜»å¡ï¼Œå¦‚æœã€æ²¡æœ‰å¤±è´¥ï¼Œè¿”å›nullã€‘</td>\n<td>-</td>\n</tr>\n<tr>\n<td>addLinstener</td>\n<td>-</td>\n<td>æ·»åŠ ã€å›è°ƒï¼Œå¼‚æ­¥æ¥æ”¶ã€‘ç»“æœ</td>\n<td>-</td>\n</tr>\n<tr>\n<td>setSuccess</td>\n<td>-</td>\n<td>-</td>\n<td>ã€ä¸ç­‰ä»»åŠ¡ç»“æŸã€‘selfè®¾ç½®æˆåŠŸç»“æœ</td>\n</tr>\n<tr>\n<td>setFailure</td>\n<td>-</td>\n<td>-</td>\n<td>è®¾ç½®å¤±è´¥ç»“æœ</td>\n</tr>\n</tbody></table>\n<p>execute(Runnable)</p>\n<p>submit(Callable æœ‰è¿”å›ç»“æœï¼) é…åˆFutureæ‹¿ç»“æœ</p>\n<p>å‘çº¿ç¨‹æ± ä¸­æäº¤ä»»åŠ¡ï¼Œgetè¿”å›ç»“æœâ€“&gt;ä¸»åŠ¨åˆ›å»º promise ç»“æœå®¹å™¨</p>\n<pre class=\"line-numbers language-java\" data-language=\"java\"><code class=\"language-java\">@Slf4j\npublic class TestJdkFuture &#123;\n    public static void main(String[] args) throws ExecutionException, InterruptedException &#123;\n        &#x2F;&#x2F; 1. çº¿ç¨‹æ± \n        ExecutorService service &#x3D; Executors.newFixedThreadPool(2);\n        &#x2F;&#x2F; 2. æäº¤ä»»åŠ¡\n        Future&lt;Integer&gt; future &#x3D; service.submit(new Callable&lt;Integer&gt;() &#123;&#x2F;&#x2F;\n            @Override\n            public Integer call() throws Exception &#123;\n                log.debug(&quot;æ‰§è¡Œè®¡ç®—&quot;);\n                Thread.sleep(1000);\n                return 50;&#x2F;&#x2F;\n            &#125;\n        &#125;);\n        &#x2F;&#x2F; 3. ä¸»çº¿ç¨‹é€šè¿‡ future æ¥åŒæ­¥è·å–ç»“æœ\n        log.debug(&quot;ç­‰å¾…ç»“æœ&quot;);\n        log.debug(&quot;ç»“æœæ˜¯ &#123;&#125;&quot;, future.get());&#x2F;&#x2F;\n    &#125;\n&#125;\n\n\n@Slf4j\npublic class TestNettyFuture &#123;\n    public static void main(String[] args) throws ExecutionException, InterruptedException &#123;\n        NioEventLoopGroup group &#x3D; new NioEventLoopGroup();\n        EventLoop eventLoop &#x3D; group.next();\n        Future&lt;Integer&gt; future &#x3D; eventLoop.submit(new Callable&lt;Integer&gt;() &#123;\n            @Override\n            public Integer call() throws Exception &#123;\n                log.debug(&quot;æ‰§è¡Œè®¡ç®—&quot;);\n                Thread.sleep(1000);\n                return 70;\n            &#125;\n        &#125;);\n&#x2F;&#x2F;        log.debug(&quot;ç­‰å¾…ç»“æœ&quot;);\n&#x2F;&#x2F;        log.debug(&quot;ç»“æœæ˜¯ &#123;&#125;&quot;, future.get());\n        future.addListener(new GenericFutureListener&lt;Future&lt;? super Integer&gt;&gt;()&#123;&#x2F;&#x2F;\n            @Override\n            public void operationComplete(Future&lt;? super Integer&gt; future) throws Exception &#123;\n                log.debug(&quot;æ¥æ”¶ç»“æœ:&#123;&#125;&quot;, future.getNow());&#x2F;&#x2F;\n            &#125;\n        &#125;);\n    &#125;\n&#125;\n\n\n@Slf4j\npublic class TestNettyPromise &#123;\n    public static void main(String[] args) throws ExecutionException, InterruptedException &#123;\n        &#x2F;&#x2F; 1. å‡†å¤‡ EventLoop å¯¹è±¡\n        EventLoop eventLoop &#x3D; new NioEventLoopGroup().next();\n        &#x2F;&#x2F; 2. å¯ä»¥ä¸»åŠ¨åˆ›å»º promiseï¼šç»“æœå®¹å™¨\n        DefaultPromise&lt;Integer&gt; promise &#x3D; new DefaultPromise&lt;&gt;(eventLoop);\n        new Thread(() -&gt; &#123;\n            &#x2F;&#x2F; 3. ä»»æ„ä¸€ä¸ªçº¿ç¨‹æ‰§è¡Œè®¡ç®—ï¼Œè®¡ç®—å®Œæ¯•åå‘ promise å¡«å……ç»“æœ\n            log.debug(&quot;å¼€å§‹è®¡ç®—...&quot;);\n            try &#123;\n                int i &#x3D; 1 &#x2F; 0;\n                Thread.sleep(1000);\n                promise.setSuccess(80);&#x2F;&#x2F;result&#x3D;80\n            &#125; catch (Exception e) &#123;\n                e.printStackTrace();\n                promise.setFailure(e);&#x2F;&#x2F;\n            &#125;\n\n        &#125;).start();\n        &#x2F;&#x2F; 4. æ¥æ”¶ç»“æœçš„çº¿ç¨‹\n        log.debug(&quot;ç­‰å¾…ç»“æœ...&quot;);\n        log.debug(&quot;ç»“æœæ˜¯: &#123;&#125;&quot;, promise.get());&#x2F;&#x2F;\n    &#125;\n\n&#125;</code></pre>\n\n<h4 id=\"ä¾‹1\"><a href=\"#ä¾‹1\" class=\"headerlink\" title=\"ä¾‹1\"></a>ä¾‹1</h4><p>åŒæ­¥å¤„ç†ä»»åŠ¡æˆåŠŸ</p>\n<pre class=\"line-numbers language-java\" data-language=\"java\"><code class=\"language-java\">DefaultEventLoop eventExecutors &#x3D; new DefaultEventLoop();\nDefaultPromise&lt;Integer&gt; promise &#x3D; new DefaultPromise&lt;&gt;(eventExecutors);\n\neventExecutors.execute(()-&gt;&#123;\n    try &#123;\n        Thread.sleep(1000);\n    &#125; catch (InterruptedException e) &#123;\n        e.printStackTrace();\n    &#125;\n    log.debug(&quot;set success, &#123;&#125;&quot;,10);\n    promise.setSuccess(10);\n&#125;);\n\nlog.debug(&quot;start...&quot;);\nlog.debug(&quot;&#123;&#125;&quot;,promise.getNow()); &#x2F;&#x2F; è¿˜æ²¡æœ‰ç»“æœ\nlog.debug(&quot;&#123;&#125;&quot;,promise.get());</code></pre>\n\n<p>è¾“å‡º</p>\n<pre class=\"line-numbers language-none\"><code class=\"language-none\">11:51:53 [DEBUG] [main] c.i.o.DefaultPromiseTest2 - start...\n11:51:53 [DEBUG] [main] c.i.o.DefaultPromiseTest2 - null\n11:51:54 [DEBUG] [defaultEventLoop-1-1] c.i.o.DefaultPromiseTest2 - set success, 10\n11:51:54 [DEBUG] [main] c.i.o.DefaultPromiseTest2 - 10</code></pre>\n\n\n\n<h4 id=\"ä¾‹2\"><a href=\"#ä¾‹2\" class=\"headerlink\" title=\"ä¾‹2\"></a>ä¾‹2</h4><p>å¼‚æ­¥å¤„ç†ä»»åŠ¡æˆåŠŸ</p>\n<pre class=\"line-numbers language-java\" data-language=\"java\"><code class=\"language-java\">DefaultEventLoop eventExecutors &#x3D; new DefaultEventLoop();\nDefaultPromise&lt;Integer&gt; promise &#x3D; new DefaultPromise&lt;&gt;(eventExecutors);\n\n&#x2F;&#x2F; è®¾ç½®å›è°ƒï¼Œå¼‚æ­¥æ¥æ”¶ç»“æœ\npromise.addListener(future -&gt; &#123;\n    &#x2F;&#x2F; è¿™é‡Œçš„ future å°±æ˜¯ä¸Šé¢çš„ promise\n    log.debug(&quot;&#123;&#125;&quot;,future.getNow());\n&#125;);\n\n&#x2F;&#x2F; ç­‰å¾… 1000 åè®¾ç½®æˆåŠŸç»“æœ\neventExecutors.execute(()-&gt;&#123;\n    try &#123;\n        Thread.sleep(1000);\n    &#125; catch (InterruptedException e) &#123;\n        e.printStackTrace();\n    &#125;\n    log.debug(&quot;set success, &#123;&#125;&quot;,10);\n    promise.setSuccess(10);\n&#125;);\n\nlog.debug(&quot;start...&quot;);</code></pre>\n\n<p>è¾“å‡º</p>\n<pre class=\"line-numbers language-none\"><code class=\"language-none\">11:49:30 [DEBUG] [main] c.i.o.DefaultPromiseTest2 - start...\n11:49:31 [DEBUG] [defaultEventLoop-1-1] c.i.o.DefaultPromiseTest2 - set success, 10\n11:49:31 [DEBUG] [defaultEventLoop-1-1] c.i.o.DefaultPromiseTest2 - 10</code></pre>\n\n\n\n<h4 id=\"ä¾‹3\"><a href=\"#ä¾‹3\" class=\"headerlink\" title=\"ä¾‹3\"></a>ä¾‹3</h4><p>åŒæ­¥å¤„ç†ä»»åŠ¡å¤±è´¥ - sync &amp; get</p>\n<pre class=\"line-numbers language-java\" data-language=\"java\"><code class=\"language-java\">DefaultEventLoop eventExecutors &#x3D; new DefaultEventLoop();\n        DefaultPromise&lt;Integer&gt; promise &#x3D; new DefaultPromise&lt;&gt;(eventExecutors);\n\n        eventExecutors.execute(() -&gt; &#123;\n            try &#123;\n                Thread.sleep(1000);\n            &#125; catch (InterruptedException e) &#123;\n                e.printStackTrace();\n            &#125;\n            RuntimeException e &#x3D; new RuntimeException(&quot;error...&quot;);\n            log.debug(&quot;set failure, &#123;&#125;&quot;, e.toString());\n            promise.setFailure(e);\n        &#125;);\n\n        log.debug(&quot;start...&quot;);\n        log.debug(&quot;&#123;&#125;&quot;, promise.getNow());\n        promise.get(); &#x2F;&#x2F; sync() ä¹Ÿä¼šå‡ºç°å¼‚å¸¸ï¼Œåªæ˜¯ get ä¼šå†ç”¨ ExecutionException åŒ…ä¸€å±‚å¼‚å¸¸</code></pre>\n\n<p>è¾“å‡º</p>\n<pre class=\"line-numbers language-none\"><code class=\"language-none\">12:11:07 [DEBUG] [main] c.i.o.DefaultPromiseTest2 - start...\n12:11:07 [DEBUG] [main] c.i.o.DefaultPromiseTest2 - null\n12:11:08 [DEBUG] [defaultEventLoop-1-1] c.i.o.DefaultPromiseTest2 - set failure, java.lang.RuntimeException: error...\nException in thread &quot;main&quot; java.util.concurrent.ExecutionException: java.lang.RuntimeException: error...\n\tat io.netty.util.concurrent.AbstractFuture.get(AbstractFuture.java:41)\n\tat com.itcast.oio.DefaultPromiseTest2.main(DefaultPromiseTest2.java:34)\nCaused by: java.lang.RuntimeException: error...\n\tat com.itcast.oio.DefaultPromiseTest2.lambda$main$0(DefaultPromiseTest2.java:27)\n\tat io.netty.channel.DefaultEventLoop.run(DefaultEventLoop.java:54)\n\tat io.netty.util.concurrent.SingleThreadEventExecutor$5.run(SingleThreadEventExecutor.java:918)\n\tat io.netty.util.internal.ThreadExecutorMap$2.run(ThreadExecutorMap.java:74)\n\tat io.netty.util.concurrent.FastThreadLocalRunnable.run(FastThreadLocalRunnable.java:30)\n\tat java.lang.Thread.run(Thread.java:745)</code></pre>\n\n\n\n<h4 id=\"ä¾‹4\"><a href=\"#ä¾‹4\" class=\"headerlink\" title=\"ä¾‹4\"></a>ä¾‹4</h4><p>åŒæ­¥å¤„ç†ä»»åŠ¡å¤±è´¥ - await</p>\n<pre class=\"line-numbers language-java\" data-language=\"java\"><code class=\"language-java\">DefaultEventLoop eventExecutors &#x3D; new DefaultEventLoop();\nDefaultPromise&lt;Integer&gt; promise &#x3D; new DefaultPromise&lt;&gt;(eventExecutors);\n\neventExecutors.execute(() -&gt; &#123;\n    try &#123;\n        Thread.sleep(1000);\n    &#125; catch (InterruptedException e) &#123;\n        e.printStackTrace();\n    &#125;\n    RuntimeException e &#x3D; new RuntimeException(&quot;error...&quot;);\n    log.debug(&quot;set failure, &#123;&#125;&quot;, e.toString());\n    promise.setFailure(e);\n&#125;);\n\nlog.debug(&quot;start...&quot;);\nlog.debug(&quot;&#123;&#125;&quot;, promise.getNow());\npromise.await(); &#x2F;&#x2F; ä¸ sync å’Œ get åŒºåˆ«åœ¨äºï¼Œä¸ä¼šæŠ›å¼‚å¸¸\nlog.debug(&quot;result &#123;&#125;&quot;, (promise.isSuccess() ? promise.getNow() : promise.cause()).toString());&#x2F;&#x2F;ï¼ï¼ï¼</code></pre>\n\n<p>è¾“å‡º</p>\n<pre class=\"line-numbers language-none\"><code class=\"language-none\">12:18:53 [DEBUG] [main] c.i.o.DefaultPromiseTest2 - start...\n12:18:53 [DEBUG] [main] c.i.o.DefaultPromiseTest2 - null\n12:18:54 [DEBUG] [defaultEventLoop-1-1] c.i.o.DefaultPromiseTest2 - set failure, java.lang.RuntimeException: error...\n12:18:54 [DEBUG] [main] c.i.o.DefaultPromiseTest2 - result java.lang.RuntimeException: error...</code></pre>\n\n\n\n<h4 id=\"ä¾‹5\"><a href=\"#ä¾‹5\" class=\"headerlink\" title=\"ä¾‹5\"></a>ä¾‹5</h4><p>å¼‚æ­¥å¤„ç†ä»»åŠ¡å¤±è´¥</p>\n<pre class=\"line-numbers language-java\" data-language=\"java\"><code class=\"language-java\">DefaultEventLoop eventExecutors &#x3D; new DefaultEventLoop();\nDefaultPromise&lt;Integer&gt; promise &#x3D; new DefaultPromise&lt;&gt;(eventExecutors);\n\npromise.addListener(future -&gt; &#123;\n    log.debug(&quot;result &#123;&#125;&quot;, (promise.isSuccess() ? promise.getNow() : promise.cause()).toString());&#x2F;&#x2F;\n&#125;);\n\neventExecutors.execute(() -&gt; &#123;\n    try &#123;\n        Thread.sleep(1000);\n    &#125; catch (InterruptedException e) &#123;\n        e.printStackTrace();\n    &#125;\n    RuntimeException e &#x3D; new RuntimeException(&quot;error...&quot;);\n    log.debug(&quot;set failure, &#123;&#125;&quot;, e.toString());\n    promise.setFailure(e);\n&#125;);\n\nlog.debug(&quot;start...&quot;);</code></pre>\n\n<p>è¾“å‡º</p>\n<pre class=\"line-numbers language-none\"><code class=\"language-none\">12:04:57 [DEBUG] [main] c.i.o.DefaultPromiseTest2 - start...\n12:04:58 [DEBUG] [defaultEventLoop-1-1] c.i.o.DefaultPromiseTest2 - set failure, java.lang.RuntimeException: error...\n12:04:58 [DEBUG] [defaultEventLoop-1-1] c.i.o.DefaultPromiseTest2 - result java.lang.RuntimeException: error...</code></pre>\n\n\n\n<h4 id=\"ä¾‹6\"><a href=\"#ä¾‹6\" class=\"headerlink\" title=\"ä¾‹6\"></a>ä¾‹6</h4><p>await æ­»é”æ£€æŸ¥ï¼Ÿï¼Ÿï¼Ÿ</p>\n<pre class=\"line-numbers language-java\" data-language=\"java\"><code class=\"language-java\">DefaultEventLoop eventExecutors &#x3D; new DefaultEventLoop();\nDefaultPromise&lt;Integer&gt; promise &#x3D; new DefaultPromise&lt;&gt;(eventExecutors);\n\neventExecutors.submit(()-&gt;&#123;\n    System.out.println(&quot;1&quot;);\n    try &#123;\n        promise.await();\n        &#x2F;&#x2F; æ³¨æ„ä¸èƒ½ä»…æ•è· InterruptedException å¼‚å¸¸\n        &#x2F;&#x2F; å¦åˆ™ æ­»é”æ£€æŸ¥æŠ›å‡ºçš„ BlockingOperationException ä¼šç»§ç»­å‘ä¸Šä¼ æ’­\n        &#x2F;&#x2F; è€Œæäº¤çš„ä»»åŠ¡ä¼šè¢«åŒ…è£…ä¸º PromiseTaskï¼Œå®ƒçš„ run æ–¹æ³•ä¸­ä¼š catch æ‰€æœ‰å¼‚å¸¸ç„¶åè®¾ç½®ä¸º Promise çš„å¤±è´¥ç»“æœè€Œä¸ä¼šæŠ›å‡º\n    &#125; catch (Exception e) &#123; \n        e.printStackTrace();\n    &#125;\n    System.out.println(&quot;2&quot;);\n&#125;);\neventExecutors.submit(()-&gt;&#123;\n    System.out.println(&quot;3&quot;);\n    try &#123;\n        promise.await();\n    &#125; catch (Exception e) &#123;\n        e.printStackTrace();\n    &#125;\n    System.out.println(&quot;4&quot;);\n&#125;);</code></pre>\n\n<p>è¾“å‡º</p>\n<pre class=\"line-numbers language-none\"><code class=\"language-none\">1\n2\n3\n4\nio.netty.util.concurrent.BlockingOperationException: DefaultPromise@47499c2a(incomplete)\n\tat io.netty.util.concurrent.DefaultPromise.checkDeadLock(DefaultPromise.java:384)\n\tat io.netty.util.concurrent.DefaultPromise.await(DefaultPromise.java:212)\n\tat com.itcast.oio.DefaultPromiseTest.lambda$main$0(DefaultPromiseTest.java:27)\n\tat io.netty.util.concurrent.PromiseTask$RunnableAdapter.call(PromiseTask.java:38)\n\tat io.netty.util.concurrent.PromiseTask.run(PromiseTask.java:73)\n\tat io.netty.channel.DefaultEventLoop.run(DefaultEventLoop.java:54)\n\tat io.netty.util.concurrent.SingleThreadEventExecutor$5.run(SingleThreadEventExecutor.java:918)\n\tat io.netty.util.internal.ThreadExecutorMap$2.run(ThreadExecutorMap.java:74)\n\tat io.netty.util.concurrent.FastThreadLocalRunnable.run(FastThreadLocalRunnable.java:30)\n\tat java.lang.Thread.run(Thread.java:745)\nio.netty.util.concurrent.BlockingOperationException: DefaultPromise@47499c2a(incomplete)\n\tat io.netty.util.concurrent.DefaultPromise.checkDeadLock(DefaultPromise.java:384)\n\tat io.netty.util.concurrent.DefaultPromise.await(DefaultPromise.java:212)\n\tat com.itcast.oio.DefaultPromiseTest.lambda$main$1(DefaultPromiseTest.java:36)\n\tat io.netty.util.concurrent.PromiseTask$RunnableAdapter.call(PromiseTask.java:38)\n\tat io.netty.util.concurrent.PromiseTask.run(PromiseTask.java:73)\n\tat io.netty.channel.DefaultEventLoop.run(DefaultEventLoop.java:54)\n\tat io.netty.util.concurrent.SingleThreadEventExecutor$5.run(SingleThreadEventExecutor.java:918)\n\tat io.netty.util.internal.ThreadExecutorMap$2.run(ThreadExecutorMap.java:74)\n\tat io.netty.util.concurrent.FastThreadLocalRunnable.run(FastThreadLocalRunnable.java:30)\n\tat java.lang.Thread.run(Thread.java:745)\n</code></pre>\n\n\n\n\n\n<h3 id=\"3-4-Handler-amp-Pipeline\"><a href=\"#3-4-Handler-amp-Pipeline\" class=\"headerlink\" title=\"3.4 Handler &amp; Pipeline\"></a>3.4 Handler &amp; Pipeline</h3><p>ChannelHandler ç”¨æ¥å¤„ç† Channel ä¸Šçš„å„ç§äº‹ä»¶ï¼Œåˆ†ä¸ºå…¥ç«™ã€å‡ºç«™ä¸¤ç§ã€‚æ‰€æœ‰ ChannelHandler è¢«è¿æˆä¸€ä¸²ï¼Œå°±æ˜¯ Pipeline</p>\n<ul>\n<li>å…¥ç«™å¤„ç†å™¨é€šå¸¸æ˜¯ ChannelInboundHandlerAdapter çš„å­ç±»ï¼Œä¸»è¦ç”¨æ¥<strong>è¯»å–å®¢æˆ·ç«¯æ•°æ®ï¼Œå†™å›ç»“æœ</strong></li>\n<li>å‡ºç«™å¤„ç†å™¨é€šå¸¸æ˜¯ ChannelOutboundHandlerAdapter çš„å­ç±»ï¼Œä¸»è¦<strong>å¯¹å†™å›ç»“æœè¿›è¡ŒåŠ å·¥</strong></li>\n</ul>\n<p>æ‰“ä¸ªæ¯”å–»ï¼Œæ¯ä¸ª Channel æ˜¯ä¸€ä¸ªäº§å“çš„åŠ å·¥è½¦é—´ï¼ŒPipeline æ˜¯è½¦é—´ä¸­çš„æµæ°´çº¿ï¼ŒChannelHandler å°±æ˜¯æµæ°´çº¿ä¸Šçš„å„é“[å·¥åº]ï¼Œè€Œåé¢è¦è®²çš„ [ByteBuf æ˜¯åŸææ–™]ï¼Œç»è¿‡å¾ˆå¤šå·¥åºçš„åŠ å·¥ï¼šå…ˆç»è¿‡ä¸€é“é“å…¥ç«™å·¥åºï¼Œå†ç»è¿‡ä¸€é“é“å‡ºç«™å·¥åºæœ€ç»ˆå˜æˆäº§å“</p>\n<p>å…ˆææ¸…æ¥šé¡ºåºï¼ŒæœåŠ¡ç«¯</p>\n<pre class=\"line-numbers language-java\" data-language=\"java\"><code class=\"language-java\">new ServerBootstrap()\n    .group(new NioEventLoopGroup())\n    .channel(NioServerSocketChannel.class)\n    .childHandler(new ChannelInitializer&lt;NioSocketChannel&gt;() &#123;\n        protected void initChannel(NioSocketChannel ch) &#123;\n            ch.pipeline().addLast(new ChannelInboundHandlerAdapter()&#123;\n                @Override\n                public void channelRead(ChannelHandlerContext ctx, Object msg) &#123;\n                    System.out.println(1);\n                    ctx.fireChannelRead(msg); &#x2F;&#x2F; 1\n                &#125;\n            &#125;);\n            ch.pipeline().addLast(new ChannelInboundHandlerAdapter()&#123;\n                @Override\n                public void channelRead(ChannelHandlerContext ctx, Object msg) &#123;\n                    System.out.println(2);\n                    ctx.fireChannelRead(msg); &#x2F;&#x2F; 2\n                &#125;\n            &#125;);\n            ch.pipeline().addLast(new ChannelInboundHandlerAdapter()&#123;\n                @Override\n                public void channelRead(ChannelHandlerContext ctx, Object msg) &#123;\n                    System.out.println(3);\n                    ctx.channel().write(msg); &#x2F;&#x2F; 3\n                &#125;\n            &#125;);\n            ch.pipeline().addLast(new ChannelOutboundHandlerAdapter()&#123;\n                @Override\n                public void write(ChannelHandlerContext ctx, Object msg, \n                                  ChannelPromise promise) &#123;\n                    System.out.println(4);\n                    ctx.write(msg, promise); &#x2F;&#x2F; 4\n                &#125;\n            &#125;);\n            ch.pipeline().addLast(new ChannelOutboundHandlerAdapter()&#123;\n                @Override\n                public void write(ChannelHandlerContext ctx, Object msg, \n                                  ChannelPromise promise) &#123;\n                    System.out.println(5);\n                    ctx.write(msg, promise); &#x2F;&#x2F; 5\n                &#125;\n            &#125;);\n            ch.pipeline().addLast(new ChannelOutboundHandlerAdapter()&#123;\n                @Override\n                public void write(ChannelHandlerContext ctx, Object msg, \n                                  ChannelPromise promise) &#123;\n                    System.out.println(6);\n                    ctx.write(msg, promise); &#x2F;&#x2F; 6 &#x3D;super.write(ctx, msg, promise);\n                &#125;\n            &#125;);\n        &#125;\n    &#125;)\n    .bind(8080);</code></pre>\n\n<p>å®¢æˆ·ç«¯</p>\n<pre class=\"line-numbers language-java\" data-language=\"java\"><code class=\"language-java\">new Bootstrap()\n    .group(new NioEventLoopGroup())\n    .channel(NioSocketChannel.class)\n    .handler(new ChannelInitializer&lt;Channel&gt;() &#123;\n        @Override\n        protected void initChannel(Channel ch) &#123;\n            ch.pipeline().addLast(new StringEncoder());\n        &#125;\n    &#125;)\n    .connect(&quot;127.0.0.1&quot;, 8080)\n    .addListener((ChannelFutureListener) future -&gt; &#123;\n        future.channel().writeAndFlush(&quot;hello,world&quot;);\n    &#125;);</code></pre>\n\n<p>æœåŠ¡å™¨ç«¯æ‰“å°ï¼š</p>\n<pre class=\"line-numbers language-none\"><code class=\"language-none\">1\n2\n3\n6\n5\n4</code></pre>\n\n<p>å¯ä»¥çœ‹åˆ°ï¼ŒChannelInboundHandlerAdapter æ˜¯æŒ‰ç…§ addLast çš„é¡ºåºæ‰§è¡Œçš„ï¼Œè€Œ ChannelOutboundHandlerAdapter æ˜¯æŒ‰ç…§ addLast çš„é€†åºæ‰§è¡Œçš„ã€‚ChannelPipeline çš„å®ç°æ˜¯ä¸€ä¸ª ChannelHandlerContextï¼ˆåŒ…è£…äº† ChannelHandlerï¼‰ ç»„æˆçš„åŒå‘é“¾è¡¨</p>\n<p><img src=\"http://cache.itzy8.top/%E5%AD%A6Netty-%E9%BB%91%E9%A9%AC%E6%BB%A1%E5%93%A5/0008.png\"></p>\n<ul>\n<li>å…¥ç«™å¤„ç†å™¨ä¸­ï¼Œctx.fireChannelRead(msg) æ˜¯ <strong>è°ƒç”¨ä¸‹ä¸€ä¸ªå…¥ç«™å¤„ç†å™¨</strong><ul>\n<li>å¦‚æœæ³¨é‡Šæ‰ 1 å¤„ä»£ç ï¼Œåˆ™ä»…ä¼šæ‰“å° 1</li>\n<li>å¦‚æœæ³¨é‡Šæ‰ 2 å¤„ä»£ç ï¼Œåˆ™ä»…ä¼šæ‰“å° 1 2</li>\n</ul>\n</li>\n<li>3 å¤„çš„ ctx.channel().write(msg) ä¼š <strong>ä»å°¾éƒ¨å¼€å§‹è§¦å‘</strong> åç»­å‡ºç«™å¤„ç†å™¨çš„æ‰§è¡Œ<ul>\n<li>å¦‚æœæ³¨é‡Šæ‰ 3 å¤„ä»£ç ï¼Œåˆ™ä»…ä¼šæ‰“å° 1 2 3</li>\n</ul>\n</li>\n<li>ç±»ä¼¼çš„ï¼Œå‡ºç«™å¤„ç†å™¨ä¸­ï¼Œctx.write(msg, promise) çš„è°ƒç”¨ä¹Ÿä¼š <strong>è§¦å‘ä¸Šä¸€ä¸ªå‡ºç«™å¤„ç†å™¨</strong><ul>\n<li>å¦‚æœæ³¨é‡Šæ‰ 6 å¤„ä»£ç ï¼Œåˆ™ä»…ä¼šæ‰“å° 1 2 3 6</li>\n</ul>\n</li>\n<li>ctx.channel().write(msg) vs ctx.write(msg)<ul>\n<li>éƒ½æ˜¯è§¦å‘å‡ºç«™å¤„ç†å™¨çš„æ‰§è¡Œ</li>\n<li><strong>ctx.channel().write(msg) ä»å°¾éƒ¨å¼€å§‹æŸ¥æ‰¾å‡ºç«™å¤„ç†å™¨</strong></li>\n<li><strong>ctx.write(msg) æ˜¯ä»å½“å‰èŠ‚ç‚¹æ‰¾ä¸Šä¸€ä¸ªå‡ºç«™å¤„ç†å™¨</strong></li>\n<li>3 å¤„çš„ ctx.channel().write(msg) å¦‚æœæ”¹ä¸º ctx.write(msg) ä»…ä¼šæ‰“å° 1 2 3ï¼Œå› ä¸ºèŠ‚ç‚¹3 ä¹‹å‰æ²¡æœ‰å…¶å®ƒå‡ºç«™å¤„ç†å™¨äº†</li>\n<li><strong>6 å¤„</strong>çš„ ctx.write(msg, promise) å¦‚æœ<strong>æ”¹ä¸º</strong> ctx.channel().write(msg) <strong>ä¼šæ‰“å° 1 2 3 6 6 6â€¦æ­»å¾ªç¯ï¼</strong> å› ä¸º <strong>ctx.channel().write() æ˜¯ä»å°¾éƒ¨</strong>å¼€å§‹æŸ¥æ‰¾ï¼Œç»“æœ<strong>åˆæ˜¯èŠ‚ç‚¹6 è‡ªå·±</strong>ã€åº”é¿å…ï¼ï¼ï¼ã€‘</li>\n</ul>\n</li>\n</ul>\n<p>å›¾1 - æœåŠ¡ç«¯ pipeline è§¦å‘çš„åŸå§‹æµç¨‹ï¼Œå›¾ä¸­æ•°å­—ä»£è¡¨äº†å¤„ç†æ­¥éª¤çš„å…ˆåæ¬¡åº</p>\n<p><img src=\"http://cache.itzy8.top/%E5%AD%A6Netty-%E9%BB%91%E9%A9%AC%E6%BB%A1%E5%93%A5/0009.png\"></p>\n<h4 id=\"x3D-x3D-in-åŒ…è£…-è½¬æ¢-channel-tailå€’-out-å¤„ç†-ctx-x2F-super-curå€’-x3D-x3D\"><a href=\"#x3D-x3D-in-åŒ…è£…-è½¬æ¢-channel-tailå€’-out-å¤„ç†-ctx-x2F-super-curå€’-x3D-x3D\" class=\"headerlink\" title=\"&#x3D;&#x3D;in(åŒ…è£… è½¬æ¢)-channel(tailå€’)\tout(å¤„ç†)-ctx&#x2F;super(curå€’)&#x3D;&#x3D;\"></a>&#x3D;&#x3D;in(åŒ…è£… è½¬æ¢)-channel(tailå€’)\tout(å¤„ç†)-ctx&#x2F;super(curå€’)&#x3D;&#x3D;</h4><pre class=\"line-numbers language-java\" data-language=\"java\"><code class=\"language-java\">package cn.itcast.netty.c3;\n\nimport io.netty.bootstrap.ServerBootstrap;\nimport io.netty.buffer.ByteBuf;\nimport io.netty.channel.*;\nimport io.netty.channel.nio.NioEventLoopGroup;\nimport io.netty.channel.socket.nio.NioServerSocketChannel;\nimport io.netty.channel.socket.nio.NioSocketChannel;\nimport lombok.AllArgsConstructor;\nimport lombok.Data;\nimport lombok.extern.slf4j.Slf4j;\n\nimport java.nio.ByteBuffer;\nimport java.nio.charset.Charset;\n\n@Slf4j\npublic class TestPipeline &#123;\n    public static void main(String[] args) &#123;\n        new ServerBootstrap()\n                .group(new NioEventLoopGroup())\n                .channel(NioServerSocketChannel.class)\n                .childHandler(new ChannelInitializer&lt;NioSocketChannel&gt;() &#123;\n                    @Override\n                    protected void initChannel(NioSocketChannel ch) throws Exception &#123;\n                        &#x2F;&#x2F; 1. é€šè¿‡ channel æ‹¿åˆ° pipeline\n                        ChannelPipeline pipeline &#x3D; ch.pipeline();\n                        &#x2F;&#x2F; 2. æ·»åŠ å¤„ç†å™¨ head -&gt;  h1 -&gt; h2 -&gt;  h4 -&gt; h3 -&gt; h5 -&gt; h6 -&gt; tail\n                        pipeline.addLast(&quot;h1&quot;, new ChannelInboundHandlerAdapter()&#123;\n                            @Override\n                            public void channelRead(ChannelHandlerContext ctx, Object msg) throws Exception &#123;\n                                log.debug(&quot;1&quot;);\n                                ByteBuf buf &#x3D; (ByteBuf) msg;\n                                String name &#x3D; buf.toString(Charset.defaultCharset());&#x2F;&#x2F;ByteBuf2str\n                                super.channelRead(ctx, name);\n                            &#125;\n                        &#125;);\n\n                        pipeline.addLast(&quot;h2&quot;, new ChannelInboundHandlerAdapter()&#123;\n                            @Override\n                            public void channelRead(ChannelHandlerContext ctx, Object name) throws Exception &#123;\n                                log.debug(&quot;2&quot;);\n                                Student student &#x3D; new Student(name.toString());\n                                super.channelRead(ctx, student); &#x2F;&#x2F; å°†æ•°æ®ä¼ é€’ç»™ä¸‹ä¸ª Inboundhandlerï¼Œå¦‚æœä¸è°ƒç”¨ï¼Œè°ƒç”¨é“¾ä¼šæ–­å¼€ æˆ–è€…è°ƒç”¨ ctx.fireChannelRead(student);\n                            &#125;\n                        &#125;);\n                        &#x2F;&#x2F;åªæœ‰å‘channelé‡Œå†™äº†æ•°æ®writeAndFlushï¼Œæ‰ä¼šè§¦å‘ å‡ºç«™Handler ã€å¤„ç†æ•°æ®ã€‘ 123 | 654\n                        pipeline.addLast(&quot;h4&quot;, new ChannelOutboundHandlerAdapter()&#123;\n                            @Override\n                            public void write(ChannelHandlerContext ctx, Object msg, ChannelPromise promise) throws Exception &#123;\n                                log.debug(&quot;4&quot;);\n                                super.write(ctx, msg, promise);\n                            &#125;\n                        &#125;);\n\n                        pipeline.addLast(&quot;h3&quot;, new ChannelInboundHandlerAdapter()&#123;\n                            @Override\n                            public void channelRead(ChannelHandlerContext ctx, Object msg) throws Exception &#123;\n                                log.debug(&quot;3, ç»“æœ&#123;&#125;, class:&#123;&#125;&quot;, msg, msg.getClass());\n&#x2F;&#x2F;                                ctx.writeAndFlush(ctx.alloc().buffer().writeBytes(&quot;server...&quot;.getBytes()));&#x2F;&#x2F;ä»ã€å½“å‰handlerå¼€å§‹å€’ç€æ‰¾outï¼š1243ã€‘\n                                ch.writeAndFlush(ctx.alloc().buffer().writeBytes(&quot;server...&quot;.getBytes()));&#x2F;&#x2F;ä»tailå¼€å§‹å€’ç€æ‰¾out     str2ByteBuf\n                            &#125;\n                        &#125;);\n\n                        pipeline.addLast(&quot;h5&quot;, new ChannelOutboundHandlerAdapter()&#123;\n                            @Override\n                            public void write(ChannelHandlerContext ctx, Object msg, ChannelPromise promise) throws Exception &#123;\n                                log.debug(&quot;5&quot;);\n                                super.write(ctx, msg, promise);\n                            &#125;\n                        &#125;);\n                        pipeline.addLast(&quot;h6&quot;, new ChannelOutboundHandlerAdapter()&#123;\n                            @Override\n                            public void write(ChannelHandlerContext ctx, Object msg, ChannelPromise promise) throws Exception &#123;\n                                log.debug(&quot;6&quot;);\n                                super.write(ctx, msg, promise);&#x2F;&#x2F;&#x3D;ctx.write(msg, promise); ä»cur\n&#x2F;&#x2F;                                ctx.channel().write(msg, promise); &#x2F;&#x2F; ä»tailï¼š 12366666...æ­»å¾ªç¯ï¼é¿å…outç”¨channelå†™ï¼ï¼ï¼\n                            &#125;\n                        &#125;);\n                    &#125;\n                &#125;)\n                .bind(8080);\n    &#125;\n    @Data\n    @AllArgsConstructor\n    static class Student &#123;\n        private String name;\n    &#125;\n&#125;\n</code></pre>\n\n<p>TestEmbeddedChannel</p>\n<pre class=\"line-numbers language-java\" data-language=\"java\"><code class=\"language-java\">EmbeddedChannel channel &#x3D; new EmbeddedChannel(h1, h2, h3, h4);&#x2F;&#x2F;ç”¨äºå¿«æ·æµ‹è¯•handleræ•ˆæœï¼\n        &#x2F;&#x2F; æ¨¡æ‹Ÿå…¥ç«™æ“ä½œ 12\n&#x2F;&#x2F;        channel.writeInbound(ByteBufAllocator.DEFAULT.buffer().writeBytes(&quot;hello&quot;.getBytes()));\n        &#x2F;&#x2F; æ¨¡æ‹Ÿå‡ºç«™æ“ä½œ 43\n        channel.writeOutbound(ByteBufAllocator.DEFAULT.buffer().writeBytes(&quot;world&quot;.getBytes()));</code></pre>\n\n\n\n<h3 id=\"3-5-ByteBuf\"><a href=\"#3-5-ByteBuf\" class=\"headerlink\" title=\"3.5 ByteBuf\"></a>3.5 ByteBuf</h3><p>æ˜¯å¯¹å­—èŠ‚æ•°æ®çš„å°è£…</p>\n<h4 id=\"1ï¼‰åˆ›å»º\"><a href=\"#1ï¼‰åˆ›å»º\" class=\"headerlink\" title=\"1ï¼‰åˆ›å»º\"></a>1ï¼‰åˆ›å»º</h4><pre class=\"line-numbers language-java\" data-language=\"java\"><code class=\"language-java\">ByteBuf buffer &#x3D; ByteBufAllocator.DEFAULT.buffer(10);\nlog(buffer);</code></pre>\n\n<p>ä¸Šé¢ä»£ç åˆ›å»ºäº†ä¸€ä¸ªé»˜è®¤çš„ ByteBufï¼ˆæ± åŒ–åŸºäºç›´æ¥å†…å­˜çš„ ByteBufï¼‰ï¼Œåˆå§‹å®¹é‡æ˜¯ 10</p>\n<p>è¾“å‡º</p>\n<pre class=\"line-numbers language-none\"><code class=\"language-none\">read index:0 write index:0 capacity:10</code></pre>\n\n<p>å…¶ä¸­ log æ–¹æ³•å‚è€ƒå¦‚ä¸‹</p>\n<pre class=\"line-numbers language-java\" data-language=\"java\"><code class=\"language-java\">private static void log(ByteBuf buffer) &#123;\n    int length &#x3D; buffer.readableBytes();\n    int rows &#x3D; length &#x2F; 16 + (length % 15 &#x3D;&#x3D; 0 ? 0 : 1) + 4;\n    StringBuilder buf &#x3D; new StringBuilder(rows * 80 * 2)\n        .append(&quot;read index:&quot;).append(buffer.readerIndex())\n        .append(&quot; write index:&quot;).append(buffer.writerIndex())\n        .append(&quot; capacity:&quot;).append(buffer.capacity())\n        .append(NEWLINE);\n    appendPrettyHexDump(buf, buffer);\n    System.out.println(buf.toString());\n&#125;</code></pre>\n\n\n\n<h4 id=\"2ï¼‰ç›´æ¥å†…å­˜-vs-å †å†…å­˜\"><a href=\"#2ï¼‰ç›´æ¥å†…å­˜-vs-å †å†…å­˜\" class=\"headerlink\" title=\"2ï¼‰ç›´æ¥å†…å­˜ vs å †å†…å­˜\"></a>2ï¼‰ç›´æ¥å†…å­˜ vs å †å†…å­˜</h4><p>å¯ä»¥ä½¿ç”¨ä¸‹é¢çš„ä»£ç æ¥åˆ›å»ºæ± åŒ–åŸºäºå †çš„ ByteBuf</p>\n<pre class=\"line-numbers language-java\" data-language=\"java\"><code class=\"language-java\">ByteBuf buffer &#x3D; ByteBufAllocator.DEFAULT.heapBuffer(10);</code></pre>\n\n<p>ä¹Ÿå¯ä»¥ä½¿ç”¨ä¸‹é¢çš„ä»£ç æ¥åˆ›å»ºæ± åŒ–åŸºäºç›´æ¥å†…å­˜çš„ ByteBuf</p>\n<pre class=\"line-numbers language-java\" data-language=\"java\"><code class=\"language-java\">ByteBuf buffer &#x3D; ByteBufAllocator.DEFAULT.directBuffer(10);</code></pre>\n\n<ul>\n<li>&#x3D;&#x3D;<strong>ç›´æ¥å†…å­˜åˆ›å»ºå’Œé”€æ¯çš„ä»£ä»·æ˜‚è´µï¼Œä½†è¯»å†™æ€§èƒ½é«˜</strong>ï¼ˆå°‘ä¸€æ¬¡å†…å­˜å¤åˆ¶ï¼‰ï¼Œ<strong>é€‚åˆé…åˆæ± åŒ–åŠŸèƒ½ä¸€èµ·ç”¨</strong>&#x3D;&#x3D;</li>\n<li>ç›´æ¥å†…å­˜<strong>å¯¹ GC å‹åŠ›å°</strong>ï¼Œå› ä¸ºè¿™éƒ¨åˆ†å†…å­˜ä¸å— JVM åƒåœ¾å›æ”¶çš„ç®¡ç†ï¼Œä½†ä¹Ÿè¦<strong>æ³¨æ„åŠæ—¶ä¸»åŠ¨é‡Šæ”¾</strong></li>\n</ul>\n<h4 id=\"3ï¼‰æ± åŒ–-vs-éæ± åŒ–\"><a href=\"#3ï¼‰æ± åŒ–-vs-éæ± åŒ–\" class=\"headerlink\" title=\"3ï¼‰æ± åŒ– vs éæ± åŒ–\"></a>3ï¼‰æ± åŒ– vs éæ± åŒ–</h4><p>æ± åŒ–çš„æœ€å¤§æ„ä¹‰åœ¨äºå¯ä»¥é‡ç”¨ ByteBufï¼Œä¼˜ç‚¹æœ‰</p>\n<ul>\n<li><strong>æ²¡æœ‰æ± åŒ–</strong>ï¼Œåˆ™ã€æ¯æ¬¡éƒ½å¾—åˆ›å»ºæ–°çš„ ByteBuf å®ä¾‹ã€‘ï¼Œè¿™ä¸ªæ“ä½œã€å¯¹ç›´æ¥å†…å­˜<strong>ä»£ä»·æ˜‚è´µ</strong>ï¼Œå°±ç®—æ˜¯å †å†…å­˜ï¼Œä¹Ÿä¼š<strong>å¢åŠ  GC å‹åŠ›</strong>ã€‘</li>\n<li>æœ‰äº†æ± åŒ–ï¼Œåˆ™å¯ä»¥<strong>é‡ç”¨æ± ä¸­ ByteBuf å®ä¾‹ï¼Œå¹¶ä¸”é‡‡ç”¨äº†ä¸ jemalloc ç±»ä¼¼çš„å†…å­˜åˆ†é…ç®—æ³•æå‡åˆ†é…æ•ˆç‡</strong></li>\n<li><strong>é«˜å¹¶å‘</strong>æ—¶ï¼Œæ± åŒ–åŠŸèƒ½<strong>æ›´èŠ‚çº¦å†…å­˜ï¼Œå‡å°‘å†…å­˜æº¢å‡ºçš„å¯èƒ½</strong></li>\n</ul>\n<p>æ± åŒ–åŠŸèƒ½æ˜¯å¦å¼€å¯ï¼Œå¯ä»¥é€šè¿‡ä¸‹é¢çš„<strong>ç³»ç»Ÿç¯å¢ƒå˜é‡</strong>æ¥è®¾ç½®</p>\n<pre class=\"line-numbers language-java\" data-language=\"java\"><code class=\"language-java\">-Dio.netty.allocator.type&#x3D;&#123;unpooled|pooled&#125;</code></pre>\n\n<ul>\n<li><strong>4.1 ä»¥åï¼Œé Android å¹³å°é»˜è®¤å¯ç”¨æ± åŒ–å®ç°ï¼ŒAndroid å¹³å°å¯ç”¨éæ± åŒ–å®ç°</strong></li>\n<li>4.1 ä¹‹å‰ï¼Œæ± åŒ–åŠŸèƒ½è¿˜ä¸æˆç†Ÿï¼Œé»˜è®¤æ˜¯éæ± åŒ–å®ç°</li>\n</ul>\n<pre class=\"line-numbers language-java\" data-language=\"java\"><code class=\"language-java\">public class TestByteBuf &#123;\n    public static void main(String[] args) &#123;\n        &#x2F;&#x2F;VM option:-Dio.netty.allocator.type&#x3D;unpooled\n        ByteBuf buf &#x3D; ByteBufAllocator.DEFAULT.buffer();&#x2F;&#x2F;é»˜è®¤256 ByteBufå¯æ‰©å®¹\n        System.out.println(buf.getClass());&#x2F;&#x2F;\n        System.out.println(buf.maxCapacity());&#x2F;&#x2F;2^31-1&#x3D;Integer.Max_VALUE\n        log(buf);\n        StringBuilder sb &#x3D; new StringBuilder();\n        for (int i &#x3D; 0; i &lt; 257; i++) &#123;&#x2F;&#x2F;\n            sb.append(&quot;a&quot;);\n        &#125;\n        buf.writeBytes(sb.toString().getBytes());\n        log(buf);\n    &#125;\n&#125;\n\nclass io.netty.buffer.PooledUnsafeDirectByteBuf\n2147483647\nread index:0 write index:0 capacity:256\nread index:0 write index:257 capacity:512</code></pre>\n\n\n\n<h4 id=\"4ï¼‰ç»„æˆ\"><a href=\"#4ï¼‰ç»„æˆ\" class=\"headerlink\" title=\"4ï¼‰ç»„æˆ\"></a>4ï¼‰ç»„æˆ</h4><p>ByteBuf ç”±å››éƒ¨åˆ†ç»„æˆ</p>\n<p><img src=\"http://cache.itzy8.top/%E5%AD%A6Netty-%E9%BB%91%E9%A9%AC%E6%BB%A1%E5%93%A5/0010.png\"></p>\n<p>æœ€å¼€å§‹è¯»å†™æŒ‡é’ˆéƒ½åœ¨ 0 ä½ç½®</p>\n<p>flip compactâ€“&gt;Ridx Widx å¯æ‰©å®¹</p>\n<h4 id=\"5ï¼‰å†™å…¥\"><a href=\"#5ï¼‰å†™å…¥\" class=\"headerlink\" title=\"5ï¼‰å†™å…¥\"></a>5ï¼‰å†™å…¥</h4><p>æ–¹æ³•åˆ—è¡¨ï¼Œçœç•¥ä¸€äº›ä¸é‡è¦çš„æ–¹æ³•</p>\n<table>\n<thead>\n<tr>\n<th>æ–¹æ³•ç­¾å</th>\n<th>å«ä¹‰</th>\n<th>å¤‡æ³¨</th>\n</tr>\n</thead>\n<tbody><tr>\n<td>writeBoolean(boolean value)</td>\n<td>å†™å…¥ boolean å€¼</td>\n<td>ç”¨ä¸€å­—èŠ‚ 01|00 ä»£è¡¨ true|false</td>\n</tr>\n<tr>\n<td>writeByte(int value)</td>\n<td>å†™å…¥ byte å€¼</td>\n<td></td>\n</tr>\n<tr>\n<td>writeShort(int value)</td>\n<td>å†™å…¥ short å€¼</td>\n<td></td>\n</tr>\n<tr>\n<td>writeInt(int value)</td>\n<td>å†™å…¥ int å€¼</td>\n<td>Big Endianï¼Œå³ 0x250ï¼Œå†™å…¥å 00 00 02 50 ã€é«˜-ä½ã€‘</td>\n</tr>\n<tr>\n<td><strong>writeIntLE</strong>(int value)</td>\n<td>å†™å…¥ int å€¼</td>\n<td><strong>Little Endian</strong>ï¼Œå³ 0x250ï¼Œå†™å…¥å 50 02 00 00</td>\n</tr>\n<tr>\n<td>writeLong(long value)</td>\n<td>å†™å…¥ long å€¼</td>\n<td></td>\n</tr>\n<tr>\n<td>writeChar(int value)</td>\n<td>å†™å…¥ char å€¼</td>\n<td></td>\n</tr>\n<tr>\n<td>writeFloat(float value)</td>\n<td>å†™å…¥ float å€¼</td>\n<td></td>\n</tr>\n<tr>\n<td>writeDouble(double value)</td>\n<td>å†™å…¥ double å€¼</td>\n<td></td>\n</tr>\n<tr>\n<td>writeBytes(ByteBuf src)</td>\n<td>å†™å…¥ netty çš„ ByteBuf</td>\n<td></td>\n</tr>\n<tr>\n<td>writeBytes(byte[] src)</td>\n<td>å†™å…¥ byte[]</td>\n<td></td>\n</tr>\n<tr>\n<td>writeBytes(ByteBuffer src)</td>\n<td>å†™å…¥ nio çš„ ByteBuffer</td>\n<td></td>\n</tr>\n<tr>\n<td>int writeCharSequence(CharSequence sequence, Charset charset)</td>\n<td>å†™å…¥å­—ç¬¦ä¸²</td>\n<td>String StringBuffer StringBuilder çš„çˆ¶ç±»ï¼</td>\n</tr>\n</tbody></table>\n<blockquote><span class=\"custom-blockquote-svg\"><svg width=\"24\" height=\"24\" viewBox=\"0 0 24 24\" fill=\"\" xmlns=\"http://www.w3.org/2000/svg\" data-reactroot=\"\">\n<path fill=\"\" d=\"M22 12C22 6.5 17.5 2 12 2C6.5 2 2 6.5 2 12C2 17.5 6.5 22 12 22C13.8 22 15.5 21.5 17 20.6L22 22L20.7 17C21.5 15.5 22 13.8 22 12Z\" undefined=\"1\"></path>\n<path fill=\"\" d=\"M15.97 11.5H16.04C17.12 11.5 18 12.38 18 13.47V13.53C18 14.62 17.12 15.5 16.03 15.5H15.96C14.88 15.5 14 14.62 14 13.53V13.46C14 12.38 14.88 11.5 15.97 11.5Z\" undefined=\"1\"></path>\n<path fill=\"\" d=\"M7.97 11.5H8.04C9.12 11.5 10 12.38 10 13.47V13.53C10 14.62 9.12 15.5 8.03 15.5H7.97C6.88 15.5 6 14.62 6 13.53V13.46C6 12.38 6.88 11.5 7.97 11.5Z\" undefined=\"1\"></path>\n<path stroke-linejoin=\"round\" stroke-linecap=\"round\" stroke-miterlimit=\"10\" stroke-width=\"2\" stroke=\"\" d=\"M17 8.5C15.23 8.97 14.07 10.84 14.01 13.27C14 13.33 14 13.4 14 13.47V13.5\"></path>\n<path stroke-linejoin=\"round\" stroke-linecap=\"round\" stroke-miterlimit=\"10\" stroke-width=\"2\" stroke=\"\" d=\"M9 8.5C7.23 8.97 6.07 10.84 6.01 13.27C6 13.33 6 13.4 6 13.47V13.5\"></path>\n<path stroke-linejoin=\"round\" stroke-linecap=\"round\" stroke-miterlimit=\"10\" stroke-width=\"2\" stroke=\"\" d=\"M15.97 11.5H16.04C17.12 11.5 18 12.38 18 13.47V13.53C18 14.62 17.12 15.5 16.03 15.5H15.96C14.88 15.5 14 14.62 14 13.53V13.46C14 12.38 14.88 11.5 15.97 11.5Z\"></path>\n<path stroke-linejoin=\"round\" stroke-linecap=\"round\" stroke-miterlimit=\"10\" stroke-width=\"2\" stroke=\"\" d=\"M7.97 11.5H8.04C9.12 11.5 10 12.38 10 13.47V13.53C10 14.62 9.12 15.5 8.03 15.5H7.97C6.88 15.5 6 14.62 6 13.53V13.46C6 12.38 6.88 11.5 7.97 11.5Z\"></path>\n</svg>\n</span><p> æ³¨æ„</p>\n<ul>\n<li>è¿™äº›æ–¹æ³•çš„æœªæŒ‡æ˜è¿”å›å€¼çš„ï¼Œå…¶<strong>è¿”å›å€¼éƒ½æ˜¯ ByteBufï¼Œæ„å‘³ç€å¯ä»¥é“¾å¼è°ƒç”¨</strong></li>\n<li><strong>ç½‘ç»œä¼ è¾“ï¼Œé»˜è®¤ä¹ æƒ¯æ˜¯ Big Endian</strong></li>\n</ul></blockquote>\n<p>å…ˆå†™å…¥ 4 ä¸ªå­—èŠ‚</p>\n<pre class=\"line-numbers language-java\" data-language=\"java\"><code class=\"language-java\">buffer.writeBytes(new byte[]&#123;1, 2, 3, 4&#125;);\nlog(buffer);</code></pre>\n\n<p>ç»“æœæ˜¯</p>\n<pre class=\"line-numbers language-none\"><code class=\"language-none\">read index:0 write index:4 capacity:10\n         +-------------------------------------------------+\n         |  0  1  2  3  4  5  6  7  8  9  a  b  c  d  e  f |\n+--------+-------------------------------------------------+----------------+\n|00000000| 01 02 03 04                                     |....            |\n+--------+-------------------------------------------------+----------------+</code></pre>\n\n<p>å†å†™å…¥ä¸€ä¸ª <strong>int æ•´æ•°ï¼Œä¹Ÿæ˜¯ 4 ä¸ªå­—èŠ‚</strong></p>\n<pre class=\"line-numbers language-java\" data-language=\"java\"><code class=\"language-java\">buffer.writeInt(5);\nlog(buffer);</code></pre>\n\n<p>ç»“æœæ˜¯</p>\n<pre class=\"line-numbers language-none\"><code class=\"language-none\">read index:0 write index:8 capacity:10\n         +-------------------------------------------------+\n         |  0  1  2  3  4  5  6  7  8  9  a  b  c  d  e  f |\n+--------+-------------------------------------------------+----------------+\n|00000000| 01 02 03 04 00 00 00 05                         |........        |\n+--------+-------------------------------------------------+----------------+</code></pre>\n\n\n\n<p>è¿˜æœ‰ä¸€ç±»æ–¹æ³•æ˜¯ <strong>set å¼€å¤´çš„ä¸€ç³»åˆ—æ–¹æ³•ï¼Œä¹Ÿå¯ä»¥å†™å…¥</strong>æ•°æ®ï¼Œ<strong>ä½†ä¸ä¼šæ”¹å˜å†™æŒ‡é’ˆä½ç½®</strong></p>\n<h4 id=\"6ï¼‰æ‰©å®¹\"><a href=\"#6ï¼‰æ‰©å®¹\" class=\"headerlink\" title=\"6ï¼‰æ‰©å®¹\"></a>6ï¼‰æ‰©å®¹</h4><p>å†å†™å…¥ä¸€ä¸ª int æ•´æ•°æ—¶ï¼Œå®¹é‡ä¸å¤Ÿäº†ï¼ˆåˆå§‹å®¹é‡æ˜¯ 10ï¼‰ï¼Œè¿™æ—¶ä¼šå¼•å‘æ‰©å®¹</p>\n<pre class=\"line-numbers language-java\" data-language=\"java\"><code class=\"language-java\">buffer.writeInt(6);\nlog(buffer);</code></pre>\n\n<p>æ‰©å®¹è§„åˆ™æ˜¯</p>\n<ul>\n<li>å¦‚æœ<strong>å†™å…¥åæ•°æ®å¤§å°æœªè¶…è¿‡ 512ï¼Œåˆ™é€‰æ‹©ä¸‹ä¸€ä¸ª 16 çš„æ•´æ•°å€</strong>ï¼Œä¾‹å¦‚å†™å…¥åå¤§å°ä¸º 12 ï¼Œåˆ™æ‰©å®¹å capacity æ˜¯ 16</li>\n<li>å¦‚æœ<strong>å†™å…¥åæ•°æ®å¤§å°è¶…è¿‡ 512ï¼Œåˆ™é€‰æ‹©ä¸‹ä¸€ä¸ª 2^n</strong>ï¼Œä¾‹å¦‚å†™å…¥åå¤§å°ä¸º 513ï¼Œåˆ™æ‰©å®¹å capacity æ˜¯ 2^10&#x3D;1024ï¼ˆ2^9&#x3D;512 å·²ç»ä¸å¤Ÿäº†ï¼‰</li>\n<li>æ‰©å®¹ä¸èƒ½<strong>è¶…è¿‡ max capacity ä¼šæŠ¥é”™</strong></li>\n</ul>\n<p>ç»“æœæ˜¯</p>\n<pre class=\"line-numbers language-none\"><code class=\"language-none\">read index:0 write index:12 capacity:16\n         +-------------------------------------------------+\n         |  0  1  2  3  4  5  6  7  8  9  a  b  c  d  e  f |\n+--------+-------------------------------------------------+----------------+\n|00000000| 01 02 03 04 00 00 00 05 00 00 00 06             |............    |\n+--------+-------------------------------------------------+----------------+</code></pre>\n\n\n\n<h4 id=\"7ï¼‰è¯»å–\"><a href=\"#7ï¼‰è¯»å–\" class=\"headerlink\" title=\"7ï¼‰è¯»å–\"></a>7ï¼‰è¯»å–</h4><p>ä¾‹å¦‚è¯»äº† 4 æ¬¡ï¼Œæ¯æ¬¡ä¸€ä¸ªå­—èŠ‚</p>\n<pre class=\"line-numbers language-java\" data-language=\"java\"><code class=\"language-java\">System.out.println(buffer.readByte());\nSystem.out.println(buffer.readByte());\nSystem.out.println(buffer.readByte());\nSystem.out.println(buffer.readByte());\nlog(buffer);</code></pre>\n\n<p>è¯»è¿‡çš„å†…å®¹ï¼Œå°±å±äºåºŸå¼ƒéƒ¨åˆ†äº†ï¼Œå†è¯»åªèƒ½è¯»é‚£äº›å°šæœªè¯»å–çš„éƒ¨åˆ†</p>\n<pre class=\"line-numbers language-none\"><code class=\"language-none\">1\n2\n3\n4\nread index:4 write index:12 capacity:16\n         +-------------------------------------------------+\n         |  0  1  2  3  4  5  6  7  8  9  a  b  c  d  e  f |\n+--------+-------------------------------------------------+----------------+\n|00000000| 00 00 00 05 00 00 00 06                         |........        |\n+--------+-------------------------------------------------+----------------+</code></pre>\n\n<p>å¦‚æœ<strong>éœ€è¦é‡å¤è¯»å– int æ•´æ•° 5</strong>ï¼Œæ€ä¹ˆåŠï¼Ÿ</p>\n<p>å¯ä»¥åœ¨ read å‰å…ˆåšä¸ªæ ‡è®° <strong>mark</strong></p>\n<pre class=\"line-numbers language-java\" data-language=\"java\"><code class=\"language-java\">buffer.markReaderIndex();&#x2F;&#x2F;\nSystem.out.println(buffer.readInt());\nlog(buffer);</code></pre>\n\n<p>ç»“æœ</p>\n<pre class=\"line-numbers language-none\"><code class=\"language-none\">5\nread index:8 write index:12 capacity:16\n         +-------------------------------------------------+\n         |  0  1  2  3  4  5  6  7  8  9  a  b  c  d  e  f |\n+--------+-------------------------------------------------+----------------+\n|00000000| 00 00 00 06                                     |....            |\n+--------+-------------------------------------------------+----------------+</code></pre>\n\n<p>è¿™æ—¶è¦é‡å¤è¯»å–çš„è¯ï¼Œé‡ç½®åˆ°æ ‡è®°ä½ç½® <strong>reset</strong></p>\n<pre class=\"line-numbers language-java\" data-language=\"java\"><code class=\"language-java\">buffer.resetReaderIndex();&#x2F;&#x2F;\nlog(buffer);</code></pre>\n\n<p>è¿™æ—¶</p>\n<pre class=\"line-numbers language-none\"><code class=\"language-none\">read index:4 write index:12 capacity:16\n         +-------------------------------------------------+\n         |  0  1  2  3  4  5  6  7  8  9  a  b  c  d  e  f |\n+--------+-------------------------------------------------+----------------+\n|00000000| 00 00 00 05 00 00 00 06                         |........        |\n+--------+-------------------------------------------------+----------------+</code></pre>\n\n<p>è¿˜æœ‰ç§åŠæ³•æ˜¯<strong>é‡‡ç”¨ get å¼€å¤´çš„ä¸€ç³»åˆ—æ–¹æ³•ï¼Œè¿™äº›æ–¹æ³•ä¸ä¼šæ”¹å˜ read index</strong></p>\n<p>&#x3D;&#x3D;write read &#x2F; set get&#x3D;&#x3D;</p>\n<h4 id=\"8ï¼‰retain-amp-release\"><a href=\"#8ï¼‰retain-amp-release\" class=\"headerlink\" title=\"8ï¼‰retain &amp; release\"></a>8ï¼‰retain &amp; release</h4><p>ç”±äº Netty ä¸­æœ‰å †å¤–å†…å­˜çš„ ByteBuf å®ç°ï¼Œå †å¤–å†…å­˜æœ€å¥½æ˜¯æ‰‹åŠ¨æ¥é‡Šæ”¾ï¼Œè€Œä¸æ˜¯ç­‰ GC åƒåœ¾å›æ”¶ã€‚</p>\n<ul>\n<li>UnpooledHeapByteBuf ä½¿ç”¨çš„æ˜¯ JVM å†…å­˜ï¼Œåªéœ€<strong>ç­‰ GC</strong> å›æ”¶å†…å­˜å³å¯</li>\n<li>UnpooledDirectByteBuf ä½¿ç”¨çš„å°±æ˜¯ç›´æ¥å†…å­˜äº†ï¼Œéœ€è¦<strong>ç‰¹æ®Šçš„æ–¹æ³•æ¥å›æ”¶</strong>å†…å­˜</li>\n<li>PooledByteBuf å’Œå®ƒçš„å­ç±»ä½¿ç”¨äº†æ± åŒ–æœºåˆ¶ï¼Œéœ€è¦<strong>æ›´å¤æ‚çš„è§„åˆ™æ¥å›æ”¶</strong>å†…å­˜ã€è¿˜å›å†…å­˜æ± ï¼ã€‘</li>\n</ul>\n<blockquote><span class=\"custom-blockquote-svg\"><svg width=\"24\" height=\"24\" viewBox=\"0 0 24 24\" fill=\"\" xmlns=\"http://www.w3.org/2000/svg\" data-reactroot=\"\">\n<path fill=\"\" d=\"M22 12C22 6.5 17.5 2 12 2C6.5 2 2 6.5 2 12C2 17.5 6.5 22 12 22C13.8 22 15.5 21.5 17 20.6L22 22L20.7 17C21.5 15.5 22 13.8 22 12Z\" undefined=\"1\"></path>\n<path fill=\"\" d=\"M15.97 11.5H16.04C17.12 11.5 18 12.38 18 13.47V13.53C18 14.62 17.12 15.5 16.03 15.5H15.96C14.88 15.5 14 14.62 14 13.53V13.46C14 12.38 14.88 11.5 15.97 11.5Z\" undefined=\"1\"></path>\n<path fill=\"\" d=\"M7.97 11.5H8.04C9.12 11.5 10 12.38 10 13.47V13.53C10 14.62 9.12 15.5 8.03 15.5H7.97C6.88 15.5 6 14.62 6 13.53V13.46C6 12.38 6.88 11.5 7.97 11.5Z\" undefined=\"1\"></path>\n<path stroke-linejoin=\"round\" stroke-linecap=\"round\" stroke-miterlimit=\"10\" stroke-width=\"2\" stroke=\"\" d=\"M17 8.5C15.23 8.97 14.07 10.84 14.01 13.27C14 13.33 14 13.4 14 13.47V13.5\"></path>\n<path stroke-linejoin=\"round\" stroke-linecap=\"round\" stroke-miterlimit=\"10\" stroke-width=\"2\" stroke=\"\" d=\"M9 8.5C7.23 8.97 6.07 10.84 6.01 13.27C6 13.33 6 13.4 6 13.47V13.5\"></path>\n<path stroke-linejoin=\"round\" stroke-linecap=\"round\" stroke-miterlimit=\"10\" stroke-width=\"2\" stroke=\"\" d=\"M15.97 11.5H16.04C17.12 11.5 18 12.38 18 13.47V13.53C18 14.62 17.12 15.5 16.03 15.5H15.96C14.88 15.5 14 14.62 14 13.53V13.46C14 12.38 14.88 11.5 15.97 11.5Z\"></path>\n<path stroke-linejoin=\"round\" stroke-linecap=\"round\" stroke-miterlimit=\"10\" stroke-width=\"2\" stroke=\"\" d=\"M7.97 11.5H8.04C9.12 11.5 10 12.38 10 13.47V13.53C10 14.62 9.12 15.5 8.03 15.5H7.97C6.88 15.5 6 14.62 6 13.53V13.46C6 12.38 6.88 11.5 7.97 11.5Z\"></path>\n</svg>\n</span><p>å›æ”¶å†…å­˜çš„æºç å®ç°ï¼Œè¯·å…³æ³¨ä¸‹é¢æ–¹æ³•çš„ä¸åŒå®ç°</p>\n<p><code>protected abstract void deallocate()</code></p></blockquote>\n<p>Netty è¿™é‡Œé‡‡ç”¨äº†**&#x3D;&#x3D;å¼•ç”¨è®¡æ•°æ³•&#x3D;&#x3D;æ¥æ§åˆ¶å›æ”¶**å†…å­˜ï¼Œæ¯ä¸ª <strong>ByteBuf éƒ½å®ç°äº† ReferenceCounted æ¥å£</strong></p>\n<ul>\n<li>æ¯ä¸ª ByteBuf å¯¹è±¡çš„<strong>åˆå§‹è®¡æ•°ä¸º 1</strong></li>\n<li>è°ƒç”¨ <strong>release</strong> æ–¹æ³•è®¡æ•°å‡ 1ï¼Œå¦‚æœè®¡æ•°ä¸º 0ï¼ŒByteBuf å†…å­˜è¢«å›æ”¶</li>\n<li>è°ƒç”¨ <strong>retain</strong> æ–¹æ³•è®¡æ•°åŠ  1ï¼Œè¡¨ç¤ºè°ƒç”¨è€…æ²¡ç”¨å®Œä¹‹å‰ï¼Œå…¶å®ƒ handler å³ä½¿è°ƒç”¨äº† release ä¹Ÿä¸ä¼šé€ æˆå›æ”¶</li>\n<li>å½“è®¡æ•°ä¸º <strong>0 æ—¶ï¼Œã€åº•å±‚å†…å­˜ä¼šè¢«å›æ”¶ï¼šè§&#x3D;&#x3D;deallocate()ä¸åŒå®ç°æ–¹å¼&#x3D;&#x3D;ã€‘ï¼Œè¿™æ—¶å³ä½¿ ByteBuf å¯¹è±¡è¿˜åœ¨ï¼Œå…¶å„ä¸ªã€æ–¹æ³•å‡æ— æ³•æ­£å¸¸ä½¿ç”¨ã€‘</strong></li>\n</ul>\n<p>è°æ¥è´Ÿè´£ release å‘¢ï¼Ÿ</p>\n<p>ä¸æ˜¯æˆ‘ä»¬æƒ³è±¡çš„ï¼ˆä¸€èˆ¬æƒ…å†µä¸‹ï¼‰</p>\n<pre class=\"line-numbers language-java\" data-language=\"java\"><code class=\"language-java\">ByteBuf buf &#x3D; ...\ntry &#123;\n    ...\n&#125; finally &#123;\n    buf.release();\n&#125;</code></pre>\n\n<p>è¯·æ€è€ƒï¼Œå› ä¸º pipeline çš„å­˜åœ¨ï¼Œä¸€èˆ¬éœ€è¦å°† ByteBuf ä¼ é€’ç»™ä¸‹ä¸€ä¸ª ChannelHandlerï¼Œå¦‚æœåœ¨ finally ä¸­ release äº†ï¼Œå°±å¤±å»äº†ä¼ é€’æ€§ï¼ˆå½“ç„¶ï¼Œå¦‚æœåœ¨è¿™ä¸ª ChannelHandler å†…è¿™ä¸ª ByteBuf å·²å®Œæˆäº†å®ƒçš„ä½¿å‘½ï¼Œé‚£ä¹ˆä¾¿æ— é¡»å†ä¼ é€’ï¼‰</p>\n<p>åŸºæœ¬è§„åˆ™æ˜¯ï¼Œ**è°æ˜¯&#x3D;&#x3D;æœ€åä½¿ç”¨è€…ï¼Œè°è´Ÿè´£ release&#x3D;&#x3D;**ï¼Œè¯¦ç»†åˆ†æå¦‚ä¸‹</p>\n<ul>\n<li>èµ·ç‚¹ï¼Œå¯¹äº NIO å®ç°æ¥è®²ï¼Œåœ¨ io.netty.channel.nio.AbstractNioByteChannel.NioByteUnsafe#read æ–¹æ³•ä¸­é¦–æ¬¡åˆ›å»º ByteBuf æ”¾å…¥ pipelineï¼ˆline 163 pipeline.fireChannelRead(byteBuf)ï¼‰</li>\n<li>å…¥ç«™ ByteBuf å¤„ç†åŸåˆ™<ul>\n<li>å¯¹åŸå§‹ ByteBuf ã€ä¸åšå¤„ç†ï¼Œè°ƒç”¨ ctx.fireChannelRead(msg) å‘åä¼ é€’ï¼Œè¿™æ—¶æ— é¡» releaseã€‘</li>\n<li>å°†åŸå§‹ ByteBuf <strong>&#x3D;&#x3D;è½¬æ¢ä¸ºå…¶å®ƒç±»å‹çš„ Java å¯¹è±¡&#x3D;&#x3D;ï¼Œè¿™æ—¶ ByteBuf å°±æ²¡ç”¨äº†ï¼Œå¿…é¡» release</strong></li>\n<li>å¦‚æœ<strong>ä¸è°ƒç”¨ ctx.fireChannelRead(msg) å‘åä¼ é€’ï¼Œé‚£ä¹ˆä¹Ÿå¿…é¡» release</strong></li>\n<li>æ³¨æ„<strong>å„ç§å¼‚å¸¸</strong>ï¼Œå¦‚æœ ByteBuf æ²¡æœ‰æˆåŠŸä¼ é€’åˆ°ä¸‹ä¸€ä¸ª ChannelHandlerï¼Œå¿…é¡» release</li>\n<li>å‡è®¾æ¶ˆæ¯ä¸€ç›´å‘åä¼ ï¼Œé‚£ä¹ˆ <strong>TailContext ä¼šè´Ÿè´£é‡Šæ”¾æœªå¤„ç†æ¶ˆæ¯ï¼ˆåŸå§‹çš„ ByteBufï¼‰</strong></li>\n</ul>\n</li>\n<li>å‡ºç«™ ByteBuf å¤„ç†åŸåˆ™<ul>\n<li><strong>å‡ºç«™æ¶ˆæ¯æœ€ç»ˆéƒ½ä¼šè½¬ä¸º ByteBuf è¾“å‡ºï¼Œä¸€ç›´å‘å‰</strong>ä¼ ï¼Œç”± <strong>HeadContext flush å release</strong></li>\n</ul>\n</li>\n<li>å¼‚å¸¸å¤„ç†åŸåˆ™<ul>\n<li>æœ‰æ—¶å€™ã€ä¸æ¸…æ¥š ByteBuf è¢«å¼•ç”¨äº†å¤šå°‘æ¬¡ï¼Œä½†åˆå¿…é¡»å½»åº•é‡Šæ”¾ï¼Œå¯ä»¥<strong>å¾ªç¯è°ƒç”¨ release ç›´åˆ°è¿”å› true</strong>ã€‘</li>\n</ul>\n</li>\n</ul>\n<p>ä¼ åˆ°äº†é¦–å°¾ï¼Œhead&#x2F;tailæ‰é‡Šæ”¾ï¼›ä¼ ä¸åˆ°æˆ–ä¸ç”¨äº†ï¼Œå°±è¦è‡ªå·±é‡Šæ”¾ï¼ï¼ï¼</p>\n<p>TailContext é‡Šæ”¾æœªå¤„ç†æ¶ˆæ¯é€»è¾‘ï¼šå¼•ç”¨è®¡æ•°ed_msg.release()</p>\n<pre class=\"line-numbers language-java\" data-language=\"java\"><code class=\"language-java\">&#x2F;&#x2F; io.netty.channel.DefaultChannelPipeline#onUnhandledInboundMessage(java.lang.Object)\nprotected void onUnhandledInboundMessage(Object msg) &#123;\n    try &#123;\n        logger.debug(\n            &quot;Discarded inbound message &#123;&#125; that reached at the tail of the pipeline. &quot; +\n            &quot;Please check your pipeline configuration.&quot;, msg);\n    &#125; finally &#123;\n        ReferenceCountUtil.release(msg);\n    &#125;\n&#125;</code></pre>\n\n<p>å…·ä½“ä»£ç </p>\n<pre class=\"line-numbers language-java\" data-language=\"java\"><code class=\"language-java\">&#x2F;&#x2F; io.netty.util.ReferenceCountUtil#release(java.lang.Object)\npublic static boolean release(Object msg) &#123;\n    if (msg instanceof ReferenceCounted) &#123;\n        return ((ReferenceCounted) msg).release();\n    &#125;\n    return false;\n&#125;</code></pre>\n\n<p>HeadContext:</p>\n<p>ctrl+F12 write  ctrl+alt+é¼ æ ‡å·¦é”®ï¼šimplement\trelease() &#x2F; -&gt;<strong>outboundBuffer</strong>ï¼ï¼ï¼</p>\n<h4 id=\"9ï¼‰slice\"><a href=\"#9ï¼‰slice\" class=\"headerlink\" title=\"9ï¼‰slice\"></a>9ï¼‰slice</h4><p>ã€é›¶æ‹·è´ã€‘çš„ä½“ç°ä¹‹ä¸€ï¼Œå¯¹åŸå§‹ ByteBuf è¿›è¡Œåˆ‡ç‰‡æˆå¤šä¸ª ByteBufï¼Œ<strong>åˆ‡ç‰‡åçš„ ByteBuf å¹¶æ²¡æœ‰å‘ç”Ÿå†…å­˜å¤åˆ¶ï¼Œè¿˜æ˜¯ä½¿ç”¨åŸå§‹ ByteBuf çš„å†…å­˜ï¼Œåˆ‡ç‰‡åçš„ ByteBuf ç»´æŠ¤ç‹¬ç«‹çš„ readï¼Œwrite æŒ‡é’ˆ</strong></p>\n<p><img src=\"http://cache.itzy8.top/%E5%AD%A6Netty-%E9%BB%91%E9%A9%AC%E6%BB%A1%E5%93%A5/0011.png\"></p>\n<p>ä¾‹ï¼ŒåŸå§‹ ByteBuf è¿›è¡Œä¸€äº›åˆå§‹æ“ä½œ</p>\n<pre class=\"line-numbers language-java\" data-language=\"java\"><code class=\"language-java\">ByteBuf origin &#x3D; ByteBufAllocator.DEFAULT.buffer(10);\norigin.writeBytes(new byte[]&#123;1, 2, 3, 4&#125;);\norigin.readByte();&#x2F;&#x2F;\nSystem.out.println(ByteBufUtil.prettyHexDump(origin));</code></pre>\n\n<p>è¾“å‡º</p>\n<pre class=\"line-numbers language-none\"><code class=\"language-none\">         +-------------------------------------------------+\n         |  0  1  2  3  4  5  6  7  8  9  a  b  c  d  e  f |\n+--------+-------------------------------------------------+----------------+\n|00000000| 02 03 04                                        |...             |\n+--------+-------------------------------------------------+----------------+</code></pre>\n\n<p>è¿™æ—¶è°ƒç”¨ slice è¿›è¡Œåˆ‡ç‰‡ï¼Œ<strong>æ— å‚ slice æ˜¯ä»åŸå§‹ ByteBuf çš„ read index åˆ° write index ä¹‹é—´çš„å†…å®¹è¿›è¡Œåˆ‡ç‰‡ï¼Œã€åˆ‡ç‰‡åçš„ max capacity è¢«å›ºå®šä¸ºè¿™ä¸ªåŒºé—´çš„å¤§å°ï¼Œå› æ­¤ä¸èƒ½è¿½åŠ  writeã€‘</strong></p>\n<pre class=\"line-numbers language-java\" data-language=\"java\"><code class=\"language-java\">ByteBuf slice &#x3D; origin.slice();\nSystem.out.println(ByteBufUtil.prettyHexDump(slice));\n&#x2F;&#x2F; slice.writeByte(5); å¦‚æœæ‰§è¡Œï¼Œä¼šæŠ¥ IndexOutOfBoundsException å¼‚å¸¸\nå¸¦å‚æ„é€ ï¼š\nbuf.slice(index, length);</code></pre>\n\n<p>è¾“å‡º</p>\n<pre class=\"line-numbers language-none\"><code class=\"language-none\">         +-------------------------------------------------+\n         |  0  1  2  3  4  5  6  7  8  9  a  b  c  d  e  f |\n+--------+-------------------------------------------------+----------------+\n|00000000| 02 03 04                                        |...             |\n+--------+-------------------------------------------------+----------------+</code></pre>\n\n<p>å¦‚æœåŸå§‹ ByteBuf å†æ¬¡è¯»æ“ä½œï¼ˆåˆè¯»äº†ä¸€ä¸ªå­—èŠ‚ï¼‰</p>\n<pre class=\"line-numbers language-java\" data-language=\"java\"><code class=\"language-java\">origin.readByte();&#x2F;&#x2F;\nSystem.out.println(ByteBufUtil.prettyHexDump(origin));</code></pre>\n\n<p>è¾“å‡º</p>\n<pre class=\"line-numbers language-none\"><code class=\"language-none\">         +-------------------------------------------------+\n         |  0  1  2  3  4  5  6  7  8  9  a  b  c  d  e  f |\n+--------+-------------------------------------------------+----------------+\n|00000000| 03 04                                           |..              |\n+--------+-------------------------------------------------+----------------+</code></pre>\n\n<p>è¿™æ—¶çš„ <strong>slice ä¸å—å½±å“ï¼Œå› ä¸ºå®ƒæœ‰ç‹¬ç«‹çš„è¯»å†™æŒ‡é’ˆ</strong></p>\n<pre class=\"line-numbers language-java\" data-language=\"java\"><code class=\"language-java\">System.out.println(ByteBufUtil.prettyHexDump(slice));</code></pre>\n\n<p>è¾“å‡º</p>\n<pre class=\"line-numbers language-none\"><code class=\"language-none\">         +-------------------------------------------------+\n         |  0  1  2  3  4  5  6  7  8  9  a  b  c  d  e  f |\n+--------+-------------------------------------------------+----------------+\n|00000000| 02 03 04                                        |...             |\n+--------+-------------------------------------------------+----------------+</code></pre>\n\n<p>å¦‚æœ slice çš„å†…å®¹å‘ç”Ÿäº†æ›´æ”¹ setByte</p>\n<pre class=\"line-numbers language-java\" data-language=\"java\"><code class=\"language-java\">slice.setByte(2, 5);&#x2F;&#x2F;\nSystem.out.println(ByteBufUtil.prettyHexDump(slice));</code></pre>\n\n<p>è¾“å‡º</p>\n<pre class=\"line-numbers language-none\"><code class=\"language-none\">         +-------------------------------------------------+\n         |  0  1  2  3  4  5  6  7  8  9  a  b  c  d  e  f |\n+--------+-------------------------------------------------+----------------+\n|00000000| 02 03 05                                        |...             |\n+--------+-------------------------------------------------+----------------+</code></pre>\n\n<p>è¿™æ—¶ï¼Œ<strong>åŸå§‹ ByteBuf ä¹Ÿä¼šå—å½±å“ï¼Œå› ä¸ºåº•å±‚éƒ½æ˜¯åŒä¸€å—å†…å­˜</strong></p>\n<pre class=\"line-numbers language-none\"><code class=\"language-none\">System.out.println(ByteBufUtil.prettyHexDump(origin));</code></pre>\n\n<p>è¾“å‡º</p>\n<pre class=\"line-numbers language-none\"><code class=\"language-none\">         +-------------------------------------------------+\n         |  0  1  2  3  4  5  6  7  8  9  a  b  c  d  e  f |\n+--------+-------------------------------------------------+----------------+\n|00000000| 03 05                                           |..              |\n+--------+-------------------------------------------------+----------------+</code></pre>\n\n<p>slice.retain();&#x2F;&#x2F;refCnt+1</p>\n<p>release();&#x2F;&#x2F;refCnt-1</p>\n<h4 id=\"10ï¼‰duplicate-æµ…æ‹·è´\"><a href=\"#10ï¼‰duplicate-æµ…æ‹·è´\" class=\"headerlink\" title=\"10ï¼‰duplicate æµ…æ‹·è´\"></a>10ï¼‰duplicate æµ…æ‹·è´</h4><p>ã€é›¶æ‹·è´ã€‘çš„ä½“ç°ä¹‹ä¸€ï¼Œå°±å¥½æ¯”æˆªå–äº†åŸå§‹ ByteBuf <strong>æ‰€æœ‰å†…å®¹ï¼Œå¹¶ä¸”æ²¡æœ‰ max capacity çš„é™åˆ¶</strong>ï¼Œä¹Ÿæ˜¯ä¸åŸå§‹ ByteBuf ä½¿<strong>ç”¨åŒä¸€å—åº•å±‚å†…å­˜ï¼Œåªæ˜¯è¯»å†™æŒ‡é’ˆæ˜¯ç‹¬ç«‹çš„</strong></p>\n<p><img src=\"http://cache.itzy8.top/%E5%AD%A6Netty-%E9%BB%91%E9%A9%AC%E6%BB%A1%E5%93%A5/0012.png\"></p>\n<h4 id=\"11ï¼‰copyæ·±æ‹·è´\"><a href=\"#11ï¼‰copyæ·±æ‹·è´\" class=\"headerlink\" title=\"11ï¼‰copyæ·±æ‹·è´\"></a>11ï¼‰copyæ·±æ‹·è´</h4><p>ä¼šå°†åº•å±‚å†…å­˜æ•°æ®è¿›è¡Œ<strong>æ·±æ‹·è´</strong>ï¼Œå› æ­¤æ— è®ºè¯»å†™ï¼Œéƒ½ä¸åŸå§‹ ByteBuf <strong>æ— å…³</strong></p>\n<h4 id=\"12ï¼‰CompositeByteBuf\"><a href=\"#12ï¼‰CompositeByteBuf\" class=\"headerlink\" title=\"12ï¼‰CompositeByteBuf\"></a>12ï¼‰CompositeByteBuf</h4><p>ã€é›¶æ‹·è´ã€‘çš„ä½“ç°ä¹‹ä¸€ï¼Œå¯ä»¥å°†å¤šä¸ª ByteBuf åˆå¹¶ä¸ºä¸€ä¸ªé€»è¾‘ä¸Šçš„ ByteBufï¼Œé¿å…æ‹·è´</p>\n<p>æœ‰ä¸¤ä¸ª ByteBuf å¦‚ä¸‹</p>\n<pre class=\"line-numbers language-java\" data-language=\"java\"><code class=\"language-java\">ByteBuf buf1 &#x3D; ByteBufAllocator.DEFAULT.buffer(5);\nbuf1.writeBytes(new byte[]&#123;1, 2, 3, 4, 5&#125;);\nByteBuf buf2 &#x3D; ByteBufAllocator.DEFAULT.buffer(5);\nbuf2.writeBytes(new byte[]&#123;6, 7, 8, 9, 10&#125;);\nSystem.out.println(ByteBufUtil.prettyHexDump(buf1));\nSystem.out.println(ByteBufUtil.prettyHexDump(buf2));</code></pre>\n\n<p>è¾“å‡º</p>\n<pre class=\"line-numbers language-none\"><code class=\"language-none\">         +-------------------------------------------------+\n         |  0  1  2  3  4  5  6  7  8  9  a  b  c  d  e  f |\n+--------+-------------------------------------------------+----------------+\n|00000000| 01 02 03 04 05                                  |.....           |\n+--------+-------------------------------------------------+----------------+\n         +-------------------------------------------------+\n         |  0  1  2  3  4  5  6  7  8  9  a  b  c  d  e  f |\n+--------+-------------------------------------------------+----------------+\n|00000000| 06 07 08 09 0a                                  |.....           |\n+--------+-------------------------------------------------+----------------+</code></pre>\n\n<p>ç°åœ¨éœ€è¦ä¸€ä¸ªæ–°çš„ ByteBufï¼Œå†…å®¹æ¥è‡ªäºåˆšæ‰çš„ buf1 å’Œ buf2ï¼Œå¦‚ä½•å®ç°ï¼Ÿ</p>\n<p>æ–¹æ³•1ï¼š</p>\n<pre class=\"line-numbers language-java\" data-language=\"java\"><code class=\"language-java\">ByteBuf buf3 &#x3D; ByteBufAllocator.DEFAULT\n    .buffer(buf1.readableBytes()+buf2.readableBytes());&#x2F;&#x2F;\nbuf3.writeBytes(buf1);&#x2F;&#x2F;\nbuf3.writeBytes(buf2);\nSystem.out.println(ByteBufUtil.prettyHexDump(buf3));</code></pre>\n\n<p>ç»“æœ</p>\n<pre class=\"line-numbers language-none\"><code class=\"language-none\">         +-------------------------------------------------+\n         |  0  1  2  3  4  5  6  7  8  9  a  b  c  d  e  f |\n+--------+-------------------------------------------------+----------------+\n|00000000| 01 02 03 04 05 06 07 08 09 0a                   |..........      |\n+--------+-------------------------------------------------+----------------+</code></pre>\n\n<p>è¿™ç§æ–¹æ³•å¥½ä¸å¥½ï¼Ÿå›ç­”æ˜¯ä¸å¤ªå¥½ï¼Œå› ä¸ºè¿›è¡Œäº†[æ•°æ®çš„å†…å­˜å¤åˆ¶]æ“ä½œ</p>\n<p>æ–¹æ³•2ï¼š</p>\n<pre class=\"line-numbers language-java\" data-language=\"java\"><code class=\"language-java\">CompositeByteBuf buf3 &#x3D; ByteBufAllocator.DEFAULT.compositeBuffer();\n&#x2F;&#x2F; true è¡¨ç¤ºå¢åŠ æ–°çš„ ByteBuf è‡ªåŠ¨é€’å¢ write index, å¦åˆ™ write index ä¼šå§‹ç»ˆä¸º 0\nbuf3.addComponents(true, buf1, buf2);&#x2F;&#x2F;é»˜è®¤ä¸å¢Widxï¼+å…¥å‚trueï¼</code></pre>\n\n<p>ç»“æœæ˜¯ä¸€æ ·çš„</p>\n<pre class=\"line-numbers language-none\"><code class=\"language-none\">         +-------------------------------------------------+\n         |  0  1  2  3  4  5  6  7  8  9  a  b  c  d  e  f |\n+--------+-------------------------------------------------+----------------+\n|00000000| 01 02 03 04 05 06 07 08 09 0a                   |..........      |\n+--------+-------------------------------------------------+----------------+</code></pre>\n\n<p>CompositeByteBuf æ˜¯ä¸€ä¸ª<strong>ç»„åˆçš„ ByteBufï¼Œå®ƒå†…éƒ¨ç»´æŠ¤äº†ä¸€ä¸ª Component æ•°ç»„ï¼Œæ¯ä¸ª Component ç®¡ç†ä¸€ä¸ª ByteBufï¼Œè®°å½•äº†è¿™ä¸ª ByteBuf ç›¸å¯¹äºæ•´ä½“åç§»é‡ç­‰ä¿¡æ¯ï¼Œä»£è¡¨ç€æ•´ä½“ä¸­æŸä¸€æ®µçš„æ•°æ®ã€‚</strong></p>\n<ul>\n<li>ä¼˜ç‚¹ï¼Œ<strong>å¯¹å¤–æ˜¯ä¸€ä¸ªè™šæ‹Ÿè§†å›¾ï¼Œç»„åˆè¿™äº› ByteBuf ä¸ä¼šäº§ç”Ÿå†…å­˜å¤åˆ¶</strong></li>\n<li>ç¼ºç‚¹ï¼Œå¤æ‚äº†å¾ˆå¤šï¼Œå¤šæ¬¡æ“ä½œä¼šå¸¦æ¥æ€§èƒ½çš„æŸè€—</li>\n</ul>\n<h4 id=\"13ï¼‰Unpooled\"><a href=\"#13ï¼‰Unpooled\" class=\"headerlink\" title=\"13ï¼‰Unpooled\"></a>13ï¼‰Unpooled</h4><p>Unpooled æ˜¯ä¸€ä¸ªå·¥å…·ç±»ï¼Œç±»å¦‚å…¶åï¼Œæä¾›äº†éæ± åŒ–çš„ ByteBuf åˆ›å»ºã€ç»„åˆã€å¤åˆ¶ç­‰æ“ä½œ</p>\n<p>è¿™é‡Œä»…ä»‹ç»å…¶è·Ÿã€é›¶æ‹·è´ã€‘ç›¸å…³çš„ wrappedBuffer æ–¹æ³•ï¼Œå¯ä»¥ç”¨æ¥åŒ…è£… ByteBuf</p>\n<pre class=\"line-numbers language-java\" data-language=\"java\"><code class=\"language-java\">ByteBuf buf1 &#x3D; ByteBufAllocator.DEFAULT.buffer(5);\nbuf1.writeBytes(new byte[]&#123;1, 2, 3, 4, 5&#125;);\nByteBuf buf2 &#x3D; ByteBufAllocator.DEFAULT.buffer(5);\nbuf2.writeBytes(new byte[]&#123;6, 7, 8, 9, 10&#125;);\n\n&#x2F;&#x2F; å½“åŒ…è£… ByteBuf ä¸ªæ•°è¶…è¿‡ä¸€ä¸ªæ—¶, åº•å±‚ä½¿ç”¨äº† CompositeByteBuf\nByteBuf buf3 &#x3D; Unpooled.wrappedBuffer(buf1, buf2);&#x2F;&#x2F;\nSystem.out.println(ByteBufUtil.prettyHexDump(buf3));</code></pre>\n\n<p>è¾“å‡º</p>\n<pre class=\"line-numbers language-none\"><code class=\"language-none\">         +-------------------------------------------------+\n         |  0  1  2  3  4  5  6  7  8  9  a  b  c  d  e  f |\n+--------+-------------------------------------------------+----------------+\n|00000000| 01 02 03 04 05 06 07 08 09 0a                   |..........      |\n+--------+-------------------------------------------------+----------------+</code></pre>\n\n<p>ä¹Ÿå¯ä»¥ç”¨æ¥åŒ…è£…æ™®é€šå­—èŠ‚æ•°ç»„ï¼Œåº•å±‚ä¹Ÿä¸ä¼šæœ‰æ‹·è´æ“ä½œ</p>\n<pre class=\"line-numbers language-java\" data-language=\"java\"><code class=\"language-java\">ByteBuf buf4 &#x3D; Unpooled.wrappedBuffer(new byte[]&#123;1, 2, 3&#125;, new byte[]&#123;4, 5, 6&#125;);&#x2F;&#x2F;\nSystem.out.println(buf4.getClass());\nSystem.out.println(ByteBufUtil.prettyHexDump(buf4));</code></pre>\n\n<p>è¾“å‡º</p>\n<pre class=\"line-numbers language-none\"><code class=\"language-none\">class io.netty.buffer.CompositeByteBuf\n         +-------------------------------------------------+\n         |  0  1  2  3  4  5  6  7  8  9  a  b  c  d  e  f |\n+--------+-------------------------------------------------+----------------+\n|00000000| 01 02 03 04 05 06                               |......          |\n+--------+-------------------------------------------------+----------------+</code></pre>\n\n\n\n<h4 id=\"ğŸ’¡-ByteBuf-ä¼˜åŠ¿\"><a href=\"#ğŸ’¡-ByteBuf-ä¼˜åŠ¿\" class=\"headerlink\" title=\"ğŸ’¡ ByteBuf ä¼˜åŠ¿\"></a>ğŸ’¡ ByteBuf ä¼˜åŠ¿</h4><ul>\n<li>æ± åŒ– - å¯ä»¥é‡ç”¨æ± ä¸­ ByteBuf å®ä¾‹ï¼Œæ›´èŠ‚çº¦å†…å­˜ï¼Œå‡å°‘å†…å­˜æº¢å‡ºçš„å¯èƒ½</li>\n<li>è¯»å†™æŒ‡é’ˆåˆ†ç¦»ï¼Œä¸éœ€è¦åƒ ByteBuffer ä¸€æ ·åˆ‡æ¢è¯»å†™æ¨¡å¼</li>\n<li>å¯ä»¥è‡ªåŠ¨æ‰©å®¹</li>\n<li>æ”¯æŒé“¾å¼è°ƒç”¨ï¼Œä½¿ç”¨æ›´æµç•…</li>\n<li>å¾ˆå¤šåœ°æ–¹ä½“ç°é›¶æ‹·è´ï¼Œä¾‹å¦‚ sliceã€duplicateã€CompositeByteBuf</li>\n</ul>\n<h2 id=\"4-åŒå‘é€šä¿¡\"><a href=\"#4-åŒå‘é€šä¿¡\" class=\"headerlink\" title=\"4. åŒå‘é€šä¿¡\"></a>4. åŒå‘é€šä¿¡</h2><h3 id=\"4-1-ç»ƒä¹ \"><a href=\"#4-1-ç»ƒä¹ \" class=\"headerlink\" title=\"4.1 ç»ƒä¹ \"></a>4.1 ç»ƒä¹ </h3><p>å®ç°ä¸€ä¸ª echo server</p>\n<p>ç¼–å†™ server</p>\n<pre class=\"line-numbers language-java\" data-language=\"java\"><code class=\"language-java\">new ServerBootstrap()\n    .group(new NioEventLoopGroup())\n    .channel(NioServerSocketChannel.class)\n    .childHandler(new ChannelInitializer&lt;NioSocketChannel&gt;() &#123;\n        @Override\n        protected void initChannel(NioSocketChannel ch) &#123;\n            ch.pipeline().addLast(new ChannelInboundHandlerAdapter()&#123;\n                @Override\n                public void channelRead(ChannelHandlerContext ctx, Object msg) &#123;\n                    ByteBuf buffer &#x3D; (ByteBuf) msg;\n                    System.out.println(buffer.toString(Charset.defaultCharset()));\n\n                    &#x2F;&#x2F; å»ºè®®ä½¿ç”¨ ctx.alloc() åˆ›å»º ByteBuf\n                    ByteBuf response &#x3D; ctx.alloc().buffer();\n                    response.writeBytes(buffer);\n                    ctx.writeAndFlush(response);\n\n                    &#x2F;&#x2F; æ€è€ƒï¼šéœ€è¦é‡Šæ”¾ buffer å—\n                    &#x2F;&#x2F; æ€è€ƒï¼šéœ€è¦é‡Šæ”¾ response å—\n                &#125;\n            &#125;);\n        &#125;\n    &#125;).bind(8080);</code></pre>\n\n<p>ç¼–å†™ client</p>\n<pre class=\"line-numbers language-java\" data-language=\"java\"><code class=\"language-java\">NioEventLoopGroup group &#x3D; new NioEventLoopGroup();\nChannel channel &#x3D; new Bootstrap()\n    .group(group)\n    .channel(NioSocketChannel.class)\n    .handler(new ChannelInitializer&lt;NioSocketChannel&gt;() &#123;\n        @Override\n        protected void initChannel(NioSocketChannel ch) throws Exception &#123;\n            ch.pipeline().addLast(new StringEncoder());\n            ch.pipeline().addLast(new ChannelInboundHandlerAdapter() &#123;\n                @Override\n                public void channelRead(ChannelHandlerContext ctx, Object msg) &#123;\n                    ByteBuf buffer &#x3D; (ByteBuf) msg;\n                    System.out.println(buffer.toString(Charset.defaultCharset()));\n\n                    &#x2F;&#x2F; æ€è€ƒï¼šéœ€è¦é‡Šæ”¾ buffer å—\n                &#125;\n            &#125;);\n        &#125;\n    &#125;).connect(&quot;127.0.0.1&quot;, 8080).sync().channel();\n\nchannel.closeFuture().addListener(future -&gt; &#123;\n    group.shutdownGracefully();\n&#125;);\n\nnew Thread(() -&gt; &#123;\n    Scanner scanner &#x3D; new Scanner(System.in);\n    while (true) &#123;\n        String line &#x3D; scanner.nextLine();\n        if (&quot;q&quot;.equals(line)) &#123;\n            channel.close();\n            break;\n        &#125;\n        channel.writeAndFlush(line);\n    &#125;\n&#125;).start();</code></pre>\n\n\n\n<h3 id=\"ğŸ’¡-è¯»å’Œå†™çš„è¯¯è§£\"><a href=\"#ğŸ’¡-è¯»å’Œå†™çš„è¯¯è§£\" class=\"headerlink\" title=\"ğŸ’¡ è¯»å’Œå†™çš„è¯¯è§£\"></a>ğŸ’¡ è¯»å’Œå†™çš„è¯¯è§£</h3><p>æˆ‘æœ€åˆåœ¨è®¤è¯†ä¸Šæœ‰è¿™æ ·çš„è¯¯åŒºï¼Œè®¤ä¸ºåªæœ‰åœ¨ nettyï¼Œnio è¿™æ ·çš„å¤šè·¯å¤ç”¨ IO æ¨¡å‹æ—¶ï¼Œè¯»å†™æ‰ä¸ä¼šç›¸äº’é˜»å¡ï¼Œæ‰å¯ä»¥å®ç°é«˜æ•ˆçš„åŒå‘é€šä¿¡ï¼Œä½†å®é™…ä¸Šï¼Œ<strong>Java Socket æ˜¯ã€å…¨åŒå·¥ã€‘çš„ï¼šåœ¨ä»»æ„æ—¶åˆ»ï¼Œçº¿è·¯ä¸Šå­˜åœ¨<code>A åˆ° B</code> å’Œ <code>B åˆ° A</code> çš„åŒå‘ä¿¡å·ä¼ è¾“ã€‚å³ä½¿æ˜¯é˜»å¡ IOï¼Œè¯»å’Œå†™æ˜¯å¯ä»¥åŒæ—¶è¿›è¡Œçš„ï¼Œåªè¦åˆ†åˆ«é‡‡ç”¨ã€è¯»çº¿ç¨‹å’Œå†™çº¿ç¨‹ã€‘å³å¯ï¼Œè¯»ä¸ä¼šé˜»å¡å†™ã€å†™ä¹Ÿä¸ä¼šé˜»å¡è¯»</strong></p>\n<p>ä¾‹å¦‚</p>\n<pre class=\"line-numbers language-java\" data-language=\"java\"><code class=\"language-java\">public class TestServer &#123;\n    public static void main(String[] args) throws IOException &#123;\n        ServerSocket ss &#x3D; new ServerSocket(8888);\n        Socket s &#x3D; ss.accept();\n\n        new Thread(() -&gt; &#123;\n            try &#123;\n                BufferedReader reader &#x3D; new BufferedReader(new InputStreamReader(s.getInputStream()));&#x2F;&#x2F;\n                while (true) &#123;\n                    System.out.println(reader.readLine());\n                &#125;\n            &#125; catch (IOException e) &#123;\n                e.printStackTrace();\n            &#125;\n        &#125;).start();\n\n        new Thread(() -&gt; &#123;\n            try &#123;\n                BufferedWriter writer &#x3D; new BufferedWriter(new OutputStreamWriter(s.getOutputStream()));&#x2F;&#x2F;\n                &#x2F;&#x2F; ä¾‹å¦‚åœ¨è¿™ä¸ªä½ç½®åŠ å…¥ thread çº§åˆ«æ–­ç‚¹ï¼Œå¯ä»¥å‘ç°å³ä½¿ä¸å†™å…¥æ•°æ®ï¼Œä¹Ÿä¸å¦¨ç¢å‰é¢çº¿ç¨‹è¯»å–å®¢æˆ·ç«¯æ•°æ®\n                for (int i &#x3D; 0; i &lt; 100; i++) &#123;\n                    writer.write(String.valueOf(i));\n                    writer.newLine();\n                    writer.flush();\n                &#125;\n            &#125; catch (IOException e) &#123;\n                e.printStackTrace();\n            &#125;\n        &#125;).start();\n    &#125;\n&#125;</code></pre>\n\n<p>å®¢æˆ·ç«¯</p>\n<pre class=\"line-numbers language-java\" data-language=\"java\"><code class=\"language-java\">public class TestClient &#123;\n    public static void main(String[] args) throws IOException &#123;\n        Socket s &#x3D; new Socket(&quot;localhost&quot;, 8888);\n\n        new Thread(() -&gt; &#123;\n            try &#123;\n                BufferedReader reader &#x3D; new BufferedReader(new InputStreamReader(s.getInputStream()));\n                while (true) &#123;\n                    System.out.println(reader.readLine());\n                &#125;\n            &#125; catch (IOException e) &#123;\n                e.printStackTrace();\n            &#125;\n        &#125;).start();\n\n        new Thread(() -&gt; &#123;\n            try &#123;\n                BufferedWriter writer &#x3D; new BufferedWriter(new OutputStreamWriter(s.getOutputStream()));\n                for (int i &#x3D; 0; i &lt; 100; i++) &#123;\n                    writer.write(String.valueOf(i));\n                    writer.newLine();\n                    writer.flush();\n                &#125;\n            &#125; catch (IOException e) &#123;\n                e.printStackTrace();\n            &#125;\n        &#125;).start();\n    &#125;\n&#125;</code></pre>\n\n\n\n<h1 id=\"ä¸‰-Netty-è¿›é˜¶\"><a href=\"#ä¸‰-Netty-è¿›é˜¶\" class=\"headerlink\" title=\"ä¸‰. Netty è¿›é˜¶\"></a>ä¸‰. Netty è¿›é˜¶</h1><h2 id=\"1-ç²˜åŒ…ä¸åŠåŒ…\"><a href=\"#1-ç²˜åŒ…ä¸åŠåŒ…\" class=\"headerlink\" title=\"1. ç²˜åŒ…ä¸åŠåŒ…\"></a>1. ç²˜åŒ…ä¸åŠåŒ…</h2><h3 id=\"1-1-ç²˜åŒ…ç°è±¡\"><a href=\"#1-1-ç²˜åŒ…ç°è±¡\" class=\"headerlink\" title=\"1.1 ç²˜åŒ…ç°è±¡\"></a>1.1 ç²˜åŒ…ç°è±¡</h3><p>æœåŠ¡ç«¯ä»£ç </p>\n<pre class=\"line-numbers language-java\" data-language=\"java\"><code class=\"language-java\">public class HelloWorldServer &#123;\n    static final Logger log &#x3D; LoggerFactory.getLogger(HelloWorldServer.class);\n    void start() &#123;\n        NioEventLoopGroup boss &#x3D; new NioEventLoopGroup(1);\n        NioEventLoopGroup worker &#x3D; new NioEventLoopGroup();\n        try &#123;\n            ServerBootstrap serverBootstrap &#x3D; new ServerBootstrap();\n            serverBootstrap.channel(NioServerSocketChannel.class);\n            &#x2F;&#x2F;serverBootstrap.option(ChannelOption.SO_RCVBUF, 10);&#x2F;&#x2F;åŠåŒ…\n            serverBootstrap.group(boss, worker);\n            serverBootstrap.childHandler(new ChannelInitializer&lt;SocketChannel&gt;() &#123;\n                @Override\n                protected void initChannel(SocketChannel ch) throws Exception &#123;\n                    ch.pipeline().addLast(new LoggingHandler(LogLevel.DEBUG));\n                    ch.pipeline().addLast(new ChannelInboundHandlerAdapter() &#123;\n                        @Override\n                        public void channelActive(ChannelHandlerContext ctx) throws Exception &#123;\n                            log.debug(&quot;connected &#123;&#125;&quot;, ctx.channel());\n                            super.channelActive(ctx);\n                        &#125;\n\n                        @Override\n                        public void channelInactive(ChannelHandlerContext ctx) throws Exception &#123;\n                            log.debug(&quot;disconnect &#123;&#125;&quot;, ctx.channel());\n                            super.channelInactive(ctx);\n                        &#125;\n                    &#125;);\n                &#125;\n            &#125;);\n            ChannelFuture channelFuture &#x3D; serverBootstrap.bind(8080);\n            log.debug(&quot;&#123;&#125; binding...&quot;, channelFuture.channel());\n            channelFuture.sync();&#x2F;&#x2F;\n            log.debug(&quot;&#123;&#125; bound...&quot;, channelFuture.channel());\n            channelFuture.channel().closeFuture().sync();&#x2F;&#x2F;\n        &#125; catch (InterruptedException e) &#123;\n            log.error(&quot;server error&quot;, e);\n        &#125; finally &#123;\n            boss.shutdownGracefully();\n            worker.shutdownGracefully();\n            log.debug(&quot;stoped&quot;);\n        &#125;\n    &#125;\n\n    public static void main(String[] args) &#123;\n        new HelloWorldServer().start();\n    &#125;\n&#125;</code></pre>\n\n<p>å®¢æˆ·ç«¯ä»£ç å¸Œæœ›å‘é€ 10 ä¸ªæ¶ˆæ¯ï¼Œæ¯ä¸ªæ¶ˆæ¯æ˜¯ 16 å­—èŠ‚</p>\n<pre class=\"line-numbers language-java\" data-language=\"java\"><code class=\"language-java\">public class HelloWorldClient &#123;\n    static final Logger log &#x3D; LoggerFactory.getLogger(HelloWorldClient.class);\n    public static void main(String[] args) &#123;\n        NioEventLoopGroup worker &#x3D; new NioEventLoopGroup();\n        try &#123;\n            Bootstrap bootstrap &#x3D; new Bootstrap();\n            bootstrap.channel(NioSocketChannel.class);\n            bootstrap.group(worker);\n            bootstrap.handler(new ChannelInitializer&lt;SocketChannel&gt;() &#123;\n                @Override\n                protected void initChannel(SocketChannel ch) throws Exception &#123;\n                    log.debug(&quot;connected...&quot;);\n                    ch.pipeline().addLast(new ChannelInboundHandlerAdapter() &#123;\n                        @Override\n                        public void channelActive(ChannelHandlerContext ctx) throws Exception &#123;\n                            log.debug(&quot;sending...&quot;);\n                            Random r &#x3D; new Random();\n                            char c &#x3D; &#39;a&#39;;\n                            for (int i &#x3D; 0; i &lt; 10; i++) &#123;\n                                ByteBuf buffer &#x3D; ctx.alloc().buffer();\n                                buffer.writeBytes(new byte[]&#123;0, 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15&#125;);\n                                ctx.writeAndFlush(buffer);&#x2F;&#x2F;160B ç²˜åŒ…\n                            &#125;\n                        &#125;\n                    &#125;);\n                &#125;\n            &#125;);\n            ChannelFuture channelFuture &#x3D; bootstrap.connect(&quot;127.0.0.1&quot;, 8080).sync();\n            channelFuture.channel().closeFuture().sync();\n\n        &#125; catch (InterruptedException e) &#123;\n            log.error(&quot;client error&quot;, e);\n        &#125; finally &#123;\n            worker.shutdownGracefully();\n        &#125;\n    &#125;\n&#125;</code></pre>\n\n<p>æœåŠ¡å™¨ç«¯çš„æŸæ¬¡è¾“å‡ºï¼Œå¯ä»¥çœ‹åˆ°ä¸€æ¬¡å°±æ¥æ”¶äº† 160 ä¸ªå­—èŠ‚ï¼Œè€Œéåˆ† 10 æ¬¡æ¥æ”¶</p>\n<pre class=\"line-numbers language-none\"><code class=\"language-none\">08:24:46 [DEBUG] [main] c.i.n.HelloWorldServer - [id: 0x81e0fda5] binding...\n08:24:46 [DEBUG] [main] c.i.n.HelloWorldServer - [id: 0x81e0fda5, L:&#x2F;0:0:0:0:0:0:0:0:8080] bound...\n08:24:55 [DEBUG] [nioEventLoopGroup-3-1] i.n.h.l.LoggingHandler - [id: 0x94132411, L:&#x2F;127.0.0.1:8080 - R:&#x2F;127.0.0.1:58177] REGISTERED\n08:24:55 [DEBUG] [nioEventLoopGroup-3-1] i.n.h.l.LoggingHandler - [id: 0x94132411, L:&#x2F;127.0.0.1:8080 - R:&#x2F;127.0.0.1:58177] ACTIVE\n08:24:55 [DEBUG] [nioEventLoopGroup-3-1] c.i.n.HelloWorldServer - connected [id: 0x94132411, L:&#x2F;127.0.0.1:8080 - R:&#x2F;127.0.0.1:58177]\n08:24:55 [DEBUG] [nioEventLoopGroup-3-1] i.n.h.l.LoggingHandler - [id: 0x94132411, L:&#x2F;127.0.0.1:8080 - R:&#x2F;127.0.0.1:58177] READ: 160B\n         +-------------------------------------------------+\n         |  0  1  2  3  4  5  6  7  8  9  a  b  c  d  e  f |\n+--------+-------------------------------------------------+----------------+\n|00000000| 00 01 02 03 04 05 06 07 08 09 0a 0b 0c 0d 0e 0f |................|\n|00000010| 00 01 02 03 04 05 06 07 08 09 0a 0b 0c 0d 0e 0f |................|\n|00000020| 00 01 02 03 04 05 06 07 08 09 0a 0b 0c 0d 0e 0f |................|\n|00000030| 00 01 02 03 04 05 06 07 08 09 0a 0b 0c 0d 0e 0f |................|\n|00000040| 00 01 02 03 04 05 06 07 08 09 0a 0b 0c 0d 0e 0f |................|\n|00000050| 00 01 02 03 04 05 06 07 08 09 0a 0b 0c 0d 0e 0f |................|\n|00000060| 00 01 02 03 04 05 06 07 08 09 0a 0b 0c 0d 0e 0f |................|\n|00000070| 00 01 02 03 04 05 06 07 08 09 0a 0b 0c 0d 0e 0f |................|\n|00000080| 00 01 02 03 04 05 06 07 08 09 0a 0b 0c 0d 0e 0f |................|\n|00000090| 00 01 02 03 04 05 06 07 08 09 0a 0b 0c 0d 0e 0f |................|\n+--------+-------------------------------------------------+----------------+\n08:24:55 [DEBUG] [nioEventLoopGroup-3-1] i.n.h.l.LoggingHandler - [id: 0x94132411, L:&#x2F;127.0.0.1:8080 - R:&#x2F;127.0.0.1:58177] READ COMPLETE</code></pre>\n\n\n\n<h3 id=\"1-2-åŠåŒ…ç°è±¡\"><a href=\"#1-2-åŠåŒ…ç°è±¡\" class=\"headerlink\" title=\"1.2 åŠåŒ…ç°è±¡\"></a>1.2 åŠåŒ…ç°è±¡</h3><p>å®¢æˆ·ç«¯ä»£ç å¸Œæœ›å‘é€ 1 ä¸ªæ¶ˆæ¯ï¼Œè¿™ä¸ªæ¶ˆæ¯æ˜¯ 160 å­—èŠ‚ï¼Œä»£ç æ”¹ä¸º</p>\n<pre class=\"line-numbers language-java\" data-language=\"java\"><code class=\"language-java\">ByteBuf buffer &#x3D; ctx.alloc().buffer();\nfor (int i &#x3D; 0; i &lt; 10; i++) &#123;\n    buffer.writeBytes(new byte[]&#123;0, 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15&#125;);\n&#125;\nctx.writeAndFlush(buffer);</code></pre>\n\n<p>ä¸ºç°è±¡æ˜æ˜¾ï¼ŒæœåŠ¡ç«¯ä¿®æ”¹ä¸€ä¸‹æ¥æ”¶ç¼“å†²åŒºï¼Œå…¶å®ƒä»£ç ä¸å˜</p>\n<pre class=\"line-numbers language-java\" data-language=\"java\"><code class=\"language-java\">serverBootstrap.option(ChannelOption.SO_RCVBUF, 10);&#x2F;&#x2F;</code></pre>\n\n<p>æœåŠ¡å™¨ç«¯çš„æŸæ¬¡è¾“å‡ºï¼Œå¯ä»¥çœ‹åˆ°æ¥æ”¶çš„æ¶ˆæ¯è¢«åˆ†ä¸ºä¸¤èŠ‚ï¼Œç¬¬ä¸€æ¬¡ 20 å­—èŠ‚ï¼Œç¬¬äºŒæ¬¡ 140 å­—èŠ‚</p>\n<pre class=\"line-numbers language-none\"><code class=\"language-none\">08:43:49 [DEBUG] [main] c.i.n.HelloWorldServer - [id: 0x4d6c6a84] binding...\n08:43:49 [DEBUG] [main] c.i.n.HelloWorldServer - [id: 0x4d6c6a84, L:&#x2F;0:0:0:0:0:0:0:0:8080] bound...\n08:44:23 [DEBUG] [nioEventLoopGroup-3-1] i.n.h.l.LoggingHandler - [id: 0x1719abf7, L:&#x2F;127.0.0.1:8080 - R:&#x2F;127.0.0.1:59221] REGISTERED\n08:44:23 [DEBUG] [nioEventLoopGroup-3-1] i.n.h.l.LoggingHandler - [id: 0x1719abf7, L:&#x2F;127.0.0.1:8080 - R:&#x2F;127.0.0.1:59221] ACTIVE\n08:44:23 [DEBUG] [nioEventLoopGroup-3-1] c.i.n.HelloWorldServer - connected [id: 0x1719abf7, L:&#x2F;127.0.0.1:8080 - R:&#x2F;127.0.0.1:59221]\n08:44:24 [DEBUG] [nioEventLoopGroup-3-1] i.n.h.l.LoggingHandler - [id: 0x1719abf7, L:&#x2F;127.0.0.1:8080 - R:&#x2F;127.0.0.1:59221] READ: 20B\n         +-------------------------------------------------+\n         |  0  1  2  3  4  5  6  7  8  9  a  b  c  d  e  f |\n+--------+-------------------------------------------------+----------------+\n|00000000| 00 01 02 03 04 05 06 07 08 09 0a 0b 0c 0d 0e 0f |................|\n|00000010| 00 01 02 03                                     |....            |\n+--------+-------------------------------------------------+----------------+\n08:44:24 [DEBUG] [nioEventLoopGroup-3-1] i.n.h.l.LoggingHandler - [id: 0x1719abf7, L:&#x2F;127.0.0.1:8080 - R:&#x2F;127.0.0.1:59221] READ COMPLETE\n08:44:24 [DEBUG] [nioEventLoopGroup-3-1] i.n.h.l.LoggingHandler - [id: 0x1719abf7, L:&#x2F;127.0.0.1:8080 - R:&#x2F;127.0.0.1:59221] READ: 140B\n         +-------------------------------------------------+\n         |  0  1  2  3  4  5  6  7  8  9  a  b  c  d  e  f |\n+--------+-------------------------------------------------+----------------+\n|00000000| 04 05 06 07 08 09 0a 0b 0c 0d 0e 0f 00 01 02 03 |................|\n|00000010| 04 05 06 07 08 09 0a 0b 0c 0d 0e 0f 00 01 02 03 |................|\n|00000020| 04 05 06 07 08 09 0a 0b 0c 0d 0e 0f 00 01 02 03 |................|\n|00000030| 04 05 06 07 08 09 0a 0b 0c 0d 0e 0f 00 01 02 03 |................|\n|00000040| 04 05 06 07 08 09 0a 0b 0c 0d 0e 0f 00 01 02 03 |................|\n|00000050| 04 05 06 07 08 09 0a 0b 0c 0d 0e 0f 00 01 02 03 |................|\n|00000060| 04 05 06 07 08 09 0a 0b 0c 0d 0e 0f 00 01 02 03 |................|\n|00000070| 04 05 06 07 08 09 0a 0b 0c 0d 0e 0f 00 01 02 03 |................|\n|00000080| 04 05 06 07 08 09 0a 0b 0c 0d 0e 0f             |............    |\n+--------+-------------------------------------------------+----------------+\n08:44:24 [DEBUG] [nioEventLoopGroup-3-1] i.n.h.l.LoggingHandler - [id: 0x1719abf7, L:&#x2F;127.0.0.1:8080 - R:&#x2F;127.0.0.1:59221] READ COMPLETE</code></pre>\n\n<blockquote><span class=\"custom-blockquote-svg\"><svg width=\"24\" height=\"24\" viewBox=\"0 0 24 24\" fill=\"\" xmlns=\"http://www.w3.org/2000/svg\" data-reactroot=\"\">\n<path fill=\"\" d=\"M22 12C22 6.5 17.5 2 12 2C6.5 2 2 6.5 2 12C2 17.5 6.5 22 12 22C13.8 22 15.5 21.5 17 20.6L22 22L20.7 17C21.5 15.5 22 13.8 22 12Z\" undefined=\"1\"></path>\n<path fill=\"\" d=\"M15.97 11.5H16.04C17.12 11.5 18 12.38 18 13.47V13.53C18 14.62 17.12 15.5 16.03 15.5H15.96C14.88 15.5 14 14.62 14 13.53V13.46C14 12.38 14.88 11.5 15.97 11.5Z\" undefined=\"1\"></path>\n<path fill=\"\" d=\"M7.97 11.5H8.04C9.12 11.5 10 12.38 10 13.47V13.53C10 14.62 9.12 15.5 8.03 15.5H7.97C6.88 15.5 6 14.62 6 13.53V13.46C6 12.38 6.88 11.5 7.97 11.5Z\" undefined=\"1\"></path>\n<path stroke-linejoin=\"round\" stroke-linecap=\"round\" stroke-miterlimit=\"10\" stroke-width=\"2\" stroke=\"\" d=\"M17 8.5C15.23 8.97 14.07 10.84 14.01 13.27C14 13.33 14 13.4 14 13.47V13.5\"></path>\n<path stroke-linejoin=\"round\" stroke-linecap=\"round\" stroke-miterlimit=\"10\" stroke-width=\"2\" stroke=\"\" d=\"M9 8.5C7.23 8.97 6.07 10.84 6.01 13.27C6 13.33 6 13.4 6 13.47V13.5\"></path>\n<path stroke-linejoin=\"round\" stroke-linecap=\"round\" stroke-miterlimit=\"10\" stroke-width=\"2\" stroke=\"\" d=\"M15.97 11.5H16.04C17.12 11.5 18 12.38 18 13.47V13.53C18 14.62 17.12 15.5 16.03 15.5H15.96C14.88 15.5 14 14.62 14 13.53V13.46C14 12.38 14.88 11.5 15.97 11.5Z\"></path>\n<path stroke-linejoin=\"round\" stroke-linecap=\"round\" stroke-miterlimit=\"10\" stroke-width=\"2\" stroke=\"\" d=\"M7.97 11.5H8.04C9.12 11.5 10 12.38 10 13.47V13.53C10 14.62 9.12 15.5 8.03 15.5H7.97C6.88 15.5 6 14.62 6 13.53V13.46C6 12.38 6.88 11.5 7.97 11.5Z\"></path>\n</svg>\n</span><p><strong>æ³¨æ„</strong></p>\n<p>serverBootstrap.option(ChannelOption.SO_RCVBUF, <strong>10) å½±å“çš„åº•å±‚æ¥æ”¶ç¼“å†²åŒºï¼ˆå³æ»‘åŠ¨çª—å£ï¼‰å¤§å°ï¼Œä»…å†³å®šäº† ã€netty è¯»å–çš„æœ€å°å•ä½ï¼Œnetty å®é™…æ¯æ¬¡è¯»å–çš„ä¸€èˆ¬æ˜¯å®ƒçš„æ•´æ•°å€ã€‘</strong></p></blockquote>\n<p>&#x3D;&#x3D;only TCP&#x3D;&#x3D;</p>\n<h3 id=\"1-3-ç°è±¡åˆ†æ\"><a href=\"#1-3-ç°è±¡åˆ†æ\" class=\"headerlink\" title=\"1.3 ç°è±¡åˆ†æ\"></a>1.3 ç°è±¡åˆ†æ</h3><p>ç²˜åŒ…</p>\n<ul>\n<li>ç°è±¡ï¼Œå‘é€ abc defï¼Œæ¥æ”¶ abcdef</li>\n<li>åŸå› <ul>\n<li>åº”ç”¨å±‚ï¼šæ¥æ”¶æ–¹ ByteBuf è®¾ç½®å¤ªå¤§ï¼ˆNetty é»˜è®¤ 1024ï¼‰</li>\n<li>æ»‘åŠ¨çª—å£ï¼šå‡è®¾å‘é€æ–¹ 256 bytes è¡¨ç¤ºä¸€ä¸ªå®Œæ•´æŠ¥æ–‡ï¼Œä½†ç”±äºæ¥æ”¶æ–¹å¤„ç†ä¸åŠæ—¶ä¸”çª—å£å¤§å°è¶³å¤Ÿå¤§ï¼Œè¿™ 256 bytes å­—èŠ‚å°±ä¼šç¼“å†²åœ¨æ¥æ”¶æ–¹çš„æ»‘åŠ¨çª—å£ä¸­ï¼Œå½“æ»‘åŠ¨çª—å£ä¸­ç¼“å†²äº†å¤šä¸ªæŠ¥æ–‡å°±ä¼šç²˜åŒ…</li>\n<li>Nagle ç®—æ³•ï¼šä¼šé€ æˆç²˜åŒ…</li>\n</ul>\n</li>\n</ul>\n<p>åŠåŒ…</p>\n<ul>\n<li>ç°è±¡ï¼Œå‘é€ abcdefï¼Œæ¥æ”¶ abc def</li>\n<li>åŸå› <ul>\n<li>åº”ç”¨å±‚ï¼šæ¥æ”¶æ–¹ ByteBuf å°äºå®é™…å‘é€æ•°æ®é‡</li>\n<li>æ»‘åŠ¨çª—å£ï¼šå‡è®¾<strong>æ¥æ”¶æ–¹çš„çª—å£åªå‰©äº† 128 bytes</strong>ï¼Œå‘é€æ–¹çš„æŠ¥æ–‡å¤§å°æ˜¯ 256 bytesï¼Œè¿™æ—¶æ”¾ä¸ä¸‹äº†ï¼Œ<strong>åªèƒ½å…ˆå‘é€å‰ 128 bytesï¼Œç­‰å¾… ack åæ‰èƒ½å‘é€å‰©ä½™éƒ¨åˆ†ï¼Œè¿™å°±é€ æˆäº†åŠåŒ…</strong></li>\n<li>MSS é™åˆ¶ï¼šå½“<strong>å‘é€çš„æ•°æ®è¶…è¿‡ MSS é™åˆ¶åï¼Œä¼šå°†æ•°æ®åˆ‡åˆ†å‘é€</strong>ï¼Œå°±ä¼šé€ æˆåŠåŒ…</li>\n</ul>\n</li>\n</ul>\n<p>ã€ IPåˆ†ç‰‡ä¸é‡ç»„ï¼šifå¤§TCPæŠ¥æ–‡è¢«IPå±‚MTUåˆ†ç‰‡:1500Bï¼Œ&#x3D;&#x3D;åªæœ‰ç¬¬ä¸€ä¸ªåˆ†ç‰‡æ‰å…·æœ‰<code>TCP</code>å¤´éƒ¨&#x3D;&#x3D;ï¼Œé‡ç»„æ‰è®¤ä¸ºæ˜¯TCPç»™ä¸Šå±‚ã€‘</p>\n<p>å¦‚æœä¸€ä¸ª<strong>å¤§çš„<code>TCP</code>æŠ¥æ–‡è¢«<code>MSS</code>åˆ†ç‰‡ï¼Œé‚£ä¹ˆæ‰€æœ‰åˆ†ç‰‡éƒ½å…·æœ‰<code>TCP</code>å¤´éƒ¨</strong>ï¼Œå› ä¸ºæ¯ä¸ª<code>MSS</code>åˆ†ç‰‡çš„æ˜¯å…·æœ‰<code>TCP</code>å¤´éƒ¨çš„<code>TCP</code>æŠ¥æ–‡ï¼Œå…¶ä¸­ä¸€ä¸ª<code>MSS</code>åˆ†ç‰‡ä¸¢å¤±ï¼Œå°±åªéœ€è¦é‡ä¼ è¿™ä¸€ä¸ªåˆ†ç‰‡å°±å¯ä»¥ã€‚</p>\n<p>æœ¬è´¨æ˜¯å› ä¸º <strong>TCP æ˜¯æµå¼åè®®ï¼Œæ¶ˆæ¯æ— è¾¹ç•Œ</strong></p>\n<blockquote><span class=\"custom-blockquote-svg\"><svg width=\"24\" height=\"24\" viewBox=\"0 0 24 24\" fill=\"\" xmlns=\"http://www.w3.org/2000/svg\" data-reactroot=\"\">\n<path fill=\"\" d=\"M22 12C22 6.5 17.5 2 12 2C6.5 2 2 6.5 2 12C2 17.5 6.5 22 12 22C13.8 22 15.5 21.5 17 20.6L22 22L20.7 17C21.5 15.5 22 13.8 22 12Z\" undefined=\"1\"></path>\n<path fill=\"\" d=\"M15.97 11.5H16.04C17.12 11.5 18 12.38 18 13.47V13.53C18 14.62 17.12 15.5 16.03 15.5H15.96C14.88 15.5 14 14.62 14 13.53V13.46C14 12.38 14.88 11.5 15.97 11.5Z\" undefined=\"1\"></path>\n<path fill=\"\" d=\"M7.97 11.5H8.04C9.12 11.5 10 12.38 10 13.47V13.53C10 14.62 9.12 15.5 8.03 15.5H7.97C6.88 15.5 6 14.62 6 13.53V13.46C6 12.38 6.88 11.5 7.97 11.5Z\" undefined=\"1\"></path>\n<path stroke-linejoin=\"round\" stroke-linecap=\"round\" stroke-miterlimit=\"10\" stroke-width=\"2\" stroke=\"\" d=\"M17 8.5C15.23 8.97 14.07 10.84 14.01 13.27C14 13.33 14 13.4 14 13.47V13.5\"></path>\n<path stroke-linejoin=\"round\" stroke-linecap=\"round\" stroke-miterlimit=\"10\" stroke-width=\"2\" stroke=\"\" d=\"M9 8.5C7.23 8.97 6.07 10.84 6.01 13.27C6 13.33 6 13.4 6 13.47V13.5\"></path>\n<path stroke-linejoin=\"round\" stroke-linecap=\"round\" stroke-miterlimit=\"10\" stroke-width=\"2\" stroke=\"\" d=\"M15.97 11.5H16.04C17.12 11.5 18 12.38 18 13.47V13.53C18 14.62 17.12 15.5 16.03 15.5H15.96C14.88 15.5 14 14.62 14 13.53V13.46C14 12.38 14.88 11.5 15.97 11.5Z\"></path>\n<path stroke-linejoin=\"round\" stroke-linecap=\"round\" stroke-miterlimit=\"10\" stroke-width=\"2\" stroke=\"\" d=\"M7.97 11.5H8.04C9.12 11.5 10 12.38 10 13.47V13.53C10 14.62 9.12 15.5 8.03 15.5H7.97C6.88 15.5 6 14.62 6 13.53V13.46C6 12.38 6.88 11.5 7.97 11.5Z\"></path>\n</svg>\n</span><p>æ»‘åŠ¨çª—å£</p>\n<ul>\n<li><p>TCP ä»¥ä¸€ä¸ªæ®µï¼ˆsegmentï¼‰ä¸ºå•ä½[MSS]ï¼Œæ¯å‘é€ä¸€ä¸ªæ®µå°±éœ€è¦è¿›è¡Œä¸€æ¬¡ç¡®è®¤åº”ç­”ï¼ˆackï¼‰å¤„ç†ï¼Œä½†å¦‚æœè¿™ä¹ˆåšï¼Œç¼ºç‚¹æ˜¯ åŒ…çš„å¾€è¿”æ—¶é—´RTTè¶Šé•¿æ€§èƒ½å°±è¶Šå·®</p>\n<p><img src=\"http://cache.itzy8.top/%E5%AD%A6Netty-%E9%BB%91%E9%A9%AC%E6%BB%A1%E5%93%A5/0049.png\"></p>\n</li>\n<li><p>ä¸ºäº†è§£å†³æ­¤é—®é¢˜ï¼Œå¼•å…¥äº†çª—å£æ¦‚å¿µï¼Œçª—å£å¤§å°å³å†³å®šäº†<strong>æ— éœ€ç­‰å¾…åº”ç­”è€Œå¯ä»¥ç»§ç»­å‘é€çš„æ•°æ®æœ€å¤§å€¼</strong></p>\n<p><img src=\"http://cache.itzy8.top/%E5%AD%A6Netty-%E9%BB%91%E9%A9%AC%E6%BB%A1%E5%93%A5/0051.png\"></p>\n</li>\n<li><p>çª—å£å®é™…å°±èµ·åˆ°ä¸€ä¸ª<strong>ç¼“å†²åŒº</strong>çš„ä½œç”¨ï¼ŒåŒæ—¶ä¹Ÿèƒ½èµ·åˆ°<strong>æµé‡æ§åˆ¶</strong>çš„ä½œç”¨</p>\n<ul>\n<li>å›¾ä¸­æ·±è‰²çš„éƒ¨åˆ†å³è¦å‘é€çš„æ•°æ®ï¼Œé«˜äº®çš„éƒ¨åˆ†å³çª—å£</li>\n<li>çª—å£å†…çš„æ•°æ®æ‰å…è®¸è¢«å‘é€ï¼Œå½“ åº”ç­”æœªåˆ°è¾¾å‰ï¼Œçª—å£å¿…é¡»åœæ­¢æ»‘åŠ¨</li>\n<li>å¦‚æœ 1001~2000 è¿™ä¸ªæ®µçš„æ•°æ® ack å›æ¥äº†ï¼Œçª—å£å°±å¯ä»¥å‘å‰æ»‘åŠ¨</li>\n<li>æ¥æ”¶æ–¹ä¹Ÿä¼šç»´æŠ¤ ä¸€ä¸ªçª—å£ï¼Œåªæœ‰è½åœ¨çª—å£å†…çš„æ•°æ®æ‰èƒ½ å…è®¸æ¥æ”¶</li>\n</ul>\n</li>\n</ul></blockquote>\n<blockquote><span class=\"custom-blockquote-svg\"><svg width=\"24\" height=\"24\" viewBox=\"0 0 24 24\" fill=\"\" xmlns=\"http://www.w3.org/2000/svg\" data-reactroot=\"\">\n<path fill=\"\" d=\"M22 12C22 6.5 17.5 2 12 2C6.5 2 2 6.5 2 12C2 17.5 6.5 22 12 22C13.8 22 15.5 21.5 17 20.6L22 22L20.7 17C21.5 15.5 22 13.8 22 12Z\" undefined=\"1\"></path>\n<path fill=\"\" d=\"M15.97 11.5H16.04C17.12 11.5 18 12.38 18 13.47V13.53C18 14.62 17.12 15.5 16.03 15.5H15.96C14.88 15.5 14 14.62 14 13.53V13.46C14 12.38 14.88 11.5 15.97 11.5Z\" undefined=\"1\"></path>\n<path fill=\"\" d=\"M7.97 11.5H8.04C9.12 11.5 10 12.38 10 13.47V13.53C10 14.62 9.12 15.5 8.03 15.5H7.97C6.88 15.5 6 14.62 6 13.53V13.46C6 12.38 6.88 11.5 7.97 11.5Z\" undefined=\"1\"></path>\n<path stroke-linejoin=\"round\" stroke-linecap=\"round\" stroke-miterlimit=\"10\" stroke-width=\"2\" stroke=\"\" d=\"M17 8.5C15.23 8.97 14.07 10.84 14.01 13.27C14 13.33 14 13.4 14 13.47V13.5\"></path>\n<path stroke-linejoin=\"round\" stroke-linecap=\"round\" stroke-miterlimit=\"10\" stroke-width=\"2\" stroke=\"\" d=\"M9 8.5C7.23 8.97 6.07 10.84 6.01 13.27C6 13.33 6 13.4 6 13.47V13.5\"></path>\n<path stroke-linejoin=\"round\" stroke-linecap=\"round\" stroke-miterlimit=\"10\" stroke-width=\"2\" stroke=\"\" d=\"M15.97 11.5H16.04C17.12 11.5 18 12.38 18 13.47V13.53C18 14.62 17.12 15.5 16.03 15.5H15.96C14.88 15.5 14 14.62 14 13.53V13.46C14 12.38 14.88 11.5 15.97 11.5Z\"></path>\n<path stroke-linejoin=\"round\" stroke-linecap=\"round\" stroke-miterlimit=\"10\" stroke-width=\"2\" stroke=\"\" d=\"M7.97 11.5H8.04C9.12 11.5 10 12.38 10 13.47V13.53C10 14.62 9.12 15.5 8.03 15.5H7.97C6.88 15.5 6 14.62 6 13.53V13.46C6 12.38 6.88 11.5 7.97 11.5Z\"></path>\n</svg>\n</span><p> MSS é™åˆ¶</p>\n<ul>\n<li><p><strong>é“¾è·¯å±‚</strong>å¯¹ä¸€æ¬¡èƒ½å¤Ÿå‘é€çš„æœ€å¤§æ•°æ®æœ‰é™åˆ¶ï¼Œè¿™ä¸ªé™åˆ¶ç§°ä¹‹ä¸º <strong>MTU</strong>ï¼ˆmaximum transmission unitï¼‰ï¼Œä¸åŒçš„é“¾è·¯è®¾å¤‡çš„ MTU å€¼ä¹Ÿæœ‰æ‰€ä¸åŒï¼Œä¾‹å¦‚</p>\n</li>\n<li><p><strong>ä»¥å¤ªç½‘çš„ MTU æ˜¯ 1500</strong></p>\n</li>\n<li><p><strong>FDDIï¼ˆå…‰çº¤åˆ†å¸ƒå¼</strong>æ•°æ®æ¥å£ï¼‰çš„ MTU æ˜¯ <strong>4352</strong></p>\n</li>\n<li><p><strong>æœ¬åœ°å›ç¯åœ°å€çš„ MTU æ˜¯ 65535 - æœ¬åœ°æµ‹è¯•ä¸èµ°ç½‘å¡</strong></p>\n</li>\n<li><p><strong>MSS</strong> æ˜¯æœ€å¤§æ®µé•¿åº¦ï¼ˆmaximum segment sizeï¼‰ï¼Œå®ƒæ˜¯ <strong>MTU åˆ¨å» tcp å¤´å’Œ ip å¤´åå‰©ä½™èƒ½å¤Ÿä½œä¸ºæ•°æ®ä¼ è¾“çš„å­—èŠ‚æ•°</strong></p>\n</li>\n<li><p><strong>ipv4 tcp å¤´å ç”¨ 20 bytesï¼Œip å¤´å ç”¨ 20 bytesï¼Œå› æ­¤ä»¥å¤ªç½‘ MSS çš„å€¼ä¸º 1500 - 40 &#x3D; 1460</strong></p>\n</li>\n<li><p>TCP åœ¨ä¼ é€’å¤§é‡æ•°æ®æ—¶ï¼Œä¼šæŒ‰ç…§ MSS å¤§å°å°†æ•°æ®è¿›è¡Œåˆ†å‰²å‘é€</p>\n</li>\n<li><p>MSS çš„å€¼åœ¨&#x3D;&#x3D;ä¸‰æ¬¡<strong>æ¡æ‰‹æ—¶é€šçŸ¥</strong>å¯¹æ–¹è‡ªå·± MSS çš„å€¼ï¼Œç„¶ååœ¨<strong>ä¸¤è€…ä¹‹é—´é€‰æ‹©ä¸€ä¸ªå°å€¼</strong>ä½œä¸º MSS&#x3D;&#x3D;</p>\n</li>\n</ul>\n<p> <img src=\"http://cache.itzy8.top/%E5%AD%A6Netty-%E9%BB%91%E9%A9%AC%E6%BB%A1%E5%93%A5/0031.jpg\"></p></blockquote>\n<blockquote><span class=\"custom-blockquote-svg\"><svg width=\"24\" height=\"24\" viewBox=\"0 0 24 24\" fill=\"\" xmlns=\"http://www.w3.org/2000/svg\" data-reactroot=\"\">\n<path fill=\"\" d=\"M22 12C22 6.5 17.5 2 12 2C6.5 2 2 6.5 2 12C2 17.5 6.5 22 12 22C13.8 22 15.5 21.5 17 20.6L22 22L20.7 17C21.5 15.5 22 13.8 22 12Z\" undefined=\"1\"></path>\n<path fill=\"\" d=\"M15.97 11.5H16.04C17.12 11.5 18 12.38 18 13.47V13.53C18 14.62 17.12 15.5 16.03 15.5H15.96C14.88 15.5 14 14.62 14 13.53V13.46C14 12.38 14.88 11.5 15.97 11.5Z\" undefined=\"1\"></path>\n<path fill=\"\" d=\"M7.97 11.5H8.04C9.12 11.5 10 12.38 10 13.47V13.53C10 14.62 9.12 15.5 8.03 15.5H7.97C6.88 15.5 6 14.62 6 13.53V13.46C6 12.38 6.88 11.5 7.97 11.5Z\" undefined=\"1\"></path>\n<path stroke-linejoin=\"round\" stroke-linecap=\"round\" stroke-miterlimit=\"10\" stroke-width=\"2\" stroke=\"\" d=\"M17 8.5C15.23 8.97 14.07 10.84 14.01 13.27C14 13.33 14 13.4 14 13.47V13.5\"></path>\n<path stroke-linejoin=\"round\" stroke-linecap=\"round\" stroke-miterlimit=\"10\" stroke-width=\"2\" stroke=\"\" d=\"M9 8.5C7.23 8.97 6.07 10.84 6.01 13.27C6 13.33 6 13.4 6 13.47V13.5\"></path>\n<path stroke-linejoin=\"round\" stroke-linecap=\"round\" stroke-miterlimit=\"10\" stroke-width=\"2\" stroke=\"\" d=\"M15.97 11.5H16.04C17.12 11.5 18 12.38 18 13.47V13.53C18 14.62 17.12 15.5 16.03 15.5H15.96C14.88 15.5 14 14.62 14 13.53V13.46C14 12.38 14.88 11.5 15.97 11.5Z\"></path>\n<path stroke-linejoin=\"round\" stroke-linecap=\"round\" stroke-miterlimit=\"10\" stroke-width=\"2\" stroke=\"\" d=\"M7.97 11.5H8.04C9.12 11.5 10 12.38 10 13.47V13.53C10 14.62 9.12 15.5 8.03 15.5H7.97C6.88 15.5 6 14.62 6 13.53V13.46C6 12.38 6.88 11.5 7.97 11.5Z\"></path>\n</svg>\n</span><p><strong>Nagle ç®—æ³•</strong></p>\n<ul>\n<li>ã€å³ä½¿å‘é€ä¸€ä¸ªå­—èŠ‚ï¼Œä¹Ÿéœ€è¦åŠ å…¥ tcp å¤´å’Œ ip å¤´ï¼Œä¹Ÿå°±æ˜¯æ€»å­—èŠ‚æ•°ä¼šä½¿ç”¨ 41 bytesï¼Œéå¸¸ä¸ç»æµã€‚å› æ­¤ä¸ºäº†æé«˜ç½‘ç»œåˆ©ç”¨ç‡ï¼Œtcp å¸Œæœ›å°½å¯èƒ½å‘é€è¶³å¤Ÿå¤§çš„æ•°æ®ã€‘ï¼Œè¿™å°±æ˜¯ Nagle ç®—æ³•äº§ç”Ÿçš„ç¼˜ç”±</li>\n<li>è¯¥ç®—æ³•æ˜¯æŒ‡å‘é€ç«¯<strong>å³ä½¿è¿˜æœ‰åº”è¯¥å‘é€çš„æ•°æ®ï¼Œä½†å¦‚æœè¿™éƒ¨åˆ†æ•°æ®å¾ˆå°‘çš„è¯ï¼Œåˆ™è¿›è¡Œå»¶è¿Ÿå‘é€</strong><ul>\n<li>å¦‚æœ <strong>SO_SNDBUF çš„æ•°æ®è¾¾åˆ° MSS</strong>ï¼Œåˆ™éœ€è¦å‘é€</li>\n<li>å¦‚æœ <strong>SO_SNDBUF ä¸­å«æœ‰ FINï¼ˆè¡¨ç¤ºéœ€è¦è¿æ¥å…³é—­ï¼‰è¿™æ—¶å°†å‰©ä½™æ•°æ®å‘é€ï¼Œå†å…³é—­</strong></li>\n<li>å¦‚æœ <strong>TCP_NODELAY &#x3D; true</strong>ï¼Œåˆ™éœ€è¦å‘é€</li>\n<li><strong>å·²å‘é€çš„æ•°æ®éƒ½æ”¶åˆ° ack</strong> æ—¶ï¼Œåˆ™éœ€è¦å‘é€</li>\n<li>ä¸Šè¿°æ¡ä»¶<strong>ä¸æ»¡è¶³ï¼Œä½†å‘ç”Ÿè¶…æ—¶ï¼ˆä¸€èˆ¬ä¸º 200msï¼‰åˆ™éœ€è¦å‘</strong>é€</li>\n<li></li>\n<li><strong>é™¤ä¸Šè¿°æƒ…å†µï¼Œå»¶è¿Ÿå‘</strong>é€</li>\n</ul>\n</li>\n</ul></blockquote>\n<h3 id=\"1-4-è§£å†³æ–¹æ¡ˆ\"><a href=\"#1-4-è§£å†³æ–¹æ¡ˆ\" class=\"headerlink\" title=\"1.4 è§£å†³æ–¹æ¡ˆ\"></a>1.4 è§£å†³æ–¹æ¡ˆ</h3><ol>\n<li><strong>çŸ­é“¾æ¥ï¼Œå‘ä¸€ä¸ªåŒ…å»ºç«‹ä¸€æ¬¡è¿æ¥</strong>ï¼Œè¿™æ ·è¿æ¥å»ºç«‹åˆ°è¿æ¥æ–­å¼€ä¹‹é—´å°±æ˜¯æ¶ˆæ¯çš„è¾¹ç•Œï¼Œç¼ºç‚¹æ•ˆç‡å¤ªä½</li>\n<li>æ¯ä¸€æ¡æ¶ˆæ¯é‡‡ç”¨<strong>å›ºå®šé•¿åº¦ï¼Œç¼ºç‚¹æµªè´¹ç©ºé—´</strong></li>\n<li>æ¯ä¸€æ¡æ¶ˆæ¯é‡‡ç”¨<strong>åˆ†éš”ç¬¦ï¼Œä¾‹å¦‚ \\nï¼Œç¼ºç‚¹éœ€è¦è½¬ä¹‰</strong></li>\n<li>æ¯ä¸€æ¡æ¶ˆæ¯<strong>åˆ†ä¸º head å’Œ bodyï¼Œhead ä¸­åŒ…å« body çš„é•¿åº¦</strong></li>\n</ol>\n<h4 id=\"æ–¹æ³•1ï¼ŒçŸ­é“¾æ¥\"><a href=\"#æ–¹æ³•1ï¼ŒçŸ­é“¾æ¥\" class=\"headerlink\" title=\"æ–¹æ³•1ï¼ŒçŸ­é“¾æ¥\"></a>æ–¹æ³•1ï¼ŒçŸ­é“¾æ¥</h4><p>ä»¥è§£å†³ç²˜åŒ…ä¸ºä¾‹</p>\n<pre class=\"line-numbers language-java\" data-language=\"java\"><code class=\"language-java\">public class HelloWorldClient &#123;\n    static final Logger log &#x3D; LoggerFactory.getLogger(HelloWorldClient.class);\n\n    public static void main(String[] args) &#123;\n        &#x2F;&#x2F; åˆ† 10 æ¬¡å‘é€\n        for (int i &#x3D; 0; i &lt; 10; i++) &#123;\n            send();\n        &#125;\n    &#125;\n\n    private static void send() &#123;\n        NioEventLoopGroup worker &#x3D; new NioEventLoopGroup();\n        try &#123;\n            Bootstrap bootstrap &#x3D; new Bootstrap();\n            bootstrap.channel(NioSocketChannel.class);\n            bootstrap.group(worker);\n            bootstrap.handler(new ChannelInitializer&lt;SocketChannel&gt;() &#123;\n                @Override\n                protected void initChannel(SocketChannel ch) throws Exception &#123;\n                    log.debug(&quot;conneted...&quot;);\n                    ch.pipeline().addLast(new LoggingHandler(LogLevel.DEBUG));\n                    ch.pipeline().addLast(new ChannelInboundHandlerAdapter() &#123;\n                        @Override\n                        public void channelActive(ChannelHandlerContext ctx) throws Exception &#123;\n                            log.debug(&quot;sending...&quot;);\n                            ByteBuf buffer &#x3D; ctx.alloc().buffer();\n                            buffer.writeBytes(new byte[]&#123;0, 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15&#125;);\n                            ctx.writeAndFlush(buffer);\n                            &#x2F;&#x2F; å‘å®Œå³å…³\n                            ctx.close();&#x2F;&#x2F;\n                        &#125;\n                    &#125;);\n                &#125;\n            &#125;);\n            ChannelFuture channelFuture &#x3D; bootstrap.connect(&quot;localhost&quot;, 8080).sync();\n            channelFuture.channel().closeFuture().sync();\n\n        &#125; catch (InterruptedException e) &#123;\n            log.error(&quot;client error&quot;, e);\n        &#125; finally &#123;\n            worker.shutdownGracefully();\n        &#125;\n    &#125;\n&#125;</code></pre>\n\n<p>è¾“å‡ºï¼Œç•¥</p>\n<blockquote><span class=\"custom-blockquote-svg\"><svg width=\"24\" height=\"24\" viewBox=\"0 0 24 24\" fill=\"\" xmlns=\"http://www.w3.org/2000/svg\" data-reactroot=\"\">\n<path fill=\"\" d=\"M22 12C22 6.5 17.5 2 12 2C6.5 2 2 6.5 2 12C2 17.5 6.5 22 12 22C13.8 22 15.5 21.5 17 20.6L22 22L20.7 17C21.5 15.5 22 13.8 22 12Z\" undefined=\"1\"></path>\n<path fill=\"\" d=\"M15.97 11.5H16.04C17.12 11.5 18 12.38 18 13.47V13.53C18 14.62 17.12 15.5 16.03 15.5H15.96C14.88 15.5 14 14.62 14 13.53V13.46C14 12.38 14.88 11.5 15.97 11.5Z\" undefined=\"1\"></path>\n<path fill=\"\" d=\"M7.97 11.5H8.04C9.12 11.5 10 12.38 10 13.47V13.53C10 14.62 9.12 15.5 8.03 15.5H7.97C6.88 15.5 6 14.62 6 13.53V13.46C6 12.38 6.88 11.5 7.97 11.5Z\" undefined=\"1\"></path>\n<path stroke-linejoin=\"round\" stroke-linecap=\"round\" stroke-miterlimit=\"10\" stroke-width=\"2\" stroke=\"\" d=\"M17 8.5C15.23 8.97 14.07 10.84 14.01 13.27C14 13.33 14 13.4 14 13.47V13.5\"></path>\n<path stroke-linejoin=\"round\" stroke-linecap=\"round\" stroke-miterlimit=\"10\" stroke-width=\"2\" stroke=\"\" d=\"M9 8.5C7.23 8.97 6.07 10.84 6.01 13.27C6 13.33 6 13.4 6 13.47V13.5\"></path>\n<path stroke-linejoin=\"round\" stroke-linecap=\"round\" stroke-miterlimit=\"10\" stroke-width=\"2\" stroke=\"\" d=\"M15.97 11.5H16.04C17.12 11.5 18 12.38 18 13.47V13.53C18 14.62 17.12 15.5 16.03 15.5H15.96C14.88 15.5 14 14.62 14 13.53V13.46C14 12.38 14.88 11.5 15.97 11.5Z\"></path>\n<path stroke-linejoin=\"round\" stroke-linecap=\"round\" stroke-miterlimit=\"10\" stroke-width=\"2\" stroke=\"\" d=\"M7.97 11.5H8.04C9.12 11.5 10 12.38 10 13.47V13.53C10 14.62 9.12 15.5 8.03 15.5H7.97C6.88 15.5 6 14.62 6 13.53V13.46C6 12.38 6.88 11.5 7.97 11.5Z\"></path>\n</svg>\n</span><p><strong>åŠåŒ…ç”¨è¿™ç§åŠæ³•è¿˜æ˜¯ä¸å¥½è§£å†³</strong>ï¼Œå› ä¸ºæ¥æ”¶æ–¹çš„ç¼“å†²åŒºå¤§å°æ˜¯æœ‰é™çš„</p>\n<pre class=\"line-numbers language-java\" data-language=\"java\"><code class=\"language-java\">public class HelloWorldServer &#123;\n static final Logger log &#x3D; LoggerFactory.getLogger(HelloWorldServer.class);\n void start() &#123;\n     NioEventLoopGroup boss &#x3D; new NioEventLoopGroup(1);\n     NioEventLoopGroup worker &#x3D; new NioEventLoopGroup();\n     try &#123;\n         ServerBootstrap serverBootstrap &#x3D; new ServerBootstrap();\n         serverBootstrap.channel(NioServerSocketChannel.class);\n         &#x2F;&#x2F;è°ƒæ•´ç³»ç»Ÿçš„æ¥æ”¶ç¼“å†²åŒºï¼ˆæ»‘åŠ¨çª—å£ï¼‰\n         &#x2F;&#x2F;serverBootstrap.option(ChannelOption.SO_RCVBUF, 10);&#x2F;&#x2F;åŠåŒ…\n         &#x2F;&#x2F;è°ƒæ•´nettyé¢æ¥æ”¶ç¼“å†²åŒºï¼ˆbyteBufï¼‰\n         serverBootstrap.childOption(ChannelOption.RCVBUF_ALLOCATOR, new AdaptiveRecvByteBufAllocator(16, 16, 16));\n\n\n         serverBootstrap.group(boss, worker);\n         serverBootstrap.childHandler(new ChannelInitializer&lt;SocketChannel&gt;() &#123;\n             @Override\n             protected void initChannel(SocketChannel ch) throws Exception &#123;\n                 ch.pipeline().addLast(new LoggingHandler(LogLevel.DEBUG));\n                 ch.pipeline().addLast(new ChannelInboundHandlerAdapter() &#123;\n                     @Override\n                     public void channelActive(ChannelHandlerContext ctx) throws Exception &#123;\n                         log.debug(&quot;connected &#123;&#125;&quot;, ctx.channel());\n                         super.channelActive(ctx);\n                     &#125;\n\n                     @Override\n                     public void channelInactive(ChannelHandlerContext ctx) throws Exception &#123;\n                         log.debug(&quot;disconnect &#123;&#125;&quot;, ctx.channel());\n                         super.channelInactive(ctx);\n                     &#125;\n                 &#125;);\n             &#125;\n         &#125;);\n         ChannelFuture channelFuture &#x3D; serverBootstrap.bind(8080);\n         log.debug(&quot;&#123;&#125; binding...&quot;, channelFuture.channel());\n         channelFuture.sync();&#x2F;&#x2F;\n         log.debug(&quot;&#123;&#125; bound...&quot;, channelFuture.channel());\n         channelFuture.channel().closeFuture().sync();&#x2F;&#x2F;\n     &#125; catch (InterruptedException e) &#123;\n         log.error(&quot;server error&quot;, e);\n     &#125; finally &#123;\n         boss.shutdownGracefully();\n         worker.shutdownGracefully();\n         log.debug(&quot;stoped&quot;);\n     &#125;\n &#125;\n\n public static void main(String[] args) &#123;\n     new HelloWorldServer().start();\n &#125;\n&#125;</code></pre>\n\n</blockquote>\n<p>16B 2B 16 2 â€¦â€¦</p>\n<h4 id=\"æ–¹æ³•2ï¼Œå›ºå®šé•¿åº¦-FixedLengthFrameDecoder\"><a href=\"#æ–¹æ³•2ï¼Œå›ºå®šé•¿åº¦-FixedLengthFrameDecoder\" class=\"headerlink\" title=\"æ–¹æ³•2ï¼Œå›ºå®šé•¿åº¦ FixedLengthFrameDecoder\"></a>æ–¹æ³•2ï¼Œå›ºå®šé•¿åº¦ FixedLengthFrameDecoder</h4><p>è®©æ‰€æœ‰æ•°æ®åŒ…é•¿åº¦å›ºå®šï¼ˆå‡è®¾é•¿åº¦ä¸º 8 å­—èŠ‚ï¼‰ï¼ŒæœåŠ¡å™¨ç«¯åŠ å…¥</p>\n<pre class=\"line-numbers language-java\" data-language=\"java\"><code class=\"language-java\">ch.pipeline().addLast(new FixedLengthFrameDecoder(8));</code></pre>\n\n<p>å®¢æˆ·ç«¯æµ‹è¯•ä»£ç ï¼Œæ³¨æ„, é‡‡ç”¨è¿™ç§æ–¹æ³•åï¼Œå®¢æˆ·ç«¯ä»€ä¹ˆæ—¶å€™ flush éƒ½å¯ä»¥</p>\n<pre class=\"line-numbers language-java\" data-language=\"java\"><code class=\"language-java\">public class HelloWorldClient &#123;\n    static final Logger log &#x3D; LoggerFactory.getLogger(HelloWorldClient.class);\n\n    public static void main(String[] args) &#123;\n        NioEventLoopGroup worker &#x3D; new NioEventLoopGroup();\n        try &#123;\n            Bootstrap bootstrap &#x3D; new Bootstrap();\n            bootstrap.channel(NioSocketChannel.class);\n            bootstrap.group(worker);\n            bootstrap.handler(new ChannelInitializer&lt;SocketChannel&gt;() &#123;\n                @Override\n                protected void initChannel(SocketChannel ch) throws Exception &#123;\n                    log.debug(&quot;connetted...&quot;);\n                    ch.pipeline().addLast(new LoggingHandler(LogLevel.DEBUG));\n                    ch.pipeline().addLast(new ChannelInboundHandlerAdapter() &#123;\n                        @Override\n                        public void channelActive(ChannelHandlerContext ctx) throws Exception &#123;\n                            log.debug(&quot;sending...&quot;);\n                            &#x2F;&#x2F; å‘é€å†…å®¹éšæœºçš„æ•°æ®åŒ…\n                            Random r &#x3D; new Random();\n                            char c &#x3D; &#39;a&#39;;\n                            ByteBuf buffer &#x3D; ctx.alloc().buffer();\n                            for (int i &#x3D; 0; i &lt; 10; i++) &#123;\n                                byte[] bytes &#x3D; new byte[8];\n                                for (int j &#x3D; 0; j &lt; r.nextInt(8); j++) &#123;\n                                    bytes[j] &#x3D; (byte) c;\n                                &#125;\n                                c++;\n                                buffer.writeBytes(bytes);\n                            &#125;\n                            ctx.writeAndFlush(buffer);\n                        &#125;\n                    &#125;);\n                &#125;\n            &#125;);\n            ChannelFuture channelFuture &#x3D; bootstrap.connect(&quot;192.168.0.103&quot;, 9090).sync();\n            channelFuture.channel().closeFuture().sync();\n\n        &#125; catch (InterruptedException e) &#123;\n            log.error(&quot;client error&quot;, e);\n        &#125; finally &#123;\n            worker.shutdownGracefully();\n        &#125;\n    &#125;\n&#125;</code></pre>\n\n<p>å®¢æˆ·ç«¯è¾“å‡º ã€ç²˜åŒ…ã€‘</p>\n<pre class=\"line-numbers language-none\"><code class=\"language-none\">12:07:00 [DEBUG] [nioEventLoopGroup-2-1] c.i.n.HelloWorldClient - connetted...\n12:07:00 [DEBUG] [nioEventLoopGroup-2-1] i.n.h.l.LoggingHandler - [id: 0x3c2ef3c2] REGISTERED\n12:07:00 [DEBUG] [nioEventLoopGroup-2-1] i.n.h.l.LoggingHandler - [id: 0x3c2ef3c2] CONNECT: &#x2F;192.168.0.103:9090\n12:07:00 [DEBUG] [nioEventLoopGroup-2-1] i.n.h.l.LoggingHandler - [id: 0x3c2ef3c2, L:&#x2F;192.168.0.103:53155 - R:&#x2F;192.168.0.103:9090] ACTIVE\n12:07:00 [DEBUG] [nioEventLoopGroup-2-1] c.i.n.HelloWorldClient - sending...\n12:07:00 [DEBUG] [nioEventLoopGroup-2-1] i.n.h.l.LoggingHandler - [id: 0x3c2ef3c2, L:&#x2F;192.168.0.103:53155 - R:&#x2F;192.168.0.103:9090] WRITE: 80B\n         +-------------------------------------------------+\n         |  0  1  2  3  4  5  6  7  8  9  a  b  c  d  e  f |\n+--------+-------------------------------------------------+----------------+\n|00000000| 61 61 61 61 00 00 00 00 62 00 00 00 00 00 00 00 |aaaa....b.......|\n|00000010| 63 63 00 00 00 00 00 00 64 00 00 00 00 00 00 00 |cc......d.......|\n|00000020| 00 00 00 00 00 00 00 00 66 66 66 66 00 00 00 00 |........ffff....|\n|00000030| 67 67 67 00 00 00 00 00 68 00 00 00 00 00 00 00 |ggg.....h.......|\n|00000040| 69 69 69 69 69 00 00 00 6a 6a 6a 6a 00 00 00 00 |iiiii...jjjj....|\n+--------+-------------------------------------------------+----------------+\n12:07:00 [DEBUG] [nioEventLoopGroup-2-1] i.n.h.l.LoggingHandler - [id: 0x3c2ef3c2, L:&#x2F;192.168.0.103:53155 - R:&#x2F;192.168.0.103:9090] FLUSH</code></pre>\n\n<p>æœåŠ¡ç«¯è¾“å‡º ã€æ­£ç¡®æ¥æ”¶ã€‘</p>\n<pre class=\"line-numbers language-none\"><code class=\"language-none\">12:06:51 [DEBUG] [main] c.i.n.HelloWorldServer - [id: 0xe3d9713f] binding...\n12:06:51 [DEBUG] [main] c.i.n.HelloWorldServer - [id: 0xe3d9713f, L:&#x2F;192.168.0.103:9090] bound...\n12:07:00 [DEBUG] [nioEventLoopGroup-3-1] i.n.h.l.LoggingHandler - [id: 0xd739f137, L:&#x2F;192.168.0.103:9090 - R:&#x2F;192.168.0.103:53155] REGISTERED\n12:07:00 [DEBUG] [nioEventLoopGroup-3-1] i.n.h.l.LoggingHandler - [id: 0xd739f137, L:&#x2F;192.168.0.103:9090 - R:&#x2F;192.168.0.103:53155] ACTIVE\n12:07:00 [DEBUG] [nioEventLoopGroup-3-1] c.i.n.HelloWorldServer - connected [id: 0xd739f137, L:&#x2F;192.168.0.103:9090 - R:&#x2F;192.168.0.103:53155]\n12:07:00 [DEBUG] [nioEventLoopGroup-3-1] i.n.h.l.LoggingHandler - [id: 0xd739f137, L:&#x2F;192.168.0.103:9090 - R:&#x2F;192.168.0.103:53155] READ: 8B\n         +-------------------------------------------------+\n         |  0  1  2  3  4  5  6  7  8  9  a  b  c  d  e  f |\n+--------+-------------------------------------------------+----------------+\n|00000000| 61 61 61 61 00 00 00 00                         |aaaa....        |\n+--------+-------------------------------------------------+----------------+\n12:07:00 [DEBUG] [nioEventLoopGroup-3-1] i.n.h.l.LoggingHandler - [id: 0xd739f137, L:&#x2F;192.168.0.103:9090 - R:&#x2F;192.168.0.103:53155] READ: 8B\n         +-------------------------------------------------+\n         |  0  1  2  3  4  5  6  7  8  9  a  b  c  d  e  f |\n+--------+-------------------------------------------------+----------------+\n|00000000| 62 00 00 00 00 00 00 00                         |b.......        |\n+--------+-------------------------------------------------+----------------+\n12:07:00 [DEBUG] [nioEventLoopGroup-3-1] i.n.h.l.LoggingHandler - [id: 0xd739f137, L:&#x2F;192.168.0.103:9090 - R:&#x2F;192.168.0.103:53155] READ: 8B\n         +-------------------------------------------------+\n         |  0  1  2  3  4  5  6  7  8  9  a  b  c  d  e  f |\n+--------+-------------------------------------------------+----------------+\n|00000000| 63 63 00 00 00 00 00 00                         |cc......        |\n+--------+-------------------------------------------------+----------------+\n12:07:00 [DEBUG] [nioEventLoopGroup-3-1] i.n.h.l.LoggingHandler - [id: 0xd739f137, L:&#x2F;192.168.0.103:9090 - R:&#x2F;192.168.0.103:53155] READ: 8B\n         +-------------------------------------------------+\n         |  0  1  2  3  4  5  6  7  8  9  a  b  c  d  e  f |\n+--------+-------------------------------------------------+----------------+\n|00000000| 64 00 00 00 00 00 00 00                         |d.......        |\n+--------+-------------------------------------------------+----------------+\n12:07:00 [DEBUG] [nioEventLoopGroup-3-1] i.n.h.l.LoggingHandler - [id: 0xd739f137, L:&#x2F;192.168.0.103:9090 - R:&#x2F;192.168.0.103:53155] READ: 8B\n         +-------------------------------------------------+\n         |  0  1  2  3  4  5  6  7  8  9  a  b  c  d  e  f |\n+--------+-------------------------------------------------+----------------+\n|00000000| 00 00 00 00 00 00 00 00                         |........        |\n+--------+-------------------------------------------------+----------------+\n12:07:00 [DEBUG] [nioEventLoopGroup-3-1] i.n.h.l.LoggingHandler - [id: 0xd739f137, L:&#x2F;192.168.0.103:9090 - R:&#x2F;192.168.0.103:53155] READ: 8B\n         +-------------------------------------------------+\n         |  0  1  2  3  4  5  6  7  8  9  a  b  c  d  e  f |\n+--------+-------------------------------------------------+----------------+\n|00000000| 66 66 66 66 00 00 00 00                         |ffff....        |\n+--------+-------------------------------------------------+----------------+\n12:07:00 [DEBUG] [nioEventLoopGroup-3-1] i.n.h.l.LoggingHandler - [id: 0xd739f137, L:&#x2F;192.168.0.103:9090 - R:&#x2F;192.168.0.103:53155] READ: 8B\n         +-------------------------------------------------+\n         |  0  1  2  3  4  5  6  7  8  9  a  b  c  d  e  f |\n+--------+-------------------------------------------------+----------------+\n|00000000| 67 67 67 00 00 00 00 00                         |ggg.....        |\n+--------+-------------------------------------------------+----------------+\n12:07:00 [DEBUG] [nioEventLoopGroup-3-1] i.n.h.l.LoggingHandler - [id: 0xd739f137, L:&#x2F;192.168.0.103:9090 - R:&#x2F;192.168.0.103:53155] READ: 8B\n         +-------------------------------------------------+\n         |  0  1  2  3  4  5  6  7  8  9  a  b  c  d  e  f |\n+--------+-------------------------------------------------+----------------+\n|00000000| 68 00 00 00 00 00 00 00                         |h.......        |\n+--------+-------------------------------------------------+----------------+\n12:07:00 [DEBUG] [nioEventLoopGroup-3-1] i.n.h.l.LoggingHandler - [id: 0xd739f137, L:&#x2F;192.168.0.103:9090 - R:&#x2F;192.168.0.103:53155] READ: 8B\n         +-------------------------------------------------+\n         |  0  1  2  3  4  5  6  7  8  9  a  b  c  d  e  f |\n+--------+-------------------------------------------------+----------------+\n|00000000| 69 69 69 69 69 00 00 00                         |iiiii...        |\n+--------+-------------------------------------------------+----------------+\n12:07:00 [DEBUG] [nioEventLoopGroup-3-1] i.n.h.l.LoggingHandler - [id: 0xd739f137, L:&#x2F;192.168.0.103:9090 - R:&#x2F;192.168.0.103:53155] READ: 8B\n         +-------------------------------------------------+\n         |  0  1  2  3  4  5  6  7  8  9  a  b  c  d  e  f |\n+--------+-------------------------------------------------+----------------+\n|00000000| 6a 6a 6a 6a 00 00 00 00                         |jjjj....        |\n+--------+-------------------------------------------------+----------------+\n12:07:00 [DEBUG] [nioEventLoopGroup-3-1] i.n.h.l.LoggingHandler - [id: 0xd739f137, L:&#x2F;192.168.0.103:9090 - R:&#x2F;192.168.0.103:53155] READ COMPLETE</code></pre>\n\n<p>ç¼ºç‚¹æ˜¯ï¼Œæ•°æ®åŒ…çš„å¤§å°ä¸å¥½æŠŠæ¡</p>\n<ul>\n<li>é•¿åº¦å®šçš„å¤ªå¤§ï¼Œæµªè´¹</li>\n<li>é•¿åº¦å®šçš„å¤ªå°ï¼Œå¯¹æŸäº›æ•°æ®åŒ…åˆæ˜¾å¾—ä¸å¤Ÿ</li>\n</ul>\n<h4 id=\"æ–¹æ³•3ï¼Œå›ºå®šåˆ†éš”ç¬¦-LineBasedFrameDecoder\"><a href=\"#æ–¹æ³•3ï¼Œå›ºå®šåˆ†éš”ç¬¦-LineBasedFrameDecoder\" class=\"headerlink\" title=\"æ–¹æ³•3ï¼Œå›ºå®šåˆ†éš”ç¬¦ LineBasedFrameDecoder\"></a>æ–¹æ³•3ï¼Œå›ºå®šåˆ†éš”ç¬¦ LineBasedFrameDecoder</h4><p>æœåŠ¡ç«¯åŠ å…¥ï¼Œé»˜è®¤ä»¥ \\n æˆ– \\r\\n ä½œä¸ºåˆ†éš”ç¬¦ï¼Œå¦‚æœè¶…å‡ºæŒ‡å®šé•¿åº¦ä»æœªå‡ºç°åˆ†éš”ç¬¦ï¼Œåˆ™æŠ›å‡ºå¼‚å¸¸</p>\n<pre class=\"line-numbers language-java\" data-language=\"java\"><code class=\"language-java\">ch.pipeline().addLast(new LineBasedFrameDecoder(1024));&#x2F;&#x2F; linux&#39;\\n&#39; win&#39;\\r\\n&#39;\n\n&#x2F;&#x2F;ByteBuf buffer &#x3D; ByteBufAllocator.DEFAULT.buffer();\n&#x2F;&#x2F;buffer.writeBytes(&quot;\\n&quot;.getBytes());\n&#x2F;&#x2F;ch.pipeline().addLast(new DelimiterBasedFrameDecoder(1024, buffer));&#x2F;&#x2F;delimiteråˆ†éš”ç¬¦</code></pre>\n\n<p>å®¢æˆ·ç«¯åœ¨æ¯æ¡æ¶ˆæ¯ä¹‹åï¼ŒåŠ å…¥ \\n åˆ†éš”ç¬¦</p>\n<pre class=\"line-numbers language-java\" data-language=\"java\"><code class=\"language-java\">public class HelloWorldClient &#123;\n    static final Logger log &#x3D; LoggerFactory.getLogger(HelloWorldClient.class);\n\n    public static void main(String[] args) &#123;\n        NioEventLoopGroup worker &#x3D; new NioEventLoopGroup();\n        try &#123;\n            Bootstrap bootstrap &#x3D; new Bootstrap();\n            bootstrap.channel(NioSocketChannel.class);\n            bootstrap.group(worker);\n            bootstrap.handler(new ChannelInitializer&lt;SocketChannel&gt;() &#123;\n                @Override\n                protected void initChannel(SocketChannel ch) throws Exception &#123;\n                    log.debug(&quot;connetted...&quot;);\n                    ch.pipeline().addLast(new LoggingHandler(LogLevel.DEBUG));\n                    ch.pipeline().addLast(new ChannelInboundHandlerAdapter() &#123;\n                        @Override\n                        public void channelActive(ChannelHandlerContext ctx) throws Exception &#123;\n                            log.debug(&quot;sending...&quot;);\n                            Random r &#x3D; new Random();\n                            char c &#x3D; &#39;a&#39;;\n                            ByteBuf buffer &#x3D; ctx.alloc().buffer();\n                            for (int i &#x3D; 0; i &lt; 10; i++) &#123;\n                                for (int j &#x3D; 1; j &lt;&#x3D; r.nextInt(16)+1; j++) &#123;\n                                    buffer.writeByte((byte) c);\n                                &#125;\n                                buffer.writeByte(10);&#x2F;&#x2F;\n                                c++;\n                            &#125;\n                            ctx.writeAndFlush(buffer);\n                        &#125;\n                    &#125;);\n                &#125;\n            &#125;);\n            ChannelFuture channelFuture &#x3D; bootstrap.connect(&quot;192.168.0.103&quot;, 9090).sync();\n            channelFuture.channel().closeFuture().sync();\n\n        &#125; catch (InterruptedException e) &#123;\n            log.error(&quot;client error&quot;, e);\n        &#125; finally &#123;\n            worker.shutdownGracefully();\n        &#125;\n    &#125;\n&#125;</code></pre>\n\n<p>å®¢æˆ·ç«¯è¾“å‡º</p>\n<pre class=\"line-numbers language-none\"><code class=\"language-none\">14:08:18 [DEBUG] [nioEventLoopGroup-2-1] c.i.n.HelloWorldClient - connetted...\n14:08:18 [DEBUG] [nioEventLoopGroup-2-1] i.n.h.l.LoggingHandler - [id: 0x1282d755] REGISTERED\n14:08:18 [DEBUG] [nioEventLoopGroup-2-1] i.n.h.l.LoggingHandler - [id: 0x1282d755] CONNECT: &#x2F;192.168.0.103:9090\n14:08:18 [DEBUG] [nioEventLoopGroup-2-1] i.n.h.l.LoggingHandler - [id: 0x1282d755, L:&#x2F;192.168.0.103:63641 - R:&#x2F;192.168.0.103:9090] ACTIVE\n14:08:18 [DEBUG] [nioEventLoopGroup-2-1] c.i.n.HelloWorldClient - sending...\n14:08:18 [DEBUG] [nioEventLoopGroup-2-1] i.n.h.l.LoggingHandler - [id: 0x1282d755, L:&#x2F;192.168.0.103:63641 - R:&#x2F;192.168.0.103:9090] WRITE: 60B\n         +-------------------------------------------------+\n         |  0  1  2  3  4  5  6  7  8  9  a  b  c  d  e  f |\n+--------+-------------------------------------------------+----------------+\n|00000000| 61 0a 62 62 62 0a 63 63 63 0a 64 64 0a 65 65 65 |a.bbb.ccc.dd.eee|\n|00000010| 65 65 65 65 65 65 65 0a 66 66 0a 67 67 67 67 67 |eeeeeee.ff.ggggg|\n|00000020| 67 67 0a 68 68 68 68 0a 69 69 69 69 69 69 69 0a |gg.hhhh.iiiiiii.|\n|00000030| 6a 6a 6a 6a 6a 6a 6a 6a 6a 6a 6a 0a             |jjjjjjjjjjj.    |\n+--------+-------------------------------------------------+----------------+\n14:08:18 [DEBUG] [nioEventLoopGroup-2-1] i.n.h.l.LoggingHandler - [id: 0x1282d755, L:&#x2F;192.168.0.103:63641 - R:&#x2F;192.168.0.103:9090] FLUSH</code></pre>\n\n\n\n<p>æœåŠ¡ç«¯è¾“å‡º</p>\n<pre class=\"line-numbers language-none\"><code class=\"language-none\">14:08:18 [DEBUG] [nioEventLoopGroup-3-5] c.i.n.HelloWorldServer - connected [id: 0xa4b3be43, L:&#x2F;192.168.0.103:9090 - R:&#x2F;192.168.0.103:63641]\n14:08:18 [DEBUG] [nioEventLoopGroup-3-5] i.n.h.l.LoggingHandler - [id: 0xa4b3be43, L:&#x2F;192.168.0.103:9090 - R:&#x2F;192.168.0.103:63641] READ: 1B\n         +-------------------------------------------------+\n         |  0  1  2  3  4  5  6  7  8  9  a  b  c  d  e  f |\n+--------+-------------------------------------------------+----------------+\n|00000000| 61                                              |a               |\n+--------+-------------------------------------------------+----------------+\n14:08:18 [DEBUG] [nioEventLoopGroup-3-5] i.n.h.l.LoggingHandler - [id: 0xa4b3be43, L:&#x2F;192.168.0.103:9090 - R:&#x2F;192.168.0.103:63641] READ: 3B\n         +-------------------------------------------------+\n         |  0  1  2  3  4  5  6  7  8  9  a  b  c  d  e  f |\n+--------+-------------------------------------------------+----------------+\n|00000000| 62 62 62                                        |bbb             |\n+--------+-------------------------------------------------+----------------+\n14:08:18 [DEBUG] [nioEventLoopGroup-3-5] i.n.h.l.LoggingHandler - [id: 0xa4b3be43, L:&#x2F;192.168.0.103:9090 - R:&#x2F;192.168.0.103:63641] READ: 3B\n         +-------------------------------------------------+\n         |  0  1  2  3  4  5  6  7  8  9  a  b  c  d  e  f |\n+--------+-------------------------------------------------+----------------+\n|00000000| 63 63 63                                        |ccc             |\n+--------+-------------------------------------------------+----------------+\n14:08:18 [DEBUG] [nioEventLoopGroup-3-5] i.n.h.l.LoggingHandler - [id: 0xa4b3be43, L:&#x2F;192.168.0.103:9090 - R:&#x2F;192.168.0.103:63641] READ: 2B\n         +-------------------------------------------------+\n         |  0  1  2  3  4  5  6  7  8  9  a  b  c  d  e  f |\n+--------+-------------------------------------------------+----------------+\n|00000000| 64 64                                           |dd              |\n+--------+-------------------------------------------------+----------------+\n14:08:18 [DEBUG] [nioEventLoopGroup-3-5] i.n.h.l.LoggingHandler - [id: 0xa4b3be43, L:&#x2F;192.168.0.103:9090 - R:&#x2F;192.168.0.103:63641] READ: 10B\n         +-------------------------------------------------+\n         |  0  1  2  3  4  5  6  7  8  9  a  b  c  d  e  f |\n+--------+-------------------------------------------------+----------------+\n|00000000| 65 65 65 65 65 65 65 65 65 65                   |eeeeeeeeee      |\n+--------+-------------------------------------------------+----------------+\n14:08:18 [DEBUG] [nioEventLoopGroup-3-5] i.n.h.l.LoggingHandler - [id: 0xa4b3be43, L:&#x2F;192.168.0.103:9090 - R:&#x2F;192.168.0.103:63641] READ: 2B\n         +-------------------------------------------------+\n         |  0  1  2  3  4  5  6  7  8  9  a  b  c  d  e  f |\n+--------+-------------------------------------------------+----------------+\n|00000000| 66 66                                           |ff              |\n+--------+-------------------------------------------------+----------------+\n14:08:18 [DEBUG] [nioEventLoopGroup-3-5] i.n.h.l.LoggingHandler - [id: 0xa4b3be43, L:&#x2F;192.168.0.103:9090 - R:&#x2F;192.168.0.103:63641] READ: 7B\n         +-------------------------------------------------+\n         |  0  1  2  3  4  5  6  7  8  9  a  b  c  d  e  f |\n+--------+-------------------------------------------------+----------------+\n|00000000| 67 67 67 67 67 67 67                            |ggggggg         |\n+--------+-------------------------------------------------+----------------+\n14:08:18 [DEBUG] [nioEventLoopGroup-3-5] i.n.h.l.LoggingHandler - [id: 0xa4b3be43, L:&#x2F;192.168.0.103:9090 - R:&#x2F;192.168.0.103:63641] READ: 4B\n         +-------------------------------------------------+\n         |  0  1  2  3  4  5  6  7  8  9  a  b  c  d  e  f |\n+--------+-------------------------------------------------+----------------+\n|00000000| 68 68 68 68                                     |hhhh            |\n+--------+-------------------------------------------------+----------------+\n14:08:18 [DEBUG] [nioEventLoopGroup-3-5] i.n.h.l.LoggingHandler - [id: 0xa4b3be43, L:&#x2F;192.168.0.103:9090 - R:&#x2F;192.168.0.103:63641] READ: 7B\n         +-------------------------------------------------+\n         |  0  1  2  3  4  5  6  7  8  9  a  b  c  d  e  f |\n+--------+-------------------------------------------------+----------------+\n|00000000| 69 69 69 69 69 69 69                            |iiiiiii         |\n+--------+-------------------------------------------------+----------------+\n14:08:18 [DEBUG] [nioEventLoopGroup-3-5] i.n.h.l.LoggingHandler - [id: 0xa4b3be43, L:&#x2F;192.168.0.103:9090 - R:&#x2F;192.168.0.103:63641] READ: 11B\n         +-------------------------------------------------+\n         |  0  1  2  3  4  5  6  7  8  9  a  b  c  d  e  f |\n+--------+-------------------------------------------------+----------------+\n|00000000| 6a 6a 6a 6a 6a 6a 6a 6a 6a 6a 6a                |jjjjjjjjjjj     |\n+--------+-------------------------------------------------+----------------+\n14:08:18 [DEBUG] [nioEventLoopGroup-3-5] i.n.h.l.LoggingHandler - [id: 0xa4b3be43, L:&#x2F;192.168.0.103:9090 - R:&#x2F;192.168.0.103:63641] READ COMPLETE</code></pre>\n\n<p>ç¼ºç‚¹ï¼Œ<strong>å¤„ç†å­—ç¬¦æ•°æ®æ¯”è¾ƒåˆé€‚ï¼Œä½†ã€å¦‚æœå†…å®¹æœ¬èº«åŒ…å«äº†åˆ†éš”ç¬¦ï¼ˆå­—èŠ‚æ•°æ®å¸¸å¸¸ä¼šæœ‰æ­¤æƒ…å†µï¼‰ï¼Œé‚£ä¹ˆå°±ä¼šè§£æé”™è¯¯ã€‘</strong></p>\n<h4 id=\"æ–¹æ³•4ï¼Œé¢„è®¾é•¿åº¦-LengthFieldBasedFrameDecoder-max-lenå‰ä¸­å-Sæ”¶å»å°¾\"><a href=\"#æ–¹æ³•4ï¼Œé¢„è®¾é•¿åº¦-LengthFieldBasedFrameDecoder-max-lenå‰ä¸­å-Sæ”¶å»å°¾\" class=\"headerlink\" title=\"æ–¹æ³•4ï¼Œé¢„è®¾é•¿åº¦ LengthFieldBasedFrameDecoder(max,lenå‰ä¸­å,Sæ”¶å»å°¾)\"></a>æ–¹æ³•4ï¼Œé¢„è®¾é•¿åº¦ LengthFieldBasedFrameDecoder(max,lenå‰ä¸­å,Sæ”¶å»å°¾)</h4><p>serverï¼šåœ¨å‘é€æ¶ˆæ¯å‰ï¼Œå…ˆ<strong>çº¦å®š ç”¨å®šé•¿å­—èŠ‚è¡¨ç¤ºæ¥ä¸‹æ¥æ•°æ®çš„é•¿åº¦</strong></p>\n<pre class=\"line-numbers language-java\" data-language=\"java\"><code class=\"language-java\">&#x2F;&#x2F; æœ€å¤§é•¿åº¦ï¼Œé•¿åº¦åç§»(é•¿åº¦å‰)ï¼Œé•¿åº¦å ç”¨å­—èŠ‚(é•¿åº¦é•¿)ï¼Œé•¿åº¦è°ƒæ•´(é•¿åº¦å|å†…å®¹å‰)ï¼Œå‰¥ç¦»å­—èŠ‚æ•°(Sæ¥æ”¶ç«¯ï¼šå»é¦–)\nch.pipeline().addLast(new LengthFieldBasedFrameDecoder(1024, 0, 1, 0, 1));</code></pre>\n\n<p>å®¢æˆ·ç«¯ä»£ç </p>\n<pre class=\"line-numbers language-java\" data-language=\"java\"><code class=\"language-java\">public class HelloWorldClient &#123;\n    static final Logger log &#x3D; LoggerFactory.getLogger(HelloWorldClient.class);\n\n    public static void main(String[] args) &#123;\n        NioEventLoopGroup worker &#x3D; new NioEventLoopGroup();\n        try &#123;\n            Bootstrap bootstrap &#x3D; new Bootstrap();\n            bootstrap.channel(NioSocketChannel.class);\n            bootstrap.group(worker);\n            bootstrap.handler(new ChannelInitializer&lt;SocketChannel&gt;() &#123;\n                @Override\n                protected void initChannel(SocketChannel ch) throws Exception &#123;\n                    log.debug(&quot;connetted...&quot;);\n                    ch.pipeline().addLast(new LoggingHandler(LogLevel.DEBUG));\n                    ch.pipeline().addLast(new ChannelInboundHandlerAdapter() &#123;\n                        @Override\n                        public void channelActive(ChannelHandlerContext ctx) throws Exception &#123;\n                            log.debug(&quot;sending...&quot;);\n                            Random r &#x3D; new Random();\n                            char c &#x3D; &#39;a&#39;;\n                            ByteBuf buffer &#x3D; ctx.alloc().buffer();\n                            for (int i &#x3D; 0; i &lt; 10; i++) &#123;\n                                byte length &#x3D; (byte) (r.nextInt(16) + 1);\n                                &#x2F;&#x2F; å…ˆå†™å…¥é•¿åº¦\n                                buffer.writeByte(length);&#x2F;&#x2F;\n                                &#x2F;&#x2F; å†\n                                for (int j &#x3D; 1; j &lt;&#x3D; length; j++) &#123;&#x2F;&#x2F;\n                                    buffer.writeByte((byte) c);&#x2F;&#x2F;\n                                &#125;\n                                c++;\n                            &#125;\n                            ctx.writeAndFlush(buffer);\n                        &#125;\n                    &#125;);\n                &#125;\n            &#125;);\n            ChannelFuture channelFuture &#x3D; bootstrap.connect(&quot;192.168.0.103&quot;, 9090).sync();\n            channelFuture.channel().closeFuture().sync();\n\n        &#125; catch (InterruptedException e) &#123;\n            log.error(&quot;client error&quot;, e);\n        &#125; finally &#123;\n            worker.shutdownGracefully();\n        &#125;\n    &#125;\n&#125;</code></pre>\n\n\n\n<p>å®¢æˆ·ç«¯è¾“å‡º</p>\n<pre class=\"line-numbers language-none\"><code class=\"language-none\">14:37:10 [DEBUG] [nioEventLoopGroup-2-1] c.i.n.HelloWorldClient - connetted...\n14:37:10 [DEBUG] [nioEventLoopGroup-2-1] i.n.h.l.LoggingHandler - [id: 0xf0f347b8] REGISTERED\n14:37:10 [DEBUG] [nioEventLoopGroup-2-1] i.n.h.l.LoggingHandler - [id: 0xf0f347b8] CONNECT: &#x2F;192.168.0.103:9090\n14:37:10 [DEBUG] [nioEventLoopGroup-2-1] i.n.h.l.LoggingHandler - [id: 0xf0f347b8, L:&#x2F;192.168.0.103:49979 - R:&#x2F;192.168.0.103:9090] ACTIVE\n14:37:10 [DEBUG] [nioEventLoopGroup-2-1] c.i.n.HelloWorldClient - sending...\n14:37:10 [DEBUG] [nioEventLoopGroup-2-1] i.n.h.l.LoggingHandler - [id: 0xf0f347b8, L:&#x2F;192.168.0.103:49979 - R:&#x2F;192.168.0.103:9090] WRITE: 97B\n         +-------------------------------------------------+\n         |  0  1  2  3  4  5  6  7  8  9  a  b  c  d  e  f |\n+--------+-------------------------------------------------+----------------+\n|00000000| 09 61 61 61 61 61 61 61 61 61 09 62 62 62 62 62 |.aaaaaaaaa.bbbbb|\n|00000010| 62 62 62 62 06 63 63 63 63 63 63 08 64 64 64 64 |bbbb.cccccc.dddd|\n|00000020| 64 64 64 64 0f 65 65 65 65 65 65 65 65 65 65 65 |dddd.eeeeeeeeeee|\n|00000030| 65 65 65 65 0d 66 66 66 66 66 66 66 66 66 66 66 |eeee.fffffffffff|\n|00000040| 66 66 02 67 67 02 68 68 0e 69 69 69 69 69 69 69 |ff.gg.hh.iiiiiii|\n|00000050| 69 69 69 69 69 69 69 09 6a 6a 6a 6a 6a 6a 6a 6a |iiiiiii.jjjjjjjj|\n|00000060| 6a                                              |j               |\n+--------+-------------------------------------------------+----------------+\n14:37:10 [DEBUG] [nioEventLoopGroup-2-1] i.n.h.l.LoggingHandler - [id: 0xf0f347b8, L:&#x2F;192.168.0.103:49979 - R:&#x2F;192.168.0.103:9090] FLUSH</code></pre>\n\n\n\n<p>æœåŠ¡ç«¯è¾“å‡º</p>\n<pre class=\"line-numbers language-none\"><code class=\"language-none\">14:36:50 [DEBUG] [main] c.i.n.HelloWorldServer - [id: 0xdff439d3] binding...\n14:36:51 [DEBUG] [main] c.i.n.HelloWorldServer - [id: 0xdff439d3, L:&#x2F;192.168.0.103:9090] bound...\n14:37:10 [DEBUG] [nioEventLoopGroup-3-1] i.n.h.l.LoggingHandler - [id: 0x744f2b47, L:&#x2F;192.168.0.103:9090 - R:&#x2F;192.168.0.103:49979] REGISTERED\n14:37:10 [DEBUG] [nioEventLoopGroup-3-1] i.n.h.l.LoggingHandler - [id: 0x744f2b47, L:&#x2F;192.168.0.103:9090 - R:&#x2F;192.168.0.103:49979] ACTIVE\n14:37:10 [DEBUG] [nioEventLoopGroup-3-1] c.i.n.HelloWorldServer - connected [id: 0x744f2b47, L:&#x2F;192.168.0.103:9090 - R:&#x2F;192.168.0.103:49979]\n14:37:10 [DEBUG] [nioEventLoopGroup-3-1] i.n.h.l.LoggingHandler - [id: 0x744f2b47, L:&#x2F;192.168.0.103:9090 - R:&#x2F;192.168.0.103:49979] READ: 9B\n         +-------------------------------------------------+\n         |  0  1  2  3  4  5  6  7  8  9  a  b  c  d  e  f |\n+--------+-------------------------------------------------+----------------+\n|00000000| 61 61 61 61 61 61 61 61 61                      |aaaaaaaaa       |\n+--------+-------------------------------------------------+----------------+\n14:37:10 [DEBUG] [nioEventLoopGroup-3-1] i.n.h.l.LoggingHandler - [id: 0x744f2b47, L:&#x2F;192.168.0.103:9090 - R:&#x2F;192.168.0.103:49979] READ: 9B\n         +-------------------------------------------------+\n         |  0  1  2  3  4  5  6  7  8  9  a  b  c  d  e  f |\n+--------+-------------------------------------------------+----------------+\n|00000000| 62 62 62 62 62 62 62 62 62                      |bbbbbbbbb       |\n+--------+-------------------------------------------------+----------------+\n14:37:10 [DEBUG] [nioEventLoopGroup-3-1] i.n.h.l.LoggingHandler - [id: 0x744f2b47, L:&#x2F;192.168.0.103:9090 - R:&#x2F;192.168.0.103:49979] READ: 6B\n         +-------------------------------------------------+\n         |  0  1  2  3  4  5  6  7  8  9  a  b  c  d  e  f |\n+--------+-------------------------------------------------+----------------+\n|00000000| 63 63 63 63 63 63                               |cccccc          |\n+--------+-------------------------------------------------+----------------+\n14:37:10 [DEBUG] [nioEventLoopGroup-3-1] i.n.h.l.LoggingHandler - [id: 0x744f2b47, L:&#x2F;192.168.0.103:9090 - R:&#x2F;192.168.0.103:49979] READ: 8B\n         +-------------------------------------------------+\n         |  0  1  2  3  4  5  6  7  8  9  a  b  c  d  e  f |\n+--------+-------------------------------------------------+----------------+\n|00000000| 64 64 64 64 64 64 64 64                         |dddddddd        |\n+--------+-------------------------------------------------+----------------+\n14:37:10 [DEBUG] [nioEventLoopGroup-3-1] i.n.h.l.LoggingHandler - [id: 0x744f2b47, L:&#x2F;192.168.0.103:9090 - R:&#x2F;192.168.0.103:49979] READ: 15B\n         +-------------------------------------------------+\n         |  0  1  2  3  4  5  6  7  8  9  a  b  c  d  e  f |\n+--------+-------------------------------------------------+----------------+\n|00000000| 65 65 65 65 65 65 65 65 65 65 65 65 65 65 65    |eeeeeeeeeeeeeee |\n+--------+-------------------------------------------------+----------------+\n14:37:10 [DEBUG] [nioEventLoopGroup-3-1] i.n.h.l.LoggingHandler - [id: 0x744f2b47, L:&#x2F;192.168.0.103:9090 - R:&#x2F;192.168.0.103:49979] READ: 13B\n         +-------------------------------------------------+\n         |  0  1  2  3  4  5  6  7  8  9  a  b  c  d  e  f |\n+--------+-------------------------------------------------+----------------+\n|00000000| 66 66 66 66 66 66 66 66 66 66 66 66 66          |fffffffffffff   |\n+--------+-------------------------------------------------+----------------+\n14:37:10 [DEBUG] [nioEventLoopGroup-3-1] i.n.h.l.LoggingHandler - [id: 0x744f2b47, L:&#x2F;192.168.0.103:9090 - R:&#x2F;192.168.0.103:49979] READ: 2B\n         +-------------------------------------------------+\n         |  0  1  2  3  4  5  6  7  8  9  a  b  c  d  e  f |\n+--------+-------------------------------------------------+----------------+\n|00000000| 67 67                                           |gg              |\n+--------+-------------------------------------------------+----------------+\n14:37:10 [DEBUG] [nioEventLoopGroup-3-1] i.n.h.l.LoggingHandler - [id: 0x744f2b47, L:&#x2F;192.168.0.103:9090 - R:&#x2F;192.168.0.103:49979] READ: 2B\n         +-------------------------------------------------+\n         |  0  1  2  3  4  5  6  7  8  9  a  b  c  d  e  f |\n+--------+-------------------------------------------------+----------------+\n|00000000| 68 68                                           |hh              |\n+--------+-------------------------------------------------+----------------+\n14:37:10 [DEBUG] [nioEventLoopGroup-3-1] i.n.h.l.LoggingHandler - [id: 0x744f2b47, L:&#x2F;192.168.0.103:9090 - R:&#x2F;192.168.0.103:49979] READ: 14B\n         +-------------------------------------------------+\n         |  0  1  2  3  4  5  6  7  8  9  a  b  c  d  e  f |\n+--------+-------------------------------------------------+----------------+\n|00000000| 69 69 69 69 69 69 69 69 69 69 69 69 69 69       |iiiiiiiiiiiiii  |\n+--------+-------------------------------------------------+----------------+\n14:37:10 [DEBUG] [nioEventLoopGroup-3-1] i.n.h.l.LoggingHandler - [id: 0x744f2b47, L:&#x2F;192.168.0.103:9090 - R:&#x2F;192.168.0.103:49979] READ: 9B\n         +-------------------------------------------------+\n         |  0  1  2  3  4  5  6  7  8  9  a  b  c  d  e  f |\n+--------+-------------------------------------------------+----------------+\n|00000000| 6a 6a 6a 6a 6a 6a 6a 6a 6a                      |jjjjjjjjj       |\n+--------+-------------------------------------------------+----------------+\n14:37:10 [DEBUG] [nioEventLoopGroup-3-1] i.n.h.l.LoggingHandler - [id: 0x744f2b47, L:&#x2F;192.168.0.103:9090 - R:&#x2F;192.168.0.103:49979] READ COMPLETE\n</code></pre>\n\n\n\n<h2 id=\"2-åè®®è®¾è®¡ä¸è§£æ\"><a href=\"#2-åè®®è®¾è®¡ä¸è§£æ\" class=\"headerlink\" title=\"2. åè®®è®¾è®¡ä¸è§£æ\"></a>2. åè®®è®¾è®¡ä¸è§£æ</h2><h3 id=\"2-1-ä¸ºä»€ä¹ˆéœ€è¦åè®®ï¼Ÿ\"><a href=\"#2-1-ä¸ºä»€ä¹ˆéœ€è¦åè®®ï¼Ÿ\" class=\"headerlink\" title=\"2.1 ä¸ºä»€ä¹ˆéœ€è¦åè®®ï¼Ÿ\"></a>2.1 ä¸ºä»€ä¹ˆéœ€è¦åè®®ï¼Ÿ</h3><p>TCP&#x2F;IP ä¸­æ¶ˆæ¯ä¼ è¾“  åŸºäºæµçš„æ–¹å¼ï¼Œæ²¡æœ‰è¾¹ç•Œã€‚</p>\n<p>åè®®çš„ç›®çš„å°±æ˜¯ï¼šåˆ’å®šæ¶ˆæ¯çš„è¾¹ç•Œï¼Œåˆ¶å®šé€šä¿¡åŒæ–¹è¦å…±åŒéµå®ˆçš„é€šä¿¡è§„åˆ™</p>\n<p>ä¾‹å¦‚ï¼šåœ¨ç½‘ç»œä¸Šä¼ è¾“</p>\n<pre class=\"line-numbers language-none\"><code class=\"language-none\">ä¸‹é›¨å¤©ç•™å®¢å¤©ç•™æˆ‘ä¸ç•™</code></pre>\n\n<p>æ˜¯ä¸­æ–‡ä¸€å¥è‘—åçš„æ— æ ‡ç‚¹ç¬¦å·å¥å­ï¼Œåœ¨æ²¡æœ‰æ ‡ç‚¹ç¬¦å·æƒ…å†µä¸‹ï¼Œè¿™å¥è¯æœ‰æ•°ç§æ‹†è§£æ–¹å¼ï¼Œè€Œæ„æ€å´æ˜¯å®Œå…¨ä¸åŒï¼Œæ‰€ä»¥å¸¸è¢«ç”¨ä½œè®²è¿°æ ‡ç‚¹ç¬¦å·çš„é‡è¦æ€§</p>\n<p>ä¸€ç§è§£è¯»</p>\n<pre class=\"line-numbers language-none\"><code class=\"language-none\">ä¸‹é›¨å¤©ç•™å®¢ï¼Œå¤©ç•™ï¼Œæˆ‘ä¸ç•™</code></pre>\n\n<p>å¦ä¸€ç§è§£è¯»</p>\n<pre class=\"line-numbers language-none\"><code class=\"language-none\">ä¸‹é›¨å¤©ï¼Œç•™å®¢å¤©ï¼Œç•™æˆ‘ä¸ï¼Ÿç•™</code></pre>\n\n\n\n<p>å¦‚ä½•è®¾è®¡åè®®å‘¢ï¼Ÿå…¶å®å°±æ˜¯ç»™ç½‘ç»œä¼ è¾“çš„ä¿¡æ¯åŠ ä¸Šâ€œæ ‡ç‚¹ç¬¦å·â€ã€‚<strong>ä½†é€šè¿‡åˆ†éš”ç¬¦æ¥æ–­å¥ä¸æ˜¯å¾ˆå¥½ï¼Œå› ä¸ºåˆ†éš”ç¬¦æœ¬èº«å¦‚æœç”¨äºä¼ è¾“ï¼Œé‚£ä¹ˆå¿…é¡»åŠ ä»¥åŒºåˆ†ã€‚</strong>å› æ­¤ï¼Œä¸‹é¢ä¸€ç§åè®®è¾ƒä¸ºå¸¸ç”¨</p>\n<pre class=\"line-numbers language-none\"><code class=\"language-none\">å®šé•¿å­—èŠ‚è¡¨ç¤ºå†…å®¹é•¿åº¦ + å®é™…å†…å®¹</code></pre>\n\n<p>ä¾‹å¦‚ï¼Œå‡è®¾ä¸€ä¸ªä¸­æ–‡å­—ç¬¦é•¿åº¦ä¸º 3ï¼ŒæŒ‰ç…§ä¸Šè¿°åè®®çš„è§„åˆ™ï¼Œå‘é€ä¿¡æ¯æ–¹å¼å¦‚ä¸‹ï¼Œå°±ä¸ä¼šè¢«æ¥æ”¶æ–¹å¼„é”™æ„æ€äº†</p>\n<pre class=\"line-numbers language-none\"><code class=\"language-none\">0fä¸‹é›¨å¤©ç•™å®¢06å¤©ç•™09æˆ‘ä¸ç•™</code></pre>\n\n\n\n<blockquote><span class=\"custom-blockquote-svg\"><svg width=\"24\" height=\"24\" viewBox=\"0 0 24 24\" fill=\"\" xmlns=\"http://www.w3.org/2000/svg\" data-reactroot=\"\">\n<path fill=\"\" d=\"M22 12C22 6.5 17.5 2 12 2C6.5 2 2 6.5 2 12C2 17.5 6.5 22 12 22C13.8 22 15.5 21.5 17 20.6L22 22L20.7 17C21.5 15.5 22 13.8 22 12Z\" undefined=\"1\"></path>\n<path fill=\"\" d=\"M15.97 11.5H16.04C17.12 11.5 18 12.38 18 13.47V13.53C18 14.62 17.12 15.5 16.03 15.5H15.96C14.88 15.5 14 14.62 14 13.53V13.46C14 12.38 14.88 11.5 15.97 11.5Z\" undefined=\"1\"></path>\n<path fill=\"\" d=\"M7.97 11.5H8.04C9.12 11.5 10 12.38 10 13.47V13.53C10 14.62 9.12 15.5 8.03 15.5H7.97C6.88 15.5 6 14.62 6 13.53V13.46C6 12.38 6.88 11.5 7.97 11.5Z\" undefined=\"1\"></path>\n<path stroke-linejoin=\"round\" stroke-linecap=\"round\" stroke-miterlimit=\"10\" stroke-width=\"2\" stroke=\"\" d=\"M17 8.5C15.23 8.97 14.07 10.84 14.01 13.27C14 13.33 14 13.4 14 13.47V13.5\"></path>\n<path stroke-linejoin=\"round\" stroke-linecap=\"round\" stroke-miterlimit=\"10\" stroke-width=\"2\" stroke=\"\" d=\"M9 8.5C7.23 8.97 6.07 10.84 6.01 13.27C6 13.33 6 13.4 6 13.47V13.5\"></path>\n<path stroke-linejoin=\"round\" stroke-linecap=\"round\" stroke-miterlimit=\"10\" stroke-width=\"2\" stroke=\"\" d=\"M15.97 11.5H16.04C17.12 11.5 18 12.38 18 13.47V13.53C18 14.62 17.12 15.5 16.03 15.5H15.96C14.88 15.5 14 14.62 14 13.53V13.46C14 12.38 14.88 11.5 15.97 11.5Z\"></path>\n<path stroke-linejoin=\"round\" stroke-linecap=\"round\" stroke-miterlimit=\"10\" stroke-width=\"2\" stroke=\"\" d=\"M7.97 11.5H8.04C9.12 11.5 10 12.38 10 13.47V13.53C10 14.62 9.12 15.5 8.03 15.5H7.97C6.88 15.5 6 14.62 6 13.53V13.46C6 12.38 6.88 11.5 7.97 11.5Z\"></path>\n</svg>\n</span><p>å°æ•…äº‹</p>\n<p>å¾ˆä¹…å¾ˆä¹…ä»¥å‰ï¼Œä¸€ä½ç§å¡¾å…ˆç”Ÿåˆ°ä¸€å®¶ä»»æ•™ã€‚åŒæ–¹ç­¾è®¢äº†ä¸€çº¸åè®®ï¼šâ€œ<strong>æ— é¸¡é¸­äº¦å¯æ— é±¼è‚‰äº¦å¯ç™½èœè±†è…ä¸å¯å°‘ä¸å¾—æŸä¿®é‡‘</strong>â€ã€‚æ­¤åï¼Œç§å¡¾å…ˆç”Ÿè™½ç„¶è®¤çœŸæ•™è¯¾ï¼Œä½†ä¸»äººå®¶åˆ™æ€»æ˜¯ç»™ç§å¡¾å…ˆç”Ÿä»¥ç™½èœè±†è…ä¸ºèœï¼Œä¸æ¯«æœªè§é¸¡é¸­é±¼è‚‰çš„æ¬¾å¾…ã€‚ç§å¡¾å…ˆç”Ÿå…ˆæ˜¯å¾ˆä¸è§£ï¼Œå¯æ˜¯åæ¥ä¹Ÿå°±æƒ³é€šäº†ï¼šä¸»äººæŠŠé¸¡é¸­é±¼è‚‰çš„é’±éƒ½ä¼šæ¢ä¸ºæŸä¿®é‡‘çš„ï¼Œä¹Ÿç½¢ã€‚è‡³æ­¤åŒæ–¹ç›¸å®‰æ— äº‹ã€‚</p>\n<p>å¹´å…³å°†è‡³ï¼Œä¸€ä¸ªå­¦å¹´æ®µäº¦å‘Šç»“æŸã€‚ç§å¡¾å…ˆç”Ÿä¸´è¡Œæ—¶ï¼Œä¹Ÿä¸è§ä¸»äººå®¶ä¸ºä»–äº¤ä»˜æŸä¿®é‡‘ï¼Œé‚ä¸ä¸»å®¶ç†è®ºã€‚ç„¶ä¸»å®¶äº¦æŒ¯æŒ¯æœ‰è¯ï¼šâ€œæœ‰åè®®ä¸ºè¯â€”â€”<strong>æ— é¸¡é¸­äº¦å¯ï¼Œæ— é±¼è‚‰äº¦å¯ï¼Œç™½èœè±†è…ä¸å¯å°‘ï¼Œä¸å¾—æŸä¿®é‡‘ã€‚</strong>è¿™ç™½çº¸é»‘å­—æ˜æ‘†ç€çš„ï¼Œä½ æœ‰ä»€ä¹ˆè¦è¯´çš„å‘¢ï¼Ÿâ€</p>\n<p>ç§å¡¾å…ˆç”Ÿæ®ç†åŠ›äº‰ï¼šâ€œåè®®æ˜¯è¿™æ ·çš„â€”â€”<strong>æ— é¸¡ï¼Œé¸­äº¦å¯ï¼›æ— é±¼ï¼Œè‚‰äº¦å¯ï¼›ç™½èœè±†è…ä¸å¯ï¼Œå°‘ä¸å¾—æŸä¿®é‡‘ã€‚</strong>â€</p>\n<p>åŒæ–¹å”‡æªèˆŒæˆ˜ï¼Œä½ æ¥æˆ‘å¾€ï¼ŒçœŸä¸ªæ˜¯ä¸äº¦ä¹ä¹ï¼</p>\n<p>è¿™é‡Œçš„æŸä¿®é‡‘ï¼Œä¹Ÿä½œâ€œæŸè„©â€ï¼Œåº”å½“æ˜¯æ³›æŒ‡æ•™å¸ˆåº”å½“å¾—åˆ°çš„æŠ¥é…¬</p></blockquote>\n<h3 id=\"2-2-redis-åè®®ä¸¾ä¾‹\"><a href=\"#2-2-redis-åè®®ä¸¾ä¾‹\" class=\"headerlink\" title=\"2.2 redis åè®®ä¸¾ä¾‹\"></a>2.2 redis åè®®ä¸¾ä¾‹</h3><pre class=\"line-numbers language-java\" data-language=\"java\"><code class=\"language-java\">NioEventLoopGroup worker &#x3D; new NioEventLoopGroup();\nbyte[] LINE &#x3D; &#123;13, 10&#125;;&#x2F;&#x2F; å›è½¦+æ¢è¡Œ win:\\r\\n\ntry &#123;\n    Bootstrap bootstrap &#x3D; new Bootstrap();\n    bootstrap.channel(NioSocketChannel.class);\n    bootstrap.group(worker);\n    bootstrap.handler(new ChannelInitializer&lt;SocketChannel&gt;() &#123;\n        @Override\n        protected void initChannel(SocketChannel ch) &#123;\n            ch.pipeline().addLast(new LoggingHandler());\n            ch.pipeline().addLast(new ChannelInboundHandlerAdapter() &#123;\n                &#x2F;&#x2F; ä¼šåœ¨è¿æ¥ channel å»ºç«‹æˆåŠŸåï¼Œä¼šè§¦å‘ active äº‹ä»¶\n                @Override\n                public void channelActive(ChannelHandlerContext ctx) &#123;\n                    set(ctx);\n                    get(ctx);\n                &#125;\n                private void get(ChannelHandlerContext ctx) &#123;\n                    ByteBuf buf &#x3D; ctx.alloc().buffer();\n                    buf.writeBytes(&quot;*2&quot;.getBytes());\n                    buf.writeBytes(LINE);\n                    buf.writeBytes(&quot;$3&quot;.getBytes());\n                    buf.writeBytes(LINE);\n                    buf.writeBytes(&quot;get&quot;.getBytes());\n                    buf.writeBytes(LINE);\n                    buf.writeBytes(&quot;$3&quot;.getBytes());\n                    buf.writeBytes(LINE);\n                    buf.writeBytes(&quot;aaa&quot;.getBytes());\n                    buf.writeBytes(LINE);\n                    ctx.writeAndFlush(buf);\n                &#125;\n                private void set(ChannelHandlerContext ctx) &#123;\n                    ByteBuf buf &#x3D; ctx.alloc().buffer();\n                    buf.writeBytes(&quot;*3&quot;.getBytes());\n                    buf.writeBytes(LINE);\n                    buf.writeBytes(&quot;$3&quot;.getBytes());\n                    buf.writeBytes(LINE);\n                    buf.writeBytes(&quot;set&quot;.getBytes());\n                    buf.writeBytes(LINE);\n                    buf.writeBytes(&quot;$3&quot;.getBytes());\n                    buf.writeBytes(LINE);\n                    buf.writeBytes(&quot;aaa&quot;.getBytes());\n                    buf.writeBytes(LINE);\n                    buf.writeBytes(&quot;$3&quot;.getBytes());\n                    buf.writeBytes(LINE);\n                    buf.writeBytes(&quot;bbb&quot;.getBytes());\n                    buf.writeBytes(LINE);\n                    ctx.writeAndFlush(buf);\n                &#125;\n\n                @Override\n                public void channelRead(ChannelHandlerContext ctx, Object msg) throws Exception &#123;\n                    ByteBuf buf &#x3D; (ByteBuf) msg;\n                    System.out.println(buf.toString(Charset.defaultCharset()));\n                &#125;\n            &#125;);\n        &#125;\n    &#125;);\n    ChannelFuture channelFuture &#x3D; bootstrap.connect(&quot;localhost&quot;, 6379).sync();&#x2F;&#x2F;\n    channelFuture.channel().closeFuture().sync();\n&#125; catch (InterruptedException e) &#123;\n    log.error(&quot;client error&quot;, e);\n&#125; finally &#123;\n    worker.shutdownGracefully();\n&#125;</code></pre>\n\n<p>èµ·redis:ã€runã€‘ get aaa</p>\n<h3 id=\"2-3-http-åè®®ä¸¾ä¾‹\"><a href=\"#2-3-http-åè®®ä¸¾ä¾‹\" class=\"headerlink\" title=\"2.3 http åè®®ä¸¾ä¾‹\"></a>2.3 http åè®®ä¸¾ä¾‹</h3><pre class=\"line-numbers language-java\" data-language=\"java\"><code class=\"language-java\">NioEventLoopGroup boss &#x3D; new NioEventLoopGroup();\nNioEventLoopGroup worker &#x3D; new NioEventLoopGroup();\ntry &#123;\n    ServerBootstrap serverBootstrap &#x3D; new ServerBootstrap();\n    serverBootstrap.channel(NioServerSocketChannel.class);\n    serverBootstrap.group(boss, worker);\n    serverBootstrap.childHandler(new ChannelInitializer&lt;SocketChannel&gt;() &#123;\n        @Override\n        protected void initChannel(SocketChannel ch) throws Exception &#123;\n            ch.pipeline().addLast(new LoggingHandler(LogLevel.DEBUG));\n            ch.pipeline().addLast(new HttpServerCodec());&#x2F;&#x2F;\n            ch.pipeline().addLast(new SimpleChannelInboundHandler&lt;HttpRequest&gt;() &#123;\n                @Override\n                protected void channelRead0(ChannelHandlerContext ctx, HttpRequest msg) throws Exception &#123;\n                    &#x2F;&#x2F; è·å–è¯·æ±‚\n                    log.debug(msg.uri());&#x2F;&#x2F;-&#x2F;bxl.html\n\n                    &#x2F;&#x2F; è¿”å›å“åº”\n                    DefaultFullHttpResponse response &#x3D;\n                            new DefaultFullHttpResponse(msg.protocolVersion(), HttpResponseStatus.OK);\n\n                    byte[] bytes &#x3D; &quot;&lt;h1&gt;Hello, world!&lt;&#x2F;h1&gt;&quot;.getBytes();\n\n                    response.headers().setInt(CONTENT_LENGTH, bytes.length);&#x2F;&#x2F;&#x2F;&#x2F;k,v å¦åˆ™æµè§ˆå™¨ä¸€ç›´è½¬åœˆè¯»ï¼ï¼ï¼\n                    response.content().writeBytes(bytes);\n\n                    &#x2F;&#x2F; å†™å›å“åº”\n                    ctx.writeAndFlush(response);\n                &#125;\n            &#125;);\n            &#x2F;*ch.pipeline().addLast(new ChannelInboundHandlerAdapter() &#123;\n                @Override\n                public void channelRead(ChannelHandlerContext ctx, Object msg) throws Exception &#123;\n                    log.debug(&quot;&#123;&#125;&quot;, msg.getClass());\n\n                    if (msg instanceof HttpRequest) &#123; &#x2F;&#x2F; è¯·æ±‚è¡Œï¼Œè¯·æ±‚å¤´\n\n                    &#125; else if (msg instanceof HttpContent) &#123; &#x2F;&#x2F;è¯·æ±‚ä½“\n\n                    &#125;\n                &#125;\n            &#125;);*&#x2F;\n        &#125;\n    &#125;);\n    ChannelFuture channelFuture &#x3D; serverBootstrap.bind(8080).sync();\n    channelFuture.channel().closeFuture().sync();\n&#125; catch (InterruptedException e) &#123;\n    log.error(&quot;server error&quot;, e);\n&#125; finally &#123;\n    boss.shutdownGracefully();\n    worker.shutdownGracefully();\n&#125;</code></pre>\n\n<p><a href=\"http://localhost:8080/bxl.html\">http://localhost:8080/bxl.html</a></p>\n<h3 id=\"x3D-x3D-2-4-è‡ªå®šä¹‰åè®®è¦ç´ -x3D-x3D-ã€ç´§å‡‘ï¼Œé«˜æ•ˆï¼Œçœå¸¦å®½ã€‘\"><a href=\"#x3D-x3D-2-4-è‡ªå®šä¹‰åè®®è¦ç´ -x3D-x3D-ã€ç´§å‡‘ï¼Œé«˜æ•ˆï¼Œçœå¸¦å®½ã€‘\" class=\"headerlink\" title=\"&#x3D;&#x3D;2.4 è‡ªå®šä¹‰åè®®è¦ç´ &#x3D;&#x3D;ã€ç´§å‡‘ï¼Œé«˜æ•ˆï¼Œçœå¸¦å®½ã€‘\"></a>&#x3D;&#x3D;2.4 è‡ªå®šä¹‰åè®®è¦ç´ &#x3D;&#x3D;ã€ç´§å‡‘ï¼Œé«˜æ•ˆï¼Œçœå¸¦å®½ã€‘</h3><ul>\n<li>é­”æ•°cafebabyï¼Œç”¨æ¥åœ¨<strong>ç¬¬ä¸€æ—¶é—´åˆ¤å®šæ˜¯å¦æ˜¯æ— æ•ˆæ•°æ®åŒ…</strong></li>\n<li>ç‰ˆæœ¬å·ï¼Œå¯ä»¥æ”¯æŒåè®®çš„<strong>å‡çº§</strong> æ–°å¢æ¶ˆæ¯â€¦</li>\n<li>åºåˆ—åŒ–ç®—æ³•ï¼Œæ¶ˆæ¯æ­£æ–‡åˆ°åº•é‡‡ç”¨å“ªç§<strong>åºåˆ—åŒ–ååºåˆ—åŒ–æ–¹å¼ï¼Œå¯ä»¥ç”±æ­¤æ‰©å±•ï¼Œä¾‹å¦‚ï¼šjsonã€xmlã€protobuf(bin)ã€hessian(bin)ã€jdk(ä¸è·¨å¹³å°|æ€§èƒ½ä½)</strong></li>\n<li><strong>æŒ‡ä»¤ç±»å‹ï¼Œæ˜¯ç™»å½•ã€æ³¨å†Œã€å•èŠã€ç¾¤èŠâ€¦ è·Ÿä¸šåŠ¡ç›¸å…³</strong></li>\n<li>[è¯·æ±‚åºå·]ï¼Œä¸ºäº†[åŒå·¥é€šä¿¡]ï¼Œæä¾›[å¼‚æ­¥]èƒ½åŠ›</li>\n<li>æ­£æ–‡é•¿åº¦</li>\n<li>æ¶ˆæ¯æ­£æ–‡ username,pwdâ€¦    json&#x2F;xml&#x2F;binå¯¹è±¡æµâ€¦</li>\n</ul>\n<h4 id=\"msgç¼–è§£ç å™¨ã€netty-demoé¡¹ç›®ã€‘\"><a href=\"#msgç¼–è§£ç å™¨ã€netty-demoé¡¹ç›®ã€‘\" class=\"headerlink\" title=\"msgç¼–è§£ç å™¨ã€netty-demoé¡¹ç›®ã€‘\"></a>msgç¼–è§£ç å™¨ã€netty-demoé¡¹ç›®ã€‘</h4><p>æ ¹æ®ä¸Šé¢çš„è¦ç´ ï¼Œè®¾è®¡ä¸€ä¸ª<strong>ç™»å½•è¯·æ±‚æ¶ˆæ¯å’Œç™»å½•å“åº”æ¶ˆæ¯ï¼Œå¹¶ä½¿ç”¨ Netty å®Œæˆæ”¶å‘</strong></p>\n<pre class=\"line-numbers language-java\" data-language=\"java\"><code class=\"language-java\">@Slf4j\npublic class MessageCodec extends ByteToMessageCodec&lt;Message&gt; &#123;\n\n    @Override\n    protected void encode(ChannelHandlerContext ctx, Message msg, ByteBuf out) throws Exception &#123;\n        &#x2F;&#x2F; 1. 4 å­—èŠ‚çš„é­”æ•°\n        out.writeBytes(new byte[]&#123;1, 2, 3, 4&#125;);\n        &#x2F;&#x2F; 2. 1 å­—èŠ‚çš„ç‰ˆæœ¬,\n        out.writeByte(1);\n        &#x2F;&#x2F; 3. 1 å­—èŠ‚çš„åºåˆ—åŒ–æ–¹å¼ jdk 0 , json 1\n        out.writeByte(0);\n        &#x2F;&#x2F; 4. 1 å­—èŠ‚çš„æŒ‡ä»¤ç±»å‹\n        out.writeByte(msg.getMessageType());\n        &#x2F;&#x2F; 5. 4 ä¸ªå­—èŠ‚\n        out.writeInt(msg.getSequenceId());\n        &#x2F;&#x2F; æ— æ„ä¹‰ï¼Œå¯¹é½å¡«å……\n        out.writeByte(0xff);\n        &#x2F;&#x2F; 6. è·å–å†…å®¹çš„å­—èŠ‚æ•°ç»„\n        ByteArrayOutputStream bos &#x3D; new ByteArrayOutputStream();\n        ObjectOutputStream oos &#x3D; new ObjectOutputStream(bos);\n        oos.writeObject(msg);\n        byte[] bytes &#x3D; bos.toByteArray();\n        &#x2F;&#x2F; 7. é•¿åº¦\n        out.writeInt(bytes.length);\n        &#x2F;&#x2F; 8. å†™å…¥å†…å®¹\n        out.writeBytes(bytes);\n    &#125;\n\n    @Override\n    protected void decode(ChannelHandlerContext ctx, ByteBuf in, List&lt;Object&gt; out) throws Exception &#123;\n        int magicNum &#x3D; in.readInt();\n        byte version &#x3D; in.readByte();\n        byte serializerType &#x3D; in.readByte();\n        byte messageType &#x3D; in.readByte();\n        int sequenceId &#x3D; in.readInt();\n        in.readByte();\n        int length &#x3D; in.readInt();\n        byte[] bytes &#x3D; new byte[length];\n        in.readBytes(bytes, 0, length);\n        ObjectInputStream ois &#x3D; new ObjectInputStream(new ByteArrayInputStream(bytes));\n        Message message &#x3D; (Message) ois.readObject();\n        log.debug(&quot;&#123;&#125;, &#123;&#125;, &#123;&#125;, &#123;&#125;, &#123;&#125;, &#123;&#125;&quot;, magicNum, version, serializerType, messageType, sequenceId, length);\n        log.debug(&quot;&#123;&#125;&quot;, message);\n        out.add(message);\n    &#125;\n&#125;</code></pre>\n\n<p>æµ‹è¯•\tprotocol.TestMessageCodecç±»ï¼š</p>\n<pre class=\"line-numbers language-java\" data-language=\"java\"><code class=\"language-java\">EmbeddedChannel channel &#x3D; new EmbeddedChannel(\n    new LoggingHandler(),\n    new LengthFieldBasedFrameDecoder(\n        1024, 12, 4, 0, 0),\n    new MessageCodec()\n);\n&#x2F;&#x2F; encode\nLoginRequestMessage message &#x3D; new LoginRequestMessage(&quot;zhangsan&quot;, &quot;123&quot;, &quot;å¼ ä¸‰&quot;);\n&#x2F;&#x2F;        channel.writeOutbound(message);&#x2F;&#x2F;ByteBuf&lt;-msg outç¼–ç \n&#x2F;&#x2F; decode    ByteBuf-&gt;msg inè§£ç \nByteBuf buf &#x3D; ByteBufAllocator.DEFAULT.buffer();\nnew MessageCodec().encode(null, message, buf);\n\nByteBuf s1 &#x3D; buf.slice(0, 100);\nByteBuf s2 &#x3D; buf.slice(100, buf.readableBytes() - 100);\ns1.retain(); &#x2F;&#x2F; å¼•ç”¨è®¡æ•° 2\nchannel.writeInbound(s1); &#x2F;&#x2F; release 1\n&#x2F;&#x2F;ByteBufæœ‰é™[åŠåŒ…é—®é¢˜ï¼ä¸å®Œæ•´,æ— æ³•ååºåˆ—åŒ–ä¸ºmsg]\n&#x2F;&#x2F;       æŠ¥é”™ï¼š java.lang.IndexOutOfBoundsException: readerIndex(16) + length(198) exceeds writerIndex(100)\n\n        &#x2F;&#x2F;+new LengthFieldBasedFrameDecoder(),ï¼šå‘ç°æ•°æ®ä¸å®Œæ•´ï¼Œä¸ä¼šä¼ é€’ç»™ä¸‹ä¸€ä¸ªhandlerï¼Œè€Œæ˜¯ç­‰å¾…æ¥ä¸‹æ¥çš„æ•°æ®\nchannel.writeInbound(s2);</code></pre>\n\n\n\n<p>è§£è¯»</p>\n<p><img src=\"http://cache.itzy8.top/%E5%AD%A6Netty-%E9%BB%91%E9%A9%AC%E6%BB%A1%E5%93%A5/0013.png\"></p>\n<h4 id=\"ğŸ’¡-ä»€ä¹ˆæ—¶å€™å¯ä»¥åŠ -Sharable\"><a href=\"#ğŸ’¡-ä»€ä¹ˆæ—¶å€™å¯ä»¥åŠ -Sharable\" class=\"headerlink\" title=\"ğŸ’¡ ä»€ä¹ˆæ—¶å€™å¯ä»¥åŠ  @Sharable\"></a>ğŸ’¡ ä»€ä¹ˆæ—¶å€™å¯ä»¥åŠ  @Sharable</h4><ul>\n<li>å½“ handler <strong>ä¸ä¿å­˜çŠ¶æ€æ—¶ï¼Œå°±å¯ä»¥@Sharable</strong>å®‰å…¨åœ°åœ¨å¤šçº¿ç¨‹ä¸‹è¢«å…±äº«</li>\n<li>ä½†è¦æ³¨æ„<strong>å¯¹äºç¼–è§£ç å™¨ç±»(S)ï¼šä¸èƒ½ç»§æ‰¿ ByteToMessageCodec(éœ€æ‹¼å‡‘,æœ‰çŠ¶æ€!S) æˆ– CombinedChannelDuplexHandler çˆ¶ç±»(!S)ï¼Œä»–ä»¬çš„æ„é€ æ–¹æ³•å¯¹ @Sharable æœ‰é™åˆ¶ï¼šæŠ¥é”™</strong></li>\n<li>å¦‚æœ&#x3D;&#x3D;ã€èƒ½ç¡®ä¿ç¼–è§£ç å™¨ä¸ä¼šä¿å­˜çŠ¶æ€(S)ï¼Œå¯ä»¥ç»§æ‰¿ MessageToMessageCodec çˆ¶ç±»ã€‘&#x3D;&#x3D;</li>\n</ul>\n<p>MessageCodecSharableã€å¯¹æ ‡MessageCodecã€‘    çˆ¶ç±»ä¸åŒï¼</p>\n<pre class=\"line-numbers language-java\" data-language=\"java\"><code class=\"language-java\">@Slf4j\n@ChannelHandler.Sharable&#x2F;&#x2F;\n&#x2F;**\n * å¿…é¡»å’Œ LengthFieldBasedFrameDecoder ä¸€èµ·ä½¿ç”¨ï¼Œ[ç¡®ä¿]æ¥åˆ°çš„ ByteBuf æ¶ˆæ¯æ˜¯[å®Œæ•´]çš„\n *&#x2F;\npublic class MessageCodecSharable extends MessageToMessageCodec&lt;ByteBuf, Message&gt; &#123;&#x2F;&#x2F;S\n    @Override\n    protected void encode(ChannelHandlerContext ctx, Message msg, List&lt;Object&gt; outList) throws Exception &#123;\n        ByteBuf out &#x3D; ctx.alloc().buffer();\n        &#x2F;&#x2F; 1. 4 å­—èŠ‚çš„é­”æ•°\n        out.writeBytes(new byte[]&#123;1, 2, 3, 4&#125;);\n        &#x2F;&#x2F; 2. 1 å­—èŠ‚çš„ç‰ˆæœ¬,\n        out.writeByte(1);\n        &#x2F;&#x2F; 3. 1 å­—èŠ‚çš„åºåˆ—åŒ–æ–¹å¼ jdk 0 , json 1\n        out.writeByte(0);\n        &#x2F;&#x2F; 4. 1 å­—èŠ‚çš„æŒ‡ä»¤ç±»å‹\n        out.writeByte(msg.getMessageType());\n        &#x2F;&#x2F; 5. 4 ä¸ªå­—èŠ‚\n        out.writeInt(msg.getSequenceId());\n        &#x2F;&#x2F; æ— æ„ä¹‰ï¼Œå¯¹é½å¡«å……\n        out.writeByte(0xff);\n        &#x2F;&#x2F; 6. è·å–å†…å®¹çš„å­—èŠ‚æ•°ç»„\n        ByteArrayOutputStream bos &#x3D; new ByteArrayOutputStream();\n        ObjectOutputStream oos &#x3D; new ObjectOutputStream(bos);\n        oos.writeObject(msg);\n        byte[] bytes &#x3D; bos.toByteArray();\n        &#x2F;&#x2F; 7. é•¿åº¦\n        out.writeInt(bytes.length);\n        &#x2F;&#x2F; 8. å†™å…¥å†…å®¹\n        out.writeBytes(bytes);\n        outList.add(out);\n    &#125;\n\n    @Override\n    protected void decode(ChannelHandlerContext ctx, ByteBuf in, List&lt;Object&gt; out) throws Exception &#123;\n        int magicNum &#x3D; in.readInt();\n        byte version &#x3D; in.readByte();\n        byte serializerType &#x3D; in.readByte();\n        byte messageType &#x3D; in.readByte();\n        int sequenceId &#x3D; in.readInt();\n        in.readByte();\n        int length &#x3D; in.readInt();\n        byte[] bytes &#x3D; new byte[length];\n        in.readBytes(bytes, 0, length);\n        ObjectInputStream ois &#x3D; new ObjectInputStream(new ByteArrayInputStream(bytes));\n        Message message &#x3D; (Message) ois.readObject();\n        log.debug(&quot;&#123;&#125;, &#123;&#125;, &#123;&#125;, &#123;&#125;, &#123;&#125;, &#123;&#125;&quot;, magicNum, version, serializerType, messageType, sequenceId, length);\n        log.debug(&quot;&#123;&#125;&quot;, message);\n        out.add(message);\n    &#125;\n&#125;</code></pre>\n\n\n\n<pre class=\"line-numbers language-java\" data-language=\"java\"><code class=\"language-java\">public class TestMessageCodec &#123;\n    public static void main(String[] args) throws Exception &#123;\n\n        &#x2F;&#x2F;[æ— çŠ¶æ€]çº¿ç¨‹å®‰å…¨ï¼šåŠ äº†@Sharable\n        LoggingHandler LOGGING_HANDLER &#x3D; new LoggingHandler();&#x2F;&#x2F;å¯æŠ½å–åˆ°å¤–é¢è¢«å…±äº«ï¼\n\n        EmbeddedChannel channel &#x3D; new EmbeddedChannel(\n                LOGGING_HANDLER,\n                &#x2F;&#x2F;è¢«å¤šä¸ªEventLoopç”¨åˆ°ï¼Œè®°å½•å¤šæ¬¡msgé—´çš„çŠ¶æ€ï¼Œ[æœ‰çŠ¶æ€]çº¿ç¨‹ä¸å®‰å…¨:éœ€è¦æ¯æ¬¡newï¼ï¼ï¼\n                &#x2F;&#x2F;worker1ch 1234\n                &#x2F;&#x2F;worker2ch 1234\n                new LengthFieldBasedFrameDecoder(1024, 12, 4, 0, 0),\n                new MessageCodec());&#x2F;&#x2F;or FRAME_DECODER+MessageCodecSharable?\n</code></pre>\n\n\n\n<h2 id=\"3-x3D-x3D-ã€QQã€‘èŠå¤©å®¤æ¡ˆä¾‹-x3D-x3D\"><a href=\"#3-x3D-x3D-ã€QQã€‘èŠå¤©å®¤æ¡ˆä¾‹-x3D-x3D\" class=\"headerlink\" title=\"3. &#x3D;&#x3D;ã€QQã€‘èŠå¤©å®¤æ¡ˆä¾‹&#x3D;&#x3D;\"></a>3. &#x3D;&#x3D;ã€QQã€‘èŠå¤©å®¤æ¡ˆä¾‹&#x3D;&#x3D;</h2><h3 id=\"3-1-èŠå¤©å®¤ä¸šåŠ¡ä»‹ç»\"><a href=\"#3-1-èŠå¤©å®¤ä¸šåŠ¡ä»‹ç»\" class=\"headerlink\" title=\"3.1 èŠå¤©å®¤ä¸šåŠ¡ä»‹ç»\"></a>3.1 èŠå¤©å®¤ä¸šåŠ¡ä»‹ç»</h3><pre class=\"line-numbers language-java\" data-language=\"java\"><code class=\"language-java\">&#x2F;**\n * ç”¨æˆ·ç®¡ç†æ¥å£\n *&#x2F;\npublic interface UserService &#123;\n\n    &#x2F;**\n     * ç™»å½•\n     * @param username ç”¨æˆ·å\n     * @param password å¯†ç \n     * @return ç™»å½•æˆåŠŸè¿”å› true, å¦åˆ™è¿”å› false\n     *&#x2F;\n    boolean login(String username, String password);\n&#125;</code></pre>\n\n\n\n<pre class=\"line-numbers language-java\" data-language=\"java\"><code class=\"language-java\">&#x2F;**\n * ä¼šè¯ç®¡ç†æ¥å£\n *&#x2F;\npublic interface Session &#123;\n\n    &#x2F;**\n     * ç»‘å®šä¼šè¯\n     * @param channel å“ªä¸ª channel è¦ç»‘å®šä¼šè¯\n     * @param username ä¼šè¯ç»‘å®šç”¨æˆ·\n     *&#x2F;\n    void bind(Channel channel, String username);\n\n    &#x2F;**\n     * è§£ç»‘ä¼šè¯\n     * @param channel å“ªä¸ª channel è¦è§£ç»‘ä¼šè¯\n     *&#x2F;\n    void unbind(Channel channel);\n\n    &#x2F;**\n     * è·å–å±æ€§\n     * @param channel å“ªä¸ª channel\n     * @param name å±æ€§å\n     * @return å±æ€§å€¼\n     *&#x2F;\n    Object getAttribute(Channel channel, String name);\n\n    &#x2F;**\n     * è®¾ç½®å±æ€§\n     * @param channel å“ªä¸ª channel\n     * @param name å±æ€§å\n     * @param value å±æ€§å€¼\n     *&#x2F;\n    void setAttribute(Channel channel, String name, Object value);\n\n    &#x2F;**\n     * æ ¹æ®ç”¨æˆ·åè·å– channel\n     * @param username ç”¨æˆ·å\n     * @return channel\n     *&#x2F;\n    Channel getChannel(String username);\n&#125;</code></pre>\n\n\n\n<pre class=\"line-numbers language-java\" data-language=\"java\"><code class=\"language-java\">&#x2F;**\n * èŠå¤©ç»„ä¼šè¯ç®¡ç†æ¥å£\n *&#x2F;\npublic interface GroupSession &#123;\n\n    &#x2F;**\n     * åˆ›å»ºä¸€ä¸ªèŠå¤©ç»„, å¦‚æœä¸å­˜åœ¨æ‰èƒ½åˆ›å»ºæˆåŠŸ, å¦åˆ™è¿”å› null\n     * @param name ç»„å\n     * @param members æˆå‘˜\n     * @return æˆåŠŸæ—¶è¿”å›ç»„å¯¹è±¡, å¤±è´¥è¿”å› null\n     *&#x2F;\n    Group createGroup(String name, Set&lt;String&gt; members);\n\n    &#x2F;**\n     * åŠ å…¥èŠå¤©ç»„\n     * @param name ç»„å\n     * @param member æˆå‘˜å\n     * @return å¦‚æœç»„ä¸å­˜åœ¨è¿”å› null, å¦åˆ™è¿”å›ç»„å¯¹è±¡\n     *&#x2F;\n    Group joinMember(String name, String member);\n\n    &#x2F;**\n     * ç§»é™¤ç»„æˆå‘˜\n     * @param name ç»„å\n     * @param member æˆå‘˜å\n     * @return å¦‚æœç»„ä¸å­˜åœ¨è¿”å› null, å¦åˆ™è¿”å›ç»„å¯¹è±¡\n     *&#x2F;\n    Group removeMember(String name, String member);\n\n    &#x2F;**\n     * ç§»é™¤èŠå¤©ç»„\n     * @param name ç»„å\n     * @return å¦‚æœç»„ä¸å­˜åœ¨è¿”å› null, å¦åˆ™è¿”å›ç»„å¯¹è±¡\n     *&#x2F;\n    Group removeGroup(String name);\n\n    &#x2F;**\n     * è·å–ç»„æˆå‘˜\n     * @param name ç»„å\n     * @return æˆå‘˜é›†åˆ, æ²¡æœ‰æˆå‘˜ä¼šè¿”å› empty set\n     *&#x2F;\n    Set&lt;String&gt; getMembers(String name);\n\n    &#x2F;**\n     * è·å–ç»„æˆå‘˜çš„ channel é›†åˆ, åªæœ‰åœ¨çº¿çš„ channel æ‰ä¼šè¿”å›\n     * @param name ç»„å\n     * @return æˆå‘˜ channel é›†åˆ\n     *&#x2F;\n    List&lt;Channel&gt; getMembersChannel(String name);\n&#125;</code></pre>\n\n\n\n<h3 id=\"3-2-èŠå¤©å®¤ä¸šåŠ¡-ç™»å½•\"><a href=\"#3-2-èŠå¤©å®¤ä¸šåŠ¡-ç™»å½•\" class=\"headerlink\" title=\"3.2 èŠå¤©å®¤ä¸šåŠ¡-ç™»å½•\"></a>3.2 èŠå¤©å®¤ä¸šåŠ¡-ç™»å½•</h3><pre class=\"line-numbers language-java\" data-language=\"java\"><code class=\"language-java\">@Slf4j\npublic class ChatServer &#123;\n    public static void main(String[] args) &#123;\n        NioEventLoopGroup boss &#x3D; new NioEventLoopGroup();\n        NioEventLoopGroup worker &#x3D; new NioEventLoopGroup();\n        LoggingHandler LOGGING_HANDLER &#x3D; new LoggingHandler(LogLevel.DEBUG);\n        MessageCodecSharable MESSAGE_CODEC &#x3D; new MessageCodecSharable();\n        try &#123;\n            ServerBootstrap serverBootstrap &#x3D; new ServerBootstrap();\n            serverBootstrap.channel(NioServerSocketChannel.class);\n            serverBootstrap.group(boss, worker);\n            serverBootstrap.childHandler(new ChannelInitializer&lt;SocketChannel&gt;() &#123;\n                @Override\n                protected void initChannel(SocketChannel ch) throws Exception &#123;\n                    ch.pipeline().addLast(new ProcotolFrameDecoder());\n                    ch.pipeline().addLast(LOGGING_HANDLER);\n                    ch.pipeline().addLast(MESSAGE_CODEC);\n                    ch.pipeline().addLast(new SimpleChannelInboundHandler&lt;LoginRequestMessage&gt;() &#123;&#x2F;&#x2F;å¾…æŠ½å–å‡ºæ¥ï¼LoginRequestMessageHandler\n                        @Override\n                        protected void channelRead0(ChannelHandlerContext ctx, LoginRequestMessage msg) throws Exception &#123;\n                            String username &#x3D; msg.getUsername();\n                            String password &#x3D; msg.getPassword();\n                            boolean login &#x3D; UserServiceFactory.getUserService().login(username, password);\n                            LoginResponseMessage message;\n                            if(login) &#123;\n                                message &#x3D; new LoginResponseMessage(true, &quot;ç™»å½•æˆåŠŸ&quot;);\n                            &#125; else &#123;\n                                message &#x3D; new LoginResponseMessage(false, &quot;ç”¨æˆ·åæˆ–å¯†ç ä¸æ­£ç¡®&quot;);\n                            &#125;\n                            ctx.writeAndFlush(message);\n                        &#125;\n                    &#125;);\n                &#125;\n            &#125;);\n            Channel channel &#x3D; serverBootstrap.bind(8080).sync().channel();\n            channel.closeFuture().sync();\n        &#125; catch (InterruptedException e) &#123;\n            log.error(&quot;server error&quot;, e);\n        &#125; finally &#123;\n            boss.shutdownGracefully();\n            worker.shutdownGracefully();\n        &#125;\n    &#125;\n&#125;</code></pre>\n\n\n\n<pre class=\"line-numbers language-java\" data-language=\"java\"><code class=\"language-java\">@Slf4j\npublic class ChatClient &#123;\n    public static void main(String[] args) &#123;\n        NioEventLoopGroup group &#x3D; new NioEventLoopGroup();\n        LoggingHandler LOGGING_HANDLER &#x3D; new LoggingHandler(LogLevel.DEBUG);\n        MessageCodecSharable MESSAGE_CODEC &#x3D; new MessageCodecSharable();\n        CountDownLatch WAIT_FOR_LOGIN &#x3D; new CountDownLatch(1);&#x2F;&#x2F;\n        AtomicBoolean LOGIN &#x3D; new AtomicBoolean(false);&#x2F;&#x2F;\n        try &#123;\n            Bootstrap bootstrap &#x3D; new Bootstrap();\n            bootstrap.channel(NioSocketChannel.class);\n            bootstrap.group(group);\n            bootstrap.handler(new ChannelInitializer&lt;SocketChannel&gt;() &#123;\n                @Override\n                protected void initChannel(SocketChannel ch) throws Exception &#123;\n                    ch.pipeline().addLast(new ProcotolFrameDecoder());\n&#x2F;&#x2F;                    ch.pipeline().addLast(LOGGING_HANDLER);\n                    ch.pipeline().addLast(MESSAGE_CODEC);\n                    ch.pipeline().addLast(&quot;client handler&quot;, new ChannelInboundHandlerAdapter() &#123;\n                        &#x2F;&#x2F; æ¥æ”¶å“åº”æ¶ˆæ¯\n                        @Override\n                        public void channelRead(ChannelHandlerContext ctx, Object msg) throws Exception &#123;\n                            log.debug(&quot;msg: &#123;&#125;&quot;, msg);\n                            if ((msg instanceof LoginResponseMessage)) &#123;\n                                LoginResponseMessage response &#x3D; (LoginResponseMessage) msg;\n                                if (response.isSuccess()) &#123;\n                                    &#x2F;&#x2F; å¦‚æœç™»å½•æˆåŠŸ\n                                    LOGIN.set(true);\n                                &#125;\n                                &#x2F;&#x2F; å”¤é†’ system in çº¿ç¨‹\n                                WAIT_FOR_LOGIN.countDown();\n                            &#125;\n                        &#125;\n\n                        &#x2F;&#x2F; åœ¨è¿æ¥å»ºç«‹åè§¦å‘ active äº‹ä»¶\n                        @Override\n                        public void channelActive(ChannelHandlerContext ctx) throws Exception &#123;\n                            &#x2F;&#x2F; è´Ÿè´£æ¥æ”¶ç”¨æˆ·åœ¨æ§åˆ¶å°çš„è¾“å…¥ï¼Œè´Ÿè´£å‘æœåŠ¡å™¨å‘é€å„ç§æ¶ˆæ¯\n                            new Thread(() -&gt; &#123;\n                                Scanner scanner &#x3D; new Scanner(System.in);\n                                System.out.println(&quot;è¯·è¾“å…¥ç”¨æˆ·å:&quot;);\n                                String username &#x3D; scanner.nextLine();\n                                System.out.println(&quot;è¯·è¾“å…¥å¯†ç :&quot;);\n                                String password &#x3D; scanner.nextLine();\n                                &#x2F;&#x2F; æ„é€ æ¶ˆæ¯å¯¹è±¡\n                                LoginRequestMessage message &#x3D; new LoginRequestMessage(username, password);\n                                &#x2F;&#x2F; å‘é€æ¶ˆæ¯\n                                ctx.writeAndFlush(message);\n                                System.out.println(&quot;ç­‰å¾…åç»­æ“ä½œ...&quot;);\n                                try &#123;\n                                    WAIT_FOR_LOGIN.await();\n                                &#125; catch (InterruptedException e) &#123;\n                                    e.printStackTrace();\n                                &#125;\n                                &#x2F;&#x2F; å¦‚æœç™»å½•å¤±è´¥\n                                if (!LOGIN.get()) &#123;\n                                    ctx.channel().close();\n                                    return;\n                                &#125;\n                                while (true) &#123;\n                                    System.out.println(&quot;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&quot;);\n                                    System.out.println(&quot;send [username] [content]&quot;);\n                                    System.out.println(&quot;gsend [group name] [content]&quot;);\n                                    System.out.println(&quot;gcreate [group name] [m1,m2,m3...]&quot;);\n                                    System.out.println(&quot;gmembers [group name]&quot;);\n                                    System.out.println(&quot;gjoin [group name]&quot;);\n                                    System.out.println(&quot;gquit [group name]&quot;);\n                                    System.out.println(&quot;quit&quot;);\n                                    System.out.println(&quot;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&quot;);\n                                    String command &#x3D; scanner.nextLine();\n                                    String[] s &#x3D; command.split(&quot; &quot;);\n                                    switch (s[0])&#123;\n                                        case &quot;send&quot;:\n                                            ctx.writeAndFlush(new ChatRequestMessage(username, s[1], s[2]));\n                                            break;\n                                        case &quot;gsend&quot;:\n                                            ctx.writeAndFlush(new GroupChatRequestMessage(username, s[1], s[2]));\n                                            break;\n                                        case &quot;gcreate&quot;:\n                                            Set&lt;String&gt; set &#x3D; new HashSet&lt;&gt;(Arrays.asList(s[2].split(&quot;,&quot;)));\n                                            set.add(username); &#x2F;&#x2F; åŠ å…¥è‡ªå·±ï¼æ˜“å¿˜ï¼\n                                            ctx.writeAndFlush(new GroupCreateRequestMessage(s[1], set));\n                                            break;\n                                        case &quot;gmembers&quot;:\n                                            ctx.writeAndFlush(new GroupMembersRequestMessage(s[1]));\n                                            break;\n                                        case &quot;gjoin&quot;:\n                                            ctx.writeAndFlush(new GroupJoinRequestMessage(username, s[1]));\n                                            break;\n                                        case &quot;gquit&quot;:\n                                            ctx.writeAndFlush(new GroupQuitRequestMessage(username, s[1]));\n                                            break;\n                                        case &quot;quit&quot;:\n                                            ctx.channel().close();\n                                            return;\n                                    &#125;\n                                &#125;\n                            &#125;, &quot;system in&quot;).start();\n                        &#125;\n                    &#125;);\n                &#125;\n            &#125;);\n            Channel channel &#x3D; bootstrap.connect(&quot;localhost&quot;, 8080).sync().channel();\n            channel.closeFuture().sync();\n        &#125; catch (Exception e) &#123;\n            log.error(&quot;client error&quot;, e);\n        &#125; finally &#123;\n            group.shutdownGracefully();\n        &#125;\n    &#125;\n&#125;</code></pre>\n\n\n\n<h3 id=\"3-3-èŠå¤©å®¤ä¸šåŠ¡-å•èŠ\"><a href=\"#3-3-èŠå¤©å®¤ä¸šåŠ¡-å•èŠ\" class=\"headerlink\" title=\"3.3 èŠå¤©å®¤ä¸šåŠ¡-å•èŠ\"></a>3.3 èŠå¤©å®¤ä¸šåŠ¡-å•èŠ</h3><p>æœåŠ¡å™¨ç«¯å°† handler ç‹¬ç«‹å‡ºæ¥ï¼šåˆ©ç”¨ideaçš„é‡æ„åŠŸèƒ½</p>\n<p>SimpleChannelInboundHandler  å³é”®refactorã€convert anonymous to innerâ€¦ã€F6ã€‘</p>\n<p>private static class LoginRequestMessageHandlerï¼šå³é”®refactorã€move inner classã€é€‰firstï¼šmove to upper levelã€‘ åˆ°server.handleråŒ…ä¸­,main.ä¸‹çš„</p>\n<p>æ— çŠ¶æ€ï¼š@Sharable</p>\n<p>ç™»å½• handler</p>\n<pre class=\"line-numbers language-java\" data-language=\"java\"><code class=\"language-java\">@ChannelHandler.Sharable\npublic class LoginRequestMessageHandler extends SimpleChannelInboundHandler&lt;LoginRequestMessage&gt; &#123;\n    @Override\n    protected void channelRead0(ChannelHandlerContext ctx, LoginRequestMessage msg) throws Exception &#123;\n        String username &#x3D; msg.getUsername();\n        String password &#x3D; msg.getPassword();\n        boolean login &#x3D; UserServiceFactory.getUserService().login(username, password);&#x2F;&#x2F;\n        LoginResponseMessage message;\n        if(login) &#123;\n            SessionFactory.getSession().bind(ctx.channel(), username);&#x2F;&#x2F;name&lt;-&gt;channelåŒå‘ConcurrentHashMap\n            message &#x3D; new LoginResponseMessage(true, &quot;ç™»å½•æˆåŠŸ&quot;);\n        &#125; else &#123;\n            message &#x3D; new LoginResponseMessage(false, &quot;ç”¨æˆ·åæˆ–å¯†ç ä¸æ­£ç¡®&quot;);\n        &#125;\n        ctx.writeAndFlush(message);\n    &#125;\n&#125;</code></pre>\n\n<p>å•èŠ handler</p>\n<pre class=\"line-numbers language-java\" data-language=\"java\"><code class=\"language-java\">@ChannelHandler.Sharable\npublic class ChatRequestMessageHandler extends SimpleChannelInboundHandler&lt;ChatRequestMessage&gt; &#123;\n    @Override\n    protected void channelRead0(ChannelHandlerContext ctx, ChatRequestMessage msg) throws Exception &#123;\n        String to &#x3D; msg.getTo();\n        Channel channel &#x3D; SessionFactory.getSession().getChannel(to);&#x2F;&#x2F;\n        &#x2F;&#x2F; åœ¨çº¿\n        if(channel !&#x3D; null) &#123;\n            channel.writeAndFlush(new ChatResponseMessage(msg.getFrom(), msg.getContent()));\n        &#125;\n        &#x2F;&#x2F; ä¸åœ¨çº¿\n        else &#123;\n            ctx.writeAndFlush(new ChatResponseMessage(false, &quot;å¯¹æ–¹ç”¨æˆ·ä¸å­˜åœ¨æˆ–è€…ä¸åœ¨çº¿&quot;));\n        &#125;\n    &#125;\n&#125;</code></pre>\n\n<p>1Server 2Clientï¼š  zhangsan123  lisi123</p>\n<p>send lisi ä½ å¥½         send zhangsan helloï¼</p>\n<h3 id=\"3-4-èŠå¤©å®¤ä¸šåŠ¡-ç¾¤èŠ\"><a href=\"#3-4-èŠå¤©å®¤ä¸šåŠ¡-ç¾¤èŠ\" class=\"headerlink\" title=\"3.4 èŠå¤©å®¤ä¸šåŠ¡-ç¾¤èŠ\"></a>3.4 èŠå¤©å®¤ä¸šåŠ¡-ç¾¤èŠ</h3><p>åˆ›å»ºç¾¤èŠ</p>\n<pre class=\"line-numbers language-java\" data-language=\"java\"><code class=\"language-java\">@ChannelHandler.Sharable\npublic class GroupCreateRequestMessageHandler extends SimpleChannelInboundHandler&lt;GroupCreateRequestMessage&gt; &#123;\n    @Override\n    protected void channelRead0(ChannelHandlerContext ctx, GroupCreateRequestMessage msg) throws Exception &#123;\n        String groupName &#x3D; msg.getGroupName();\n        Set&lt;String&gt; members &#x3D; msg.getMembers();\n        &#x2F;&#x2F; ç¾¤ç®¡ç†å™¨\n        GroupSession groupSession &#x3D; GroupSessionFactory.getGroupSession();\n        Group group &#x3D; groupSession.createGroup(groupName, members);&#x2F;&#x2F;ConcurrentHashMap groupMap.putIfAbsent()\n        if (group &#x3D;&#x3D; null) &#123;\n            &#x2F;&#x2F; å‘é€æˆåŠŸæ¶ˆæ¯\n            ctx.writeAndFlush(new GroupCreateResponseMessage(true, groupName + &quot;åˆ›å»ºæˆåŠŸ&quot;));\n            &#x2F;&#x2F; ç¾¤å‘æ‹‰ç¾¤æ¶ˆæ¯\n            List&lt;Channel&gt; channels &#x3D; groupSession.getMembersChannel(groupName);&#x2F;&#x2F;Java8 è¿‡æ»¤å‡ºnonNull_members!!!\n            for (Channel channel : channels) &#123;\n                channel.writeAndFlush(new GroupCreateResponseMessage(true, &quot;æ‚¨å·²è¢«æ‹‰å…¥&quot; + groupName));\n            &#125;\n        &#125; else &#123;\n            ctx.writeAndFlush(new GroupCreateResponseMessage(false, groupName + &quot;å·²ç»å­˜åœ¨&quot;));\n        &#125;\n    &#125;\n&#125;\n</code></pre>\n\n<p>1Server 3Clientï¼š  zhangsan123  lisi123  wangwu123</p>\n<p>zhangsanå‘ï¼šgcreate ç¾¤èŠ1 lisi,wangwu</p>\n<p>ç¾¤èŠ</p>\n<pre class=\"line-numbers language-java\" data-language=\"java\"><code class=\"language-java\">@ChannelHandler.Sharable\npublic class GroupChatRequestMessageHandler extends SimpleChannelInboundHandler&lt;GroupChatRequestMessage&gt; &#123;\n    @Override\n    protected void channelRead0(ChannelHandlerContext ctx, GroupChatRequestMessage msg) throws Exception &#123;\n        List&lt;Channel&gt; channels &#x3D; GroupSessionFactory.getGroupSession()\n                .getMembersChannel(msg.getGroupName());\n\n        for (Channel channel : channels) &#123;\n            channel.writeAndFlush(new GroupChatResponseMessage(msg.getFrom(), msg.getContent()));&#x2F;&#x2F;ç¾¤å†…æˆå‘˜ï¼šæ”¶åˆ°æ¥è‡ªfromçš„msg_content\n        &#125;\n    &#125;\n&#125;</code></pre>\n\n<p>1Server 3Clientï¼š  zhangsan123  lisi123  wangwu123 zhaoliu123</p>\n<p>zhangsanå‘ï¼šgcreate ç¾¤èŠ1 lisi,wangwu</p>\n<p>gsend ç¾¤èŠ1 å¤§å®¶å¥½</p>\n<p>ã€ä½œä¸šã€‘</p>\n<p>åŠ å…¥ç¾¤èŠ</p>\n<pre class=\"line-numbers language-java\" data-language=\"java\"><code class=\"language-java\">@ChannelHandler.Sharable\npublic class GroupJoinRequestMessageHandler extends SimpleChannelInboundHandler&lt;GroupJoinRequestMessage&gt; &#123;\n    @Override\n    protected void channelRead0(ChannelHandlerContext ctx, GroupJoinRequestMessage msg) throws Exception &#123;\n        Group group &#x3D; GroupSessionFactory.getGroupSession().joinMember(msg.getGroupName(), msg.getUsername());\n        if (group !&#x3D; null) &#123;\n            ctx.writeAndFlush(new GroupJoinResponseMessage(true, msg.getGroupName() + &quot;ç¾¤åŠ å…¥æˆåŠŸ&quot;));\n        &#125; else &#123;\n            ctx.writeAndFlush(new GroupJoinResponseMessage(true, msg.getGroupName() + &quot;ç¾¤ä¸å­˜åœ¨&quot;));\n        &#125;\n    &#125;\n&#125;</code></pre>\n\n<p>gjoin ç¾¤èŠ1</p>\n<p>é€€å‡ºç¾¤èŠ</p>\n<pre class=\"line-numbers language-java\" data-language=\"java\"><code class=\"language-java\">@ChannelHandler.Sharable\npublic class GroupQuitRequestMessageHandler extends SimpleChannelInboundHandler&lt;GroupQuitRequestMessage&gt; &#123;\n    @Override\n    protected void channelRead0(ChannelHandlerContext ctx, GroupQuitRequestMessage msg) throws Exception &#123;\n        Group group &#x3D; GroupSessionFactory.getGroupSession().removeMember(msg.getGroupName(), msg.getUsername());\n        if (group !&#x3D; null) &#123;\n            ctx.writeAndFlush(new GroupJoinResponseMessage(true, &quot;å·²é€€å‡ºç¾¤&quot; + msg.getGroupName()));\n        &#125; else &#123;\n            ctx.writeAndFlush(new GroupJoinResponseMessage(true, msg.getGroupName() + &quot;ç¾¤ä¸å­˜åœ¨&quot;));\n        &#125;\n    &#125;\n&#125;</code></pre>\n\n<p>gquit ç¾¤èŠ1</p>\n<p>æŸ¥çœ‹æˆå‘˜</p>\n<pre class=\"line-numbers language-java\" data-language=\"java\"><code class=\"language-java\">@ChannelHandler.Sharable\npublic class GroupMembersRequestMessageHandler extends SimpleChannelInboundHandler&lt;GroupMembersRequestMessage&gt; &#123;\n    @Override\n    protected void channelRead0(ChannelHandlerContext ctx, GroupMembersRequestMessage msg) throws Exception &#123;\n        Set&lt;String&gt; members &#x3D; GroupSessionFactory.getGroupSession()\n                .getMembers(msg.getGroupName());&#x2F;&#x2F;getOrDefaultï¼\n        ctx.writeAndFlush(new GroupMembersResponseMessage(members));\n    &#125;\n&#125;</code></pre>\n\n<p>gmembers ç¾¤èŠ1</p>\n<h3 id=\"3-5-èŠå¤©å®¤ä¸šåŠ¡-é€€å‡º\"><a href=\"#3-5-èŠå¤©å®¤ä¸šåŠ¡-é€€å‡º\" class=\"headerlink\" title=\"3.5 èŠå¤©å®¤ä¸šåŠ¡-é€€å‡º\"></a>3.5 èŠå¤©å®¤ä¸šåŠ¡-é€€å‡º</h3><pre class=\"line-numbers language-java\" data-language=\"java\"><code class=\"language-java\">@Slf4j\n@ChannelHandler.Sharable\npublic class QuitHandler extends ChannelInboundHandlerAdapter &#123;\n\n    &#x2F;&#x2F; å½“è¿æ¥æ–­å¼€æ—¶è§¦å‘ inactive äº‹ä»¶  [quit]ctx.channel().close();\n    @Override\n    public void channelInactive(ChannelHandlerContext ctx) throws Exception &#123;\n        SessionFactory.getSession().unbind(ctx.channel());\n        log.debug(&quot;&#123;&#125; å·²ç»æ–­å¼€&quot;, ctx.channel());\n    &#125;\n\n    &#x2F;&#x2F; å½“å‡ºç°å¼‚å¸¸æ—¶è§¦å‘ ç›´æ¥å…³é—­ï¼\n    @Override\n    public void exceptionCaught(ChannelHandlerContext ctx, Throwable cause) throws Exception &#123;&#x2F;&#x2F;\n        SessionFactory.getSession().unbind(ctx.channel());\n        log.debug(&quot;&#123;&#125; å·²ç»å¼‚å¸¸æ–­å¼€ å¼‚å¸¸æ˜¯&#123;&#125;&quot;, ctx.channel(), cause.getMessage());\n    &#125;\n&#125;\n</code></pre>\n\n\n\n<h3 id=\"3-6-èŠå¤©å®¤ä¸šåŠ¡-ç©ºé—²æ£€æµ‹\"><a href=\"#3-6-èŠå¤©å®¤ä¸šåŠ¡-ç©ºé—²æ£€æµ‹\" class=\"headerlink\" title=\"3.6 èŠå¤©å®¤ä¸šåŠ¡-ç©ºé—²æ£€æµ‹\"></a>3.6 èŠå¤©å®¤ä¸šåŠ¡-ç©ºé—²æ£€æµ‹</h3><h4 id=\"è¿æ¥å‡æ­»-å¿ƒè·³\"><a href=\"#è¿æ¥å‡æ­»-å¿ƒè·³\" class=\"headerlink\" title=\"è¿æ¥å‡æ­»-å¿ƒè·³\"></a>è¿æ¥å‡æ­»-å¿ƒè·³</h4><p>åŸå› </p>\n<ul>\n<li><strong>ç½‘ç»œè®¾å¤‡å‡ºç°æ•…éšœ</strong>ï¼Œä¾‹å¦‚ç½‘å¡ï¼Œæœºæˆ¿ç­‰ï¼Œ<strong>åº•å±‚çš„ TCP è¿æ¥å·²ç»æ–­å¼€äº†ï¼Œä½†åº”ç”¨ç¨‹åºæ²¡æœ‰æ„ŸçŸ¥åˆ°ï¼Œä»ç„¶å ç”¨ç€èµ„æºã€‚</strong></li>\n<li>å…¬ç½‘ç½‘ç»œä¸ç¨³å®šï¼Œå‡ºç°ä¸¢åŒ…ã€‚å¦‚æœ<strong>è¿ç»­å‡ºç°ä¸¢åŒ…</strong>ï¼Œè¿™æ—¶ç°è±¡å°±æ˜¯å®¢æˆ·ç«¯æ•°æ®å‘ä¸å‡ºå»ï¼ŒæœåŠ¡ç«¯ä¹Ÿä¸€ç›´æ”¶ä¸åˆ°æ•°æ®ï¼Œå°±è¿™ä¹ˆ<strong>ä¸€ç›´è€—ç€</strong></li>\n<li>åº”ç”¨ç¨‹åº<strong>çº¿ç¨‹é˜»å¡ï¼Œæ— æ³•è¿›è¡Œæ•°æ®è¯»å†™</strong></li>\n</ul>\n<p>é—®é¢˜</p>\n<ul>\n<li><strong>å‡æ­»çš„è¿æ¥å ç”¨çš„èµ„æºä¸èƒ½è‡ªåŠ¨é‡Šæ”¾</strong></li>\n<li>å‘å‡æ­»çš„è¿æ¥å‘é€æ•°æ®ï¼Œå¾—åˆ°çš„<strong>åé¦ˆæ˜¯å‘é€è¶…æ—¶</strong></li>\n</ul>\n<p>SæœåŠ¡å™¨ç«¯è§£å†³</p>\n<ul>\n<li>æ€ä¹ˆåˆ¤æ–­å®¢æˆ·ç«¯è¿æ¥æ˜¯å¦å‡æ­»å‘¢ï¼Ÿå¦‚æœ<strong>èƒ½æ”¶åˆ°å®¢æˆ·ç«¯æ•°æ®ï¼Œè¯´æ˜æ²¡æœ‰å‡æ­»</strong>ã€‚å› æ­¤ç­–ç•¥å°±å¯ä»¥å®šä¸ºï¼Œ<strong>æ¯éš”ä¸€æ®µæ—¶é—´å°±[ç©ºé—²æ£€æµ‹]æ£€æŸ¥è¿™æ®µæ—¶é—´å†…æ˜¯å¦æ¥æ”¶åˆ°</strong>å®¢æˆ·ç«¯æ•°æ®ï¼Œæ²¡æœ‰å°±å¯ä»¥åˆ¤å®šä¸ºè¿æ¥å‡æ­»</li>\n</ul>\n<pre class=\"line-numbers language-java\" data-language=\"java\"><code class=\"language-java\">&#x2F;&#x2F; ç”¨æ¥åˆ¤æ–­æ˜¯ä¸æ˜¯ è¯»ç©ºé—²æ—¶é—´è¿‡é•¿ï¼Œæˆ– å†™ç©ºé—²æ—¶é—´è¿‡é•¿\n&#x2F;&#x2F; 5s å†…å¦‚æœæ²¡æœ‰æ”¶åˆ° channel çš„æ•°æ®ï¼Œä¼šè§¦å‘ä¸€ä¸ª IdleState#READER_IDLE äº‹ä»¶ï¼ˆå±äºè‡ªå®šä¹‰çš„ç‰¹æ®Šäº‹ä»¶ï¼ï¼‰\nch.pipeline().addLast(new IdleStateHandler(5, 0, 0));&#x2F;&#x2F;R,W,all  å¤ªå°ä¸å¥½æµ‹ï¼Œå°±æ–­äº†ï¼Œ10s\n&#x2F;&#x2F; ChannelDuplexHandler å¯ä»¥åŒæ—¶ä½œä¸ºå…¥ç«™å’Œå‡ºç«™å¤„ç†å™¨\nch.pipeline().addLast(new ChannelDuplexHandler() &#123;\n    &#x2F;&#x2F; ç”¨æ¥è§¦å‘ã€éioã€‘ç‰¹æ®Šäº‹ä»¶ï¼Œä¾‹å¦‚IdleState#READER_IDLE äº‹ä»¶\n    @Override\n    public void userEventTriggered(ChannelHandlerContext ctx, Object evt) throws Exception&#123;\n        IdleStateEvent event &#x3D; (IdleStateEvent) evt;\n        &#x2F;&#x2F; è§¦å‘äº†è¯»ç©ºé—²äº‹ä»¶\n        if (event.state() &#x3D;&#x3D; IdleState.READER_IDLE) &#123;\n            log.debug(&quot;å·²ç» 5s æ²¡æœ‰è¯»åˆ°æ•°æ®äº†&quot;);\n            ctx.channel().close();\n        &#125;\n    &#125;\n&#125;);</code></pre>\n\n\n\n<p>Cå®¢æˆ·ç«¯å®šæ—¶å¿ƒè·³</p>\n<ul>\n<li>å®¢æˆ·ç«¯å¯ä»¥<strong>å®šæ—¶å‘æœåŠ¡å™¨ç«¯[å‘é€å¿ƒè·³]æ•°æ®ï¼Œåªè¦è¿™ä¸ªæ—¶é—´é—´éš”[å°äºæœåŠ¡å™¨å®šä¹‰çš„ç©ºé—²æ£€æµ‹]çš„æ—¶é—´é—´éš”ï¼Œé‚£ä¹ˆå°±èƒ½é˜²æ­¢å‰é¢æåˆ°çš„è¯¯åˆ¤</strong>ï¼Œå®¢æˆ·ç«¯å¯ä»¥å®šä¹‰å¦‚ä¸‹å¿ƒè·³å¤„ç†å™¨</li>\n</ul>\n<pre class=\"line-numbers language-java\" data-language=\"java\"><code class=\"language-java\">&#x2F;&#x2F; ç”¨æ¥åˆ¤æ–­æ˜¯ä¸æ˜¯ è¯»ç©ºé—²æ—¶é—´è¿‡é•¿ï¼Œæˆ– å†™ç©ºé—²æ—¶é—´è¿‡é•¿\n&#x2F;&#x2F; 3s å†…å¦‚æœæ²¡æœ‰å‘æœåŠ¡å™¨å†™æ•°æ®ï¼Œä¼šè§¦å‘ä¸€ä¸ª IdleState#WRITER_IDLE äº‹ä»¶\nch.pipeline().addLast(new IdleStateHandler(0, 3, 0));\n&#x2F;&#x2F; ChannelDuplexHandler å¯ä»¥åŒæ—¶ä½œä¸ºå…¥ç«™å’Œå‡ºç«™å¤„ç†å™¨\nch.pipeline().addLast(new ChannelDuplexHandler() &#123;\n    &#x2F;&#x2F; ç”¨æ¥è§¦å‘ç‰¹æ®Šäº‹ä»¶\n    @Override\n    public void userEventTriggered(ChannelHandlerContext ctx, Object evt) throws Exception&#123;\n        IdleStateEvent event &#x3D; (IdleStateEvent) evt;\n        &#x2F;&#x2F; è§¦å‘äº†å†™ç©ºé—²äº‹ä»¶\n        if (event.state() &#x3D;&#x3D; IdleState.WRITER_IDLE) &#123;\n            &#x2F;&#x2F;log.debug(&quot;3s æ²¡æœ‰å†™æ•°æ®äº†ï¼Œå‘é€ä¸€ä¸ªå¿ƒè·³åŒ…&quot;);&#x2F;&#x2F;æ³¨é‡Šæ‰ï¼Œé¿å…æ‰“æ–­è¾“å…¥ï¼\n            ctx.writeAndFlush(new PingMessage());\n        &#125;\n    &#125;\n&#125;);</code></pre>\n\n<h1 id=\"å››-ä¼˜åŒ–ä¸æºç \"><a href=\"#å››-ä¼˜åŒ–ä¸æºç \" class=\"headerlink\" title=\"å››. ä¼˜åŒ–ä¸æºç \"></a>å››. ä¼˜åŒ–ä¸æºç </h1><h2 id=\"1-ä¼˜åŒ–\"><a href=\"#1-ä¼˜åŒ–\" class=\"headerlink\" title=\"1. ä¼˜åŒ–\"></a>1. ä¼˜åŒ–</h2><h3 id=\"1-1-æ‰©å±•åºåˆ—åŒ–ç®—æ³•\"><a href=\"#1-1-æ‰©å±•åºåˆ—åŒ–ç®—æ³•\" class=\"headerlink\" title=\"1.1 æ‰©å±•åºåˆ—åŒ–ç®—æ³•\"></a>1.1 æ‰©å±•åºåˆ—åŒ–ç®—æ³•</h3><p>åºåˆ—åŒ–ï¼Œååºåˆ—åŒ–ä¸»è¦ç”¨åœ¨æ¶ˆæ¯æ­£æ–‡çš„è½¬æ¢ä¸Š</p>\n<ul>\n<li>åºåˆ—åŒ–æ—¶ï¼Œéœ€è¦å°† Java å¯¹è±¡å˜ä¸ºè¦ä¼ è¾“çš„æ•°æ®ï¼ˆå¯ä»¥æ˜¯ byte[]ï¼Œæˆ– json ç­‰ï¼Œæœ€ç»ˆéƒ½éœ€è¦å˜æˆ byte[]ï¼‰</li>\n<li>ååºåˆ—åŒ–æ—¶ï¼Œéœ€è¦å°†ä¼ å…¥çš„æ­£æ–‡æ•°æ®è¿˜åŸæˆ Java å¯¹è±¡ï¼Œä¾¿äºå¤„ç†</li>\n</ul>\n<p>ç›®å‰çš„ä»£ç ä»…æ”¯æŒ Java è‡ªå¸¦çš„åºåˆ—åŒ–ï¼Œååºåˆ—åŒ–æœºåˆ¶ï¼Œæ ¸å¿ƒä»£ç å¦‚ä¸‹</p>\n<pre class=\"line-numbers language-java\" data-language=\"java\"><code class=\"language-java\">&#x2F;&#x2F; ååºåˆ—åŒ–\nbyte[] body &#x3D; new byte[bodyLength];\nbyteByf.readBytes(body);\nObjectInputStream in &#x3D; new ObjectInputStream(new ByteArrayInputStream(body));\nMessage message &#x3D; (Message) in.readObject();\nmessage.setSequenceId(sequenceId);\n\n&#x2F;&#x2F; åºåˆ—åŒ–\nByteArrayOutputStream out &#x3D; new ByteArrayOutputStream();\nnew ObjectOutputStream(out).writeObject(message);\nbyte[] bytes &#x3D; out.toByteArray();</code></pre>\n\n<p>ä¸ºäº†æ”¯æŒæ›´å¤šåºåˆ—åŒ–ç®—æ³•ï¼ŒæŠ½è±¡ä¸€ä¸ª Serializer æ¥å£</p>\n<pre class=\"line-numbers language-java\" data-language=\"java\"><code class=\"language-java\">public interface Serializer &#123;\n\n    &#x2F;&#x2F; ååºåˆ—åŒ–æ–¹æ³•\n    &lt;T&gt; T deserialize(Class&lt;T&gt; clazz, byte[] bytes);\n\n    &#x2F;&#x2F; åºåˆ—åŒ–æ–¹æ³•\n    &lt;T&gt; byte[] serialize(T object);\n\n&#125;</code></pre>\n\n<p>æä¾›ä¸¤ä¸ªå®ç°ï¼Œæˆ‘è¿™é‡Œç›´æ¥å°†å®ç°åŠ å…¥äº†æšä¸¾ç±» Serializer.Algorithm ä¸­</p>\n<pre class=\"line-numbers language-java\" data-language=\"java\"><code class=\"language-java\">enum SerializerAlgorithm implements Serializer &#123;\n\t&#x2F;&#x2F; Java å®ç°\n    Java &#123;\n        @Override\n        public &lt;T&gt; T deserialize(Class&lt;T&gt; clazz, byte[] bytes) &#123;\n            try &#123;\n                ObjectInputStream in &#x3D; \n                    new ObjectInputStream(new ByteArrayInputStream(bytes));\n                Object object &#x3D; in.readObject();\n                return (T) object;\n            &#125; catch (IOException | ClassNotFoundException e) &#123;\n                throw new RuntimeException(&quot;SerializerAlgorithm.Java ååºåˆ—åŒ–é”™è¯¯&quot;, e);\n            &#125;\n        &#125;\n\n        @Override\n        public &lt;T&gt; byte[] serialize(T object) &#123;\n            try &#123;\n                ByteArrayOutputStream out &#x3D; new ByteArrayOutputStream();\n                new ObjectOutputStream(out).writeObject(object);\n                return out.toByteArray();\n            &#125; catch (IOException e) &#123;\n                throw new RuntimeException(&quot;SerializerAlgorithm.Java åºåˆ—åŒ–é”™è¯¯&quot;, e);\n            &#125;\n        &#125;\n    &#125;, \n    &#x2F;&#x2F; Json å®ç°(å¼•å…¥äº† Gson ä¾èµ–)\n    Json &#123;\n        @Override\n        public &lt;T&gt; T deserialize(Class&lt;T&gt; clazz, byte[] bytes) &#123;\n            return new Gson().fromJson(new String(bytes, StandardCharsets.UTF_8), clazz);&#x2F;&#x2F;\n        &#125;\n\n        @Override\n        public &lt;T&gt; byte[] serialize(T object) &#123;\n            return new Gson().toJson(object).getBytes(StandardCharsets.UTF_8);&#x2F;&#x2F;\n        &#125;\n    &#125;;\n\n    &#x2F;&#x2F; éœ€è¦ä»åè®®çš„å­—èŠ‚ä¸­å¾—åˆ°æ˜¯å“ªç§åºåˆ—åŒ–ç®—æ³•ã€å¼ƒç”¨ï¼Œæœ‰APIï¼ã€‘\n    public static SerializerAlgorithm getByInt(int type) &#123;\n        SerializerAlgorithm[] array &#x3D; SerializerAlgorithm.values();\n        if (type &lt; 0 || type &gt; array.length - 1) &#123;\n            throw new IllegalArgumentException(&quot;è¶…è¿‡ SerializerAlgorithm èŒƒå›´&quot;);\n        &#125;\n        return array[type];\n    &#125;\n&#125;</code></pre>\n\n<p>æˆ‘çš„åšæ³•ï¼š</p>\n<pre class=\"line-numbers language-java\" data-language=\"java\"><code class=\"language-java\">package cn.itcast.protocol;\n\nimport com.google.gson.*;\n\nimport java.io.*;\nimport java.lang.reflect.Type;\nimport java.nio.charset.StandardCharsets;\n\n&#x2F;**\n * ç”¨äºæ‰©å±•åºåˆ—åŒ–ã€ååºåˆ—åŒ–ç®—æ³•\n *&#x2F;\npublic interface Serializer &#123;\n\n    &#x2F;&#x2F; ååºåˆ—åŒ–æ–¹æ³•\n    &lt;T&gt; T deserialize(Class&lt;T&gt; clazz, byte[] bytes);\n\n    &#x2F;&#x2F; åºåˆ—åŒ–æ–¹æ³•\n    &lt;T&gt; byte[] serialize(T object);\n\n    enum Algorithm implements Serializer &#123;\n\n        Java &#123;\n            @Override\n            public &lt;T&gt; T deserialize(Class&lt;T&gt; clazz, byte[] bytes) &#123;\n                try &#123;\n                    ObjectInputStream ois &#x3D; new ObjectInputStream(new ByteArrayInputStream(bytes));&#x2F;&#x2F;ois-bis-byt[]\n                    return (T) ois.readObject();&#x2F;&#x2F;(T)\n                &#125; catch (IOException | ClassNotFoundException e) &#123;&#x2F;&#x2F;|\n                    throw new RuntimeException(&quot;ååºåˆ—åŒ–å¤±è´¥&quot;, e);\n                &#125;\n            &#125;\n\n            @Override\n            public &lt;T&gt; byte[] serialize(T object) &#123;\n                try &#123;\n                    ByteArrayOutputStream bos &#x3D; new ByteArrayOutputStream();\n                    ObjectOutputStream oos &#x3D; new ObjectOutputStream(bos);\n                    oos.writeObject(object);&#x2F;&#x2F;oos-bos-obj  bos-&gt;byte[]\n                    return bos.toByteArray();\n                &#125; catch (IOException e) &#123;\n                    throw new RuntimeException(&quot;åºåˆ—åŒ–å¤±è´¥&quot;, e);\n                &#125;\n            &#125;\n        &#125;,\n\n        Json &#123;\n            @Override\n            public &lt;T&gt; T deserialize(Class&lt;T&gt; clazz, byte[] bytes) &#123;\n                Gson gson &#x3D; new GsonBuilder().registerTypeAdapter(Class.class, new Serializer.ClassCodec()).create();&#x2F;&#x2F;+ClassCodec\n                String json &#x3D; new String(bytes, StandardCharsets.UTF_8);\n&#x2F;&#x2F;                return new Gson().fromJson(json, clazz);&#x2F;&#x2F;\n                return gson.fromJson(json, clazz);\n            &#125;\n\n            @Override\n            public &lt;T&gt; byte[] serialize(T object) &#123;\n                Gson gson &#x3D; new GsonBuilder().registerTypeAdapter(Class.class, new Serializer.ClassCodec()).create();&#x2F;&#x2F;+ClassCodec\n                String json &#x3D; gson.toJson(object);\n&#x2F;&#x2F;                String json &#x3D; new Gson().toJson(object);\n                return json.getBytes(StandardCharsets.UTF_8);\n            &#125;\n        &#125;\n    &#125;\n    &#x2F;&#x2F;è‡ªå®šä¹‰ClassCodec\n    class ClassCodec implements JsonSerializer&lt;Class&lt;?&gt;&gt;, JsonDeserializer&lt;Class&lt;?&gt;&gt; &#123;\n\n        @Override\n        public Class&lt;?&gt; deserialize(JsonElement json, Type typeOfT, JsonDeserializationContext context) throws JsonParseException &#123;\n            try &#123;\n                String str &#x3D; json.getAsString();\n                return Class.forName(str);\n            &#125; catch (ClassNotFoundException e) &#123;\n                throw new JsonParseException(e);\n            &#125;\n        &#125;\n\n        @Override             &#x2F;&#x2F;   String.class\n        public JsonElement serialize(Class&lt;?&gt; src, Type typeOfSrc, JsonSerializationContext context) &#123;\n            &#x2F;&#x2F; class -&gt; json\n            return new JsonPrimitive(src.getName());\n        &#125;\n    &#125;\n&#125;</code></pre>\n\n<p>registerTypeAdapter(java.lang.reflect.Type type, java.lang.Object typeAdapter) ä¸ºtypeç±»å‹å­—æ®µï¼ŒæŒ‡å®šç‰¹æ®Šçš„ç±»å‹é€‚é…å™¨<br>ä¾‹å­01ï¼šæ ¼å¼åŒ–æ—¥æœŸç±»å‹</p>\n<p>@JsonAdapter ä¸€æ ·çš„æ–¹å¼<br>å¯ä»¥æ”¯æŒ <strong>JsonDeserializer,JsonSerializer</strong>,InstanceCreator,TypeAdapterå››ç§é€‚é…å™¨ç±»å‹<br>â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”<br>ç‰ˆæƒå£°æ˜ï¼šæœ¬æ–‡ä¸ºCSDNåšä¸»ã€Œå‘ä¸Šå°èš‚èšã€çš„åŸåˆ›æ–‡ç« ï¼Œéµå¾ªCC 4.0 BY-SAç‰ˆæƒåè®®ï¼Œè½¬è½½è¯·é™„ä¸ŠåŸæ–‡å‡ºå¤„é“¾æ¥åŠæœ¬å£°æ˜ã€‚<br>åŸæ–‡é“¾æ¥ï¼š<a href=\"https://blog.csdn.net/jieandan/article/details/109774650\">https://blog.csdn.net/jieandan/article/details/109774650</a></p>\n<p>å¢åŠ é…ç½®ç±»å’Œé…ç½®æ–‡ä»¶</p>\n<pre class=\"line-numbers language-java\" data-language=\"java\"><code class=\"language-java\">public abstract class Config &#123;\n    static Properties properties;\n    static &#123;\n        try (InputStream in &#x3D; Config.class.getResourceAsStream(&quot;&#x2F;application.properties&quot;)) &#123;\n            properties &#x3D; new Properties();\n            properties.load(in);\n        &#125; catch (IOException e) &#123;\n            throw new ExceptionInInitializerError(e);\n        &#125;\n    &#125;\n    public static int getServerPort() &#123;\n        String value &#x3D; properties.getProperty(&quot;server.port&quot;);\n        if(value &#x3D;&#x3D; null) &#123;\n            return 8080;\n        &#125; else &#123;\n            return Integer.parseInt(value);\n        &#125;\n    &#125;\n    public static Serializer.Algorithm getSerializerAlgorithm() &#123;\n        String value &#x3D; properties.getProperty(&quot;serializer.algorithm&quot;);\n        if(value &#x3D;&#x3D; null) &#123;\n            return Serializer.Algorithm.Java;\n        &#125; else &#123;\n            return Serializer.Algorithm.valueOf(value);&#x2F;&#x2F;\n        &#125;\n    &#125;\n&#125;</code></pre>\n\n\n\n<p>é…ç½®æ–‡ä»¶</p>\n<pre class=\"line-numbers language-properties\" data-language=\"properties\"><code class=\"language-properties\">serializer.algorithm&#x3D;Json</code></pre>\n\n\n\n<p>ä¿®æ”¹ç¼–è§£ç å™¨</p>\n<p>out.writeByte(Config.getSerializerAlgorithm().ordinal());&#x2F;&#x2F;Java-&gt;0</p>\n<p>&#x2F;&#x2F; æ‰¾åˆ°ååºåˆ—åŒ–ç®—æ³•<br>        Serializer.Algorithm algorithm &#x3D; Serializer.Algorithm.values()[serializerAlgorithm];&#x2F;&#x2F;.values()[0]&#x3D;Java æšä¸¾ç±»å¯¹è±¡</p>\n<pre class=\"line-numbers language-java\" data-language=\"java\"><code class=\"language-java\">&#x2F;**\n * å¿…é¡»å’Œ LengthFieldBasedFrameDecoder ä¸€èµ·ä½¿ç”¨ï¼Œç¡®ä¿æ¥åˆ°çš„ ByteBuf æ¶ˆæ¯æ˜¯å®Œæ•´çš„\n *&#x2F;\npublic class MessageCodecSharable extends MessageToMessageCodec&lt;ByteBuf, Message&gt; &#123;\n    @Override\n    public void encode(ChannelHandlerContext ctx, Message msg, List&lt;Object&gt; outList) throws Exception &#123;\n        ByteBuf out &#x3D; ctx.alloc().buffer();\n        &#x2F;&#x2F; 1. 4 å­—èŠ‚çš„é­”æ•°\n        out.writeBytes(new byte[]&#123;1, 2, 3, 4&#125;);\n        &#x2F;&#x2F; 2. 1 å­—èŠ‚çš„ç‰ˆæœ¬,\n        out.writeByte(1);\n        &#x2F;&#x2F; 3. 1 å­—èŠ‚çš„åºåˆ—åŒ–æ–¹å¼ jdk 0 , json 1\n        out.writeByte(Config.getSerializerAlgorithm().ordinal());&#x2F;&#x2F;Java-&gt;0\n        &#x2F;&#x2F; 4. 1 å­—èŠ‚çš„æŒ‡ä»¤ç±»å‹\n        out.writeByte(msg.getMessageType());\n        &#x2F;&#x2F; 5. 4 ä¸ªå­—èŠ‚\n        out.writeInt(msg.getSequenceId());\n        &#x2F;&#x2F; æ— æ„ä¹‰ï¼Œå¯¹é½å¡«å……\n        out.writeByte(0xff);\n        &#x2F;&#x2F; 6. è·å–å†…å®¹çš„å­—èŠ‚æ•°ç»„\n        byte[] bytes &#x3D; Config.getSerializerAlgorithm().serialize(msg);\n        &#x2F;&#x2F; 7. é•¿åº¦\n        out.writeInt(bytes.length);\n        &#x2F;&#x2F; 8. å†™å…¥å†…å®¹\n        out.writeBytes(bytes);\n        outList.add(out);\n    &#125;\n\n    @Override\n    protected void decode(ChannelHandlerContext ctx, ByteBuf in, List&lt;Object&gt; out) throws Exception &#123;\n        int magicNum &#x3D; in.readInt();\n        byte version &#x3D; in.readByte();\n        byte serializerAlgorithm &#x3D; in.readByte(); &#x2F;&#x2F; 0 æˆ– 1\n        byte messageType &#x3D; in.readByte(); &#x2F;&#x2F; 0,1,2...\n        int sequenceId &#x3D; in.readInt();\n        in.readByte();\n        int length &#x3D; in.readInt();\n        byte[] bytes &#x3D; new byte[length];\n        in.readBytes(bytes, 0, length);\n\n&#x2F;&#x2F;        Message msg &#x3D; Serializer.Algorithm.Java.deserialize(Message.class, bytes);&#x2F;&#x2F;ä¸è¡Œï¼š1.å†™æ­»Java 2.Messageæ˜¯æŠ½è±¡ç±»ï¼è¦ç¡®å®šå…·ä½“msg.classï¼\n\n        &#x2F;&#x2F; æ‰¾åˆ°ååºåˆ—åŒ–ç®—æ³•\n        Serializer.Algorithm algorithm &#x3D; Serializer.Algorithm.values()[serializerAlgorithm];&#x2F;&#x2F;.values()[0]&#x3D;Java æšä¸¾ç±»å¯¹è±¡\n        &#x2F;&#x2F; ç¡®å®šå…·ä½“æ¶ˆæ¯ç±»å‹\n        Class&lt;? extends Message&gt; messageClass &#x3D; Message.getMessageClass(messageType);\n        Message message &#x3D; algorithm.deserialize(messageClass, bytes);\n&#x2F;&#x2F;        log.debug(&quot;&#123;&#125;, &#123;&#125;, &#123;&#125;, &#123;&#125;, &#123;&#125;, &#123;&#125;&quot;, magicNum, version, serializerType, messageType, sequenceId, length);\n&#x2F;&#x2F;        log.debug(&quot;&#123;&#125;&quot;, message);\n        out.add(message);\n    &#125;\n&#125;</code></pre>\n\n\n\n<p>å…¶ä¸­ç¡®å®šå…·ä½“æ¶ˆæ¯ç±»å‹ï¼Œå¯ä»¥æ ¹æ® <code>æ¶ˆæ¯ç±»å‹å­—èŠ‚</code> è·å–åˆ°å¯¹åº”çš„ <code>æ¶ˆæ¯ class</code></p>\n<pre class=\"line-numbers language-java\" data-language=\"java\"><code class=\"language-java\">@Data\npublic abstract class Message implements Serializable &#123;\n\n    &#x2F;**\n     * æ ¹æ®æ¶ˆæ¯ç±»å‹å­—èŠ‚ï¼Œè·å¾—å¯¹åº”çš„æ¶ˆæ¯ class\n     * @param messageType æ¶ˆæ¯ç±»å‹å­—èŠ‚\n     * @return æ¶ˆæ¯ class\n     *&#x2F;\n    public static Class&lt;? extends Message&gt; getMessageClass(int messageType) &#123;\n        return messageClasses.get(messageType);\n    &#125;\n\n    private int sequenceId;\n\n    private int messageType;\n\n    public abstract int getMessageType();\n\n    public static final int LoginRequestMessage &#x3D; 0;\n    public static final int LoginResponseMessage &#x3D; 1;\n    public static final int ChatRequestMessage &#x3D; 2;\n    public static final int ChatResponseMessage &#x3D; 3;\n    public static final int GroupCreateRequestMessage &#x3D; 4;\n    public static final int GroupCreateResponseMessage &#x3D; 5;\n    public static final int GroupJoinRequestMessage &#x3D; 6;\n    public static final int GroupJoinResponseMessage &#x3D; 7;\n    public static final int GroupQuitRequestMessage &#x3D; 8;\n    public static final int GroupQuitResponseMessage &#x3D; 9;\n    public static final int GroupChatRequestMessage &#x3D; 10;\n    public static final int GroupChatResponseMessage &#x3D; 11;\n    public static final int GroupMembersRequestMessage &#x3D; 12;\n    public static final int GroupMembersResponseMessage &#x3D; 13;\n    public static final int PingMessage &#x3D; 14;\n    public static final int PongMessage &#x3D; 15;\n    private static final Map&lt;Integer, Class&lt;? extends Message&gt;&gt; messageClasses &#x3D; new HashMap&lt;&gt;();\n\n    static &#123;\n        messageClasses.put(LoginRequestMessage, LoginRequestMessage.class);\n        messageClasses.put(LoginResponseMessage, LoginResponseMessage.class);\n        messageClasses.put(ChatRequestMessage, ChatRequestMessage.class);\n        messageClasses.put(ChatResponseMessage, ChatResponseMessage.class);\n        messageClasses.put(GroupCreateRequestMessage, GroupCreateRequestMessage.class);\n        messageClasses.put(GroupCreateResponseMessage, GroupCreateResponseMessage.class);\n        messageClasses.put(GroupJoinRequestMessage, GroupJoinRequestMessage.class);\n        messageClasses.put(GroupJoinResponseMessage, GroupJoinResponseMessage.class);\n        messageClasses.put(GroupQuitRequestMessage, GroupQuitRequestMessage.class);\n        messageClasses.put(GroupQuitResponseMessage, GroupQuitResponseMessage.class);\n        messageClasses.put(GroupChatRequestMessage, GroupChatRequestMessage.class);\n        messageClasses.put(GroupChatResponseMessage, GroupChatResponseMessage.class);\n        messageClasses.put(GroupMembersRequestMessage, GroupMembersRequestMessage.class);\n        messageClasses.put(GroupMembersResponseMessage, GroupMembersResponseMessage.class);\n    &#125;\n&#125;</code></pre>\n\n<p>test.javaä¸‹netty.c5.TestSerializerï¼š</p>\n<pre class=\"line-numbers language-java\" data-language=\"java\"><code class=\"language-java\">package cn.itcast.netty.c5;\n\npublic class TestSerializer &#123;\n\n    public static void main(String[] args)  &#123;\n        MessageCodecSharable CODEC &#x3D; new MessageCodecSharable();\n        LoggingHandler LOGGING &#x3D; new LoggingHandler();\n        EmbeddedChannel channel &#x3D; new EmbeddedChannel(LOGGING, CODEC, LOGGING);&#x2F;&#x2F;(handlers) logç¼–è§£ç å‰å\n\n        LoginRequestMessage message &#x3D; new LoginRequestMessage(&quot;zhangsan&quot;, &quot;123&quot;);\n        &#x2F;&#x2F;&lt;-out_ç¼–ç _åºåˆ—åŒ–  å‰logï¼šJavaå¯¹è±¡msg-&gt;ålogï¼šbuf[]_Jsonä¸²ã€Jdkåºåˆ—åŒ–ï¼šè¾ƒé•¿ï¼Œbinçœ‹ä¸æ‡‚ã€‘ ret boolean\n        channel.writeOutbound(message);\n        &#x2F;&#x2F;å› ä¸ºMessageCodecSharable.encode(ctx,)æ–¹æ³•ä¸èƒ½ç›´æ¥ç”¨:ByteBuf out &#x3D; å…¥å‚ctx.alloc().buffer();å†…éƒ¨åˆ†é…ä½¿ç”¨\n        ByteBuf buf &#x3D; messageToByteBuf(message);\n        &#x2F;&#x2F;-&gt;in_è§£ç _ååºåˆ—åŒ–  å‰logï¼šbuf[]_Jsonä¸²-&gt;ålogï¼šJavaå¯¹è±¡\n        channel.writeInbound(buf);\n    &#125;\n\n    public static ByteBuf messageToByteBuf(Message msg) &#123;&#x2F;&#x2F;Javaå¯¹è±¡-&gt;ByteBuf\n        int algorithm &#x3D; Config.getSerializerAlgorithm().ordinal();\n        ByteBuf out &#x3D; ByteBufAllocator.DEFAULT.buffer();&#x2F;&#x2F;è‡ªå·±åˆ†é…ByteBuf\n        out.writeBytes(new byte[]&#123;1, 2, 3, 4&#125;);\n        out.writeByte(1);\n        out.writeByte(algorithm);\n        out.writeByte(msg.getMessageType());\n        out.writeInt(msg.getSequenceId());\n        out.writeByte(0xff);\n        byte[] bytes &#x3D; Serializer.Algorithm.values()[algorithm].serialize(msg);&#x2F;&#x2F;\n        out.writeInt(bytes.length);\n        out.writeBytes(bytes);\n        return out;\n    &#125;\n&#125;\n</code></pre>\n\n\n\n<h3 id=\"1-2-å‚æ•°è°ƒä¼˜\"><a href=\"#1-2-å‚æ•°è°ƒä¼˜\" class=\"headerlink\" title=\"1.2 å‚æ•°è°ƒä¼˜\"></a>1.2 å‚æ•°è°ƒä¼˜</h3><h4 id=\"1ï¼‰CONNECT-TIMEOUT-MILLIS\"><a href=\"#1ï¼‰CONNECT-TIMEOUT-MILLIS\" class=\"headerlink\" title=\"1ï¼‰CONNECT_TIMEOUT_MILLIS\"></a>1ï¼‰CONNECT_TIMEOUT_MILLIS</h4><ul>\n<li>å±äº SocketChannal å‚æ•°</li>\n<li>ç”¨åœ¨<strong>å®¢æˆ·ç«¯å»ºç«‹è¿æ¥</strong>æ—¶(Serveråªæœ‰accept()æ¥æ”¶è¿æ¥)ï¼Œå¦‚æœåœ¨<strong>æŒ‡å®šæ¯«ç§’å†…æ— æ³•è¿æ¥ï¼Œä¼šæŠ›å‡º timeout å¼‚å¸¸</strong></li>\n<li>æ˜“æ··æ·†ï¼š<strong>SO_TIMEOUT ä¸»è¦ç”¨åœ¨[ä¼ ç»Ÿé˜»å¡ IO]ï¼Œé˜»å¡ IO ä¸­ acceptï¼Œread ç­‰éƒ½æ˜¯æ— é™ç­‰å¾…çš„</strong>ï¼Œå¦‚æœä¸å¸Œæœ›æ°¸è¿œé˜»å¡ï¼Œä½¿ç”¨å®ƒè°ƒæ•´è¶…æ—¶æ—¶é—´ã€ä¸ç”¨åœ¨nioã€nettyç¼–ç¨‹ï¼ã€‘</li>\n</ul>\n<p>testä¸‹çš„sourceåŒ…ä¸‹ï¼š</p>\n<pre class=\"line-numbers language-java\" data-language=\"java\"><code class=\"language-java\">@Slf4j\npublic class TestConnectionTimeout &#123;\n    public static void main(String[] args) &#123;\n        &#x2F;&#x2F; 1. å®¢æˆ·ç«¯é€šè¿‡ .option() æ–¹æ³•é…ç½®å‚æ•° ç»™ SocketChannel é…ç½®å‚æ•°\n\n        &#x2F;&#x2F; 2. æœåŠ¡å™¨ç«¯\n&#x2F;&#x2F;        new ServerBootstrap().option() &#x2F;&#x2F; æ˜¯ç»™ ServerSocketChannel é…ç½®å‚æ•°\n&#x2F;&#x2F;        new ServerBootstrap().childOption() &#x2F;&#x2F; ç»™ SocketChannel é…ç½®å‚æ•°\n        NioEventLoopGroup group &#x3D; new NioEventLoopGroup();\n        try &#123;\n            Bootstrap bootstrap &#x3D; new Bootstrap()\n                    .group(group)\n                    .option(ChannelOption.CONNECT_TIMEOUT_MILLIS, 300)&#x2F;&#x2F;3000msè¶…æ—¶:ç­‰ä¸åˆ°\n                    .channel(NioSocketChannel.class)\n                    .handler(new LoggingHandler());\n            ChannelFuture future &#x3D; bootstrap.connect(&quot;127.0.0.1&quot;, 8080);\n            future.sync().channel().closeFuture().sync(); &#x2F;&#x2F; æ–­ç‚¹1\n        &#125; catch (Exception e) &#123;\n            e.printStackTrace();\n            log.debug(&quot;timeout&quot;);\n        &#125; finally &#123;\n            group.shutdownGracefully();\n        &#125;\n    &#125;\n&#125;</code></pre>\n\n<p>2så°±ç¡®è®¤Serverç«¯æ²¡å¼€ï¼Œè¿æ¥æ‹’ç»ã€‚ä¸ç­‰è¶…æ—¶å°±æŠ¥é”™</p>\n<p>Caused by: java.net.ConnectException: Connection refused: no further information</p>\n<p>1.future.sync().channel().closeFuture().sync();</p>\n<p>2.æŠ›å¼‚å¸¸å¤„(AbstractNioChannel.java:263) </p>\n<p>ä¸¤å¤„+ç«¯ç‚¹ã€å³é”®ï¼Œç±»å‹å¿…é¡»æ˜¯ï¼šThreadç±»å‹ï¼ã€‘ï¼Œdebugï¼š</p>\n<p>future å³é”®mark object</p>\n<p>æ¢nioTHï¼š</p>\n<p>å¦å¤–æºç éƒ¨åˆ† <code>io.netty.channel.nio.AbstractNioChannel.AbstractNioUnsafe#connect</code></p>\n<p>eventLoop-ç›‘æµ‹nioäº‹ä»¶ å†…æœ‰nioth &#x2F; thï¼šæäº¤(å®šæ—¶)ä»»åŠ¡ schedule è¿æ¥è¶…æ—¶</p>\n<pre class=\"line-numbers language-java\" data-language=\"java\"><code class=\"language-java\">@Override\npublic final void connect(\n        final SocketAddress remoteAddress, final SocketAddress localAddress, final ChannelPromise promise) &#123;\n    &#x2F;&#x2F; ...\n    &#x2F;&#x2F; Schedule connect timeout.\n    int connectTimeoutMillis &#x3D; config().getConnectTimeoutMillis();&#x2F;&#x2F;\n    if (connectTimeoutMillis &gt; 0) &#123;\n        connectTimeoutFuture &#x3D; eventLoop().schedule(new Runnable() &#123;\n            @Override\n            public void run() &#123;                \n                ChannelPromise connectPromise &#x3D; AbstractNioChannel.this.connectPromise;\n                ConnectTimeoutException cause &#x3D;\n                    new ConnectTimeoutException(&quot;connection timed out: &quot; + remoteAddress); &#x2F;&#x2F; æ–­ç‚¹2 å¼‚å¸¸\n                if (connectPromise !&#x3D; null &amp;&amp; connectPromise.tryFailure(cause)) &#123;&#x2F;&#x2F;å¼‚å¸¸cause-å”¤é†’ä¸»sync() catch...\n                    close(voidPromise());\n                &#125;\n            &#125;\n        &#125;, connectTimeoutMillis, TimeUnit.MILLISECONDS);\n    &#125;\n\t&#x2F;&#x2F; ...\n&#125;</code></pre>\n\n<p>Promise  å®šæ—¶ä»»åŠ¡</p>\n<h4 id=\"2ï¼‰SO-BACKLOG\"><a href=\"#2ï¼‰SO-BACKLOG\" class=\"headerlink\" title=\"2ï¼‰SO_BACKLOG\"></a>2ï¼‰SO_BACKLOG</h4><ul>\n<li>å±äº ServerSocketChannal å‚æ•°ï¼ˆå»ºç«‹è¿æ¥æ—¶è®¾ç½®ï¼‰</li>\n</ul>\n<pre class=\"line-numbers language-mermaid\" data-language=\"mermaid\"><code class=\"language-mermaid\">sequenceDiagram\n\nparticipant c as client\nparticipant s as server\nparticipant sq as sync queue\nparticipant aq as accept queue\n\ns -&gt;&gt; s : bind()\ns -&gt;&gt; s : listen()\nc -&gt;&gt; c : connect()\nc -&gt;&gt; s : 1. SYN\nNote left of c : SYN_SEND\ns -&gt;&gt; sq : put\nNote right of s : SYN_RCVD\ns -&gt;&gt; c : 2. SYN + ACK\nNote left of c : ESTABLISHED\nc -&gt;&gt; s : 3. ACK\nsq -&gt;&gt; aq : put\nNote right of s : ESTABLISHED\naq --&gt;&gt; s : \ns -&gt;&gt; s : accept()</code></pre>\n\n<ol>\n<li>ç¬¬ä¸€æ¬¡æ¡æ‰‹ï¼Œclient å‘é€ SYN åˆ° serverï¼ŒçŠ¶æ€ä¿®æ”¹ä¸º SYN_SENDï¼Œserver æ”¶åˆ°ï¼ŒçŠ¶æ€æ”¹å˜ä¸º SYN_REVDï¼Œå¹¶å°†è¯¥è¯·æ±‚æ”¾å…¥ sync queue é˜Ÿåˆ—</li>\n<li>ç¬¬äºŒæ¬¡æ¡æ‰‹ï¼Œserver å›å¤ SYN + ACK ç»™ clientï¼Œclient æ”¶åˆ°ï¼ŒçŠ¶æ€æ”¹å˜ä¸º ESTABLISHEDï¼Œå¹¶å‘é€ ACK ç»™ server</li>\n<li>ç¬¬ä¸‰æ¬¡æ¡æ‰‹ï¼Œserver æ”¶åˆ° ACKï¼ŒçŠ¶æ€æ”¹å˜ä¸º ESTABLISHEDï¼Œå°†è¯¥è¯·æ±‚ä» sync queue(åŠè¿æ¥é˜Ÿåˆ—) æ”¾å…¥ accept queue(å…¨è¿æ¥é˜Ÿåˆ—)</li>\n</ol>\n<p>å…¶ä¸­</p>\n<ul>\n<li><p>åœ¨ linux 2.2 ä¹‹å‰ï¼Œbacklog å¤§å°åŒ…æ‹¬äº†ä¸¤ä¸ªé˜Ÿåˆ—çš„å¤§å°ï¼Œåœ¨ 2.2 ä¹‹åï¼Œåˆ†åˆ«ç”¨ä¸‹é¢ä¸¤ä¸ªå‚æ•°æ¥æ§åˆ¶</p>\n</li>\n<li><p>sync queue - åŠè¿æ¥é˜Ÿåˆ—</p>\n<ul>\n<li>å¤§å°é€šè¿‡ <strong>&#x2F;proc&#x2F;sys&#x2F;net&#x2F;ipv4&#x2F;tcp_max_syn_backlog</strong> æŒ‡å®šï¼Œåœ¨ <strong><code>syncookies</code> å¯ç”¨çš„æƒ…å†µä¸‹ï¼Œé€»è¾‘ä¸Šæ²¡æœ‰æœ€å¤§å€¼é™åˆ¶ï¼Œè¿™ä¸ªè®¾ç½®ä¾¿è¢«å¿½ç•¥</strong></li>\n</ul>\n</li>\n<li><p>accept queue - å…¨è¿æ¥é˜Ÿåˆ—</p>\n<ul>\n<li>å…¶å¤§å°é€šè¿‡ <strong>&#x2F;proc&#x2F;sys&#x2F;net&#x2F;core&#x2F;somaxconn</strong> æŒ‡å®šï¼Œåœ¨ä½¿<strong>ç”¨ listen å‡½æ•°æ—¶ï¼Œå†…æ ¸ä¼šæ ¹æ®ä¼ å…¥çš„ backlog å‚æ•°ä¸ç³»ç»Ÿå‚æ•°ï¼Œå–äºŒè€…çš„è¾ƒå°å€¼</strong>      </li>\n<li>min(nioç¨‹åºä¸­bind(8080, backlog); , somaxconn)</li>\n<li>å¦‚æœ accpet queue <strong>é˜Ÿåˆ—æ»¡äº†ï¼Œserver å°†å‘é€ä¸€ä¸ªã€æ‹’ç»è¿æ¥ã€‘çš„é”™è¯¯ä¿¡æ¯åˆ° client</strong></li>\n</ul>\n</li>\n</ul>\n<p>netty ä¸­</p>\n<p>å¯ä»¥é€šè¿‡  option(ChannelOption.SO_BACKLOG, å€¼) æ¥è®¾ç½®å¤§å°  &#x2F;&#x2F; å…¨é˜Ÿåˆ—æ»¡äº†</p>\n<p>nettyå¤„ç†èƒ½åŠ›å¼ºï¼Œå¤„ç†ä¸äº†äº†æ‰ä¼šå †ç§¯åˆ°å…¨è¿æ¥é˜Ÿåˆ—é‡Œ</p>\n<p><img src=\"http://cache.itzy8.top/%E5%AD%A6Netty-%E9%BB%91%E9%A9%AC%E6%BB%A1%E5%93%A5/image-20220502112651966.png\" alt=\"image-20220502112651966\"></p>\n<p>æ‰“æ–­ç‚¹ï¼Œä¸è®©è°ƒaccept()ä»å…¨è¿æ¥é˜Ÿåˆ—é‡Œå–ï¼Œé€ æˆå †ç§¯ï¼</p>\n<p>queue&#x3D;2  debug_serverã€run3ä¸ªClientï¼ˆAllow parallel runï¼‰ï¼šæŠ¥é”™ConnectException: Connection refused</p>\n<p>å¯ä»¥é€šè¿‡ä¸‹é¢æºç æŸ¥çœ‹é»˜è®¤å¤§å°</p>\n<p>ServerSocketChannelä¸­bind()è¢«è°ƒç”¨ï¼Œbacklogè¢«èµ‹å€¼ï¼šfind usage</p>\n<p>nettyä¸­çš„ï¼ŒdoBind()ï¼šjavaChannel().bind(localAddress, config.getBacklog());</p>\n<p>ServerSocketChannelConfigï¼šCtrl_Alt_Bçœ‹å®ç°ï¼šDefaultServerSocketChannelConfig</p>\n<pre class=\"line-numbers language-java\" data-language=\"java\"><code class=\"language-java\">public class DefaultServerSocketChannelConfig extends DefaultChannelConfig\n                                              implements ServerSocketChannelConfig &#123;\n\n    private volatile int backlog &#x3D; NetUtil.SOMAXCONN;&#x2F;&#x2F;\n    &#x2F;&#x2F; ...\n&#125;\n\n\nNetUtil:\n        SOMAXCONN &#x3D; AccessController.doPrivileged(new PrivilegedAction&lt;Integer&gt;() &#123;\n            @Override\n            public Integer run() &#123;\n                &#x2F;&#x2F; Determine the default somaxconn (server socket backlog) value of the platform.\n                &#x2F;&#x2F; The known defaults:\n                &#x2F;&#x2F; - Windows NT Server 4.0+: 200\n                &#x2F;&#x2F; - Linux and Mac OS X: 128\n                int somaxconn &#x3D; PlatformDependent.isWindows() ? 200 : 128;&#x2F;&#x2F;\n                File file &#x3D; new File(&quot;&#x2F;proc&#x2F;sys&#x2F;net&#x2F;core&#x2F;somaxconn&quot;);&#x2F;&#x2F;\n                BufferedReader in &#x3D; null;\n                try &#123;\n                    &#x2F;&#x2F; file.exists() may throw a SecurityException if a SecurityManager is used, so execute it in the\n                    &#x2F;&#x2F; try &#x2F; catch block.\n                    &#x2F;&#x2F; See https:&#x2F;&#x2F;github.com&#x2F;netty&#x2F;netty&#x2F;issues&#x2F;4936\n                    if (file.exists()) &#123;\n                        in &#x3D; new BufferedReader(new FileReader(file));\n                        somaxconn &#x3D; Integer.parseInt(in.readLine());&#x2F;&#x2F;</code></pre>\n\n\n\n<p>è¯¾å ‚è°ƒè¯•å…³é”®æ–­ç‚¹ä¸ºï¼š<code>io.netty.channel.nio.NioEventLoop#processSelectedKey</code></p>\n<p>oio ä¸­æ›´å®¹æ˜“è¯´æ˜ï¼Œä¸ç”¨ debug æ¨¡å¼</p>\n<pre class=\"line-numbers language-java\" data-language=\"java\"><code class=\"language-java\">public class Server &#123;\n    public static void main(String[] args) throws IOException &#123;\n        ServerSocket ss &#x3D; new ServerSocket(8888, 2);\n        Socket accept &#x3D; ss.accept();&#x2F;&#x2F;oio accepté˜»å¡ï¼\n        System.out.println(accept);\n        System.in.read();\n    &#125;\n&#125;</code></pre>\n\n<p>å®¢æˆ·ç«¯å¯åŠ¨ 4 ä¸ª</p>\n<pre class=\"line-numbers language-java\" data-language=\"java\"><code class=\"language-java\">public class Client &#123;\n    public static void main(String[] args) throws IOException &#123;\n        try &#123;\n            Socket s &#x3D; new Socket();\n            System.out.println(new Date()+&quot; connecting...&quot;);\n            s.connect(new InetSocketAddress(&quot;localhost&quot;, 8888),1000);\n            System.out.println(new Date()+&quot; connected...&quot;);\n            s.getOutputStream().write(1);\n            System.in.read();\n        &#125; catch (IOException e) &#123;\n            System.out.println(new Date()+&quot; connecting timeout...&quot;);\n            e.printStackTrace();\n        &#125;\n    &#125;\n&#125;</code></pre>\n\n<p>ç¬¬ 1ï¼Œ2ï¼Œ3 ä¸ªå®¢æˆ·ç«¯éƒ½æ‰“å°ï¼Œä½†<strong>é™¤äº†ç¬¬ä¸€ä¸ªå¤„äº accpet å¤–ï¼Œå…¶å®ƒä¸¤ä¸ªéƒ½å¤„äº accept queue ä¸­</strong></p>\n<pre class=\"line-numbers language-java\" data-language=\"java\"><code class=\"language-java\">Tue Apr 21 20:30:28 CST 2020 connecting...\nTue Apr 21 20:30:28 CST 2020 connected...</code></pre>\n\n<p><strong>ç¬¬ 4 ä¸ªå®¢æˆ·ç«¯è¿æ¥æ—¶</strong></p>\n<pre class=\"line-numbers language-none\"><code class=\"language-none\">Tue Apr 21 20:53:58 CST 2020 connecting...\nTue Apr 21 20:53:59 CST 2020 connecting timeout...\njava.net.SocketTimeoutException: connect timed out</code></pre>\n\n\n\n\n\n<h4 id=\"3ï¼‰ulimit-n\"><a href=\"#3ï¼‰ulimit-n\" class=\"headerlink\" title=\"3ï¼‰ulimit -n\"></a>3ï¼‰ulimit -n</h4><ul>\n<li>å±äºæ“ä½œç³»ç»Ÿå‚æ•°</li>\n</ul>\n<p>ä¸€ä¸ªthreadèƒ½æ‰“å¼€çš„fd(æ–‡ä»¶æè¿°ç¬¦)çš„æœ€å¤§æ•°é‡ã€too many open fileã€‘ï¼Œé¿å…è¿›ç¨‹æ‰“å¼€çš„æ–‡ä»¶&#x2F;Socketæ•°å¤ªå¤š</p>\n<p><strong>åº”å¯¹é«˜å¹¶å‘ï¼Œä¸´æ—¶è°ƒé«˜ï¼Œå»ºè®®æ”¾åœ¨å¯åŠ¨è„šæœ¬ä¸­ï¼</strong></p>\n<h4 id=\"4ï¼‰TCP-NODELAY\"><a href=\"#4ï¼‰TCP-NODELAY\" class=\"headerlink\" title=\"4ï¼‰TCP_NODELAY\"></a>4ï¼‰TCP_NODELAY</h4><ul>\n<li><p>å±äº SocketChannal å‚æ•°</p>\n<p>falseï¼šå¼€å¯äº†Nagleï¼Œæ”’ä¸€æ‰¹å‘æœ‰å»¶è¿Ÿ\tå»ºè®®æ”¹ä¸ºtrueï¼Œç”¨childOption</p>\n</li>\n</ul>\n<h4 id=\"5ï¼‰SO-SNDBUF-amp-SO-RCVBUF-æ»‘åŠ¨çª—å£ä¸Šé™\"><a href=\"#5ï¼‰SO-SNDBUF-amp-SO-RCVBUF-æ»‘åŠ¨çª—å£ä¸Šé™\" class=\"headerlink\" title=\"5ï¼‰SO_SNDBUF &amp; SO_RCVBUF[æ»‘åŠ¨çª—å£ä¸Šé™]\"></a>5ï¼‰SO_SNDBUF &amp; SO_RCVBUF[æ»‘åŠ¨çª—å£ä¸Šé™]</h4><ul>\n<li>SO_SNDBUF å±äº SocketChannal å‚æ•°</li>\n<li>SO_RCVBUF æ—¢å¯ç”¨äº SocketChannal å‚æ•°ï¼Œä¹Ÿå¯ä»¥ç”¨äº ServerSocketChannal å‚æ•°ï¼ˆå»ºè®®è®¾ç½®åˆ° ServerSocketChannal ä¸Šï¼‰</li>\n</ul>\n<p>[memå ç”¨é«˜äº†ï¼ŒOSè‡ªåŠ¨ä¼šå°†å…¶è‡ªé€‚åº”è°ƒå°] ä¸ç”¨è°ƒï¼</p>\n<h4 id=\"6ï¼‰ALLOCATOR\"><a href=\"#6ï¼‰ALLOCATOR\" class=\"headerlink\" title=\"6ï¼‰ALLOCATOR\"></a>6ï¼‰ALLOCATOR</h4><ul>\n<li><p>å±äº SocketChannal å‚æ•°</p>\n</li>\n<li><p>ç”¨æ¥åˆ†é… ByteBufï¼Œ ctx.alloc()</p>\n</li>\n<li><p>&#96;&#96;&#96;<br>æµ‹è¯•ç±»ï¼šTestByteBuf  TestBacklogClient</p>\n<pre class=\"line-numbers language-none\"><code class=\"language-none\">\n* ctx.alloc().buffer()    PooledUnsafeDirectByteBuf\n\nChannelConfig  DefaultChannelConfig  ByteBufAllocator.DEFAULT;\n\n...ByteBufUtilï¼š\n\n&#96;&#96;&#96;java\nstatic &#123;\n        String allocType &#x3D; SystemPropertyUtil.get(\n                &quot;io.netty.allocator.type&quot;, PlatformDependent.isAndroid() ? &quot;unpooled&quot; : &quot;pooled&quot;);&#x2F;&#x2F;\n        allocType &#x3D; allocType.toLowerCase(Locale.US).trim();\n\n        ByteBufAllocator alloc;\n        if (&quot;unpooled&quot;.equals(allocType)) &#123;\n            alloc &#x3D; UnpooledByteBufAllocator.DEFAULT;&#x2F;&#x2F;DEFAULT\n            logger.debug(&quot;-Dio.netty.allocator.type: &#123;&#125;&quot;, allocType);\n   \n    public static final UnpooledByteBufAllocator DEFAULT &#x3D;\n            new UnpooledByteBufAllocator(PlatformDependent.directBufferPreferred());\n       \n            \n    public static boolean directBufferPreferred() &#123;\n        return DIRECT_BUFFER_PREFERRED;\n    &#125;\n            \nDIRECT_BUFFER_PREFERRED\n\nè¢«ä½¿ç”¨å¤„ï¼š\n&#x2F;&#x2F; We should always prefer direct buffers by default if we can use a Cleaner to release direct buffers.\nDIRECT_BUFFER_PREFERRED &#x3D; CLEANER !&#x3D; NOOP\n                          &amp;&amp; !SystemPropertyUtil.getBoolean(&quot;io.netty.noPreferDirect&quot;, false);</code></pre></li>\n</ul>\n<pre class=\"line-numbers language-none\"><code class=\"language-none\">TestByteBuf    VM option: \n-Dio.netty.allocator.type&#x3D;unpooled -Dio.netty.noPreferDirect&#x3D;true</code></pre>\n\n<p>InstrumentedUnpooledUnsafeHeapByteBuf</p>\n<h4 id=\"7ï¼‰RCVBUF-ALLOCATOR\"><a href=\"#7ï¼‰RCVBUF-ALLOCATOR\" class=\"headerlink\" title=\"7ï¼‰RCVBUF_ALLOCATOR\"></a>7ï¼‰RCVBUF_ALLOCATOR</h4><ul>\n<li>å±äº SocketChannal å‚æ•°</li>\n<li>æ§åˆ¶ netty <strong>æ¥æ”¶ç¼“å†²åŒºå¤§å°</strong></li>\n<li>è´Ÿè´£å…¥ç«™æ•°æ®çš„åˆ†é…ï¼Œ<strong>å†³å®šå…¥ç«™ç¼“å†²åŒºçš„å¤§å°ï¼ˆå¹¶å¯åŠ¨æ€è°ƒæ•´ï¼‰ï¼Œç»Ÿä¸€é‡‡ç”¨ direct ç›´æ¥å†…å­˜</strong>ï¼Œå…·ä½“æ± åŒ–è¿˜æ˜¯éæ± åŒ–ç”± ä¸Šä¸€ä¸ªå‚æ•°:6ï¼‰allocator å†³å®š</li>\n</ul>\n<p>ioæ•°æ®RWæ“ä½œï¼šç»Ÿä¸€direct</p>\n<pre class=\"line-numbers language-none\"><code class=\"language-none\">æµ‹è¯•ç±»ï¼šTestByteBuf  TestBacklogClient\n\nTestByteBuf    VM option: \n-Dio.netty.allocator.type&#x3D;unpooled -Dio.netty.noPreferDirect&#x3D;true\n\nlog.debug(&quot;receive buf &#123;&#125;&quot;, msg);&#x2F;&#x2F;\nSystem.out.println(&quot;&quot;);&#x2F;&#x2F;æ‰“æ–­ç‚¹ debug\n</code></pre>\n\n<p>Debuggerï¼šé»„è‰²åŒºåŸŸisè¯¥çº¿ç¨‹çš„å †æ ˆè°ƒç”¨é“¾</p>\n<p>Handlerã€pipelineã€æ‰¾åˆ°AbstractNioByteChannel</p>\n<pre class=\"line-numbers language-java\" data-language=\"java\"><code class=\"language-java\">byteBuf &#x3D; allocHandle.allocate(allocator);\n\nfinal ChannelPipeline pipeline &#x3D; pipeline();\n            final ByteBufAllocator allocator &#x3D; config.getAllocator();&#x2F;&#x2F;byteBufçš„åˆ†é…å™¨ï¼Œ(é)æ± åŒ–  ctrl+Alt+B:implement   ---&gt;   ByteBufAllocator.DEFAULT; è¯»VMå‚æ•°\n            final RecvByteBufAllocator.Handle allocHandle &#x3D; recvBufAllocHandle();&#x2F;&#x2F;\n\n            allocHandle.reset(config);\n\n            ByteBuf byteBuf &#x3D; null;\n            boolean close &#x3D; false;\n            try &#123;\n                do &#123;\n                    byteBuf &#x3D; allocHandle.allocate(allocator);&#x2F;&#x2F;æ˜¯RecvByteBufAllocatorçš„å†…éƒ¨ç±»ï¼Œallocateæ–¹æ³•ï¼ˆimplement MaxMessageHandleï¼‰ï¼Œå†³å®šbyteçš„å¤§å°å’Œdirect\n                    allocHandle.lastBytesRead(doReadBytes(byteBuf));</code></pre>\n\n<p>allocateæ–¹æ³•ï¼ˆimplement MaxMessageHandleï¼‰â€“&gt;DefaultMaxMessagesRecvByteBufAllocator</p>\n<pre class=\"line-numbers language-java\" data-language=\"java\"><code class=\"language-java\">@Override\npublic ByteBuf allocate(ByteBufAllocator alloc) &#123;\n    return alloc.ioBuffer(guess());&#x2F;&#x2F;ioBufå¼ºåˆ¶Direct  è¿™æ¬¡å‘é€å¤šï¼ŒByteBufåˆ†é…æ›´å¤š\n&#125;</code></pre>\n\n<p>AbstractNioByteChannelç±»ï¼š</p>\n<p>allocHandle &#x3D; recvBufAllocHandle();&#x2F;&#x2F;</p>\n<p>getRecvByteBufAllocator()â€“&gt;implement</p>\n<p>setRecvByteBufAllocator(allocator);</p>\n<p>å¤–å±‚å‡½æ•°è°ƒç”¨è€…ï¼š</p>\n<pre class=\"line-numbers language-java\" data-language=\"java\"><code class=\"language-java\">public DefaultChannelConfig(Channel channel) &#123;\n    this(channel, new AdaptiveRecvByteBufAllocator());&#x2F;&#x2F;\n&#125;\n\n    &#x2F;**\n     * Creates a new predictor with the default parameters.  With the default\n     * parameters, the expected buffer size starts from &#123;@code 1024&#125;, does not\n     * go down below &#123;@code 64&#125;, and does not go up above &#123;@code 65536&#125;.\n     *&#x2F;\n    public AdaptiveRecvByteBufAllocator() &#123;\n        this(DEFAULT_MINIMUM, DEFAULT_INITIAL, DEFAULT_MAXIMUM);&#x2F;&#x2F;64~1024~65536\n    &#125;</code></pre>\n\n\n\n<h3 id=\"1-3-x3D-x3D-å…¸å‹åº”ç”¨-RPC-æ¡†æ¶-åŸºäºèŠå¤©å®¤ChatSC-ã€è¿œç¨‹æ–¹æ³•è°ƒç”¨-åå°„ï¼šstr-gt-JavaClassã€‘-x3D-x3D\"><a href=\"#1-3-x3D-x3D-å…¸å‹åº”ç”¨-RPC-æ¡†æ¶-åŸºäºèŠå¤©å®¤ChatSC-ã€è¿œç¨‹æ–¹æ³•è°ƒç”¨-åå°„ï¼šstr-gt-JavaClassã€‘-x3D-x3D\" class=\"headerlink\" title=\"1.3 &#x3D;&#x3D;å…¸å‹åº”ç”¨-RPC æ¡†æ¶(åŸºäºèŠå¤©å®¤ChatSC)ã€è¿œç¨‹æ–¹æ³•è°ƒç”¨ åå°„ï¼šstr-&gt;JavaClassã€‘&#x3D;&#x3D;\"></a>1.3 &#x3D;&#x3D;å…¸å‹åº”ç”¨-RPC æ¡†æ¶(åŸºäºèŠå¤©å®¤ChatSC)ã€è¿œç¨‹æ–¹æ³•è°ƒç”¨ åå°„ï¼šstr-&gt;JavaClassã€‘&#x3D;&#x3D;</h3><h4 id=\"1ï¼‰å‡†å¤‡å·¥ä½œ\"><a href=\"#1ï¼‰å‡†å¤‡å·¥ä½œ\" class=\"headerlink\" title=\"1ï¼‰å‡†å¤‡å·¥ä½œ\"></a>1ï¼‰å‡†å¤‡å·¥ä½œ</h4><p>è¿™äº›ä»£ç å¯ä»¥è®¤ä¸ºæ˜¯ç°æˆçš„ï¼Œæ— éœ€ä»å¤´ç¼–å†™ç»ƒä¹ </p>\n<p>ä¸ºäº†ç®€åŒ–èµ·è§ï¼Œåœ¨åŸæ¥èŠå¤©é¡¹ç›®çš„åŸºç¡€ä¸Šæ–°å¢ Rpc è¯·æ±‚å’Œå“åº”æ¶ˆæ¯</p>\n<pre class=\"line-numbers language-java\" data-language=\"java\"><code class=\"language-java\">@Data\npublic abstract class Message implements Serializable &#123;\n\n    &#x2F;&#x2F; çœç•¥æ—§çš„ä»£ç \n\n    public static final int RPC_MESSAGE_TYPE_REQUEST &#x3D; 101;\n    public static final int  RPC_MESSAGE_TYPE_RESPONSE &#x3D; 102;\n\n    static &#123;\n        &#x2F;&#x2F; ...\n        messageClasses.put(RPC_MESSAGE_TYPE_REQUEST, RpcRequestMessage.class);\n        messageClasses.put(RPC_MESSAGE_TYPE_RESPONSE, RpcResponseMessage.class);\n    &#125;\n\n&#125;</code></pre>\n\n<p>è¯·æ±‚æ¶ˆæ¯</p>\n<pre class=\"line-numbers language-java\" data-language=\"java\"><code class=\"language-java\">@Getter\n@ToString(callSuper &#x3D; true)\npublic class RpcRequestMessage extends Message &#123;\n\n    &#x2F;**\n     * è°ƒç”¨çš„æ¥å£å…¨é™å®šåï¼ŒæœåŠ¡ç«¯æ ¹æ®å®ƒæ‰¾åˆ°å®ç°\n     *&#x2F;\n    private String interfaceName;\n    &#x2F;**\n     * è°ƒç”¨æ¥å£ä¸­çš„æ–¹æ³•å\n     *&#x2F;\n    private String methodName;\n    &#x2F;**\n     * æ–¹æ³•è¿”å›ç±»å‹\n     *&#x2F;\n    private Class&lt;?&gt; returnType;\n    &#x2F;**\n     * æ–¹æ³•å‚æ•°ç±»å‹æ•°ç»„\n     *&#x2F;\n    private Class[] parameterTypes;\n    &#x2F;**\n     * æ–¹æ³•å‚æ•°å€¼æ•°ç»„\n     *&#x2F;\n    private Object[] parameterValue;\n\n    public RpcRequestMessage(int sequenceId, String interfaceName, String methodName, Class&lt;?&gt; returnType, Class[] parameterTypes, Object[] parameterValue) &#123;\n        super.setSequenceId(sequenceId);\n        this.interfaceName &#x3D; interfaceName;\n        this.methodName &#x3D; methodName;\n        this.returnType &#x3D; returnType;\n        this.parameterTypes &#x3D; parameterTypes;\n        this.parameterValue &#x3D; parameterValue;\n    &#125;\n\n    @Override\n    public int getMessageType() &#123;\n        return RPC_MESSAGE_TYPE_REQUEST;\n    &#125;\n&#125;</code></pre>\n\n<p>å“åº”æ¶ˆæ¯</p>\n<pre class=\"line-numbers language-java\" data-language=\"java\"><code class=\"language-java\">@Data\n@ToString(callSuper &#x3D; true)\npublic class RpcResponseMessage extends Message &#123;\n    &#x2F;**\n     * è¿”å›å€¼\n     *&#x2F;\n    private Object returnValue;\n    &#x2F;**\n     * å¼‚å¸¸å€¼\n     *&#x2F;\n    private Exception exceptionValue;\n\n    @Override\n    public int getMessageType() &#123;\n        return RPC_MESSAGE_TYPE_RESPONSE;\n    &#125;\n&#125;</code></pre>\n\n<p>æœåŠ¡å™¨æ¶å­</p>\n<pre class=\"line-numbers language-java\" data-language=\"java\"><code class=\"language-java\">@Slf4j\npublic class RpcServer &#123;\n    public static void main(String[] args) &#123;\n        NioEventLoopGroup boss &#x3D; new NioEventLoopGroup();\n        NioEventLoopGroup worker &#x3D; new NioEventLoopGroup();\n        LoggingHandler LOGGING_HANDLER &#x3D; new LoggingHandler(LogLevel.DEBUG);\n        MessageCodecSharable MESSAGE_CODEC &#x3D; new MessageCodecSharable();\n        \n        &#x2F;&#x2F; rpc è¯·æ±‚æ¶ˆæ¯å¤„ç†å™¨ï¼Œå¾…å®ç°\n        RpcRequestMessageHandler RPC_HANDLER &#x3D; new RpcRequestMessageHandler();\n        try &#123;\n            ServerBootstrap serverBootstrap &#x3D; new ServerBootstrap();\n            serverBootstrap.channel(NioServerSocketChannel.class);\n            serverBootstrap.group(boss, worker);\n            serverBootstrap.childHandler(new ChannelInitializer&lt;SocketChannel&gt;() &#123;\n                @Override\n                protected void initChannel(SocketChannel ch) throws Exception &#123;\n                    ch.pipeline().addLast(new ProcotolFrameDecoder());\n                    ch.pipeline().addLast(LOGGING_HANDLER);\n                    ch.pipeline().addLast(MESSAGE_CODEC);\n                    ch.pipeline().addLast(RPC_HANDLER);\n                &#125;\n            &#125;);\n            Channel channel &#x3D; serverBootstrap.bind(8080).sync().channel();\n            channel.closeFuture().sync();\n        &#125; catch (InterruptedException e) &#123;\n            log.error(&quot;server error&quot;, e);\n        &#125; finally &#123;\n            boss.shutdownGracefully();\n            worker.shutdownGracefully();\n        &#125;\n    &#125;\n&#125;</code></pre>\n\n<p>å®¢æˆ·ç«¯æ¶å­</p>\n<pre class=\"line-numbers language-java\" data-language=\"java\"><code class=\"language-java\">public class RpcClient &#123;\n    public static void main(String[] args) &#123;\n        NioEventLoopGroup group &#x3D; new NioEventLoopGroup();\n        LoggingHandler LOGGING_HANDLER &#x3D; new LoggingHandler(LogLevel.DEBUG);\n        MessageCodecSharable MESSAGE_CODEC &#x3D; new MessageCodecSharable();\n        \n        &#x2F;&#x2F; rpc å“åº”æ¶ˆæ¯å¤„ç†å™¨ï¼Œå¾…å®ç°\n        RpcResponseMessageHandler RPC_HANDLER &#x3D; new RpcResponseMessageHandler();\n        try &#123;\n            Bootstrap bootstrap &#x3D; new Bootstrap();\n            bootstrap.channel(NioSocketChannel.class);\n            bootstrap.group(group);\n            bootstrap.handler(new ChannelInitializer&lt;SocketChannel&gt;() &#123;\n                @Override\n                protected void initChannel(SocketChannel ch) throws Exception &#123;\n                    ch.pipeline().addLast(new ProcotolFrameDecoder());\n                    ch.pipeline().addLast(LOGGING_HANDLER);\n                    ch.pipeline().addLast(MESSAGE_CODEC);\n                    ch.pipeline().addLast(RPC_HANDLER);\n                &#125;\n            &#125;);\n            Channel channel &#x3D; bootstrap.connect(&quot;localhost&quot;, 8080).sync().channel();\n            channel.closeFuture().sync();\n        &#125; catch (Exception e) &#123;\n            log.error(&quot;client error&quot;, e);\n        &#125; finally &#123;\n            group.shutdownGracefully();\n        &#125;\n    &#125;\n&#125;</code></pre>\n\n<p>æœåŠ¡å™¨ç«¯çš„ service è·å–</p>\n<pre class=\"line-numbers language-java\" data-language=\"java\"><code class=\"language-java\">public class ServicesFactory &#123;\n\n    static Properties properties;\n    static Map&lt;Class&lt;?&gt;, Object&gt; map &#x3D; new ConcurrentHashMap&lt;&gt;();\n\n    static &#123;\n        try (InputStream in &#x3D; Config.class.getResourceAsStream(&quot;&#x2F;application.properties&quot;)) &#123;\n            properties &#x3D; new Properties();\n            properties.load(in);\n            Set&lt;String&gt; names &#x3D; properties.stringPropertyNames();\n            for (String name : names) &#123;\n                if (name.endsWith(&quot;Service&quot;)) &#123;\n                    Class&lt;?&gt; interfaceClass &#x3D; Class.forName(name);\n                    Class&lt;?&gt; instanceClass &#x3D; Class.forName(properties.getProperty(name));\n                    map.put(interfaceClass, instanceClass.newInstance());\n                &#125;\n            &#125;\n        &#125; catch (IOException | ClassNotFoundException | InstantiationException | IllegalAccessException e) &#123;\n            throw new ExceptionInInitializerError(e);\n        &#125;\n    &#125;\n\n    public static &lt;T&gt; T getService(Class&lt;T&gt; interfaceClass) &#123;\n        return (T) map.get(interfaceClass);\n    &#125;\n&#125;</code></pre>\n\n<p>ç›¸å…³é…ç½® application.properties</p>\n<pre class=\"line-numbers language-none\"><code class=\"language-none\">serializer.algorithm&#x3D;Json\ncn.itcast.server.service.HelloService&#x3D;cn.itcast.server.service.HelloServiceImpl</code></pre>\n\n\n\n<h4 id=\"ï¼2ï¼‰æœåŠ¡å™¨-handler\"><a href=\"#ï¼2ï¼‰æœåŠ¡å™¨-handler\" class=\"headerlink\" title=\"ï¼2ï¼‰æœåŠ¡å™¨ handler\"></a>ï¼2ï¼‰æœåŠ¡å™¨ handler</h4><pre class=\"line-numbers language-java\" data-language=\"java\"><code class=\"language-java\">@Slf4j\n@ChannelHandler.Sharable\npublic class RpcRequestMessageHandler extends SimpleChannelInboundHandler&lt;RpcRequestMessage&gt; &#123;\n\n    @Override\n    protected void channelRead0(ChannelHandlerContext ctx, RpcRequestMessage message) &#123;\n        RpcResponseMessage response &#x3D; new RpcResponseMessage();\n        response.setSequenceId(message.getSequenceId());&#x2F;&#x2F;\n        try &#123;\n            &#x2F;&#x2F; è·å–çœŸæ­£çš„å®ç°å¯¹è±¡\n            HelloService service &#x3D; (HelloService)\n                    ServicesFactory.getService(Class.forName(message.getInterfaceName()));\n            \n            &#x2F;&#x2F; è·å–è¦è°ƒç”¨çš„æ–¹æ³•\n            Method method &#x3D; service.getClass().getMethod(message.getMethodName(), message.getParameterTypes());\n            \n            &#x2F;&#x2F; è°ƒç”¨æ–¹æ³•\n            Object invoke &#x3D; method.invoke(service, message.getParameterValue());\n            &#x2F;&#x2F; è°ƒç”¨æˆåŠŸ\n            response.setReturnValue(invoke);&#x2F;&#x2F;\n        &#125; catch (Exception e) &#123;\n            e.printStackTrace();\n            &#x2F;&#x2F; è°ƒç”¨å¼‚å¸¸\n            response.setExceptionValue(e);&#x2F;&#x2F;\n        &#125;\n        &#x2F;&#x2F; è¿”å›ç»“æœ\n        ctx.writeAndFlush(response);&#x2F;&#x2F;\n    &#125;\n    &#x2F;*\n    public static void main(String[] args) throws ClassNotFoundException, NoSuchMethodException, InvocationTargetException, IllegalAccessException &#123;\n        RpcRequestMessage message &#x3D; new RpcRequestMessage(\n                1,\n                &quot;cn.itcast.server.service.HelloService&quot;,\n                &quot;sayHello&quot;,\n                String.class,\n                new Class[]&#123;String.class&#125;,\n                new Object[]&#123;&quot;å¼ ä¸‰&quot;&#125;\n        );\n        HelloService service &#x3D; (HelloService)\n                ServicesFactory.getService(Class.forName(message.getInterfaceName()));\n        Method method &#x3D; service.getClass().getMethod(message.getMethodName(), message.getParameterTypes());\n        Object invoke &#x3D; method.invoke(service, message.getParameterValue());\n        System.out.println(invoke);\n    &#125;*&#x2F;\n&#125;</code></pre>\n\n\n\n\n\n<h4 id=\"3ï¼‰å®¢æˆ·ç«¯ä»£ç ç¬¬ä¸€ç‰ˆã€å†™æ­»msgå¯¹è±¡ï¼è‡ªå®šä¹‰å¤„ç†Handlerï¼è‡ªå·±è½¬æ¢å°è£…objã€‘\"><a href=\"#3ï¼‰å®¢æˆ·ç«¯ä»£ç ç¬¬ä¸€ç‰ˆã€å†™æ­»msgå¯¹è±¡ï¼è‡ªå®šä¹‰å¤„ç†Handlerï¼è‡ªå·±è½¬æ¢å°è£…objã€‘\" class=\"headerlink\" title=\"3ï¼‰å®¢æˆ·ç«¯ä»£ç ç¬¬ä¸€ç‰ˆã€å†™æ­»msgå¯¹è±¡ï¼è‡ªå®šä¹‰å¤„ç†Handlerï¼è‡ªå·±è½¬æ¢å°è£…objã€‘\"></a>3ï¼‰å®¢æˆ·ç«¯ä»£ç ç¬¬ä¸€ç‰ˆã€å†™æ­»msgå¯¹è±¡ï¼è‡ªå®šä¹‰å¤„ç†Handlerï¼è‡ªå·±è½¬æ¢å°è£…objã€‘</h4><p>åªå‘æ¶ˆæ¯ Cï¼šchannel å‘ä¸Šå‡ºç«™-&gt;Sï¼šå‘ä¸‹å…¥ç«™ RpcReqMsgHandlerã€æ¥å£-å®ç°obj-åå°„è°ƒç”¨ã€‘ ret-resp S-&gt;C RpcRespMsgHandler_log.debug</p>\n<pre class=\"line-numbers language-java\" data-language=\"java\"><code class=\"language-java\">@Slf4j\npublic class RpcClient &#123;\n    public static void main(String[] args) &#123;\n        NioEventLoopGroup group &#x3D; new NioEventLoopGroup();\n        LoggingHandler LOGGING_HANDLER &#x3D; new LoggingHandler(LogLevel.DEBUG);\n        MessageCodecSharable MESSAGE_CODEC &#x3D; new MessageCodecSharable();\n        RpcResponseMessageHandler RPC_HANDLER &#x3D; new RpcResponseMessageHandler();\n        try &#123;\n            Bootstrap bootstrap &#x3D; new Bootstrap();\n            bootstrap.channel(NioSocketChannel.class);\n            bootstrap.group(group);\n            bootstrap.handler(new ChannelInitializer&lt;SocketChannel&gt;() &#123;\n                @Override\n                protected void initChannel(SocketChannel ch) throws Exception &#123;\n                    ch.pipeline().addLast(new ProcotolFrameDecoder());\n                    ch.pipeline().addLast(LOGGING_HANDLER);\n                    ch.pipeline().addLast(MESSAGE_CODEC);\n                    ch.pipeline().addLast(RPC_HANDLER);\n                &#125;\n            &#125;);\n            Channel channel &#x3D; bootstrap.connect(&quot;localhost&quot;, 8080).sync().channel();&#x2F;&#x2F;\n            &#x2F;&#x2F;channelé‡Œæ‰‹å†™msgï¼šwriteAndFlushå¼‚æ­¥æ‰§è¡Œï¼ŒæˆåŠŸè¿˜æ˜¯å¤±è´¥ï¼Œçœ‹è¿”å›å€¼futureã€‚å¼‚æ­¥addListener\n            ChannelFuture future &#x3D; channel.writeAndFlush(new RpcRequestMessage(\n                    1,\n                    &quot;cn.itcast.server.service.HelloService&quot;,\n                    &quot;sayHello&quot;,\n                    String.class,\n                    new Class[]&#123;String.class&#125;,\n                    new Object[]&#123;&quot;å¼ ä¸‰&quot;&#125;\n            )).addListener(promise -&gt; &#123;\n                if (!promise.isSuccess()) &#123;&#x2F;&#x2F;\n                    Throwable cause &#x3D; promise.cause();&#x2F;&#x2F;\n                    log.error(&quot;error&quot;, cause);\n                &#125;\n            &#125;);\n\n            channel.closeFuture().sync();&#x2F;&#x2F;é˜»å¡ï¼ï¼ï¼å¾…æ”¹ï¼ï¼ï¼\n        &#125; catch (Exception e) &#123;\n            log.error(&quot;client error&quot;, e);\n        &#125; finally &#123;\n            group.shutdownGracefully();\n        &#125;\n    &#125;\n&#125;</code></pre>\n\n\n\n<h4 id=\"4ï¼‰å®¢æˆ·ç«¯-handler-ç¬¬ä¸€ç‰ˆ\"><a href=\"#4ï¼‰å®¢æˆ·ç«¯-handler-ç¬¬ä¸€ç‰ˆ\" class=\"headerlink\" title=\"4ï¼‰å®¢æˆ·ç«¯ handler ç¬¬ä¸€ç‰ˆ\"></a>4ï¼‰å®¢æˆ·ç«¯ handler ç¬¬ä¸€ç‰ˆ</h4><pre class=\"line-numbers language-java\" data-language=\"java\"><code class=\"language-java\">@Slf4j\n@ChannelHandler.Sharable\npublic class RpcResponseMessageHandler extends SimpleChannelInboundHandler&lt;RpcResponseMessage&gt; &#123;\n    @Override\n    protected void channelRead0(ChannelHandlerContext ctx, RpcResponseMessage msg) throws Exception &#123;\n        log.debug(&quot;&#123;&#125;&quot;, msg);\n    &#125;\n&#125;</code></pre>\n\n<p>run RpcServerã€RpcClient</p>\n<p>ç°è±¡ï¼šactiveåï¼Œä¸logï¼Œä¸æŠ¥é”™</p>\n<p>future &#x3D; channel.writeAndFlush</p>\n<p>.addListener(logï¼špromise.cause();)</p>\n<p>æ‰“å°å¼‚å¸¸ä¿¡æ¯ï¼šUnsupportedException</p>\n<p><img src=\"http://cache.itzy8.top/%E5%AD%A6Netty-%E9%BB%91%E9%A9%AC%E6%BB%A1%E5%93%A5/image-20220505131057909.png\" alt=\"image-20220505131057909\"></p>\n<p>ä¿®å¤Gsonçš„Java.Classç±»å‹-&gt;Jsonå­—ç¬¦ä¸² çš„ä¸æ”¯æŒæŠ¥é”™ï¼šregisterTypeAdapter</p>\n<pre class=\"line-numbers language-java\" data-language=\"java\"><code class=\"language-java\">public class TestGson &#123;\n    public static void main(String[] args) &#123;\n        Gson gson &#x3D; new GsonBuilder().registerTypeAdapter(Class.class, new Serializer.ClassCodec()).create();&#x2F;&#x2F;é‡æ„Serializerï¼ï¼ï¼\n        System.out.println(gson.toJson(String.class));&#x2F;&#x2F;classç±»å‹-&gt;toJson\n        &#x2F;&#x2F;System.out.println(new Gson().toJson(String.class));&#x2F;&#x2F;classç±»å‹-&gt;toJson UnsupportedException!\n    &#125;\n&#125;\n\n\n\n\nprotocolåŒ…ï¼š\n&#x2F;**\n * ç”¨äºæ‰©å±•åºåˆ—åŒ–ã€ååºåˆ—åŒ–ç®—æ³•\n *&#x2F;\npublic interface Serializer &#123;\n\n    &#x2F;&#x2F; ååºåˆ—åŒ–æ–¹æ³•\n    &lt;T&gt; T deserialize(Class&lt;T&gt; clazz, byte[] bytes);\n\n    &#x2F;&#x2F; åºåˆ—åŒ–æ–¹æ³•\n    &lt;T&gt; byte[] serialize(T object);\n\n    enum Algorithm implements Serializer &#123;\n\n        Java &#123;\n            @Override\n            public &lt;T&gt; T deserialize(Class&lt;T&gt; clazz, byte[] bytes) &#123;\n                try &#123;\n                    ObjectInputStream ois &#x3D; new ObjectInputStream(new ByteArrayInputStream(bytes));&#x2F;&#x2F;ois-bis-byte[]\n                    return (T) ois.readObject();&#x2F;&#x2F;(T)\n                &#125; catch (IOException | ClassNotFoundException e) &#123;&#x2F;&#x2F;|\n                    throw new RuntimeException(&quot;ååºåˆ—åŒ–å¤±è´¥&quot;, e);\n                &#125;\n            &#125;\n\n            @Override\n            public &lt;T&gt; byte[] serialize(T object) &#123;\n                try &#123;\n                    ByteArrayOutputStream bos &#x3D; new ByteArrayOutputStream();\n                    ObjectOutputStream oos &#x3D; new ObjectOutputStream(bos);\n                    oos.writeObject(object);&#x2F;&#x2F;oos-bos-obj  bos-&gt;byte[]\n                    return bos.toByteArray();\n                &#125; catch (IOException e) &#123;\n                    throw new RuntimeException(&quot;åºåˆ—åŒ–å¤±è´¥&quot;, e);\n                &#125;\n            &#125;\n        &#125;,\n\n        Json &#123;\n            @Override\n            public &lt;T&gt; T deserialize(Class&lt;T&gt; clazz, byte[] bytes) &#123;\n                Gson gson &#x3D; new GsonBuilder().registerTypeAdapter(Class.class, new Serializer.ClassCodec()).create();&#x2F;&#x2F;+ClassCodec    registerTypeAdapter\n                String json &#x3D; new String(bytes, StandardCharsets.UTF_8);\n&#x2F;&#x2F;                return new Gson().fromJson(json, clazz);&#x2F;&#x2F;\n                return gson.fromJson(json, clazz);\n            &#125;\n\n            @Override\n            public &lt;T&gt; byte[] serialize(T object) &#123;\n                Gson gson &#x3D; new GsonBuilder().registerTypeAdapter(Class.class, new Serializer.ClassCodec()).create();&#x2F;&#x2F;+ClassCodec\n                String json &#x3D; gson.toJson(object);\n&#x2F;&#x2F;                String json &#x3D; new Gson().toJson(object);\n                return json.getBytes(StandardCharsets.UTF_8);\n            &#125;\n        &#125;\n    &#125;\n    class ClassCodec implements JsonSerializer&lt;Class&lt;?&gt;&gt;, JsonDeserializer&lt;Class&lt;?&gt;&gt; &#123;\n\n        @Override\n        public Class&lt;?&gt; deserialize(JsonElement json, Type typeOfT, JsonDeserializationContext context) throws JsonParseException &#123;&#x2F;&#x2F;\n            try &#123;\n                String str &#x3D; json.getAsString();&#x2F;&#x2F;\n                return Class.forName(str);&#x2F;&#x2F;\n            &#125; catch (ClassNotFoundException e) &#123;\n                throw new JsonParseException(e);&#x2F;&#x2F;\n            &#125;\n        &#125;\n        &#x2F;&#x2F;è‡ªå®šä¹‰ClassCodec\n        @Override             &#x2F;&#x2F;   String.classåŸºæœ¬ç±»å‹\n        public JsonElement serialize(Class&lt;?&gt; src, Type typeOfSrc, JsonSerializationContext context) &#123;\n            &#x2F;&#x2F; class -&gt; json\n            return new JsonPrimitive(src.getName());&#x2F;&#x2F;\n        &#125;\n    &#125;\n&#125;\n</code></pre>\n\n<p>é€šä¿¡okï¼</p>\n<h4 id=\"5ï¼‰å®¢æˆ·ç«¯ä»£ç -ç¬¬äºŒç‰ˆã€RpcClientManagerç‰ˆï¼šå¼‚æ­¥ç½‘ç»œç»“æœç”¨åŒæ­¥æ–¹å¼ã€‘\"><a href=\"#5ï¼‰å®¢æˆ·ç«¯ä»£ç -ç¬¬äºŒç‰ˆã€RpcClientManagerç‰ˆï¼šå¼‚æ­¥ç½‘ç»œç»“æœç”¨åŒæ­¥æ–¹å¼ã€‘\" class=\"headerlink\" title=\"5ï¼‰å®¢æˆ·ç«¯ä»£ç  ç¬¬äºŒç‰ˆã€RpcClientManagerç‰ˆï¼šå¼‚æ­¥ç½‘ç»œç»“æœç”¨åŒæ­¥æ–¹å¼ã€‘\"></a>5ï¼‰å®¢æˆ·ç«¯ä»£ç  ç¬¬äºŒç‰ˆã€RpcClientManagerç‰ˆï¼šå¼‚æ­¥ç½‘ç»œç»“æœç”¨åŒæ­¥æ–¹å¼ã€‘</h4><h4 id=\"åŒ…æ‹¬-x3D-x3D-channel-ç®¡ç†-å•ä¾‹-ï¼Œ-JDK-Proxy-ä»£ç†ï¼Œæ¥æ”¶ç»“æœ-promise-await-å¼‚æ­¥ç½‘ç»œç»“æœåŒæ­¥ç­‰å¾…ï¼Œä¸æŠ›å¼‚å¸¸-x3D-x3D\"><a href=\"#åŒ…æ‹¬-x3D-x3D-channel-ç®¡ç†-å•ä¾‹-ï¼Œ-JDK-Proxy-ä»£ç†ï¼Œæ¥æ”¶ç»“æœ-promise-await-å¼‚æ­¥ç½‘ç»œç»“æœåŒæ­¥ç­‰å¾…ï¼Œä¸æŠ›å¼‚å¸¸-x3D-x3D\" class=\"headerlink\" title=\"åŒ…æ‹¬ &#x3D;&#x3D;channel ç®¡ç†(å•ä¾‹)ï¼Œ(JDK Proxy)ä»£ç†ï¼Œæ¥æ”¶ç»“æœ(promise.await();å¼‚æ­¥ç½‘ç»œç»“æœåŒæ­¥ç­‰å¾…ï¼Œä¸æŠ›å¼‚å¸¸)&#x3D;&#x3D;\"></a>åŒ…æ‹¬ &#x3D;&#x3D;channel ç®¡ç†(å•ä¾‹)ï¼Œ(JDK Proxy)ä»£ç†ï¼Œæ¥æ”¶ç»“æœ(promise.await();å¼‚æ­¥ç½‘ç»œç»“æœåŒæ­¥ç­‰å¾…ï¼Œä¸æŠ›å¼‚å¸¸)&#x3D;&#x3D;</h4><pre class=\"line-numbers language-java\" data-language=\"java\"><code class=\"language-java\">protocolåŒ…ï¼š\npublic abstract class SequenceIdGenerator &#123;\n    private static final AtomicInteger id &#x3D; new AtomicInteger();\n\n    public static int nextId() &#123;\n        return id.incrementAndGet();\n    &#125;\n&#125;</code></pre>\n\n\n\n<p>nioçº¿ç¨‹é—´é€šä¿¡ï¼šç©ºpromiseå¯¹è±¡ç±»ä¼¼äºç©ºä¹¦åŒ…ï¼ŒClientç«¯mainTH-&gt;nioçº¿ç¨‹RespMsgHandlerï¼Œæ¥åˆ°Sç«¯å“åº”msgï¼Œè£…å…¥ä¹¦åŒ…-&gt;mainTHæ‹¿å‡º</p>\n<p>promiseæ˜¯ä¸ªå®¹å™¨ï¼Œç”¨æ¥åœ¨å¤šTHsé—´äº¤æ¢ç»“æœ</p>\n<pre class=\"line-numbers language-java\" data-language=\"java\"><code class=\"language-java\">@Slf4j\npublic class RpcClientManager &#123;\n\n    public static void main(String[] args) &#123;\n        HelloService service &#x3D; getProxyService(HelloService.class);&#x2F;&#x2F;ä»£ç†å¯¹è±¡\n        System.out.println(service.sayHello(&quot;zhangsan&quot;));\n&#x2F;&#x2F;        System.out.println(service.sayHello(&quot;lisi&quot;));\n&#x2F;&#x2F;        System.out.println(service.sayHello(&quot;wangwu&quot;));\n\n    &#125;\n\n    &#x2F;&#x2F;åˆ›å»ºä»£ç†ç±»ï¼šå°†ç”¨æˆ·çš„æ–¹æ³•è°ƒç”¨è½¬æ¢æˆåº•å±‚æ¶ˆæ¯å‘é€ï¼Œå±è”½ç»†èŠ‚ï¼\n    public static &lt;T&gt; T getProxyService(Class&lt;T&gt; serviceClass) &#123;\n        &#x2F;&#x2F;JDK Proxy:å®ç°æ¥å£\n        ClassLoader loader &#x3D; serviceClass.getClassLoader();\n        Class&lt;?&gt;[] interfaces &#x3D; new Class[]&#123;serviceClass&#125;;\n        &#x2F;&#x2F;                                                           sayHello &quot;å¼ ä¸‰&quot;\n        Object o &#x3D; Proxy.newProxyInstance(loader, interfaces, (proxy, method, args) -&gt; &#123;\n            &#x2F;&#x2F; 1.å°†æ–¹æ³•è°ƒç”¨è½¬æ¢ä¸º æ¶ˆæ¯å¯¹è±¡\n            int sequenceId &#x3D; SequenceIdGenerator.nextId();&#x2F;&#x2F;ï¼ï¼ï¼\n            RpcRequestMessage msg &#x3D; new RpcRequestMessage(\n                    sequenceId,\n                    serviceClass.getName(),\n                    method.getName(),\n                    method.getReturnType(),\n                    method.getParameterTypes(),\n                    args\n            );\n            &#x2F;&#x2F; 2.å°†æ¶ˆæ¯å¯¹è±¡å‘é€å‡ºå»\n            getChannel().writeAndFlush(msg);\n\n            &#x2F;&#x2F; 3.å‡†å¤‡ä¸€ä¸ªç©º Promise å¯¹è±¡ï¼Œæ¥æ¥æ”¶ç»“æœ                   æŒ‡å®šPromiseå¯¹è±¡ã€å¼‚æ­¥ã€‘æ¥æ”¶ç»“æœçš„çº¿ç¨‹\n            DefaultPromise&lt;Object&gt; promise &#x3D; new DefaultPromise&lt;&gt;(getChannel().eventLoop());&#x2F;&#x2F;çˆ¶æ¥å£æ˜¯EventExecutorï¼Œå†…æœ‰TH\n            RpcResponseMessageHandler.PROMISES.put(sequenceId, promise);\n\n&#x2F;&#x2F;            promise.addListener(future -&gt; &#123;\n&#x2F;&#x2F;                &#x2F;&#x2F;TH:Promiseå¯¹è±¡å¼‚æ­¥æ¥æ”¶ç»“æœçš„çº¿ç¨‹\n&#x2F;&#x2F;            &#125;);\n\n            &#x2F;&#x2F; 4.mainTHç­‰å¾… promise ç»“æœ\n            promise.await();&#x2F;&#x2F;ç›¸æ¯”sync(),await()ä¸ä¼šæŠ›å¼‚å¸¸,isSuccess()è‡ªå·±æ£€æŸ¥ï¼\n            if(promise.isSuccess()) &#123;\n                &#x2F;&#x2F; è°ƒç”¨æ­£å¸¸\n                return promise.getNow();\n            &#125; else &#123;\n                &#x2F;&#x2F; è°ƒç”¨å¤±è´¥\n                throw new RuntimeException(promise.cause());\n            &#125;\n        &#125;);\n        return (T)o;&#x2F;&#x2F;\n    &#125;\n\n\n    private static Channel channel &#x3D; null;\n    private static final Object LOCK &#x3D; new Object();\n\n    &#x2F;&#x2F; è·å–å”¯ä¸€çš„ channel å¯¹è±¡\n    public static Channel getChannel() &#123;&#x2F;&#x2F;DCLå•ä¾‹\n        if(channel !&#x3D; null) &#123;\n            return channel;\n        &#125;\n        synchronized (LOCK) &#123;&#x2F;&#x2F;é«˜æ•ˆ\n            if(channel !&#x3D; null) &#123; &#x2F;&#x2F;only one\n                return channel;\n            &#125;\n            initChannel();\n            return channel;\n        &#125;\n    &#125;\n\n    &#x2F;&#x2F; åˆå§‹åŒ– channel æ–¹æ³•\n    private static void initChannel() &#123;\n        NioEventLoopGroup group &#x3D; new NioEventLoopGroup();\n        LoggingHandler LOGGING_HANDLER &#x3D; new LoggingHandler(LogLevel.DEBUG);\n        MessageCodecSharable MESSAGE_CODEC &#x3D; new MessageCodecSharable();\n        RpcResponseMessageHandler RPC_HANDLER &#x3D; new RpcResponseMessageHandler();\n        Bootstrap bootstrap &#x3D; new Bootstrap();\n        bootstrap.channel(NioSocketChannel.class);\n        bootstrap.group(group);\n        bootstrap.handler(new ChannelInitializer&lt;SocketChannel&gt;() &#123;\n            @Override\n            protected void initChannel(SocketChannel ch) throws Exception &#123;\n                ch.pipeline().addLast(new ProcotolFrameDecoder());\n                ch.pipeline().addLast(LOGGING_HANDLER);\n                ch.pipeline().addLast(MESSAGE_CODEC);\n                ch.pipeline().addLast(RPC_HANDLER);\n            &#125;\n        &#125;);\n        try &#123;\n            channel &#x3D; bootstrap.connect(&quot;localhost&quot;, 8080).sync().channel();&#x2F;&#x2F;é˜»å¡ç­‰channelè¿æ¥å»ºç«‹å¥½äº†ï¼Œæ‰å¯ç”¨\n            channel.closeFuture().addListener(future -&gt; &#123;&#x2F;&#x2F;æ”¹å¼‚æ­¥ï¼šå¦åˆ™getChannel()ä¸€ç›´é˜»å¡,ç­‰å…³é—­\n                group.shutdownGracefully();\n            &#125;);\n        &#125; catch (Exception e) &#123;\n            log.error(&quot;client error&quot;, e);\n        &#125;\n    &#125;\n\n&#125;</code></pre>\n\n<p><img src=\"http://cache.itzy8.top/%E5%AD%A6Netty-%E9%BB%91%E9%A9%AC%E6%BB%A1%E5%93%A5/image-20220505164858588.png\" alt=\"image-20220505164858588\"></p>\n<h4 id=\"6ï¼‰å®¢æˆ·ç«¯-handler-ç¬¬äºŒç‰ˆ\"><a href=\"#6ï¼‰å®¢æˆ·ç«¯-handler-ç¬¬äºŒç‰ˆ\" class=\"headerlink\" title=\"6ï¼‰å®¢æˆ·ç«¯ handler ç¬¬äºŒç‰ˆ\"></a>6ï¼‰å®¢æˆ·ç«¯ handler ç¬¬äºŒç‰ˆ</h4><pre class=\"line-numbers language-java\" data-language=\"java\"><code class=\"language-java\">@Slf4j\n@ChannelHandler.Sharable\npublic class RpcResponseMessageHandler extends SimpleChannelInboundHandler&lt;RpcResponseMessage&gt; &#123;\n\n    &#x2F;&#x2F;@Sharable:éœ€è¦è‡ªå·±ä¿è¯çº¿ç¨‹å®‰å…¨ [å¤šæ¬¡è®°å½•promises]æœ‰çŠ¶æ€ï¼šConcurrentHashMapä¸”å•æ­¥æ“ä½œï¼OKï¼\n    &#x2F;&#x2F;                       åºå·id      ç”¨æ¥æ¥æ”¶ç»“æœçš„ promise å¯¹è±¡\n    public static final Map&lt;Integer, Promise&lt;Object&gt;&gt; PROMISES &#x3D; new ConcurrentHashMap&lt;&gt;();\n\n    @Override\n\n    protected void channelRead0(ChannelHandlerContext ctx, RpcResponseMessage msg) throws Exception &#123;\n        log.debug(&quot;&#123;&#125;&quot;, msg);\n        &#x2F;&#x2F; æ‹¿åˆ°ç©ºçš„ promise\n        Promise&lt;Object&gt; promise &#x3D; PROMISES.remove(msg.getSequenceId());&#x2F;&#x2F;&lt;Object&gt; removeç”¨è¿‡å³å¼ƒï¼\n        if (promise !&#x3D; null) &#123;\n            Object returnValue &#x3D; msg.getReturnValue();\n            Exception exceptionValue &#x3D; msg.getExceptionValue();\n            if(exceptionValue !&#x3D; null) &#123;\n                promise.setFailure(exceptionValue);&#x2F;&#x2F;&lt;?&gt;åªèƒ½getï¼Œä¸èƒ½set ä¾‹å¤–ï¼šset(null)\n            &#125; else &#123;\n                promise.setSuccess(returnValue);\n            &#125;\n        &#125;\n    &#125;\n&#125;</code></pre>\n\n<p>&#x3D;&#x3D;&lt;?&gt;æ³›å‹é€šé…ç¬¦ï¼šåªèƒ½getå–ï¼Œä¸èƒ½setè®¾ç½®ï¼ï¼ï¼åº”æ”¹ä¸º<Object>ï¼Œä¸è¿‡set(null)æ˜¯ä¾‹å¤–&#x3D;&#x3D;</p>\n<h4 id=\"Clientç«¯-å¼‚å¸¸è°ƒç”¨\"><a href=\"#Clientç«¯-å¼‚å¸¸è°ƒç”¨\" class=\"headerlink\" title=\"Clientç«¯-å¼‚å¸¸è°ƒç”¨\"></a>Clientç«¯-å¼‚å¸¸è°ƒç”¨</h4><pre class=\"line-numbers language-java\" data-language=\"java\"><code class=\"language-java\">package cn.itcast.server.service;\n\npublic class HelloServiceImpl implements HelloService &#123;\n    @Override\n    public String sayHello(String msg) &#123;\n        int i &#x3D; 1 &#x2F; 0;&#x2F;&#x2F;\n        return &quot;ä½ å¥½, &quot; + msg;\n    &#125;\n&#125;</code></pre>\n\n<p>RpcClientManagerï¼šæŠ¥é”™ æŠ¥é”™å¸§å¤ªé•¿äº†ã€å†—ä½™ä¿¡æ¯è¿‡å¤šã€‘</p>\n<p><img src=\"http://cache.itzy8.top/%E5%AD%A6Netty-%E9%BB%91%E9%A9%AC%E6%BB%A1%E5%93%A5/image-20220505183238887.png\" alt=\"image-20220505183238887\"></p>\n<p>RpcServer</p>\n<pre class=\"line-numbers language-java\" data-language=\"java\"><code class=\"language-java\">java.lang.reflect.InvocationTargetException\n\tat cn.itcast.server.handler.RpcRequestMessageHandler.channelRead0(RpcRequestMessageHandler.java:27)\n\t...\n\tCaused by: java.lang.ArithmeticException: &#x2F; by zero\n\tat cn.itcast.server.service.HelloServiceImpl.sayHello(HelloServiceImpl.java:6)\n\t\n\t\næ”¹RpcRequestMessageHandler:\n\t            Object invoke &#x3D; method.invoke(service, message.getParameterValue());\n            response.setReturnValue(invoke);&#x2F;&#x2F;\n        &#125; catch (Exception e) &#123;\n            e.printStackTrace();\n            &#x2F;&#x2F;response.setExceptionValue(e);\n            String msg &#x3D; e.getCause().getMessage();&#x2F;&#x2F;\n            response.setExceptionValue(new Exception(&quot;è¿œç¨‹è°ƒç”¨å‡ºé”™:&quot; + msg));\n        &#125;</code></pre>\n\n<p>RpcClientManager:</p>\n<p>Exception in thread â€œmainâ€ java.lang.RuntimeException: java.lang.Exception: è¿œç¨‹è°ƒç”¨å‡ºé”™:&#x2F; by zero</p>\n<h2 id=\"2-æºç åˆ†æ-ä¾§é‡nettyæ‰§è¡Œæµç¨‹\"><a href=\"#2-æºç åˆ†æ-ä¾§é‡nettyæ‰§è¡Œæµç¨‹\" class=\"headerlink\" title=\"2. æºç åˆ†æ [ä¾§é‡nettyæ‰§è¡Œæµç¨‹]\"></a>2. æºç åˆ†æ [ä¾§é‡nettyæ‰§è¡Œæµç¨‹]</h2><h3 id=\"2-1-å¯åŠ¨å‰–æ\"><a href=\"#2-1-å¯åŠ¨å‰–æ\" class=\"headerlink\" title=\"2.1 å¯åŠ¨å‰–æ\"></a>2.1 å¯åŠ¨å‰–æ</h3><p>æˆ‘ä»¬å°±æ¥çœ‹çœ‹ netty ä¸­å¯¹ä¸‹é¢çš„ä»£ç æ˜¯æ€æ ·è¿›è¡Œå¤„ç†çš„</p>\n<pre class=\"line-numbers language-java\" data-language=\"java\"><code class=\"language-java\">&#x2F;&#x2F;1 netty ä¸­ä½¿ç”¨ NioEventLoopGroup ï¼ˆç®€ç§° nio boss çº¿ç¨‹ï¼‰æ¥å°è£…çº¿ç¨‹å’Œ selector\nSelector selector &#x3D; Selector.open(); \n\n&#x2F;&#x2F;2 åˆ›å»º NioServerSocketChannelï¼ŒåŒæ—¶ä¼šåˆå§‹åŒ–å®ƒå…³è”çš„ handlerï¼Œä»¥åŠä¸ºåŸç”Ÿ ssc å­˜å‚¨ config\nNioServerSocketChannel attachment &#x3D; new NioServerSocketChannel();\n\n&#x2F;&#x2F;3 åˆ›å»º NioServerSocketChannel æ—¶ï¼Œåˆ›å»ºäº† java åŸç”Ÿçš„ ServerSocketChannel\nServerSocketChannel serverSocketChannel &#x3D; ServerSocketChannel.open(); \nserverSocketChannel.configureBlocking(false);\n\n&#x2F;&#x2F;4 å¯åŠ¨ nio boss çº¿ç¨‹æ‰§è¡Œæ¥ä¸‹æ¥çš„æ“ä½œ\n\n&#x2F;&#x2F;5 æ³¨å†Œï¼ˆä»…å…³è” selector å’Œ NioServerSocketChannelï¼‰ï¼Œæœªå…³æ³¨äº‹ä»¶\nSelectionKey selectionKey &#x3D; serverSocketChannel.register(selector, 0, attachment);\n\n&#x2F;&#x2F;6 head -&gt; åˆå§‹åŒ–å™¨ -&gt; ServerBootstrapAcceptor -&gt; tailï¼Œåˆå§‹åŒ–å™¨æ˜¯ä¸€æ¬¡æ€§çš„ï¼Œåªä¸ºæ·»åŠ  acceptor\n\n&#x2F;&#x2F;7 ç»‘å®šç«¯å£\nserverSocketChannel.bind(new InetSocketAddress(8080));\n\n&#x2F;&#x2F;8 è§¦å‘ channel active äº‹ä»¶ï¼Œåœ¨ head ä¸­å…³æ³¨ op_accept äº‹ä»¶\nselectionKey.interestOps(SelectionKey.OP_ACCEPT);</code></pre>\n\n\n\n<p><img src=\"http://cache.itzy8.top/%E5%AD%A6Netty-%E9%BB%91%E9%A9%AC%E6%BB%A1%E5%93%A5/image-20220505190005899.png\" alt=\"image-20220505190005899\"></p>\n<p>testä¸‹sourceï¼š</p>\n<pre class=\"line-numbers language-java\" data-language=\"java\"><code class=\"language-java\">public class TestSourceServer &#123;\n    public static void main(String[] args) &#123;\n        new ServerBootstrap()\n                .group(new NioEventLoopGroup())&#x2F;&#x2F;selectorï¼šç›‘å¬äº‹ä»¶ã€å•thæ‰§è¡Œå™¨ï¼šäº‹ä»¶å¤„ç†&amp;æ‰§è¡Œå¼‚æ­¥(å®šæ—¶)ä»»åŠ¡\n                .channel(NioServerSocketChannel.class)\n                .childHandler(new ChannelInitializer&lt;NioSocketChannel&gt;() &#123;\n                    @Override\n                    protected void initChannel(NioSocketChannel ch) &#123;\n                        ch.pipeline().addLast(new LoggingHandler());\n                    &#125;\n                &#125;).bind(8080);&#x2F;&#x2F;æ‰“æ–­ç‚¹\n    &#125;\n&#125;\n</code></pre>\n\n<p>debug</p>\n<p><img src=\"http://cache.itzy8.top/%E5%AD%A6Netty-%E9%BB%91%E9%A9%AC%E6%BB%A1%E5%93%A5/image-20220505202631876.png\" alt=\"image-20220505202631876\"></p>\n<p>ã€initï¼šssc.open(); |  register: selectionKey &#x3D; ssc.register(selector,0,nettySsc)ï¼›| dobindï¼š8080ã€‘</p>\n<p>å…¥å£ <code>io.netty.bootstrap.ServerBootstrap#bind</code></p>\n<p>å…³é”®ä»£ç  <code>io.netty.bootstrap.AbstractBootstrap#doBind</code></p>\n<pre class=\"line-numbers language-java\" data-language=\"java\"><code class=\"language-java\">private ChannelFuture doBind(final SocketAddress localAddress) &#123;\n\t&#x2F;&#x2F; 1. æ‰§è¡Œåˆå§‹åŒ–å’Œæ³¨å†Œ regFuture ä¼šç”± initAndRegister è®¾ç½®å…¶æ˜¯å¦å®Œæˆï¼Œä»è€Œå›è°ƒ 3.2 å¤„ä»£ç \n    final ChannelFuture regFuture &#x3D; initAndRegister();\n    final Channel channel &#x3D; regFuture.channel();\n    if (regFuture.cause() !&#x3D; null) &#123;\n        return regFuture;\n    &#125;\n\n    &#x2F;&#x2F; 2. å› ä¸ºæ˜¯ initAndRegister å¼‚æ­¥æ‰§è¡Œï¼Œéœ€è¦åˆ†ä¸¤ç§æƒ…å†µæ¥çœ‹ï¼Œè°ƒè¯•æ—¶ä¹Ÿéœ€è¦é€šè¿‡ suspend æ–­ç‚¹ç±»å‹åŠ ä»¥åŒºåˆ†\n    &#x2F;&#x2F; 2.1 å¦‚æœå·²ç»å®Œæˆ\n    if (regFuture.isDone()) &#123;\n        ChannelPromise promise &#x3D; channel.newPromise();\n        &#x2F;&#x2F; 3.1 ç«‹åˆ»è°ƒç”¨ doBind0\n        doBind0(regFuture, channel, localAddress, promise);\n        return promise;\n    &#125; \n    &#x2F;&#x2F; 2.2 è¿˜æ²¡æœ‰å®Œæˆ\n    else &#123;\n        final PendingRegistrationPromise promise &#x3D; new PendingRegistrationPromise(channel);\n        &#x2F;&#x2F; 3.2 å›è°ƒ doBind0\n        regFuture.addListener(new ChannelFutureListener() &#123;\n            @Override\n            public void operationComplete(ChannelFuture future) throws Exception &#123;\n                Throwable cause &#x3D; future.cause();\n                if (cause !&#x3D; null) &#123;\n                    &#x2F;&#x2F; å¤„ç†å¼‚å¸¸...\n                    promise.setFailure(cause);\n                &#125; else &#123;\n                    promise.registered();\n\t\t\t\t\t&#x2F;&#x2F; 3. ç”±æ³¨å†Œçº¿ç¨‹å»æ‰§è¡Œ doBind0\n                    doBind0(regFuture, channel, localAddress, promise);\n                &#125;\n            &#125;\n        &#125;);\n        return promise;\n    &#125;\n&#125;</code></pre>\n\n<p>å…³é”®ä»£ç  <code>io.netty.bootstrap.AbstractBootstrap#initAndRegister</code></p>\n<pre class=\"line-numbers language-java\" data-language=\"java\"><code class=\"language-java\">final ChannelFuture initAndRegister() &#123;\n    Channel channel &#x3D; null;\n    try &#123;\n        &#x2F;&#x2F;constructor:æœNioServerSocketChannel()-&gt; this(newSocket(DEFAULT_SELECTOR_PROVIDER));-&gt; return provider.openServerSocketChannel();&lt;-åŸç”ŸServerSocketChannel.open()\n        channel &#x3D; channelFactory.newChannel();\n        &#x2F;&#x2F; 1.1 åˆå§‹åŒ– - åšçš„äº‹å°±æ˜¯æ·»åŠ ä¸€ä¸ªåˆå§‹åŒ–å™¨ ChannelInitializer\n        init(channel);\n    &#125; catch (Throwable t) &#123;\n        &#x2F;&#x2F; å¤„ç†å¼‚å¸¸...\n        return new DefaultChannelPromise(new FailedChannel(), GlobalEventExecutor.INSTANCE).setFailure(t);\n    &#125;\n\n    &#x2F;&#x2F; 1.2 æ³¨å†Œ - åšçš„äº‹å°±æ˜¯å°†åŸç”Ÿ channel æ³¨å†Œåˆ° selector ä¸Š\n    ChannelFuture regFuture &#x3D; config().group().register(channel);\n    if (regFuture.cause() !&#x3D; null) &#123;\n        &#x2F;&#x2F; å¤„ç†å¼‚å¸¸...\n    &#125;\n    return regFuture;\n&#125;</code></pre>\n\n<p>å…³é”®ä»£ç  <code>io.netty.bootstrap.ServerBootstrap#init</code></p>\n<pre class=\"line-numbers language-java\" data-language=\"java\"><code class=\"language-java\">&#x2F;&#x2F; è¿™é‡Œ channel å®é™…ä¸Šæ˜¯ NioServerSocketChannel\nvoid init(Channel channel) throws Exception &#123;\n    final Map&lt;ChannelOption&lt;?&gt;, Object&gt; options &#x3D; options0();\n    synchronized (options) &#123;\n        setChannelOptions(channel, options, logger);\n    &#125;\n\n    final Map&lt;AttributeKey&lt;?&gt;, Object&gt; attrs &#x3D; attrs0();\n    synchronized (attrs) &#123;\n        for (Entry&lt;AttributeKey&lt;?&gt;, Object&gt; e: attrs.entrySet()) &#123;\n            @SuppressWarnings(&quot;unchecked&quot;)\n            AttributeKey&lt;Object&gt; key &#x3D; (AttributeKey&lt;Object&gt;) e.getKey();\n            channel.attr(key).set(e.getValue());\n        &#125;\n    &#125;\n\n    ChannelPipeline p &#x3D; channel.pipeline();\n\n    final EventLoopGroup currentChildGroup &#x3D; childGroup;\n    final ChannelHandler currentChildHandler &#x3D; childHandler;\n    final Entry&lt;ChannelOption&lt;?&gt;, Object&gt;[] currentChildOptions;\n    final Entry&lt;AttributeKey&lt;?&gt;, Object&gt;[] currentChildAttrs;\n    synchronized (childOptions) &#123;\n        currentChildOptions &#x3D; childOptions.entrySet().toArray(newOptionArray(0));\n    &#125;\n    synchronized (childAttrs) &#123;\n        currentChildAttrs &#x3D; childAttrs.entrySet().toArray(newAttrArray(0));\n    &#125;\n\t\n    &#x2F;&#x2F; ä¸º NioServerSocketChannel æ·»åŠ åˆå§‹åŒ–å™¨\n    p.addLast(new ChannelInitializer&lt;Channel&gt;() &#123;\n        @Override\n        public void initChannel(final Channel ch) throws Exception &#123;&#x2F;&#x2F;1.2.2:registeråçœŸæ­£è°ƒç”¨\n            final ChannelPipeline pipeline &#x3D; ch.pipeline();\n            ChannelHandler handler &#x3D; config.handler();\n            if (handler !&#x3D; null) &#123;\n                pipeline.addLast(handler);\n            &#125;\n\n            &#x2F;&#x2F; åˆå§‹åŒ–å™¨çš„èŒè´£æ˜¯å°† ServerBootstrapAcceptor handler(åœ¨acceptäº‹ä»¶å‘ç”Ÿåå»ºç«‹è¿æ¥) åŠ å…¥è‡³ NioServerSocketChannel\n            ch.eventLoop().execute(new Runnable() &#123;\n                @Override\n                public void run() &#123;\n                    pipeline.addLast(new ServerBootstrapAcceptor(\n                            ch, currentChildGroup, currentChildHandler, currentChildOptions, currentChildAttrs));\n                &#125;\n            &#125;);\n        &#125;\n    &#125;);\n&#125;</code></pre>\n\n<p><img src=\"http://cache.itzy8.top/%E5%AD%A6Netty-%E9%BB%91%E9%A9%AC%E6%BB%A1%E5%93%A5/image-20220505205144375.png\" alt=\"image-20220505205144375\"></p>\n<p>å…³é”®ä»£ç  <code>io.netty.channel.AbstractChannel.AbstractUnsafe#register</code></p>\n<pre class=\"line-numbers language-java\" data-language=\"java\"><code class=\"language-java\">public final void register(EventLoop eventLoop, final ChannelPromise promise) &#123;\n    &#x2F;&#x2F; ä¸€äº›æ£€æŸ¥ï¼Œç•¥...\n\n    AbstractChannel.this.eventLoop &#x3D; eventLoop;\n\n    if (eventLoop.inEventLoop()) &#123;&#x2F;&#x2F;æ˜¯mainä¸æ˜¯nioTHï¼Œèµ°elseï¼\n        register0(promise);\n    &#125; else &#123;\n        try &#123;\n            &#x2F;&#x2F; é¦–æ¬¡æ‰§è¡Œ execute æ–¹æ³•æ—¶ï¼Œä¼šå¯åŠ¨ nio çº¿ç¨‹ï¼ˆæ‡’åŠ è½½~ï¼‰ï¼Œä¹‹åæ³¨å†Œç­‰æ“ä½œåœ¨ nio çº¿ç¨‹ä¸Šæ‰§è¡Œ\n            &#x2F;&#x2F; å› ä¸ºåªæœ‰ä¸€ä¸ª NioServerSocketChannel å› æ­¤ï¼Œä¹Ÿåªä¼šæœ‰ä¸€ä¸ª boss nio çº¿ç¨‹\n            &#x2F;&#x2F; è¿™è¡Œä»£ç å®Œæˆçš„äº‹å®æ˜¯ main -&gt; nio boss çº¿ç¨‹çš„åˆ‡æ¢\n            eventLoop.execute(new Runnable() &#123;\n                @Override\n                public void run() &#123;\n                    register0(promise);&#x2F;&#x2F;\n                &#125;\n            &#125;);\n        &#125; catch (Throwable t) &#123;\n            &#x2F;&#x2F; æ—¥å¿—è®°å½•...\n            closeForcibly();\n            closeFuture.setClosed();\n            safeSetFailure(promise, t);\n        &#125;\n    &#125;\n&#125;</code></pre>\n\n\n\n<p><code>io.netty.channel.AbstractChannel.AbstractUnsafe#register0</code></p>\n<pre class=\"line-numbers language-java\" data-language=\"java\"><code class=\"language-java\">private void register0(ChannelPromise promise) &#123;\n    try &#123;\n        if (!promise.setUncancellable() || !ensureOpen(promise)) &#123;\n            return;\n        &#125;\n        boolean firstRegistration &#x3D; neverRegistered;\n        &#x2F;&#x2F; 1.2.1 åŸç”Ÿçš„ nio channel ç»‘å®šåˆ° selector ä¸Šï¼Œæ³¨æ„æ­¤æ—¶æ²¡æœ‰æ³¨å†Œ selector å…³æ³¨äº‹ä»¶ï¼Œé™„ä»¶ä¸º NioServerSocketChannel\n        doRegister();&#x2F;&#x2F;selectionKey &#x3D; javaChannel().register(eventLoop().unwrappedSelector(), 0, this);\n        neverRegistered &#x3D; false;\n        registered &#x3D; true;\n\n        &#x2F;&#x2F; 1.2.2 [çœŸæ­£è°ƒç”¨]æ‰§è¡Œ NioServerSocketChannel åˆå§‹åŒ–å™¨çš„ [initChannel]\n        pipeline.invokeHandlerAddedIfNeeded();\n\n        &#x2F;&#x2F; å›è°ƒ 3.2 io.netty.bootstrap.AbstractBootstrap#doBind0\n        safeSetSuccess(promise);&#x2F;&#x2F;å‘ã€åŒä¸€ä¸ªã€‘promiseé‡Œå¡«ç»“æœï¼\n        pipeline.fireChannelRegistered();\n        \n        &#x2F;&#x2F; å¯¹åº” server socket channel è¿˜æœªç»‘å®šï¼ŒisActive ä¸º false\n        if (isActive()) &#123;\n            if (firstRegistration) &#123;\n                pipeline.fireChannelActive();\n            &#125; else if (config().isAutoRead()) &#123;\n                beginRead();\n            &#125;\n        &#125;\n    &#125; catch (Throwable t) &#123;\n        &#x2F;&#x2F; Close the channel directly to avoid FD leak.\n        closeForcibly();\n        closeFuture.setClosed();\n        safeSetFailure(promise, t);\n    &#125;\n&#125;</code></pre>\n\n<p><img src=\"http://cache.itzy8.top/%E5%AD%A6Netty-%E9%BB%91%E9%A9%AC%E6%BB%A1%E5%93%A5/image-20220505210646539.png\" alt=\"image-20220505210646539\"></p>\n<p>&#x2F;&#x2F; åˆå§‹åŒ–å™¨çš„èŒè´£æ˜¯å°† ServerBootstrapAcceptor handler(åœ¨acceptäº‹ä»¶å‘ç”Ÿåå»ºç«‹è¿æ¥) åŠ å…¥è‡³ NioServerSocketChannel</p>\n<p><img src=\"http://cache.itzy8.top/%E5%AD%A6Netty-%E9%BB%91%E9%A9%AC%E6%BB%A1%E5%93%A5/image-20220505211236724.png\" alt=\"image-20220505211236724\"></p>\n<p><img src=\"http://cache.itzy8.top/%E5%AD%A6Netty-%E9%BB%91%E9%A9%AC%E6%BB%A1%E5%93%A5/image-20220505212344302.png\" alt=\"image-20220505212344302\"></p>\n<p>æ–­ç‚¹å³é”®Allã€F9ï¼š Mark objectï¼šregFuture@1837</p>\n<p><img src=\"http://cache.itzy8.top/%E5%AD%A6Netty-%E9%BB%91%E9%A9%AC%E6%BB%A1%E5%93%A5/image-20220505212607163.png\" alt=\"image-20220505212607163\"></p>\n<p><img src=\"http://cache.itzy8.top/%E5%AD%A6Netty-%E9%BB%91%E9%A9%AC%E6%BB%A1%E5%93%A5/image-20220505213040038.png\" alt=\"image-20220505213040038\"></p>\n<p>F9ï¼šoperationCompleteå†… doBind0</p>\n<p>ã€‚ã€‚ã€‚</p>\n<p><img src=\"http://cache.itzy8.top/%E5%AD%A6Netty-%E9%BB%91%E9%A9%AC%E6%BB%A1%E5%93%A5/image-20220505214038700.png\" alt=\"image-20220505214038700\"></p>\n<p><img src=\"http://cache.itzy8.top/%E5%AD%A6Netty-%E9%BB%91%E9%A9%AC%E6%BB%A1%E5%93%A5/image-20220505213952627.png\" alt=\"image-20220505213952627\"></p>\n<p>å…³é”®ä»£ç  <code>io.netty.channel.ChannelInitializer#initChannel</code></p>\n<pre class=\"line-numbers language-java\" data-language=\"java\"><code class=\"language-java\">private boolean initChannel(ChannelHandlerContext ctx) throws Exception &#123;\n    if (initMap.add(ctx)) &#123; &#x2F;&#x2F; Guard against re-entrance.\n        try &#123;\n            &#x2F;&#x2F; 1.2.2.1 æ‰§è¡Œåˆå§‹åŒ–\n            initChannel((C) ctx.channel());\n        &#125; catch (Throwable cause) &#123;\n            exceptionCaught(ctx, cause);\n        &#125; finally &#123;\n            &#x2F;&#x2F; 1.2.2.2 ç§»é™¤åˆå§‹åŒ–å™¨\n            ChannelPipeline pipeline &#x3D; ctx.pipeline();\n            if (pipeline.context(this) !&#x3D; null) &#123;\n                pipeline.remove(this);\n            &#125;\n        &#125;\n        return true;\n    &#125;\n    return false;\n&#125;</code></pre>\n\n\n\n<p>å…³é”®ä»£ç  <code>io.netty.bootstrap.AbstractBootstrap#doBind0</code></p>\n<pre class=\"line-numbers language-java\" data-language=\"java\"><code class=\"language-java\">&#x2F;&#x2F; 3.1 æˆ– 3.2 æ‰§è¡Œ doBind0\nprivate static void doBind0(\n        final ChannelFuture regFuture, final Channel channel,\n        final SocketAddress localAddress, final ChannelPromise promise) &#123;\n\n    channel.eventLoop().execute(new Runnable() &#123;\n        @Override\n        public void run() &#123;\n            if (regFuture.isSuccess()) &#123;\n                channel.bind(localAddress, promise).addListener(ChannelFutureListener.CLOSE_ON_FAILURE);\n            &#125; else &#123;\n                promise.setFailure(regFuture.cause());\n            &#125;\n        &#125;\n    &#125;);\n&#125;</code></pre>\n\n<p>å…³é”®ä»£ç  <code>io.netty.channel.AbstractChannel.AbstractUnsafe#bind</code></p>\n<pre class=\"line-numbers language-java\" data-language=\"java\"><code class=\"language-java\">public final void bind(final SocketAddress localAddress, final ChannelPromise promise) &#123;\n    assertEventLoop();\n\n    if (!promise.setUncancellable() || !ensureOpen(promise)) &#123;\n        return;\n    &#125;\n\n    if (Boolean.TRUE.equals(config().getOption(ChannelOption.SO_BROADCAST)) &amp;&amp;\n        localAddress instanceof InetSocketAddress &amp;&amp;\n        !((InetSocketAddress) localAddress).getAddress().isAnyLocalAddress() &amp;&amp;\n        !PlatformDependent.isWindows() &amp;&amp; !PlatformDependent.maybeSuperUser()) &#123;\n        &#x2F;&#x2F; è®°å½•æ—¥å¿—...\n    &#125;\n\n    boolean wasActive &#x3D; isActive();\n    try &#123;\n        &#x2F;&#x2F; 3.3 æ‰§è¡Œç«¯å£ç»‘å®š\n        doBind(localAddress);\n    &#125; catch (Throwable t) &#123;\n        safeSetFailure(promise, t);\n        closeIfClosed();\n        return;\n    &#125;\n\n    if (!wasActive &amp;&amp; isActive()) &#123;\n        invokeLater(new Runnable() &#123;\n            @Override\n            public void run() &#123;\n                &#x2F;&#x2F; 3.4 è§¦å‘ active äº‹ä»¶\n                pipeline.fireChannelActive();&#x2F;&#x2F;[head]-&gt;Acceptor-&gt;tail\n            &#125;\n        &#125;);\n    &#125;\n\n    safeSetSuccess(promise);\n&#125;</code></pre>\n\n<p>3.3 å…³é”®ä»£ç  <code>io.netty.channel.socket.nio.NioServerSocketChannel#doBind</code></p>\n<pre class=\"line-numbers language-java\" data-language=\"java\"><code class=\"language-java\">protected void doBind(SocketAddress localAddress) throws Exception &#123;\n    if (PlatformDependent.javaVersion() &gt;&#x3D; 7) &#123;\n        javaChannel().bind(localAddress, config.getBacklog());&#x2F;&#x2F;\n    &#125; else &#123;\n        javaChannel().socket().bind(localAddress, config.getBacklog());\n    &#125;\n&#125;</code></pre>\n\n\n\n\n\n<p>3.4 å…³é”®ä»£ç  <code>io.netty.channel.DefaultChannelPipeline.HeadContext#channelActive</code></p>\n<p>æ‰“æ–­ç‚¹ï¼F9</p>\n<pre class=\"line-numbers language-java\" data-language=\"java\"><code class=\"language-java\">public void channelActive(ChannelHandlerContext ctx) &#123;\n    ctx.fireChannelActive();\n\t&#x2F;&#x2F; è§¦å‘ read (NioServerSocketChannel ä¸Šçš„ read ä¸æ˜¯è¯»å–æ•°æ®ï¼Œåªæ˜¯ä¸ºäº†è§¦å‘ channel çš„äº‹ä»¶æ³¨å†Œ)\n    readIfIsAutoRead();&#x2F;&#x2F;ã€selectionKey.interestOps(SelectionKey.OP_ACCEPT&#x3D;1&lt;&lt;&lt;4&#x3D;16)ã€‘\n&#125;</code></pre>\n\n<p>F7ã€‚ã€‚ã€‚</p>\n<p>å…³é”®ä»£ç  <code>io.netty.channel.nio.AbstractNioChannel#doBeginRead</code></p>\n<pre class=\"line-numbers language-java\" data-language=\"java\"><code class=\"language-java\">protected void doBeginRead() throws Exception &#123;\n    &#x2F;&#x2F; Channel.read() or ChannelHandlerContext.read() was called\n    final SelectionKey selectionKey &#x3D; this.selectionKey;\n    if (!selectionKey.isValid()) &#123;\n        return;\n    &#125;\n\n    readPending &#x3D; true;\n\n    final int interestOps &#x3D; selectionKey.interestOps();\n    &#x2F;&#x2F; readInterestOp å–å€¼æ˜¯ 16ï¼Œåœ¨ NioServerSocketChannel åˆ›å»ºæ—¶åˆå§‹åŒ–å¥½ï¼Œä»£è¡¨å…³æ³¨ accept äº‹ä»¶\n    if ((interestOps &amp; readInterestOp) &#x3D;&#x3D; 0) &#123;\n        selectionKey.interestOps(interestOps | readInterestOp);\n    &#125;\n&#125;</code></pre>\n\n<p><img src=\"http://cache.itzy8.top/%E5%AD%A6Netty-%E9%BB%91%E9%A9%AC%E6%BB%A1%E5%93%A5/image-20220505215312463.png\" alt=\"image-20220505215312463\"></p>\n<h3 id=\"2-2-NioEventLoop-å‰–æ-é‡é‡çº§-900-lines\"><a href=\"#2-2-NioEventLoop-å‰–æ-é‡é‡çº§-900-lines\" class=\"headerlink\" title=\"2.2 NioEventLoop å‰–æ[é‡é‡çº§ 900+lines]\"></a>2.2 NioEventLoop å‰–æ[é‡é‡çº§ 900+lines]</h3><p><img src=\"http://cache.itzy8.top/%E5%AD%A6Netty-%E9%BB%91%E9%A9%AC%E6%BB%A1%E5%93%A5/image-20220505215603229.png\" alt=\"image-20220505215603229\"></p>\n<p>æœ¬ç±»selectorã€ç¥–çˆ¶ç±»ã€æ›¾ç¥–çˆ¶ç±»scheduledTaskQueue</p>\n<p><img src=\"http://cache.itzy8.top/%E5%AD%A6Netty-%E9%BB%91%E9%A9%AC%E6%BB%A1%E5%93%A5/image-20220506161150036.png\" alt=\"image-20220506161150036\"></p>\n<p>æ„é€ é‡Œåˆ›å»ºselectorï¼šfinal SelectorTuple selectorTuple &#x3D; openSelector();</p>\n<p><img src=\"http://cache.itzy8.top/%E5%AD%A6Netty-%E9%BB%91%E9%A9%AC%E6%BB%A1%E5%93%A5/image-20220506161600716.png\" alt=\"image-20220506161600716\"></p>\n<p>7.SelectedKeysä¼˜åŒ–ï¼š</p>\n<p>åŸç”ŸunwrappedSelectorä¸­çš„SelectionKeysé›†åˆåº•å±‚åŸºäºHashSetï¼ˆHashè¡¨ï¼‰æ‹‰é“¾æ³•éå†æ•ˆç‡ä¸é«˜ï¼Œä»ä¿ç•™ã€‚</p>\n<p>æ¢ä¸ºSelectorï¼Œå…¶ä¸­çš„SelectionKeysåº•å±‚åŸºäºæ•°ç»„ï¼Œéå†æ•ˆç‡é«˜ï¼éå†keyæ—¶ç”¨ï¼ï¼ï¼</p>\n<p><img src=\"http://cache.itzy8.top/%E5%AD%A6Netty-%E9%BB%91%E9%A9%AC%E6%BB%A1%E5%93%A5/image-20220506162616596.png\" alt=\"image-20220506162616596\"></p>\n<p><img src=\"http://cache.itzy8.top/%E5%AD%A6Netty-%E9%BB%91%E9%A9%AC%E6%BB%A1%E5%93%A5/image-20220506162759185.png\" alt=\"image-20220506162759185\"></p>\n<pre class=\"line-numbers language-java\" data-language=\"java\"><code class=\"language-java\">package cn.itcast.source;\n\nimport io.netty.channel.EventLoop;\nimport io.netty.channel.nio.NioEventLoopGroup;\n\npublic class TestEventLoop &#123;\n    public static void main(String[] args) &#123;\n        EventLoop eventLoop &#x3D; new NioEventLoopGroup().next();\n        eventLoop.execute(()-&gt;&#123;&#x2F;&#x2F;æ–­ç‚¹ debug\n            System.out.println(&quot;hello&quot;);\n        &#125;);\n    &#125;\n&#125;\n</code></pre>\n\n\n\n<p>NioEventLoop çº¿ç¨‹ä¸ä»…è¦å¤„ç† IO äº‹ä»¶ï¼Œè¿˜è¦å¤„ç† Taskï¼ˆåŒ…æ‹¬æ™®é€šä»»åŠ¡å’Œå®šæ—¶ä»»åŠ¡ï¼‰ï¼Œ</p>\n<p>æäº¤ä»»åŠ¡ä»£ç  <code>io.netty.util.concurrent.SingleThreadEventExecutor#execute</code></p>\n<pre class=\"line-numbers language-java\" data-language=\"java\"><code class=\"language-java\">public void execute(Runnable task) &#123;\n    if (task &#x3D;&#x3D; null) &#123;\n        throw new NullPointerException(&quot;task&quot;);\n    &#125;\n\n    boolean inEventLoop &#x3D; inEventLoop();&#x2F;&#x2F;\n    &#x2F;&#x2F; æ·»åŠ ä»»åŠ¡ï¼Œå…¶ä¸­é˜Ÿåˆ—ä½¿ç”¨äº† jctools æä¾›çš„ mpsc æ— é”é˜Ÿåˆ—\n    addTask(task);\n    if (!inEventLoop) &#123;\n        &#x2F;&#x2F; inEventLoop å¦‚æœä¸º false è¡¨ç¤ºç”±å…¶å®ƒçº¿ç¨‹æ¥è°ƒç”¨ executeï¼Œå³é¦–æ¬¡è°ƒç”¨ï¼Œè¿™æ—¶éœ€è¦å‘ eventLoop æäº¤é¦–ä¸ªä»»åŠ¡ï¼Œå¯åŠ¨æ­»å¾ªç¯ï¼Œä¼šæ‰§è¡Œåˆ°ä¸‹é¢çš„ doStartThread\n        startThread();\n        if (isShutdown()) &#123;\n            &#x2F;&#x2F; å¦‚æœå·²ç» shutdownï¼Œåšæ‹’ç»é€»è¾‘ï¼Œä»£ç ç•¥...\n        &#125;\n    &#125;\n\n    if (!addTaskWakesUp &amp;&amp; wakesUpForTask(task)) &#123;\n        &#x2F;&#x2F; å¦‚æœçº¿ç¨‹ç”±äº IO select é˜»å¡äº†ï¼Œæ·»åŠ çš„ä»»åŠ¡çš„çº¿ç¨‹éœ€è¦è´Ÿè´£å”¤é†’ NioEventLoop çº¿ç¨‹\n        wakeup(inEventLoop);\n    &#125;\n&#125;</code></pre>\n\n<p><img src=\"http://cache.itzy8.top/%E5%AD%A6Netty-%E9%BB%91%E9%A9%AC%E6%BB%A1%E5%93%A5/image-20220506163236905.png\" alt=\"image-20220506163236905\"></p>\n<p><img src=\"http://cache.itzy8.top/%E5%AD%A6Netty-%E9%BB%91%E9%A9%AC%E6%BB%A1%E5%93%A5/image-20220506164224177.png\" alt=\"image-20220506164224177\"></p>\n<p>private volatile int state &#x3D; ST_NOT_STARTED;</p>\n<p><img src=\"http://cache.itzy8.top/%E5%AD%A6Netty-%E9%BB%91%E9%A9%AC%E6%BB%A1%E5%93%A5/image-20220506164251139.png\" alt=\"image-20220506164251139\"></p>\n<p>doStartThread()çš„run()æ­»å¾ªç¯é‡Œï¼š</p>\n<p>select()ï¼š</p>\n<pre class=\"line-numbers language-java\" data-language=\"java\"><code class=\"language-java\">int selectedKeys &#x3D; selector.select(timeoutMillis);&#x2F;&#x2F;æœ‰è¶…æ—¶çš„é˜»å¡ï¼Œä¸€æ—¦æœ‰ä»»åŠ¡å°±å”¤é†’wakeup()</code></pre>\n\n<p>å”¤é†’ select é˜»å¡çº¿ç¨‹<code>io.netty.channel.nio.NioEventLoop#wakeup</code></p>\n<pre class=\"line-numbers language-java\" data-language=\"java\"><code class=\"language-java\">@Override\nprotected void wakeup(boolean inEventLoop) &#123;\n    if (!inEventLoop &amp;&amp; wakenUp.compareAndSet(false, true)) &#123;&#x2F;&#x2F;\n        selector.wakeup();&#x2F;&#x2F;\n    &#125;\n&#125;</code></pre>\n\n<pre class=\"line-numbers language-java\" data-language=\"java\"><code class=\"language-java\">private final AtomicBoolean wakenUp &#x3D; new AtomicBoolean();</code></pre>\n\n<p><img src=\"http://cache.itzy8.top/%E5%AD%A6Netty-%E9%BB%91%E9%A9%AC%E6%BB%A1%E5%93%A5/image-20220506170128464.png\" alt=\"image-20220506170128464\"></p>\n<p>æ²¡äº‹ä»¶æ²¡ä»»åŠ¡ï¼Œåº”è¯¥è¿›selecté˜»å¡ä¸€ä¼šå„¿ï¼Œåˆ«ç©ºè½¬ï¼</p>\n<p>å¯åŠ¨ EventLoop ä¸»å¾ªç¯ <code>io.netty.util.concurrent.SingleThreadEventExecutor#doStartThread</code></p>\n<pre class=\"line-numbers language-java\" data-language=\"java\"><code class=\"language-java\">private void doStartThread() &#123;\n    assert thread &#x3D;&#x3D; null;\n    executor.execute(new Runnable() &#123;\n        @Override\n        public void run() &#123;\n            &#x2F;&#x2F; å°†çº¿ç¨‹æ± çš„å½“å‰çº¿ç¨‹ä¿å­˜åœ¨æˆå‘˜å˜é‡ä¸­ï¼Œä»¥ä¾¿åç»­ä½¿ç”¨\n            thread &#x3D; Thread.currentThread();\n            if (interrupted) &#123;\n                thread.interrupt();\n            &#125;\n\n            boolean success &#x3D; false;\n            updateLastExecutionTime();\n            try &#123;\n                &#x2F;&#x2F; è°ƒç”¨å¤–éƒ¨ç±» SingleThreadEventExecutor çš„ [run æ–¹æ³•ï¼Œè¿›å…¥æ­»å¾ªç¯]ï¼Œrun æ–¹æ³•è§ä¸‹\n                SingleThreadEventExecutor.this.run();\n                success &#x3D; true;\n            &#125; catch (Throwable t) &#123;\n                logger.warn(&quot;Unexpected exception from an event executor: &quot;, t);\n            &#125; finally &#123;\n\t\t\t\t&#x2F;&#x2F; æ¸…ç†å·¥ä½œï¼Œä»£ç ç•¥...\n            &#125;\n        &#125;\n    &#125;);\n&#125;</code></pre>\n\n<p><img src=\"http://cache.itzy8.top/%E5%AD%A6Netty-%E9%BB%91%E9%A9%AC%E6%BB%A1%E5%93%A5/image-20220506184156309.png\" alt=\"image-20220506184156309\"></p>\n<p><img src=\"http://cache.itzy8.top/%E5%AD%A6Netty-%E9%BB%91%E9%A9%AC%E6%BB%A1%E5%93%A5/image-20220506184246479.png\" alt=\"image-20220506184246479\"></p>\n<p><img src=\"http://cache.itzy8.top/%E5%AD%A6Netty-%E9%BB%91%E9%A9%AC%E6%BB%A1%E5%93%A5/image-20220506171019252.png\" alt=\"image-20220506171019252\"></p>\n<p><code>io.netty.channel.nio.NioEventLoop#run</code> ä¸»è¦ä»»åŠ¡æ˜¯æ‰§è¡Œæ­»å¾ªç¯ï¼Œä¸æ–­çœ‹æœ‰æ²¡æœ‰æ–°ä»»åŠ¡ï¼Œæœ‰æ²¡æœ‰ IO äº‹ä»¶</p>\n<pre class=\"line-numbers language-java\" data-language=\"java\"><code class=\"language-java\">protected void run() &#123;\n    for (;;) &#123;\n        try &#123;\n            try &#123;\n                &#x2F;&#x2F; calculateStrategy çš„é€»è¾‘å¦‚ä¸‹ï¼š\n                &#x2F;&#x2F; æœ‰ä»»åŠ¡ï¼Œä¼šæ‰§è¡Œä¸€æ¬¡ selectNowï¼Œæ¸…é™¤ä¸Šä¸€æ¬¡çš„ wakeup ç»“æœï¼Œæ— è®ºæœ‰æ²¡æœ‰ IO äº‹ä»¶ï¼Œéƒ½ä¼šè·³è¿‡ switch\n                &#x2F;&#x2F; æ²¡æœ‰ä»»åŠ¡ï¼Œä¼šåŒ¹é… SelectStrategy.SELECTï¼Œçœ‹æ˜¯å¦åº”å½“é˜»å¡\n                switch (selectStrategy.calculateStrategy(selectNowSupplier, hasTasks())) &#123;\n                    case SelectStrategy.CONTINUE:\n                        continue;\n\n                    case SelectStrategy.BUSY_WAIT:\n\n                    case SelectStrategy.SELECT:\n                        &#x2F;&#x2F; å› ä¸º IO çº¿ç¨‹å’Œæäº¤ä»»åŠ¡çº¿ç¨‹éƒ½æœ‰å¯èƒ½æ‰§è¡Œ wakeupï¼Œè€Œ wakeup å±äºæ¯”è¾ƒæ˜‚è´µçš„æ“ä½œï¼Œå› æ­¤ä½¿ç”¨äº†ä¸€ä¸ªåŸå­å¸ƒå°”å¯¹è±¡ wakenUpï¼Œå®ƒå–å€¼ä¸º true æ—¶ï¼Œè¡¨ç¤ºè¯¥ç”±å½“å‰çº¿ç¨‹å”¤é†’\n                        &#x2F;&#x2F; è¿›è¡Œ select é˜»å¡ï¼Œå¹¶è®¾ç½®å”¤é†’çŠ¶æ€ä¸º false\n                        boolean oldWakenUp &#x3D; wakenUp.getAndSet(false);\n                        \n                        &#x2F;&#x2F; å¦‚æœåœ¨è¿™ä¸ªä½ç½®ï¼Œé EventLoop çº¿ç¨‹æŠ¢å…ˆå°† wakenUp ç½®ä¸º trueï¼Œå¹¶ wakeup\n                        &#x2F;&#x2F; ä¸‹é¢çš„ select æ–¹æ³•ä¸ä¼šé˜»å¡\n                        &#x2F;&#x2F; ç­‰ runAllTasks å¤„ç†å®Œæˆåï¼Œåˆ°å†å¾ªç¯è¿›æ¥è¿™ä¸ªé˜¶æ®µæ–°å¢çš„ä»»åŠ¡ä¼šä¸ä¼šåŠæ—¶æ‰§è¡Œå‘¢?\n                        &#x2F;&#x2F; å› ä¸º oldWakenUp ä¸º trueï¼Œå› æ­¤ä¸‹é¢çš„ select æ–¹æ³•å°±ä¼šé˜»å¡ï¼Œç›´åˆ°è¶…æ—¶\n                        &#x2F;&#x2F; æ‰èƒ½æ‰§è¡Œï¼Œè®© select æ–¹æ³• æ— è°“é˜»å¡ï¼Ÿ\n                        select(oldWakenUp);\n\n                        if (wakenUp.get()) &#123;\n                            selector.wakeup();\n                        &#125;\n                    default:\n                &#125;\n            &#125; catch (IOException e) &#123;\n                rebuildSelector0();\n                handleLoopException(e);\n                continue;\n            &#125;\n\n            cancelledKeys &#x3D; 0;\n            needsToSelectAgain &#x3D; false;\n            &#x2F;&#x2F; ioRatio é»˜è®¤æ˜¯ 50\n            final int ioRatio &#x3D; this.ioRatio;\n            if (ioRatio &#x3D;&#x3D; 100) &#123;\n                try &#123;\n                    processSelectedKeys();&#x2F;&#x2F;å¤„ç†ioäº‹ä»¶ï¼ï¼ï¼7.keys[i] 8.åŒºåˆ†äº‹ä»¶ç±»å‹ unsafe.read()!\n                &#125; finally &#123;\n                    &#x2F;&#x2F; ã€ioRatio ä¸º 100ã€‘ æ—¶ï¼Œã€æ€»æ˜¯è¿è¡Œå®Œæ‰€æœ‰ï¼ã€‘ã€é IO ä»»åŠ¡ã€‘\n                    runAllTasks();&#x2F;&#x2F;å¹¶ä¸å¥½ï¼finallyï¼Œä¸è¶…æ—¶ï¼\n                &#125;\n            &#125; else &#123;                \n                final long ioStartTime &#x3D; System.nanoTime();\n                try &#123;\n                    processSelectedKeys();&#x2F;&#x2F;\n                &#125; finally &#123;\n                    &#x2F;&#x2F; è®°å½• ã€io äº‹ä»¶å¤„ç†ã€‘è€—æ—¶\n                    final long ioTime &#x3D; System.nanoTime() - ioStartTime;\n                    &#x2F;&#x2F; è¿è¡Œé IO ä»»åŠ¡ï¼Œä¸€æ—¦è¶…æ—¶ä¼šé€€å‡º runAllTasks,ä¸‹ä¸€æ¬¡å¾ªç¯ ã€æ™®é€šä»»åŠ¡ï¼ã€‘\n                    &#x2F;&#x2F; ioæ—¶é—´*(éio)&#x2F;(io)&#x3D;éioä»»åŠ¡è¶…æ—¶æ—¶é—´:8s*20&#x2F;80&#x3D;2s\n                    runAllTasks(ioTime * (100 - ioRatio) &#x2F; ioRatio);\n                &#125;\n            &#125;\n        &#125; catch (Throwable t) &#123;\n            handleLoopException(t);\n        &#125;\n        try &#123;\n            if (isShuttingDown()) &#123;\n                closeAll();\n                if (confirmShutdown()) &#123;\n                    return;\n                &#125;\n            &#125;\n        &#125; catch (Throwable t) &#123;\n            handleLoopException(t);\n        &#125;\n    &#125;\n&#125;</code></pre>\n\n<p><img src=\"http://cache.itzy8.top/%E5%AD%A6Netty-%E9%BB%91%E9%A9%AC%E6%BB%A1%E5%93%A5/image-20220506193501592.png\" alt=\"image-20220506193501592\"></p>\n<h4 id=\"âš ï¸-æ³¨æ„\"><a href=\"#âš ï¸-æ³¨æ„\" class=\"headerlink\" title=\"âš ï¸ æ³¨æ„\"></a>âš ï¸ æ³¨æ„</h4><blockquote><span class=\"custom-blockquote-svg\"><svg width=\"24\" height=\"24\" viewBox=\"0 0 24 24\" fill=\"\" xmlns=\"http://www.w3.org/2000/svg\" data-reactroot=\"\">\n<path fill=\"\" d=\"M22 12C22 6.5 17.5 2 12 2C6.5 2 2 6.5 2 12C2 17.5 6.5 22 12 22C13.8 22 15.5 21.5 17 20.6L22 22L20.7 17C21.5 15.5 22 13.8 22 12Z\" undefined=\"1\"></path>\n<path fill=\"\" d=\"M15.97 11.5H16.04C17.12 11.5 18 12.38 18 13.47V13.53C18 14.62 17.12 15.5 16.03 15.5H15.96C14.88 15.5 14 14.62 14 13.53V13.46C14 12.38 14.88 11.5 15.97 11.5Z\" undefined=\"1\"></path>\n<path fill=\"\" d=\"M7.97 11.5H8.04C9.12 11.5 10 12.38 10 13.47V13.53C10 14.62 9.12 15.5 8.03 15.5H7.97C6.88 15.5 6 14.62 6 13.53V13.46C6 12.38 6.88 11.5 7.97 11.5Z\" undefined=\"1\"></path>\n<path stroke-linejoin=\"round\" stroke-linecap=\"round\" stroke-miterlimit=\"10\" stroke-width=\"2\" stroke=\"\" d=\"M17 8.5C15.23 8.97 14.07 10.84 14.01 13.27C14 13.33 14 13.4 14 13.47V13.5\"></path>\n<path stroke-linejoin=\"round\" stroke-linecap=\"round\" stroke-miterlimit=\"10\" stroke-width=\"2\" stroke=\"\" d=\"M9 8.5C7.23 8.97 6.07 10.84 6.01 13.27C6 13.33 6 13.4 6 13.47V13.5\"></path>\n<path stroke-linejoin=\"round\" stroke-linecap=\"round\" stroke-miterlimit=\"10\" stroke-width=\"2\" stroke=\"\" d=\"M15.97 11.5H16.04C17.12 11.5 18 12.38 18 13.47V13.53C18 14.62 17.12 15.5 16.03 15.5H15.96C14.88 15.5 14 14.62 14 13.53V13.46C14 12.38 14.88 11.5 15.97 11.5Z\"></path>\n<path stroke-linejoin=\"round\" stroke-linecap=\"round\" stroke-miterlimit=\"10\" stroke-width=\"2\" stroke=\"\" d=\"M7.97 11.5H8.04C9.12 11.5 10 12.38 10 13.47V13.53C10 14.62 9.12 15.5 8.03 15.5H7.97C6.88 15.5 6 14.62 6 13.53V13.46C6 12.38 6.88 11.5 7.97 11.5Z\"></path>\n</svg>\n</span><p>è¿™é‡Œæœ‰ä¸ªè´¹è§£çš„åœ°æ–¹å°±æ˜¯ wakeupï¼Œå®ƒæ—¢å¯ä»¥ç”±æäº¤ä»»åŠ¡çš„çº¿ç¨‹æ¥è°ƒç”¨ï¼ˆæ¯”è¾ƒå¥½ç†è§£ï¼‰ï¼Œä¹Ÿå¯ä»¥ç”± EventLoop çº¿ç¨‹æ¥è°ƒç”¨ï¼ˆæ¯”è¾ƒè´¹è§£ï¼‰ï¼Œè¿™é‡Œè¦çŸ¥é“ wakeup æ–¹æ³•çš„æ•ˆæœï¼š</p>\n<ul>\n<li>ç”±<strong>é EventLoop çº¿ç¨‹è°ƒ</strong>ç”¨ï¼Œä¼š**[å”¤é†’å½“å‰]åœ¨æ‰§è¡Œ select é˜»å¡çš„ EventLoop çº¿ç¨‹**</li>\n<li>ç”± <strong>EventLoop è‡ªå·±è°ƒ</strong>ç”¨ï¼Œä¼š<strong>æœ¬æ¬¡çš„ wakeup ä¼š[å–æ¶ˆä¸‹ä¸€æ¬¡çš„ select] æ“ä½œ</strong></li>\n</ul></blockquote>\n<p>å‚è€ƒä¸‹å›¾</p>\n<p><img src=\"http://cache.itzy8.top/%E5%AD%A6Netty-%E9%BB%91%E9%A9%AC%E6%BB%A1%E5%93%A5/0032.png\"></p>\n<p><img src=\"http://cache.itzy8.top/%E5%AD%A6Netty-%E9%BB%91%E9%A9%AC%E6%BB%A1%E5%93%A5/image-20220506190850519.png\" alt=\"image-20220506190850519\"></p>\n<p><code>io.netty.channel.nio.NioEventLoop#select</code></p>\n<pre class=\"line-numbers language-java\" data-language=\"java\"><code class=\"language-java\">private void select(boolean oldWakenUp) throws IOException &#123;\n    Selector selector &#x3D; this.selector;\n    try &#123;\n        int selectCnt &#x3D; 0;\n        long currentTimeNanos &#x3D; System.nanoTime();\n        &#x2F;&#x2F; è®¡ç®—ç­‰å¾…æ—¶é—´\n        &#x2F;&#x2F; * æ²¡æœ‰ scheduledTaskï¼Œè¶…æ—¶æ—¶é—´ä¸º 1s\n        &#x2F;&#x2F; * æœ‰ scheduledTaskï¼Œè¶…æ—¶æ—¶é—´ä¸º &#96;ä¸‹ä¸€ä¸ªå®šæ—¶ä»»åŠ¡æ‰§è¡Œæ—¶é—´ - å½“å‰æ—¶é—´&#96;\n        long selectDeadLineNanos &#x3D; currentTimeNanos + delayNanos(currentTimeNanos);\n\n        for (;;) &#123;\n            long timeoutMillis &#x3D; (selectDeadLineNanos - currentTimeNanos + 500000L) &#x2F; 1000000L;\n            &#x2F;&#x2F; å¦‚æœè¶…æ—¶ï¼Œé€€å‡ºå¾ªç¯\n            if (timeoutMillis &lt;&#x3D; 0) &#123;\n                if (selectCnt &#x3D;&#x3D; 0) &#123;\n                    selector.selectNow();\n                    selectCnt &#x3D; 1;\n                &#125;\n                break;\n            &#125;\n\n            &#x2F;&#x2F; å¦‚æœæœŸé—´åˆæœ‰ task: é€€å‡ºå¾ªç¯ï¼Œå¦‚æœæ²¡è¿™ä¸ªåˆ¤æ–­ï¼Œé‚£ä¹ˆä»»åŠ¡å°±ä¼šç­‰åˆ°ä¸‹æ¬¡ select è¶…æ—¶æ—¶æ‰èƒ½è¢«æ‰§è¡Œ\n            &#x2F;&#x2F; wakenUp.compareAndSet(false, true) æ˜¯è®©é NioEventLoop ä¸å¿…å†æ‰§è¡Œ wakeup\n            if (hasTasks() &amp;&amp; wakenUp.compareAndSet(false, true)) &#123;\n                selector.selectNow();\n                selectCnt &#x3D; 1;\n                break;\n            &#125;\n\n            &#x2F;&#x2F; select æœ‰é™æ—¶é˜»å¡\n            &#x2F;&#x2F; æ³¨æ„ã€ (JDK)nio æœ‰ bugã€‘ï¼Œå½“ bug å‡ºç°æ—¶ï¼Œã€select æ–¹æ³•å³ä½¿æ²¡æœ‰äº‹ä»¶å‘ç”Ÿï¼Œä¹Ÿä¸ä¼šé˜»å¡ä½ï¼Œå¯¼è‡´ä¸æ–­ç©ºè½®è¯¢ï¼Œcpu å ç”¨ 100%ã€‘\n            int selectedKeys &#x3D; selector.select(timeoutMillis);\n            &#x2F;&#x2F; è®¡æ•°åŠ  1\n            selectCnt ++;\n\n            &#x2F;&#x2F; é†’æ¥åï¼Œå¦‚æœã€æœ‰ IO äº‹ä»¶ã€æˆ–æ˜¯ç”±é EventLoop çº¿ç¨‹å”¤é†’ï¼Œæˆ–è€…æœ‰ä»»åŠ¡ï¼šé€€å‡ºå¾ªç¯ã€‘\n            if (selectedKeys !&#x3D; 0 || oldWakenUp || wakenUp.get() || hasTasks() || hasScheduledTasks()) &#123;\n                break;\n            &#125;\n            if (Thread.interrupted()) &#123;\n               \t&#x2F;&#x2F; [çº¿ç¨‹è¢«æ‰“æ–­]ï¼Œé€€å‡ºå¾ªç¯\n                &#x2F;&#x2F; è®°å½•æ—¥å¿—\n                selectCnt &#x3D; 1;\n                break;\n            &#125;\n\n            long time &#x3D; System.nanoTime();\n            if (time - TimeUnit.MILLISECONDS.toNanos(timeoutMillis) &gt;&#x3D; currentTimeNanos) &#123;\n                &#x2F;&#x2F; å¦‚æœ[è¶…æ—¶]ï¼Œ[è®¡æ•°é‡ç½®ä¸º 1ï¼Œä¸‹æ¬¡å¾ªç¯å°±ä¼š break]\n                selectCnt &#x3D; 1;\n            &#125; \n            &#x2F;&#x2F; è®¡æ•°è¶…è¿‡é˜ˆå€¼ï¼Œç”± io.netty.selectorAutoRebuildThreshold æŒ‡å®šï¼Œé»˜è®¤ 512\n            &#x2F;&#x2F; è¿™æ˜¯ä¸ºäº†è§£å†³ ã€nio ç©ºè½®è¯¢ bugã€‘(ä¸å¯ä¿®å¤ï¼Œä»¥æ–°æ¢æ—§)\n            else if (SELECTOR_AUTO_REBUILD_THRESHOLD &gt; 0 &amp;&amp;\n                    selectCnt &gt;&#x3D; SELECTOR_AUTO_REBUILD_THRESHOLD) &#123;&#x2F;&#x2F;&gt;&#x3D;512\n                &#x2F;&#x2F; é‡å»º selector,æ›¿æ¢æ—§çš„selector(selectionKeyç­‰ä¿¡æ¯å¤åˆ¶è¿‡å»)\n                selector &#x3D; selectRebuildSelector(selectCnt);\n                selectCnt &#x3D; 1;\n                break;\n            &#125;\n\n            currentTimeNanos &#x3D; time;\n        &#125;\n\n        if (selectCnt &gt; MIN_PREMATURE_SELECTOR_RETURNS) &#123;\n            &#x2F;&#x2F; è®°å½•æ—¥å¿—\n        &#125;\n    &#125; catch (CancelledKeyException e) &#123;\n        &#x2F;&#x2F; è®°å½•æ—¥å¿—\n    &#125;\n&#125;</code></pre>\n\n<p><img src=\"http://cache.itzy8.top/%E5%AD%A6Netty-%E9%BB%91%E9%A9%AC%E6%BB%A1%E5%93%A5/image-20220506191120761.png\" alt=\"image-20220506191120761\"></p>\n<p><img src=\"http://cache.itzy8.top/%E5%AD%A6Netty-%E9%BB%91%E9%A9%AC%E6%BB%A1%E5%93%A5/image-20220506191602799.png\" alt=\"image-20220506191602799\"></p>\n<p>linuxä¸‹jdk nioæ”¯æŒæœ‰bugã€‚æ³•2ï¼šå®Œå…¨é‡å†™selectorçš„å®ç°ã€‚ã€‚ã€‚</p>\n<p>å¤„ç† keys <code>io.netty.channel.nio.NioEventLoop#processSelectedKeys</code></p>\n<pre class=\"line-numbers language-java\" data-language=\"java\"><code class=\"language-java\">private void processSelectedKeys() &#123;\n    if (selectedKeys !&#x3D; null) &#123;\n        &#x2F;&#x2F; é€šè¿‡åå°„å°† Selector å®ç°ç±»ä¸­çš„å°±ç»ªäº‹ä»¶é›†åˆæ›¿æ¢ä¸º SelectedSelectionKeySet \n        &#x2F;&#x2F; SelectedSelectionKeySet åº•å±‚ä¸ºæ•°ç»„å®ç°ï¼Œå¯ä»¥æé«˜éå†æ€§èƒ½ï¼ˆåŸæœ¬ä¸º HashSetï¼‰\n        processSelectedKeysOptimized();&#x2F;&#x2F;\n    &#125; else &#123;\n        processSelectedKeysPlain(selector.selectedKeys());\n    &#125;\n&#125;</code></pre>\n\n<pre class=\"line-numbers language-java\" data-language=\"java\"><code class=\"language-java\">private void processSelectedKeysOptimized() &#123;\n        for (int i &#x3D; 0; i &lt; selectedKeys.size; ++i) &#123;\n            final SelectionKey k &#x3D; selectedKeys.keys[i];\n            &#x2F;&#x2F; null out entry in the array to allow to have it GC&#39;ed once the Channel close\n            &#x2F;&#x2F; See https:&#x2F;&#x2F;github.com&#x2F;netty&#x2F;netty&#x2F;issues&#x2F;2363\n            selectedKeys.keys[i] &#x3D; null;&#x2F;&#x2F;\n\n            final Object a &#x3D; k.attachment();&#x2F;&#x2F;keyå…³è”çš„é™„ä»¶ï¼šNIOçš„channel (pipeline-handlers)\n\n            if (a instanceof AbstractNioChannel) &#123;\n                processSelectedKey(k, (AbstractNioChannel) a);&#x2F;&#x2F;ï¼ï¼ï¼\n            &#125; else &#123;\n                @SuppressWarnings(&quot;unchecked&quot;)\n                NioTask&lt;SelectableChannel&gt; task &#x3D; (NioTask&lt;SelectableChannel&gt;) a;\n                processSelectedKey(k, task);\n            &#125;\n\n            if (needsToSelectAgain) &#123;\n                &#x2F;&#x2F; null out entries in the array to allow to have it GC&#39;ed once the Channel close\n                &#x2F;&#x2F; See https:&#x2F;&#x2F;github.com&#x2F;netty&#x2F;netty&#x2F;issues&#x2F;2363\n                selectedKeys.reset(i + 1);\n\n                selectAgain();\n                i &#x3D; -1;\n            &#125;\n        &#125;\n    &#125;</code></pre>\n\n<p><img src=\"http://cache.itzy8.top/%E5%AD%A6Netty-%E9%BB%91%E9%A9%AC%E6%BB%A1%E5%93%A5/image-20220506194541725.png\" alt=\"image-20220506194541725\"></p>\n<p><code>io.netty.channel.nio.NioEventLoop#processSelectedKey</code></p>\n<pre class=\"line-numbers language-java\" data-language=\"java\"><code class=\"language-java\">private void processSelectedKey(SelectionKey k, AbstractNioChannel ch) &#123;\n    final AbstractNioChannel.NioUnsafe unsafe &#x3D; ch.unsafe();\n    &#x2F;&#x2F; å½“ key å–æ¶ˆæˆ–å…³é—­æ—¶ä¼šå¯¼è‡´è¿™ä¸ª key æ— æ•ˆ\n    if (!k.isValid()) &#123;\n        &#x2F;&#x2F; æ— æ•ˆæ—¶å¤„ç†...\n        return;\n    &#125;\n\n    try &#123;\n        int readyOps &#x3D; k.readyOps();&#x2F;&#x2F;\n        &#x2F;&#x2F; è¿æ¥äº‹ä»¶\n        if ((readyOps &amp; SelectionKey.OP_CONNECT) !&#x3D; 0) &#123;\n            int ops &#x3D; k.interestOps();\n            ops &amp;&#x3D; ~SelectionKey.OP_CONNECT;\n            k.interestOps(ops);\n\n            unsafe.finishConnect();\n        &#125;\n\n        &#x2F;&#x2F; å¯å†™äº‹ä»¶\n        if ((readyOps &amp; SelectionKey.OP_WRITE) !&#x3D; 0) &#123;\n            ch.unsafe().forceFlush();\n        &#125;\n\n        &#x2F;&#x2F; å¯è¯»æˆ–å¯æ¥å…¥äº‹ä»¶\n        if ((readyOps &amp; (SelectionKey.OP_READ | SelectionKey.OP_ACCEPT)) !&#x3D; 0 || readyOps &#x3D;&#x3D; 0) &#123;\n            &#x2F;&#x2F; å¦‚æœæ˜¯å¯æ¥å…¥ io.netty.channel.nio.AbstractNioMessageChannel.NioMessageUnsafe#read\n            &#x2F;&#x2F; å¦‚æœæ˜¯å¯è¯» io.netty.channel.nio.AbstractNioByteChannel.NioByteUnsafe#read\n            unsafe.read();&#x2F;&#x2F;ã€åä¸¤èŠ‚:accept&#x2F;readã€‘æ‰“æ–­ç‚¹ï¼Œdebugï¼šTestSourceServerï¼ï¼ï¼\n        &#125;\n    &#125; catch (CancelledKeyException ignored) &#123;\n        unsafe.close(unsafe.voidPromise());\n    &#125;\n&#125;</code></pre>\n\n\n\n<h3 id=\"2-3-accept-å‰–æ\"><a href=\"#2-3-accept-å‰–æ\" class=\"headerlink\" title=\"2.3 accept å‰–æ\"></a>2.3 accept å‰–æ</h3><p>nio ä¸­å¦‚ä¸‹ä»£ç ï¼Œåœ¨ netty ä¸­çš„æµç¨‹</p>\n<pre class=\"line-numbers language-java\" data-language=\"java\"><code class=\"language-java\">&#x2F;&#x2F;1 é˜»å¡ç›´åˆ°äº‹ä»¶å‘ç”Ÿ\nselector.select();\n\nIterator&lt;SelectionKey&gt; iter &#x3D; selector.selectedKeys().iterator();\nwhile (iter.hasNext()) &#123;    \n    &#x2F;&#x2F;2 æ‹¿åˆ°ä¸€ä¸ªäº‹ä»¶\n    SelectionKey key &#x3D; iter.next();\n    \n    &#x2F;&#x2F;3 å¦‚æœæ˜¯ accept äº‹ä»¶\n    if (key.isAcceptable()) &#123;\n        \n        &#x2F;&#x2F;4 æ‰§è¡Œ accept\n        SocketChannel channel &#x3D; serverSocketChannel.accept();\n        channel.configureBlocking(false);\n        \n        &#x2F;&#x2F;5 å…³æ³¨ read äº‹ä»¶\n        channel.register(selector, SelectionKey.OP_READ);\n    &#125;\n    &#x2F;&#x2F; ...\n&#125;</code></pre>\n\n<p><img src=\"http://cache.itzy8.top/%E5%AD%A6Netty-%E9%BB%91%E9%A9%AC%E6%BB%A1%E5%93%A5/image-20220506194824870.png\" alt=\"image-20220506194824870\"></p>\n<p>debug TestSourceServer, run TestBacklogClientï¼š</p>\n<pre class=\"line-numbers language-java\" data-language=\"java\"><code class=\"language-java\">&#x2F;&#x2F;readyOps&#x3D;16ï¼šaccept (&#x3D;1ï¼šread)\nif ((readyOps &amp; (SelectionKey.OP_READ | SelectionKey.OP_ACCEPT)) !&#x3D; 0 || readyOps &#x3D;&#x3D; 0) &#123;\n    unsafe.read();&#x2F;&#x2F;456)\n&#125;</code></pre>\n\n<p>&#x3D;&#x3D;run to cursor:Alt+F9&#x3D;&#x3D;</p>\n<p>å…ˆæ¥çœ‹å¯æ¥å…¥äº‹ä»¶å¤„ç†ï¼ˆacceptï¼‰</p>\n<p><code>io.netty.channel.nio.AbstractNioMessageChannel.NioMessageUnsafe#read</code></p>\n<pre class=\"line-numbers language-java\" data-language=\"java\"><code class=\"language-java\">public void read() &#123;\n    assert eventLoop().inEventLoop();\n    final ChannelConfig config &#x3D; config();\n    final ChannelPipeline pipeline &#x3D; pipeline();    \n    final RecvByteBufAllocator.Handle allocHandle &#x3D; unsafe().recvBufAllocHandle();\n    allocHandle.reset(config);\n\n    boolean closed &#x3D; false;\n    Throwable exception &#x3D; null;\n    try &#123;\n        try &#123;\n            do &#123;\n\t\t\t\t&#x2F;&#x2F;4) doReadMessages ä¸­æ‰§è¡Œäº† accept å¹¶[åˆ›å»º NioSocketChannel ä½œä¸ºæ¶ˆæ¯æ”¾å…¥ readBuf]\n                &#x2F;&#x2F; readBuf æ˜¯ä¸€ä¸ª ArrayList ç”¨æ¥ç¼“å­˜æ¶ˆæ¯\n                int localRead &#x3D; doReadMessages(readBuf);&#x2F;&#x2F;4)\n                if (localRead &#x3D;&#x3D; 0) &#123;\n                    break;\n                &#125;\n                if (localRead &lt; 0) &#123;\n                    closed &#x3D; true;\n                    break;\n                &#125;\n\t\t\t\t&#x2F;&#x2F; localRead ä¸º 1ï¼Œå°±ä¸€æ¡æ¶ˆæ¯ï¼Œå³æ¥æ”¶ä¸€ä¸ªå®¢æˆ·ç«¯è¿æ¥\n                allocHandle.incMessagesRead(localRead);\n            &#125; while (allocHandle.continueReading());\n        &#125; catch (Throwable t) &#123;\n            exception &#x3D; t;\n        &#125;\n\n        int size &#x3D; readBuf.size();\n        for (int i &#x3D; 0; i &lt; size; i ++) &#123;\n            readPending &#x3D; false;\n            &#x2F;&#x2F; è§¦å‘ read äº‹ä»¶ï¼Œè®© pipeline ä¸Šçš„ handler å¤„ç†ï¼Œè¿™æ—¶æ˜¯å¤„ç†\n            &#x2F;&#x2F; io.netty.bootstrap.ServerBootstrap.ServerBootstrapAcceptor#channelRead\n            pipeline.fireChannelRead(readBuf.get(i));&#x2F;&#x2F;channelRead()+æ–­ç‚¹\n        &#125;\n        readBuf.clear();\n        allocHandle.readComplete();\n        pipeline.fireChannelReadComplete();\n\n        if (exception !&#x3D; null) &#123;\n            closed &#x3D; closeOnReadError(exception);\n\n            pipeline.fireExceptionCaught(exception);\n        &#125;\n\n        if (closed) &#123;\n            inputShutdown &#x3D; true;\n            if (isOpen()) &#123;\n                close(voidPromise());\n            &#125;\n        &#125;\n    &#125; finally &#123;\n        if (!readPending &amp;&amp; !config.isAutoRead()) &#123;\n            removeReadOp();\n        &#125;\n    &#125;\n&#125;</code></pre>\n\n<pre class=\"line-numbers language-java\" data-language=\"java\"><code class=\"language-java\">@Override\nprotected int doReadMessages(List&lt;Object&gt; buf) throws Exception &#123;\n    &#x2F;&#x2F;4) -&gt;serverSocketChannel.accept();\n    SocketChannel ch &#x3D; SocketUtils.accept(javaChannel());\n    \n    try &#123;\n        if (ch !&#x3D; null) &#123;\n            buf.add(new NioSocketChannel(this, ch));&#x2F;&#x2F;è®¾ç½®éé˜»å¡\n            return 1;\n        &#125;\n    &#125; catch (Throwable t) &#123;\n        ...</code></pre>\n\n<p><img src=\"http://cache.itzy8.top/%E5%AD%A6Netty-%E9%BB%91%E9%A9%AC%E6%BB%A1%E5%93%A5/image-20220506200712839.png\" alt=\"image-20220506200712839\"></p>\n<p>head-&gt;ã€ServerBootstrapAcceptorç±»ã€‘acceptor-&gt;tail</p>\n<p>channelRead()æ–¹æ³•æ‰“æ–­ç‚¹ï¼š</p>\n<p>å…³é”®ä»£ç  <code>io.netty.bootstrap.ServerBootstrap.ServerBootstrapAcceptor#channelRead</code></p>\n<pre class=\"line-numbers language-java\" data-language=\"java\"><code class=\"language-java\">public void channelRead(ChannelHandlerContext ctx, Object msg) &#123;\n    &#x2F;&#x2F; è¿™æ—¶çš„ msg æ˜¯ NioSocketChannel\n    final Channel child &#x3D; (Channel) msg;\n\n    &#x2F;&#x2F; NioSocketChannel æ·»åŠ   childHandler å³åˆå§‹åŒ–å™¨\n    child.pipeline().addLast(childHandler);\n\n    &#x2F;&#x2F; è®¾ç½®é€‰é¡¹\n    setChannelOptions(child, childOptions, logger);\n\n    for (Entry&lt;AttributeKey&lt;?&gt;, Object&gt; e: childAttrs) &#123;\n        child.attr((AttributeKey&lt;Object&gt;) e.getKey()).set(e.getValue());\n    &#125;\n\n    try &#123;\n        &#x2F;&#x2F; æ³¨å†Œ NioSocketChannel åˆ° nio worker çº¿ç¨‹ï¼Œæ¥ä¸‹æ¥çš„å¤„ç†ä¹Ÿç§»äº¤è‡³ nio worker çº¿ç¨‹\n        childGroup.register(child).addListener(new ChannelFutureListener() &#123;\n            @Override\n            public void operationComplete(ChannelFuture future) throws Exception &#123;\n                if (!future.isSuccess()) &#123;\n                    forceClose(child, future.cause());\n                &#125;\n            &#125;\n        &#125;);\n    &#125; catch (Throwable t) &#123;\n        forceClose(child, t);\n    &#125;\n&#125;</code></pre>\n\n\n\n<p>åˆå›åˆ°äº†ç†Ÿæ‚‰çš„ <code>io.netty.channel.AbstractChannel.AbstractUnsafe#register</code>  æ–¹æ³•</p>\n<pre class=\"line-numbers language-java\" data-language=\"java\"><code class=\"language-java\">public final void register(EventLoop eventLoop, final ChannelPromise promise) &#123;\n    &#x2F;&#x2F; ä¸€äº›æ£€æŸ¥ï¼Œç•¥...\n\n    AbstractChannel.this.eventLoop &#x3D; eventLoop;\n\n    if (eventLoop.inEventLoop()) &#123;\n        register0(promise);\n    &#125; else &#123;\n        try &#123;\n            &#x2F;&#x2F; è¿™è¡Œä»£ç å®Œæˆçš„äº‹å®æ˜¯ nio boss -&gt; nio worker çº¿ç¨‹çš„åˆ‡æ¢\n            eventLoop.execute(new Runnable() &#123;\n                @Override\n                public void run() &#123;\n                    register0(promise);&#x2F;&#x2F;\n                &#125;\n            &#125;);\n        &#125; catch (Throwable t) &#123;\n            &#x2F;&#x2F; æ—¥å¿—è®°å½•...\n            closeForcibly();\n            closeFuture.setClosed();\n            safeSetFailure(promise, t);\n        &#125;\n    &#125;\n&#125;</code></pre>\n\n<ol start=\"4\">\n<li>doReadMessages()</li>\n</ol>\n<p><img src=\"http://cache.itzy8.top/%E5%AD%A6Netty-%E9%BB%91%E9%A9%AC%E6%BB%A1%E5%93%A5/image-20220506202850401.png\" alt=\"image-20220506202850401\"></p>\n<p><code>io.netty.channel.AbstractChannel.AbstractUnsafe#register0</code></p>\n<pre class=\"line-numbers language-java\" data-language=\"java\"><code class=\"language-java\">private void register0(ChannelPromise promise) &#123;\n    try &#123;\n        if (!promise.setUncancellable() || !ensureOpen(promise)) &#123;\n            return;\n        &#125;\n        boolean firstRegistration &#x3D; neverRegistered;\n        doRegister();&#x2F;&#x2F; 5) selectionKey &#x3D; javaChannel().register(eventLoop().unwrappedSelector(), 0, this);\n        neverRegistered &#x3D; false;\n        registered &#x3D; true;\n\t\t\n        &#x2F;&#x2F; æ‰§è¡Œåˆå§‹åŒ–å™¨ï¼Œæ‰§è¡Œå‰ pipeline ä¸­åªæœ‰ head -&gt; åˆå§‹åŒ–å™¨ -&gt; tail\n        pipeline.invokeHandlerAddedIfNeeded();&#x2F;&#x2F;\n        &#x2F;&#x2F; æ‰§è¡Œåå°±æ˜¯ head -&gt; logging handler -&gt; my handler -&gt; tail\n\n        safeSetSuccess(promise);\n        pipeline.fireChannelRegistered();\n        \n        if (isActive()) &#123;\n            if (firstRegistration) &#123;\n                &#x2F;&#x2F; 6) è§¦å‘ pipeline ä¸Š active äº‹ä»¶ï¼Œå…³æ³¨selectionKeyçš„readäº‹ä»¶\n                pipeline.fireChannelActive();&#x2F;&#x2F;\n            &#125; else if (config().isAutoRead()) &#123;\n                beginRead();\n            &#125;\n        &#125;\n    &#125; catch (Throwable t) &#123;\n        closeForcibly();\n        closeFuture.setClosed();\n        safeSetFailure(promise, t);\n    &#125;\n&#125;</code></pre>\n\n<p><img src=\"http://cache.itzy8.top/%E5%AD%A6Netty-%E9%BB%91%E9%A9%AC%E6%BB%A1%E5%93%A5/image-20220506202410914.png\" alt=\"image-20220506202410914\"></p>\n<p>å›åˆ°äº†ç†Ÿæ‚‰çš„ä»£ç  <code>io.netty.channel.DefaultChannelPipeline.HeadContext#channelActive</code></p>\n<pre class=\"line-numbers language-java\" data-language=\"java\"><code class=\"language-java\">public void channelActive(ChannelHandlerContext ctx) &#123;\n    ctx.fireChannelActive();\n\t&#x2F;&#x2F; è§¦å‘ read (NioSocketChannel è¿™é‡Œ readï¼Œåªæ˜¯ä¸ºäº†è§¦å‘ channel çš„äº‹ä»¶æ³¨å†Œï¼Œè¿˜æœªæ¶‰åŠæ•°æ®è¯»å–)\n    readIfIsAutoRead();&#x2F;&#x2F;F7ã€‚ã€‚ã€‚\n&#125;</code></pre>\n\n<p><code>io.netty.channel.nio.AbstractNioChannel#doBeginRead</code></p>\n<pre class=\"line-numbers language-java\" data-language=\"java\"><code class=\"language-java\">protected void doBeginRead() throws Exception &#123;\n    &#x2F;&#x2F; Channel.read() or ChannelHandlerContext.read() was called\n    final SelectionKey selectionKey &#x3D; this.selectionKey;\n    if (!selectionKey.isValid()) &#123;\n        return;\n    &#125;\n\n    readPending &#x3D; true;\n\t&#x2F;&#x2F; è¿™æ—¶å€™ interestOps æ˜¯ 0\n    final int interestOps &#x3D; selectionKey.interestOps();\n    if ((interestOps &amp; readInterestOp) &#x3D;&#x3D; 0) &#123;\n        &#x2F;&#x2F; 6) å…³æ³¨ read äº‹ä»¶ï¼\n        selectionKey.interestOps(interestOps | readInterestOp);\n    &#125;\n&#125;</code></pre>\n\n<p><img src=\"http://cache.itzy8.top/%E5%AD%A6Netty-%E9%BB%91%E9%A9%AC%E6%BB%A1%E5%93%A5/image-20220506204034188.png\" alt=\"image-20220506204034188\"></p>\n<h3 id=\"2-4-read-å‰–æ\"><a href=\"#2-4-read-å‰–æ\" class=\"headerlink\" title=\"2.4 read å‰–æ\"></a>2.4 read å‰–æ</h3><p>NioEventLoopä¸‹ï¼šunsafe.read()åŠ æ–­ç‚¹</p>\n<p>F9ä¸¤æ¬¡ï¼šreadOps&#x3D;16:acceptäº‹ä»¶ï¼Œ  &#x3D;1:readäº‹ä»¶ </p>\n<p>F7è¿›ï¼š</p>\n<p><img src=\"http://cache.itzy8.top/%E5%AD%A6Netty-%E9%BB%91%E9%A9%AC%E6%BB%A1%E5%93%A5/image-20220506210125483.png\" alt=\"image-20220506210125483\"></p>\n<p>å†æ¥çœ‹å¯è¯»äº‹ä»¶ <code>io.netty.channel.nio.AbstractNioByteChannel.NioByteUnsafe#read</code>ï¼Œæ³¨æ„<strong>å‘é€çš„æ•°æ®æœªå¿…èƒ½å¤Ÿä¸€æ¬¡è¯»å®Œï¼Œå› æ­¤ä¼šè§¦å‘å¤šæ¬¡ nio read äº‹ä»¶ï¼Œä¸€æ¬¡äº‹ä»¶å†…ä¼šè§¦å‘å¤šæ¬¡ pipeline readï¼Œä¸€æ¬¡äº‹ä»¶ä¼šè§¦å‘ä¸€æ¬¡ pipeline read complete</strong></p>\n<pre class=\"line-numbers language-java\" data-language=\"java\"><code class=\"language-java\">public final void read() &#123;\n    final ChannelConfig config &#x3D; config();\n    if (shouldBreakReadReady(config)) &#123;\n        clearReadPending();\n        return;\n    &#125;\n    final ChannelPipeline pipeline &#x3D; pipeline();\n    &#x2F;&#x2F; io.netty.allocator.type å†³å®š allocator çš„å®ç°ï¼š(é)æ± åŒ–\n    final ByteBufAllocator allocator &#x3D; config.getAllocator();\n    &#x2F;&#x2F; ç”¨æ¥åˆ†é… byteBufï¼Œç¡®å®šå•æ¬¡è¯»å–å¤§å°ã€ioäº‹ä»¶å¼ºåˆ¶ç”¨deirectIOBufã€‘\n    final RecvByteBufAllocator.Handle allocHandle &#x3D; recvBufAllocHandle();\n    allocHandle.reset(config);\n\n    ByteBuf byteBuf &#x3D; null;\n    boolean close &#x3D; false;\n    try &#123;\n        do &#123;\n            byteBuf &#x3D; allocHandle.allocate(allocator);\n            &#x2F;&#x2F; è¯»å–\n            allocHandle.lastBytesRead(doReadBytes(byteBuf));&#x2F;&#x2F;&quot;hello!&quot; widx&#x3D;0å˜6\n            if (allocHandle.lastBytesRead() &lt;&#x3D; 0) &#123;\n                byteBuf.release();\n                byteBuf &#x3D; null;\n                close &#x3D; allocHandle.lastBytesRead() &lt; 0;\n                if (close) &#123;\n                    readPending &#x3D; false;\n                &#125;\n                break;\n            &#125;\n\n            allocHandle.incMessagesRead(1);\n            readPending &#x3D; false;\n            &#x2F;&#x2F; è§¦å‘ read äº‹ä»¶ï¼Œè®© pipeline ä¸Šçš„ handler å¤„ç†ï¼Œè¿™æ—¶æ˜¯å¤„ç† NioSocketChannel ä¸Šçš„ handler\n            pipeline.fireChannelRead(byteBuf);&#x2F;&#x2F;headã€loggingã€tail\n            byteBuf &#x3D; null;\n        &#125; \n        &#x2F;&#x2F; æ˜¯å¦è¦ç»§ç»­å¾ªç¯\n        while (allocHandle.continueReading());\n\n        allocHandle.readComplete();\n        &#x2F;&#x2F; è§¦å‘ read complete äº‹ä»¶\n        pipeline.fireChannelReadComplete();\n\n        if (close) &#123;\n            closeOnRead(pipeline);\n        &#125;\n    &#125; catch (Throwable t) &#123;\n        handleReadException(pipeline, byteBuf, t, close, allocHandle);\n    &#125; finally &#123;\n        if (!readPending &amp;&amp; !config.isAutoRead()) &#123;\n            removeReadOp();\n        &#125;\n    &#125;\n&#125;</code></pre>\n\n\n\n<p><code>io.netty.channel.DefaultMaxMessagesRecvByteBufAllocator.MaxMessageHandle#continueReading(io.netty.util.UncheckedBooleanSupplier)</code></p>\n<pre class=\"line-numbers language-java\" data-language=\"java\"><code class=\"language-java\">public boolean continueReading(UncheckedBooleanSupplier maybeMoreDataSupplier) &#123;\n    return \n           &#x2F;&#x2F; ä¸€èˆ¬ä¸º true\n           config.isAutoRead() &amp;&amp;\n           &#x2F;&#x2F; respectMaybeMoreData é»˜è®¤ä¸º true\n           &#x2F;&#x2F; maybeMoreDataSupplier çš„é€»è¾‘æ˜¯ã€å¦‚æœé¢„æœŸè¯»å–å­—èŠ‚ä¸å®é™…è¯»å–å­—èŠ‚ç›¸ç­‰ï¼Œè¿”å› trueã€‘\n           (!respectMaybeMoreData || maybeMoreDataSupplier.get()) &amp;&amp;\n           &#x2F;&#x2F; å°äºæœ€å¤§æ¬¡æ•°ï¼ŒmaxMessagePerRead é»˜è®¤ 16\n           totalMessages &lt; maxMessagePerRead &amp;&amp;\n           &#x2F;&#x2F; å®é™…è¯»åˆ°äº†æ•°æ®\n           totalBytesRead &gt; 0;\n&#125;</code></pre>\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n","text":"é»‘é©¬Nettyï¼šhttps://www.bilibili.com/video/BV1py4y1E7oA å­¦Nettyï¼Œå»ºè®®çœ‹é»‘é©¬Nettyæ•™ç¨‹ã€‚ç„¶åå°šç¡…è°·Nettyè¯¾çš„Protobuf, DubboRPCç­‰æ¡ˆä¾‹å°±å¯ä»¥äº†ã€‚ å°šç¡…è°·-éŸ©é¡ºå¹³ï¼šhttps://www.bilibili....","link":"","photos":[],"count_time":{"symbolsCount":"317k","symbolsTime":"4:48"},"categories":[{"name":"Netty","slug":"Netty","count":1,"path":"api/categories/Netty.json"}],"tags":[{"name":"Netty","slug":"Netty","count":1,"path":"api/tags/Netty.json"}],"toc":"<ol class=\"toc\"><li class=\"toc-item toc-level-1\"><a class=\"toc-link\" href=\"#%E4%B8%80-NIO-%E5%9F%BA%E7%A1%80\"><span class=\"toc-text\">ä¸€. NIO åŸºç¡€</span></a><ol class=\"toc-child\"><li class=\"toc-item toc-level-2\"><a class=\"toc-link\" href=\"#1-%E4%B8%89%E5%A4%A7%E7%BB%84%E4%BB%B6\"><span class=\"toc-text\">1. ä¸‰å¤§ç»„ä»¶</span></a><ol class=\"toc-child\"><li class=\"toc-item toc-level-3\"><a class=\"toc-link\" href=\"#1-1-Channel-amp-Buffer\"><span class=\"toc-text\">1.1 Channel &amp; Buffer</span></a></li><li class=\"toc-item toc-level-3\"><a class=\"toc-link\" href=\"#1-2-Selector\"><span class=\"toc-text\">1.2 Selector</span></a><ol class=\"toc-child\"><li class=\"toc-item toc-level-4\"><a class=\"toc-link\" href=\"#%E5%A4%9A%E7%BA%BF%E7%A8%8B%E7%89%88%E8%AE%BE%E8%AE%A1\"><span class=\"toc-text\">å¤šçº¿ç¨‹ç‰ˆè®¾è®¡</span></a></li><li class=\"toc-item toc-level-4\"><a class=\"toc-link\" href=\"#%E2%9A%A0%EF%B8%8F-%E5%A4%9A%E7%BA%BF%E7%A8%8B%E7%89%88%E7%BC%BA%E7%82%B9\"><span class=\"toc-text\">âš ï¸ å¤šçº¿ç¨‹ç‰ˆç¼ºç‚¹</span></a></li><li class=\"toc-item toc-level-4\"><a class=\"toc-link\" href=\"#%E7%BA%BF%E7%A8%8B%E6%B1%A0%E7%89%88%E8%AE%BE%E8%AE%A1\"><span class=\"toc-text\">çº¿ç¨‹æ± ç‰ˆè®¾è®¡</span></a></li><li class=\"toc-item toc-level-4\"><a class=\"toc-link\" href=\"#%E2%9A%A0%EF%B8%8F-%E7%BA%BF%E7%A8%8B%E6%B1%A0%E7%89%88%E7%BC%BA%E7%82%B9\"><span class=\"toc-text\">âš ï¸ çº¿ç¨‹æ± ç‰ˆç¼ºç‚¹</span></a></li><li class=\"toc-item toc-level-4\"><a class=\"toc-link\" href=\"#selector-%E7%89%88%E8%AE%BE%E8%AE%A1\"><span class=\"toc-text\">selector ç‰ˆè®¾è®¡</span></a></li></ol></li></ol></li><li class=\"toc-item toc-level-2\"><a class=\"toc-link\" href=\"#2-ByteBuffer\"><span class=\"toc-text\">2. ByteBuffer</span></a><ol class=\"toc-child\"><li class=\"toc-item toc-level-3\"><a class=\"toc-link\" href=\"#2-1-ByteBuffer-%E6%AD%A3%E7%A1%AE%E4%BD%BF%E7%94%A8%E5%A7%BF%E5%8A%BF\"><span class=\"toc-text\">2.1  ByteBuffer æ­£ç¡®ä½¿ç”¨å§¿åŠ¿</span></a></li><li class=\"toc-item toc-level-3\"><a class=\"toc-link\" href=\"#2-2-ByteBuffer-%E7%BB%93%E6%9E%84\"><span class=\"toc-text\">2.2 ByteBuffer ç»“æ„</span></a><ol class=\"toc-child\"><li class=\"toc-item toc-level-4\"><a class=\"toc-link\" href=\"#%F0%9F%92%A1-%E8%B0%83%E8%AF%95%E5%B7%A5%E5%85%B7%E7%B1%BB\"><span class=\"toc-text\">ğŸ’¡ è°ƒè¯•å·¥å…·ç±»</span></a></li></ol></li><li class=\"toc-item toc-level-3\"><a class=\"toc-link\" href=\"#2-3-ByteBuffer-%E5%B8%B8%E8%A7%81%E6%96%B9%E6%B3%95-nio-c2\"><span class=\"toc-text\">2.3 ByteBuffer å¸¸è§æ–¹æ³•-nio.c2</span></a><ol class=\"toc-child\"><li class=\"toc-item toc-level-4\"><a class=\"toc-link\" href=\"#%E5%88%86%E9%85%8D%E7%A9%BA%E9%97%B4TestByteBufferAllocate\"><span class=\"toc-text\">åˆ†é…ç©ºé—´\tTestByteBufferAllocate</span></a></li><li class=\"toc-item toc-level-4\"><a class=\"toc-link\" href=\"#%E5%90%91-buffer-%E5%86%99%E5%85%A5%E6%95%B0%E6%8D%AETestByteBufferReadWrite\"><span class=\"toc-text\">å‘ buffer å†™å…¥æ•°æ®\tTestByteBufferReadWrite</span></a></li><li class=\"toc-item toc-level-4\"><a class=\"toc-link\" href=\"#%E4%BB%8E-buffer-%E8%AF%BB%E5%8F%96%E6%95%B0%E6%8D%AETestByteBufferRead\"><span class=\"toc-text\">ä» buffer è¯»å–æ•°æ®\tTestByteBufferRead</span></a></li><li class=\"toc-item toc-level-4\"><a class=\"toc-link\" href=\"#mark-%E5%92%8C-reset\"><span class=\"toc-text\">mark å’Œ reset</span></a></li><li class=\"toc-item toc-level-4\"><a class=\"toc-link\" href=\"#%E5%AD%97%E7%AC%A6%E4%B8%B2%E4%B8%8E-ByteBuffer-%E4%BA%92%E8%BD%ACTestByteBufferString\"><span class=\"toc-text\">å­—ç¬¦ä¸²ä¸ ByteBuffer äº’è½¬\tTestByteBufferString</span></a></li><li class=\"toc-item toc-level-4\"><a class=\"toc-link\" href=\"#%E2%9A%A0%EF%B8%8F-Buffer-%E7%9A%84%E7%BA%BF%E7%A8%8B%E5%AE%89%E5%85%A8\"><span class=\"toc-text\">âš ï¸ Buffer çš„çº¿ç¨‹å®‰å…¨</span></a></li></ol></li><li class=\"toc-item toc-level-3\"><a class=\"toc-link\" href=\"#2-4-Scattering-Reads\"><span class=\"toc-text\">2.4 Scattering Reads</span></a></li><li class=\"toc-item toc-level-3\"><a class=\"toc-link\" href=\"#2-5-Gathering-Writes\"><span class=\"toc-text\">2.5 Gathering Writes</span></a></li><li class=\"toc-item toc-level-3\"><a class=\"toc-link\" href=\"#2-6-%E7%BB%83%E4%B9%A0TestByteBufferExam\"><span class=\"toc-text\">2.6 ç»ƒä¹ \tTestByteBufferExam</span></a></li></ol></li><li class=\"toc-item toc-level-2\"><a class=\"toc-link\" href=\"#3-%E6%96%87%E4%BB%B6%E7%BC%96%E7%A8%8B\"><span class=\"toc-text\">3. æ–‡ä»¶ç¼–ç¨‹</span></a><ol class=\"toc-child\"><li class=\"toc-item toc-level-3\"><a class=\"toc-link\" href=\"#3-1-FileChannel\"><span class=\"toc-text\">3.1 FileChannel</span></a><ol class=\"toc-child\"><li class=\"toc-item toc-level-4\"><a class=\"toc-link\" href=\"#%E2%9A%A0%EF%B8%8F-FileChannel-%E5%B7%A5%E4%BD%9C%E6%A8%A1%E5%BC%8F\"><span class=\"toc-text\">âš ï¸ FileChannel å·¥ä½œæ¨¡å¼</span></a></li><li class=\"toc-item toc-level-4\"><a class=\"toc-link\" href=\"#%E8%8E%B7%E5%8F%96\"><span class=\"toc-text\">è·å–</span></a></li><li class=\"toc-item toc-level-4\"><a class=\"toc-link\" href=\"#%E8%AF%BB%E5%8F%96\"><span class=\"toc-text\">è¯»å–</span></a></li><li class=\"toc-item toc-level-4\"><a class=\"toc-link\" href=\"#%E5%86%99%E5%85%A5\"><span class=\"toc-text\">å†™å…¥</span></a></li><li class=\"toc-item toc-level-4\"><a class=\"toc-link\" href=\"#%E5%85%B3%E9%97%AD\"><span class=\"toc-text\">å…³é—­</span></a></li><li class=\"toc-item toc-level-4\"><a class=\"toc-link\" href=\"#%E4%BD%8D%E7%BD%AE\"><span class=\"toc-text\">ä½ç½®</span></a></li><li class=\"toc-item toc-level-4\"><a class=\"toc-link\" href=\"#%E5%A4%A7%E5%B0%8F\"><span class=\"toc-text\">å¤§å°</span></a></li><li class=\"toc-item toc-level-4\"><a class=\"toc-link\" href=\"#%E5%BC%BA%E5%88%B6%E5%86%99%E5%85%A5\"><span class=\"toc-text\">å¼ºåˆ¶å†™å…¥</span></a></li></ol></li><li class=\"toc-item toc-level-3\"><a class=\"toc-link\" href=\"#3-2-%E4%B8%A4%E4%B8%AA-Channel-%E4%BC%A0%E8%BE%93%E6%95%B0%E6%8D%AE-nio-c3\"><span class=\"toc-text\">3.2 ä¸¤ä¸ª Channel ä¼ è¾“æ•°æ®-nio.c3</span></a></li><li class=\"toc-item toc-level-3\"><a class=\"toc-link\" href=\"#3-3-Path\"><span class=\"toc-text\">3.3 Path</span></a></li><li class=\"toc-item toc-level-3\"><a class=\"toc-link\" href=\"#3-4-Files\"><span class=\"toc-text\">3.4 Files</span></a><ol class=\"toc-child\"><li class=\"toc-item toc-level-4\"><a class=\"toc-link\" href=\"#TestFilesWalkFileTree\"><span class=\"toc-text\">TestFilesWalkFileTree</span></a></li><li class=\"toc-item toc-level-4\"><a class=\"toc-link\" href=\"#%E2%9A%A0%EF%B8%8F-%E5%88%A0%E9%99%A4%E5%BE%88%E5%8D%B1%E9%99%A9\"><span class=\"toc-text\">âš ï¸ åˆ é™¤å¾ˆå±é™©</span></a></li></ol></li></ol></li><li class=\"toc-item toc-level-2\"><a class=\"toc-link\" href=\"#4-%E7%BD%91%E7%BB%9C%E7%BC%96%E7%A8%8B-nio-c4\"><span class=\"toc-text\">4. ç½‘ç»œç¼–ç¨‹-nio.c4</span></a><ol class=\"toc-child\"><li class=\"toc-item toc-level-3\"><a class=\"toc-link\" href=\"#4-1-%E9%9D%9E%E9%98%BB%E5%A1%9E-vs-%E9%98%BB%E5%A1%9E\"><span class=\"toc-text\">4.1 éé˜»å¡ vs é˜»å¡</span></a><ol class=\"toc-child\"><li class=\"toc-item toc-level-4\"><a class=\"toc-link\" href=\"#1%E3%80%81%E9%98%BB%E5%A1%9E\"><span class=\"toc-text\">1ã€é˜»å¡</span></a></li><li class=\"toc-item toc-level-4\"><a class=\"toc-link\" href=\"#2%E3%80%81%E9%9D%9E%E9%98%BB%E5%A1%9E\"><span class=\"toc-text\">2ã€éé˜»å¡</span></a></li></ol></li><li class=\"toc-item toc-level-3\"><a class=\"toc-link\" href=\"#%E5%AE%9E%E6%88%98%EF%BC%9Anio-c4%EF%BC%81%EF%BC%81%EF%BC%81\"><span class=\"toc-text\">å®æˆ˜ï¼šnio.c4ï¼ï¼ï¼</span></a></li><li class=\"toc-item toc-level-3\"><a class=\"toc-link\" href=\"#%E3%80%90%E5%88%86%E6%AD%A5%E8%AE%B2%E8%A7%A3%E3%80%914-2-Selector\"><span class=\"toc-text\">ã€åˆ†æ­¥è®²è§£ã€‘4.2 Selector</span></a><ol class=\"toc-child\"><li class=\"toc-item toc-level-4\"><a class=\"toc-link\" href=\"#3%E3%80%81%E5%A4%9A%E8%B7%AF%E5%A4%8D%E7%94%A8\"><span class=\"toc-text\">3ã€å¤šè·¯å¤ç”¨</span></a></li><li class=\"toc-item toc-level-4\"><a class=\"toc-link\" href=\"#%E5%88%9B%E5%BB%BA\"><span class=\"toc-text\">åˆ›å»º</span></a></li><li class=\"toc-item toc-level-4\"><a class=\"toc-link\" href=\"#%E7%BB%91%E5%AE%9A-Channel-%E4%BA%8B%E4%BB%B6\"><span class=\"toc-text\">ç»‘å®š Channel äº‹ä»¶</span></a></li><li class=\"toc-item toc-level-4\"><a class=\"toc-link\" href=\"#%E7%9B%91%E5%90%AC-Channel-%E4%BA%8B%E4%BB%B6\"><span class=\"toc-text\">ç›‘å¬ Channel äº‹ä»¶</span></a></li><li class=\"toc-item toc-level-4\"><a class=\"toc-link\" href=\"#%F0%9F%92%A1-select-%E4%BD%95%E6%97%B6%E4%B8%8D%E9%98%BB%E5%A1%9E\"><span class=\"toc-text\">ğŸ’¡ select ä½•æ—¶ä¸é˜»å¡</span></a></li></ol></li><li class=\"toc-item toc-level-3\"><a class=\"toc-link\" href=\"#4-3-%E5%A4%84%E7%90%86-accept-%E4%BA%8B%E4%BB%B6\"><span class=\"toc-text\">4.3 å¤„ç† accept äº‹ä»¶</span></a><ol class=\"toc-child\"><li class=\"toc-item toc-level-4\"><a class=\"toc-link\" href=\"#%F0%9F%92%A1-%E4%BA%8B%E4%BB%B6%E5%8F%91%E7%94%9F%E5%90%8E%E8%83%BD%E5%90%A6%E4%B8%8D%E5%A4%84%E7%90%86\"><span class=\"toc-text\">ğŸ’¡ äº‹ä»¶å‘ç”Ÿåèƒ½å¦ä¸å¤„ç†</span></a></li></ol></li><li class=\"toc-item toc-level-3\"><a class=\"toc-link\" href=\"#4-4-%E5%A4%84%E7%90%86-read-%E4%BA%8B%E4%BB%B6\"><span class=\"toc-text\">4.4 å¤„ç† read äº‹ä»¶</span></a><ol class=\"toc-child\"><li class=\"toc-item toc-level-4\"><a class=\"toc-link\" href=\"#%F0%9F%92%A1-%E4%B8%BA%E4%BD%95%E8%A6%81-iter-remove\"><span class=\"toc-text\">ğŸ’¡ ä¸ºä½•è¦ iter.remove()</span></a></li><li class=\"toc-item toc-level-4\"><a class=\"toc-link\" href=\"#%F0%9F%92%A1-cancel-%E7%9A%84%E4%BD%9C%E7%94%A8\"><span class=\"toc-text\">ğŸ’¡ cancel çš„ä½œç”¨</span></a></li><li class=\"toc-item toc-level-4\"><a class=\"toc-link\" href=\"#%E2%9A%A0%EF%B8%8F-%E4%B8%8D%E5%A4%84%E7%90%86%E8%BE%B9%E7%95%8C%E7%9A%84%E9%97%AE%E9%A2%98\"><span class=\"toc-text\">âš ï¸  ä¸å¤„ç†è¾¹ç•Œçš„é—®é¢˜</span></a></li><li class=\"toc-item toc-level-4\"><a class=\"toc-link\" href=\"#%E5%A4%84%E7%90%86%E6%B6%88%E6%81%AF%E7%9A%84%E8%BE%B9%E7%95%8C%EF%BC%81%EF%BC%81%EF%BC%81\"><span class=\"toc-text\">å¤„ç†æ¶ˆæ¯çš„è¾¹ç•Œï¼ï¼ï¼</span></a></li><li class=\"toc-item toc-level-4\"><a class=\"toc-link\" href=\"#ByteBuffer-%E5%A4%A7%E5%B0%8F%E5%88%86%E9%85%8D\"><span class=\"toc-text\">ByteBuffer å¤§å°åˆ†é…</span></a></li></ol></li><li class=\"toc-item toc-level-3\"><a class=\"toc-link\" href=\"#4-5-%E5%A4%84%E7%90%86-write-%E4%BA%8B%E4%BB%B6WriteServer-x2F-Client\"><span class=\"toc-text\">4.5 å¤„ç† write äº‹ä»¶\tWriteServer&#x2F;Client</span></a><ol class=\"toc-child\"><li class=\"toc-item toc-level-4\"><a class=\"toc-link\" href=\"#%E4%B8%80%E6%AC%A1%E6%97%A0%E6%B3%95%E5%86%99%E5%AE%8C%E4%BE%8B%E5%AD%90\"><span class=\"toc-text\">ä¸€æ¬¡æ— æ³•å†™å®Œä¾‹å­</span></a></li><li class=\"toc-item toc-level-4\"><a class=\"toc-link\" href=\"#%F0%9F%92%A1-write-%E4%B8%BA%E4%BD%95%E8%A6%81%E5%8F%96%E6%B6%88\"><span class=\"toc-text\">ğŸ’¡ write ä¸ºä½•è¦å–æ¶ˆ</span></a></li></ol></li><li class=\"toc-item toc-level-3\"><a class=\"toc-link\" href=\"#4-6-%E6%9B%B4%E8%BF%9B%E4%B8%80%E6%AD%A5\"><span class=\"toc-text\">4.6 æ›´è¿›ä¸€æ­¥</span></a><ol class=\"toc-child\"><li class=\"toc-item toc-level-4\"><a class=\"toc-link\" href=\"#%F0%9F%92%A1-%E5%88%A9%E7%94%A8%E5%A4%9A%E7%BA%BF%E7%A8%8B%E4%BC%98%E5%8C%96\"><span class=\"toc-text\">ğŸ’¡ åˆ©ç”¨å¤šçº¿ç¨‹ä¼˜åŒ–</span></a></li><li class=\"toc-item toc-level-4\"><a class=\"toc-link\" href=\"#%F0%9F%92%A1-%E5%A6%82%E4%BD%95%E6%8B%BF%E5%88%B0-cpu-%E4%B8%AA%E6%95%B0\"><span class=\"toc-text\">ğŸ’¡ å¦‚ä½•æ‹¿åˆ° cpu ä¸ªæ•°</span></a></li></ol></li><li class=\"toc-item toc-level-3\"><a class=\"toc-link\" href=\"#4-7-UDP\"><span class=\"toc-text\">4.7 UDP</span></a></li></ol></li><li class=\"toc-item toc-level-2\"><a class=\"toc-link\" href=\"#5-NIO-vs-BIO\"><span class=\"toc-text\">5. NIO vs BIO</span></a><ol class=\"toc-child\"><li class=\"toc-item toc-level-3\"><a class=\"toc-link\" href=\"#5-1-stream-vs-channel\"><span class=\"toc-text\">5.1 stream vs channel</span></a></li><li class=\"toc-item toc-level-3\"><a class=\"toc-link\" href=\"#5-2-IO-%E6%A8%A1%E5%9E%8B\"><span class=\"toc-text\">5.2 IO æ¨¡å‹</span></a><ol class=\"toc-child\"><li class=\"toc-item toc-level-4\"><a class=\"toc-link\" href=\"#%F0%9F%94%96-%E5%8F%82%E8%80%83\"><span class=\"toc-text\">ğŸ”– å‚è€ƒ</span></a></li></ol></li><li class=\"toc-item toc-level-3\"><a class=\"toc-link\" href=\"#5-3-%E9%9B%B6%E6%8B%B7%E8%B4%9D\"><span class=\"toc-text\">5.3 é›¶æ‹·è´</span></a><ol class=\"toc-child\"><li class=\"toc-item toc-level-4\"><a class=\"toc-link\" href=\"#%E4%BC%A0%E7%BB%9F-IO-%E9%97%AE%E9%A2%98\"><span class=\"toc-text\">ä¼ ç»Ÿ IO é—®é¢˜</span></a></li><li class=\"toc-item toc-level-4\"><a class=\"toc-link\" href=\"#NIO-%E4%BC%98%E5%8C%96\"><span class=\"toc-text\">NIO ä¼˜åŒ–</span></a></li></ol></li><li class=\"toc-item toc-level-3\"><a class=\"toc-link\" href=\"#5-3-AIO\"><span class=\"toc-text\">5.3 AIO</span></a><ol class=\"toc-child\"><li class=\"toc-item toc-level-4\"><a class=\"toc-link\" href=\"#%E6%96%87%E4%BB%B6-AIO\"><span class=\"toc-text\">æ–‡ä»¶ AIO</span></a></li><li class=\"toc-item toc-level-4\"><a class=\"toc-link\" href=\"#%F0%9F%92%A1-%E5%AE%88%E6%8A%A4%E7%BA%BF%E7%A8%8B\"><span class=\"toc-text\">ğŸ’¡ å®ˆæŠ¤çº¿ç¨‹</span></a></li><li class=\"toc-item toc-level-4\"><a class=\"toc-link\" href=\"#%E7%BD%91%E7%BB%9C-AIO\"><span class=\"toc-text\">ç½‘ç»œ AIO</span></a></li></ol></li></ol></li></ol></li><li class=\"toc-item toc-level-1\"><a class=\"toc-link\" href=\"#%E4%BA%8C-Netty-%E5%85%A5%E9%97%A8\"><span class=\"toc-text\">äºŒ. Netty å…¥é—¨</span></a><ol class=\"toc-child\"><li class=\"toc-item toc-level-2\"><a class=\"toc-link\" href=\"#1-%E6%A6%82%E8%BF%B0\"><span class=\"toc-text\">1. æ¦‚è¿°</span></a><ol class=\"toc-child\"><li class=\"toc-item toc-level-3\"><a class=\"toc-link\" href=\"#1-1-Netty-%E6%98%AF%E4%BB%80%E4%B9%88%EF%BC%9F\"><span class=\"toc-text\">1.1 Netty æ˜¯ä»€ä¹ˆï¼Ÿ</span></a></li><li class=\"toc-item toc-level-3\"><a class=\"toc-link\" href=\"#1-2-Netty-%E7%9A%84%E4%BD%9C%E8%80%85\"><span class=\"toc-text\">1.2 Netty çš„ä½œè€…</span></a></li><li class=\"toc-item toc-level-3\"><a class=\"toc-link\" href=\"#1-3-Netty-%E7%9A%84%E5%9C%B0%E4%BD%8D\"><span class=\"toc-text\">1.3 Netty çš„åœ°ä½</span></a></li><li class=\"toc-item toc-level-3\"><a class=\"toc-link\" href=\"#1-4-Netty-%E7%9A%84%E4%BC%98%E5%8A%BF\"><span class=\"toc-text\">1.4 Netty çš„ä¼˜åŠ¿</span></a></li></ol></li><li class=\"toc-item toc-level-2\"><a class=\"toc-link\" href=\"#2-Hello-World\"><span class=\"toc-text\">2. Hello World</span></a><ol class=\"toc-child\"><li class=\"toc-item toc-level-3\"><a class=\"toc-link\" href=\"#2-1-%E7%9B%AE%E6%A0%87\"><span class=\"toc-text\">2.1 ç›®æ ‡</span></a></li><li class=\"toc-item toc-level-3\"><a class=\"toc-link\" href=\"#2-2-%E6%9C%8D%E5%8A%A1%E5%99%A8%E7%AB%AF\"><span class=\"toc-text\">2.2 æœåŠ¡å™¨ç«¯</span></a></li><li class=\"toc-item toc-level-3\"><a class=\"toc-link\" href=\"#2-3-%E5%AE%A2%E6%88%B7%E7%AB%AF\"><span class=\"toc-text\">2.3 å®¢æˆ·ç«¯</span></a></li><li class=\"toc-item toc-level-3\"><a class=\"toc-link\" href=\"#2-4-%E6%B5%81%E7%A8%8B%E6%A2%B3%E7%90%86\"><span class=\"toc-text\">2.4 æµç¨‹æ¢³ç†</span></a><ol class=\"toc-child\"><li class=\"toc-item toc-level-4\"><a class=\"toc-link\" href=\"#%F0%9F%92%A1-%E6%8F%90%E7%A4%BA\"><span class=\"toc-text\">ğŸ’¡ æç¤º</span></a></li></ol></li></ol></li><li class=\"toc-item toc-level-2\"><a class=\"toc-link\" href=\"#3-%E7%BB%84%E4%BB%B6\"><span class=\"toc-text\">3. ç»„ä»¶</span></a><ol class=\"toc-child\"><li class=\"toc-item toc-level-3\"><a class=\"toc-link\" href=\"#3-1-EventLoop-x3D-%E5%8C%85%E8%A3%85%E7%9A%84Selector\"><span class=\"toc-text\">3.1 EventLoop&#x3D;åŒ…è£…çš„Selector</span></a><ol class=\"toc-child\"><li class=\"toc-item toc-level-4\"><a class=\"toc-link\" href=\"#%E6%BC%94%E7%A4%BA-NioEventLoop-%E5%A4%84%E7%90%86-io-%E4%BA%8B%E4%BB%B6\"><span class=\"toc-text\">æ¼”ç¤º NioEventLoop å¤„ç† io äº‹ä»¶</span></a></li><li class=\"toc-item toc-level-4\"><a class=\"toc-link\" href=\"#%F0%9F%92%A1-handler-%E6%89%A7%E8%A1%8C%E4%B8%AD%E5%A6%82%E4%BD%95%E6%8D%A2%E4%BA%BA%EF%BC%9F\"><span class=\"toc-text\">ğŸ’¡ handler æ‰§è¡Œä¸­å¦‚ä½•æ¢äººï¼Ÿ</span></a></li><li class=\"toc-item toc-level-4\"><a class=\"toc-link\" href=\"#%E6%BC%94%E7%A4%BA-NioEventLoop-%E5%A4%84%E7%90%86%E6%99%AE%E9%80%9A%E4%BB%BB%E5%8A%A1\"><span class=\"toc-text\">æ¼”ç¤º NioEventLoop å¤„ç†æ™®é€šä»»åŠ¡</span></a></li><li class=\"toc-item toc-level-4\"><a class=\"toc-link\" href=\"#%E6%BC%94%E7%A4%BA-NioEventLoop-%E5%A4%84%E7%90%86%E5%AE%9A%E6%97%B6%E4%BB%BB%E5%8A%A1\"><span class=\"toc-text\">æ¼”ç¤º NioEventLoop å¤„ç†å®šæ—¶ä»»åŠ¡</span></a></li></ol></li><li class=\"toc-item toc-level-3\"><a class=\"toc-link\" href=\"#3-2-Channel%EF%BC%81%EF%BC%81%EF%BC%81\"><span class=\"toc-text\">3.2 Channelï¼ï¼ï¼</span></a><ol class=\"toc-child\"><li class=\"toc-item toc-level-4\"><a class=\"toc-link\" href=\"#ChannelFuture\"><span class=\"toc-text\">ChannelFuture</span></a></li><li class=\"toc-item toc-level-4\"><a class=\"toc-link\" href=\"#x3D-x3D-%EF%BC%81%EF%BC%81%EF%BC%81%E9%99%A4%E4%BA%86%E7%94%A8-sync-%E6%96%B9%E6%B3%95%E5%8F%AF%E4%BB%A5%E8%AE%A9connect%E5%BC%82%E6%AD%A5%E6%93%8D%E4%BD%9C%E5%90%8C%E6%AD%A5%E4%BB%A5%E5%A4%96%EF%BC%8C%E8%BF%98%E5%8F%AF%E4%BB%A5%E4%BD%BF%E7%94%A8%E5%9B%9E%E8%B0%83%E7%9A%84%E6%96%B9%E5%BC%8F%EF%BC%9A-x3D-x3D\"><span class=\"toc-text\">&#x3D;&#x3D;ï¼ï¼ï¼é™¤äº†ç”¨ sync æ–¹æ³•å¯ä»¥è®©connectå¼‚æ­¥æ“ä½œåŒæ­¥ä»¥å¤–ï¼Œè¿˜å¯ä»¥ä½¿ç”¨å›è°ƒçš„æ–¹å¼ï¼š&#x3D;&#x3D;</span></a></li><li class=\"toc-item toc-level-4\"><a class=\"toc-link\" href=\"#CloseFuture\"><span class=\"toc-text\">CloseFuture</span></a></li><li class=\"toc-item toc-level-4\"><a class=\"toc-link\" href=\"#%F0%9F%92%A1-%E4%BC%98%E9%9B%85%E5%85%B3%E9%97%AD\"><span class=\"toc-text\">ğŸ’¡ ä¼˜é›…å…³é—­</span></a></li><li class=\"toc-item toc-level-4\"><a class=\"toc-link\" href=\"#%F0%9F%92%A1-%E5%BC%82%E6%AD%A5%E6%8F%90%E5%8D%87%E7%9A%84%E6%98%AF%E4%BB%80%E4%B9%88%EF%BC%81%EF%BC%81%EF%BC%81\"><span class=\"toc-text\">ğŸ’¡ å¼‚æ­¥æå‡çš„æ˜¯ä»€ä¹ˆï¼ï¼ï¼</span></a></li></ol></li><li class=\"toc-item toc-level-3\"><a class=\"toc-link\" href=\"#x3D-x3D-%E3%80%90%E5%BC%82%E6%AD%A5-%E5%A4%9A%E6%A0%B8%E5%A4%9A%E7%BA%BF%E7%A8%8B%EF%BC%81-%E4%BB%BB%E5%8A%A1%E6%8B%86%E5%88%86%EF%BC%81-%E6%B5%81%E6%B0%B4%E7%BA%BFpipeline%EF%BC%81-%E5%93%8D%E5%BA%94%E5%8F%98%E6%85%A2-%E5%8D%8F%E4%BD%9C%E6%97%B6%E9%97%B4-%EF%BC%8C%E5%90%9E%E5%90%90%E5%8F%98%E9%AB%98%EF%BC%81%E3%80%91-x3D-x3D\"><span class=\"toc-text\">&#x3D;&#x3D;ã€å¼‚æ­¥+å¤šæ ¸å¤šçº¿ç¨‹ï¼ ä»»åŠ¡æ‹†åˆ†ï¼ æµæ°´çº¿pipelineï¼ å“åº”å˜æ…¢(+åä½œæ—¶é—´)ï¼Œååå˜é«˜ï¼ã€‘&#x3D;&#x3D;</span></a></li><li class=\"toc-item toc-level-3\"><a class=\"toc-link\" href=\"#3-3-Future-amp-Promise\"><span class=\"toc-text\">3.3 Future &amp; Promise</span></a><ol class=\"toc-child\"><li class=\"toc-item toc-level-4\"><a class=\"toc-link\" href=\"#%E4%BE%8B1\"><span class=\"toc-text\">ä¾‹1</span></a></li><li class=\"toc-item toc-level-4\"><a class=\"toc-link\" href=\"#%E4%BE%8B2\"><span class=\"toc-text\">ä¾‹2</span></a></li><li class=\"toc-item toc-level-4\"><a class=\"toc-link\" href=\"#%E4%BE%8B3\"><span class=\"toc-text\">ä¾‹3</span></a></li><li class=\"toc-item toc-level-4\"><a class=\"toc-link\" href=\"#%E4%BE%8B4\"><span class=\"toc-text\">ä¾‹4</span></a></li><li class=\"toc-item toc-level-4\"><a class=\"toc-link\" href=\"#%E4%BE%8B5\"><span class=\"toc-text\">ä¾‹5</span></a></li><li class=\"toc-item toc-level-4\"><a class=\"toc-link\" href=\"#%E4%BE%8B6\"><span class=\"toc-text\">ä¾‹6</span></a></li></ol></li><li class=\"toc-item toc-level-3\"><a class=\"toc-link\" href=\"#3-4-Handler-amp-Pipeline\"><span class=\"toc-text\">3.4 Handler &amp; Pipeline</span></a><ol class=\"toc-child\"><li class=\"toc-item toc-level-4\"><a class=\"toc-link\" href=\"#x3D-x3D-in-%E5%8C%85%E8%A3%85-%E8%BD%AC%E6%8D%A2-channel-tail%E5%80%92-out-%E5%A4%84%E7%90%86-ctx-x2F-super-cur%E5%80%92-x3D-x3D\"><span class=\"toc-text\">&#x3D;&#x3D;in(åŒ…è£… è½¬æ¢)-channel(tailå€’)\tout(å¤„ç†)-ctx&#x2F;super(curå€’)&#x3D;&#x3D;</span></a></li></ol></li><li class=\"toc-item toc-level-3\"><a class=\"toc-link\" href=\"#3-5-ByteBuf\"><span class=\"toc-text\">3.5 ByteBuf</span></a><ol class=\"toc-child\"><li class=\"toc-item toc-level-4\"><a class=\"toc-link\" href=\"#1%EF%BC%89%E5%88%9B%E5%BB%BA\"><span class=\"toc-text\">1ï¼‰åˆ›å»º</span></a></li><li class=\"toc-item toc-level-4\"><a class=\"toc-link\" href=\"#2%EF%BC%89%E7%9B%B4%E6%8E%A5%E5%86%85%E5%AD%98-vs-%E5%A0%86%E5%86%85%E5%AD%98\"><span class=\"toc-text\">2ï¼‰ç›´æ¥å†…å­˜ vs å †å†…å­˜</span></a></li><li class=\"toc-item toc-level-4\"><a class=\"toc-link\" href=\"#3%EF%BC%89%E6%B1%A0%E5%8C%96-vs-%E9%9D%9E%E6%B1%A0%E5%8C%96\"><span class=\"toc-text\">3ï¼‰æ± åŒ– vs éæ± åŒ–</span></a></li><li class=\"toc-item toc-level-4\"><a class=\"toc-link\" href=\"#4%EF%BC%89%E7%BB%84%E6%88%90\"><span class=\"toc-text\">4ï¼‰ç»„æˆ</span></a></li><li class=\"toc-item toc-level-4\"><a class=\"toc-link\" href=\"#5%EF%BC%89%E5%86%99%E5%85%A5\"><span class=\"toc-text\">5ï¼‰å†™å…¥</span></a></li><li class=\"toc-item toc-level-4\"><a class=\"toc-link\" href=\"#6%EF%BC%89%E6%89%A9%E5%AE%B9\"><span class=\"toc-text\">6ï¼‰æ‰©å®¹</span></a></li><li class=\"toc-item toc-level-4\"><a class=\"toc-link\" href=\"#7%EF%BC%89%E8%AF%BB%E5%8F%96\"><span class=\"toc-text\">7ï¼‰è¯»å–</span></a></li><li class=\"toc-item toc-level-4\"><a class=\"toc-link\" href=\"#8%EF%BC%89retain-amp-release\"><span class=\"toc-text\">8ï¼‰retain &amp; release</span></a></li><li class=\"toc-item toc-level-4\"><a class=\"toc-link\" href=\"#9%EF%BC%89slice\"><span class=\"toc-text\">9ï¼‰slice</span></a></li><li class=\"toc-item toc-level-4\"><a class=\"toc-link\" href=\"#10%EF%BC%89duplicate-%E6%B5%85%E6%8B%B7%E8%B4%9D\"><span class=\"toc-text\">10ï¼‰duplicate æµ…æ‹·è´</span></a></li><li class=\"toc-item toc-level-4\"><a class=\"toc-link\" href=\"#11%EF%BC%89copy%E6%B7%B1%E6%8B%B7%E8%B4%9D\"><span class=\"toc-text\">11ï¼‰copyæ·±æ‹·è´</span></a></li><li class=\"toc-item toc-level-4\"><a class=\"toc-link\" href=\"#12%EF%BC%89CompositeByteBuf\"><span class=\"toc-text\">12ï¼‰CompositeByteBuf</span></a></li><li class=\"toc-item toc-level-4\"><a class=\"toc-link\" href=\"#13%EF%BC%89Unpooled\"><span class=\"toc-text\">13ï¼‰Unpooled</span></a></li><li class=\"toc-item toc-level-4\"><a class=\"toc-link\" href=\"#%F0%9F%92%A1-ByteBuf-%E4%BC%98%E5%8A%BF\"><span class=\"toc-text\">ğŸ’¡ ByteBuf ä¼˜åŠ¿</span></a></li></ol></li></ol></li><li class=\"toc-item toc-level-2\"><a class=\"toc-link\" href=\"#4-%E5%8F%8C%E5%90%91%E9%80%9A%E4%BF%A1\"><span class=\"toc-text\">4. åŒå‘é€šä¿¡</span></a><ol class=\"toc-child\"><li class=\"toc-item toc-level-3\"><a class=\"toc-link\" href=\"#4-1-%E7%BB%83%E4%B9%A0\"><span class=\"toc-text\">4.1 ç»ƒä¹ </span></a></li><li class=\"toc-item toc-level-3\"><a class=\"toc-link\" href=\"#%F0%9F%92%A1-%E8%AF%BB%E5%92%8C%E5%86%99%E7%9A%84%E8%AF%AF%E8%A7%A3\"><span class=\"toc-text\">ğŸ’¡ è¯»å’Œå†™çš„è¯¯è§£</span></a></li></ol></li></ol></li><li class=\"toc-item toc-level-1\"><a class=\"toc-link\" href=\"#%E4%B8%89-Netty-%E8%BF%9B%E9%98%B6\"><span class=\"toc-text\">ä¸‰. Netty è¿›é˜¶</span></a><ol class=\"toc-child\"><li class=\"toc-item toc-level-2\"><a class=\"toc-link\" href=\"#1-%E7%B2%98%E5%8C%85%E4%B8%8E%E5%8D%8A%E5%8C%85\"><span class=\"toc-text\">1. ç²˜åŒ…ä¸åŠåŒ…</span></a><ol class=\"toc-child\"><li class=\"toc-item toc-level-3\"><a class=\"toc-link\" href=\"#1-1-%E7%B2%98%E5%8C%85%E7%8E%B0%E8%B1%A1\"><span class=\"toc-text\">1.1 ç²˜åŒ…ç°è±¡</span></a></li><li class=\"toc-item toc-level-3\"><a class=\"toc-link\" href=\"#1-2-%E5%8D%8A%E5%8C%85%E7%8E%B0%E8%B1%A1\"><span class=\"toc-text\">1.2 åŠåŒ…ç°è±¡</span></a></li><li class=\"toc-item toc-level-3\"><a class=\"toc-link\" href=\"#1-3-%E7%8E%B0%E8%B1%A1%E5%88%86%E6%9E%90\"><span class=\"toc-text\">1.3 ç°è±¡åˆ†æ</span></a></li><li class=\"toc-item toc-level-3\"><a class=\"toc-link\" href=\"#1-4-%E8%A7%A3%E5%86%B3%E6%96%B9%E6%A1%88\"><span class=\"toc-text\">1.4 è§£å†³æ–¹æ¡ˆ</span></a><ol class=\"toc-child\"><li class=\"toc-item toc-level-4\"><a class=\"toc-link\" href=\"#%E6%96%B9%E6%B3%951%EF%BC%8C%E7%9F%AD%E9%93%BE%E6%8E%A5\"><span class=\"toc-text\">æ–¹æ³•1ï¼ŒçŸ­é“¾æ¥</span></a></li><li class=\"toc-item toc-level-4\"><a class=\"toc-link\" href=\"#%E6%96%B9%E6%B3%952%EF%BC%8C%E5%9B%BA%E5%AE%9A%E9%95%BF%E5%BA%A6-FixedLengthFrameDecoder\"><span class=\"toc-text\">æ–¹æ³•2ï¼Œå›ºå®šé•¿åº¦ FixedLengthFrameDecoder</span></a></li><li class=\"toc-item toc-level-4\"><a class=\"toc-link\" href=\"#%E6%96%B9%E6%B3%953%EF%BC%8C%E5%9B%BA%E5%AE%9A%E5%88%86%E9%9A%94%E7%AC%A6-LineBasedFrameDecoder\"><span class=\"toc-text\">æ–¹æ³•3ï¼Œå›ºå®šåˆ†éš”ç¬¦ LineBasedFrameDecoder</span></a></li><li class=\"toc-item toc-level-4\"><a class=\"toc-link\" href=\"#%E6%96%B9%E6%B3%954%EF%BC%8C%E9%A2%84%E8%AE%BE%E9%95%BF%E5%BA%A6-LengthFieldBasedFrameDecoder-max-len%E5%89%8D%E4%B8%AD%E5%90%8E-S%E6%94%B6%E5%8E%BB%E5%B0%BE\"><span class=\"toc-text\">æ–¹æ³•4ï¼Œé¢„è®¾é•¿åº¦ LengthFieldBasedFrameDecoder(max,lenå‰ä¸­å,Sæ”¶å»å°¾)</span></a></li></ol></li></ol></li><li class=\"toc-item toc-level-2\"><a class=\"toc-link\" href=\"#2-%E5%8D%8F%E8%AE%AE%E8%AE%BE%E8%AE%A1%E4%B8%8E%E8%A7%A3%E6%9E%90\"><span class=\"toc-text\">2. åè®®è®¾è®¡ä¸è§£æ</span></a><ol class=\"toc-child\"><li class=\"toc-item toc-level-3\"><a class=\"toc-link\" href=\"#2-1-%E4%B8%BA%E4%BB%80%E4%B9%88%E9%9C%80%E8%A6%81%E5%8D%8F%E8%AE%AE%EF%BC%9F\"><span class=\"toc-text\">2.1 ä¸ºä»€ä¹ˆéœ€è¦åè®®ï¼Ÿ</span></a></li><li class=\"toc-item toc-level-3\"><a class=\"toc-link\" href=\"#2-2-redis-%E5%8D%8F%E8%AE%AE%E4%B8%BE%E4%BE%8B\"><span class=\"toc-text\">2.2 redis åè®®ä¸¾ä¾‹</span></a></li><li class=\"toc-item toc-level-3\"><a class=\"toc-link\" href=\"#2-3-http-%E5%8D%8F%E8%AE%AE%E4%B8%BE%E4%BE%8B\"><span class=\"toc-text\">2.3 http åè®®ä¸¾ä¾‹</span></a></li><li class=\"toc-item toc-level-3\"><a class=\"toc-link\" href=\"#x3D-x3D-2-4-%E8%87%AA%E5%AE%9A%E4%B9%89%E5%8D%8F%E8%AE%AE%E8%A6%81%E7%B4%A0-x3D-x3D-%E3%80%90%E7%B4%A7%E5%87%91%EF%BC%8C%E9%AB%98%E6%95%88%EF%BC%8C%E7%9C%81%E5%B8%A6%E5%AE%BD%E3%80%91\"><span class=\"toc-text\">&#x3D;&#x3D;2.4 è‡ªå®šä¹‰åè®®è¦ç´ &#x3D;&#x3D;ã€ç´§å‡‘ï¼Œé«˜æ•ˆï¼Œçœå¸¦å®½ã€‘</span></a><ol class=\"toc-child\"><li class=\"toc-item toc-level-4\"><a class=\"toc-link\" href=\"#msg%E7%BC%96%E8%A7%A3%E7%A0%81%E5%99%A8%E3%80%90netty-demo%E9%A1%B9%E7%9B%AE%E3%80%91\"><span class=\"toc-text\">msgç¼–è§£ç å™¨ã€netty-demoé¡¹ç›®ã€‘</span></a></li><li class=\"toc-item toc-level-4\"><a class=\"toc-link\" href=\"#%F0%9F%92%A1-%E4%BB%80%E4%B9%88%E6%97%B6%E5%80%99%E5%8F%AF%E4%BB%A5%E5%8A%A0-Sharable\"><span class=\"toc-text\">ğŸ’¡ ä»€ä¹ˆæ—¶å€™å¯ä»¥åŠ  @Sharable</span></a></li></ol></li></ol></li><li class=\"toc-item toc-level-2\"><a class=\"toc-link\" href=\"#3-x3D-x3D-%E3%80%90QQ%E3%80%91%E8%81%8A%E5%A4%A9%E5%AE%A4%E6%A1%88%E4%BE%8B-x3D-x3D\"><span class=\"toc-text\">3. &#x3D;&#x3D;ã€QQã€‘èŠå¤©å®¤æ¡ˆä¾‹&#x3D;&#x3D;</span></a><ol class=\"toc-child\"><li class=\"toc-item toc-level-3\"><a class=\"toc-link\" href=\"#3-1-%E8%81%8A%E5%A4%A9%E5%AE%A4%E4%B8%9A%E5%8A%A1%E4%BB%8B%E7%BB%8D\"><span class=\"toc-text\">3.1 èŠå¤©å®¤ä¸šåŠ¡ä»‹ç»</span></a></li><li class=\"toc-item toc-level-3\"><a class=\"toc-link\" href=\"#3-2-%E8%81%8A%E5%A4%A9%E5%AE%A4%E4%B8%9A%E5%8A%A1-%E7%99%BB%E5%BD%95\"><span class=\"toc-text\">3.2 èŠå¤©å®¤ä¸šåŠ¡-ç™»å½•</span></a></li><li class=\"toc-item toc-level-3\"><a class=\"toc-link\" href=\"#3-3-%E8%81%8A%E5%A4%A9%E5%AE%A4%E4%B8%9A%E5%8A%A1-%E5%8D%95%E8%81%8A\"><span class=\"toc-text\">3.3 èŠå¤©å®¤ä¸šåŠ¡-å•èŠ</span></a></li><li class=\"toc-item toc-level-3\"><a class=\"toc-link\" href=\"#3-4-%E8%81%8A%E5%A4%A9%E5%AE%A4%E4%B8%9A%E5%8A%A1-%E7%BE%A4%E8%81%8A\"><span class=\"toc-text\">3.4 èŠå¤©å®¤ä¸šåŠ¡-ç¾¤èŠ</span></a></li><li class=\"toc-item toc-level-3\"><a class=\"toc-link\" href=\"#3-5-%E8%81%8A%E5%A4%A9%E5%AE%A4%E4%B8%9A%E5%8A%A1-%E9%80%80%E5%87%BA\"><span class=\"toc-text\">3.5 èŠå¤©å®¤ä¸šåŠ¡-é€€å‡º</span></a></li><li class=\"toc-item toc-level-3\"><a class=\"toc-link\" href=\"#3-6-%E8%81%8A%E5%A4%A9%E5%AE%A4%E4%B8%9A%E5%8A%A1-%E7%A9%BA%E9%97%B2%E6%A3%80%E6%B5%8B\"><span class=\"toc-text\">3.6 èŠå¤©å®¤ä¸šåŠ¡-ç©ºé—²æ£€æµ‹</span></a><ol class=\"toc-child\"><li class=\"toc-item toc-level-4\"><a class=\"toc-link\" href=\"#%E8%BF%9E%E6%8E%A5%E5%81%87%E6%AD%BB-%E5%BF%83%E8%B7%B3\"><span class=\"toc-text\">è¿æ¥å‡æ­»-å¿ƒè·³</span></a></li></ol></li></ol></li></ol></li><li class=\"toc-item toc-level-1\"><a class=\"toc-link\" href=\"#%E5%9B%9B-%E4%BC%98%E5%8C%96%E4%B8%8E%E6%BA%90%E7%A0%81\"><span class=\"toc-text\">å››. ä¼˜åŒ–ä¸æºç </span></a><ol class=\"toc-child\"><li class=\"toc-item toc-level-2\"><a class=\"toc-link\" href=\"#1-%E4%BC%98%E5%8C%96\"><span class=\"toc-text\">1. ä¼˜åŒ–</span></a><ol class=\"toc-child\"><li class=\"toc-item toc-level-3\"><a class=\"toc-link\" href=\"#1-1-%E6%89%A9%E5%B1%95%E5%BA%8F%E5%88%97%E5%8C%96%E7%AE%97%E6%B3%95\"><span class=\"toc-text\">1.1 æ‰©å±•åºåˆ—åŒ–ç®—æ³•</span></a></li><li class=\"toc-item toc-level-3\"><a class=\"toc-link\" href=\"#1-2-%E5%8F%82%E6%95%B0%E8%B0%83%E4%BC%98\"><span class=\"toc-text\">1.2 å‚æ•°è°ƒä¼˜</span></a><ol class=\"toc-child\"><li class=\"toc-item toc-level-4\"><a class=\"toc-link\" href=\"#1%EF%BC%89CONNECT-TIMEOUT-MILLIS\"><span class=\"toc-text\">1ï¼‰CONNECT_TIMEOUT_MILLIS</span></a></li><li class=\"toc-item toc-level-4\"><a class=\"toc-link\" href=\"#2%EF%BC%89SO-BACKLOG\"><span class=\"toc-text\">2ï¼‰SO_BACKLOG</span></a></li><li class=\"toc-item toc-level-4\"><a class=\"toc-link\" href=\"#3%EF%BC%89ulimit-n\"><span class=\"toc-text\">3ï¼‰ulimit -n</span></a></li><li class=\"toc-item toc-level-4\"><a class=\"toc-link\" href=\"#4%EF%BC%89TCP-NODELAY\"><span class=\"toc-text\">4ï¼‰TCP_NODELAY</span></a></li><li class=\"toc-item toc-level-4\"><a class=\"toc-link\" href=\"#5%EF%BC%89SO-SNDBUF-amp-SO-RCVBUF-%E6%BB%91%E5%8A%A8%E7%AA%97%E5%8F%A3%E4%B8%8A%E9%99%90\"><span class=\"toc-text\">5ï¼‰SO_SNDBUF &amp; SO_RCVBUF[æ»‘åŠ¨çª—å£ä¸Šé™]</span></a></li><li class=\"toc-item toc-level-4\"><a class=\"toc-link\" href=\"#6%EF%BC%89ALLOCATOR\"><span class=\"toc-text\">6ï¼‰ALLOCATOR</span></a></li><li class=\"toc-item toc-level-4\"><a class=\"toc-link\" href=\"#7%EF%BC%89RCVBUF-ALLOCATOR\"><span class=\"toc-text\">7ï¼‰RCVBUF_ALLOCATOR</span></a></li></ol></li><li class=\"toc-item toc-level-3\"><a class=\"toc-link\" href=\"#1-3-x3D-x3D-%E5%85%B8%E5%9E%8B%E5%BA%94%E7%94%A8-RPC-%E6%A1%86%E6%9E%B6-%E5%9F%BA%E4%BA%8E%E8%81%8A%E5%A4%A9%E5%AE%A4ChatSC-%E3%80%90%E8%BF%9C%E7%A8%8B%E6%96%B9%E6%B3%95%E8%B0%83%E7%94%A8-%E5%8F%8D%E5%B0%84%EF%BC%9Astr-gt-JavaClass%E3%80%91-x3D-x3D\"><span class=\"toc-text\">1.3 &#x3D;&#x3D;å…¸å‹åº”ç”¨-RPC æ¡†æ¶(åŸºäºèŠå¤©å®¤ChatSC)ã€è¿œç¨‹æ–¹æ³•è°ƒç”¨ åå°„ï¼šstr-&gt;JavaClassã€‘&#x3D;&#x3D;</span></a><ol class=\"toc-child\"><li class=\"toc-item toc-level-4\"><a class=\"toc-link\" href=\"#1%EF%BC%89%E5%87%86%E5%A4%87%E5%B7%A5%E4%BD%9C\"><span class=\"toc-text\">1ï¼‰å‡†å¤‡å·¥ä½œ</span></a></li><li class=\"toc-item toc-level-4\"><a class=\"toc-link\" href=\"#%EF%BC%812%EF%BC%89%E6%9C%8D%E5%8A%A1%E5%99%A8-handler\"><span class=\"toc-text\">ï¼2ï¼‰æœåŠ¡å™¨ handler</span></a></li><li class=\"toc-item toc-level-4\"><a class=\"toc-link\" href=\"#3%EF%BC%89%E5%AE%A2%E6%88%B7%E7%AB%AF%E4%BB%A3%E7%A0%81%E7%AC%AC%E4%B8%80%E7%89%88%E3%80%90%E5%86%99%E6%AD%BBmsg%E5%AF%B9%E8%B1%A1%EF%BC%81%E8%87%AA%E5%AE%9A%E4%B9%89%E5%A4%84%E7%90%86Handler%EF%BC%81%E8%87%AA%E5%B7%B1%E8%BD%AC%E6%8D%A2%E5%B0%81%E8%A3%85obj%E3%80%91\"><span class=\"toc-text\">3ï¼‰å®¢æˆ·ç«¯ä»£ç ç¬¬ä¸€ç‰ˆã€å†™æ­»msgå¯¹è±¡ï¼è‡ªå®šä¹‰å¤„ç†Handlerï¼è‡ªå·±è½¬æ¢å°è£…objã€‘</span></a></li><li class=\"toc-item toc-level-4\"><a class=\"toc-link\" href=\"#4%EF%BC%89%E5%AE%A2%E6%88%B7%E7%AB%AF-handler-%E7%AC%AC%E4%B8%80%E7%89%88\"><span class=\"toc-text\">4ï¼‰å®¢æˆ·ç«¯ handler ç¬¬ä¸€ç‰ˆ</span></a></li><li class=\"toc-item toc-level-4\"><a class=\"toc-link\" href=\"#5%EF%BC%89%E5%AE%A2%E6%88%B7%E7%AB%AF%E4%BB%A3%E7%A0%81-%E7%AC%AC%E4%BA%8C%E7%89%88%E3%80%90RpcClientManager%E7%89%88%EF%BC%9A%E5%BC%82%E6%AD%A5%E7%BD%91%E7%BB%9C%E7%BB%93%E6%9E%9C%E7%94%A8%E5%90%8C%E6%AD%A5%E6%96%B9%E5%BC%8F%E3%80%91\"><span class=\"toc-text\">5ï¼‰å®¢æˆ·ç«¯ä»£ç  ç¬¬äºŒç‰ˆã€RpcClientManagerç‰ˆï¼šå¼‚æ­¥ç½‘ç»œç»“æœç”¨åŒæ­¥æ–¹å¼ã€‘</span></a></li><li class=\"toc-item toc-level-4\"><a class=\"toc-link\" href=\"#%E5%8C%85%E6%8B%AC-x3D-x3D-channel-%E7%AE%A1%E7%90%86-%E5%8D%95%E4%BE%8B-%EF%BC%8C-JDK-Proxy-%E4%BB%A3%E7%90%86%EF%BC%8C%E6%8E%A5%E6%94%B6%E7%BB%93%E6%9E%9C-promise-await-%E5%BC%82%E6%AD%A5%E7%BD%91%E7%BB%9C%E7%BB%93%E6%9E%9C%E5%90%8C%E6%AD%A5%E7%AD%89%E5%BE%85%EF%BC%8C%E4%B8%8D%E6%8A%9B%E5%BC%82%E5%B8%B8-x3D-x3D\"><span class=\"toc-text\">åŒ…æ‹¬ &#x3D;&#x3D;channel ç®¡ç†(å•ä¾‹)ï¼Œ(JDK Proxy)ä»£ç†ï¼Œæ¥æ”¶ç»“æœ(promise.await();å¼‚æ­¥ç½‘ç»œç»“æœåŒæ­¥ç­‰å¾…ï¼Œä¸æŠ›å¼‚å¸¸)&#x3D;&#x3D;</span></a></li><li class=\"toc-item toc-level-4\"><a class=\"toc-link\" href=\"#6%EF%BC%89%E5%AE%A2%E6%88%B7%E7%AB%AF-handler-%E7%AC%AC%E4%BA%8C%E7%89%88\"><span class=\"toc-text\">6ï¼‰å®¢æˆ·ç«¯ handler ç¬¬äºŒç‰ˆ</span></a></li><li class=\"toc-item toc-level-4\"><a class=\"toc-link\" href=\"#Client%E7%AB%AF-%E5%BC%82%E5%B8%B8%E8%B0%83%E7%94%A8\"><span class=\"toc-text\">Clientç«¯-å¼‚å¸¸è°ƒç”¨</span></a></li></ol></li></ol></li><li class=\"toc-item toc-level-2\"><a class=\"toc-link\" href=\"#2-%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90-%E4%BE%A7%E9%87%8Dnetty%E6%89%A7%E8%A1%8C%E6%B5%81%E7%A8%8B\"><span class=\"toc-text\">2. æºç åˆ†æ [ä¾§é‡nettyæ‰§è¡Œæµç¨‹]</span></a><ol class=\"toc-child\"><li class=\"toc-item toc-level-3\"><a class=\"toc-link\" href=\"#2-1-%E5%90%AF%E5%8A%A8%E5%89%96%E6%9E%90\"><span class=\"toc-text\">2.1 å¯åŠ¨å‰–æ</span></a></li><li class=\"toc-item toc-level-3\"><a class=\"toc-link\" href=\"#2-2-NioEventLoop-%E5%89%96%E6%9E%90-%E9%87%8D%E9%87%8F%E7%BA%A7-900-lines\"><span class=\"toc-text\">2.2 NioEventLoop å‰–æ[é‡é‡çº§ 900+lines]</span></a><ol class=\"toc-child\"><li class=\"toc-item toc-level-4\"><a class=\"toc-link\" href=\"#%E2%9A%A0%EF%B8%8F-%E6%B3%A8%E6%84%8F\"><span class=\"toc-text\">âš ï¸ æ³¨æ„</span></a></li></ol></li><li class=\"toc-item toc-level-3\"><a class=\"toc-link\" href=\"#2-3-accept-%E5%89%96%E6%9E%90\"><span class=\"toc-text\">2.3 accept å‰–æ</span></a></li><li class=\"toc-item toc-level-3\"><a class=\"toc-link\" href=\"#2-4-read-%E5%89%96%E6%9E%90\"><span class=\"toc-text\">2.4 read å‰–æ</span></a></li></ol></li></ol></li></ol>","author":{"name":"CodingSeed","slug":"blog-author","avatar":"http://cache.itzy8.top/img/a.jpg","link":"/","description":"","socials":{"github":"https://github.com/codingseed","twitter":"","stackoverflow":"","wechat":"","qq":"","weibo":"","zhihu":"","csdn":"","juejin":"","customs":{}}},"mapped":true,"prev_post":{"title":"Hello World","uid":"b9663f58f18133b35bfe243f3e916a80","slug":"hello-world","date":"2022-08-18T15:39:21.726Z","updated":"2022-08-22T08:06:14.544Z","comments":true,"path":"api/articles/hello-world.json","keywords":null,"cover":"http://p1.qhimg.com/bdm/480_296_0/t01f3d12d8647407337.jpg","text":"Welcome to Hexo! This is your very first post. Check documentation for more info. If you get any problems when using Hexo, you can find the ...","link":"","photos":[],"count_time":{"symbolsCount":440,"symbolsTime":"1 mins."},"categories":[],"tags":[],"author":{"name":"CodingSeed","slug":"blog-author","avatar":"http://cache.itzy8.top/img/a.jpg","link":"/","description":"","socials":{"github":"https://github.com/codingseed","twitter":"","stackoverflow":"","wechat":"","qq":"","weibo":"","zhihu":"","csdn":"","juejin":"","customs":{}}}},"next_post":{"title":"sggå¤§æ•°æ®é«˜é¢‘é¢è¯•é¢˜","uid":"128485c0403ac0ca82c74aaa720458ad","slug":"sggå¤§æ•°æ®é«˜é¢‘é¢è¯•é¢˜","date":"2021-12-26T12:18:53.000Z","updated":"2022-08-22T07:56:11.565Z","comments":true,"path":"api/articles/sggå¤§æ•°æ®é«˜é¢‘é¢è¯•é¢˜.json","keywords":null,"cover":"http://browser9.qhimg.com/bdm/480_296_0/t015eb817c1c36a6fc1.jpg","text":"å°šç¡…è°·å¤§æ•°æ®æŠ€æœ¯ä¹‹é«˜é¢‘é¢è¯•é¢˜ ï¼ˆä½œè€…ï¼šå°šç¡…è°·å¤§æ•°æ®ç ”å‘éƒ¨ï¼‰ ç‰ˆæœ¬ï¼šV8.0.15 ç›®å½•é¡¹ç›®æ¶‰åŠæŠ€æœ¯1.1 Linux&amp;Shell1.1.1 Linuxå¸¸ç”¨é«˜çº§å‘½ä»¤ åºå· å‘½ä»¤ å‘½ä»¤è§£é‡Š 1 top æŸ¥çœ‹å†…å­˜ 2 df -h æŸ¥çœ‹ç£ç›˜å­˜å‚¨æƒ…å†µ 3 iotop æŸ¥çœ‹ç£ç›˜IOè¯»...","link":"","photos":[],"count_time":{"symbolsCount":"143k","symbolsTime":"2:10"},"categories":[{"name":"å¤§æ•°æ®","slug":"å¤§æ•°æ®","count":2,"path":"api/categories/å¤§æ•°æ®.json"}],"tags":[{"name":"å¤§æ•°æ®","slug":"å¤§æ•°æ®","count":2,"path":"api/tags/å¤§æ•°æ®.json"}],"author":{"name":"CodingSeed","slug":"blog-author","avatar":"http://cache.itzy8.top/img/a.jpg","link":"/","description":"","socials":{"github":"https://github.com/codingseed","twitter":"","stackoverflow":"","wechat":"","qq":"","weibo":"","zhihu":"","csdn":"","juejin":"","customs":{}}}}}